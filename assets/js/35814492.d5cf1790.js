"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[8731],{28453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>c});var t=r(96540);const o={},i=t.createContext(o);function a(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(i.Provider,{value:n},e.children)}},59347:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>s,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"advanced/kotlin","title":"Kotlin integration","description":"Coroutines support for annotated services","source":"@site/src/content/docs/advanced/kotlin.mdx","sourceDirName":"advanced","slug":"/advanced/kotlin","permalink":"/docs/advanced/kotlin","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site/src/content/docs/advanced/kotlin.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Using Armeria with Dropwizard","permalink":"/docs/advanced/dropwizard-integration"},"next":{"title":"Scala integration","permalink":"/docs/advanced/scala"}}');var o=r(74848),i=r(28453);const a={},c="Kotlin integration",s={},l=[{value:"Coroutines support for annotated services",id:"coroutines-support-for-annotated-services",level:2},{value:"Coroutine context and dispatcher",id:"coroutine-context-and-dispatcher",level:3},{value:"Coroutine dispatcher",id:"coroutine-dispatcher",level:3},{value:"Customizing <code>CoroutineContext</code> for annotated services",id:"customizing-coroutinecontext-for-annotated-services",level:3},{value:"Coroutines support for RestClient",id:"coroutines-support-for-restclient",level:2},{value:"Coroutines support for gRPC-Kotlin",id:"coroutines-support-for-grpc-kotlin",level:2},{value:"Running a gRPC-Kotlin service",id:"running-a-grpc-kotlin-service",level:3},{value:"Calling a gRPC-Kotlin service",id:"calling-a-grpc-kotlin-service",level:3},{value:"Customizing <code>CoroutineContext</code> for gRPC-Kotlin services",id:"customizing-coroutinecontext-for-grpc-kotlin-services",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components},{RequiredDependencies:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("RequiredDependencies",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"kotlin-integration",children:"Kotlin integration"})}),"\n",(0,o.jsx)(n.h2,{id:"coroutines-support-for-annotated-services",children:"Coroutines support for annotated services"}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["Visit ",(0,o.jsx)(n.a,{href:"https://github.com/line/armeria/tree/main/examples/annotated-http-service-kotlin",children:"annotated-http-service-kotlin"})," to check out a fully working example."]})}),"\n",(0,o.jsxs)(n.p,{children:["You can implement annotated services with ",(0,o.jsx)(n.a,{href:"https://kotlinlang.org/docs/reference/coroutines-overview.html",children:"Kotlin coroutines"}),"\nby adding the following dependency:"]}),"\n",(0,o.jsx)(r,{boms:[{groupId:"com.linecorp.armeria",artifactId:"armeria-bom"}],dependencies:[{groupId:"com.linecorp.armeria",artifactId:"armeria-kotlin"}]}),"\n",(0,o.jsx)(n.p,{children:"Then, define the suspending function:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-kotlin",children:'class MyAnnotatedService {\n    @Get("/users/{name}")\n    suspend fun getUserToken(@Param("name") name: String): String {\n        val user = myReactiveRepository.findByName(name).await()\n        return user.token\n    }\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Note that you can omit the value of ",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/annotation/Param.html",children:"@Param"})," if you compiled your Kotlin code with ",(0,o.jsx)(n.a,{href:"https://kotlinlang.org/docs/reference/compiler-reference.html#java-parameters",children:(0,o.jsx)(n.code,{children:"java-parameters"})})," option."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-kotlin",children:'class MyAnnotatedService {\n    @Get("/users/{name}")\n    suspend fun getUserToken(@Param name: String): String { ... }\n}\n'})}),"\n",(0,o.jsx)(n.p,{children:"Data classes are also supported for JSON requests and responses:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-kotlin",children:'data class User(val name: String, val token: String)\ndata class Result(val status: Int, val message: String)\n\nclass MyRestService {\n\n    @ConsumesJson\n    @ProducesJson\n    @Post("/users")\n    suspend fun createUser(user: User): Result {\n        return myReactiveRepository.save(user).await()\n    }\n}\n'})}),"\n",(0,o.jsx)(n.h3,{id:"coroutine-context-and-dispatcher",children:"Coroutine context and dispatcher"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"})," is injected to the default ",(0,o.jsx)(n.code,{children:"CoroutineContext"})," of a ",(0,o.jsx)(n.code,{children:"suspend"})," function,\nso you can access ",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"})," from a ",(0,o.jsx)(n.code,{children:"suspend"})," function with ",(0,o.jsx)(n.a,{href:"type://#",children:"ServiceRequestContext.current()/"}),"\nand the context is inherits to child contexts."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-kotlin",children:"class MyContextAwareService {\n    suspend fun contextPropagation(@Param name: String): String {\n        // Make sure that current thread is request context aware\n        assert(ServiceRequestContext.current() != null)\n\n        return withContext(myDispatcher) {\n            // Make sure that the ServiceRequestContext is propagated to other CoroutineContext which is needed\n            // for logging, tracing.\n            assert(ServiceRequestContext.current() != null)\n            ...\n        }\n    }\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"coroutine-dispatcher",children:"Coroutine dispatcher"}),"\n",(0,o.jsxs)(n.p,{children:["By default, Armeria uses a context-aware event loop as a\n",(0,o.jsx)(n.a,{href:"https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-dispatcher/",children:"coroutine dispatcher"})," to run ",(0,o.jsx)(n.code,{children:"suspend"})," functions.\nA context-aware blocking executor is used as a dispatcher if you annotate a service method with\n",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/annotation/Blocking.html",children:"@Blocking"})," or enable ",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/AnnotatedServiceBindingBuilder.html#useBlockingTaskExecutor(boolean)",children:"AnnotatedServiceBindingBuilder#useBlockingTaskExecutor(boolean)"}),"."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-kotlin",children:'serverBuilder\n    .annotatedService()\n    // Enable `useBlockingTaskExecutor`.\n    .useBlockingTaskExecutor(true)\n    .build(MyAnnotatedService())\n\n// or use @Blocking annotation:\n\nimport com.linecorp.armeria.server.annotation.Blocking\n\nclass MyAnnotatedService {\n    @Blocking\n    @Get("/blocking/users/{name}")\n    suspend fun getUserTokenBlocking(@Param("name") name: String): String {\n        val id = myReactiveClient.getId(name).await()\n        val user = myBlockingRepository.findById(id)\n        return user.token\n    }\n}\n'})}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["If you use ",(0,o.jsx)(n.a,{href:"/docs/advanced/logging",children:"Logback integration"})," or ",(0,o.jsx)(n.a,{href:"/docs/advanced/zipkin",children:"Zipkin integration"}),",\ncoroutines should be executed in a thread that is aware of ",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/RequestContext.html",children:"RequestContext"}),"."]})}),"\n",(0,o.jsxs)(n.h3,{id:"customizing-coroutinecontext-for-annotated-services",children:["Customizing ",(0,o.jsx)(n.code,{children:"CoroutineContext"})," for annotated services"]}),"\n",(0,o.jsxs)(n.p,{children:["Armeria provides a way to configure a coroutine context of annotated service methods\nusing ",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/kotlin/CoroutineContextService.html",children:"CoroutineContextService"})," decorator."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-kotlin",children:'import com.linecorp.armeria.server.kotlin.CoroutineContextService\n\nserverBuilder\n    .annotatedService()\n    .decorator(CoroutineContextService.newDecorator { ctx ->\n        CoroutineName(ctx.config().defaultServiceNaming().serviceName(ctx) ?: "name")\n    })\n    .build(MyAnnotatedService())\n'})}),"\n",(0,o.jsxs)(n.h2,{id:"coroutines-support-for-restclient",children:["Coroutines support for ",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/RestClient.html",children:"RestClient"})]}),"\n",(0,o.jsxs)(n.p,{children:["Armeria provides extension methods to convert ",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/RestClientPreparation.html#execute(java.lang.Class)",children:"RestClientPreparation#execute(Class)"})," to a ",(0,o.jsx)(n.code,{children:"suspend"})," function."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-kotlin",children:'val client = RestClient.of("https://armeria.dev")\n// In a coroutine scope.\nval response: ResponseEntity<RestResponse> =\n   client.get("/api/v1/users/{id}")\n         .pathParam("id", "Armeria")\n         .header(HttpHeaderNames.AUTHORIZATION, "...")\n         // The suspend function executes the request and\n         // returns the response.\n         .execute<RestResponse>()\n'})}),"\n",(0,o.jsxs)(n.h2,{id:"coroutines-support-for-grpc-kotlin",children:["Coroutines support for ",(0,o.jsx)(n.a,{href:"https://github.com/grpc/grpc-kotlin",children:"gRPC-Kotlin"})]}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["Visit ",(0,o.jsx)(n.a,{href:"https://github.com/line/armeria/tree/main/examples/grpc-kotlin",children:"grpc-kotlin"})," to check out a fully working example."]})}),"\n",(0,o.jsx)(n.p,{children:"To use gRPC-Kotlin with Armeria, add the following dependency:"}),"\n",(0,o.jsx)(r,{boms:[{groupId:"com.linecorp.armeria",artifactId:"armeria-bom"}],dependencies:[{groupId:"com.linecorp.armeria",artifactId:"armeria-grpc-kotlin"}]}),"\n",(0,o.jsx)(n.h3,{id:"running-a-grpc-kotlin-service",children:"Running a gRPC-Kotlin service"}),"\n",(0,o.jsxs)(n.p,{children:["gRPC-kotlin support is enabled automatically by registering coroutine stub services in\n",(0,o.jsx)(n.a,{href:"/docs/server/grpc",children:"the same way"})," as using gRPC-Java."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-kotlin",children:'import com.linecorp.armeria.server.Server\nimport com.linecorp.armeria.server.docs.DocService\nimport com.linecorp.armeria.server.grpc.GrpcService\n\nclass YourServiceImpl : YourServiceGrpcKt.YourServiceCoroutineImplBase() {\n  ...\n}\n\n// Creates GrpcService with your gRPC stub generated by gRPC-Kotlin.\nval grpcService =\n  GrpcService\n    .builder()\n    // Add your gRPC-Kotlin stub to GrpcService\n    .addService(YourServiceImpl())\n    .enableUnframedRequests(true)\n    .build()\n\n// Creates Armeria Server for gRPC-Kotlin stub.\nServer\n  .builder()\n  .http(httpPort)\n  .https(httpsPort)\n  .service(grpcService)\n  // Add DocService for browsing the list of gRPC services and\n  // invoking a service operation from a web form.\n  // See https://armeria.dev/docs/server-docservice for more information.\n  .serviceUnder("/docs", DocService())\n  .build()\n'})}),"\n",(0,o.jsx)(n.h3,{id:"calling-a-grpc-kotlin-service",children:"Calling a gRPC-Kotlin service"}),"\n",(0,o.jsxs)(n.p,{children:["You can use ",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/grpc/GrpcClients.html",children:"GrpcClients"})," to specify a coroutine stub that ends with ",(0,o.jsx)(n.code,{children:"CoroutineStub"})," when creating a\ngRPC-Kotlin client."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-kotlin",children:'val client =\n  GrpcClients\n    .builder("https://grpc.service.com")\n    .intercept(yourInterceptors)\n    .build(YourServiceGrpcKt.YourServiceCoroutineStub::class.java)\n'})}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["Please refer to ",(0,o.jsx)(n.a,{href:"/docs/client/grpc",children:"Calling a gRPC service"})," for more information on gRPC clients."]})}),"\n",(0,o.jsxs)(n.h3,{id:"customizing-coroutinecontext-for-grpc-kotlin-services",children:["Customizing ",(0,o.jsx)(n.code,{children:"CoroutineContext"})," for gRPC-Kotlin services"]}),"\n",(0,o.jsxs)(n.p,{children:["When you use gRPC-Kotlin's suspend functions, the default ",(0,o.jsx)(n.code,{children:"CoroutineContext"})," is the combination of\n",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"})," and an event loop ",(0,o.jsx)(n.code,{children:"CoroutineDispatcher"}),". You can access\n",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"})," from the suspend functions with ",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html#current()",children:"ServiceRequestContext#current()"}),",\nsimilar to how you access it in annotated services."]}),"\n",(0,o.jsxs)(n.p,{children:["With Armeria's integration with gRPC-Kotlin, it's easy to set up a custom ",(0,o.jsx)(n.code,{children:"CoroutineContext"})," for your\ngRPC-Kotlin service. You can create your own ",(0,o.jsx)(n.code,{children:"CoroutineContext"})," using ",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/kotlin/CoroutineContextProvider.html",children:"CoroutineContextProvider"}),", and\nadd it to your service through Java SPI."]}),"\n",(0,o.jsxs)(n.p,{children:["Note that the ",(0,o.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"})," is still a part of the\n",(0,o.jsx)(n.code,{children:"CoroutineContext"}),", but the event loop ",(0,o.jsx)(n.code,{children:"CoroutineDispatcher"})," is disabled if the custom ",(0,o.jsx)(n.code,{children:"CoroutineContext"}),"\nis used."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-kotlin",children:"class CustomCoroutineContextProvider : CoroutineContextProvider {\n    override fun provide(ctx: ServiceRequestContext): CoroutineContext {\n      return ... // A custom CoroutineContext\n    }\n}\n"})}),"\n",(0,o.jsx)(n.admonition,{type:"tip",children:(0,o.jsxs)(n.p,{children:["A custom ",(0,o.jsx)(n.code,{children:"CoroutineContextProvider"})," should be registered via Java SPI in\n",(0,o.jsx)(n.code,{children:"META-INF/services/com.linecorp.armeria.common.kotlin.CoroutineContextProvider"}),"."]})})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}}}]);