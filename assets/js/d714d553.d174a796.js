"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[8090],{28453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>s});var r=i(96540);const t={},a=r.createContext(t);function o(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(a.Provider,{value:n},e.children)}},31655:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"advanced/saml","title":"SAML Single Sign-On","description":"Visit armeria-examples to find a fully working example.","source":"@site/src/content/docs/advanced/saml.mdx","sourceDirName":"advanced","slug":"/advanced/saml","permalink":"/docs/advanced/saml","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site/src/content/docs/advanced/saml.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Production checklist","permalink":"/docs/advanced/production-checklist"},"next":{"title":"Athenz integration","permalink":"/docs/advanced/athenz"}}');var t=i(74848),a=i(28453);const o={},s="SAML Single Sign-On",d={},c=[{value:"What is SAML?",id:"what-is-saml",level:2},{value:"Configuring your server as a service provider",id:"configuring-your-server-as-a-service-provider",level:2},{value:"How to handle the authentication response",id:"how-to-handle-the-authentication-response",level:2},{value:"What services are automatically configured",id:"what-services-are-automatically-configured",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components},{RequiredDependencies:i}=n;return i||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("RequiredDependencies",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"saml-single-sign-on",children:"SAML Single Sign-On"})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["Visit ",(0,t.jsx)(n.a,{href:"https://github.com/line/armeria-examples",children:"armeria-examples"})," to find a fully working example."]})}),"\n",(0,t.jsx)(n.h2,{id:"what-is-saml",children:"What is SAML?"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Security_Assertion_Markup_Language",children:"Security Assertion Markup Language (SAML)"}),"\nis an open standard for exchanging authentication and authorization data between an identity provider and\na service provider. In this protocol, a service provider is an endpoint which provides a web service to\nan end user, and an identity provider is in charge of authenticating an end user with information sent by\nthe service provider.\nArmeria currently provides ",(0,t.jsx)(n.a,{href:"https://wiki.shibboleth.net/confluence/display/OS30/Home",children:"OpenSAML"})," based\n",(0,t.jsx)(n.code,{children:"armeria-saml"})," module in order to support the integration with an identity provider from a service\nprovider's point of view."]}),"\n",(0,t.jsx)(n.h2,{id:"configuring-your-server-as-a-service-provider",children:"Configuring your server as a service provider"}),"\n",(0,t.jsxs)(n.p,{children:["The first step to configure a service provider is adding ",(0,t.jsx)(n.code,{children:"armeria-saml"})," to your dependencies."]}),"\n",(0,t.jsx)(i,{boms:[{groupId:"com.linecorp.armeria",artifactId:"armeria-bom"}],dependencies:[{groupId:"com.linecorp.armeria",artifactId:"armeria-saml"}]}),"\n",(0,t.jsxs)(n.p,{children:["After that, you need to prepare your keystore file which contains a key pair for signing and encryption\nof a SAML message. Also, you need to import the certificate of your identity provider into the keystore\nwhich contains your key pairs. In this example, we are using a free identity provider service hosted by\n",(0,t.jsx)(n.a,{href:"https://www.ssocircle.com/en/",children:"SSOCircle"})," in order to authenticate an end user. The following commands\nmay help you to get a keystore."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Generate new key pairs as alias 'signing' and 'encryption'.\nkeytool -genkeypair -keystore sample.jks -storepass 'N5^X[hvG' -keyalg rsa -sigalg sha1withrsa \\\n  -dname 'CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown' -alias signing \\\n  -deststoretype pkcs12\nkeytool -genkeypair -keystore sample.jks -storepass 'N5^X[hvG' -keyalg rsa -sigalg sha1withrsa \\\n  -dname 'CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown' -alias encryption \\\n  -deststoretype pkcs12\n\n# Import a certificate into the keystore as alias 'https://idp.ssocircle.com', which is the entity ID\n# of the SSOCircle. You can make 'ssocircle.crt' file with the certificate from\n# 'https://www.ssocircle.com/en/idp-tips-tricks/public-idp-configuration/'.\nkeytool -importcert -keystore sample.jks -storepass 'N5^X[hvG' -file ssocircle.crt \\\n  -alias 'https://idp.ssocircle.com'\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Finally, you need to create your ",(0,t.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/saml/SamlServiceProvider.html",children:"SamlServiceProvider"})," with a ",(0,t.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/saml/SamlServiceProviderBuilder.html",children:"SamlServiceProviderBuilder"}),", and\nattach it to your ",(0,t.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/Server.html",children:"Server"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// Specify information about your keystore.\n// The keystore contains two key pairs, which are identified as \'signing\' and \'encryption\'.\nCredentialResolver credentialResolver =\n        new KeyStoreCredentialResolverBuilder(ClassLoader.getSystemClassLoader(),\n                                              "sample.jks")\n                .type("PKCS12")\n                .password("N5^X[hvG")\n                // You need to specify your key pair and its password here.\n                .keyPassword("signing", "N5^X[hvG")\n                .keyPassword("encryption", "N5^X[hvG")\n                .build();\n\nSamlServiceProvider ssp =\n        SamlServiceProvider.builder()\n                           .credentialResolver(credentialResolver)\n                           // Specify the entity ID of this service provider.\n                           // You can specify what you want.\n                           .entityId("your-sp-id")\n                           .hostname("your-service-domain-name")\n                           // Specify an authorizer in order to authenticate a request.\n                           .authorizer(new Authorizer<HttpRequest>() { ... })\n                           // Specify a SAML single sign-on handler\n                           // which sends a response to an end user\n                           // after he or she is authenticated or not.\n                           .ssoHandler(new SamlSingleSignOnHandler() { ... })\n                           // Specify the signature algorithm of your key.\n                           .signatureAlgorithm(SignatureConstants.ALGO_ID_SIGNATURE_RSA)\n                           .idp()\n                           // Specify the entity ID of the identity provider.\n                           // It can be found from the metadata of the identity provider.\n                           .entityId("https://idp.ssocircle.com")\n                           // Specify the endpoint that is supposed to send an authentication request.\n                           .ssoEndpoint(\n                               ofHttpPost("https://idp.ssocircle.com:443/sso/SSOPOST/metaAlias/publicidp"))\n                           .and()\n                           .build();\n\nServer server = Server.builder()\n                      .https(8443)\n                      // Configure TLS with your key and certificate.\n                      .tls(new File("your-certificate-file-path"), new File("your-key-file-path"))\n                      // Decorate you service with SAML decorator.\n                      .annotatedService("/", new MyService(), ssp.newSamlDecorator())\n                      // Add SAML service to your server which handles a SAML response and a metadata request.\n                      .service(ssp.newSamlService())\n                      .build();\n'})}),"\n",(0,t.jsx)(n.h2,{id:"how-to-handle-the-authentication-response",children:"How to handle the authentication response"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"armeria-saml"})," provides ",(0,t.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/saml/SamlSingleSignOnHandler.html",children:"SamlSingleSignOnHandler"})," to handle the response from an identity provider.\nIt consists of ",(0,t.jsx)(n.code,{children:"loginSucceeded()"})," and ",(0,t.jsx)(n.code,{children:"loginFailed()"})," methods which handle the response,\nand ",(0,t.jsx)(n.code,{children:"beforeInitiatingSso()"})," which handles a request. In most cases, you only need to write the two methods\nwhich handle the response, but if you want to send data to your identity provider and get it back\nwith a response, you need to implement ",(0,t.jsx)(n.code,{children:"beforeInitiatingSso()"})," method."]}),"\n",(0,t.jsxs)(n.p,{children:["The following example shows a simple implementation of the ",(0,t.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/saml/SamlSingleSignOnHandler.html",children:"SamlSingleSignOnHandler"}),". In this example,\nif an authentication is succeeded, an email address is retrieved from the response by referring to a ",(0,t.jsx)(n.code,{children:"name ID"}),"\nelement in the assertion, then it is sent to the end user via ",(0,t.jsx)(n.code,{children:"Set-Cookie"})," header. It means that your\n",(0,t.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/auth/Authorizer.html",children:"Authorizer"})," can identify an authenticated session with a ",(0,t.jsx)(n.code,{children:"Cookie"})," header in the following requests,\nlike ",(0,t.jsx)(n.code,{children:"MyAuthorizer"})," in this example."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'class MySamlSingleSignOnHandler implements SamlSingleSignOnHandler {\n    @Override\n    public HttpResponse loginSucceeded(ServiceRequestContext ctx, AggregatedHttpRequest req,\n                                       MessageContext<Response> message, @Nullable String sessionIndex,\n                                       @Nullable String relayState) {\n        final Response response = message.getMessage();\n        final String username = response.getAssertions().stream()\n                                        .map(s -> s.getSubject().getNameID())\n                                        .filter(id -> id.getFormat().equals(SamlNameIdFormat.EMAIL.urn()))\n                                        .map(NameIDType::getValue)\n                                        .findFirst()\n                                        .orElse(null);\n        if (username == null) {\n            return HttpResponse.of(HttpStatus.UNAUTHORIZED, MediaType.HTML_UTF_8,\n                                   "<html><body>Username is not found.</body></html>");\n        }\n\n        // Note that you MUST NOT use this example in a real world application. You may consider encoding\n        // the value using JSON Web Tokens to prevent tempering.\n        final Cookie cookie = Cookie.secureBuilder("username", username)\n                                    .domain("localhost")\n                                    .maxAge(60)\n                                    .path("/")\n                                    .build();\n        return HttpResponse.of(\n                ResponseHeaders,of(HttpStatus.OK,\n                                   HttpHeaderNames.CONTENT_TYPE, MediaType.HTML_UTF_8,\n                                   HttpHeaderNames.SET_COOKIE, cookie.toSetCookieHeader()),\n                HttpData.ofUtf8("<html><body onLoad=\\"window.location.href=\'/welcome\'\\"></body></html>"));\n    }\n\n    @Override\n    public HttpResponse loginFailed(ServiceRequestContext ctx, AggregatedHttpRequest req,\n                                    @Nullable MessageContext<Response> message, Throwable cause) {\n        return HttpResponse.of(HttpStatus.UNAUTHORIZED, MediaType.HTML_UTF_8,\n                               "<html><body>Login failed.</body></html>");\n    }\n}\n\nclass MyAuthorizer implements Authorizer<HttpRequest> {\n    @Override\n    public CompletionStage<Boolean> authorize(ServiceRequestContext ctx, HttpRequest data) {\n        // Note that you MUST NOT use this example in a real world application. You have to perform\n        // proper validation in your application.\n        final String cookie = data.headers().get(HttpHeaderNames.COOKIE);\n        if (cookie == null) {\n            return UnmodifiableFuture.completedFuture(false);\n        }\n\n        final boolean authenticated = Cookie.fromCookieHeader(cookie).stream().anyMatch(\n                c -> "username".equals(c.name()) && !Strings.isNullOrEmpty(c.value()));\n        return UnmodifiableFuture.completedFuture(authenticated);\n    }\n}\n'})}),"\n",(0,t.jsx)(n.admonition,{type:"warning",children:(0,t.jsxs)(n.p,{children:["The above implementation is just an example that shows you how to handle the response, so it is recommended\nthat you write your own ",(0,t.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/saml/SamlSingleSignOnHandler.html",children:"SamlSingleSignOnHandler"})," according to your authentication system."]})}),"\n",(0,t.jsx)(n.h2,{id:"what-services-are-automatically-configured",children:"What services are automatically configured"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"armeria-saml"})," module automatically adds SAML services to your server with the following default paths:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"/saml/acs/post"})," and ",(0,t.jsx)(n.code,{children:"/saml/acs/redirect"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"SAML assertion consumer services for HTTP Post binding and HTTP Redirect binding. These services are invoked\nby an identity provider when it responds to an authentication request received from your service."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"/saml/slo/post"})," and ",(0,t.jsx)(n.code,{children:"/saml/slo/redirect"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"SAML single logout services for HTTP Post binding and HTTP Redirect binding. These services may be invoked\nby an identity provider when it performs global logout."}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"/saml/metadata"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["SAML metadata service. In the metadata, the endpoints for assertion consumer services and single logout\nservices are specified by ",(0,t.jsx)(n.code,{children:"md:AssertionConsumerService"})," and ",(0,t.jsx)(n.code,{children:"md:SingleLogoutService"})," elements\nrespectively. The certificates of the ",(0,t.jsx)(n.code,{children:"signing"})," and ",(0,t.jsx)(n.code,{children:"encryption"})," key pair are also included."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["In order for your service to act as a service provider, you need to register your service to your identity\nprovider, and providing your metadata is the easiest way to do that. You can get your metadata from\n",(0,t.jsx)(n.code,{children:"https://your-service-domain-name:your-service-port/saml/metadata"}),"."]})})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}}}]);