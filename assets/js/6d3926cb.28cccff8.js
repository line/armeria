"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[1202],{12043:e=>{e.exports=JSON.parse('{"permalink":"/blog/2016/07/24/circuit-breakers-for-distributed-services","editUrl":"https://github.com/line/armeria/edit/main/site-new/src/content/blog/en/2016-07-24-circuit-breakers-for-distributed-services.mdx","source":"@site/src/content/blog/en/2016-07-24-circuit-breakers-for-distributed-services.mdx","title":"Circuit breakers for distributed services","description":"Hello, my name is Ono and I\'m a LINE engineer.","date":"2016-07-24T00:00:00.000Z","tags":[],"readingTime":5.39,"hasTruncateMarker":true,"authors":[{"name":"Ono Yuichi","title":"He is a LINE engineer.","imageURL":"/img/author-onoyuichi.png","key":"onoyuichi","page":null}],"frontMatter":{"authors":["onoyuichi"],"other_languages":{"ja":"/blog/ja/2016/07/14/circuit-breakers-for-distributed-services","ko":"/blog/ko/2016/07/24/circuit-breakers-for-distributed-services"}},"unlisted":false,"prevItem":{"title":"Applying CircuitBreaker to Channel Gateway","permalink":"/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway"},"nextItem":{"title":"Open-sourcing Armeria","permalink":"/blog/2016/04/13/open-sourcing-armeria"}}')},28453:(e,r,i)=>{i.d(r,{R:()=>a,x:()=>c});var t=i(96540);const n={},s=t.createContext(n);function a(e){const r=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:a(e.components),t.createElement(s.Provider,{value:r},e.children)}},45587:(e,r,i)=>{i.d(r,{A:()=>t});const t=i.p+"assets/images/circuit-breakers-for-distributed-services-2-94100185efcea1b197617840a9c6a288.png"},49796:(e,r,i)=>{i.r(r),i.d(r,{assets:()=>o,contentTitle:()=>c,default:()=>d,frontMatter:()=>a,metadata:()=>t,toc:()=>l});var t=i(12043),n=i(74848),s=i(28453);const a={authors:["onoyuichi"],other_languages:{ja:"/blog/ja/2016/07/14/circuit-breakers-for-distributed-services",ko:"/blog/ko/2016/07/24/circuit-breakers-for-distributed-services"}},c="Circuit breakers for distributed services",o={authorsImageUrls:[void 0]},l=[{value:"What is a Circuit Breaker?",id:"what-is-a-circuit-breaker",level:2},{value:"Circuit breakers for Armeria",id:"circuit-breakers-for-armeria",level:2},{value:"Grouping",id:"grouping",level:2},{value:"Failure Rate",id:"failure-rate",level:2},{value:"Monitoring",id:"monitoring",level:2},{value:"Using Armeria&#39;s circuit breaker independently",id:"using-armerias-circuit-breaker-independently",level:2}];function h(e){const r={a:"a",br:"br",code:"code",em:"em",h2:"h2",img:"img",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.p,{children:"Hello, my name is Ono and I'm a LINE engineer.\nIn this blog post, I'd like to talk about \"circuit breakers\" which we use with our LINE servers."}),"\n",(0,n.jsx)(r.h2,{id:"what-is-a-circuit-breaker",children:"What is a Circuit Breaker?"}),"\n",(0,n.jsx)(r.p,{children:"The backend server systems for various web services and apps including LINE consist of networks that have several services connected with each other through APIs and RPCs."}),"\n",(0,n.jsx)(r.p,{children:"What would happen if one of these networks suddenly failed to respond?\nThe downed services would be blocked until they time-out, and all other services that rely on the blocked service would start a chain reaction of failures.\nIf no one has been keeping an eye on the entire network, it will take a long time to figure out which service is the root cause."}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{alt:"-BG-",src:i(99832).A+"",width:"537",height:"141"})}),"\n","\n",(0,n.jsx)(r.p,{children:"These chain reaction failures should be prevented at all costs.\nAt the least, the core features must be protected from these failures.\nTo achieve that, we must block off access to the downed service before it affects another."}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{alt:"-BG-",src:i(45587).A+"",width:"537",height:"140"})}),"\n",(0,n.jsx)(r.p,{children:"Circuit breakers are used to automate this whole process."}),"\n",(0,n.jsxs)(r.p,{children:["[",(0,n.jsx)(r.a,{href:"http://martinfowler.com/bliki/CircuitBreaker.html",children:"http://martinfowler.com/bliki/CircuitBreaker.html"}),"]"]}),"\n",(0,n.jsx)(r.p,{children:"The in-depth details behind the system can be found in the post above by Martin Fowler, but I'll keep it brief here."}),"\n",(0,n.jsx)(r.p,{children:"A circuit breaker is a system that automatically blocks off access when the number of failed remote access attempts exceeds the failure rate."}),"\n",(0,n.jsx)(r.p,{children:"Circuit breakers can be seen as state machines.\nThey can automatically detect failures and determine when they're restored by continuously updating access success and failure events."}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{src:i(90378).A+"",width:"749",height:"182"})}),"\n",(0,n.jsx)(r.p,{children:"Below are details for each state and their conditions."}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"CLOSED"}),(0,n.jsx)(r.br,{}),"\n","Initial state.\nAll accesses are treated normally."]}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"OPEN"}),(0,n.jsx)(r.br,{}),"\n","The state changes to OPEN once the number of failures exceeds the failure rate.\nAll accesses are blocked off (fail fast)."]}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"HALF_OPEN"}),(0,n.jsx)(r.br,{}),"\n","After a certain amount of time in the OPEN state, it changes into the HALF_OPEN state.\nIf an attempted access succeeds, the state changes to CLOSED.\nIf access fails, the state changes to OPEN."]}),"\n",(0,n.jsx)(r.h2,{id:"circuit-breakers-for-armeria",children:"Circuit breakers for Armeria"}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.a,{href:"http://line.github.io/armeria/",children:"Armeria"})," is an asynchronous Thrift client/server library based on Netty, released as a LINE open source project.\nOne of Armeria's many key features is its ability to expand features using decorators."]}),"\n",(0,n.jsx)(r.p,{children:"Starting with version 0.13.0 of Armeria, it is possible to add circuit breakers using decorators."}),"\n",(0,n.jsx)(r.p,{children:"Below is an example of initializing a Thrift client using a circuit breaker."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'Iface helloClient = new ClientBuilder("tbinary+http://127.0.0.1:8080/hello")\n                     .decorator(\n                      CircuitBreakerClient.newDecorator(\n                          new CircuitBreakerBuilder("hello").build()\n                      )\n                     )\n                     .build(Iface.class);\n'})}),"\n",(0,n.jsx)(r.p,{children:"Easy, right?"}),"\n",(0,n.jsx)(r.p,{children:"Below is the code for calling this Thrift client."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'try {\n    helloClient.hello("line");\n} catch (TException e) {\n    // error handling\n} catch (FailFastException e) {\n   // fallback code\n}\n'})}),"\n",(0,n.jsx)(r.p,{children:"As you can see in the example above, when the circuit breaker detects a failure, the Thrift client will send a FailFastException, running the appropriate fallback code.\nIt can be used in the same way for an asynchronous client."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'helloClient.hello("line", new AsyncMethodCallback() {\n  public void onComplete(Object response) {\n     // response handling\n  }\n  public void onError(Exception e) {\n     if (e instanceof TException) {\n         // error handling\n     } else if (e instanceof FailFastException) {\n         // fallback code\n     }\n }\n});\n'})}),"\n",(0,n.jsx)(r.h2,{id:"grouping",children:"Grouping"}),"\n",(0,n.jsx)(r.p,{children:"In the example above, a single circuit breaker was allocated for each Thrift service.\nIn this case, if a single method causes a problem in a service, all other methods will be blocked when the circuit breaker becomes active.\nThis would only spread the failure to more parts, and isn't something that is recommended."}),"\n",(0,n.jsx)(r.p,{children:"That's why Armeria lets its users group the range of circuit breaker instances in a variety of ways."}),"\n",(0,n.jsx)(r.p,{children:"Below are the grouping conditions."}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"Per Host"}),(0,n.jsx)(r.br,{}),"\n","A single circuit breaker is allocated for each remote host."]}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"Per Method"}),(0,n.jsx)(r.br,{}),"\n","A single circuit breaker is allocated for each method."]}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"Per Host and Method"}),(0,n.jsx)(r.br,{}),"\n","A single circuit breaker is allocated each method in each host."]}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{alt:"-BG-",src:i(73605).A+"",width:"684",height:"279"})}),"\n",(0,n.jsx)(r.h2,{id:"failure-rate",children:"Failure Rate"}),"\n",(0,n.jsx)(r.p,{children:"When using circuit breakers, it's important to clearly define the conditions for a failure."}),"\n",(0,n.jsxs)(r.p,{children:["Failures in Armeria are when the number of failed requests (failure rate) exceeds the ",(0,n.jsx)(r.em,{children:"Failure Rate Threshold"}),"."]}),"\n",(0,n.jsxs)(r.p,{children:["However, in cases where there are too few requests, (such as right after launching) the failure rate will be too irregular and the system may incorrectly assess the situation as a failure.\nTo resolve this, you can set a ",(0,n.jsx)(r.em,{children:"Minimum Request Threshold"})," so that the system only begins to detect failures when the number of requests is at least at a certain amount."]}),"\n",(0,n.jsxs)(r.p,{children:["The duration of the time where detection begins can also be adjusted with the ",(0,n.jsx)(r.em,{children:"Sliding Window"}),"."]}),"\n",(0,n.jsx)(r.p,{children:"The correlation between the failure rate and the sliding window can be seen in the figure below."}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{alt:"-BG-",src:i(90716).A+"",width:"585",height:"277"})}),"\n",(0,n.jsx)(r.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,n.jsx)(r.p,{children:"You can monitor the status of circuit breakers by adding a listener."}),"\n",(0,n.jsx)(r.p,{children:"Below is sample code using a listener based on Dropwizard Metrics provided by Armeria.\nYou can implement listeners that match your customized monitoring system."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'MetricRegistry registry = new MetricRegistry();\n\nIface helloClient = new ClientBuilder("tbinary+http://127.0.0.1:8080/hello")\n       .decorator(\n        CircuitBreakerClient.newDecorator(\n          new CircuitBreakerBuilder("hello")\n            .listener(new DropwizardMetricsCircuitBreakerListener(registry, "hello"))\n            .build()\n        )\n       )\n       .build(Iface.class);\n'})}),"\n",(0,n.jsx)(r.h2,{id:"using-armerias-circuit-breaker-independently",children:"Using Armeria's circuit breaker independently"}),"\n",(0,n.jsx)(r.p,{children:"Up to this point, I've talked about how you can combine the Armeria thrift client and circuit breaker package, but it's also possible to use the circuit breaker package independently."}),"\n",(0,n.jsx)(r.p,{children:"When using the circuit breaker package independently, keep the following 3 APIs in mind."}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"CircuitBreaker#canRequest()"}),(0,n.jsx)(r.br,{}),"\n",'Checks the status of the circuit breaker.\nIf the circuit is blocked off, the returned value will be "false."']}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"CircuitBreaker#onSuccess()"}),(0,n.jsx)(r.br,{}),"\n","Records successful access attempts to a service."]}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.strong,{children:"CircuitBreaker#onFailure() or CircuitBreaker#onFailure(Throwable t)"}),(0,n.jsx)(r.br,{}),"\n","Records failed access attempts to a service."]}),"\n",(0,n.jsx)(r.p,{children:"In the sample code below, canRequest() checks the status of the circuit and runs remote service access if there are no problems detected.\nDepending on the result, the API will call onSuccess or onFailure."}),"\n",(0,n.jsx)(r.p,{children:'The trigger condition for this sample was set to "whether or not exceptions were detected," but you can change the condition to whatever fits your needs.\nFor example, you can make it so that it counts as an error if remote service access took a certain amount of time even if there were no exceptions detected.'}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"if (circuitBreaker.canRequest()) {\n   try {\n       // remote service access\n\n       circuitBreaker.onSuccess();\n   } catch (Exception e) {\n       circuitBreaker.onFailure(e);\n   }\n} else {\n   // fail fast\n}\n"})}),"\n",(0,n.jsx)(r.p,{children:"This concludes my introduction to the circuit breaker feature in Armeria."}),"\n",(0,n.jsx)(r.p,{children:"In a future post, I plan to give you some real-life use cases from inside LINE."})]})}function d(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},73605:(e,r,i)=>{i.d(r,{A:()=>t});const t=i.p+"assets/images/circuit-breakers-for-distributed-services-4-4ae96ba1d797e52c0fc3b3f1f3909775.png"},90378:(e,r,i)=>{i.d(r,{A:()=>t});const t=i.p+"assets/images/circuit-breakers-for-distributed-services-3-706b943b1852878bf1209d68ac7ca623.png"},90716:(e,r,i)=>{i.d(r,{A:()=>t});const t=i.p+"assets/images/circuit-breakers-for-distributed-services-5-2ff3131f0701105e189fa5953d2d9c1e.png"},99832:(e,r,i)=>{i.d(r,{A:()=>t});const t=i.p+"assets/images/circuit-breakers-for-distributed-services-1-5bb7df69bbea59e475a05522088cd493.png"}}]);