"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[857],{12130:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"advanced/structured-logging","title":"Structured logging","description":"Although traditional logging is a useful tool to diagnose the behavior of an application, it has its own","source":"@site/src/content/docs/advanced/structured-logging.mdx","sourceDirName":"advanced","slug":"/advanced/structured-logging","permalink":"/docs/advanced/structured-logging","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site/src/content/docs/advanced/structured-logging.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Logging contextual information","permalink":"/docs/advanced/logging"},"next":{"title":"RequestContext custom attributes","permalink":"/docs/advanced/custom-attributes"}}');var i=t(74848),o=t(28453);const s={},c="Structured logging",a={},l=[{value:"What properties can be retrieved?",id:"what-properties-can-be-retrieved",level:2},{value:"Request properties",id:"request-properties",level:3},{value:"Response properties",id:"response-properties",level:3},{value:"Client connection timing properties",id:"client-connection-timing-properties",level:3},{value:"Availability of properties",id:"availability-of-properties",level:2},{value:"Availability of client timing properties",id:"availability-of-client-timing-properties",level:3},{value:"Enabling content previews",id:"enabling-content-previews",level:2},{value:"Nested log",id:"nested-log",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"structured-logging",children:"Structured logging"})}),"\n",(0,i.jsx)(n.p,{children:"Although traditional logging is a useful tool to diagnose the behavior of an application, it has its own\nproblem; the resulting log messages are not always machine-friendly. This section explains the Armeria API for\nretrieving the information collected during request life cycle in a machine-friendly way."}),"\n",(0,i.jsx)(n.h2,{id:"what-properties-can-be-retrieved",children:"What properties can be retrieved?"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/RequestLog.html",children:"RequestLog"})," provides various properties recorded while handling a request:"]}),"\n",(0,i.jsx)(n.h3,{id:"request-properties",children:"Request properties"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:(0,i.jsx)("div",{style:{width:"13rem"},children:"Property"})}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"requestStartTimeMicros"})}),(0,i.jsx)(n.td,{children:"when the request processing started, in microseconds since the epoch (01-Jan-1970 00:00:00 UTC)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"requestDurationNanos"})}),(0,i.jsx)(n.td,{children:"the duration took to process the request completely"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"requestLength"})}),(0,i.jsx)(n.td,{children:"the byte length of the request content"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"requestCause"})}),(0,i.jsx)(n.td,{children:"the cause of request processing failure (if any)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"sessionProtocol"})}),(0,i.jsxs)(n.td,{children:["the protocol of the connection (e.g. ",(0,i.jsx)(n.code,{children:"H2C"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"serializationFormat"})}),(0,i.jsxs)(n.td,{children:["the serialization format of the content (e.g. ",(0,i.jsx)(n.code,{children:"tbinary"}),", ",(0,i.jsx)(n.code,{children:"none"}),")"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"name"})}),(0,i.jsxs)(n.td,{children:["the human-readable simple name of the request, such as: - gRPC - A capitalized method name defined in ",(0,i.jsx)(n.code,{children:"io.grpc.MethodDescriptor"})," (e.g, ",(0,i.jsx)(n.code,{children:"GetItems"}),") - Thrift and annotated service - a method name (e.g, ",(0,i.jsx)(n.code,{children:"getItems"}),") - ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/HttpService.html",children:"HttpService"})," - an HTTP method name"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"serviceName"})}),(0,i.jsxs)(n.td,{children:["the human-readable name of the service that served the request, such as: - gRPC - a service name (e.g, ",(0,i.jsx)(n.code,{children:"com.foo.GrpcService"}),") - Thrift - a service type (e.g, ",(0,i.jsx)(n.code,{children:"com.foo.ThriftService$AsyncIface"})," or ",(0,i.jsx)(n.code,{children:"com.foo.ThriftService$Iface)"})," - ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/HttpService.html",children:"HttpService"})," and annotated service - an innermost class name"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"host"})}),(0,i.jsx)(n.td,{children:"the name of the virtual host that serves the request"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"requestHeaders"})}),(0,i.jsxs)(n.td,{children:["the HTTP headers of the request. the header contains the method (e.g. ",(0,i.jsx)(n.code,{children:"GET"}),", ",(0,i.jsx)(n.code,{children:"POST"}),"), the path (e.g. ",(0,i.jsx)(n.code,{children:"/thrift/foo"}),"), the query (e.g. ",(0,i.jsx)(n.code,{children:"foo=bar&bar=baz"}),"), the content type, etc."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"requestContent"})}),(0,i.jsxs)(n.td,{children:["the serialization-dependent content object of the request. ",(0,i.jsx)(n.code,{children:"ThriftCall"})," for Thrift. ",(0,i.jsx)(n.code,{children:"null"})," otherwise."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"requestContentPreview"})}),(0,i.jsx)(n.td,{children:"the preview of the request content"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"response-properties",children:"Response properties"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:(0,i.jsx)("div",{style:{width:"13rem"},children:"Property"})}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"responseStartTimeMicros"})}),(0,i.jsx)(n.td,{children:"when the response processing started, in microseconds since the epoch (01-Jan-1970 00:00:00 UTC)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"responseDurationNanos"})}),(0,i.jsx)(n.td,{children:"the duration took to process the response completely"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"responseLength"})}),(0,i.jsx)(n.td,{children:"the byte length of the response content"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"responseCause"})}),(0,i.jsx)(n.td,{children:"the cause of response processing failure (if any)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"totalDurationNanos"})}),(0,i.jsx)(n.td,{children:"the duration between the request start and the response end (i.e. response time)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"responseHeaders"})}),(0,i.jsx)(n.td,{children:"the HTTP headers of the response. the header contains the statusCode (e.g. 404), the content type, etc."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"responseContent"})}),(0,i.jsxs)(n.td,{children:["the serialization-dependent content object of the response. ",(0,i.jsx)(n.code,{children:"ThriftReply"})," for Thrift. ",(0,i.jsx)(n.code,{children:"null"})," otherwise."]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"responseContentPreview"})}),(0,i.jsx)(n.td,{children:"the preview of the response content"})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"totalDurationNanos"})," value is calculated differently between the client-side and the server-side."]}),"\n",(0,i.jsxs)(n.p,{children:["For the server-side, ",(0,i.jsx)(n.code,{children:"totalDurationNanos"})," starts when the server receives the ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/RequestHeaders.html",children:"RequestHeaders"})," and\nends when the server sends the response fully:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bob-svg",children:"\n           +---------------------------------------------------------------------+\n           |<--------------------------totalDurationNanos-----------------------\x3e|\n           +----------------------------+----------------------------------------+\n           |<---requestDurationNanos---\x3e|\n           +----------------------------+            +---------------------------+\n           ^                            ^            |<--responseDurationNanos--\x3e|\n           :                            :            +---------------------------+\n           :                            :            ^                           ^\n  Received RequestHeaders    Received the last frame :                           :\n                                                     :                           :\n                                           Sending ResponseHeaders    Sending the last frame\n"})}),"\n",(0,i.jsxs)(n.p,{children:["As you noticed, ",(0,i.jsx)(n.code,{children:"totalDurationNanos"})," is not the sum of ",(0,i.jsx)(n.code,{children:"requestDurationNanos"})," and ",(0,i.jsx)(n.code,{children:"responseDurationNanos"}),".\nThe sum of ",(0,i.jsx)(n.code,{children:"requestDurationNanos"})," and ",(0,i.jsx)(n.code,{children:"responseDurationNanos"})," even can be greater than ",(0,i.jsx)(n.code,{children:"totalDurationNanos"})," when\nthe ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/ResponseHeaders.html",children:"ResponseHeaders"})," is sent before the service receives the ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpRequest.html",children:"HttpRequest"})," fully:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bob-svg",children:"\n           +---------------------------------------------------------------------+\n           |<--------------------------totalDurationNanos-----------------------\x3e|\n           +--------------------------------------------+------------------------+\n           |<-----------requestDurationNanos-----------\x3e|\n           +-----------------------+--------------------+------------------------+\n                                   |<-----------responseDurationNanos-----------\x3e|\n                                   +---------------------------------------------+\n                                   ^\n                                   :\n             Sending ResponseHeaders before the service fully receives the request\n"})}),"\n",(0,i.jsxs)(n.p,{children:["On the other hand, ",(0,i.jsx)(n.code,{children:"totalDurationNanos"})," of the client-side contains\n",(0,i.jsx)(n.a,{href:"/docs/advanced/structured-logging#client-connection-timing-properties",children:"connectionAcquisitionDuration"}),",\nbecause a client may have to establish a new connection or acquire an existing connection from\nthe connection pool before sending a request:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bob-svg",children:"\n   +------------------------------------------------------------------------------------------+\n   |<------------------------------------totalDurationNanos----------------------------------\x3e|\n   +---------------------------+--------------------------------------------------------------+\n   |<--connectionAcquisition--\x3e|\n   +---------------------------+  +--------------------------+\n                                  |<--requestDurationNanos--\x3e|\n                                  +--------------------------+    +---------------------------+\n                                  ^                          ^    |<--responseDurationNanos--\x3e|\n                                  :                          :    +---------------------------+\n                                  :                          :    ^                           ^\n                   Sending RequestHeaders   Sending the last frame:                           :\n                                                                  :                           :\n                                              Received ResponseHeaders  Received the last chunk\n"})}),"\n",(0,i.jsxs)(n.admonition,{type:"tip",children:[(0,i.jsx)(n.p,{children:"In the client-side, the response timeout scheduler starts by the first of the following two events:"}),(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The client sends the last frame of an ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpRequest.html",children:"HttpRequest"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["The client receives a ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/ResponseHeaders.html",children:"ResponseHeaders"}),"."]}),"\n"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bob-svg",children:"\n +-------------------------------------------------------------------------------+\n |<-------------------------totalDurationNanos----------------------------------\x3e|\n +----------------+--------------------------------------------------------------+\n |<--connection--\x3e|\n +----------------+  +--------------------------+\n                     |<--requestDurationNanos--\x3e|\n                     +--------------------------+    +---------------------------+\n                                                ^    |<--responseDurationNanos--\x3e|\n                                                :    +---------------------------+\n                                 Response timeout scheduler starts\n                                      :\n                                      v\n                     +------------------------------------------+\n                     |<----------requestDurationNanos----------\x3e|\n                     +------------------------------------------+----------------+\n                                      |<-----------responseDurationNanos--------\x3e|\n                                      +------------------------------------------+\n\n"})})]}),"\n",(0,i.jsx)(n.h3,{id:"client-connection-timing-properties",children:"Client connection timing properties"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:(0,i.jsx)("div",{style:{width:"20rem"},children:"Property"})}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"connectionAcquisitionStartTimeMicros"})}),(0,i.jsx)(n.td,{children:"when the client started to acquire a connection, in microseconds since the epoch (01-Jan-1970 00:00:00 UTC)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"connectionAcquisitionDurationNanos"})}),(0,i.jsx)(n.td,{children:"the duration took to get a connection (i.e. the total duration)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"dnsResolutionStartTimeMicros"})}),(0,i.jsxs)(n.td,{children:["when the client started to resolve a domain name, in microseconds since the epoch (01-Jan-1970 00:00:00 UTC), ",(0,i.jsx)(n.code,{children:"-1"})," if DNS lookup did not occur"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"dnsResolutionDurationNanos"})}),(0,i.jsxs)(n.td,{children:["the duration took to resolve a domain name, ",(0,i.jsx)(n.code,{children:"-1"})," if DNS lookup did not occur"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"socketConnectStartTimeMicros"})}),(0,i.jsxs)(n.td,{children:["when the client started to connect to a remote peer, in microseconds since the epoch (01-Jan-1970 00:00:00 UTC), ",(0,i.jsx)(n.code,{children:"-1"})," if socket connection attempt did not occur"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"socketConnectDurationNanos"})}),(0,i.jsxs)(n.td,{children:["the duration took to connect to a remote peer, ",(0,i.jsx)(n.code,{children:"-1"})," if socket connection attempt did not occur"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"pendingAcquisitionStartTimeMicros"})}),(0,i.jsxs)(n.td,{children:["when the client started to wait for the completion of an existing connection attempt, in microseconds since the epoch (01-Jan-1970 00:00:00 UTC), ",(0,i.jsx)(n.code,{children:"-1"})," if waiting did not occur"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"pendingAcquisitionDurationNanos"})}),(0,i.jsxs)(n.td,{children:["the duration took to wait for the completion of an existing connection attempt to use one connection in HTTP/2, ",(0,i.jsx)(n.code,{children:"-1"})," if waiting did not occur"]})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:["The connection acquisition duration is the sum of ",(0,i.jsx)(n.code,{children:"dnsResolutionDurationNanos"}),", ",(0,i.jsx)(n.code,{children:"socketConnectDurationNanos"})," and\n",(0,i.jsx)(n.code,{children:"pendingAcquisitionDurationNanos"}),". They may or may not occur depending on circumstances.\nThese are some of the scenarios how the total duration is composed of:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Resolving a domain name and connecting to the remote peer."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bob-svg",children:"\n   +---------------------------------------------------------------+                               #1\n   :<---------------------connectionAcquisition-------------------\x3e|\n   +---------------------------------------------------------------+\n   :<--------dnsResolution--------\x3e|\n   +-------------------------------+-------------------------------+\n                                   :<--------socketConnect--------\x3e|\n                                   +-------------------------------+\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsxs)(n.li,{children:["Waiting for the connection to be established, since there's an existing connection attempt, to use one\nconnection in HTTP/2. (Note that, if you create a client with an IP address, ",(0,i.jsx)(n.code,{children:"dnsResolution"})," did not\noccur. Also note that, there's no ",(0,i.jsx)(n.code,{children:"socketConnect"})," because the client just waits for the connection and\nuses it.)"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bob-svg",children:"+-----------------------------+                                                                 #2\n:<---connectionAcquisition---\x3e|\n+-----------------------------+\n:<-----pendingAcquisition----\x3e|\n+-----------------------------+\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:"Connecting to the remote peer with the resolved IP address after the existing connection attempt is\nfailed."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bob-svg",children:"+------------------------------------------------------------------------------------------+    #3\n:<-----------------------------------connectionAcquisition--------------------------------\x3e|\n+------------------------------------------------------------------------------------------+\n:<--------dnsResolution--------\x3e|\n+-------------------------------+--------------------------+\n                                :<---pendingAcquisition---\x3e|\n                                +--------------------------+-------------------------------+\n                                                           :<--------socketConnect--------\x3e|\n                                                           +-------------------------------+\n"})}),"\n",(0,i.jsx)(n.h2,{id:"availability-of-properties",children:"Availability of properties"}),"\n",(0,i.jsxs)(n.p,{children:["Armeria handles requests and responses in a stream-oriented way, which means that some properties are revealed\nonly after the streams are processed to some point. For example, there's no way to know the ",(0,i.jsx)(n.code,{children:"requestLength"}),"\nuntil the request processing ends. Also, some properties related to the (de)serialization of request content,\nsuch as ",(0,i.jsx)(n.code,{children:"serializationFormat"})," and ",(0,i.jsx)(n.code,{children:"requestContent"}),", will not be available when request processing just\nstarted."]}),"\n",(0,i.jsxs)(n.p,{children:["The collected properties must be accessed via ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/RequestLogAccess.html",children:"RequestLogAccess"}),", which provides a safe access to the\ncollected properties via the following methods:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"isComplete()"})," or ",(0,i.jsx)(n.code,{children:"whenComplete()"})," to check if or to get notified when all request and response\nproperties are available."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"isRequestComplete()"})," or ",(0,i.jsx)(n.code,{children:"whenRequestComplete()"})," to check if or to get notified when all request\nproperties are available."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"isAvailable(RequestLogProperty...)"})," or ",(0,i.jsx)(n.code,{children:"whenAvailable(RequestLogProperty...)"})," to check if or to get\nnotified when a certain set of properties are available."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'import com.linecorp.armeria.common.HttpRequest;\nimport com.linecorp.armeria.common.HttpResponse;\nimport com.linecorp.armeria.common.logging.RequestLog;\nimport com.linecorp.armeria.common.logging.RequestLogProperty;\nimport com.linecorp.armeria.server.ServiceRequestContext;\nimport com.linecorp.armeria.server.AbstractHttpService;\n\nHttpService myService = (ctx, req) -> {\n    final RequestLogAccess logAccess = ctx.log();\n\n    logAccess.whenAvailable(RequestLogProperty.REQUEST_HEADERS)\n             .thenAccept(log -> {\n                 assert log.isAvailable(RequestLogProperty.REQUEST_HEADERS);\n                 System.err.println("Started to handle a request: " +\n                                    log.requestHeaders());\n             });\n\n    logAccess.whenComplete()\n             .thenAccept(log -> {\n                 assert log.isComplete();\n                 System.err.println("Handled a request: " + log);\n             });\n    ...\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"availability-of-client-timing-properties",children:"Availability of client timing properties"}),"\n",(0,i.jsxs)(n.p,{children:["On the client side, you can also get the timing information about the related connection attempt. Unlike\nrequest and response properties, you need to use ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/ClientConnectionTimings.html",children:"ClientConnectionTimings"})," as follows:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'import com.linecorp.armeria.client.ClientConnectionTimings;\nimport com.linecorp.armeria.client.WebClient;\n\nWebClient client = WebClient\n    .builder("http://armeria.com")\n    .decorator((delegate, ctx, req) -> {\n        // Can get as soon as a request is started.\n        ctx.log().whenAvailable(RequestLogProperty.REQUEST_START_TIME)\n           .thenAccept(log -> {\n               final ClientConnectionTimings timings = ClientConnectionTimings.get(log);\n               if (timings != null) {\n                   System.err.println("Connection acquisition duration: " +\n                                      timings.connectionAcquisitionDurationNanos());\n               }\n           });\n        return delegate.execute(ctx, req);\n    })\n    .build();\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["The reason why we used the static method is that the ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/ClientConnectionTimings.html",children:"ClientConnectionTimings"})," is stored using\nthe attribute. See ",(0,i.jsx)(n.a,{href:"/docs/advanced/custom-attributes",children:"RequestContext custom attributes"})," for more information."]})}),"\n",(0,i.jsx)(n.h2,{id:"enabling-content-previews",children:"Enabling content previews"}),"\n",(0,i.jsxs)(n.p,{children:["Armeria provides the ",(0,i.jsx)(n.code,{children:"requestContentPreview"})," and ",(0,i.jsx)(n.code,{children:"responseContentPreview"})," properties in ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/RequestLog.html",children:"RequestLog"}),"\nto retrieve the textual representation of the first N bytes of the request and response content.\nHowever, the properties are disabled by default due to performance overhead and thus they return ",(0,i.jsx)(n.code,{children:"null"}),"\nby default. You can enable it using ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/logging/ContentPreviewingClient.html",children:"ContentPreviewingClient"})," and ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/logging/ContentPreviewingService.html",children:"ContentPreviewingService"}),"\ndecorators."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"import com.linecorp.armeria.server.logging.ContentPreviewingService;\nimport com.linecorp.armeria.server.ServerBuilder;\n\nServerBuilder sb = Server.builder();\n...\n// Enable previewing the content with the maximum length of 100 for textual content.\nsb.decorator(ContentPreviewingService.newDecorator(100));\n...\nsb.build();\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"import com.linecorp.armeria.client.logging.ContentPreviewingClient;\nimport com.linecorp.armeria.client.WebClientBuilder;\n\nWebClientBuilder cb = WebClient.builder();\n...\ncb.decorator(ContentPreviewingClient.newDecorator(100));\n"})}),"\n",(0,i.jsx)(n.p,{children:"Note that the above decorators enable the previews only for textual content\nwhich meets one of the following cases:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["when its type matches ",(0,i.jsx)(n.code,{children:"text/*"})," or ",(0,i.jsx)(n.code,{children:"application/x-www-form-urlencoded"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["when its subtype is ",(0,i.jsx)(n.code,{children:"xml"})," or ",(0,i.jsx)(n.code,{children:"json"}),". e.g. application/xml, application/json."]}),"\n",(0,i.jsxs)(n.li,{children:["when its subtype ends with ",(0,i.jsx)(n.code,{children:"+xml"})," or ",(0,i.jsx)(n.code,{children:"+json"}),". e.g. application/atom+xml, application/hal+json"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["You can also customize the previews by specifying your own ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/ContentPreviewerFactory.html",children:"ContentPreviewerFactory"})," implementation.\nThe following example enables the textual preview of first 100 characters for the content type of ",(0,i.jsx)(n.code,{children:"text/*"}),",\nand the hex dump preview of first 100 characters for the content type of ",(0,i.jsx)(n.code,{children:"application/binary"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"import io.netty.buffer.ByteBufUtil;\nimport com.linecorp.armeria.common.MediaType;\nimport com.linecorp.armeria.common.logging.ContentPreviewer;\nimport com.linecorp.armeria.common.logging.ContentPreviewerFactoryBuilder;\n\nServerBuilder sb = Server.builder();\n\nContentPreviewerFactoryBuilder builder = ContentPreviewerFactory.builder().maxLength(100);\nbuilder.text((ctx, headers) -> {\n    final MediaType contentType = headers.contentType();\n    // Produces the textual preview when the content type is ANY_TEXT_TYPE.\n    if (contentType != null && contentType.is(MediaType.ANY_TEXT_TYPE)) {\n        return true;\n    }\n    return false;\n});\n\n// Produces the hex dump when the content type is APPLICATION_BINARY.\nbuilder.binary(MediaType.APPLICATION_BINARY);\n\nsb.decorator(ContentPreviewingService.newDecorator(builder.build()));\n"})}),"\n",(0,i.jsx)(n.p,{children:"You can write your own producer to change the way to make the preview, e.g."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"ContentPreviewerFactoryBuilder builder = ContentPreviewerFactory.builder();\nbuilder.binary(MediaTypeSet.of(MediaType.APPLICATION_BINARY),\n               (headers, byteBuf) -> {\n                   // You can use the byteBuf to produce your own way.\n               });\n...\nServerBuilder sb = Server.builder();\n...\nsb.decorator(ContentPreviewingService.newDecorator(builder.build()));\n"})}),"\n",(0,i.jsx)(n.h2,{id:"nested-log",children:"Nested log"}),"\n",(0,i.jsxs)(n.p,{children:["When you retry a failed attempt, you might want to record the result of each attempt and to group them under\na single ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/RequestLog.html",children:"RequestLog"}),". A ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/RequestLog.html",children:"RequestLog"})," can contain more than one child ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/RequestLog.html",children:"RequestLog"}),"\nto support this sort of use cases."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"import com.linecorp.armeria.common.logging.RequestLogBuilder;\n\nRequestLogBuilder.addChild(RequestLog);\n"})}),"\n",(0,i.jsxs)(n.p,{children:["If the added ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/RequestLog.html",children:"RequestLog"})," is the first child, the request-side log of the ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/RequestLog.html",children:"RequestLog"})," will\nbe propagated to the parent log. You can add as many child logs as you want, but the rest of logs would not\nbe affected. If you want to fill the response-side log of the parent log, please invoke:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"RequestLogBuilder.endResponseWithLastChild();\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This will propagate the response-side log of the last added child to the parent log. The following diagram\nillustrates how a ",(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/RequestLog.html",children:"RequestLog"})," with child logs looks like:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bob-svg",children:"/--------------------------------------------------------------\\\n|                                                              |\n|  RequestLog                                                  |\n|                                                              |\n|                             /-----------------------------\\  |\n|                             :                             |  |\n|  +----------------------+   |      Child RequestLogs      |  |\n|  |                      |   |        e.g. retries         |  |\n|  |                      |   |                             |  |\n|  |   Request side log   |   |  +-----------------------+  |  |\n|  |                      |   |  | Child #1              |  |  |\n|  |                      |   |  | +-------------------+ |  |  |\n|  |     Copied from      |<-------+ Request side log  | |  |  |\n|  |     the first child  |   :  | +-------------------+ |  |  |\n|  |                      |   |  | : Response side log | |  |  |\n|  |                      |   |  | +-------------------+ |  |  |\n|  +----------------------+   |  +-----------------------+  |  |\n|                             |  | ...                   |  |  |\n|  +----------------------+   |  +-----------------------+  |  |\n|  |                      |   |              .              |  |\n|  |                      |   |              .              |  |\n|  |  Response side log   |   |  +-----------------------+  |  |\n|  |                      |   |  | Child #N              |  |  |\n|  |                      |   |  | +-------------------+ |  |  |\n|  |     Copied from      |   |  | : Request side log  | |  |  |\n|  |     the last child   |   |  | +-------------------+ |  |  |\n|  |                      |<-------+ Response side log | |  |  |\n|  |                      |   :  | +-------------------+ |  |  |\n|  +----------------------+   |  +-----------------------+  |  |\n|                             |                             |  |\n|                             \\-----------------------------/  |\n|                                                              |\n\\--------------------------------------------------------------/\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You can retrieve the child logs using ",(0,i.jsx)(n.code,{children:"RequestLog.children()"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'final RequestContext ctx = ...;\nctx.log().whenComplete().thenAccept(log -> {\n    if (!log.children().isEmpty()) {\n        System.err.println("A request finished after " + log.children().size() + " attempt(s): " + log);\n    } else {\n        System.err.println("A request is done: " + log);\n    }\n});\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/retry/RetryingClient.html",children:"RetryingClient"})," is a good example that leverages this feature.\nSee ",(0,i.jsx)(n.a,{href:"/docs/client/retry#retryingclient-with-logging",children:"RetryingClient with logging"})," for more information."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>c});var r=t(96540);const i={},o=r.createContext(i);function s(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);