---
date: 2020-11-30
---

## üåü New features

- You can now use <a href="https://unixism.net/loti/what_is_io_uring.html">io_uring</a> for efficient I/O
  processing in Linux. #3182
  - Specify the `-Dcom.linecorp.armeria.transportType=io_uring` JVM option to enable it.
  - This is the early stage of development so you should be careful using the feature.
- The metrics of requests to a <type://TransientService> are now not collected by default. #3061, #3081
  - Access logs and service logs are not recorded as well.
  - You should use <type://TransientServiceOption> to enable them.
    ```java
    TransientServiceBuilder.transientServiceOptions(TransientServiceOption.WITH_METRIC_COLLECTION,
                                                    TransientServiceOption.WITH_SERVICE_LOGGING,
                                                    TransientServiceOption.WITH_ACCESS_LOGGING)
    ```
- You can now use Protobuf's `Message` and ScalaPB's `GeneratedMessage` as a request/response object in
  annotated service. #3088 #3124, #3192
  - Use `armeria-protobuf`, `armeria-scalapb_2.12` or `armeria-scalapb_2.13` dependencies.
  - See [Supporting ScalaPB in annotated services](/docs/advanced-scalapb#supporting-scalapb-in-annotated-services)
    for more information.
- You can now use Scala `Future` in annotated service. #3189
  ```scala
  @Get("/items/{id}")
  def items(@Param id: Int)(implicit ec: ExecutionContext): Future[String] = {
    Future {
      // Perform asynchronous task using Armeria's event loop.
      ...
    }
  }
  ```
- You can now use <type://HttpDeframer> to conveniently decode a stream of <typeplural://HttpObject>
  to N objects. #2981
  ```java
  HttpDeframerHandler<String> decoder = ...
  HttpDeframer<String> deframer = new HttpDeframer<>(decoder, ByteBufAllocator.DEFAULT);
  HttpRequest request = ...;
  request.subscribe(deframer);
  ```
  See <type://HttpDeframer> for more information.
- You can now apply <type://CircuitBreaker> per request path. #3134, #3135
  ```java
  CircuitBreakerFactory factory = ...
  CircuitBreakerMapping mapping = CircuitBreakerMapping.builder()
                                                       .perPath() // per the combination of host and path
                                                       .perHost()
                                                       .build(factory)
  CircuitBreakerRule rule = ...
  CircuitBreakerClient.newDecorator(mapping, rule);
  ```
- You can now apply the different `maxTotalAttempts` and `responseTimeout` for <type://RetryingClient>
  using <type://RetryConfig>. #3145
  ```java
  BiFunction<ClientRequestContext, Request, String> keyFactory =
      (ctx, req) -> ctx.endpoint().host();
  BiFunction<ClientRequestContext, Request, RetryConfig<HttpResponse>> configFactory = (ctx, req) -> {
      String host = ctx.endpoint().host();
      RetryConfigBuilder builder = RetryConfig.<HttpResponse>builder(RetryRule.onException());
      if (host.equals("host1")) {
          builder.maxTotalAttempts(2);
      } else if (host.equals("host2")) {
          builder.maxTotalAttempts(4);
      } else {
          builder.maxTotalAttempts(1);
      }
      return builder.build();
  };
  RetryConfigMapping mapping = RetryConfigMapping.of(keyFactory, configFactory);
  RetryingClient.newDecoratorWithMapping(mapping);
  ```
- You can now split the <type://ResponseHeaders> and bodies using <type://HttpResponse#split()>. #3038
- You can now specify the Caffeine spec for the DNS resolver. #2970, #3007
- You can now specify a prefix fo MDC keys using the `<prefix>` element. #3086, #3112
  ```xml
  <prefix>...</prefix> <!-- The default prefix -->
  <export>...</export>
  <exports>...</exports>

  <exportGroup>
    <prefix>...</prefix> <!-- The prefix for the export group. -->
    <export>...</export>
    <exports>...</exports>
  </exportGroup>
  ```
- You can now use the unsafe TLS cipher using <type://ClientFactoryBuilder#tlsAllowUnsafeCiphers(boolean)>.
  #3157, #3172
- You can now specify an arbitrary type for <type://@Header> and <type://@Param> if the
  type has one of following static methods or the constructor. #2574, #3143, #3164
  - `public static T of(String) { ... }`
  - `public static T valueOf(String) { ... }`
  - `public static T fromString(String) { ... }`
  - `public T(String) { ... } // constructor`
  ```java
  public class UserService {

      @Get("/api")
      public HttpResponse get(@Param User user) {
          ...
      }

      private static class User {
          User(String userId) { ... } // This constructor is used to create User.
          ...
      }
  }
  ```
- You can now build an <type://HttpRequest> fluently. #3110
  ```java
  // Creates a POST HttpRequest whose URI is "/foo?q=bar"
  // with headers "cookie: name=value" and "authorization: value" and a JSON body.
  HttpRequest.builder()
             .post("/{resource}")
             .pathParam("resource", "foo")
             .queryParam("q", "bar")
             .cookie(Cookie.of("name", "value"))
             .header("authorization", "value")
             .content(MediaType.JSON, "{\"foo\":\"bar\"}"));
  // You can also use WebClient.prepare().
  WebClient client = ...
  client.prepare()
        .post("/{resource}")
        .pathParam("resource", "foo")
        .queryParam("q", "bar")
        .cookie(Cookie.of("name", "value"))
        .header("authorization", "value")
        .content(MediaType.JSON, "{\"foo\":\"bar\"}")
        .execute();
  ```
- You can now easily handle cookies by applying <type://CookieClient#newDecorator()>. #2637, #3118
- You can now use the custom Thrift protocol by using <type://ThriftProtocolFactoryProvider> and SPI. #3183
  ```java
  public class TTupleFactoryProvider extends ThriftProtocolFactoryProvider {
      @Override
      public Set<ThriftProtocolFactoryProvider.Entry> entries() {
          return ImmutableSet.of(new ThriftProtocolFactoryProvider.Entry(
                  SerializationFormat.of("ttuple"), new TTupleProtocol.Factory()));
      }
  }
  ```
- You can now collect more detailed DNS metrics such as success or failure, query type, etc. #1887, #2935
- You can now customize the <type://HealthCheckService> when using Spring integration. #3144
  ```java
  @Bean
  public HealthCheckServiceConfigurator healthCheckServiceConfigurator() {
      return builder -> builder.updatable(true);
  }
  ```
- You can now use <type://RequestHeaders#acceptLanguage()> to choose language. #3177, #3179
## üìà Improvements

- Various improvements for Doc service. #3149, #3150, #3167, #3188

## üõ†Ô∏è Bug fixes
- <type://HealthCheckedEndpointGroup#endpoints()> now returns healthy endpoints properly even when
  <type://EndpointGroup#orElse(EndpointGroup)> is used. #3181
- `ServletRequest.getProtocol()` now returns the proper value when using <type://TomcatService> and
  <type://JettyService>. #3194
- The route decorators are now evaluated in the reverse order they applied. #3160, #3166
- You now get the FORBIDDEN status if your service does not handle preflight requests regardless of
  route decorators. #3152
- A gRPC `ServerCall` is now closed exactly only once. #3153
- You no longer see `AnnotatedConnectException` when the <type://Endpoint> is created with an
  IPv6 scope ID. #3158, #3178
- Armeria server does not reject the request path whose first segment includes a colon anymore. #3154

## üèöÔ∏è Deprecations
- <type://CircuitBreakerClient#newPerHostAndMethodDecorator(BiFunction,CircuitBreakerRule)> is now deprecated.
  #31356
  - Use <type://CircuitBreakerClient#newDecorator(CircuitBreakerMapping,CircuitBreakerRule)> with the customized
    <type://CircuitBreakerMapping> using <type://CircuitBreakerMapping#builder()>.
- The response timeout and max total attempts setters in <type://RetryingClientBuilder> is now deprecated.
  #3128 #3145
  - The static factory methods that take those parameters in <type://RetryingClient> are now deprecated as well.
  - Use <type://RetryConfigMapping> and <type://RetryConfig>.
- <type://Route#apply(RoutingContext)?full> is deprecated. #3152
  - Use <type://Route#apply(RoutingContext,boolean)?full>.
- The constructor of <type://PrometheusExpositionService> is now deprecated. #3081
  - Use <type://PrometheusExpositionService#of(CollectorRegistry)>.

## ‚ò¢Ô∏è Breaking changes

- N/A

## ‚õì Dependencies

- completalbe-futures 0.3.3 ‚Üí 0.3.4
- dropwizard-core 2.0.13 ‚Üí 2.0.16
- Fastutil 8.4.2 ‚Üí 8.4.3
- gRPC 1.33.0 ‚Üí 1.33.1
- grpc-kotlin-stub 0.2.0 ‚Üí 0.2.1
- io.dropwizard.metrics 4.1.13 ‚Üí 4.1.15
- Jackson 2.11.2 ‚Üí 2.12.0
- Jctools 3.1.0 ‚Üí 3.2.0
- javax.annotation-api 1.3.2
- Micrometer 1.5.5 ‚Üí 1.6.1
- Netty 4.1.53.Final ‚Üí 4.1.54.Final
- org.bouncycastle 1.66 ‚Üí 1.67
- Reactor 3.3.10.RELEASE ‚Üí 3.4.0
- Spring Boot 2.3.4.RELEASE ‚Üí 2.4.0
- Spring 5.2.9.RELEASE ‚Üí 5.3.1
- tomcat-embed-core 9.0.39 ‚Üí 9.0.40

## üôá Thank you

<ThankYou
  usernames={[
    'adriancole',
    'anuraaga',
    'ghkim3221',
    'haithamgabr',
    'heowc',
    'ikhoon',
    'jrhee17',
    'KarboniteKream',
    'kojilin',
    'masonshin',
    'minwoox',
    'okue',
    'perlun',
    'rolandblain',
    'techno',
    'tobias-',
    'trustin',
    'tumile',
    'Ubehebe',
    'wickedev',
    'windmeup'
  ]}
/>
