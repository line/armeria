<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog-ko" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Armeria의 서킷 브레이커 사용해 보기 | Armeria</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://armeria.dev/img/og-image.png"><meta data-rh="true" name="twitter:image" content="https://armeria.dev/img/og-image.png"><meta data-rh="true" property="og:url" content="https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="og:site_name" content="Armeria - Your go-to microservice framework"><meta data-rh="true" name="og:type" content="website"><meta data-rh="true" name="og:image:width" content="1280"><meta data-rh="true" name="og:image:height" content="640"><meta data-rh="true" name="twitter:site" content="@armeria_project"><meta data-rh="true" name="twitter:creator" content="@armeria_project"><meta data-rh="true" property="og:title" content="Armeria의 서킷 브레이커 사용해 보기 | Armeria"><meta data-rh="true" name="description" content="안녕하세요."><meta data-rh="true" property="og:description" content="안녕하세요."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2020-04-27T00:00:00.000Z"><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria"><link data-rh="true" rel="alternate" href="https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria" hreflang="en"><link data-rh="true" rel="alternate" href="https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria","mainEntityOfPage":"https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria","url":"https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria","headline":"Armeria의 서킷 브레이커 사용해 보기","name":"Armeria의 서킷 브레이커 사용해 보기","description":"안녕하세요.","datePublished":"2020-04-27T00:00:00.000Z","author":{"@type":"Person","name":"주승환","description":"LINE에서 OpenChat 서비스의 백엔드 개발을 담당하고 있습니다.","image":"/img/author-seunghwanjoo.jpeg"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://armeria.dev/blog/ko","name":"Armeria Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="Armeria Newsletter RSS Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CY9YHLJ0K6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-CY9YHLJ0K6",{anonymize_ip:!0})</script>





<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Armeria Blog RSS Feed">
<link rel="alternate" type="application/rss+xml" href="/blog/ja/rss.xml" title="Armeria Blog - Japanese RSS Feed">
<link rel="alternate" type="application/rss+xml" href="/blog/ko/rss.xml" title="Armeria Blog - Korean RSS Feed">

<link rel="manifest" href="/manifest.json">


<link rel="alternate" type="application/rss+xml" href="/release-notes/rss.xml" title="Armeria Release Notes RSS Feed">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Armeria RSS Feed"><link rel="stylesheet" href="/assets/css/styles.884c8684.css">
<script src="/assets/js/runtime~main.a1f00a49.js" defer="defer"></script>
<script src="/assets/js/main.73113e33.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/armeria_logo_horiz.svg"><link rel="preload" as="image" href="/img/author-seunghwanjoo.jpeg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/armeria_logo_horiz.svg" alt="Armeria Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/armeria_logo_horiz.svg" alt="Armeria Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">News</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/news/20231208-newsletter-6">Newsletter</a></li><li><a class="dropdown__link" href="/release-notes/1.36.0">Release notes</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/">Documentation</a><a class="navbar__item navbar__link" href="/community/">Community</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/line/armeria" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><a class="navbar__item navbar__link header-discord-link" aria-label="Discord" href="/s/discord"></a><a href="https://x.com/armeria_project" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-x-link" aria-label="X"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS darkNavbarColorModeToggle_X3D1" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md"> </div><button type="button" class="ant-btn css-198drv2 ant-btn-default ant-btn-color-default ant-btn-variant-outlined ant-btn-lg ant-dropdown-trigger blogLanguageSelector__AnM"><a href="/blog">English</a><span role="img" aria-label="down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></span></button><div role="group"><h3 class="yearGroupHeading_rMGB">2021</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ko/2021/07/15/customizing-armeria-metrics">Armeria 지표 커스터마이징하기</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria">Armeria에서 Prometheus 지표 모니터링하기</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2020</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ko/2020/02/19/reactive-streams-armeria-2">Armeria로 Reactive Streams와 놀자! - 2</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ko/2020/02/18/reactive-streams-armeria-1">Armeria로 Reactive Streams와 놀자! - 1</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/ko/2020/04/27/circuit-breakers-armeria">Armeria의 서킷 브레이커 사용해 보기</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2019</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ko/2019/12/24/my-first-opensource-contribution-to-armeria">생애 첫 오픈 소스 기여 경험(feat. Armeria)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ko/2019/05/09/armeria-sprint-1">GitHub Contributions 그래프를 푸릇푸릇하게 만들어보아요(feat. Armeria Sprint)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria">오픈소스 Armeria의 기여자를 위한 이벤트를 진행하였습니다</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2016</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway">Channel Gateway에 CircuitBreaker 적용</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ko/2016/07/24/circuit-breakers-for-distributed-services">분산 서비스 환경에 대한 Circuit Breaker 적용</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ko/2016/04/13/open-sourcing-armeria">Armeria 오픈소스화 이야기</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><div><div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>This post is also available in<!-- --> <a href="/blog/2020/07/08/circuit-breakers-armeria">English</a>.</p></div></div></div><h1 class="title_f1Hy">Armeria의 서킷 브레이커 사용해 보기</h1><div class="container_mt6G margin-vert--md"><time datetime="2020-04-27T00:00:00.000Z">April 27, 2020</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo authorImage_XqGP" src="/img/author-seunghwanjoo.jpeg" alt="주승환"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp" translate="no">주승환</span></div><small class="authorTitle_nd0D" title="LINE에서 OpenChat 서비스의 백엔드 개발을 담당하고 있습니다.">LINE에서 OpenChat 서비스의 백엔드 개발을 담당하고 있습니다.</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>안녕하세요.
LINE에서 OpenChat 서비스의 백엔드를 개발하고 있는 주승환입니다. 이번 글에서는 간단한 코드 예제와 함께 Armeria의 서킷 브레이커 기능을 사용해 본 내용을 공유하고자 합니다.</p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="서킷-브레이커란">서킷 브레이커란?<a href="#서킷-브레이커란" class="hash-link" aria-label="Direct link to 서킷 브레이커란?" title="Direct link to 서킷 브레이커란?" translate="no">​</a></h2>
<p>만약 예상치 못한 장애(네크워크 이슈 혹은 서버 다운 등)가 발생하여 어떤 원격 서버 하나가 요청에 응답하지 못하는 상태라고 가정해 보겠습니다. 이때 해당 서버로 요청을 보낸 클라이언트는 타임아웃이 발생할 때까지 응답을 기다리거나 계속 무의미한 요청을 보내며 자원을 낭비하게 될 것입니다.
MSA(Microservice Architecture)에서는 이 클라이언트가 또 다른 누군가의 서버가 될 수도 있는데요. 그렇다면 이 서버의 클라이언트 역시 똑같은 문제를 겪게 될 것입니다. 이렇게 장애가 계속 전파되며 한 원격 서버에서 발생한 장애가 모든 시스템에 큰 영향을 줄 수 있습니다. 이런 문제를 해결하기 위해 등장한 개념이 바로 &#x27;서킷 브레이커(circuit breaker)&#x27;입니다.</p>
<p>서킷 브레이커란, 클라이언트에서 어떤 원격 서버로 전송한 요청의 실패율이 특정 임계치(threshold)를 넘어서면, 이 서버에 문제가 있다고 판단하여 더 이상 무의미한 요청을 전송하지 않고 빠르게 에러를 발생시키는 방법(fail fast)입니다. 이 방법으로 앞서 언급한 문제를 방지하여 장애 규모를 최소화할 수 있습니다(서킷 브레이커의 개념은 &#x27;<a class="" href="/blog/ko/2016/07/24/circuit-breakers-for-distributed-services">분산 서비스 환경에 대한 Circuit Breaker 적용</a>&#x27; 블로그에 잘 설명되어 있으니 참고하시기 바랍니다).</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="서킷-브레이커의-상태">서킷 브레이커의 상태<a href="#서킷-브레이커의-상태" class="hash-link" aria-label="Direct link to 서킷 브레이커의 상태" title="Direct link to 서킷 브레이커의 상태" translate="no">​</a></h2>
<p>서킷 브레이커에는 총 3가지 상태가 있습니다.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/circuit-breakers-armeria-1-f70bdace5b6c392763a6f834aac57203.png" width="1806" height="598" class="img_ev3q"></p>
<ul>
<li class=""><code>CLOSED</code>: 요청의 실패율이 정해 놓은 임계치보다 낮은 정상적인 상태.</li>
<li class=""><code>OPEN</code>: 요청의 실패율이 정해 놓은 임계치를 넘어선 상태. 요청을 전송하지 않고 바로 에러를 발생시킴(fail fast).</li>
<li class=""><code>HALF_OPEN</code>: <code>OPEN</code> 상태에서 주기적으로 요청을 전송하여 응답을 확인하는 상태. 성공하면 <code>CLOSED</code> 상태로 전환하고 실패하면 <code>OPEN</code> 상태를 유지.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="armeria의-서킷-브레이커">Armeria의 서킷 브레이커<a href="#armeria의-서킷-브레이커" class="hash-link" aria-label="Direct link to Armeria의 서킷 브레이커" title="Direct link to Armeria의 서킷 브레이커" translate="no">​</a></h2>
<p>LINE에서 운영하는 <a href="https://netty.io/" target="_blank" rel="noopener noreferrer" class="">Netty</a> 기반의 비동기 마이크로 서비스 프레임워크 오픈소스, <a href="https://github.com/line/armeria" target="_blank" rel="noopener noreferrer" class="">Armeria</a>에서는 서킷 브레이커 기능을 직접 구현하여 제공하고 있습니다. 이를 이용해 직접 로그를 살펴보며 서킷 브레이커의 동작을 확인해 보겠습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="준비하기">준비하기<a href="#준비하기" class="hash-link" aria-label="Direct link to 준비하기" title="Direct link to 준비하기" translate="no">​</a></h3>
<p>먼저, 테스트를 위해 간단하게 요청과 응답을 주고받을 서버 2대, Server1과 Server2를 준비합니다.</p>
<p>클라이언트가 Server1으로 <code>/hello</code> 요청을 보내면, Server1은 Server2로 <code>/world</code> 요청을 보냅니다.
Server2가 Server1으로 응답을 보내면 Server1은 그 응답을 다시 클라이언트에게 반환합니다.
Server1은 클라이언트의 서버이면서 Server2의 클라이언트이기도 합니다.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/circuit-breakers-armeria-2-b3c58daca726cc29671eb155593a051c.png" width="840" height="234" class="img_ev3q"></p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="server2-구현-코드">Server2 구현 코드<a href="#server2-구현-코드" class="hash-link" aria-label="Direct link to Server2 구현 코드" title="Direct link to Server2 구현 코드" translate="no">​</a></h4>
<p>상대적으로 구현이 간단한, Server1의 응답을 받을 Server2의 구현 코드부터 보겠습니다. <code>/world</code>로 전송된 요청에 대한 응답으로 성공(200)과 실패(500)를 번갈아 반환하도록 간단하게 구현했습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Server2Application.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@SpringBootApplication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Server2Application</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">AtomicInteger</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">REQ_CNT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AtomicInteger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ServerBuilder</span><span class="token plain"> sb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">http</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5008</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">LoggingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/world&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">REQ_CNT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addAndGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">INTERNAL_SERVER_ERROR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Server</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CompletableFuture</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Void</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> future </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="server1-구현-코드">Server1 구현 코드<a href="#server1-구현-코드" class="hash-link" aria-label="Direct link to Server1 구현 코드" title="Direct link to Server1 구현 코드" translate="no">​</a></h4>
<p>Server1의 구현 코드입니다.
Server2는 <code>ServerBuilder</code>를 이용하여 간단하게 구현한 후, Server1은 클라이언트의 요청을 받을 서비스와 Server2로 요청을 보낼 클라이언트를 모두 빈(bean)으로 만들어 사용합니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Server1Application.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@SpringBootApplication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Import</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Server1Context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Server1Application</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">SpringApplication</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Server1Application</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Server1Context.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Server1Context</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">HttpServiceRegistrationBean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">httpService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">WebClient</span><span class="token plain"> webClient</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">HttpServiceRegistrationBean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> webClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/world&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setServiceName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;httpService&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Route</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/hello&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">methods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">GET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">WebClient</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">webClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CircuitBreakerStrategy</span><span class="token plain"> strategy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CircuitBreakerStrategy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onServerErrorStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// CircuitBreaker 설정!!!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CircuitBreaker</span><span class="token plain"> circuitBreaker </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CircuitBreaker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;test-circuit-breaker&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">counterSlidingWindow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">circuitOpenWindow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">failureRateThreshold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">minimumRequestThreshold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">trialRequestInterval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">WebClient</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;http://localhost:5008&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">LoggingClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">CircuitBreakerHttpClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">circuitBreaker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strategy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Armeria에서 <code>CircuitBreaker</code>를 구현할 때 주의해야 할 점은, 클라이언트 객체는 각자 자신만의 <code>CircuitBreaker</code>를 가진다는 점입니다. 만약 Server2로 전송되는 매 요청마다 클라이언트 객체를 새로 생성하고 요청이 끝난 후에 소멸되는 방식으로 구현했다면, 각 객체에 연결된 <code>CircuitBreaker</code>는 사실상 무의미해집니다. 따라서 Server2로 요청을 보낼 <code>WebClient</code>를 빈(bean)으로 만들어서 Server2로 전송되는 모든 요청에 대해 동일한 <code>WebClient</code> 객체를 재사용하도록 구현한 후, Armeria에서 제공하는 <a href="https://line.github.io/armeria/client-decorator.html" target="_blank" rel="noopener noreferrer" class="">Decorator</a>를 이용해 이 <code>WebClient</code> 객체에 서킷 브레이커를 적용했습니다.</p>
<p>위 코드에서 <code>CircuitBreaker</code>에 설정한 각 필드를 하나씩 살펴보겠습니다.</p>
<ul>
<li class=""><code>counterSlidingWindow</code>(10s): 서킷 브레이커에서 요청의 성공/실패의 수를 측정하는 시간 간격입니다. 즉, 위 코드에선 10초 동안의 집계를 바탕으로 어떤 상태로 전환 또는 유지할지 판단합니다.</li>
<li class=""><code>circuitOpenWindow</code>(5s): 서킷 브레이커가 <code>OPEN</code> 상태로 유지되는 시간입니다. 위 코드에선 <code>OPEN</code> 상태가 되면 5초 동안 외부 서버로 요청을 보내지 않고 바로 에러(FailFastException)를 발생시킵니다.</li>
<li class=""><code>failureRateThreshold</code>(0.3): <code>OPEN</code> 상태로 전환되기 위한 요청 실패율입니다. <code>circuitOpenWindow</code>에서 설정한 시간 동안 0.3(30%) 비율 이상으로 요청이 실패해야 <code>OPEN</code> 상태로 전환됩니다.</li>
<li class=""><code>minimumRequestThreshold</code>(5): 측정에 필요한 요청의 최소 개수입니다. 실패율이 <code>failureRateThreshold</code>보다 높다고 해도, 그 값이 최소 5개 이상의 요청에 대한 결과값일 때만 <code>OPEN</code> 상태로 전환됩니다.</li>
<li class=""><code>trialRequestInterval</code>(3s): <code>HALF_OPEN</code> 상태로 유지되는 시간입니다. 3초 동안은 <code>OPEN</code> 상태일 때와 마찬가지로 <code>FailFastException</code> 에러를 발생시키는 한편, 외부 서버로도 요청을 전송하며 서버가 정상으로 돌아왔는지 확인합니다. 3초 동안 요청을 전송하면서 성공 응답을 받으면 즉시 <code>CLOSED</code> 상태로 전환되고, 모두 실패하면 다시 <code>OPEN</code> 상태로 전환됩니다.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="테스트">테스트<a href="#테스트" class="hash-link" aria-label="Direct link to 테스트" title="Direct link to 테스트" translate="no">​</a></h3>
<p>아래와 같이 터미널에서 <a href="https://www.npmjs.com/package/loadtest" target="_blank" rel="noopener noreferrer" class="">loadtest</a> 라이브러리를 이용하여 지속적으로 Server1에 요청을 보내겠습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ loadtest http://127.0.0.1:5007/hello --rps 1</span><br></span></code></pre></div></div>
<p>Server1의 로그를 살펴보면 서킷 브레이커의 동작을 눈으로 확인할 수 있습니다. 서버가 처음 실행될 때는 서킷 브레이커의 초기 상태가 <code>CLOSED</code>입니다.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/circuit-breakers-armeria-3-07759276f457694ff964d39a17233647.png" width="2780" height="440" class="img_ev3q"></p>
<p><em>03:03:41.830</em> 초에 측정된 전체 5개의 요청 중 실패한 요청 수는 두 개이고, 실패율은 2/5 = 0.4입니다. 실패율이 앞서 설정한 0.3(<code>failureRateThreshold</code>)보다 크고, 측정에 사용한 요청 수도 5(<code>minimumRequestThreshold</code>) 이상이므로 서킷 브레이커는 <code>OPEN</code> 상태로 전환됩니다.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/circuit-breakers-armeria-4-a2545fecd5a4cb40a6c7f1e9bc606001.png" width="3160" height="378" class="img_ev3q"></p>
<p>이후 <em>03:03:41.830</em> ~ <em>03:03:47.824</em>, 약 5초(<code>circuitOpenWindow</code>) 간 Server2로 요청이 전송되지 않고 <code>FailFastException</code> 에러가 계속 발생합니다(Server2의 로그를 보면 해당 시간에 요청이 들어오지 않은 것을 확인할 수 있습니다).</p>
<p><img decoding="async" loading="lazy" src="/assets/images/circuit-breakers-armeria-5-fb48c4e7a8981c1da7c2dc9413a94d2f.png" width="2562" height="448" class="img_ev3q"></p>
<p><em>03:03:47.824</em> 초에 <code>HALF_OPEN</code> 상태로 전환되고, 클라이언트가 보낸 요청이 Server2로 전송됩니다. 이때 전송된 요청이 운 좋게 200 응답을 받으면서 <code>CLOSED</code> 상태로 전환됩니다.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/circuit-breakers-armeria-6-26bbfb46bbe9fbc038bbac6a0eb170c2.png" width="3164" height="146" class="img_ev3q"></p>
<p>다시 <code>CLOSED</code>가 되어서 이 과정을 또 반복합니다. <em>03:03:47.827</em> ~ <em>03:03:56.824</em>, 약 10초(<code>counterSlidingWindow</code>) 동안 실패율을 측정합니다. 이번에 측정한 실패율은 4/8 = 0.5이므로, 서킷 브레이커는 다시 <code>OPEN</code> 상태로 전환됩니다.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/circuit-breakers-armeria-7-d5c6d32d0e6c79a216971115d5a25552.png" width="3156" height="626" class="img_ev3q"></p>
<p>위와 같이 간단한 테스트를 통해 Armeria 서킷 브레이커의 동작을 직접 확인해 보면서, 여러 설정 옵션의 의미와 그에 따른 동작을 보다 쉽게 이해할 수 있었습니다. 또한 간단한 설정으로도 완벽히 동작하는 서킷 브레이커 클라이언트를 구현할 수 있다는 점도 알게 되었습니다.</p>
<blockquote>
<p>Armeria 서킷 브레이커에 관한 보다 자세한 내용은 <a href="https://armeria.dev/docs/client-circuit-breaker/" target="_blank" rel="noopener noreferrer" class="">https://armeria.dev/docs/client-circuit-breaker/</a> 를 참고하시기 바랍니다.</p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="마치며">마치며<a href="#마치며" class="hash-link" aria-label="Direct link to 마치며" title="Direct link to 마치며" translate="no">​</a></h2>
<p>Armeria에서는 서킷 브레이커 외에도 MSA에 필요한 클라이언트 측 로드 밸런싱이나 auto-retry와 같은 여러 유용한 기능을 제공하고 있습니다. 실제 저희 OpenChat 서버 개발에도 Armeria를 사용하고 있는데요. 덕분에 많은 기능을 편하게 사용하고 있습니다. 지금 이 순간에도 개발자의 목소리에 귀를 기울이며 새로운 기능을 추가하고 개선하고 있는 Armeria 오픈소스 개발 팀에게 감사의 말을 전하며 이 글을 마칩니다.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/line/armeria/edit/main/site-new/src/content/blog/ko/2020-04-27-circuit-breakers-armeria.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/ko/2020/02/18/reactive-streams-armeria-1"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Armeria로 Reactive Streams와 놀자! - 1</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/ko/2019/12/24/my-first-opensource-contribution-to-armeria"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">생애 첫 오픈 소스 기여 경험(feat. Armeria)</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#서킷-브레이커란" class="table-of-contents__link toc-highlight">서킷 브레이커란?</a></li><li><a href="#서킷-브레이커의-상태" class="table-of-contents__link toc-highlight">서킷 브레이커의 상태</a></li><li><a href="#armeria의-서킷-브레이커" class="table-of-contents__link toc-highlight">Armeria의 서킷 브레이커</a><ul><li><a href="#준비하기" class="table-of-contents__link toc-highlight">준비하기</a></li><li><a href="#테스트" class="table-of-contents__link toc-highlight">테스트</a></li></ul></li><li><a href="#마치며" class="table-of-contents__link toc-highlight">마치며</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container--fluid"><div class="row"><div class="newsletterForm_kJQ8 col"><p>Sign up for our newsletters:</p><span class="ant-input-group-wrapper ant-input-group-wrapper-outlined css-198drv2 ant-input-search ant-input-search-with-button signUpForm_fXdf"><span class="ant-input-wrapper ant-input-group css-198drv2"><span class="ant-input-affix-wrapper css-198drv2 ant-input-outlined"><span class="ant-input-prefix"><span role="img" aria-label="mail" class="anticon anticon-mail"><svg viewBox="64 64 896 896" focusable="false" data-icon="mail" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0068.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"></path></svg></span></span><input type="search" placeholder="Your e-mail" required="" aria-required="true" class="ant-input css-198drv2" value=""></span><span class="ant-input-group-addon"><button title="Sign up for our newsletters" type="button" class="ant-btn css-198drv2 ant-btn-default ant-btn-color-default ant-btn-variant-outlined ant-input-search-button"><span>Subscribe</span></button></span></span></span></div><div class="copyright_C6JK col"><div>© 2015-<!-- -->2026<!-- -->, LY Corporation<br><br><a href="https://terms.line.me/line_rules?lang=en" target="_blank" rel="noopener noreferrer">Privacy policy</a></div><div><span role="img" aria-label="Armeria project logo" aria-hidden="false"><svg class="" style="width:4rem;overflow:hidden;vertical-align:middle" viewBox="20 70 70 70" version="1.1"><title>Armeria project logo</title><g id="layer1" transform="translate(0,-87)"><g id="g4208" transform="matrix(1.3217499,0,0,1.3217499,-49.437761,-33.946772)"><g transform="matrix(0.35277777,0,0,-0.35277777,80.962517,162.47851)" id="g46"><path id="path48" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="M 0,0 -20.785,-12 V -36 L 0,-48 20.785,-36 v 24 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,95.627238,162.47851)" id="g50"><path id="path52" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="M 0,0 V 24 L -20.785,12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,66.297787,170.94517)" id="g54"><path id="path56" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="M 0,0 V 24 L -20.784,12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,88.294897,192.11184)" id="g58"><path id="path60" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="M 0,0 V 24 L -20.785,12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,66.297787,154.01184)" id="g62"><path id="path64" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="m 0,0 v -24 l 20.785,12 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,95.627238,162.47851)" id="g66"><path id="path68" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="m 0,0 v -24 l 20.785,12 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,73.630137,183.64517)" id="g70"><path id="path72" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="m 0,0 v -24 l 20.785,12 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,73.630137,149.77851)" id="g74"><path id="path76" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="M 0,0 -20.785,-12 0,-24 20.785,-12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,95.627238,154.01184)" id="g78"><path id="path80" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="M 0,0 -20.785,12 -41.569,0 -20.785,-12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,88.294897,166.71184)" id="g82"><path id="path84" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="m 0,0 v 0 -24 l 20.785,12 V 12 L 0,24 -20.785,12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,73.630137,166.71184)" id="g86"><path id="path88" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="M 0,0 20.785,12 0,24 -20.785,12 V -12 L 0,-24 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,88.294897,192.11184)" id="g90"><path id="path92" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="M 0,0 20.785,12 V 36 L 0,24 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,95.627238,170.94517)" id="g94"><path id="path96" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="m 0,0 v -24 l 20.785,12 v 24 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,66.297787,187.8785)" id="g98"><path id="path100" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="M 0,0 20.785,-12 V 12 L 0,24 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,58.965587,166.71184)" id="g102"><path id="path104" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="m 0,0 v -24 l 20.784,-12 v 24 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,80.962517,179.41184)" id="g106"><path id="path108" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="M 0,0 -20.785,12 V -12 L 0,-24 20.785,-12 v 24 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,88.294897,158.24517)" id="g110"><path id="path112" class="tertiary_B5zC" style="fill:transparent" d="M 0,0 -20.785,12 -41.569,0 -20.785,-12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,95.627238,170.94517)" id="g114"><path id="path116" class="tertiary_B5zC" style="fill:transparent" d="M 0,0 -20.785,-12 V -36 L 0,-24 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,66.297787,170.94517)" id="g118"><path id="path120" class="tertiary_B5zC" style="fill:transparent" d="M 0,0 20.785,-12 V -36 L 0,-24 Z"></path></g></g></g></svg></span></div></div></div></div></footer><div id="starBegging_pb0B" class="off_vUOf"><p>Like Armeria?<br>Star us ⭐️</p><span role="button" tabindex="0" class="close_CaW0">×</span> <iframe id="starFrame" class="githubStar" title="github-stars" src="https://ghbtns.com/github-btn.html?user=line&amp;repo=armeria&amp;type=star&amp;count=true&amp;size=large" width="150px" height="30px"></iframe></div></div>
</body>
</html>