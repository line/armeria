# Collecting metrics

Armeria has built-in support for collecting metrics both on the server and client side. This page describes how to enable this.

The metric data is collected using the [Micrometer](https://micrometer.io/) library. Please consult its documentation for information on how to expose the collected metrics to various monitoring systems (JMX, Prometheus, etc)

## Collecting server-side metrics (gRPC)

```java
import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;
import com.linecorp.armeria.server.Server;
import com.linecorp.armeria.server.ServerBuilder;
import com.linecorp.armeria.server.grpc.GrpcService;
import com.linecorp.armeria.server.metric.MetricCollectingService;

ServerBuilder serverBuilder = Server.builder()
        .http(new InetSocketAddress(address, port))
        .service(
                GrpcService.builder()
                        .addService(new MyHelloService())
                        .build()
        )
        .decorator(MetricCollectingService.newDecorator(
                GrpcMeterIdPrefixFunction.of("my.service"))
        );
```

In cases where more sophisticated filtering and/or mangling of the generated metrics are required, you can use the `meterRegistry()` method like this:

```java
ServerBuilder serverBuilder = Server.builder()
        // ...
        .meterRegistry(myMeterRegistry);
```

## Collecting client-side metrics (gRPC)

This approach can used to collect metrics in a gRPC client:

```java
import com.linecorp.armeria.client.ClientOptions;
import com.linecorp.armeria.client.Clients;
import com.linecorp.armeria.client.metric.MetricCollectingClient;
import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;

return Clients.builder(grpcUrl)
        .options(
                ClientOptions.builder()
                        .decorator(
                                MetricCollectingClient.newDecorator(
                                        GrpcMeterIdPrefixFunction.of("my.client")
                                )
                        )
                        .build()
        )
        .build(HelloServiceBlockingStub.class);
```

Like with the server-side metrics described above, certain scenarios might require you to provide a custom meter registry. To accomplish this, override the `ClientFactory` in this way:

```java
import com.linecorp.armeria.client.ClientFactory;
import com.linecorp.armeria.client.Clients;

ClientFactory clientFactory = ClientFactory.builder()
        .meterRegistry(myMeterRegistry)
        .build();

return Clients.builder(grpcUrl)
        .factory(clientFactory)
        // ...
        .build(HelloServiceBlockingStub.class);
```
