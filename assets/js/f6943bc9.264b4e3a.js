"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[5375],{28453:(e,a,t)=>{t.d(a,{R:()=>n,x:()=>c});var r=t(96540);const i={},o=r.createContext(i);function n(e){const a=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(a):{...a,...e}},[a,e])}function c(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:n(e.components),r.createElement(o.Provider,{value:a},e.children)}},42276:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>l,contentTitle:()=>c,default:()=>d,frontMatter:()=>n,metadata:()=>r,toc:()=>m});const r=JSON.parse('{"id":"server/multipart","title":"Handling a multipart request","description":"Armeria provides Multipart encoder and decoder built on top of","source":"@site/src/content/docs/server/multipart.mdx","sourceDirName":"server","slug":"/server/multipart","permalink":"/docs/server/multipart","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site-new/src/content/docs/server/multipart.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Service registration for discovery","permalink":"/docs/server/service-registration"},"next":{"title":"Configuring server timeouts","permalink":"/docs/server/timeouts"}}');var i=t(74848),o=t(28453);const n={},c="Handling a multipart request",l={},m=[{value:"Building a multipart request",id:"building-a-multipart-request",level:2},{value:"Sending a multipart request",id:"sending-a-multipart-request",level:2},{value:"Receiving a multipart request",id:"receiving-a-multipart-request",level:2},{value:"Using @Param annotation",id:"using-param-annotation",level:2}];function s(e){const a={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(a.header,{children:(0,i.jsx)(a.h1,{id:"handling-a-multipart-request",children:"Handling a multipart request"})}),"\n",(0,i.jsxs)(a.p,{children:["Armeria provides ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/Multipart.html",children:"Multipart"})," encoder and decoder built on top of\n",(0,i.jsx)(a.a,{href:"https://www.reactive-streams.org/",children:"Reactive Streams"}),"."]}),"\n",(0,i.jsx)(a.h2,{id:"building-a-multipart-request",children:"Building a multipart request"}),"\n",(0,i.jsxs)(a.p,{children:["A ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/Multipart.html",children:"Multipart"})," consists of multiple ",(0,i.jsx)(a.a,{href:"typeplural://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/BodyPart.html",children:"BodyPart"}),".\nEach ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/BodyPart.html",children:"BodyPart"})," is divided into headers and a body. A ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/BodyPart.html",children:"BodyPart"})," headers can be created simply\nusing ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/ContentDisposition.html",children:"ContentDisposition"}),".\n",(0,i.jsx)(a.code,{children:"String"}),", ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpData.html",children:"HttpData"}),", or ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/stream/StreamMessage.html",children:"StreamMessage"})," can be set as the body of the ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/BodyPart.html",children:"BodyPart"}),"."]}),"\n",(0,i.jsx)(a.admonition,{type:"tip",children:(0,i.jsxs)(a.p,{children:["You can also use ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpHeaders.html",children:"HttpHeaders"})," to set complex headers for ",(0,i.jsx)(a.a,{href:"type://#",children:"BobyPart#headers()"}),"."]})}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-java",children:'import java.nio.file.Path;\nimport com.linecorp.armeria.common.ContentDisposition;\nimport com.linecorp.armeria.common.multipart.BodyPart;\n\n// Create a \'Content-Disposition\' header with the \'name\' parameter set to \'name\'.\nContentDisposition nameDisposition =\n    ContentDisposition.of("form-data", "name");\n// Create a BodyPart with \'Content-Disposition\' header and its data.\nBodyPart bodyPart1 = BodyPart.of(nameDisposition, "Meri Kim");\n\n// Create a \'Content-Disposition\' header with the name parameter set to "image",\n// and the filename parameter set to "profile.png"\nContentDisposition imageDisposition =\n    ContentDisposition.of("form-data", "image", "profile.png");\nPath image = Paths.get("/path/to/image");\n// Create a BodyPart with \'Content-Disposition\' header and its file.\nBodyPart bodyPart2 = BodyPart.of(imageDisposition, StreamMessage.of(image));\n\n// Create a new multipart with the two body parts.\nMultipart multipart = Multipart.of(bodyPart1, bodyPart2);\n'})}),"\n",(0,i.jsxs)(a.p,{children:["If we encode and print the ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/Multipart.html",children:"Multipart"})," created above,"]}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-java",children:"for (HttpData httpData : multipart.toStreamMessage().collect().join()) {\n  System.out.print(httpData.toStringUtf8());\n}\n"})}),"\n",(0,i.jsxs)(a.p,{children:["we can see how the ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/Multipart.html",children:"Multipart"})," is encoded as shown below:"]}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{children:'--ArmeriaBoundaryEsbNVr9Z66DAIYIN\ncontent-disposition:form-data; name="name"\ncontent-type:text/plain\n\nMeri Kim\n--ArmeriaBoundaryEsbNVr9Z66DAIYIN\ncontent-disposition:form-data; name="image"; filename="profile.png"\ncontent-type:application/octet-stream\n\n<binary-data>\n--ArmeriaBoundaryEsbNVr9Z66DAIYIN--\n'})}),"\n",(0,i.jsx)(a.h2,{id:"sending-a-multipart-request",children:"Sending a multipart request"}),"\n",(0,i.jsxs)(a.p,{children:["The ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/Multipart.html",children:"Multipart"})," created in this way can be converted to an ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpRequest.html",children:"HttpRequest"})," through\n",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/Multipart.html#toHttpRequest(java.lang.String)",children:"Multipart#toHttpRequest(String)"})," and transmitted to a server using a ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/WebClient.html",children:"WebClient"}),"."]}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-java",children:'WebClient client = WebClient.of("https://armeria.dev");\n// Encode a `Multipart` into an `HttpRequest`\nHttpRequest request = multipart.toHttpRequest("/upload");\nclient.execute(request).aggregate()...;\n'})}),"\n",(0,i.jsx)(a.h2,{id:"receiving-a-multipart-request",children:"Receiving a multipart request"}),"\n",(0,i.jsxs)(a.p,{children:["On the server side, the multipart request sent from the client can be decoded into a ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/Multipart.html",children:"Multipart"}),"\nusing ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/Multipart.html#from(com.linecorp.armeria.common.HttpRequest)",children:"Multipart#from(HttpRequest)"}),"."]}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-java",children:"Server.builder()\n      .service((ctx, req) -> {\n        // Decode an `HttpRequest` into a `Multipart`\n        Multipart multipart = Multipart.from(req);\n        ...\n      })\n"})}),"\n",(0,i.jsxs)(a.p,{children:["Since ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/Multipart.html",children:"Multipart"})," does not have the actual multipart data, you can use\n",(0,i.jsx)(a.code,{children:"Multipart.bodyParts().subscribe(...)"})," to read data little by little as needed.\nIf the size of the data is not large, the data can be read after being loaded into memory through\n",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/Multipart.html#aggregate()",children:"Multipart#aggregate()"}),"."]}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-java",children:"// Use a `Subscriber` to read the data with backpressure.\nmultipart.bodyParts().subsribe(new Subscriber() {\n   ...\n});\n\n// Read the data after aggregation.\nMultipart.from(req).aggregate()\n         .thenAccept(multipart -> {\n             for (AggregatedBodyPart bodyPart : multipart.bodyParts()) {\n                 String content = bodyPart.contentUtf8();\n                 ...\n             }\n         });\n"})}),"\n",(0,i.jsxs)(a.h2,{id:"using-param-annotation",children:["Using ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/annotation/Param.html",children:"@Param"})," annotation"]}),"\n",(0,i.jsxs)(a.p,{children:["In annotated services, a body part content of ",(0,i.jsx)(a.code,{children:"multipart/form-data"})," can be directly mapped into a ",(0,i.jsx)(a.code,{children:"String"}),",\n",(0,i.jsx)(a.code,{children:"Path"}),", ",(0,i.jsx)(a.code,{children:"File"}),", or ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/MultipartFile.html",children:"MultipartFile"})," using the ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/annotation/Param.html",children:"@Param"})," annotation."]}),"\n",(0,i.jsx)(a.admonition,{type:"tip",children:(0,i.jsxs)(a.p,{children:["Note that a ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/BodyPart.html",children:"BodyPart"})," can be converted into a ",(0,i.jsx)(a.code,{children:"Path"}),", ",(0,i.jsx)(a.code,{children:"File"})," or ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/MultipartFile.html",children:"MultipartFile"})," only when\nthe ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/BodyPart.html#filename()",children:"BodyPart#filename()"})," and ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/multipart/BodyPart.html#name()",children:"BodyPart#name()"})," is specified."]})}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-java",children:'import java.io.File;\nimport java.nio.file.Path;\n\nimport com.linecorp.armeria.common.MediaTypeNames;\nimport com.linecorp.armeria.common.multipart.MultipartFile;\nimport com.linecorp.armeria.server.annotation.Consumes;\nimport com.linecorp.armeria.server.annotation.Post;\n\n@Consumes(MediaTypeNames.MULTIPART_FORM_DATA)\n@Post("/upload")\npublic HttpResponse upload(\n    @Param String param,\n    @Param File file,\n    @Param Path path,\n    @Param MultipartFile multipartFile) {\n    // Do something with the multipart data\n    ...\n}\n'})}),"\n",(0,i.jsxs)(a.admonition,{type:"tip",children:[(0,i.jsxs)(a.p,{children:[(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServerBuilder.html#multipartUploadsLocation(java.nio.file.Path)",children:"ServerBuilder#multipartUploadsLocation(Path)"})," and the files are removed as soon as the request is\nhandled completely by default, i.e. when the ",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/logging/RequestLog.html",children:"RequestLog"})," is complete. If you want to persist the\nuploaded file, you can move the uploaded file to another folder or persistence layer before the deletion."]}),(0,i.jsxs)(a.p,{children:["Alternatively, you can disable the automatic deletion of the uploaded files by setting\n",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/MultipartRemovalStrategy.html#NEVER",children:"MultipartRemovalStrategy#NEVER"})," to\n",(0,i.jsx)(a.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServerBuilder.html#multipartRemovalStrategy(com.linecorp.armeria.server.MultipartRemovalStrategy)",children:"ServerBuilder#multipartRemovalStrategy(MultipartRemovalStrategy)"}),", but please note that you must make\nsure the uploaded files are deleted once they are not in use to avoid the excessive consumption of disk space."]})]})]})}function d(e={}){const{wrapper:a}={...(0,o.R)(),...e.components};return a?(0,i.jsx)(a,{...e,children:(0,i.jsx)(s,{...e})}):s(e)}}}]);