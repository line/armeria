---
date: 2022-07-04
---

## üåü New features

- You can now easily send and receive RESTful APIs using <type://RestClient>. #4263
  - Java
    ```java
    RestClient restClient = RestClient.of("...");
    CompletableFuture<ResponseEntity<Customer>> response =
        restClient.get("/api/v1/customers/{customerId}")
                  .pathParam("customerId", "0000001")
                  .execute(Customer.class);
    ```
  - Kotlin
    ```kt
    val restClient: RestClient = RestClient.of("...");
    val response: ResponseEntity<Customer> =
       restClient
         .get("/api/v1/customers/{customerId}")
         .pathParam("customerId", "0000001")
         .execute<Customer>()  // a suspend function
    ```
  - Scala
    ```scala
    val restClient: ScalaRestClient = ScalaRestClient("...")
    val response: Future[ResponseEntity[Result]] =
      restClient.post("/api/v1/customers")
                .contentJson(new Customer(...))
                .execute[Result]()
    ```
- You can now configure a timeout for an <type://Endpoint> selection of an
  <type://DynamicEndpointGroup>. #4246
  ```java
  DnsAddressEndpointGroup delegate = DnsAddressEndpointGroup.of(...);
  HealthCheckedEndpointGroup healthGroup =
    HealthCheckedEndpointGroup
      .builder(delegate, "/health")
      .selectionTimeout(Duration.ofSeconds(10)) // üëàüëàüëà
      .build();
  ```
- You can now inject dependencies in an annotation using <type://DependencyInjector>. #4006 #4202
  ```java
  // Inject authClient that is needed to create the AuthDecorator.
  WebClient authClient = ...
  DependencyInjector injector = DependencyInjector.ofSingletons(new AuthDecorator(authClient));
  serverBuilder.dependencyInjector(dependencyInjector, true);

  // An annotated service that uses AuthDecorator.
  @Get("/foo")
  @Decorator(AuthDecorator.class)
  public FooResponse foo(FooRequest req) {
      // Authrorized request.
      ...
  }

  // authClient is injected.
  class AuthDecorator implements DecoratingHttpServiceFunction {
      AuthDecorator(WebClient authClient) { ... }

      @Override
      public HttpResponse serve(HttpService delegate, ServiceRequestContext ctx, HttpRequest req)
              throws Exception {
          // Authorize the request.
          ...
      }
  }
  ```
  - Set `armeria.enable-auto-injection` to `true` to apply <type://SpringDependencyInjector>.
- You can now customize the length of string fields or container fields
  of Thrift messages using <type://THttpServiceBuilder> or <type://ThriftClientBuilder>. #4024 #4226
  ```java
  THttpService.builder()
              .addService(new MyThriftService())
              .maxRequestStringLength(MAX_STRING_LENGTH)
              .maxRequestContainerLength(MAX_CONTAINER_LENGTH)
              .build();
  ThriftClients.builder("https://my.server.com")
               .path("/thrift")
               .maxResponseStringLength(MAX_STRING_LENGTH)
               .maxResponseContainerLength(MAX_CONTAINER_LENGTH)
               .build(HelloService.AsyncIface.class);
  ```
- You can now set attributes to an <type://Endpoint> using <type://Attributes> and
  <type://AttributesBuilder>. #4241
  ```java
  AttributesBuilder attrs = Attributes.builder();
  AttributeKey<String> region = AttributeKey.valueOf("region");
  attrs.set(region, "arctic");

  Endpoint endpoint = ...;
  Endpoint endpointB = endpoint.withAttrs(attrs.build());
  assert endpointB.attr(region).equals("arctic");
  ```
- You can now use <type://MultipartFile> to get the actual filename of an uploaded file
  through `multipart/form-data`. #4262
  ```java
  @Consumes(MediaTypeNames.MULTIPART_FORM_DATA)
  @Post("/upload")
  public HttpResponse upload(@Param MultipartFile multipartFile) {
    // The name parameter of the "content-disposition" header
    String name = multipartFile.name();
    // The filename parameter of the "content-disposition" header
    String filename = multipartFile.filename();
    // The file that stores the multipart content.
    File file = multipartFile.file();
    ...
  }
  ```
- You can now read a range of bytes using <type://ByteStreamMessage>. #4058
  ```java
  Path path = ...;
  // Fluently build a `StreamMessage` for a `Path`.
  ByteStreamMessage pathContent =
      StreamMessage.builder(path)
                   .bufferSize(1024)
                   .alloc(alloc)
                   .executor(executor)
                   .build();
  // Slice a range of a file data
  pathContent.range(100, 200);
  HttpResponse response = ...
  ByteStreamMessage partialBody =
      response.split().body().range(100, 200);
  ```
- You can now map a specific exception to a `LogLevel` in <type://LoggingService> and
  <type://LoggingClient>. #3400 #4090
  ```java
  LoggingService.builder()
                .responseLogLevel(IllegalStateException.class, LogLevel.WARN)
                .responseLogLevel(IllegalArgumentException.class, LogLevel.ERROR)
                ...
  ```
- You can now map a specific exception to an <type://HttpResponse>. #4279 #4283
  ```java
  HttpResponse recovered =
      response.recover(IllegalStateException.class, cause -> HttpResponse.of("Fallback"));
  ```
- You can now enable automatic compression for a gRPC response. #4258 #4266
  ```java
  GrpcService.builder()
             .addService(new MyGrpcService())
             .autoCompression(true)
             .build();
  ```
  - This only works when the client sends a `grpc-accept-encoding` header and
    the `CompressorRegistry` has the compressor.
- You can now add a hook to <type://Server> and <type://ClientFactory> that is called when the
  JVM shuts down. #4015 #4043
  ```java
  Runnable whenClosing = () -> System.err.println("Before stopping Server");
  server.closeOnJvmShutdown(whenClosing).thenRun(() -> {
      System.err.println("After Server stopped");
   });
  ```
- You can now customize internal Netty `Pipeline` using
  <type://ClientFactoryOptions#CHANNEL_PIPELINE_CUSTOMIZER>. #3907 #4260
  - This is for testing purpose and not recommended to use if you are not familiar with
    Armeria and Netty internals.

### Kotlin
- You can now use the Kotlin nullable type(`?`) to indicate a nullable parameter in
  an annotated service. #4144 #4225
  ```kt
  serverBuilder.apply {
    annotatedService(object {
      @Get("/foo")
      fun foo(@Param a: String?) = // üëàüëàüëà
        HttpResponse.of("a: $a")
    })
  }
  ```

## üìà Improvements

- The <type://EndpointSelectionTimeoutException> is thrown if timeout occurred when selecting
  an <type://Endpoint> from an <type://EndpointGroup>. #4269
- You can now set multiple <type://AccessLogWriter> to <type://ServerBuilder>
  and <type://ServiceBindingBuilder>. #4280
- You can now give a performance optimization hint to a client by setting an <type://ExchangeType> to a
  <type://RequestOptions>. The <type://ExchangeType> is automatically detected for a gRPC client and
  a Thrift client, or <type://WebClient> when it's used with <type://ResponseAs>. #4236
- Better performance for unary gRPC call by introducing `UnaryServerCall`. #4192
- Annotated services perform better on unary responses. #4177

## üõ†Ô∏è Bug fixes

- You can now run `ServerInterceptors` in a blocking task executor when
  <type://GrpcServiceBuilder#useBlockingTaskExecutor(boolean)> is enabled. #4331
- <type://Multiparts#getBoundary()> now throws an `IllegalStateException` instead
  of `NullPointerException` when a boundary is missing. #4193 #4325
- Armeria retrofit streaming mode now requests data to upstream when it does not have one. #4319
- You no longer see deep recursive calls in <type://PublisherBasedStreamMessage>. #4298
- You no longer see `IllegalArgumentException` indicating the prohibited character of a header name
  in an environment where Spring integration module and Netty client are used together.
  (e.g. Spring Cloud Gateway) #4293
- <type://ServerCacheControl#DISABLED> and <type://ServerCacheControl#REVALIDATED> now have
  `max-age` set to `0`. #4290 #4291
- You no longer see a `NullPointerException` from <type://Flags>
  when <type://RequestContextExportingAppender> is used. #4285
- You no longer see hang by not requesting more data in `StreamMessageInputStream`. #4268 #4271
- A <type://WriteTimeoutException> is thrown when a header only request times out. #4255 #4259
- The request completes even when the content sanitizer throw an exception. #4248
- A proxy client doesn't resolve a hostname anymore. #4244 #4245
- <type://WebClient> is reused in the Spring integration module. #4240
- Armeria server sends 400 Bad Request when an HTTP/2 upgrade request contains invalid headers. #4016 #4224
- <type://EurekaUpdatingListener> registers itself with the `instanceId` which is `hostname:appname:port`. #4223
- A ramping up <type://EndpointSelectionStrategy> now correctly works with
  <type://HealthCheckedEndpointGroup>. #4221
- The information of a thrown exception in gRPC service is now propagated to the client via the
  `grpc-status-details-bin` header. #4203 #4204

## üèöÔ∏è Deprecations

- <type://AbstractEndpointSelector#select(ClientRequestContext,ScheduledExecutorService,long)?full>
  is deprecated in favor of
  <type://AbstractEndpointSelector#select(ClientRequestContext,ScheduledExecutorService)?full>. #4246
- <type://ThriftSerializationFormats#protocolFactory(SerializationFormat)?full> is deprecated in favor of
  <type://ThriftSerializationFormats#protocolFactory(SerializationFormat,long,long)?full>.
  #4226
- `BINARY`, `COMPACT`, `JSON`, `TEXT`, and `TEXT_NAMED_ENUM` in <type://ThriftProtocolFactories> are deprecated
  in favor of corresponding factory methods. $4226
- <type://StreamMessage#of(Path,int)?full>, <type://StreamMessage#of(Path,ByteBufAllocator,int)?full> and
  <type://StreamMessage#of(Path,ExecutorService,ByteBufAllocator,int)?full> are deprecated
  in favor of <type://StreamMessage#builder(Path)?full>. #4058
- <type://ServiceConfig#shutdownBlockingTaskExecutorOnStop()>,
  <type://ServiceConfig#shutdownAccessLogWriterOnStop()>,
  <type://ServerConfig#shutdownBlockingTaskExecutorOnStop()> and
  <type://ServerConfig.shutdownWorkerGroupOnStop()> are not used anymore. $4280

## ‚ò¢Ô∏è Breaking changes

- <type://ByteStreamMessage> is returned instead of `StreamMessage<HttpData>`. #4058
  - e.g <type://StreamMessage#of(File)?full>, <type://SplitHttpMessage#body()>, <type://Multipart.toStreamMessage()>
    and <type://BodyPart.content()>
- `HttpService.exchangeType(RequestHeaders, Route)` is now
  <type://HttpService#exchangeType(RequestHeaders,Routed)>. #4177

## ‚õì Dependencies

- Brave 5.13.8 ‚Üí 5.13.9
- Bucket4J 7.4.0 ‚Üí 7.5.0
- Dropwizard metrics 4.2.9 ‚Üí 4.2.10
- GraphQL 1.8.0 ‚Üí 1.8.2
- gRPC 1.45.1 ‚Üí 1.47.0
- grpc-kotlin-stub 1.2.1 ‚Üí 1.3.0
- Jackson 2.13.2.1 ‚Üí 2.13.3
- Kotlin 1.6.20 ‚Üí 1.7.0
- Kotlinx 1.6.1 ‚Üí 1.6.3
- Micrometer 1.8.5 ‚Üí 1.9.1
- Netty 4.1.76.Final ‚Üí 4.1.78.Final
- Netty incubator 0.0.13.Final ‚Üí 0.0.14.Final
- Project Reactor 3.4.17 ‚Üí 3.4.19
- Prometheus Simpleclient 0.15.0 ‚Üí 0.16.0
- Reactive Streams 1.0.3 ‚Üí 1.0.4
- RxJava 3.1.4 ‚Üí 3.1.5
- scalapb-runtime_2.12 0.11.10 ‚Üí 0.11.11
- Spring Boot 2.6.6 ‚Üí 2.7.1
- Spring Web 5.3.19 ‚Üí 5.3.21

## üôá Thank you

<ThankYou usernames={[
  'ahnyujin',
  'be-hase',
  'devdynam0507',
  'eisig',
  'ghkim3221',
  'ikhoon',
  'injae-kim',
  'Jimexist',
  'jrhee17',
  'kezhenxu94',
  'kojilin',
  'ks-yim',
  'litols',
  'mauhiz',
  'minwoox',
  'natsumehu',
  'ngyukman',
  'ta7uw',
  'timothy-xflowpay',
  'tobias-',
  'trustin'
]} />