"use strict";(self.webpackChunkarmeria_site=self.webpackChunkarmeria_site||[]).push([[9739],{27654:function(e,t,r){r.r(t),r.d(t,{_frontmatter:function(){return s},default:function(){return u},pageTitle:function(){return l}});var i,a=r(63366),n=(r(67294),r(64983)),c=r(28819),o=["components"],l="Collecting metrics",s={},m=(i="Tip",function(e){return console.warn("Component "+i+" was not imported, exported, or provided by MDXProvider as global scope"),(0,n.kt)("div",e)}),d={pageTitle:l,_frontmatter:s},p=c.Z;function u(e){var t=e.components,r=(0,a.Z)(e,o);return(0,n.kt)(p,Object.assign({},d,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"collecting-metrics",style:{position:"relative"}},(0,n.kt)("a",{parentName:"h1",href:"#collecting-metrics","aria-label":"collecting metrics permalink",className:"anchor before"},(0,n.kt)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},(0,n.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Collecting metrics"),(0,n.kt)("h6",{className:"inlinePageToc",role:"navigation"},"Table of contents"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#collecting-server-side-metrics"},"Collecting server-side metrics")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#collecting-client-side-metrics"},"Collecting client-side metrics")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#changing-the-default-distribution-summary-config"},"Changing the default distribution summary config")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#excluding-certain-meters-created-by-armeria"},"Excluding certain meters created by Armeria"))),(0,n.kt)("p",null,"Armeria has built-in support for collecting metrics both on the server and client side.\nThis page describes how to enable this."),(0,n.kt)(m,{mdxType:"Tip"},(0,n.kt)("p",null,"The metric data is collected using the ",(0,n.kt)("a",{parentName:"p",href:"https://micrometer.io/"},"Micrometer")," library.\nPlease consult its documentation for information on how to expose the collected metrics to\nvarious monitoring systems such as ",(0,n.kt)("a",{parentName:"p",href:"https://prometheus.io/"},"Prometheus"),",\n",(0,n.kt)("a",{parentName:"p",href:"https://metrics.dropwizard.io/4.1.2/"},"Dropwizard Metrics")," and ",(0,n.kt)("a",{parentName:"p",href:"https://www.datadoghq.com/"},"Datadog"),".")),(0,n.kt)("h2",{id:"collecting-server-side-metrics",style:{position:"relative"}},(0,n.kt)("a",{parentName:"h2",href:"#collecting-server-side-metrics","aria-label":"collecting server side metrics permalink",className:"anchor before"},(0,n.kt)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},(0,n.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Collecting server-side metrics"),(0,n.kt)("p",null,"You can use ",(0,n.kt)("a",{parentName:"p",href:"type://MetricCollectingService:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/metric/MetricCollectingService.html"},"type://MetricCollectingService")," with ",(0,n.kt)("a",{parentName:"p",href:"type://MeterIdPrefixFunction:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html"},"type://MeterIdPrefixFunction")," for collecting metrics\nof your services."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},'import com.linecorp.armeria.common.MeterIdPrefixFunction;\nimport com.linecorp.armeria.server.Server;\nimport com.linecorp.armeria.server.ServerBuilder;\nimport com.linecorp.armeria.server.metric.MetricCollectingService;\n\nServer.builder()\n      .http(new InetSocketAddress(address, port))\n      .service(new MyHttpService())\n      .decorator(MetricCollectingService.newDecorator(\n              MeterIdPrefixFunction.ofDefault("http.service")))\n      .build();\n')),(0,n.kt)("p",null,"If you are interested in monitoring ",(0,n.kt)("a",{parentName:"p",href:"https://grpc.github.io/grpc/core/md_doc_statuscodes.html"},"gRPC status"),"\nfor a gRPC service, you can use ",(0,n.kt)("a",{parentName:"p",href:"type://GrpcMeterIdPrefixFunction:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/grpc/GrpcMeterIdPrefixFunction.html"},"type://GrpcMeterIdPrefixFunction")," instead of ",(0,n.kt)("a",{parentName:"p",href:"type://MeterIdPrefixFunction:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html"},"type://MeterIdPrefixFunction"),"."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},'import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\nimport com.linecorp.armeria.server.grpc.GrpcService;\n\nServer.builder()\n      .http(new InetSocketAddress(address, port))\n      .service(GrpcService.builder()\n                          .addService(new MyHelloService())\n                          .build())\n      .decorator(MetricCollectingService.newDecorator(\n              GrpcMeterIdPrefixFunction.of("grpc.service")))\n      .build();\n')),(0,n.kt)("p",null,"You can provide ",(0,n.kt)("a",{parentName:"p",href:"type://GrpcMeterIdPrefixFunction:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/grpc/GrpcMeterIdPrefixFunction.html"},"type://GrpcMeterIdPrefixFunction")," as a bean if you are using a Spring integration module:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},'@Bean\npublic MeterIdPrefixFunction grpcMeterIdPrefixFunction() {\n    return GrpcMeterIdPrefixFunction.of("grpc.service");\n}\n')),(0,n.kt)("p",null,"In cases where more sophisticated filtering and/or mangling of the generated metrics are required,\nyou can use the ",(0,n.kt)("a",{parentName:"p",href:"type://ServerBuilder#meterRegistry(MeterRegistry):https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServerBuilder.html#meterRegistry(io.micrometer.core.instrument.MeterRegistry)"},"type://ServerBuilder#meterRegistry(MeterRegistry)")," method like this:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},"Server.builder()\n      // ...\n      .meterRegistry(myMeterRegistry);\n")),(0,n.kt)("h2",{id:"collecting-client-side-metrics",style:{position:"relative"}},(0,n.kt)("a",{parentName:"h2",href:"#collecting-client-side-metrics","aria-label":"collecting client side metrics permalink",className:"anchor before"},(0,n.kt)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},(0,n.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Collecting client-side metrics"),(0,n.kt)("p",null,"This approach can be used to collect metrics for a ",(0,n.kt)("a",{parentName:"p",href:"type://WebClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/WebClient.html"},"type://WebClient")," and a gRPC client:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},'import com.linecorp.armeria.client.WebClient;\nimport com.linecorp.armeria.client.grpc.GrpcClients;\nimport com.linecorp.armeria.client.metric.MetricCollectingClient;\n\n// Decorate a WebClient with MetricCollectingClient\nWebClient.builder(httpUrl)\n         .decorator(MetricCollectingClient.newDecorator(\n                 MeterIdPrefixFunction.ofDefault("http.client")))\n         .build();\n\n// Decorate a gRPC client with MetricCollectingClient\nGrpcClients.builder(grpcUrl)\n           .decorator(MetricCollectingClient.newDecorator(\n                   GrpcMeterIdPrefixFunction.of("grpc.client")))\n           .build(HelloServiceBlockingStub.class);\n')),(0,n.kt)("p",null,"Like the server-side metrics described above, certain scenarios might require you to\nprovide a custom meter registry. To accomplish this, override the ",(0,n.kt)("a",{parentName:"p",href:"type://ClientFactory:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactory.html"},"type://ClientFactory")," in this way:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},"import com.linecorp.armeria.client.ClientFactory;\nimport com.linecorp.armeria.client.Clients;\n\nClientFactory clientFactory =\n      ClientFactory.builder()\n                   .meterRegistry(myMeterRegistry)\n                   .build();\n\n// Set a custom ClientFactory to a WebClient\nWebClient.builder(httpUrl)\n         .factory(clientFactory)\n          // ...\n         .build();\n\n// Set a custom ClientFactory to a gRPC client\nClients.builder(grpcUrl)\n       .factory(clientFactory)\n        // ...\n       .build(HelloServiceBlockingStub.class);\n")),(0,n.kt)("h2",{id:"changing-the-default-distribution-summary-config",style:{position:"relative"}},(0,n.kt)("a",{parentName:"h2",href:"#changing-the-default-distribution-summary-config","aria-label":"changing the default distribution summary config permalink",className:"anchor before"},(0,n.kt)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},(0,n.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Changing the default distribution summary config"),(0,n.kt)("p",null,"A ",(0,n.kt)("a",{parentName:"p",href:"https://micrometer.io/docs/concepts#_distribution_summaries"},"distribution summary")," is used to track\nthe distribution of events. Armeria provides a sensible default\n",(0,n.kt)("a",{parentName:"p",href:"https://javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/distribution/DistributionStatisticConfig.html"},"DistributionStatisticConfig"),"\nfor measuring the following metrics:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"A length of the request content"),(0,n.kt)("li",{parentName:"ul"},"A length of the response content"),(0,n.kt)("li",{parentName:"ul"},"A duration of request"),(0,n.kt)("li",{parentName:"ul"},"A duration of response")),(0,n.kt)("p",null,"If you want to override the default config,\nyou can set your own ",(0,n.kt)("inlineCode",{parentName:"p"},"DistributionStatisticConfig")," using ",(0,n.kt)("a",{parentName:"p",href:"type://MoreMeters#setDistributionStatisticConfig(DistributionStatisticConfig):https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/metric/MoreMeters.html#setDistributionStatisticConfig(io.micrometer.core.instrument.distribution.DistributionStatisticConfig)"},"type://MoreMeters#setDistributionStatisticConfig(DistributionStatisticConfig)"),"."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},"import com.linecorp.armeria.common.metric.MoreMeters;\nimport io.micrometer.core.instrument.distribution.DistributionStatisticConfig;\n\nDistributionStatisticConfig myDistStatCfg =\n        DistributionStatisticConfig.builder()\n                                   .percentilesHistogram(false)\n                                   .sla()\n                                   .percentiles({ 0, 0.5, 0.75, 0.9, 0.95, 0.99, 1.0 })\n                                   .percentilePrecision(10)\n                                   .minimumExpectedValue(1L)\n                                   .maximumExpectedValue(Long.MAX_VALUE)\n                                   .expiry(Duration.ofMinutes(10))\n                                   .bufferLength(10)\n                                   .build();\nMoreMeters.setDistributionStatisticConfig(myDistStatCfg);\n")),(0,n.kt)("h2",{id:"excluding-certain-meters-created-by-armeria",style:{position:"relative"}},(0,n.kt)("a",{parentName:"h2",href:"#excluding-certain-meters-created-by-armeria","aria-label":"excluding certain meters created by armeria permalink",className:"anchor before"},(0,n.kt)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},(0,n.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Excluding certain meters created by Armeria"),(0,n.kt)("p",null,"Micrometer's ",(0,n.kt)("inlineCode",{parentName:"p"},"MeterRegistry")," can be configured with ",(0,n.kt)("a",{parentName:"p",href:"https://micrometer.io/docs/concepts#_meter_filters"},"meter filters"),".\nIf you need to control the exported meters, you can apply sophisticated filters to the ",(0,n.kt)("inlineCode",{parentName:"p"},"MeterRegistry"),"."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},'import com.linecorp.armeria.common.Flags;\n\nFlags.meterRegistry()\n     .config()\n     .meterFilter(MeterFilter.deny(id ->\n                  id.getTag("service").equals("MyHealthCheckService")));\n     .meterFilter(MeterFilter.denyNameStartsWith("jvm"));\n')),(0,n.kt)("p",null,"Please refer to ",(0,n.kt)("a",{parentName:"p",href:"type://MeterIdPrefixFunction:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html"},"type://MeterIdPrefixFunction")," to learn what kinds of tags are used for request metrics."))}u.isMDXComponent=!0},28819:function(e,t,r){r.d(t,{Z:function(){return o}});var i=r(25444),a=r(67294),n=JSON.parse('{"root":["index","setup"],"Useful links":{"Tutorials":"/tutorials","Community articles":"/community/articles","API documentation":"https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/index.html","Release notes":"/release-notes"},"Server":["server-basics","server-decorator","server-grpc","server-thrift","server-graphql","server-docservice","server-annotated-service","server-http-file","server-servlet","server-access-log","server-cors","server-sse","server-service-registration","server-multipart","server-timeouts"],"Client":["client-http","client-thrift","client-grpc","client-factory","client-decorator","client-retrofit","client-custom-http-headers","client-timeouts","client-retry","client-circuit-breaker","client-service-discovery"],"Advanced":["advanced-logging","advanced-structured-logging","advanced-custom-attributes","advanced-streaming-backpressure","advanced-structured-logging-kafka","advanced-metrics","advanced-unit-testing","advanced-production-checklist","advanced-saml","advanced-spring-boot-integration","advanced-spring-webflux-integration","advanced-dropwizard-integration","advanced-kotlin","advanced-scala","advanced-scalapb","advanced-flags-provider","advanced-zipkin","advanced-client-interoperability"]}'),c=r(46731),o=function(e){var t=(0,i.useStaticQuery)("1217743243").allMdx.nodes;return a.createElement(c.Z,Object.assign({},e,{candidateMdxNodes:t,index:n,prefix:"docs",pageTitleSuffix:"Armeria documentation"}))}}}]);
//# sourceMappingURL=component---src-pages-docs-advanced-metrics-mdx-830abbe94cbbd133eb32.js.map