"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[7367],{654:(e,r,i)=>{i.r(r),i.d(r,{assets:()=>s,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"server/decorator","title":"Decorating a service","description":"A \'decorating service\' (or a \'decorator\') is a service that wraps another service","source":"@site/src/content/docs/server/decorator.mdx","sourceDirName":"server","slug":"/server/decorator","permalink":"/docs/server/decorator","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site-new/src/content/docs/server/decorator.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Server basics","permalink":"/docs/server/basics"},"next":{"title":"Running a gRPC service","permalink":"/docs/server/grpc"}}');var n=i(74848),c=i(28453);const a={},o="Decorating a service",s={},d=[{value:"Implementing <code>DecoratingHttpServiceFunction</code> and <code>DecoratingRpcServiceFunction</code>",id:"implementing-decoratinghttpservicefunction-and-decoratingrpcservicefunction",level:2},{value:"Extending <code>SimpleDecoratingHttpService</code> and <code>SimpleDecoratingRpcService</code>",id:"extending-simpledecoratinghttpservice-and-simpledecoratingrpcservice",level:2},{value:"Extending <code>DecoratingService</code>",id:"extending-decoratingservice",level:2},{value:"Unwrapping decoration",id:"unwrapping-decoration",level:2},{value:"Decorating <code>ServiceWithRoutes</code>",id:"decorating-servicewithroutes",level:2},{value:"Decorating multiple services by path mapping",id:"decorating-multiple-services-by-path-mapping",level:2},{value:"See also",id:"see-also",level:2}];function l(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.header,{children:(0,n.jsx)(r.h1,{id:"decorating-a-service",children:"Decorating a service"})}),"\n",(0,n.jsxs)(r.p,{children:["A 'decorating service' (or a 'decorator') is a service that wraps another service\nto intercept an incoming request or an outgoing response. As its name says, it is an implementation of\n",(0,n.jsx)(r.a,{href:"https://en.wikipedia.org/wiki/Decorator_pattern",children:"the decorator pattern"}),". Service decoration takes a crucial role in Armeria. A lot of core features\nsuch as logging, metrics and distributed tracing are implemented as decorators and you will also find it\nuseful when ",(0,n.jsx)(r.a,{href:"https://en.wikipedia.org/wiki/Separation_of_concerns",children:"separating concerns"}),"."]}),"\n",(0,n.jsx)(r.p,{children:"There are basically three ways to write a decorating service:"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["Implementing ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/DecoratingHttpServiceFunction.html",children:"DecoratingHttpServiceFunction"})," and ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/DecoratingRpcServiceFunction.html",children:"DecoratingRpcServiceFunction"})]}),"\n",(0,n.jsxs)(r.li,{children:["Extending ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/SimpleDecoratingHttpService.html",children:"SimpleDecoratingHttpService"})," and ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/SimpleDecoratingRpcService.html",children:"SimpleDecoratingRpcService"})]}),"\n",(0,n.jsxs)(r.li,{children:["Extending ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/DecoratingService.html",children:"DecoratingService"})]}),"\n"]}),"\n",(0,n.jsxs)(r.h2,{id:"implementing-decoratinghttpservicefunction-and-decoratingrpcservicefunction",children:["Implementing ",(0,n.jsx)(r.code,{children:"DecoratingHttpServiceFunction"})," and ",(0,n.jsx)(r.code,{children:"DecoratingRpcServiceFunction"})]}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/DecoratingHttpServiceFunction.html",children:"DecoratingHttpServiceFunction"})," and ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/DecoratingRpcServiceFunction.html",children:"DecoratingRpcServiceFunction"})," are functional interfaces that\ngreatly simplify the implementation of a decorating service. They enables you to write a decorating service\nwith a single lambda expression:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.HttpResponse;\nimport com.linecorp.armeria.common.HttpStatus;\nimport com.linecorp.armeria.server.HttpService;\n\nServerBuilder sb = Server.builder();\nHttpService service = ...;\nsb.serviceUnder("/web", service.decorate((delegate, ctx, req) -> {\n    if (!authenticate(req)) {\n        // Authentication failed; fail the request.\n        return HttpResponse.of(HttpStatus.UNAUTHORIZED);\n    }\n\n    // Authenticated; pass the request to the actual service.\n    return delegate.serve(ctx, req);\n});\n'})}),"\n",(0,n.jsxs)(r.h2,{id:"extending-simpledecoratinghttpservice-and-simpledecoratingrpcservice",children:["Extending ",(0,n.jsx)(r.code,{children:"SimpleDecoratingHttpService"})," and ",(0,n.jsx)(r.code,{children:"SimpleDecoratingRpcService"})]}),"\n",(0,n.jsxs)(r.p,{children:["If your decorator is expected to be reusable, it is recommended to define a new top-level class that extends\n",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/SimpleDecoratingHttpService.html",children:"SimpleDecoratingHttpService"})," or ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/SimpleDecoratingRpcService.html",children:"SimpleDecoratingRpcService"})," depending on whether you are\ndecorating an ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/HttpService.html",children:"HttpService"})," or an ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/RpcService.html",children:"RpcService"}),":"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.HttpRequest;\nimport com.linecorp.armeria.common.HttpResponse;\nimport com.linecorp.armeria.server.HttpService;\nimport com.linecorp.armeria.server.ServiceRequestContext;\nimport com.linecorp.armeria.server.SimpleDecoratingHttpService;\n\npublic class AuthService extends SimpleDecoratingHttpService {\n    public AuthService(HttpService delegate) {\n        super(delegate);\n    }\n\n    @Override\n    public HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) throws Exception {\n        if (!authenticate(req)) {\n            // Authentication failed; fail the request.\n            return HttpResponse.of(HttpStatus.UNAUTHORIZED);\n        }\n\n        HttpService delegate = unwrap();\n        return delegate.serve(ctx, req);\n    }\n}\n\nServerBuilder sb = Server.builder();\n// Using a lambda expression:\nsb.serviceUnder("/web", service.decorate(delegate -> new AuthService(delegate)));\n'})}),"\n",(0,n.jsxs)(r.h2,{id:"extending-decoratingservice",children:["Extending ",(0,n.jsx)(r.code,{children:"DecoratingService"})]}),"\n",(0,n.jsxs)(r.p,{children:["So far, we only demonstrated the case where a decorating service does not transform the type of the request and\nresponse. You can do that as well, of course, using ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/DecoratingService.html",children:"DecoratingService"}),":"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:"import com.linecorp.armeria.server.RpcService;\n\n// Transforms an RpcService into an HttpService.\npublic class MyRpcService extends DecoratingService<RpcRequest, RpcResponse,\n                                                    HttpRequest, HttpResponse> {\n\n    public MyRpcService(Service<? super RpcRequest, ? extends RpcResponse> delegate) {\n        super(delegate);\n    }\n\n    @Override\n    public HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) throws Exception {\n        // This method has been greatly simplified for easier understanding.\n        // In reality, we will have to do this asynchronously.\n        RpcRequest rpcReq = convertToRpcRequest(req);\n        RpcResponse rpcRes = unwrap().serve(ctx, rpcReq);\n        return convertToHttpResponse(rpcRes);\n    }\n\n    private RpcRequest convertToRpcRequest(HttpRequest req) { ... }\n    private HttpResponse convertToHttpResponse(RpcResponse res) { ... }\n}\n"})}),"\n",(0,n.jsx)(r.h2,{id:"unwrapping-decoration",children:"Unwrapping decoration"}),"\n",(0,n.jsxs)(r.p,{children:["Once a service is decorated, the type of the service is not that of the original service\nanymore. Therefore, you cannot simply down-cast it to access the method exposed by the original service.\nInstead, you need to 'unwrap' the decorator using the ",(0,n.jsx)(r.code,{children:"Service.as()"})," method:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:"MyService service = ...;\nMyDecoratedService decoratedService = service.decorate(...);\n\nassert !(decoratedService instanceof MyService);\nassert decoratedService.as(MyService.class) == service;\nassert decoratedService.as(MyDecoratedService.class) == decoratedService;\nassert decoratedService.as(SomeOtherService.class) == null;\n"})}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.code,{children:"as()"})," is especially useful when you are looking for the service instances that implements\na certain type from a server:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:"import com.linecorp.armeria.server.ServerConfig;\nimport java.util.List;\n\nServer server = ...;\nServerConfig serverConfig = server.config();\nList<ServiceConfig> serviceConfigs = serverConfig.serviceConfigs();\nfor (ServiceConfig sc : serviceConfigs) {\n    if (sc.service().as(SomeType.class) != null) {\n        // Handle the service who implements or extends SomeType.\n    }\n}\n"})}),"\n",(0,n.jsxs)(r.h2,{id:"decorating-servicewithroutes",children:["Decorating ",(0,n.jsx)(r.code,{children:"ServiceWithRoutes"})]}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceWithRoutes.html",children:"ServiceWithRoutes"})," is a special variant of service which allows a user to register multiple\nroutes for a single service. It has a method called ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceWithRoutes.html#routes()",children:"ServiceWithRoutes#routes()"})," which returns a ",(0,n.jsx)(r.code,{children:"Set"})," of\n",(0,n.jsx)(r.a,{href:"typeplural://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/Route.html",children:"Route"})," so that you do not have to specify path when registering your service:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.server.Route;\nimport com.linecorp.armeria.server.HttpServiceWithRoutes;\nimport java.util.HashSet;\nimport java.util.Set;\n\npublic class MyServiceWithRoutes implements HttpServiceWithRoutes {\n    @Override\n    public HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) { ... }\n\n    @Override\n    public Set<Route> routes() {\n        Set<Route> routes = new HashSet<>();\n        routes.add(Route.builder().path("/services/greet").build());\n        routes.add(Route.builder().path("/services/hello").build());\n        return routes;\n    }\n}\n\nServerBuilder sb = Server.builder();\n// No path is specified.\nsb.service(new MyServiceWithRoutes());\n// Override the path provided by routes().\nsb.service("/services/hola", new MyServiceWithRoutes());\n'})}),"\n",(0,n.jsxs)(r.p,{children:["However, decorating a ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceWithRoutes.html",children:"ServiceWithRoutes"})," can lead to a compilation error when you attempt to\nregister it without specifying a path explicitly, because a decorated service is not a\n",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceWithRoutes.html",children:"ServiceWithRoutes"})," anymore but just a service:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.server.logging.LoggingService;\n\nServerBuilder sb = Server.builder();\n\n// Works.\nHttpServiceWithRoutes service = new MyServiceWithRoutes();\nsb.service(service);\n\n// Does not work - not a HttpServiceWithRoutes anymore due to decoration.\nHttpService decoratedService = service.decorate(LoggingService.newDecorator());\nsb.service(decoratedService); // Compilation error\n\n// Works if a path is specified explicitly.\nsb.service("/services/bonjour", decoratedService);\n'})}),"\n",(0,n.jsx)(r.p,{children:"Therefore, you need to specify the decorators as extra parameters:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:"ServerBuilder sb = Server.builder();\n// Register a service decorated with two decorators at multiple routes.\nsb.service(new MyServiceWithRoutes(),\n           MyDecoratedService::new,\n           LoggingService.newDecorator())\n"})}),"\n",(0,n.jsxs)(r.p,{children:["A good real-world example of ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceWithRoutes.html",children:"ServiceWithRoutes"})," is ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/grpc/GrpcService.html",children:"GrpcService"}),".\nSee ",(0,n.jsx)(r.a,{href:"/docs/server/grpc#decorating-a-grpcservice",children:"Decorating a GrpcService"})," for more information."]}),"\n",(0,n.jsx)(r.h2,{id:"decorating-multiple-services-by-path-mapping",children:"Decorating multiple services by path mapping"}),"\n",(0,n.jsxs)(r.p,{children:["If you want to decorate multiple ",(0,n.jsx)(r.a,{href:"typeplural://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/Service.html",children:"Service"})," by path mapping or router matching, you can specify\ndecorators using ",(0,n.jsx)(r.code,{children:"decoratorUnder(pathPrefix, ...)"})," or ",(0,n.jsx)(r.code,{children:"decorator(Route, ...)"}),"."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.HttpHeaderNames;\n\nVipService vipService = ...;\nMemberService memberService = ...;\nHtmlService htmlService = ...;\nJsService jsService = ...;\n\nServerBuilder sb = Server.builder();\n\n// Register vipService and memberService under \'/users\' path\nsb.annotatedService("/users/vip", vipService)\n  .annotatedService("/users/members", memberService);\n\n// Decorate all services under \'/users\' path\nsb.decoratorUnder("/users", (delegate, ctx, req) -> {\n    if (!authenticate(req)) {\n        return HttpResponse.of(HttpStatus.UNAUTHORIZED);\n    }\n    return delegate.serve(ctx, req);\n});\n\n// Register htmlService and jsService under \'/public\' path\nsb.serviceUnder("/public/html", htmlService)\n  .serviceUnder("/public/js", jsService);\n\n// Decorate services only when a request method is \'GET\'\nsb.decorator(Route.builder().get("/public").build(), (delegate, ctx, req) -> {\n    final HttpResponse response = delegate.serve(ctx, req);\n    ctx.mutateAdditionalResponseHeaders(\n            mutator -> mutator.add(HttpHeaderNames.CACHE_CONTROL, "public"));\n    return response;\n});\n'})}),"\n",(0,n.jsxs)(r.p,{children:["You can also use fluent route builder with ",(0,n.jsx)(r.code,{children:"routeDecorator()"})," to match services being decorated."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'ServerBuilder sb = Server.builder();\n\n// Register vipService and memberService under \'/users\' path\nsb.annotatedService("/users/vip", vipService)\n  .annotatedService("/users/members", memberService);\n\n// Decorate services under \'/users\' path with fluent route builder\nsb.routeDecorator()\n  .pathPrefix("/users")\n  .build((delegate, ctx, req) -> {\n      if (!authenticate(req)) {\n          return HttpResponse.of(HttpStatus.UNAUTHORIZED);\n      }\n      return delegate.serve(ctx, req);\n  });\n\n// Register htmlService and jsService under \'/public\' path\nsb.serviceUnder("/public/html", htmlService)\n  .serviceUnder("/public/js", jsService);\n\n// Decorate services under \'/public\' path using \'get\' method with path pattern\nsb.routeDecorator()\n  .get("prefix:/public")\n  .build((delegate, ctx, req) -> {\n      final HttpResponse response = delegate.serve(ctx, req);\n      ctx.mutateAdditionalResponseHeaders(\n              mutator -> mutator.add(HttpHeaderNames.CACHE_CONTROL, "public"));\n      return response;\n  });\n'})}),"\n",(0,n.jsxs)(r.p,{children:["Please refer to ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/DecoratingServiceBindingBuilder.html",children:"DecoratingServiceBindingBuilder"})," for more information."]}),"\n",(0,n.jsx)(r.h2,{id:"see-also",children:"See also"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:(0,n.jsx)(r.a,{href:"/docs/client/decorator",children:"Decorating a client"})}),"\n",(0,n.jsx)(r.li,{children:(0,n.jsxs)(r.a,{href:"/docs/advanced/custom-attributes",children:[(0,n.jsx)(r.code,{children:"RequestContext"})," custom attributes"]})}),"\n"]})]})}function p(e={}){const{wrapper:r}={...(0,c.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},28453:(e,r,i)=>{i.d(r,{R:()=>a,x:()=>o});var t=i(96540);const n={},c=t.createContext(n);function a(e){const r=t.useContext(c);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:a(e.components),t.createElement(c.Provider,{value:r},e.children)}}}]);