"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[4651],{15248:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>c,default:()=>p,frontMatter:()=>a,metadata:()=>i,toc:()=>s});const i=JSON.parse('{"id":"client/factory","title":"Customizing a ClientFactory with ClientFactoryBuilder","description":"A ClientFactory manages connections and protocol-specific properties.","source":"@site/src/content/docs/client/factory.mdx","sourceDirName":"client","slug":"/client/factory","permalink":"/docs/client/factory","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site-new/src/content/docs/client/factory.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Calling a gRPC service","permalink":"/docs/client/grpc"},"next":{"title":"Decorating a client","permalink":"/docs/client/decorator"}}');var o=n(74848),r=n(28453);const a={},c="Customizing a ClientFactory with ClientFactoryBuilder",l={},s=[{value:"Customizing TLS",id:"customizing-tls",level:2},{value:"Lifecycle of <code>ClientFactory</code>",id:"lifecycle-of-clientfactory",level:2},{value:"Specifying Netty <code>ChannelOption</code>s",id:"specifying-netty-channeloptions",level:2},{value:"Specifying different <code>EventLoop</code> threads for different endpoints",id:"specifying-different-eventloop-threads-for-different-endpoints",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.header,{children:(0,o.jsxs)(t.h1,{id:"customizing-a-clientfactory-with-clientfactorybuilder",children:["Customizing a ",(0,o.jsx)(t.code,{children:"ClientFactory"})," with ",(0,o.jsx)(t.code,{children:"ClientFactoryBuilder"})]})}),"\n",(0,o.jsxs)(t.p,{children:["A ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactory.html",children:"ClientFactory"})," manages connections and protocol-specific properties.\nYou can customize the properties via ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactoryBuilder.html",children:"ClientFactoryBuilder"}),". For example,\nlet's say that you want to increase the connection timeout."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-java",children:'ClientFactory factory =\n  ClientFactory\n    .builder()\n    // Increase the connection timeout to 5 seconds.\n    .connectTimeoutMillis(5000)\n    .build());\nWebClient client =\n  WebClient\n   .builder("https://armeria.dev")\n   .factory(factory)\n   .build();\nclient.get("/api").aggregate().join();\n'})}),"\n",(0,o.jsxs)(t.p,{children:["The client created with the given ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactory.html",children:"ClientFactory"})," will respect the settings such as connection timeout\nthat you defined.\nYou might notice that the clients, which are created using the same ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactory.html",children:"ClientFactory"}),",\nshare one connection pool. If you don't want to share the connections among the clients,\nyou should use different ",(0,o.jsx)(t.a,{href:"typeplural://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactory.html",children:"ClientFactory"}),".\nFor the complete list of properties, see ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactoryBuilder.html",children:"ClientFactoryBuilder"}),"."]}),"\n",(0,o.jsx)(t.admonition,{type:"tip",children:(0,o.jsxs)(t.p,{children:["You might want to take a look at ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientBuilder.html",children:"ClientBuilder"})," to distinguish the client-specific properties."]})}),"\n",(0,o.jsxs)(t.p,{children:["You can also use ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactoryOptions.html",children:"ClientFactoryOptions"})," to build ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactory.html",children:"ClientFactory"}),".\nIt's more verbose than calling a dedicated setter method, but it can be useful when you need to\nset a series of options programmatically."]}),"\n",(0,o.jsx)(t.h2,{id:"customizing-tls",children:"Customizing TLS"}),"\n",(0,o.jsxs)(t.p,{children:["You can configure the client authentication\nfor ",(0,o.jsx)(t.a,{href:"https://www.cloudflare.com/learning/access-management/what-is-mutual-tls/",children:"mutual TLS (mTLS)"}),"\nusing ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactoryBuilder.html#tls(java.io.InputStream,java.io.InputStream)",children:"ClientFactoryBuilder#tls(InputStream,InputStream)"})," .\nAdditionally, you can specify various options such as a different CA certificate chain or enforce certain\ncipher suites with ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactoryBuilder.html#tlsCustomizer(java.util.function.Consumer)",children:"ClientFactoryBuilder#tlsCustomizer(Consumer)"})," ."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-java",children:"try (InputStream keyCertChainInputStream = ...;\n     InputStream keyInputStream = ...) {\n  ClientFactory factory =\n    ClientFactory\n      .builder()\n      .tls(keyCertChainInputStream, keyInputStream)\n      .build();\n  WebClient\n    .builder()\n    .factory(factory)\n    .build();\n}\n"})}),"\n",(0,o.jsxs)(t.h2,{id:"lifecycle-of-clientfactory",children:["Lifecycle of ",(0,o.jsx)(t.code,{children:"ClientFactory"})]}),"\n",(0,o.jsxs)(t.p,{children:["Most clients for a ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactory.html",children:"ClientFactory"})," need to send requests to another server for the lifetime of an application.\nTherefore, you will generally avoid closing the ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactory.html",children:"ClientFactory"}),", except for perhaps in a shutdown hook,\nto avoid losing any connection to the other servers.\nFor unit tests where a ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactory.html",children:"ClientFactory"})," is only used for a single test or test class,\nit is appropriate to close it when done using it."]}),"\n",(0,o.jsxs)(t.h2,{id:"specifying-netty-channeloptions",children:["Specifying Netty ",(0,o.jsx)(t.code,{children:"ChannelOption"}),"s"]}),"\n",(0,o.jsxs)(t.p,{children:["You can also specify Netty ",(0,o.jsx)(t.a,{href:"https://netty.io/4.1/api/io/netty/channel/ChannelOption.html",children:(0,o.jsx)(t.code,{children:"ChannelOption"})}),"\nvia ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactoryBuilder.html#channelOption(io.netty.channel.ChannelOption,T)",children:"ClientFactoryBuilder#channelOption(ChannelOption,T)"}),":"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-java",children:"ClientFactory factory =\n  ClientFactory\n    .builder()\n    // Set the size of send socket buffer as 4096 bytes\n    .channelOption(ChannelOption.SO_SNDBUF, 4096)\n    .build();\nWebClient\n  .builder()\n  .factory(factory)\n  .build();\n"})}),"\n",(0,o.jsxs)(t.h2,{id:"specifying-different-eventloop-threads-for-different-endpoints",children:["Specifying different ",(0,o.jsx)(t.code,{children:"EventLoop"})," threads for different endpoints"]}),"\n",(0,o.jsxs)(t.p,{children:["By default, Armeria keeps at most 1 connection per endpoint (host and port pair) when using HTTP/2,\nwhich is desirable for typical HTTP/2 services. Armeria achieves this by assigning one ",(0,o.jsx)(t.code,{children:"EventLoop"})," per endpoint\nfrom the ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServerConfig.html#workerGroup()",children:"ServerConfig#workerGroup()"}),". However, there's a limit to the requests that\na single connection(or ",(0,o.jsx)(t.code,{children:"EventLoop"})," which is a thread) can handle, so you might want to increase\nthe number of connections(or ",(0,o.jsx)(t.code,{children:"EventLoop"})," threads) for certain or all endpoints."]}),"\n",(0,o.jsxs)(t.p,{children:["You can do this via ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactoryBuilder.html#maxNumEventLoopsPerEndpoint(int)",children:"ClientFactoryBuilder#maxNumEventLoopsPerEndpoint(int)"}),":"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-java",children:"ClientFactory factory =\n  ClientFactory\n    .builder()\n    // A client will use maximum 5 EventLoops from the worker group per endpoint\n    .maxNumEventLoopsPerEndpoint(5)\n    .build();\nWebClient\n  .builder()\n  .factory(factory)\n  .build();\n\nClientFactory factory =\n  ClientFactory\n    .builder()\n    // or you can just use Integer.MAX_VALUE to use all EventLoops\n    .maxNumEventLoopsPerEndpoint(Integer.MAX_VALUE)\n    .build();\nWebClient\n  .builder()\n  .factory(factory)\n  .build();\n\nClientFactory factory =\n  ClientFactory\n    .builder()\n    // A client will use maximum 5 EventLoops per HTTP/1.1 endpoint\n    .maxNumEventLoopsPerHttp1Endpoint(5)\n    .build();\n"})}),"\n",(0,o.jsxs)(t.p,{children:["The client might need to send many requests to a certain endpoint, while sending small number of requests to others.\nIn that situation, you can use ",(0,o.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactoryBuilder.html#maxNumEventLoopsFunction(java.util.function.ToIntFunction)",children:"ClientFactoryBuilder#maxNumEventLoopsFunction(ToIntFunction)"}),":"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-java",children:'ClientFactory factory =\n  ClientFactory\n    .builder()\n    .maxNumEventLoopsFunction(endpoint -> {\n      if (endpoint.equals(Endpoint.of("lotsOfTraffic.com"))) {\n        // We are going to use all EventLoops to send requests.\n        return Integer.MAX_VALUE;\n      }\n      // We use just one `EventLoop` per endpoint for the rest.\n      return 1;\n    })\n    .build();\nWebClient\n  .builder()\n  .factory(factory)\n  .build();\n'})})]})}function p(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>c});var i=n(96540);const o={},r=i.createContext(o);function a(e){const t=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),i.createElement(r.Provider,{value:t},e.children)}}}]);