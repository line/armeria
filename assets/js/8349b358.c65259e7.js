"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[1519],{7973:(e,r,t)=>{t.d(r,{A:()=>i});const i=t.p+"assets/images/circuit-breakers-armeria-5-fb48c4e7a8981c1da7c2dc9413a94d2f.png"},23306:(e,r,t)=>{t.d(r,{A:()=>i});const i=t.p+"assets/images/circuit-breakers-armeria-2-b3c58daca726cc29671eb155593a051c.png"},28453:(e,r,t)=>{t.d(r,{R:()=>a,x:()=>o});var i=t(96540);const n={},s=i.createContext(n);function a(e){const r=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:a(e.components),i.createElement(s.Provider,{value:r},e.children)}},59726:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>l});var i=t(80061),n=t(74848),s=t(28453);const a={authors:["seunghwanjoo"],other_languages:{ko:"/blog/ko/2020/04/27/circuit-breakers-armeria"}},o="Using Circuit Breakers with Armeria",c={authorsImageUrls:[void 0]},l=[{value:"What is a circuit breaker?",id:"what-is-a-circuit-breaker",level:2},{value:"Status of a circuit breaker",id:"status-of-a-circuit-breaker",level:2},{value:"Armeria&#39;s circuit breaker",id:"armerias-circuit-breaker",level:2},{value:"Preparation",id:"preparation",level:3},{value:"Server2 implementation code",id:"server2-implementation-code",level:4},{value:"Server1 implementation code",id:"server1-implementation-code",level:4},{value:"Testing",id:"testing",level:3},{value:"Conclusion",id:"conclusion",level:2}];function d(e){const r={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.h2,{id:"what-is-a-circuit-breaker",children:"What is a circuit breaker?"}),"\n",(0,n.jsx)(r.p,{children:"Suppose an unexpected failure occurs (For example, a network issue or a server crash) and a remote server is unable to respond to the request.\nIf so, the client who made the request to the remote server will either wait for a response until a timeout occurs, consume resources, or eventually continue to send unnecessary requests.\nAnd on a Microservice Architecture (MSA), this client can also be a server for other services.\nIn the end, clients of this server will have the same problem."}),"\n","\n",(0,n.jsx)(r.p,{children:"This continuous propagation of failures results in the failure of one remote server having a significant impact on all systems.\nThe concept that emerged to solve this problem is known as the circuit breaker."}),"\n",(0,n.jsx)(r.p,{children:"In other words, circuit breakers are a fast method of failing a request from a client to a remote server when the failure rate exceeds a certain threshold, self-diagnosing that there is a problem with the server, and no longer sending unnecessary requests.\nUsing circuit breakers allows us to avoid the aforementioned problems and minimize the size of failure."}),"\n",(0,n.jsxs)(r.p,{children:["You can read more about the concept of circuit breakers in this article previously posted on the blog: ",(0,n.jsx)(r.a,{href:"/blog/2016/07/24/circuit-breakers-for-distributed-services",children:"Circuit breakers for distributed services"})]}),"\n",(0,n.jsx)(r.h2,{id:"status-of-a-circuit-breaker",children:"Status of a circuit breaker"}),"\n",(0,n.jsx)(r.p,{children:"A circuit breaker can be in one of the following three states."}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{src:t(72289).A+"",width:"1806",height:"598"})}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.code,{children:"CLOSED"}),": The failure rate of the request is lower than the configured threshold. This is the initial and default state."]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.code,{children:"OPEN"}),": The failure rate of the request is beyond the configured threshold. Errors occur immediately without sending the actual request (Fails fast)."]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.code,{children:"HALF_OPEN"}),": A status where the response is successful by sending a request once in the middle of the ",(0,n.jsx)(r.code,{children:"OPEN"})," state. If successful, the state switches back to ",(0,n.jsx)(r.code,{children:"CLOSED"}),". Upon failure, the state is left ",(0,n.jsx)(r.code,{children:"OPEN"}),"."]}),"\n"]}),"\n",(0,n.jsx)(r.h2,{id:"armerias-circuit-breaker",children:"Armeria's circuit breaker"}),"\n",(0,n.jsxs)(r.p,{children:[(0,n.jsx)(r.a,{href:"https://github.com/line/armeria",children:"Armeria"})," is an open-source asynchronous microservice framework based on ",(0,n.jsx)(r.a,{href:"https://netty.io/",children:"Netty"})," that is maintained by LINE engineers, which can implement and provide circuit breakers directly.\nLet me show you how circuit breakers work with Armeria."]}),"\n",(0,n.jsx)(r.h3,{id:"preparation",children:"Preparation"}),"\n",(0,n.jsxs)(r.p,{children:["First, let's launch two simple servers (Server1, Server2) to send and receive requests.\nServer1 sends a ",(0,n.jsx)(r.code,{children:"/world"})," request to Server2 when a ",(0,n.jsx)(r.code,{children:"/hello"})," request is received from the Client.\nWhen you receive a response from Server2, you return the response back to the client.\nServer1 is a server, but it is also a client of Server2."]}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{src:t(23306).A+"",width:"840",height:"234"})}),"\n",(0,n.jsx)(r.h4,{id:"server2-implementation-code",children:"Server2 implementation code"}),"\n",(0,n.jsxs)(r.p,{children:["First, here is the implementation of Server2 which will receive the response of Server1.\nIn response to requests coming into ",(0,n.jsx)(r.code,{children:"/world"}),", success (200) and failure (500) are simply implemented to return."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="Server2Application.java"',children:'@SpringBootApplication\npublic class Server2Application {\n\n    private static final AtomicInteger REQ_CNT = new AtomicInteger();\n\n    public static void main(String[] args) {\n        ServerBuilder sb = Server.builder();\n        sb.http(5008);\n        sb.decorator(LoggingService.newDecorator());\n\n        sb.service("/world", (ctx, res) -> {\n            if (REQ_CNT.addAndGet(1) % 2 == 0) {\n                return HttpResponse.of(HttpStatus.INTERNAL_SERVER_ERROR);\n            }\n            return HttpResponse.of(HttpStatus.OK);\n        });\n\n        Server server = sb.build();\n        CompletableFuture<Void> future = server.start();\n        future.join();\n    }\n}\n'})}),"\n",(0,n.jsx)(r.h4,{id:"server1-implementation-code",children:"Server1 implementation code"}),"\n",(0,n.jsxs)(r.p,{children:["Here is the implementation of Server1.\nUnlike the simple one using ",(0,n.jsx)(r.code,{children:"ServerBuilder"})," on Server2, you can find the Service bean that receives requests from the client and the Client bean that sends requests to Server2."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="Server1Application.java"',children:"@SpringBootApplication\n@Import(Server1Context.class)\npublic class Server1Application {\n\n    public static void main(String[] args) {\n        SpringApplication.run(Server1Application.class, args);\n    }\n}\n"})}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="Server1Context.java"',children:'@Configuration\npublic class Server1Context {\n\n    @Bean\n    public HttpServiceRegistrationBean httpService(WebClient webClient) {\n        return new HttpServiceRegistrationBean()\n                .setService((ctx, req) -> webClient.get("/world"))\n                .setServiceName("httpService")\n                .setRoute(Route.builder()\n                               .path("/hello")\n                               .methods(HttpMethod.GET)\n                               .build());\n    }\n\n    @Bean\n    public WebClient webClient() {\n        CircuitBreakerStrategy strategy = CircuitBreakerStrategy.onServerErrorStatus();\n\n        // CircuitBreaker \xec\x84\xa4\xec \x95!!!\n        CircuitBreaker circuitBreaker = CircuitBreaker\n                .builder("test-circuit-breaker")\n                .counterSlidingWindow(Duration.ofSeconds(10))\n                .circuitOpenWindow(Duration.ofSeconds(5))\n                .failureRateThreshold(0.3)\n                .minimumRequestThreshold(5)\n                .trialRequestInterval(Duration.ofSeconds(3))\n                .build();\n\n        return WebClient\n                .builder("http://localhost:5008")\n                .decorator(LoggingClient.newDecorator())\n                .decorator(CircuitBreakerHttpClient.newDecorator(circuitBreaker, strategy))\n                .build();\n    }\n}\n'})}),"\n",(0,n.jsxs)(r.p,{children:["Pay attention to the fact that a Client object has its own ",(0,n.jsx)(r.code,{children:"CircuitBreaker"})," when you use ",(0,n.jsx)(r.code,{children:"CircuitBreaker"})," in Armeria.\nIn other words, if a new Client object is created for each request to Server2 and is extinguished after the request is completed, the ",(0,n.jsx)(r.code,{children:"CircuitBreaker"})," connected to the Client would eventually become useless."]}),"\n",(0,n.jsxs)(r.p,{children:["Therefore, we need a ",(0,n.jsx)(r.code,{children:"WebClient"})," bean that sends requests to Server2 to reuse the same ",(0,n.jsx)(r.code,{children:"WebClient"})," object for the requests to all Server2.\nAnd we can apply ",(0,n.jsx)(r.code,{children:"CircuitBreaker"})," to the ",(0,n.jsx)(r.code,{children:"WebClient"})," object using the ",(0,n.jsx)(r.a,{href:"https://armeria.dev/docs/client-decorator",children:"Decorator"})," provided by Armeria."]}),"\n",(0,n.jsxs)(r.p,{children:["Let's take a look at each field of the ",(0,n.jsx)(r.code,{children:"CircuitBreaker"})," settings above."]}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.code,{children:"counterSlidingWindow"})," (10s): The time interval between measuring the number of successful/failed requests in ",(0,n.jsx)(r.code,{children:"CircuitBreaker"}),". It is used to determine what state to transition or maintain based on a 10-second aggregate."]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.code,{children:"circuitOpenWindow"}),"(5s): The duration that ",(0,n.jsx)(r.code,{children:"CircuitBreaker"})," is kept ",(0,n.jsx)(r.code,{children:"OPEN"}),". Throws an error right away without asking the external server for 5 seconds once in an ",(0,n.jsx)(r.code,{children:"OPEN"})," state (",(0,n.jsx)(r.code,{children:"FailFastException"}),")."]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.code,{children:"failureRateThreshold"}),"(0.3): The rate of failure of the request required to switch to an ",(0,n.jsx)(r.code,{children:"OPEN"})," state. Requests greater than 0.3 (30%) must fail during the ",(0,n.jsx)(r.code,{children:"circuitOpenWindow"})," time to enter the ",(0,n.jsx)(r.code,{children:"OPEN"})," state."]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.code,{children:"minimumRequestThreshold"}),"(5): Minimum number of requests required for measurement. Even if the failure rate is higher than ",(0,n.jsx)(r.code,{children:"failureRateThreshold"}),", it must be the result of at least five requests before it becomes ",(0,n.jsx)(r.code,{children:"OPEN"}),"."]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.code,{children:"trialRequestInterval"}),"(s): Time to remain in the ",(0,n.jsx)(r.code,{children:"HALF_OPEN"})," state. For 3 seconds, it throws a ",(0,n.jsx)(r.code,{children:"FailFastException"})," error as it did when it was ",(0,n.jsx)(r.code,{children:"OPEN"}),", while sending requests to external servers to check if the server returned to normal. If the response to the request sent in these 3 seconds is successful, it immediately switches to the ",(0,n.jsx)(r.code,{children:"CLOSED"})," state; if all fails, it goes back to the ",(0,n.jsx)(r.code,{children:"OPEN"})," state."]}),"\n"]}),"\n",(0,n.jsx)(r.h3,{id:"testing",children:"Testing"}),"\n",(0,n.jsxs)(r.p,{children:["Now let's send requests from the terminal to Server1 using the ",(0,n.jsx)(r.a,{href:"https://www.npmjs.com/package/loadtest",children:"loadtest"})," library."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:"$ loadtest http://127.0.0.1:5007/hello --rps 1\n"})}),"\n",(0,n.jsxs)(r.p,{children:["The log of Server1 provides information on the behavior of ",(0,n.jsx)(r.code,{children:"CircuitBreaker"}),"."]}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{src:t(74067).A+"",width:"2780",height:"440"})}),"\n",(0,n.jsxs)(r.p,{children:["When the server first started, the initial state of ",(0,n.jsx)(r.code,{children:"CircuitBreaker"})," was ",(0,n.jsx)(r.code,{children:"CLOSED"}),"."]}),"\n",(0,n.jsxs)(r.p,{children:["At 03:03:41.830 - Of the total 5 requests measured, the number of failures was 2, so the failure rate was 2/5 = 0.4.\nThus, the failure rate was greater than the previously set failure rate of 0.3 (",(0,n.jsx)(r.code,{children:"failureRateThreshold"}),") and the number of requests used in the measurement was greater than 5 (",(0,n.jsx)(r.code,{children:"minimumRequestThreshold"}),"), so ",(0,n.jsx)(r.code,{children:"CircuitBreaker"})," switched to the ",(0,n.jsx)(r.code,{children:"OPEN"})," state."]}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{src:t(90460).A+"",width:"3160",height:"378"})}),"\n",(0,n.jsxs)(r.p,{children:["From 03:03:41.830 to 03:03:47.824 - ",(0,n.jsx)(r.code,{children:"FailFastException"})," errors continued to occur during subsequent periods, in approximately 5 seconds (",(0,n.jsx)(r.code,{children:"circuitOpenWindow"}),"). (If you check the logs on Server2, you can see that the request was not received at that time.)"]}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{src:t(7973).A+"",width:"2562",height:"448"})}),"\n",(0,n.jsxs)(r.p,{children:["At 03:03:47.824 - the transition is made to the ",(0,n.jsx)(r.code,{children:"HALF_OPEN"})," state, where requests from clients were actually sent to Server2.\nAt this point, the transmitted request luckily received a 200 response and then ",(0,n.jsx)(r.code,{children:"CircuitBreaker"})," switched to the ",(0,n.jsx)(r.code,{children:"CLOSED"})," state."]}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{src:t(89198).A+"",width:"3164",height:"146"})}),"\n",(0,n.jsxs)(r.p,{children:["This process is repeated again because it is ",(0,n.jsx)(r.code,{children:"CLOSED"})," again.\nFrom 03:03:47.827 to 03:03:56.824 - The failure rate was measured for approximately 10 seconds (",(0,n.jsx)(r.code,{children:"counterSlidingWindow"}),"), and the failure rate measured this time was 4/8 = 0.5, so ",(0,n.jsx)(r.code,{children:"CircuitBreaker"})," switched back to the ",(0,n.jsx)(r.code,{children:"OPEN"})," state."]}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.img,{src:t(79191).A+"",width:"3156",height:"626"})}),"\n",(0,n.jsx)(r.p,{children:"We've taken a look at Armeria's circuit breaker in action with the simple test above.\nI hope you now have a better understanding of what the various configurations and operations are for, and how easy it is to implement a circuit breaker client for yourself."}),"\n",(0,n.jsxs)(r.blockquote,{children:["\n",(0,n.jsxs)(r.p,{children:["For more information on Armeria's circuit breakers, please take a look at the ",(0,n.jsx)(r.a,{href:"https://line.github.io/armeria/client-circuit-breaker.html",children:"official Armeria documentation on circuit breakers"}),"."]}),"\n"]}),"\n",(0,n.jsx)(r.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,n.jsx)(r.p,{children:"Armeria provides several features useful to running an MSA in addition to circuit breakers.\nThese features include client-side load balancing and auto-retry.\nWe use Armeria ourselves in our own OpenChat server development, and are enjoying the many benefits its features bring to our daily work.\nI dedicate this post to the open-source Armeria development team who are working day and night to make requested features a reality."})]})}function h(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},72289:(e,r,t)=>{t.d(r,{A:()=>i});const i=t.p+"assets/images/circuit-breakers-armeria-1-f70bdace5b6c392763a6f834aac57203.png"},74067:(e,r,t)=>{t.d(r,{A:()=>i});const i=t.p+"assets/images/circuit-breakers-armeria-3-07759276f457694ff964d39a17233647.png"},79191:(e,r,t)=>{t.d(r,{A:()=>i});const i=t.p+"assets/images/circuit-breakers-armeria-7-d5c6d32d0e6c79a216971115d5a25552.png"},80061:e=>{e.exports=JSON.parse('{"permalink":"/blog/2020/07/08/circuit-breakers-armeria","editUrl":"https://github.com/line/armeria/edit/main/site-new/src/content/blog/en/2020-07-08-circuit-breakers-armeria.mdx","source":"@site/src/content/blog/en/2020-07-08-circuit-breakers-armeria.mdx","title":"Using Circuit Breakers with Armeria","description":"What is a circuit breaker?","date":"2020-07-08T00:00:00.000Z","tags":[],"readingTime":6.71,"hasTruncateMarker":true,"authors":[{"name":"Seunghwan Joo","title":"Seunghwan is in charge of LINE OpenChat back-end development","imageURL":"/img/author-seunghwanjoo.jpeg","key":"seunghwanjoo","page":null}],"frontMatter":{"authors":["seunghwanjoo"],"other_languages":{"ko":"/blog/ko/2020/04/27/circuit-breakers-armeria"}},"unlisted":false,"prevItem":{"title":"Monitoring Prometheus metrics from Armeria","permalink":"/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria"},"nextItem":{"title":"Let\'s Play with Reactive Streams on Armeria - Part 2","permalink":"/blog/2020/07/03/reactive-streams-armeria-2"}}')},89198:(e,r,t)=>{t.d(r,{A:()=>i});const i=t.p+"assets/images/circuit-breakers-armeria-6-26bbfb46bbe9fbc038bbac6a0eb170c2.png"},90460:(e,r,t)=>{t.d(r,{A:()=>i});const i=t.p+"assets/images/circuit-breakers-armeria-4-a2545fecd5a4cb40a6c7f1e9bc606001.png"}}]);