---
date: 2020-07-07
---

# v0.99.8

## üåü New features

- You can now use [ClientRequestContext](type) to build a complex [RetryRule](type) and
  [CircuitBreakerRule](type). #2851
  ```java
  RetryRuleWithContent.<RpcResponse>builder()
                      .onServerErrorStatus()
                       // Now it's the BiPredicate that takes ctx as well.
                      .onException((ctx, ex) -> {
                          RpcRequest request = ctx.rpcRequest();
                          if (request != null &&
                              !safeMethods.contains(request.method())) {
                              return isRetryableException(throwable);
                          } else {
                              return false;
                          }
                      })
                      .thenBackoff(backoff);
  ```
- You can now run the gRPC server/client stubs generated by ScalaPB with Armeria. #2719
  - Please refer to the fully working [example](https://github.com/line/armeria/tree/main/examples/grpc-scala).
- You can now parse a response trailers from a response body for gRPC-Web using
  [GrpcWebUtil#parseTrailers(HttpData)](type). #2848
  ```java
  Clients.builder(...)
         .decorator(RetryingClient.newDecorator(
                 RetryRuleWithContent.onResponse(response -> {
                     return response.aggregate().thenApply(aggregated -> {
                        HttpHeaders trailers =
                                GrpcWebUtil.parseTrailers(aggregated.content());
                        // Retry if the 'grpc-status' is not equal to 0.
                        return trailers != null &&
                               trailers.getInt(GrpcHeaderNames.GRPC_STATUS) != 0;
                    });
                })))
        .build(MyGrpcStub.class);
  ```
- You can now access the metadata of [HttpFile](type) and [FileService](type) asynchronously. #1668 #2845
  ```java
  HttpFile httpFile = HttpFile.of(...);
  CompletableFuture<HttpFileAttributes> attrs =
          httpFile.readAttributes(CommonPools.blockingTaskExecutor());
  CompletableFuture<ResponseHeaders> headers =
          httpFile.readHeaders(CommonPools.blockingTaskExecutor());
  ```
- You can now easily customize [MeterIdPrefixFunction](type) using
  [MeterIdPrefixFunction#andThen(MeterIdPrefixFunctionCustomizer)](type). #2839
  ```java
  MeterIdPrefixFunction
          .ofDefault("hoge")
          .andThen((registry, log, id) -> id.withTags(
                  "grpc-status", log.responseTrailers().get("grpc-status")));
  ```
- Both synchronous and asynchronous APIs to select an [Endpoint](type) are added to
  [EndpointSelector](type) and thus [EndpointGroup](type) which is a sub-interface. #1910 #2837
  ```java
  ClientRequestContext ctx = ...
  EndpointGroup group = ...
  // synchronous selection!
  Endpoint endpoint = group.selectNow(ctx);
  // asynchronous selection!
  CompletableFuture<Endpoint> future =
          group.select(ctx, ctx.eventLoop(), 1000 /* timeout */ );
  ```
  - Thanks to this change, you can now avoid the [EmptyEndpointGroupException](type) at least
    for the case where the [Endpoint](typeplural) disappear temporarily.
- You can now get the snapshot status of circuit breakers from monitoring system. #2841

{/* truncate */}

## üìà Improvements

- You can now schedule a request timeout in nanoseconds. #2864
  - [ServiceRequestContext#setRequestTimeout(TimeoutMode,Duration)](type)
  - [ClientRequestContext#setResponseTimeout(TimeoutMode,Duration)](type)
- You can now see the error message by `ResourceLeakDetector` if the `DefaultClientFactory` is not closed
  properly. #2847
- The initial connection latency is lowered by giving up hopeless HTTP/1.1 connection early when
  HTTP/2 upgrade request fails. #2852

## üõ†Ô∏è Bug fixes

- Armeria server does not convert the `Host` header to `:authority` header anymore. #2846 #2850
  - [RequestHeaders#authority()](type) looks into `Host` header if `:authority` header is missing.
- [FileService](type) is not blocked by `ClassLoader` lock anymore. #1668 #2845
- You can retry when [DnsTimeoutException](type) is raised using [RetryRule#onUnprocessed()](type). #2836
- You no longer see `Http2Exception: failed to consume a HEADERS frame` error. #2832
- You no longer see `You tried to set the content preview twice` warning unless
  you really did apply content previewing decorator twice. #2830 #2832
- A non-base [WebClient](type) respects the user defined scheme correctly. #2835
- The specified port when building [EurekaUpdatingListener](type) and [ZooKeeperUpdatingListener](type)
  is used in the registration information of an Armeria server. #2826

## üèöÔ∏è Deprecations

- All Spring registration beans are deprecated. Use [ArmeriaServerConfigurator](type) and
  [DocServiceConfigurator](type) instead. #2787 #2838
  - Deprecated beans: `HttpServiceRegistrationBean`, `AnnotatedServiceRegistrationBean`,
    `GrpcServiceRegistrationBean` and `ThriftServiceRegistrationBean`
- `MeterIdPrefixFunctionFactory` has been deprecated in favor of [RequestLog#serviceName()](type). #2780 #2820
- `executor()`, `contextAwareExecutor()` and `contextAwareEventLoop()` methods in
  [RequestContext](type) are deprecated. #2834
- `on*(Predicate)` methods in the followings classes are deprecated. #2851
  - [RetryRule](type) and [RetryRuleBuilder](type)
  - [RetryRuleWithContent](type) and [RetryRuleWithContentBuilder](type)
  - [CircuitBreakerRule](type) and [CircuitBreakerRuleBuilder](type)
  - [CircuitBreakerRuleWithContent](type) and [CircuitBreakerRuleWithContentBuilder](type)
  - Use `on*(BiPredicate)` methods instead.
- `RequestLogBuilder.defer*Content*()` and `isDefer*Content*Set()` have been deprecated in favor of
  `defer(RequestLogProperty)` and `isDeferred(RequestLogProperty)`. #2832
- `MeterIdPrefixFunction.andThen(BiFunction<MeterRegistry, MeterIdPrefix, MeterIdPrefix>` is deprecated. #2839
- `UnprocessedRequestException(Throwable)` constructor is deprecated.
  Use [UnprocessedRequestException#of(Throwable)](type) instead. #2836

## ‚ò¢Ô∏è Breaking changes

- The names of various artifacts are changed. #2676 #2677 #2829 #2843
  - `armeria-dropwizard` is now `armeria-dropwizard2`.
  - `armeria-jetty` is now `armeria-jetty9`.
  - `armeria-rxjava` is now `armeria-rxjava3`.
    - `rxjava` package is renamed to `rxjava3`.
  - `armeria-spring-boot-actuator-autoconfigure` is now `armeria-spring-boot2-actuator-autoconfigure`.
  - `armeria-spring-boot-actuator-starter` is now `armeria-spring-boot2-actuator-starter`.
  - `armeria-spring-boot-autoconfigure` is now `armeria-spring-boot2-autoconfigure`.
  - `armeria-spring-boot-starter` is now `armeria-spring-boot2-starter`.
  - `armeria-spring-boot-webflux-autoconfigure` is now `armeria-spring-boot2-webflux-autoconfigure`.
  - `armeria-spring-boot-webflux-starter` is now `armeria-spring-boot2-webflux-starter`.
  - `armeria-testing-common` has been removed.
  - `armeria-testing-junit4` is now `armeria-junit4`.
  - `armeria-testing-junit` is now `armeria-junit5`.
    - `junit` package is renamed to `junit5`.
  - `armeria-thrift` is now `armeria-thrift0.13`.
  - `armeria-tomcat` is now `armeria-tomcat9`.
  - `armeria-zookeeper` is now `armeria-zookeeper3`.
- [RequestContext#eventLoop()](type) now returns [ContextAwareEventLoop](type) which always set the
  [RequestContext](type) before executing any submitted tasks. #2629 #2834
- The default logging level for successful requests and response has been changed. #2696 #2855
  - `INFO` to `DEBUG` for `Logging{Client,Service}.newDecorator()`
  - `TRACE` to `DEBUG` for `Logging{Client,Service}Builder`
- The APIs of [HttpFile](type) and [HttpVfs](type) have been changed. #1668 #2845 #2861
- [AggregatedHttpFile](type) does not extend [HttpFile](type) anymore. #2861
- [AbstractHttpFile#headers()](type) is now [AbstractHttpFile#additionalHeaders()](type). #2861
- [EndpointSelector](type) API has been changed. #2837  #1910
  - It is not a functional interface anymore.
  - `select()` has been renamed to [EndpointSelector#selectNow(ClientRequestContext)](type).
  - An asynchronous [EndpointSelector#select(ClientRequestContext,ScheduledExecutorService,long)](type)
    has been added.
- [UserClient](type) API has been changed. #2837
  - Its constructor requires more parameters.
  - `execute()` requires less parameters.
- `StreamMessage.drainAll()` and its variants have been removed. #2782 #2827
  - They are only used for unit tests and you can use `reactor.test.StepVerifier` instead.
- `UnprocessedRequestException(String, Throwable)` constructor has been removed without replacement. #2836
- Deprecated timeout APIs in `{Service,Client}RequestContext` have been removed. #2864
  - `extend{Request,Response}TimeoutMillis(long)` and `extend{Request,Response}Timeout(Duration)`
  - `set{Request,Response}TimeoutAfterMillis(long)` and `set{Request,Response}TimeoutAfter(Duration)`
  - `set{Request,Response}TimeoutAtMillis(long)` and `set{Request,Response}TimeoutAt(Duration)`

## ‚õì Dependencies

- gRPC-Java 1.30.1 ‚Üí 1.30.2
- Jackson 2.11.0 ‚Üí 2.11.1
- Kafka 1.1.1 ‚Üí 2.5.0
- Micrometer 1.5.1 ‚Üí 1.5.2
- Reactor 3.3.6 ‚Üí 3.3.7
- Shaded dependencies
  - Caffeine 2.8.4 ‚Üí 2.8.5
- Examples:
  - Dagger 2.28 ‚Üí 2.28.1
  - monix_reactive 3.2.2
  - ScalaPB 0.10.6
- Build:
  - Checkstyle 8.33 ‚Üí 8.34
  - Eureka 1.9.23 ‚Üí 1.9.25
  - Finagle ServerSets 20.5.0 ‚Üí 20.6.0
  - Gradle 6.5 ‚Üí 6.5.1
  - gRPC-Kotlin 0.1.3 ‚Üí 0.1.4

## üôá Thank you

<ThankYou
  usernames={[
    'anuraaga',
    'gary-lo',
    'heowc',
    'hexoul',
    'ikhoon',
    'jongmin92',
    'minwoox',
    'okue',
    'tobias-',
    'trustin',
  ]}
/>
