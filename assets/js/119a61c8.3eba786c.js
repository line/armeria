"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[7069],{25073:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>p,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"advanced/unit-testing","title":"Unit-testing Client and Service","description":"A unit test of a client or a service will require you to prepare two objects:","source":"@site/src/content/docs/advanced/unit-testing.mdx","sourceDirName":"advanced","slug":"/advanced/unit-testing","permalink":"/docs/advanced/unit-testing","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site-new/src/content/docs/advanced/unit-testing.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Collecting metrics","permalink":"/docs/advanced/metrics"},"next":{"title":"Production checklist","permalink":"/docs/advanced/production-checklist"}}');var i=n(74848),o=n(28453);const a={},s="Unit-testing Client and Service",c={},l=[{value:"Using a fake context to emulate an incoming request",id:"using-a-fake-context-to-emulate-an-incoming-request",level:2}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsxs)(t.h1,{id:"unit-testing-client-and-service",children:["Unit-testing ",(0,i.jsx)(t.code,{children:"Client"})," and ",(0,i.jsx)(t.code,{children:"Service"})]})}),"\n",(0,i.jsx)(t.p,{children:"A unit test of a client or a service will require you to prepare two objects:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientRequestContext.html",children:"ClientRequestContext"})," or ",(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"})]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpRequest.html",children:"HttpRequest"})," or ",(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/RpcRequest.html",children:"RpcRequest"})]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientRequestContext.html",children:"ClientRequestContext"})," or ",(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"})," is a more complex object with many properties than\n",(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpRequest.html",children:"HttpRequest"})," or ",(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/RpcRequest.html",children:"RpcRequest"}),", and thus Armeria provides the API dedicated to building a fake context\nobject easily:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-java",children:'import org.junit.jupiter.api.BeforeEach;\nimport org.junit.jupiter.api.Test;\n\nimport com.linecorp.armeria.common.HttpRequest;\nimport com.linecorp.armeria.common.HttpResponse;\nimport com.linecorp.armeria.common.AggregatedHttpResponse;\nimport com.linecorp.armeria.client.ClientRequestContext;\nimport com.linecorp.armeria.server.ServiceRequestContext;\n\nclass MyJUnit5Test {\n\n    private MyClient client;\n    private MyService service;\n\n    @BeforeEach\n    void setUp() {\n        client = ...;\n        service = ...;\n    }\n\n    @Test\n    void testClient() {\n        // Given\n        HttpRequest req = HttpRequest.of(HttpMethod.GET, "/greet?name=foo");\n        ClientRequestContext cctx = ClientRequestContext.of(req);\n\n        // When\n        HttpResponse res = client.execute(cctx, req);\n\n        // Then\n        AggregatedHttpResponse aggregatedRes = res.aggregate().join();\n        assertEquals(200, aggregatedRes.status().code());\n    }\n\n    @Test\n    void testService() {\n        // Given\n        HttpRequest req = HttpRequest.of(HttpMethod.POST, "/greet",\n                                         MediaType.JSON_UTF_8,\n                                         "{ \\"name\\": \\"foo\\" }");\n        ServiceRequestContext sctx = ServiceRequestContext.of(req);\n\n        // When\n        HttpResponse res = service.serve(sctx, req);\n\n        // Then\n        AggregatedHttpResponse aggregatedRes = res.aggregate().join();\n        assertEquals(200, aggregatedRes.status().code());\n    }\n}\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Although the fake context returned by ",(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientRequestContext.html#of(com.linecorp.armeria.common.HttpRequest)",children:"ClientRequestContext#of(HttpRequest)"})," and\n",(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html#of(com.linecorp.armeria.common.HttpRequest)",children:"ServiceRequestContext#of(HttpRequest)"})," will provide sensible defaults,\nyou can override its default properties using a builder:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-java",children:'import java.net.InetAddress;\nimport java.net.InetSocketAddress;\nimport java.util.Map;\n\nimport com.linecorp.armeria.common.SessionProtocol;\nimport com.linecorp.armeria.client.ClientRequestContext;\nimport com.linecorp.armeria.server.RoutingResult;\nimport com.linecorp.armeria.server.ServiceRequestContext;\n\nHttpRequest req = HttpRequest.of(...);\n\nClientRequestContext cctx =\n        ClientRequestContext.builder(req)\n                            .sessionProtocol(SessionProtocol.H1C)\n                            .remoteAddress(new InetSocketAddress("192.168.0.2", 443))\n                            .build();\n\nRoutingResult routingResult =\n        RoutingResult.builder()\n                     .path("/mapped/path")                       // Mapped path\n                     .query("foo=bar&baz=qux")                   // Query string\n                     .pathParams(Map.of("pathParam1", "value1",  // Path parameters\n                                        "pathParam2", "value2"))\n                     .build();\n\nServiceRequestContext sctx =\n        ServiceRequestContext.builder(req)\n                             .clientAddress(InetAddress.getByName("192.168.1.2"))\n                             .routingResult(routingResult);\n                             .build();\n'})}),"\n",(0,i.jsx)(t.h2,{id:"using-a-fake-context-to-emulate-an-incoming-request",children:"Using a fake context to emulate an incoming request"}),"\n",(0,i.jsx)(t.p,{children:"It is usually not necessary to build a context object by yourself except when writing a unit test,\nbecause Armeria will always create a context object for you. However, you may need to build a fake context and\ninvoke your request processing pipeline with it when you want to handle the requests received via other sources\nsuch as:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Non-Armeria services"}),"\n",(0,i.jsx)(t.li,{children:"Non-HTTP protocols, e.g. Kafka and STOMP"}),"\n",(0,i.jsx)(t.li,{children:"Timers, i.e. Trigger a certain request every N minutes."}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"The following example shows how to emit a fake request every minute:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-java",children:'import java.util.concurrent.ScheduledExecutorService;\nimport java.util.concurrent.TimeUnit;\n\nimport com.linecorp.armeria.server.HttpService;\n\nScheduledExecutorService executor = ...;\nHttpService sessionManagementService = (ctx, req) -> ...;\n\n// Send a session expiration request to the session management service\n// every minute.\nexecutor.scheduleWithFixedDelay(() -> {\n    HttpRequest req = HttpRequest.of(HttpMethod.POST, "/expire_stall_sessions");\n    ServiceRequestContext ctx = ServiceRequestContext.of(req);\n    try {\n        HttpResponse res = sessionManagementService.serve(ctx, req);\n        AggregatedHttpResponse aggregatedRes = res.aggregate().get();\n        if (aggregatedRes.status().code() != 200) {\n            System.err.println("Failed to expire stall sessions: " +\n                               aggregatedRes);\n        }\n    } catch (Exception e) {\n        e.printStackTrace();\n    }\n}, 1, 1, TimeUnit.MINUTES);\n'})})]})}function p(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>s});var r=n(96540);const i={},o=r.createContext(i);function a(e){const t=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(o.Provider,{value:t},e.children)}}}]);