<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-blog-ja" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">RxJava 2とArmeriaでマイクロサービスを非同期化してみた | Armeria</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://armeria.dev/img/og-image.png"><meta data-rh="true" name="twitter:image" content="https://armeria.dev/img/og-image.png"><meta data-rh="true" property="og:url" content="https://armeria.dev/blog/ja/2017/12/01/asynchronous-micro-service-in-rxjava-2-armeria"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="og:site_name" content="Armeria - Your go-to microservice framework"><meta data-rh="true" name="og:type" content="website"><meta data-rh="true" name="og:image:width" content="1280"><meta data-rh="true" name="og:image:height" content="640"><meta data-rh="true" name="twitter:site" content="@armeria_project"><meta data-rh="true" name="twitter:creator" content="@armeria_project"><meta data-rh="true" property="og:title" content="RxJava 2とArmeriaでマイクロサービスを非同期化してみた | Armeria"><meta data-rh="true" name="description" content="こんにちは、LINEメッセンジャーのサーバーサイド開発チームに所属してスタンプや着せかえに関連する開発を担当している川田（@hktechno）です。この記事はLINE Advent Calendar 2017の2日目の記事です。"><meta data-rh="true" property="og:description" content="こんにちは、LINEメッセンジャーのサーバーサイド開発チームに所属してスタンプや着せかえに関連する開発を担当している川田（@hktechno）です。この記事はLINE Advent Calendar 2017の2日目の記事です。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2017-12-01T00:00:00.000Z"><link data-rh="true" rel="icon" href="/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://armeria.dev/blog/ja/2017/12/01/asynchronous-micro-service-in-rxjava-2-armeria"><link data-rh="true" rel="alternate" href="https://armeria.dev/blog/ja/2017/12/01/asynchronous-micro-service-in-rxjava-2-armeria" hreflang="en"><link data-rh="true" rel="alternate" href="https://armeria.dev/blog/ja/2017/12/01/asynchronous-micro-service-in-rxjava-2-armeria" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://armeria.dev/blog/ja/2017/12/01/asynchronous-micro-service-in-rxjava-2-armeria","mainEntityOfPage":"https://armeria.dev/blog/ja/2017/12/01/asynchronous-micro-service-in-rxjava-2-armeria","url":"https://armeria.dev/blog/ja/2017/12/01/asynchronous-micro-service-in-rxjava-2-armeria","headline":"RxJava 2とArmeriaでマイクロサービスを非同期化してみた","name":"RxJava 2とArmeriaでマイクロサービスを非同期化してみた","description":"こんにちは、LINEメッセンジャーのサーバーサイド開発チームに所属してスタンプや着せかえに関連する開発を担当している川田（@hktechno）です。この記事はLINE Advent Calendar 2017の2日目の記事です。","datePublished":"2017-12-01T00:00:00.000Z","author":{"@type":"Person","name":"Hirotaka Kawata","description":"LINE Engineer","image":"/img/author-hirotakakawata.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://armeria.dev/blog/ja","name":"Armeria Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="Armeria Newsletter RSS Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CY9YHLJ0K6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-CY9YHLJ0K6",{anonymize_ip:!0})</script>





<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Armeria Blog RSS Feed">
<link rel="alternate" type="application/rss+xml" href="/blog/ja/rss.xml" title="Armeria Blog - Japanese RSS Feed">
<link rel="alternate" type="application/rss+xml" href="/blog/ko/rss.xml" title="Armeria Blog - Korean RSS Feed">

<link rel="manifest" href="/manifest.json">


<link rel="alternate" type="application/rss+xml" href="/release-notes/rss.xml" title="Armeria Release Notes RSS Feed">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Armeria RSS Feed"><link rel="stylesheet" href="/assets/css/styles.4999cde9.css">
<script src="/assets/js/runtime~main.22ee5cc3.js" defer="defer"></script>
<script src="/assets/js/main.fb373ee4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/armeria_logo_horiz.svg"><link rel="preload" as="image" href="/img/author-hirotakakawata.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/armeria_logo_horiz.svg" alt="Armeria Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/armeria_logo_horiz.svg" alt="Armeria Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">News</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/news/20231208-newsletter-6">Newsletter</a></li><li><a class="dropdown__link" href="/release-notes/1.34.1">Release notes</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/">Documentation</a><a class="navbar__item navbar__link" href="/community/">Community</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/line/armeria" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><a class="navbar__item navbar__link header-discord-link" aria-label="Discord" href="/s/discord"></a><a href="https://x.com/armeria_project" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-x-link" aria-label="X"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS darkNavbarColorModeToggle_X3D1" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md"> </div><button type="button" class="ant-btn css-198drv2 ant-btn-default ant-btn-color-default ant-btn-variant-outlined ant-btn-lg ant-dropdown-trigger blogLanguageSelector__AnM"><a href="/blog">English</a><span role="img" aria-label="down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></span></button><div role="group"><h3 class="yearGroupHeading_rMGB">2020</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ja/2020/03/26/reactive-streams-armeria-2">Let’s play Reactive Streams with Armeria vol.2</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ja/2020/03/26/reactive-streams-armeria-1">Let’s play Reactive Streams with Armeria vol.1</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ja/2020/01/14/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019">Devoxx Belgiumで学んだ方法でKubernetes上のSpring Bootをモニタリングする</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2019</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ja/2019/06/21/armeria-sprint-1">GitHub Contributions グラフを緑豊かにしてみましょう(feat. Armeria Sprint)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ja/2019/05/23/thank-you-for-contributing-to-armeria">オープンソース「Armeria」のコントリビュータのためのイベントを開催しました</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2017</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/ja/2017/12/01/asynchronous-micro-service-in-rxjava-2-armeria">RxJava 2とArmeriaでマイクロサービスを非同期化してみた</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2016</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ja/2016/08/04/applying-circuitbreaker-to-channel-gateway">チャネルゲートウェイへのCircuitBreakerの適用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ja/2016/07/14/circuit-breakers-for-distributed-services">分散サービス環境へのCircuit Breakerの適用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ja/2016/04/13/open-sourcing-armeria">社内プロジェクト「Armeria」をオープンソース化するために行った６つのステップ</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">RxJava 2とArmeriaでマイクロサービスを非同期化してみた</h1><div class="container_mt6G margin-vert--md"><time datetime="2017-12-01T00:00:00.000Z">December 1, 2017</time> · <!-- -->28 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><img class="avatar__photo authorImage_XqGP" src="/img/author-hirotakakawata.png" alt="Hirotaka Kawata"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp" translate="no">Hirotaka Kawata</span></div><small class="authorTitle_nd0D" title="LINE Engineer">LINE Engineer</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>こんにちは、LINEメッセンジャーのサーバーサイド開発チームに所属してスタンプや着せかえに関連する開発を担当している川田（@hktechno）です。この記事は<a href="https://engineering.linecorp.com/ja/blog/detail/210" target="_blank" rel="noopener noreferrer" class="">LINE Advent Calendar 2017</a>の2日目の記事です。</p>
<p>私が所属しているチームは、数年前からマイクロサービス化されたサービスのRPC（Remote Procedure Call）やDBアクセスを非同期化し、レイテンシの削減やサーバーリソースの省力化に勤しんできました。最近は、LINE内部で開発しているRPCサーバー<a href="http://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a>と<a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener noreferrer" class="">RxJava 2</a>を使って、“Javaにしては”なかなかイケている内部構成になってきました。この記事では、そんな私達のチームで開発しているスタンプ・着せかえ関連サーバーの裏側についてご紹介したいと思います。</p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="line-shopにおけるマイクロサービス">LINE Shopにおけるマイクロサービス<a href="#line-shopにおけるマイクロサービス" class="hash-link" aria-label="Direct link to LINE Shopにおけるマイクロサービス" title="Direct link to LINE Shopにおけるマイクロサービス" translate="no">​</a></h2>
<p>一言でLINEといっても、LINEと名前のつくサービスはたくさんありますが、私達のチームでは、LINEメッセンジャー内で使えるデジタルコンテンツのうち、主にスタンプと着せかえを提供するシステムを開発していて、それらのシステムやチーム全体のことをLINE Shopと呼んでいます。LINE Shopのシステムでは、ショップ向けのAPI提供はもちろん、<a href="https://store.line.me" target="_blank" rel="noopener noreferrer" class="">LINE STORE</a>というサイトや、メッセージを実際にやり取りするサーバーと連携するサービスなど、複数のサービスを管理しています。</p>
<p>マイクロサービスという言葉が流行り始めてからもう数年が過ぎますが、LINEでは早くからマイクロサービスアーキテクチャを取り入れていて、スタンプショップや着せかえショップの内部も細かいサービスに切り出されています。例えば、スタンプメッセージをやり取りする際に必要なバリデーションなどは、LINEの根幹となるメッセージ送信サーバーでは行なわず、マイクロサービスとして切り出して私達のチームで管理していますし、<a href="https://engineering.linecorp.com/ja/blog/detail/99" target="_blank" rel="noopener noreferrer" class="">昨年のAdvent Calendar</a>で紹介したように、ショップ向けの検索やランキングリスト向けのCache＋Queryを行うサーバーは別なサーバーとして動作しています。</p>
<p><img decoding="async" loading="lazy" alt="LINE Shop Architecture" src="/assets/images/asynchronous-micro-service-in-rxjava-2-armeria-1-c21f929f375484f08ce8cdfdc2105dfc.png" width="766" height="508" class="img_ev3q"> &#x27;LINE Shopのアーキテクチャ（かなり簡略化されています）&#x27;</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="マイクロサービス化した場合に問題になりそうなこと">マイクロサービス化した場合に問題になりそうなこと<a href="#マイクロサービス化した場合に問題になりそうなこと" class="hash-link" aria-label="Direct link to マイクロサービス化した場合に問題になりそうなこと" title="Direct link to マイクロサービス化した場合に問題になりそうなこと" translate="no">​</a></h3>
<p>マイクロサービスを増やしていくと、それぞれのサービスがAPIによって接続され、たくさんのRPC（Remote Procedure Call）を行うようになります。しかし、RPCを1つのリクエスト内部でたくさん行う場合は、考えなければいけないことがいくつかあります。そのうちの1つが、RPCを行うためにかかるレイテンシが、逐次的に実行した場合に意外と大きくなってしまうことです。</p>
<p>例えば、あるRPCで1回あたりのレイテンシが10msかかる状況では、100回RPCを行うときに同期的なAPIで100回呼び出すと、1000msかかります。さらに、以下のような状況を考えてみてください。</p>
<ul>
<li class="">Aを100回取得する（10ms）。</li>
<li class="">それぞれのA.idを使ってBとCを取得する（B 10ms、C 10ms）。</li>
<li class="">すべてのデータ（A、B、C）を利用してDを作成してレスポンスを返す。</li>
</ul>
<p>このように逐次的にDを100個取得するような状況では、レスポンスまで3000msかかってしまう可能性があります。マイクロサービス化したりDBクエリを実行したりする際に、このような設計にするべきではありませんが、それぞれをキャッシュできる場合などはこうしたほうが良い場合も多いでしょう。</p>
<p>今回はマイクロサービスのRPCを例としましたが、DBアクセスでも同様の状況になることが考えられます。マイクロサービス化されたサービス間のRPCの場合には、それぞれが担っている領域が違うために、DBのクエリレベルで最適化されたものでないことが普通でしょう。例えば、認証、プロダクト情報、ユーザーの所有権などが複雑に絡み合い、全く違うDB・サービスとして提供されているような状況を考えてみてください。</p>
<p>このような場合、よくRPCやDBアクセスを何らかの方法で並列化すると思います。RPCを行うためにスレッドを作って並列化することで、それぞれの段階を並列化することができます。上記の例では、理論上最短でレイテンシを20msに短縮することができます。Javaであれば、通常ThreadPoolExecutorを利用するのではないでしょうか。その他の言語であっても、最近では簡単にマルチスレッドでプログラムを実行することができるようになっています。</p>
<p><img decoding="async" loading="lazy" alt="Sync API" src="data:image/png;base64,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" width="906" height="230" class="img_ev3q"> &#x27;同期API＋スレッドプール&#x27;</p>
<p>スレッドプールを利用した例</p>
<p>これで、めでたしめでたし、となるとよいのですが、実際のところはそう簡単に物事は進みません。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="同期的synchronousapiとスレッドプール">同期的（Synchronous）APIとスレッドプール<a href="#同期的synchronousapiとスレッドプール" class="hash-link" aria-label="Direct link to 同期的（Synchronous）APIとスレッドプール" title="Direct link to 同期的（Synchronous）APIとスレッドプール" translate="no">​</a></h3>
<p>RPCを行う際の同期的なAPIの問題点は何でしょうか。それは、RPCの結果を取得するまで、他の処理を実行できないことです。前述のように、スレッドプールを利用して、RPCやDBに対して同期的なAPIを使って並列にリクエストを行った場合、利用するスレッドはそのレスポンスが返ってくるまで、その1つのリクエストに専有されてしまいます。C10K問題という単語を聞いたことがある方もいるかと思いますが、だいたいあれと同じことです。</p>
<p>例えば、以下の状況を考えてみましょう。</p>
<ul>
<li class="">API AはAPI Bを100回呼び出す。</li>
<li class="">API Bは1回あたり100msでレスポンスを返す。</li>
<li class="">API Aは平均で毎秒1000回呼び出される。</li>
</ul>
<p>この場合、1秒間に生成されるジョブの数は1000 × 100 = 100,000です。それぞれの処理に100msかかるのであれば、スレッドプールの最大生成スレッド数が1,000であった場合に、計算上は遅延せずに処理できることになります。そうでない場合には、処理が遅延していくことになりますし、そうでなかったとしても、API Aのレスポンスにかかる時間は通常100msより長くなります。</p>
<p>このような状況は、普段は問題にならないかもしれません。しかし、リクエストが集中して高負荷になったときに、DBやアクセス先のサーバーはまだ処理できる状態であっても、RPCをたくさん受け付けているサーバーがスレッドプールの限界を迎えたり、逆にそのサーバーのCPUは余裕があるのにDBのレイテンシが悪化して、スレッドプールが限界を迎えたりすることがあります。つまり、スレッドプールを使うと、リソースが限界に近いときに、RPCやDBのレイテンシに敏感なサーバーになってしまうことになります。</p>
<p>以下は、<a href="https://github.com/openzipkin/zipkin" target="_blank" rel="noopener noreferrer" class="">Zipkin</a>を利用して、DBやそれぞれのマイクロサービスをまたいで、LINE Shop内部のサーバーのリクエストの流れを可視化した図です。この例は、購入済み商品の一覧を取得する、実際に動作しているAPIの内部フローです。1つのAPIリクエストで、3つのマイクロサービスを経由して、MongoDBとRedis Cacheに複数回アクセスしていることがわかります。この例では画像の縦サイズの都合上、DBへのアクセスはそれほど多くありませんが、それでも、同期的APIを利用した場合は1リクエストあたり多くのスレッドが必要であることがわかると思います。</p>
<p><img decoding="async" loading="lazy" alt="Armeria Zipkin Integration" src="/assets/images/asynchronous-micro-service-in-rxjava-2-armeria-3-2bbc59d51090b480b7b10614f6c83ef7.png" width="2704" height="1730" class="img_ev3q"> &#x27;Armeria Zipkin Integration&#x27;</p>
<p>もっとたくさんスレッドを作ればいいじゃないかと思うかもしれませんが、スレッドをたくさん作る事自体がコストになりますし、スレッドプールを使ったとしてもその数を大きくしすぎると、コンテキストスイッチのコストが大きく効率的ではありません。通常は私達のチームでは、1つのスレッドプールの上限は多くても1000程度に設定しています。</p>
<p>RPCやDBへのアクセスは、ただリクエストを投げてそれが返ってくるまで待つだけなので、基本的に他に何も処理するべきことはありません。つまり、何らかのデータをほぼ右から左に流すだけの処理です。しかし、CPUに余裕があっても、外部のリクエスト数が多くレイテンシがそれなりにかかる場合は、スレッドプールの限界を迎えてしまい、結果的にサーバーを増やすしかなくなってしまいます。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="非同期asynchronousapi">非同期（Asynchronous）API<a href="#非同期asynchronousapi" class="hash-link" aria-label="Direct link to 非同期（Asynchronous）API" title="Direct link to 非同期（Asynchronous）API" translate="no">​</a></h2>
<p>上記のような、同期的なAPIとスレッドプールの組み合わせにより発生する問題を解決するために、非同期（Asynchronous、Async）なAPIを利用します。長々と前置きをしてきましたが、非同期APIを利用するのは、右から左に流すだけの処理をなるべく並列化して効率的に行いたいからです。</p>
<p>マイクロサービスのアーキテクチャでは、ユーザーからAPIリクエストを受けるような上位に位置するサービスは、ほとんどの場合、ただ右から左にリクエストを流したり、複数のRPCのレスポンスを結合したりするだけです。また、その他のサービス内部でも、多くの場合、DBはCPUやメモリをたくさん使って処理を行いますが、それをリクエストするアプリケーションサーバーは、ただレスポンスを受けてデータを変換したりするだけだったりするでしょう。</p>
<p>特に、LINE Shopで管理しているサービスでは、<a href="https://store.line.me" target="_blank" rel="noopener noreferrer" class="">LINE STORE</a>を提供しているサーバー以外で、サーバーサイドでテンプレートエンジンを利用したHTMLレンダリングを行っていません。多くの場合、CPUリソースを消費するような処理は、ほとんど行われません。一番CPUを食うのは、JSONや、その他RPCやキャッシュのために利用するプロトコルのための、シリアライズやデシリアライズだったりするのではないでしょうか。</p>
<p>このようなサービスのために、たくさんのサーバーを使いたくないですし、なるべくたくさんのリクエストを同時に、かつ効率的に、できれば、そのマシンが耐えうるネットワーク帯域幅の限界まで処理を受け付けられるようにしたいのです。マイクロサービス化すると、必然的にそれぞれのサービスでやることは分散され小さくなるので、いかに多くのリクエストをそれぞれのサーバーで処理できるかが、無駄なリソースを減らすために重要になってきます。</p>
<p><img decoding="async" loading="lazy" alt="Async API" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA2IAAADXCAAAAABdK70VAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAAGJsAABibAUl1g5QAAAAHdElNRQfhCxwCAjhlY7XDAAAXN0lEQVR42u2dTYvkSHqA+z/F1Wf9A6ObjwmCPbihGWzBLltn/QKp+9SwIGifumxi1wxzEY0ZKJCpnYstaFgoTRuK1mEOollVI8cboa9UKjMlZXyl8n2YqVLpo95QdDylUKT0xqsaQRCFvDJdAATZNqgYgigFFUMQpaBiCKIUVAxBlIKKIYhSVCn2fL+zlPtn03WO3BRqFHu+My3SKe5QMkQfahRjht09PlvJI5TNdK0jN4QSxZ53uyfTJ3acp90OL2OINpQodm/3deJud2+6CMjtoESx3e7R9Hmd4nG3ezFdBuRmUKSY1T2xF8vLh2yKW1TM+vIhWwIVQxCloGIIohRUDEGUgoohiFKsUKzM81LnSaNiiD4sUCzxCMPJVgZL2cGpyvIhyCWYVyxnirgu+xKvCwaCBgrLhyAXYV6xgJC8rjMmSgU/Filfm+cF9B/ZV1iX5web2sNLJmhzqJryIchFmFfMIQ54lIJNFXQa3ZT9SIgfdPI4xD3Y1B5OmaGEJOrKhyAXYV4x5oiTNqMdEbuWMZN88MiBviO/zcqgEzne1B7uEo/1FT115UOQizCvWEn4aEdU8EWvhJursoYbrLxiKyIuXnmwqTm6gCtYAqtVlQ9BLsK8YnUZu9wyCiMfPqUBXLrYzzDE6BEH+onexCZBDHaVC8dKUDFEHxYoxihTuNHi4++Nbc3oB7s+5RlcqA43CVif0fd9OFhl+RBkNeYVK3inr2KOpQV0AYES1IGNcH2KQKnDTZysNY/k8yOiYohGjCuW8CGMumZXoqJ2YZk/6+E3HgXwmRl87HW4CWD6xZTSmN+zKSkfglyGccVKdlFyYyoGC5kqfsJH8VuPeAcRbr0ONzGqtofowj2bkvIhyGUYV6wufdHTc1lXrwhIo1TrUQWjjbBwuKnmAopxjnjRQ1SoGKIP84oxUSj1o+ZeqqQB/5CMres2Zkc2sVsxSstmG13wjCMqhujDBsW0Y3v5kC2BiiGIUlAxBFEKKoYgSkHFEEQpqBiCKAUVQxCloGIIohRUDEGUcouK4bQRiEZw8iMEUQpO4YcgSsGJaBFEKQqnU7eyM/aC06kjelGj2DNrx/ZyhxcxRB9qFGOS3a9s/2G4ft0s7lEwRCeqFGNdsudVhOH6dXOwsvuKbBh1iq0kDNevQxD7QMUQRCmoGIIoBRVDEKWgYgiiFFQMQZSCiiGIUlAxBFEKKoYgSkHFEEQpqBiCKAUVQxCloGIIohRUDEGUgoohiFJQsSsmp3Mnkc+bqQ4R/aBi0iEt9MyORdEd4s/+7Xn360lOz4ZooWSujIhsUDHpEMcXpGd29DqxFihWwG8mBL4WqNg1gIpJ55gvRdUvjnbcO6SYWKr3+3nNhPJcsWJvS92pVBWDX4OKmQMVk07vS0Ii+BaTuK4SlxC3gI4eLXziJqLHR8eHlGw/l984dUtMpNwj0VCyXjG2xc9gKfWYRSVlUTw+57xHiMOPyX3i5aiYOVAx6fS+VMSBby4p2f9BEhOnZGa5Do0dUpURMygfHVI5zD7WD6wGS5Q4DmVLg8tVp5jrJpHj8CXHLytC4jSAoJXjJKnP1K4zQiLqOKiYMVAx6TBzBHUdQMsuiMf+D2q4qsVw8argwpaypcOOorjuUZINliiYWafD+65esVoEofy3piSpxe9OfVgC2QL2E3MdFTOGTYplQBjyb+26BAhD/q06sZ9FdCN+0OZj0eQpSfI8T5lKOZcNhJlSzAch2JZosET5VnFcF4J/o42GtFmKSMqiUAgKR+TQd/T41c9HxYxhk2Ifwo4P7bp3/bp3p/aziOHYheNCP7FiTVwAisHVKD+qGO8OsqtTv9Qow69Y7f6D4Y5GMVhyuihV0IzrN7vGqJgxbFLsr706f23XfezXfTy1n0UMFYtIUcAFxudXMcYZxXjPsi6ZTv2SuEJVrLvZhzimWMaDFCwuW6zhDswl/e9FTGCTYmWvTjd89rlf9/nUfhYxVCwnccxup1iTp92aU4qJuynY0i+1HcV4EGJaMZ+0HWcXupkFXMWEXC4qZgybFOt7gIP+X6/T6f3sYe9DLpdRgzpuWZcBH6vvFfMODimJX0Ivjw6WKJhSxfzerN1/WjFKgqoufBfuwKK6ZJeyCIZNKhYeFTOGVYo9tOo89Os+HvQTp/ezh+7pDvAmJuLqw+6N2H9eNVCMXXTaB0DaQ+ByR3y+X7/ErmKO74iPu9oQ04pVvjgGRiaJRxwWPCld4rgEr2LmsEqxr606X/t1nw/6idP72YPvDxQrfV+oUVLXhw+SC64V/5p3z1gND4jdSHwC1i4xfSrqpvsh+LeUHw9f0+Y3sWMCyvysUs+Li5rC6tT1k9RHxUxhlWL1e2HO++G6w37i9H6bZf6TiIiN2KXYw0T/78PEbdeDxf1E6aBi141din2d6P/9Itb9cm6/zYKKXTd2KSZ6gPv9v0roVJ3bb7PMf/ESsRHLFHuY6P99mBief7idfiJy5Vim2BdQ58v+ul8O+onT+yGIjVim2HdQ5/v+uuqwnzi5H4LYiGWK1Z/C8NN43Z/C8E9z9kMQC1mp2Mvj3U4Jr8Pw9XjdH8LwD3P2k8Pd44vpfxRkS6xT7F5N6wbCcMK71/P2k8W96X8VZEOsUiyDZvj0rIQff5S731Ke4M+HjW96IlfKKsXe7t4q60x9mTlOOHe/5byw01P1u5HbY41i31T+mf/73+XutwJ2kf6m7Jcjt8YaxX7evTFdbLW82f1kugjIZlin2MY7Uj9t/QQRjaBit3iCiEZQsVs8QUQjqNgtniCiEVTsFk8Q0QgqdosniGgEFbvFE0Q0YkqxfrLH87PXlfDab35+1klpoGKIPK5BsRjkQsWQ68SgYpHI8l6UeQ6pBivIxc5Ied5B9lNVFzAZS5W7bNdypFiW5qNF9muqKpOS5gIVQ+RhULE+y3szHxCJ6yJy2HVN9AsTjxAxIRdMJzlUrIhdtsrN+aLTLFK2MxEHXwoqhsjDAsVql+ePDggpKuaLw/6H+e2IQ0CksvCZQn46OsBl/8PMdk6zCHmp2Tew8vKpJFAxRB7m78VyyPueQZ52D1Kxx1UOS6AYn/wxhi3792IFX6QwKULGF3nieMoTwIvfdSGoGCIPGxQrGlkSuJJFFKYEh+0+l8k/VCzm8x7zbRG/aPGdKfwCWIwvKpisE0QQgfnhjqquPeKCLP1kkqQd3ZhUTHQs2WoH+oli0RNzBMGsxueHKHWcoByeFaZw2O3uF70Wp7Yskk/Kooqz4V4M+oeFA2MeMFuP8O6UYj6/dJWwzeXTiBfNVSzd2FXsSVEOop63s9uK+rJIPCmbKs4OxUqYDQvuoXKuScHnax0qFu0dEPB9MxiI9PliSvis47BbSoZT3a3EFsXuIB+WmhQlwM9vFmQCUlwWuSdlU8WZVMztJ9WCDqIDqx3i0EDMOt4r5sCYfX9AAfdxNOK3cTAqwhcLPqIYxFsaUXza7Z7URvhpdgoF9WWReVIWVZwNwx1wM5WSpn+Xwjg9cas9xbLmc7FufCQRe8FkyFQspuJzMRi+l/AMiCWK3e/uFEd4mZ1CQX1ZZJ6URRVnTrGSdrCfKvatufjkUZxVfDt8hkxpyr4m7If+gFLsVdTdAXwRhjvY76mWl0XJCUpgt3tUHeLn3Zt5ucQ0lEXiSVlUcVt60p7KmzLckhPc7Z5Vh3iZG0NDWfSflJ4YqJi9J6ijWW9RMasqDhWz+QRtaimo2OoY21Gs5J9iS8GSE7SppaBiq2NsRzGJWHKCNrUUVGx1DFTM3hO0qaWgYqtjoGL2nuDEv2LzUKfSGBftZwXDwkqvscUVgorZe4IT/4rNp+9euqrVFIcPvmxesctqTEaFoGL2nuCUYi58+B7wxzGXM/Hky/YVu6jGZFQIKjaBJdNGTCkm3tQpxROddZm2naC0rKu8rEv+s/jaby344y9lRqKDPtP2FTtSY6JOeFWVabNvKS51sK5K93YbHrm0QnDyowksmfzouGK1D58B5vD8swMveacucWhGaE35Z4N0b2vpi0RfVDzgeTbG3LLYy4Rioxpr64RVSkod/oxrnQfwIHnGqy9x+EOz3W6Dul5cIdZN4WcBtkzhd1yxyiEVvH2aQFso6xwE88meYv3WhERFERFaJjd8FRvVWFsn8HfHTWnz0kaU8xeD2Y9+lsIB3W79kcsrxLqJaM1jzUS0U4p5MEKWevD+agaJFFgrgLQl8CfP21Os3xrwpaxgjegW78Uma6yrE0q8Gt70SJpVUJWUuGwpImm/W3/k8gpZP536FVX5Ep7tmU79+IgiiUreBqDxsD/TARcrGCiWDrbCi+C8f3ibik3WWFcnlCcYzPnbvTlfgr9YEd9C+936I5dXyCrF6uvI4rCa+W+0amspbYNxKf23f1F67t/mlsVeDkYUAy7S8z8ZqLi1itUvjxpTObwJwz/qi3b3aEsnePJezFBaiutVjF94XJIZy+exUjHGb9rSMfxHGH7QFuw30+1juqV0DcZQWoorVywnzh9N5fNYr5g2voeM76ZLYYApxX4wlJbiyhWro38wls/jChT7Aop9MV0KA0wp9s+G0lJcu2LVPxrL53EFin0CxT6ZLoUBJpo1NZWW4moV48lfapOJUOxXjPcTb7KnONWsTaWluFrFNJ7AkXwe9iv2RSh2gz1FU00dFZMY9xoU+yQUu8Geok0tBRVbGfcaFHsvFHtvuhz6samloGIr416BYl/Dhq+mS6Idm1oKKrYy7hUo9tAq9mC6JNqxqaWgYivjXoFi71vFbq+nOLOlaMnnobyFxpdPCzf7BPTm87Bdsa6feIM9xZlNXUs+DymKVXw2uLp5R6Qu+EsjDT5h2yU1/HMnoDefh+2KPfSK3VxPca5iOvJ5yLmK+WIi7mYmUzqebTGXlM/5rGJa83nYrtiHXrEPpsuim7mK6cjnIUcx8U5jRlw+fTB/Q6vKxLWkyOsiIokUx84qpjWfh+2KZYz/DMNP8P3WHvCYeubHVD4POYqV/B3jmPDXtCto4QHvsVW8o+g3s80przi9+TxsVwx4d4NXMGBq2jxT+TwkDXe4kP3CcytoqxkJ2P9+wZpxyhUrPGlXsdMVpzefxxUo9vkmxzrq6clfTeXzkKRYzGwq2S2Q54nllBYw7OGJ4Q5f2r3Y6YrTm8/DdsWqh3fNndjfbq2f2Exhvv/wtql8HpIUY7d+rO1mTK+S6V/BIGKeUEKkK3ay4vTm81iv2K8fQ01AR1FXrAeL3nquJ9+FN5PPQ9bnYo7DtK+Yaim/L8scmKlbvmK/P1lxevN5rFXs13e6Gv3HX+swrH97uPw3zeODTZI9HyYiMpPPQ5ZiASkc6IaRKIXrpwueFfIVez5ZcXrzeaxVjBn27uFXDcC9OFOsrr//poG/fbBtaOVlP0WEqXweshRLScxvXnwnIgW7LYPOYqJAsZMVpzefx0rFfg3Dz1JqYxZcMU18DUObLmNjjOXzkKQYk4qPw1DiwPiBA/dmLnwGDIpFEzeGkirJYD6PlYp9DN+pLdseOhWrP1j9GImxfB6ynlH0xEdfhXi0IiKEWQYD5KBYKe1zsVmKacrnsVwx+BA4C8O/6PkwuImW6Yv2X2H4P/Z+0G0sn8fu/+T8prxJpkEpf0Yii+KsrigtU7iAZVTKZeycYnrzeSxXTO8jTVuOtgZzaSn+1/Spz2duJempuOWK6X0wd8vR1mDuVShUbGVZlium9/WSLUdbAyo2q7DXrZjmlyS3HG0FqNiswl65Ynpf9d9ytBWgYrMKe+WK6U1Ys+VoK0DFZhX2yhXTnHZty9GWYy6fx8YVU5fPY41iepOHbjnacszl89i4YuryeaxRTG8K7C1HW465fB5bV0xZPo81iumdyGHL0ZZjLp/H1hVTls9j1TOKeqcj2nK0xZjL53H1ipnK57FKMb2T6m052mLM5fO4csXOVZy6fB6rFNM7NeyWoy3GXD6PK1fsXMWpy+ex7mWWH8Pw3/XVGIv2o9Zof9YXbTHG8nlcuWLnKk5dPo9WsYkXsU/wJgx/v2T/+9EpL472Rmu0f10UbXIObWXMz+fRZKeo3abx+LXIEEoHitHB1pqyZSeuNqrYmYqbrrGuTiivk4pXYtUsiXX8a7vb4MiuLEKx56U5DH74YeEBd4OTXhztd7/TGe3164UHvNUr2bx8HqKpQMfQZ7cHQMGWYNxL3FrAlpgt9VtreJnLYT2dbSp2puKma6yrE5EcHK5iAa/EfF+xdre9I5uyCMUUJ394vNtLHrmpaCI/g17m5PPg/+zEqdpJGqqqGUHk92IJbxew1G+tSn6Iu1nF5uXz2Kuxrk4o3w6DsSkkVmUVGAwU63brj+zLwhV7Vp7D4GlwNluLBvkZ1EY4w/ERxQg6Pjm7k68zl7WMjC1VMYwoFsQrK0r4bUSztXKcQiQ63JsxpYuxBcVO7DdZY32dQF1Vhcf+RpWwMYelTrF+t76u+xhcsXvlOQzYtaT7U7+1aJCfQfUJneTkoD18fuMQh0DTqQJ2x+AHIrsacQKejqbbyu7ZXY/AeDMf1x/HuA3FRjXW1QkTyWOrInZ9imEjPADTX8X6quuO7GO8Et+U5zB43O3a0ZzNRft59+bl8t+ynql8Hqn43mTKSAOaiQcSorRpGVnA/iDTfLi1SIIggS5PQenmPno+t9+RGmvrBG5e06j5uCsNUrFr3n7tqm5Q122MV0uKdAEvfYwtRzPCwvB0TSq1zSt2hlWVJmLoUqzW2uiNRTMCKnZQWFRss9GMgIodFBYV22w0IywMX+blkt3bGLet2KpKEzFQManRjICJBQ4KK12xC8qCikmNZgRU7KCwV6BYma+9MMLjI6dPZ8vRjICKHRTWesUSj4xeLJtP8xykGxf76483+i1FMwIqdlBY2xXLoRnBM8Pxil/ZvhQwfgjnaKPfVDQjoGIHhbVdsYC/V54RPr9aXRcpXwuPD5ftQ8SF6DHtbRIHi/lrYvYtPXI6FkfLL41mBJw24qCw1ij2Mq2YQ+CpxjqF9l1Bx4qnLCDED/i8vBXfxT3YJA5upoiKxo+5HW30m4pmBD2TH/23yVNcWNiZD7RpnPxo1EQou1dJmxEByPbh8VfMYLI11r/if8Ez6GiNN4kDxAJs2x9TONroNxXNCFqedFb/7LbEws58LFvPI+JTipX8fsOJCr7olTV/iBjS7uRVyRPNsVZWHmwSB3e3K+l+sKON3qpowYXRjPCkZSJa1TFkFnbmy0VaKu7b5IhiGYsXpPlT+j5P4JjWzSS9HiSac4g3sYnTDQn4++Pbx8f4thTNDBNpKSTywt86VRtDcmHn7q2j4upjHz2XKdyM1GnbqGjdjBAkhOSsL5VMbOKIzlSVjofdTn4YbE+07LJoZnhamjthMW+/qY8hsbA2VdykYgXvGFWsHaYFdJOAkv1153ckrA8V8yxyh5sGzZAP3e19enS00W8qmimWZQBaisgApDaG5MJaVHETiiVNAh0fGpILy/x5CL9rX67LX+s83DRshu5oTOBYo99WNHO8zE83spQXDTHkF9aaiptQrHTgAQYqBtRi9jXhI91tW+OdKJG/aLypaYY+Y//t6hONflvREGTM5Iii3wycwRvTAWmaXdvWKhiRg4XDTUA/JLD/lNHxMb4tRUOQMdPDHSmlftSMmpU04B8ksXXdxuzIJgYVJOMnbU8MQGwoGoKMwZdZpEZDkDGomNRoCDIGFZMaDUHGoGJSoyHIGFRMajQEGYOKSY2GIGNQManREGQMKiY1GoKMQcWkRkOQMThthNRoCDIGJz+6HNOTHyFWg1P4XYzxKfwQq8GJaC/G+ES0iNUMplNXl8NgaoLzrUQzMZ06ck0IxZ6V5zC4GwwIbC3a/FwRyA3yqvmuOIfBaMRtU9FQMOQUr7olHckf6puIhiADXl3+KxAEOQ4qhiBKQcUQRCmoGIIoBRVDEKX8PwvzSH789sC+AAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDE3LTExLTI4VDAyOjAyOjU2KzAwOjAwRZOLMQAAACV0RVh0ZGF0ZTptb2RpZnkAMjAxNy0xMS0yOFQwMjowMjo1NiswMDowMDTOM40AAAAASUVORK5CYII=" width="866" height="215" class="img_ev3q"> &#x27;非同期API＋イベントループ&#x27;</p>
<p>非同期API＋イベントループの例</p>
<p>非同期APIといわれても、非同期という概念についていまいちぱっと思い浮かぶイメージがない方も多いと思います。簡単に言ってしまえば、JavaのFutureであったり、RxJavaのSingleであったり、Pythonであればasyncioだったりというものです。これらを使ったことがある方であれば、なんとなくイメージが湧くかもしれません。何か処理を実行して、計算が終了したときに通知してくれたり、次に行う処理（コールバック）を指定できたりするような仕組みが非同期APIです。何か非同期処理を行う関数を実行しても、その関数自体は処理が終了していなくてもブロックせずに終了します。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="非同期apiの例">非同期APIの例<a href="#非同期apiの例" class="hash-link" aria-label="Direct link to 非同期APIの例" title="Direct link to 非同期APIの例" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 非同期APIを利用してProductからAuthorを取得する</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// CompletableFutureの例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">someAsyncDriver.getProdut(id) // ブロックしない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// -&gt; CompletableFuture&lt;Product&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               .thenCompose(product -&gt; product.getAuthor());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// -&gt; CompletableFuture&lt;Author&gt;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="非同期apiを利用するメリット">非同期APIを利用するメリット<a href="#非同期apiを利用するメリット" class="hash-link" aria-label="Direct link to 非同期APIを利用するメリット" title="Direct link to 非同期APIを利用するメリット" translate="no">​</a></h3>
<p>サーバー内で効率的にリクエストを処理するために、まずサービス内部でRPCやDBへのリクエストを行う際に、それらのクライアントに備わっている非同期APIを利用します。きちんと実装された非同期APIでは、RPCやDBへクエリを行う際に、スレッドを専有することなく処理を行うことができます（注：Futureを返却するAPIでも、実装によっては内部でリクエスト毎にスレッドを生成している場合があり注意が必要です）。最近では、多くのDBクライアントやRPCライブラリが非同期APIを提供しており、各言語で非同期APIを利用することができます。例えば、LINE ShopではJava 8を使っていますが、以下のようなライブラリが提供する非同期APIを利用しています。これらのライブラリの内部的な仕組みはさまざまで、詳細に説明しているとネットワークライブラリ（Java NIOやNetty）や、OSのシステムコール（例えばselectやepoll）の話をしなくてはいけなくなるので、この記事では省きます。</p>
<ul>
<li class="">Thrift RPC：<a href="http://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a></li>
<li class="">HTTP RESTful API：<a href="http://square.github.io/retrofit/" target="_blank" rel="noopener noreferrer" class="">Retrofit</a> (<a href="https://line.github.io/armeria/client-retrofit.html" target="_blank" rel="noopener noreferrer" class="">Armeria Retrofit</a>)</li>
<li class="">Redis：<a href="https://lettuce.io/" target="_blank" rel="noopener noreferrer" class="">Lettuce</a></li>
<li class="">MongoDB：<a href="http://mongodb.github.io/mongo-java-driver/3.5/driver-async/" target="_blank" rel="noopener noreferrer" class="">MongoDB Async Java Driver</a></li>
<li class="">Elasticsearch：<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api/current/java-api.html" target="_blank" rel="noopener noreferrer" class="">Java API</a></li>
<li class=""><a href="https://kafka.apache.org/090/javadoc/index.html?org/apache/kafka/clients/producer/KafkaProducer.html" target="_blank" rel="noopener noreferrer" class="">Apache Kafka</a></li>
</ul>
<p>多くのライブラリではリクエスト毎にスレッドを生成することはしません。基本的にはリクエストの送受信時に通知を受けて処理するために限られた数のスレッドを使い、そのスレッド数よりはるかに多くのリクエストを並列に処理しています。イベントループのような仕組みを使って、CPUのコア数程度のスレッドを作り、それぞれのスレッドでリクエスト・レスポンスの処理を行い、キャッシュ効率向上や無駄なコンテキストスイッチコストの削減を実現することができます（例えば、JavaのForkJoinPoolを利用すると、このような処理が簡単に行なえます）。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="リクエストからレスポンスまで完全に非同期に">リクエストからレスポンスまで完全に非同期に<a href="#リクエストからレスポンスまで完全に非同期に" class="hash-link" aria-label="Direct link to リクエストからレスポンスまで完全に非同期に" title="Direct link to リクエストからレスポンスまで完全に非同期に" translate="no">​</a></h3>
<p>もちろん、RPCやDBへのアクセス部分だけでも非同期化することでかなりの効果が得られるのですが、最大限効果を得るためには、サーバーのネットワークから来るリクエスト処理からRPCやDBへのリクエストを経て、レスポンスを返すまですべてを非同期化するべきです。いったんどこかで同期的な処理にまとめてしまうと、またそこでスレッド数の問題が発生することが少なくないからです。また、後ほど説明するとおり、非同期APIと同期APIの混在は、イベントループの方式を利用した場合、コーディングミスによりリクエストをブロックしてしまうようなことが簡単にできてしまうこともあり、これを防ぐためでもあります。</p>
<p>さらに、上から下まで完全に非同期で書かれたサービスは、それぞれのサービスのレイテンシの低下にそれほど敏感になる必要がなくなります。なぜなら、レスポンスがいくら遅くてもスレッドを専有しないので、通常はただレスポンスが返ってこないだけです。よって、スレッドプールを利用した場合のように、スレッドの上限を気にする必要がなくなります。</p>
<p>サーバーの受け側を非同期化するためには、そのリクエストを処理するフレームワークも非同期APIに対応している必要があります。Javaであれば、よく利用されるSpring FrameworkだとDeferredResultが非同期処理を行うインターフェースとして利用できます。最近では、Spring WebFluxなどサーブレットに依存しないフレームワークが出現して、非同期化の機運が高まっています。そんな世の中ですが、LINE Shopでは、これから説明するArmeriaという自社開発RPCフレームワークを使い、非同期化を行っています（Spring も同時に利用しています）。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="armeriaとthrift">ArmeriaとThrift<a href="#armeriaとthrift" class="hash-link" aria-label="Direct link to ArmeriaとThrift" title="Direct link to ArmeriaとThrift" translate="no">​</a></h2>
<p>LINEでは、LINE Shopに限らずメッセンジャーに関連する多くのRPCが<a href="https://thrift.apache.org/" target="_blank" rel="noopener noreferrer" class="">Apache Thrift</a>と呼ばれるRPCフレームワークを利用して行われています。Thriftは、APIの定義、リクエスト・レスポンスのスキーマの定義を専用のIDLを用いて行うことで、それぞれの言語で利用できるRPCライブラリを自動生成してくれます。最近では、同様のフレームワークにProtocol Buffersを利用した<a href="https://grpc.io/" target="_blank" rel="noopener noreferrer" class="">gRPC</a>があります。LINE Shopでは、JSONを利用したRESTfulなAPIはほとんど使われていません。個人的には、マイクロサービスをやるならJSONを使うのはもうダサいと思っています。遅いし、普通はAPIを内部でしか使わないので。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="thrift-idlの例">Thrift IDLの例<a href="#thrift-idlの例" class="hash-link" aria-label="Direct link to Thrift IDLの例" title="Direct link to Thrift IDLの例" translate="no">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct GetProductRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1: ProductType type,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2: string productId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct Product {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    1: ProductType type,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2: string productId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service ShopService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Product getProduct(1:GetProductRequest request) throws (1:ShopException e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>そんな中、LINEでは<a href="http://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a>というオープンソースのHTTP/2対応Java向け非同期RPCライブラリを公開しています。簡単に言うと、ArmeriaはThriftやgRPCを使って定義したAPIを使うためのサーバーとクライアントを勝手に作って、しかもHTTP/2で通信してくれる便利なフレームワークです。その一方で、HTTP REST APIにも対応しています。通信は、HTTP/2を基本とし、Javaの非同期ネットワークライブラリとして有名な<a href="https://netty.io/" target="_blank" rel="noopener noreferrer" class="">Netty</a>を使って実装されています（LINEに在籍しているNettyプロジェクトの設立者が開発しています）。Armeriaは、以下のようなマイクロサービスを構築するために必要なものが全て揃っている素晴らしいフレームワークです。</p>
<ul>
<li class="">HTTP/2を利用する場合に必要な、Client-side Load Balancing</li>
<li class="">障害が起きた際に、他のサービスが障害に巻き混まれる影響を最小限に抑える<a href="http://line.github.io/armeria/advanced-circuitbreaker.html" target="_blank" rel="noopener noreferrer" class="">Circuit Breaker</a></li>
<li class="">Swaggerのようなデバッグが簡単に行える<a href="http://line.github.io/armeria/server-docservice.html" target="_blank" rel="noopener noreferrer" class="">Documentation Service</a></li>
<li class=""><a href="https://github.com/line/armeria/pull/717" target="_blank" rel="noopener noreferrer" class="">MicrometerとPrometheusを利用した詳細なメトリック出力</a></li>
<li class=""><a href="https://line.github.io/armeria/advanced-zipkin.html" target="_blank" rel="noopener noreferrer" class="">Zipkin Integration</a></li>
<li class=""><a href="https://line.github.io/armeria/client-retrofit.html" target="_blank" rel="noopener noreferrer" class="">Retrofit Integration</a></li>
</ul>
<p>Armeriaを使うと、ThriftやgRPCを利用するサーバー・クライアントをすべて非同期化することができます。LINE Shopでは、ほぼすべてのサービスでArmeriaを利用して、サービスの基礎となるネットワーク通信部分から、その先のRPCコールまでを非同期APIで結んでいます。社内でも、Armeriaを使っているプロジェクトはまだまだ多くないのですが、これからもっと増やしていこうと、パイロットプロジェクト的なものになっています（実際にはそんなきれい事ではなくて、多数のバグや障害を率先的に踏み抜いていく役目です）。まだまだ、大規模なAPIの変更などがあったり、メトリック出力用のライブラリが突然<a href="http://metrics.dropwizard.io/" target="_blank" rel="noopener noreferrer" class="">Dropwizard Metrics</a>から<a href="https://micrometer.io/" target="_blank" rel="noopener noreferrer" class="">Micrometer</a>に変わったりしていますが、LINE Shopやその他いくつかのチームではプロダクション環境で本気で使っていますし、基本的な部分に関しては最近は安定しているので、使ってくれる仲間を募集中です。</p>
<p><img decoding="async" loading="lazy" alt="Armeria Documentation Service" src="/assets/images/asynchronous-micro-service-in-rxjava-2-armeria-5-68362bedc903d62abb81b59d536c0599.png" width="1362" height="974" class="img_ev3q"> &#x27;Armeria Documentation Service&#x27;</p>
<p>Armeria Documentation Service</p>
<p><img decoding="async" loading="lazy" alt="Shop Grafana Dashboard" src="/assets/images/asynchronous-micro-service-in-rxjava-2-armeria-6-4f585de289046e7d4633fb83bd1f9c5f.png" width="2808" height="1790" class="img_ev3q"> &#x27;Shop Grafana Dashboard&#x27;</p>
<p>Prometheus＋Grafanaを利用したメトリック出力</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="サーバーサイドrxjava-2">サーバーサイドRxJava 2<a href="#サーバーサイドrxjava-2" class="hash-link" aria-label="Direct link to サーバーサイドRxJava 2" title="Direct link to サーバーサイドRxJava 2" translate="no">​</a></h2>
<p>LINE Shopでは、今年の初めあたりに<a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener noreferrer" class="">RxJava 2</a>を導入して、非同期APIの結果に対する処理の流れがかなりきれいに書けるようになりました。非同期APIを使って、上から下まですべてを非同期にしてしまうと、実際に内部の処理を書くコードは結構変わってきます。それまでは全てが同期的なAPIで、ただ普通の型を扱っていたコードが、突然Futureだらけになってしまうからです。そして、Futureに対して何か変換処理を行ったり、2つのFutureの結果を待ち受けて処理を行ったりするためには、特殊な操作が必要です。非同期でFutureを使うと、コードの書きやすさとしてはどうしても劣ってしまいますし、今までの手続き的な同期APIばかりを使ってプログラムを書いてきた者としては、とっつきづらいという感想もチーム内ではよくありました。非同期APIをたくさん扱うようになると、このあたりが面倒になってきて、諦める人も多いかと思います。LINE Shopでは、Reactive Streamsを採用したRxJava 2を導入することで、この煩わしさを解決しました。</p>
<p>本格的に非同期化を始めた2年半ほど前は、GuavaのListenableFutureを使っていました。.transform()や.transformAsync()といったメソッドで、Futureの結果に対して変換を行ったり、そのFutureをもとに新たなリクエストを投げるFutureに変換したりするのですが、ListenableFutureのままではなかなか扱いづらいです。Java 8は普段から利用していたので、CompletableFutureも使える状況で、こちらは.map()のような処理が簡単に行えるAPIが用意されているのですが、いろいろあってListenableFutureのままでした。<a href="http://square.github.io/dagger/" target="_blank" rel="noopener noreferrer" class="">Dagger</a>のAsync Dependency Injection を裏技的に利用したりもしていましたが、コードの可読性やデバッグのやりやすさが著しく低下するので、現在はRxJava 2に乗り換えて正解だったと思っています。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="rxjavaを導入して得られたメリット">RxJavaを導入して得られたメリット<a href="#rxjavaを導入して得られたメリット" class="hash-link" aria-label="Direct link to RxJavaを導入して得られたメリット" title="Direct link to RxJavaを導入して得られたメリット" translate="no">​</a></h3>
<p>RxJavaというより、Reactive Streamsを採用することで得られた恩恵は、非同期APIに対するデータの処理が簡潔に書けるようになったことと、データの流れを意識しながらプログラムを書けるようになったことです。例えば、従来のFutureでは.transform()を利用して、ネストして書いていたものが、RxJavaではmapを使って簡潔に書けるようになります。これが、複数の非同期APIの結果を利用して、また別の非同期APIを呼び出すような場合に、.flatMap()を使って気軽に行えるあたりはとても気持ち良いです。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Service AからProductを複数取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ProductごとにTag idを利用してService Bにリクエスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Tagを取得したらProductにセット</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ProductのListを返す</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serviceA.getProducts()             // Single&lt;List&lt;Product&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .filter(p -&gt; p.isOnSale())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .flattenAsFlowable()       // Flowable&lt;Product&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .flatMap(p -&gt; serviceB.getTag(p.getTagId()) // Single&lt;Tag&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              .map(tag -&gt; p.setTag(tag)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .toList()                  // Single&lt;List&lt;Product&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .doOnError(e -&gt; log.error(&quot;ERROR!&quot;));</span><br></span></code></pre></div></div>
<p>ListenableFutureやCompletableFutureを使っているライブラリでも、簡単にRxJava 2に変換できるように、それらを変換するライブラリを作ったり利用したりして、あまり細かいことは気にせずにReactive Streamsに変換できるような環境を整えています（例えば、<a href="https://github.com/akarnokd/RxJava2Jdk8Interop" target="_blank" rel="noopener noreferrer" class="">RxJava2Jdk8Interop</a>など）。実際は、非同期処理が発火されるタイミングが、FutureとRxJavaでは根本的に考え方が違うのですが、このあたりはあまり気にせずに利用できるようにしています。</p>
<p>また、データの流れを意識して、Reactiveに書けるという点も、コードを書いていてとても気持ちよくなる点の1つです。今までは手続き的にいろんな変数にぐちゃぐちゃと一時的なデータを入れ込んで、見通しが悪いプログラムを書きがちだったものが、データが非同期的に集まってきて、Reactive Streamsの中できれいに書こうとすると、自ずとデータの流れを意識した効率的なプログラムになります。今書いているコードにどんなデータが必要で、どこからデータが来て、何に変換されていくか、という流れが、自然に明確になる感じがあります。</p>
<p>このようなデータフローを意識していくと、無駄な処理や、イケていないコードや設計が駆逐されていきます（正確に言うと、データの流れに反するようなコードをReactive Streamsの上で書くのが難しいので、書きたくなくなります）。これは、直接非同期化とは関係ない事ではありますが、RxJavaを使うことで現れた良い副作用の1つですね。ただし、RxJavaを使いこなすためには若干学習が必要なのと、関数型言語やReactiveな世界に触れたことがない手続き型バリバリの頭だと、最初は厳しいこともあると思うので、導入する際にはチームメンバーの教育と協力が必要だと思います。</p>
<p>その他にも、RxJavaを採用して得られたメリットや落とし穴など、詳しくは福岡オフィスの同じチームのメンバーである@kojilinさんがJJUG CCCで話した内容に詳しく解説されているので、こちらをぜひご覧ください。</p>
<p>サーバーサイドでの非同期処理で色々やったよ<a href="https://docs.google.com/presentation/d/1LKcFzspXUQbq-sivRBPb3Q6V7fQBLKB0zH6BSnGrD%5C_I/edit#slide=id.p" target="_blank" rel="noopener noreferrer" class="">https://docs.google.com/presentation/d/1LKcFzspXUQbq-sivRBPb3Q6V7fQBLKB0zH6BSnGrD\_I/edit#slide=id.p</a></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="今後の課題">今後の課題<a href="#今後の課題" class="hash-link" aria-label="Direct link to 今後の課題" title="Direct link to 今後の課題" translate="no">​</a></h2>
<p>今後の課題には、以下のようなものがあります。</p>
<ul>
<li class="">MySQL（JDBC）には、非同期APIが存在しない</li>
<li class="">同期的なAPIと非同期的なAPIが混ざることによりミスが発生する</li>
<li class="">新しいメンバーに対する、非同期とはなにか、非同期の場合にはこうするべき、というような知識の移譲</li>
</ul>
<p>まずは、1つ目のMySQLの問題です。LINE ShopではMyBatisと組み合わせてMySQLを利用しているのですが、仕方なくThreadPoolExecutorを使って、Futureに変換しています。また、MySQLはスタンプ（Sticker）関連の処理でしか利用していないので、さまざまなリクエストが集まるサーバーではなく、スタンプ専用のMySQLが必要なリクエストを処理するサーバーに処理をまとめることで、問題を回避しています。将来的に、非同期的なJDBCが実装され利用できるようになれば、この問題も解決されることでしょう。</p>
<p>同期的なAPIと非同期的なAPIが混ざることによるミスというのは、非同期を実現するために利用しているイベントループの根本的な仕組みではあるのですが、イベントループは少ない数のスレッドで実現されているために、その中ではCPUをブロックしてしまうような処理を実行することは許されません。つまり、ArmeriaやNettyなどイベントループを利用するライブラリでは、リクエストを受け付けてAPIのハンドラを実行する関数は通常イベントループ上で実行されるため、その中で同期的なAPIリクエストを行うことはできません。同期的なAPIをイベントループ内で呼んでしまうと、著しいパフォーマンスの低下やデッドロックを引き起こします。</p>
<p>しかし、ミスはつきもので、今までの感覚でついつい同期的なAPIを呼びたくなってしまうこともあるし、コードレビューで見抜けないこともあります。なので、同期的なAPIを利用する関数を完全に撤廃するべきなのですが、同期APIから非同期APIに移行するとき、すべてを一気に移行するのは難しいです。</p>
<p>3番目の課題につながることですが、非同期APIについてチーム内で理解を深めあって、やってはいけないことの共有をコードレビューなどを通じてしっかり行いながら、共通認識を持つのが大事だと思います。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="Direct link to まとめ" title="Direct link to まとめ" translate="no">​</a></h2>
<p>この記事のまとめですが、言いたかったことはだいたい以下のようなものです。</p>
<ul>
<li class="">RPCやDBアクセスが沢山発生するAPIで、スレッドプールを使って並列化する場合、スレッドプールの限界を考える必要があります。</li>
<li class="">同期的なAPIだと何をやってもリクエストしている間にスレッドを専有してしまうので、非同期APIを使うと効率的です。</li>
<li class="">LINEでは、ThriftとgRPCを扱える、HTTP/2に対応した非同期RPCフレームワーク<a href="http://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a>を開発しています。</li>
<li class="">RxJavaを使うと、RPCやDBアクセスを非同期的にした場合でも、Reactiveにデータの流れを考えながらきれいなコードが書けます。</li>
</ul>
<p>結果的に、LINE Shopでの1台のサーバーあたりで捌いているAPIリクエスト数について言えば、APIの内容にもよりますが、物理サーバー1台あたり最大毎秒3,000件程度のリクエストを受けて、毎秒10,000件程度のRPC、Redis、DBリクエストを発行するような、高トラフィックな状況を耐え凌いだこともあります。スタンプメッセージのバリデーションを行うようなサーバーは、常時毎秒数千リクエストを捌くことができています。</p>
<p>実際には、非同期APIを利用するだけでなく、RPCを少なくするような仕組みや、キャッシュを行うサーバーを限定したり、<a href="https://github.com/ben-manes/caffeine/wiki" target="_blank" rel="noopener noreferrer" class="">Caffeine</a>を使ったローカルメモリキャッシュを併用したりしつつ、いろいろな工夫をして意外と少ないサーバー数で運用しています。実際には、APIによってはまだまだ無駄なことをしている部分があったり、ベンチマークをきちんとできているとはいえないので、今の構成でもさらに詰めるべき点はあると思っています。さらに、ほとんどのAPIは100ms以内に結果を返すことができていて、私達のチームでは、APIのレスポンスが95パーセンタイルで1秒を超えていたら、好ましくない状況だという共通認識で運用をしています。</p>
<p>雑多な紹介になってしまいましたが、非同期APIの必要性と面白さをおわかりいただけたでしょうか？最後になりますが、非同期RPCフレームワーク<a href="http://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a>をよろしくお願いします。</p>
<p>明日の記事はSongran Liuさんによる「<a href="https://engineering.linecorp.com/ja/blog/detail/214" target="_blank" rel="noopener noreferrer" class="">LINE Developersサイトを支えるDAO自動生成ツール</a>」です。お楽しみに！</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/line/armeria/edit/main/site/src/content/blog/ja/2017-12-01-asynchronous-micro-service-in-rxjava-2-armeria.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/ja/2019/05/23/thank-you-for-contributing-to-armeria"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">オープンソース「Armeria」のコントリビュータのためのイベントを開催しました</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/ja/2016/08/04/applying-circuitbreaker-to-channel-gateway"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">チャネルゲートウェイへのCircuitBreakerの適用</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#line-shopにおけるマイクロサービス" class="table-of-contents__link toc-highlight">LINE Shopにおけるマイクロサービス</a><ul><li><a href="#マイクロサービス化した場合に問題になりそうなこと" class="table-of-contents__link toc-highlight">マイクロサービス化した場合に問題になりそうなこと</a></li><li><a href="#同期的synchronousapiとスレッドプール" class="table-of-contents__link toc-highlight">同期的（Synchronous）APIとスレッドプール</a></li></ul></li><li><a href="#非同期asynchronousapi" class="table-of-contents__link toc-highlight">非同期（Asynchronous）API</a><ul><li><a href="#非同期apiの例" class="table-of-contents__link toc-highlight">非同期APIの例</a></li><li><a href="#非同期apiを利用するメリット" class="table-of-contents__link toc-highlight">非同期APIを利用するメリット</a></li><li><a href="#リクエストからレスポンスまで完全に非同期に" class="table-of-contents__link toc-highlight">リクエストからレスポンスまで完全に非同期に</a></li></ul></li><li><a href="#armeriaとthrift" class="table-of-contents__link toc-highlight">ArmeriaとThrift</a><ul><li><a href="#thrift-idlの例" class="table-of-contents__link toc-highlight">Thrift IDLの例</a></li></ul></li><li><a href="#サーバーサイドrxjava-2" class="table-of-contents__link toc-highlight">サーバーサイドRxJava 2</a><ul><li><a href="#rxjavaを導入して得られたメリット" class="table-of-contents__link toc-highlight">RxJavaを導入して得られたメリット</a></li></ul></li><li><a href="#今後の課題" class="table-of-contents__link toc-highlight">今後の課題</a></li><li><a href="#まとめ" class="table-of-contents__link toc-highlight">まとめ</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container--fluid"><div class="row"><div class="newsletterForm_kJQ8 col"><p>Sign up for our newsletters:</p><span class="ant-input-group-wrapper ant-input-group-wrapper-outlined css-198drv2 ant-input-search ant-input-search-with-button signUpForm_fXdf"><span class="ant-input-wrapper ant-input-group css-198drv2"><span class="ant-input-affix-wrapper css-198drv2 ant-input-outlined"><span class="ant-input-prefix"><span role="img" aria-label="mail" class="anticon anticon-mail"><svg viewBox="64 64 896 896" focusable="false" data-icon="mail" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0068.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"></path></svg></span></span><input type="search" placeholder="Your e-mail" required="" aria-required="true" class="ant-input css-198drv2" value=""></span><span class="ant-input-group-addon"><button title="Sign up for our newsletters" type="button" class="ant-btn css-198drv2 ant-btn-default ant-btn-color-default ant-btn-variant-outlined ant-input-search-button"><span>Subscribe</span></button></span></span></span></div><div class="copyright_C6JK col"><div>© 2015-<!-- -->2025<!-- -->, LY Corporation<br><br><a href="https://terms.line.me/line_rules?lang=en" target="_blank" rel="noopener noreferrer">Privacy policy</a></div><div><span role="img" aria-label="Armeria project logo" aria-hidden="false"><svg class="" style="width:4rem;overflow:hidden;vertical-align:middle" viewBox="20 70 70 70" version="1.1"><title>Armeria project logo</title><g id="layer1" transform="translate(0,-87)"><g id="g4208" transform="matrix(1.3217499,0,0,1.3217499,-49.437761,-33.946772)"><g transform="matrix(0.35277777,0,0,-0.35277777,80.962517,162.47851)" id="g46"><path id="path48" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="M 0,0 -20.785,-12 V -36 L 0,-48 20.785,-36 v 24 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,95.627238,162.47851)" id="g50"><path id="path52" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="M 0,0 V 24 L -20.785,12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,66.297787,170.94517)" id="g54"><path id="path56" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="M 0,0 V 24 L -20.784,12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,88.294897,192.11184)" id="g58"><path id="path60" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="M 0,0 V 24 L -20.785,12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,66.297787,154.01184)" id="g62"><path id="path64" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="m 0,0 v -24 l 20.785,12 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,95.627238,162.47851)" id="g66"><path id="path68" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="m 0,0 v -24 l 20.785,12 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,73.630137,183.64517)" id="g70"><path id="path72" class="secondary_XIgw" style="fill:rgba(255, 255, 255, 0.55)" d="m 0,0 v -24 l 20.785,12 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,73.630137,149.77851)" id="g74"><path id="path76" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="M 0,0 -20.785,-12 0,-24 20.785,-12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,95.627238,154.01184)" id="g78"><path id="path80" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="M 0,0 -20.785,12 -41.569,0 -20.785,-12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,88.294897,166.71184)" id="g82"><path id="path84" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="m 0,0 v 0 -24 l 20.785,12 V 12 L 0,24 -20.785,12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,73.630137,166.71184)" id="g86"><path id="path88" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="M 0,0 20.785,12 0,24 -20.785,12 V -12 L 0,-24 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,88.294897,192.11184)" id="g90"><path id="path92" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="M 0,0 20.785,12 V 36 L 0,24 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,95.627238,170.94517)" id="g94"><path id="path96" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="m 0,0 v -24 l 20.785,12 v 24 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,66.297787,187.8785)" id="g98"><path id="path100" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="M 0,0 20.785,-12 V 12 L 0,24 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,58.965587,166.71184)" id="g102"><path id="path104" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="m 0,0 v -24 l 20.784,-12 v 24 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,80.962517,179.41184)" id="g106"><path id="path108" class="primary_UCAP" style="fill:rgba(255, 255, 255, 1.0)" d="M 0,0 -20.785,12 V -12 L 0,-24 20.785,-12 v 24 z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,88.294897,158.24517)" id="g110"><path id="path112" class="tertiary_B5zC" style="fill:transparent" d="M 0,0 -20.785,12 -41.569,0 -20.785,-12 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,95.627238,170.94517)" id="g114"><path id="path116" class="tertiary_B5zC" style="fill:transparent" d="M 0,0 -20.785,-12 V -36 L 0,-24 Z"></path></g><g transform="matrix(0.35277777,0,0,-0.35277777,66.297787,170.94517)" id="g118"><path id="path120" class="tertiary_B5zC" style="fill:transparent" d="M 0,0 20.785,-12 V -36 L 0,-24 Z"></path></g></g></g></svg></span></div></div></div></div></footer><div id="starBegging_pb0B" class="off_vUOf"><p>Like Armeria?<br>Star us ⭐️</p><span role="button" tabindex="0" class="close_CaW0">×</span> <iframe id="starFrame" class="githubStar" title="github-stars" src="https://ghbtns.com/github-btn.html?user=line&amp;repo=armeria&amp;type=star&amp;count=true&amp;size=large" width="150px" height="30px"></iframe></div></div>
</body>
</html>