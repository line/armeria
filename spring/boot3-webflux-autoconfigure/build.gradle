import com.linecorp.armeria.conventions.spring.SpringBuildUtil

configurations {
    // TODO(hyangtack) The followings are not transitive dependencies and they are not in testRuntime
    //                 dependencies. Need to figure out why they are included in shadedJarTestRuntime dependencies.
    // Exclude jetty from shadedTest.
    shadedJarTestRuntime.exclude group: 'org.eclipse.jetty'
    shadedJarTestRuntime.exclude group: 'org.eclipse.jetty.http2'
}

dependencies {
    // To let a user choose between thrift and thrift0.9.
    compileOnly project(':thrift0.18')
    implementation project(':logback')
    implementation project(':spring:spring6')

    api libs.spring.boot3.starter.webflux
    api libs.jakarta.inject
    compileOnly libs.jakarta.validation
    // WebFlux uses `StandardWebSocketUpgradeStrategy`, which depends on Jakarta WebSocket API 2.1+, if no
    // custom `RequestUpgradeStrategy` is detected. We may remove jakarta.websocket dependencies if
    // Armeria WebFlux module supports WebSocket.
    // https://github.com/spring-projects/spring-framework/blob/main/spring-webflux/src/main/java/org/springframework/web/reactive/socket/server/support/HandshakeWebSocketService.java#L272-L291
    implementation libs.jakarta.websocket
    implementation libs.jakarta.websocket.client

    optionalApi project(':prometheus1')
    optionalApi libs.micrometer.prometheus.legacy
    optionalApi libs.dropwizard.metrics.json

    annotationProcessor libs.spring.boot3.configuration.processor

    testImplementation project(':spring:boot3-actuator-autoconfigure')
    testImplementation project(':thrift0.18')
    testImplementation libs.spring.boot3.starter.test
    testImplementation libs.spring6.web
    // Added for sharing test suites with boot2
    testImplementation libs.javax.inject
}

SpringBuildUtil.useMainSources(project(":spring:spring7"), project) {
    include '**/ArmeriaClientHttpRequest.java'
    include '**/ArmeriaClientHttpResponse.java'
    include '**/DataBufferFactoryWrapper.java'
}

SpringBuildUtil.useMainSources(project(":spring:boot4-webflux-autoconfigure"), project) {
    exclude '**/VersionSpecificConfiguration.java'
    exclude '**/VersionSpecificReactiveWebServerFactory.java'
    exclude '**/package-info.java'
    exclude '**/org.springframework.boot.autoconfigure.AutoConfiguration.imports'
}

SpringBuildUtil.useTestSources(project(":spring:boot4-webflux-autoconfigure"), project) {
    exclude "**/VersionSpecificTestUtil.java"
}
