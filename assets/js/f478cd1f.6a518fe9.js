"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[1676],{28453:(e,r,i)=>{i.d(r,{R:()=>o,x:()=>a});var t=i(96540);const n={},c=t.createContext(n);function o(e){const r=t.useContext(c);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),t.createElement(c.Provider,{value:r},e.children)}},71654:(e,r,i)=>{i.r(r),i.d(r,{assets:()=>s,contentTitle:()=>a,default:()=>m,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"advanced/metrics","title":"Collecting metrics","description":"Armeria has built-in support for collecting metrics both on the server and client side.","source":"@site/src/content/docs/advanced/metrics.mdx","sourceDirName":"advanced","slug":"/advanced/metrics","permalink":"/docs/advanced/metrics","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site/src/content/docs/advanced/metrics.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Structured logging with Kafka","permalink":"/docs/advanced/structured-logging-kafka"},"next":{"title":"Unit-testing Client and Service","permalink":"/docs/advanced/unit-testing"}}');var n=i(74848),c=i(28453);const o={},a="Collecting metrics",s={},l=[{value:"Collecting server-side metrics",id:"collecting-server-side-metrics",level:2},{value:"Collecting client-side metrics",id:"collecting-client-side-metrics",level:2},{value:"Changing the default distribution summary config",id:"changing-the-default-distribution-summary-config",level:2},{value:"Excluding certain meters created by Armeria",id:"excluding-certain-meters-created-by-armeria",level:2}];function d(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.header,{children:(0,n.jsx)(r.h1,{id:"collecting-metrics",children:"Collecting metrics"})}),"\n",(0,n.jsx)(r.p,{children:"Armeria has built-in support for collecting metrics both on the server and client side.\nThis page describes how to enable this."}),"\n",(0,n.jsx)(r.admonition,{type:"tip",children:(0,n.jsxs)(r.p,{children:["The metric data is collected using the ",(0,n.jsx)(r.a,{href:"https://micrometer.io/",children:"Micrometer"})," library.\nPlease consult its documentation for information on how to expose the collected metrics to\nvarious monitoring systems such as ",(0,n.jsx)(r.a,{href:"https://prometheus.io/",children:"Prometheus"}),",\n",(0,n.jsx)(r.a,{href:"https://metrics.dropwizard.io/4.1.2/",children:"Dropwizard Metrics"})," and ",(0,n.jsx)(r.a,{href:"https://www.datadoghq.com/",children:"Datadog"}),"."]})}),"\n",(0,n.jsx)(r.h2,{id:"collecting-server-side-metrics",children:"Collecting server-side metrics"}),"\n",(0,n.jsxs)(r.p,{children:["You can use ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/metric/MetricCollectingService.html",children:"MetricCollectingService"})," with ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html",children:"MeterIdPrefixFunction"})," for collecting metrics\nof your services."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.MeterIdPrefixFunction;\nimport com.linecorp.armeria.server.Server;\nimport com.linecorp.armeria.server.ServerBuilder;\nimport com.linecorp.armeria.server.metric.MetricCollectingService;\n\nServer.builder()\n      .http(new InetSocketAddress(address, port))\n      .service(new MyHttpService())\n      .decorator(MetricCollectingService.newDecorator(\n              MeterIdPrefixFunction.ofDefault("http.service")))\n      .build();\n'})}),"\n",(0,n.jsxs)(r.p,{children:["If you are interested in monitoring ",(0,n.jsx)(r.a,{href:"https://grpc.github.io/grpc/core/md_doc_statuscodes.html",children:"gRPC status"}),"\nfor a gRPC service, you can use ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/grpc/GrpcMeterIdPrefixFunction.html",children:"GrpcMeterIdPrefixFunction"})," instead of ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html",children:"MeterIdPrefixFunction"}),"."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.grpc.GrpcMeterIdPrefixFunction;\nimport com.linecorp.armeria.server.grpc.GrpcService;\n\nServer.builder()\n      .http(new InetSocketAddress(address, port))\n      .service(GrpcService.builder()\n                          .addService(new MyHelloService())\n                          .build())\n      .decorator(MetricCollectingService.newDecorator(\n              GrpcMeterIdPrefixFunction.of("grpc.service")))\n      .build();\n'})}),"\n",(0,n.jsxs)(r.p,{children:["You can provide ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/grpc/GrpcMeterIdPrefixFunction.html",children:"GrpcMeterIdPrefixFunction"})," as a bean if you are using a Spring integration module:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'@Bean\npublic MeterIdPrefixFunction grpcMeterIdPrefixFunction() {\n    return GrpcMeterIdPrefixFunction.of("grpc.service");\n}\n'})}),"\n",(0,n.jsxs)(r.p,{children:["In cases where more sophisticated filtering and/or mangling of the generated metrics are required,\nyou can use the ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServerBuilder.html#meterRegistry(io.micrometer.core.instrument.MeterRegistry)",children:"ServerBuilder#meterRegistry(MeterRegistry)"})," method like this:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:"Server.builder()\n      // ...\n      .meterRegistry(myMeterRegistry);\n"})}),"\n",(0,n.jsx)(r.h2,{id:"collecting-client-side-metrics",children:"Collecting client-side metrics"}),"\n",(0,n.jsxs)(r.p,{children:["This approach can be used to collect metrics for a ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/WebClient.html",children:"WebClient"})," and a gRPC client:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.client.WebClient;\nimport com.linecorp.armeria.client.grpc.GrpcClients;\nimport com.linecorp.armeria.client.metric.MetricCollectingClient;\n\n// Decorate a WebClient with MetricCollectingClient\nWebClient.builder(httpUrl)\n         .decorator(MetricCollectingClient.newDecorator(\n                 MeterIdPrefixFunction.ofDefault("http.client")))\n         .build();\n\n// Decorate a gRPC client with MetricCollectingClient\nGrpcClients.builder(grpcUrl)\n           .decorator(MetricCollectingClient.newDecorator(\n                   GrpcMeterIdPrefixFunction.of("grpc.client")))\n           .build(HelloServiceBlockingStub.class);\n'})}),"\n",(0,n.jsxs)(r.p,{children:["Like the server-side metrics described above, certain scenarios might require you to\nprovide a custom meter registry. To accomplish this, override the ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientFactory.html",children:"ClientFactory"})," in this way:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:"import com.linecorp.armeria.client.ClientFactory;\nimport com.linecorp.armeria.client.Clients;\n\nClientFactory clientFactory =\n      ClientFactory.builder()\n                   .meterRegistry(myMeterRegistry)\n                   .build();\n\n// Set a custom ClientFactory to a WebClient\nWebClient.builder(httpUrl)\n         .factory(clientFactory)\n          // ...\n         .build();\n\n// Set a custom ClientFactory to a gRPC client\nClients.builder(grpcUrl)\n       .factory(clientFactory)\n        // ...\n       .build(HelloServiceBlockingStub.class);\n"})}),"\n",(0,n.jsx)(r.h2,{id:"changing-the-default-distribution-summary-config",children:"Changing the default distribution summary config"}),"\n",(0,n.jsxs)(r.p,{children:["A ",(0,n.jsx)(r.a,{href:"https://docs.micrometer.io/micrometer/reference/concepts/distribution-summaries",children:"distribution summary"})," is used to track\nthe distribution of events. Armeria provides a sensible default\n",(0,n.jsx)(r.a,{href:"https://javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/distribution/DistributionStatisticConfig.html",children:"DistributionStatisticConfig"}),"\nfor measuring the following metrics:"]}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:"A length of the request content"}),"\n",(0,n.jsx)(r.li,{children:"A length of the response content"}),"\n",(0,n.jsx)(r.li,{children:"A duration of request"}),"\n",(0,n.jsx)(r.li,{children:"A duration of response"}),"\n"]}),"\n",(0,n.jsxs)(r.p,{children:["If you want to override the default config,\nyou can set your own ",(0,n.jsx)(r.code,{children:"DistributionStatisticConfig"})," using ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/metric/MoreMeters.html#setDistributionStatisticConfig(io.micrometer.core.instrument.distribution.DistributionStatisticConfig)",children:"MoreMeters#setDistributionStatisticConfig(DistributionStatisticConfig)"}),"."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:"import com.linecorp.armeria.common.metric.MoreMeters;\nimport io.micrometer.core.instrument.distribution.DistributionStatisticConfig;\n\nDistributionStatisticConfig myDistStatCfg =\n        DistributionStatisticConfig.builder()\n                                   .percentilesHistogram(false)\n                                   .sla()\n                                   .percentiles({ 0, 0.5, 0.75, 0.9, 0.95, 0.99, 1.0 })\n                                   .percentilePrecision(10)\n                                   .minimumExpectedValue(1L)\n                                   .maximumExpectedValue(Long.MAX_VALUE)\n                                   .expiry(Duration.ofMinutes(10))\n                                   .bufferLength(10)\n                                   .build();\nMoreMeters.setDistributionStatisticConfig(myDistStatCfg);\n"})}),"\n",(0,n.jsx)(r.h2,{id:"excluding-certain-meters-created-by-armeria",children:"Excluding certain meters created by Armeria"}),"\n",(0,n.jsxs)(r.p,{children:["Micrometer's ",(0,n.jsx)(r.code,{children:"MeterRegistry"})," can be configured with ",(0,n.jsx)(r.a,{href:"https://docs.micrometer.io/micrometer/reference/concepts/meter-filters",children:"meter filters"}),".\nIf you need to control the exported meters, you can apply sophisticated filters to the ",(0,n.jsx)(r.code,{children:"MeterRegistry"}),"."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.Flags;\n\nFlags.meterRegistry()\n     .config()\n     .meterFilter(MeterFilter.deny(id ->\n                  id.getTag("service").equals("MyHealthCheckService")));\n     .meterFilter(MeterFilter.denyNameStartsWith("jvm"));\n'})}),"\n",(0,n.jsxs)(r.p,{children:["Please refer to ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html",children:"MeterIdPrefixFunction"})," to learn what kinds of tags are used for request metrics."]})]})}function m(e={}){const{wrapper:r}={...(0,c.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}}}]);