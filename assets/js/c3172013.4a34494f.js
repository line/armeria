"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[6595],{28453:(e,r,i)=>{i.d(r,{R:()=>s,x:()=>a});var t=i(96540);const n={},o=t.createContext(n);function s(e){const r=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:s(e.components),t.createElement(o.Provider,{value:r},e.children)}},98125:(e,r,i)=>{i.r(r),i.d(r,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>s,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"server/timeouts","title":"Configuring server timeouts","description":"There are several ways to override the default timeouts at server-side.","source":"@site/src/content/docs/server/timeouts.mdx","sourceDirName":"server","slug":"/server/timeouts","permalink":"/docs/server/timeouts","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site-new/src/content/docs/server/timeouts.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Handling a multipart request","permalink":"/docs/server/multipart"},"next":{"title":"Client","permalink":"/docs/category/client"}}');var n=i(74848),o=i(28453);const s={},a="Configuring server timeouts",l={},c=[{value:"Using ServerBuilder",id:"using-serverbuilder",level:2},{value:"Using VirtualHostBuilder",id:"using-virtualhostbuilder",level:2},{value:"Using ServiceBindingBuilder",id:"using-servicebindingbuilder",level:2},{value:"Using ServiceRequestContext",id:"using-servicerequestcontext",level:2},{value:"Using @RequestTimeout Annotation",id:"using-requesttimeout-annotation",level:2},{value:"Handling timeouts for streaming requests",id:"handling-timeouts-for-streaming-requests",level:2},{value:"Understanding timeout and cancellation origins",id:"understanding-timeout-and-cancellation-origins",level:2},{value:"Global Configuration",id:"global-configuration",level:2},{value:"Using FlagsProvider",id:"using-flagsprovider",level:3},{value:"Using JVM system properties",id:"using-jvm-system-properties",level:3}];function m(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.header,{children:(0,n.jsx)(r.h1,{id:"configuring-server-timeouts",children:"Configuring server timeouts"})}),"\n",(0,n.jsx)(r.p,{children:"There are several ways to override the default timeouts at server-side."}),"\n",(0,n.jsxs)(r.h2,{id:"using-serverbuilder",children:["Using ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServerBuilder.html",children:"ServerBuilder"})]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:"import com.linecorp.armeria.server.Server;\nimport com.linecorp.armeria.server.ServerBuilder;\n\nimport java.time.Duration;\n\nServerBuilder sb = Server.builder();\nServer server = sb.http(port)\n                  .annotatedService(new HelloService())\n                  .requestTimeout(Duration.ofSeconds(5))\n                  .build();\n"})}),"\n",(0,n.jsxs)(r.h2,{id:"using-virtualhostbuilder",children:["Using ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/VirtualHostBuilder.html",children:"VirtualHostBuilder"})]}),"\n",(0,n.jsx)(r.p,{children:"You can set the timeouts for each virtual host."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.HttpResponse;\nimport com.linecorp.armeria.server.Server;\nimport com.linecorp.armeria.server.ServerBuilder;\n\nimport java.time.Duration;\n\nimport static com.linecorp.armeria.common.HttpStatus.OK;\n\nServerBuilder sb = Server.builder();\nServer server = sb.http(port)\n                  .defaultVirtualHost()\n                  .service("/hello1", (ctx, req) -> HttpResponse.of(OK))\n                  .requestTimeout(Duration.ofSeconds(5))\n                  .and()\n                  .virtualHost("*.foo.com")\n                  .service("/hello2", (ctx, req) -> HttpResponse.of(OK))\n                  .requestTimeout(Duration.ofSeconds(10))\n                  .and()\n                  .withVirtualHost(builder -> {\n                      builder.hostnamePattern("*.bar.com")\n                             .service("/hello3", (ctx, req) -> HttpResponse.of(OK))\n                             .requestTimeout(Duration.ofSeconds(15));\n                  })\n                  .build();\n'})}),"\n",(0,n.jsxs)(r.h2,{id:"using-servicebindingbuilder",children:["Using ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceBindingBuilder.html",children:"ServiceBindingBuilder"})]}),"\n",(0,n.jsx)(r.p,{children:"You can set the timeouts for each route."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.HttpResponse;\nimport com.linecorp.armeria.server.Server;\nimport com.linecorp.armeria.server.ServerBuilder;\n\nimport java.time.Duration;\n\nimport static com.linecorp.armeria.common.HttpStatus.OK;\n\nServerBuilder sb = Server.builder();\nServer server = sb.http(port)\n                  .route()\n                  .get("/hello1")\n                  .requestTimeout(Duration.ofSeconds(5))\n                  .build((ctx, req) -> HttpResponse.of(OK))\n                  .withRoute(builder -> {\n                      builder.get("/hello2")\n                             .requestTimeout(Duration.ofSeconds(10))\n                             .build((ctx, req) -> HttpResponse.of(OK));\n                  })\n                  .build();\n'})}),"\n",(0,n.jsxs)(r.h2,{id:"using-servicerequestcontext",children:["Using ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"})]}),"\n",(0,n.jsx)(r.p,{children:"You can use the context to set the timeouts for a request."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.HttpResponse;\nimport com.linecorp.armeria.server.Server;\nimport com.linecorp.armeria.server.ServerBuilder;\n\nimport java.time.Duration;\n\nimport static com.linecorp.armeria.common.HttpStatus.OK;\n\nServerBuilder sb = Server.builder();\nServer server = sb.http(port)\n                  .service("/hello", (ctx, req) -> {\n                      ctx.setRequestTimeout(Duration.ofSeconds(5));\n                      return HttpResponse.of(OK);\n                  })\n                  .build();\n'})}),"\n",(0,n.jsxs)(r.h2,{id:"using-requesttimeout-annotation",children:["Using ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/annotation/decorator/RequestTimeout.html",children:"@RequestTimeout"})," Annotation"]}),"\n",(0,n.jsxs)(r.p,{children:["You can use the ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/annotation/decorator/RequestTimeout.html",children:"@RequestTimeout"})," annotation for annotated services and gRPC services."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="HelloService.java"',children:'import com.linecorp.armeria.common.HttpResponse;\nimport com.linecorp.armeria.server.ServiceRequestContext;\nimport com.linecorp.armeria.server.annotation.Get;\nimport com.linecorp.armeria.server.annotation.decorator.RequestTimeout;\n\nimport java.time.Duration;\nimport java.util.concurrent.TimeUnit;\n\nimport static com.linecorp.armeria.common.HttpStatus.OK;\n\n@RequestTimeout(value = 10, unit = TimeUnit.SECONDS)\npublic class HelloService {\n\n    @Get("/hello")\n    @RequestTimeout(5000)\n    public HttpResponse getHello() {\n        return HttpResponse.of(OK);\n    }\n\n}\n'})}),"\n",(0,n.jsx)(r.h2,{id:"handling-timeouts-for-streaming-requests",children:"Handling timeouts for streaming requests"}),"\n",(0,n.jsxs)(r.p,{children:["For long-running streaming requests (e.g., gRPC server streaming, bidirectional streaming, or\nGraphQL subscriptions), the default request timeout applies to the entire duration of the stream\u2014from\nreceiving the first message until ",(0,n.jsx)(r.code,{children:"responseObserver.onCompleted()"})," is called. This means that if your\nstream is expected to last longer than the configured request timeout, you must manually extend the\ntimeout as messages are sent."]}),"\n",(0,n.jsxs)(r.p,{children:["You can extend the timeout dynamically using ",(0,n.jsx)(r.a,{href:"type://ServiceRequestContext",children:"ServiceRequestContext"})," with\n",(0,n.jsx)(r.a,{href:"type://TimeoutMode#EXTEND",children:"TimeoutMode.EXTEND"}),":"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:"import com.linecorp.armeria.common.util.TimeoutMode;\nimport com.linecorp.armeria.server.ServiceRequestContext;\n\nimport java.time.Duration;\n\nimport io.grpc.stub.StreamObserver;\n\npublic class MyStreamingService extends MyServiceGrpc.MyServiceImplBase {\n\n    @Override\n    public void streamingOutputCall(Request request,\n                                    StreamObserver<Response> responseObserver) {\n        ServiceRequestContext ctx = ServiceRequestContext.current();\n\n        for (int i = 0; i < 100; i++) {\n            // Simulate processing time\n            Thread.sleep(500);\n\n            // Send a response\n            responseObserver.onNext(Response.newBuilder().build());\n\n            // Extend the timeout with each message sent\n            ctx.setRequestTimeout(TimeoutMode.EXTEND, Duration.ofSeconds(5));\n        }\n\n        responseObserver.onCompleted();\n    }\n}\n"})}),"\n",(0,n.jsx)(r.p,{children:"You can also extend the timeout reactively when streaming with reactive publishers:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.HttpResponse;\nimport com.linecorp.armeria.common.util.TimeoutMode;\nimport com.linecorp.armeria.server.ServiceRequestContext;\n\nimport java.time.Duration;\n\nimport reactor.core.publisher.Flux;\n\n// Extend timeout with each emitted item\nServerBuilder sb = Server.builder();\nsb.service("/streaming", (ctx, req) -> {\n    Flux<String> publisher =\n        Flux.interval(Duration.ofMillis(200))\n            .doOnNext(i -> ctx.setRequestTimeout(TimeoutMode.EXTEND, Duration.ofMillis(500)));\n    return HttpResponse.of(publisher.take(100).map(i -> "data: " + i + "\\n"));\n});\n'})}),"\n",(0,n.jsx)(r.p,{children:"Alternatively, for streams with unpredictable duration (e.g., infinite streams or proxy services),\nyou can disable the timeout entirely:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:'// Disable request timeout for infinite streaming\nServerBuilder sb = Server.builder();\nsb.requestTimeoutMillis(0)\n  .service("/infinite-stream", myStreamingService);\n'})}),"\n",(0,n.jsx)(r.admonition,{type:"tip",children:(0,n.jsxs)(r.p,{children:["See ",(0,n.jsx)(r.a,{href:"/docs/advanced/request-context#timeout-control",children:"Timeout control"})," for more details on using\n",(0,n.jsx)(r.a,{href:"type://TimeoutMode",children:"TimeoutMode"})," to dynamically adjust timeouts."]})}),"\n",(0,n.jsx)(r.h2,{id:"understanding-timeout-and-cancellation-origins",children:"Understanding timeout and cancellation origins"}),"\n",(0,n.jsxs)(r.p,{children:["Timeouts and cancellations can originate from either the client or server side, and understanding this is\ncrucial for debugging issues. For detailed information about how timeouts and cancellations propagate\nbetween clients and servers, see ",(0,n.jsx)(r.a,{href:"/docs/advanced/understanding-timeouts",children:"Understanding timeout and cancellation origins"}),"."]}),"\n",(0,n.jsx)(r.h2,{id:"global-configuration",children:"Global Configuration"}),"\n",(0,n.jsxs)(r.p,{children:["You may globally configure the default timeout with system properties or a custom ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/FlagsProvider.html",children:"FlagsProvider"}),"."]}),"\n",(0,n.jsxs)(r.h3,{id:"using-flagsprovider",children:["Using ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/FlagsProvider.html",children:"FlagsProvider"})]}),"\n",(0,n.jsxs)(r.p,{children:["You can override the request timeout specified by JVM system properties by implementing your own ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/FlagsProvider.html",children:"FlagsProvider"})," and loading it via Java SPI."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",children:"package com.example.providers;\n\n// Add the following text file to your classpath or JAR file:\n//\n// $ cat META-INF/services/com.linecorp.armeria.common.FlagsProvider\n// com.example.providers.MyFlagsProvider\n//\npublic class MyFlagsProvider implements FlagsProvider {\n  @Override\n  public int priority() {\n    // The provider with higher value will be evaluated first.\n    return 100;\n  }\n\n  @Override\n  public Long defaultRequestTimeoutMillis() {\n      return 1000L;\n  }\n}\n"})}),"\n",(0,n.jsx)(r.h3,{id:"using-jvm-system-properties",children:"Using JVM system properties"}),"\n",(0,n.jsx)(r.p,{children:"You can override the default server timeouts by specifying the following JVM system properties if you do not prefer setting it programmatically."}),"\n",(0,n.jsx)(r.p,{children:(0,n.jsx)(r.code,{children:"-Dcom.linecorp.armeria.defaultRequestTimeoutMillis=<long>"})}),"\n",(0,n.jsxs)(r.p,{children:["Represents the amount of time from receiving a request to sending the corresponding response completely. Default: ",(0,n.jsx)(r.code,{children:"10000"}),"."]}),"\n",(0,n.jsx)(r.admonition,{type:"warning",children:(0,n.jsxs)(r.p,{children:["The JVM system properties have effect only when you did not specify them programmatically.\nSee ",(0,n.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/Flags.html",children:"Flags"})," for the complete list of JVM system properties in Armeria."]})})]})}function u(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(m,{...e})}):m(e)}}}]);