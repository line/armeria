"use strict";(self.webpackChunkarmeria_site=self.webpackChunkarmeria_site||[]).push([[5260],{10736:function(e,t,a){a.r(t),a.d(t,{_frontmatter:function(){return s},default:function(){return y},pageTitle:function(){return c}});var n=a(80045),r=(a(96540),a(28619)),i=a(53747);a(12793);const o=["components"],c="Athenz integration",s={},l=e=>function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.yg)("div",t)},h=l("RequiredDependencies"),p=l("Tip"),m={pageTitle:c,_frontmatter:s},d=i.A;function y(e){let{components:t}=e,a=(0,n.A)(e,o);return(0,r.yg)(d,Object.assign({},m,a,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("h1",{id:"athenz-integration",style:{position:"relative"}},(0,r.yg)("a",{parentName:"h1",href:"#athenz-integration","aria-label":"athenz integration permalink",className:"anchor before"},(0,r.yg)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},(0,r.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Athenz integration"),(0,r.yg)("h6",{className:"inlinePageToc",role:"navigation"},"Table of contents"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#prerequisites"},"Prerequisites")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#creating-a-zts-client"},"Creating a ZTS client")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#checking-permissions-with-the-typeathenzservice-decorator"},"Checking permissions with the type://AthenzService decorator")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#checking-permissions-with-the-typerequiresathenzrole-annotation"},"Checking permissions with the type://@RequiresAthenzRole annotation")),(0,r.yg)("li",{parentName:"ul"},(0,r.yg)("a",{parentName:"li",href:"#obtaining-athenz-tokens-with-typeathenzclient"},"Obtaining athenz tokens with type://AthenzClient"))),(0,r.yg)("p",null,"This document explains how to integrate Armeria with ",(0,r.yg)("a",{parentName:"p",href:"https://www.athenz.io/"},"Athenz"),", a platform for service\nauthentication and authorization. It assumes that you have already configured an Athenz domain and installed\nthe necessary service identity certificates locally."),(0,r.yg)("h2",{id:"prerequisites",style:{position:"relative"}},(0,r.yg)("a",{parentName:"h2",href:"#prerequisites","aria-label":"prerequisites permalink",className:"anchor before"},(0,r.yg)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},(0,r.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Prerequisites"),(0,r.yg)("p",null,"Add the following dependencies to your build.gradle file:"),(0,r.yg)(h,{boms:[{groupId:"com.linecorp.armeria",artifactId:"armeria-bom"}],dependencies:[{groupId:"com.linecorp.armeria",artifactId:"armeria-athenz"}],mdxType:"RequiredDependencies"}),(0,r.yg)("h2",{id:"creating-a-zts-client",style:{position:"relative"}},(0,r.yg)("a",{parentName:"h2",href:"#creating-a-zts-client","aria-label":"creating a zts client permalink",className:"anchor before"},(0,r.yg)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},(0,r.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Creating a ZTS client"),(0,r.yg)("p",null,"The ",(0,r.yg)("a",{parentName:"p",href:"type://ZtsBaseClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/athenz/ZtsBaseClient.html"},"type://ZtsBaseClient")," is a client used to interact with the ",(0,r.yg)("a",{parentName:"p",href:"https://athenz.github.io/athenz/system_view/#zts-authz-token-system"},"Athenz ZTS (authZ Token System)"),".\nIt is required to create ",(0,r.yg)("a",{parentName:"p",href:"type://AthenzClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/athenz/AthenzClient.html"},"type://AthenzClient")," and ",(0,r.yg)("a",{parentName:"p",href:"type://AthenzService:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/AthenzService.html"},"type://AthenzService")," decorators.\nYou can create an instance of ",(0,r.yg)("a",{parentName:"p",href:"type://ZtsBaseClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/athenz/ZtsBaseClient.html"},"type://ZtsBaseClient")," as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'import com.linecorp.armeria.client.athenz.ZtsBaseClient;\nimport com.linecorp.armeria.client.athenz.ZtsBaseClientBuilder;\n\nZtsBaseClient ztsBaseClient =\n    ZtsBaseClient\n        .builder("https://athenz.example.com:8443/zts/v1")\n        // You need to specify your Athenz service key and certificate files.\n        .keyPair("/var/lib/athenz/service.key.pem", \n                 "/var/lib/athenz/service.cert.pem")\n        // Uncomment the following line to use a proxy.\n        // .proxyUri("http://my-proxy.example.com:8080")\n        .build();\n\n// ...\n\n// Close the client when it is no longer needed.\nztsBaseClient.close();\n')),(0,r.yg)("h2",{id:"checking-permissions-with-the-typeathenzservice-decorator",style:{position:"relative"}},(0,r.yg)("a",{parentName:"h2",href:"#checking-permissions-with-the-typeathenzservice-decorator","aria-label":"checking permissions with the typeathenzservice decorator permalink",className:"anchor before"},(0,r.yg)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},(0,r.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Checking permissions with the ",(0,r.yg)("a",{parentName:"h2",href:"type://AthenzService:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/AthenzService.html"},"type://AthenzService")," decorator"),(0,r.yg)("p",null,"You can enforce Athenz authorization on your services by applying the ",(0,r.yg)("a",{parentName:"p",href:"type://AthenzService:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/AthenzService.html"},"type://AthenzService")," decorator.\nThis decorator intercepts incoming requests and validates the client's token against the configured Athenz policies."),(0,r.yg)("p",null,"The code below configures a decorator for paths under ",(0,r.yg)("inlineCode",{parentName:"p"},"/files"),". It will only grant access to requests that\npresent a token with the specified ",(0,r.yg)("inlineCode",{parentName:"p"},"action"),' ("get") and ',(0,r.yg)("inlineCode",{parentName:"p"},"resource"),' ("files") for your Athenz domain.\nThe ',(0,r.yg)("inlineCode",{parentName:"p"},"action")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"resource")," must correspond to an assertion you have configured in Athenz."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'import com.linecorp.armeria.server.Server;\nimport com.linecorp.armeria.server.ServerBuilder;\nimport com.linecorp.armeria.server.athenz.AthenzService;\nimport com.linecorp.armeria.server.athenz.AthenzPolicyConfig;\n\nServerBuilder serverBuilder = Server.builder();\nserverBuilder.decoratorUnder(\n    "/files",\n    AthenzService.builder(ztsBaseClient)\n                 .action("get")\n                 .resource("files")\n                 .policyConfig(new AthenzPolicyConfig("your-domain"))\n                 .newDecorator());\nserverBuilder.serviceUnder("/files", FileService.of(...));\n...\n')),(0,r.yg)("p",null,"The ",(0,r.yg)("a",{parentName:"p",href:"type://AthenzPolicyConfig:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/AthenzPolicyConfig.html"},"type://AthenzPolicyConfig")," object replaces the need for a ",(0,r.yg)("inlineCode",{parentName:"p"},"zpu.conf")," file. It allows the server to download\npolicy files directly at startup and perform authorization checks without relying on the ",(0,r.yg)("a",{parentName:"p",href:"https://athenz.github.io/athenz/setup_zpu/"},(0,r.yg)("inlineCode",{parentName:"a"},"zpu")),"\ncommand-line utility."),(0,r.yg)("p",null,"If you are only using the decorator for permission checks, this is all the configuration required to integrate Athenz with Armeria."),(0,r.yg)("h2",{id:"checking-permissions-with-the-typerequiresathenzrole-annotation",style:{position:"relative"}},(0,r.yg)("a",{parentName:"h2",href:"#checking-permissions-with-the-typerequiresathenzrole-annotation","aria-label":"checking permissions with the typerequiresathenzrole annotation permalink",className:"anchor before"},(0,r.yg)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},(0,r.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Checking permissions with the ",(0,r.yg)("a",{parentName:"h2",href:"type://@RequiresAthenzRole:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/RequiresAthenzRole.html"},"type://@RequiresAthenzRole")," annotation"),(0,r.yg)("p",null,"As an alternative to programmatically applying decorators, you can use the ",(0,r.yg)("a",{parentName:"p",href:"type://@RequiresAthenzRole:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/RequiresAthenzRole.html"},"type://@RequiresAthenzRole")," annotation\non service methods or classes for a more declarative approach."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'import com.linecorp.armeria.server.athenz.RequiresAthenzRole;\n\nclass MyService {\n    // Decorate the method with `@RequiresAthenzRole` to check the Athenz role.\n    @RequiresAthenzRole(resource = "user", action = "get")\n    @ProducesJson\n    @Get("/user")\n    public CompletableFuture<User> getUser() {\n        // ...\n    }\n}\n')),(0,r.yg)("p",null,"To enable this annotation, you must register an ",(0,r.yg)("a",{parentName:"p",href:"type://AthenzServiceDecoratorFactory:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/AthenzServiceDecoratorFactory.html"},"type://AthenzServiceDecoratorFactory")," with the server.\nThis factory uses the ",(0,r.yg)("a",{parentName:"p",href:"type://ZtsBaseClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/athenz/ZtsBaseClient.html"},"type://ZtsBaseClient")," to create the necessary decorators that enforce the roles specified\nin the annotations."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'import com.linecorp.armeria.common.DependencyInjector;\nimport com.linecorp.armeria.server.athenz.AthenzPolicyConfig;\nimport com.linecorp.armeria.server.athenz.AthenzServiceDecoratorFactory;\nimport com.linecorp.armeria.server.athenz.AthenzServiceDecoratorFactoryBuilder;\n\n// Create and register `AthenzServiceDecoratorFactory`.\nAthenzServiceDecoratorFactory athenzDecoratorFactory =\n  AthenzServiceDecoratorFactory\n    .builder(ztsBaseClient)\n    .policyConfig(new AthenzPolicyConfig("my-domain"))\n    .build();\n\nDependencyInjector di =\n  DependencyInjector.ofSingletons(athenzDecoratorFactory)\n                    .orElse(DependencyInjector.ofReflective());\nserverBuilder.dependencyInjector(di, true);\n')),(0,r.yg)("p",null,"The ",(0,r.yg)("a",{parentName:"p",href:"type://@RequiresAthenzRole:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/RequiresAthenzRole.html"},"type://@RequiresAthenzRole")," annotation can be applied not only to annotated services but also to methods in\nThrift and gRPC services."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'class UserGrpcServiceImpl extends UserGrpcServiceImplBase {\n  @RequiresAthenzRole(resource = "user", action = "get")\n  public void getUser(UserRequest request,\n                      StreamObserver<UserResponse> responseObserver) {\n    // ...\n  }\n}\n')),(0,r.yg)("h2",{id:"obtaining-athenz-tokens-with-typeathenzclient",style:{position:"relative"}},(0,r.yg)("a",{parentName:"h2",href:"#obtaining-athenz-tokens-with-typeathenzclient","aria-label":"obtaining athenz tokens with typeathenzclient permalink",className:"anchor before"},(0,r.yg)("svg",{parentName:"a","aria-hidden":"true",focusable:"false",height:"16",version:"1.1",viewBox:"0 0 16 16",width:"16"},(0,r.yg)("path",{parentName:"svg",fillRule:"evenodd",d:"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"}))),"Obtaining athenz tokens with ",(0,r.yg)("a",{parentName:"h2",href:"type://AthenzClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/athenz/AthenzClient.html"},"type://AthenzClient")),(0,r.yg)("p",null,"To communicate with other Athenz-protected services, you can use the ",(0,r.yg)("a",{parentName:"p",href:"type://AthenzClient:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/athenz/AthenzClient.html"},"type://AthenzClient")," decorator.\nThis client automatically acquires an Athenz token from the ZTS, caches it, and attaches it to outgoing requests.\nIt also handles token refreshes before expiration, so you do not need to manage the token lifecycle yourself."),(0,r.yg)("p",null,"To obtain an access token and send it in the ",(0,r.yg)("inlineCode",{parentName:"p"},"Authorization")," header, configure the decorator with ",(0,r.yg)("a",{parentName:"p",href:"type://TokenType#ACCESS_TOKEN:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/athenz/TokenType.html#ACCESS_TOKEN"},"type://TokenType#ACCESS_TOKEN"),"."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'import com.linecorp.armeria.client.athenz.AthenzClient;\nimport com.linecorp.armeria.common.athenz.TokenType;\n\nWebClient client =\n  WebClient\n    .builder("https://api.example.com/")\n    .decorator(AthenzClient.newDecorator(ztsBaseClient, "my-domain",\n                                         TokenType.ACCESS_TOKEN))\n    .build();\n \n// An Athenz access token is automatically acquired and set in the `Authorization` header.\nclient.get("/files");\n')),(0,r.yg)("p",null,"To obtain a role token and send it in a role token header (e.g., Athenz-Role-Auth or Yahoo-Role-Auth), specify\n",(0,r.yg)("a",{parentName:"p",href:"type://TokenType#ATHENZ_ROLE_TOKEN:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/athenz/TokenType.html#ATHENZ_ROLE_TOKEN"},"type://TokenType#ATHENZ_ROLE_TOKEN")," or ",(0,r.yg)("a",{parentName:"p",href:"type://TokenType#YAHOO_ROLE_TOKEN:https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/athenz/TokenType.html#YAHOO_ROLE_TOKEN"},"type://TokenType#YAHOO_ROLE_TOKEN"),"."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'WebClient client =\nWebClient\n  .builder("https://api.example.com/")\n  .decorator(AthenzClient.newDecorator(ztsBaseClient, "my-domain",\n                                       TokenType.ATHENZ_ROLE_TOKEN))\n  .build();\n')),(0,r.yg)(p,{mdxType:"Tip"},(0,r.yg)("p",null,"Visit ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/line/armeria/tree/main/examples/athenz"},"athenz-example")," to check out a fully working example.")))}y.isMDXComponent=!0},53747:function(e,t,a){a.d(t,{A:function(){return c}});var n=a(41015),r=a(96540),i=JSON.parse('{"root":["index","setup"],"Useful links":{"Tutorials":"/tutorials","Community articles":"/community/articles","API documentation":"https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/index.html","Release notes":"/release-notes"},"Server":["server-basics","server-decorator","server-grpc","server-thrift","server-graphql","server-docservice","server-annotated-service","server-http-file","server-servlet","server-access-log","server-cors","server-sse","server-service-registration","server-multipart","server-timeouts"],"Client":["client-http","client-thrift","client-grpc","client-factory","client-decorator","client-retrofit","client-custom-http-headers","client-timeouts","client-retry","client-circuit-breaker","client-service-discovery"],"Advanced":["advanced-logging","advanced-structured-logging","advanced-custom-attributes","advanced-streaming-backpressure","advanced-structured-logging-kafka","advanced-metrics","advanced-unit-testing","advanced-production-checklist","advanced-saml","advanced-athenz","advanced-spring-boot-integration","advanced-spring-webflux-integration","advanced-dropwizard-integration","advanced-kotlin","advanced-scala","advanced-scalapb","advanced-flags-provider","advanced-zipkin","advanced-client-interoperability"]}'),o=a(61023);var c=e=>{const{allMdx:{nodes:t}}=(0,n.useStaticQuery)("1217743243");return r.createElement(o.A,Object.assign({},e,{candidateMdxNodes:t,index:i,prefix:"docs",pageTitleSuffix:"Armeria documentation"}))}}}]);
//# sourceMappingURL=component---src-pages-docs-advanced-athenz-mdx-48215c4a007bf8cf840c.js.map