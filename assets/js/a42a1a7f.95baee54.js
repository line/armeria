"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[9806],{28453:(e,r,n)=>{n.d(r,{R:()=>i,x:()=>o});var t=n(96540);const a={},s=t.createContext(a);function i(e){const r=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),t.createElement(s.Provider,{value:r},e.children)}},49437:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"server/basics","title":"Server basics","description":"To start a server, you need to build it first. Use ServerBuilder:","source":"@site/src/content/docs/server/basics.mdx","sourceDirName":"server","slug":"/server/basics","permalink":"/docs/server/basics","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site-new/src/content/docs/server/basics.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Server","permalink":"/docs/category/server"},"next":{"title":"Decorating a service","permalink":"/docs/server/decorator"}}');var a=n(74848),s=n(28453);const i={},o="Server basics",c={},d=[{value:"Ports",id:"ports",level:2},{value:"Services",id:"services",level:2},{value:"Path patterns",id:"path-patterns",level:2},{value:"Per service configuration",id:"per-service-configuration",level:2},{value:"SSL/TLS",id:"ssltls",level:2},{value:"PROXY protocol",id:"proxy-protocol",level:2},{value:"Serving HTTP and HTTPS on the same port",id:"serving-http-and-https-on-the-same-port",level:2},{value:"Virtual hosts",id:"virtual-hosts",level:2},{value:"Getting an IP address of a client who initiated a request",id:"getting-an-ip-address-of-a-client-who-initiated-a-request",level:2},{value:"See also",id:"see-also",level:2}];function l(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(r.header,{children:(0,a.jsx)(r.h1,{id:"server-basics",children:"Server basics"})}),"\n",(0,a.jsxs)(r.p,{children:["To start a server, you need to build it first. Use ",(0,a.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServerBuilder.html",children:"ServerBuilder"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-java",children:"import com.linecorp.armeria.server.Server;\nimport com.linecorp.armeria.server.ServerBuilder;\n\nServerBuilder sb = Server.builder();\n// TODO: Configure your server here.\nServer server = sb.build();\nCompletableFuture<Void> future = server.start();\n// Wait until the server is ready.\nfuture.join();\n"})}),"\n",(0,a.jsx)(r.h2,{id:"ports",children:"Ports"}),"\n",(0,a.jsx)(r.p,{children:"To serve anything, you need to specify which TCP/IP port you want to bind onto:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-java",children:"ServerBuilder sb = Server.builder();\n// Configure an HTTP port.\nsb.http(8080);\n// TODO: Add your services here.\nServer server = sb.build();\nCompletableFuture<Void> future = server.start();\nfuture.join();\n"})}),"\n",(0,a.jsx)(r.h2,{id:"services",children:"Services"}),"\n",(0,a.jsx)(r.p,{children:"Even if we opened a port, it's of no use if we didn't bind any services to them. Let's add some:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.HttpRequest;\nimport com.linecorp.armeria.common.HttpResponse;\nimport com.linecorp.armeria.common.HttpStatus;\nimport com.linecorp.armeria.common.MediaType;\nimport com.linecorp.armeria.common.MediaTypeNames;\nimport com.linecorp.armeria.common.QueryParams;\n\nimport com.linecorp.armeria.server.AbstractHttpService;\nimport com.linecorp.armeria.server.Server;\nimport com.linecorp.armeria.server.ServerBuilder;\nimport com.linecorp.armeria.server.ServiceRequestContext;\nimport com.linecorp.armeria.server.annotation.Consumes;\nimport com.linecorp.armeria.server.annotation.Default;\nimport com.linecorp.armeria.server.annotation.Get;\nimport com.linecorp.armeria.server.annotation.Param;\nimport com.linecorp.armeria.server.annotation.Post;\nimport com.linecorp.armeria.server.annotation.Produces;\nimport com.linecorp.armeria.server.logging.LoggingService;\n\nServerBuilder sb = Server.builder();\nsb.http(8080);\n\n// Add a simple \'Hello, world!\' service.\nsb.service("/", (ctx, req) -> HttpResponse.of("Hello, world!"));\n\n// Using path variables:\nsb.service("/greet/{name}", new AbstractHttpService() {\n    @Override\n    protected HttpResponse doGet(ServiceRequestContext ctx, HttpRequest req) {\n        String name = ctx.pathParam("name");\n        return HttpResponse.of("Hello, %s!", name);\n    }\n}.decorate(LoggingService.newDecorator())); // Enable logging\n\n// Using an annotated service object:\nsb.annotatedService(new Object() {\n    @Get("/greet2/:name") // `:name` style is also available\n    public HttpResponse greet(@Param("name") String name) {\n        return HttpResponse.of("Hello, %s!", name);\n    }\n});\n\n// Just in case your name contains a slash:\nsb.serviceUnder("/greet3", (ctx, req) -> {\n    String path = ctx.mappedPath();  // Get the path without the prefix (\'/greet3\')\n    String name = path.substring(1); // Strip the leading slash (\'/\')\n    return HttpResponse.of("Hello, %s!", name);\n});\n\n// Using an annotated service object:\nsb.annotatedService(new Object() {\n    @Get("regex:^/greet4/(?<name>.*)$")\n    public HttpResponse greet(@Param("name") String name) {\n        return HttpResponse.of("Hello, %s!", name);\n    }\n});\n\n// Using a query parameter (e.g. /greet5?name=alice) on an annotated service object:\nsb.annotatedService(new Object() {\n    @Get("/greet5")\n    public HttpResponse greet(@Param("name") String name,\n                              @Param("title") @Default("Mr.") String title) {\n        // "Mr." is used by default if there is no title parameter in the request.\n        return HttpResponse.of("Hello, %s %s!", title, name);\n    }\n});\n\n// Getting a map of query parameters on an annotated service object:\nsb.annotatedService(new Object() {\n    @Get("/greet6")\n    public HttpResponse greet(QueryParams params) {\n        return HttpResponse.of("Hello, %s!", params.get("name"));\n    }\n});\n\n// Using media type negotiation:\nsb.annotatedService(new Object() {\n    @Get("/greet7")\n    @Produces(MediaTypeNames.JSON_UTF_8)\n    public HttpResponse greetGet(@Param("name") String name) {\n        return HttpResponse.of(HttpStatus.OK, MediaType.JSON_UTF_8,\n                               "{\\"name\\":\\"%s\\"}", name);\n    }\n\n    @Post("/greet7")\n    @Consumes(MediaTypeNames.FORM_DATA)\n    public HttpResponse greetPost(@Param("name") String name) {\n        return HttpResponse.of(HttpStatus.OK);\n    }\n});\n\nServer server = sb.build();\nCompletableFuture<Void> future = server.start();\nfuture.join();\n'})}),"\n",(0,a.jsxs)(r.p,{children:["As described in the example, ",(0,a.jsx)(r.code,{children:"service()"})," and ",(0,a.jsx)(r.code,{children:"serviceUnder()"})," perform an exact match and a prefix match\non a request path respectively. ",(0,a.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServerBuilder.html",children:"ServerBuilder"})," also provides advanced path mapping such as regex and\nglob pattern matching."]}),"\n",(0,a.jsxs)(r.p,{children:["Also, we decorated the second service using ",(0,a.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/logging/LoggingService.html",children:"LoggingService"}),", which logs all requests and responses.\nYou might be interested in decorating a service using other decorators, for example to gather metrics."]}),"\n",(0,a.jsxs)(r.p,{children:["You can also use an arbitrary object that's annotated by the ",(0,a.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/annotation/Path.html",children:"@Path"})," annotation\nusing ",(0,a.jsx)(r.code,{children:"annotatedService()"}),"."]}),"\n",(0,a.jsx)(r.h2,{id:"path-patterns",children:"Path patterns"}),"\n",(0,a.jsx)(r.p,{children:"You can use the following path patterns to map an HTTP request path to a service or a decorator."}),"\n",(0,a.jsxs)(r.table,{children:[(0,a.jsx)(r.thead,{children:(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.th,{children:"Pattern"}),(0,a.jsx)(r.th,{children:"Example"})]})}),(0,a.jsxs)(r.tbody,{children:[(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.td,{children:"Exact match"}),(0,a.jsxs)(r.td,{children:[(0,a.jsx)(r.code,{children:"/foo/bar"})," or ",(0,a.jsx)(r.code,{children:"exact:/foo/bar"})]})]}),(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.td,{children:"Curly-brace style path variables"}),(0,a.jsx)(r.td,{children:(0,a.jsx)(r.code,{children:"/users/{userId}"})})]}),(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.td,{children:"Colon style path variables"}),(0,a.jsx)(r.td,{children:(0,a.jsx)(r.code,{children:"/list/:productType/by/:ordering"})})]}),(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.td,{children:"Prefix match"}),(0,a.jsx)(r.td,{children:(0,a.jsx)(r.code,{children:"prefix:/files"})})]}),(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.td,{children:"Glob pattern"}),(0,a.jsx)(r.td,{children:(0,a.jsx)(r.code,{children:"glob:/*/downloads/**"})})]}),(0,a.jsxs)(r.tr,{children:[(0,a.jsx)(r.td,{children:"Regular expression"}),(0,a.jsx)(r.td,{children:(0,a.jsx)(r.code,{children:"regex:^/files/(?<filePath>.*)$"})})]})]})]}),"\n",(0,a.jsxs)(r.admonition,{type:"tip",children:[(0,a.jsx)(r.p,{children:"By default, colon style path variables assume that a path segment starting with a ':' is a parameter name.\nIf the colon starting a path segment should signify a literal, you can prefix the ':' with '\\'."}),(0,a.jsx)(r.p,{children:"e.g."}),(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"/foo/\\\\:colon:"})," will match a request with path ",(0,a.jsx)(r.code,{children:"/foo/:colon:"}),".","\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"Note that only the first colon starting the segment should be escaped."}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(r.li,{children:[(0,a.jsx)(r.code,{children:"/foo/:colon"})," will match a request with path ",(0,a.jsx)(r.code,{children:"/foo/bar"}),". The path parameter 'colon' will be bound to 'bar'."]}),"\n"]})]}),"\n",(0,a.jsx)(r.h2,{id:"per-service-configuration",children:"Per service configuration"}),"\n",(0,a.jsx)(r.p,{children:"The examples above are just mapping the path of an HTTP request on a service. If you want to set configuration\nfor a specific service, you can use fluent API:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-java",children:'ServerBuilder sb = Server.builder();\nsb.route()                    // Configure the service.\n  .post("/foo/bar")           // Matched when the path is "/foo/bar" and the method is POST.\n  .consumes(MediaType.JSON)   // Matched when the "content-type" header is "application/json".\n  .produces(MediaType.JSON)   // Matched when the "accept" headers is "application/json".\n  .matchesHeaders("baz=qux")  // Matched when the "baz" header is "qux".\n  .matchesParams("quux=quuz") // Matched when the "quux" parameter is "quuz".\n  .requestTimeoutMillis(5000)\n  .maxRequestLength(8192)\n  .verboseResponses(true)\n  .build((ctx, req) -> HttpResponse.of(OK)); // Should call to finish and return to the ServerBuilder.\n'})}),"\n",(0,a.jsxs)(r.p,{children:["Or use a ",(0,a.jsx)(r.code,{children:"Consumer"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.HttpMethod;\n\nServerBuilder sb = Server.builder();\nsb.withRoute(builder -> builder.path("/baz") // Matched when the path is "/baz".\n                               // Matched when the method is GET or POST.\n                               .methods(HttpMethod.GET, HttpMethod.POST)\n                               ...\n                               .build((ctx, req) -> HttpResponse.of(OK)));\n'})}),"\n",(0,a.jsx)(r.h2,{id:"ssltls",children:"SSL/TLS"}),"\n",(0,a.jsx)(r.p,{children:"You can also add an HTTPS port with your certificate and its private key files:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-java",children:'ServerBuilder sb = Server.builder();\nsb.https(8443)\n  .tls(new File("certificate.crt"), new File("private.key"), "myPassphrase");\n...\n'})}),"\n",(0,a.jsx)(r.h2,{id:"proxy-protocol",children:"PROXY protocol"}),"\n",(0,a.jsxs)(r.p,{children:["Armeria supports both text (v1) and binary (v2) versions of\n",(0,a.jsx)(r.a,{href:"https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt",children:"PROXY protocol"}),".\nIf your server is behind a load balancer such as ",(0,a.jsx)(r.a,{href:"https://www.haproxy.org/",children:"HAProxy"})," and\n",(0,a.jsx)(r.a,{href:"https://aws.amazon.com/elasticloadbalancing/",children:"AWS ELB"}),", you could consider enabling the PROXY protocol:"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-java",children:"import static com.linecorp.armeria.common.SessionProtocol.HTTP;\nimport static com.linecorp.armeria.common.SessionProtocol.HTTPS;\nimport static com.linecorp.armeria.common.SessionProtocol.PROXY;\n\nServerBuilder sb = Server.builder();\nsb.port(8080, PROXY, HTTP);\nsb.port(8443, PROXY, HTTPS);\n...\n"})}),"\n",(0,a.jsx)(r.h2,{id:"serving-http-and-https-on-the-same-port",children:"Serving HTTP and HTTPS on the same port"}),"\n",(0,a.jsx)(r.p,{children:"For whatever reason, you may have to serve both HTTP and HTTPS on the same port. Armeria is one of the few\nimplementations that supports port unification:"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-java",children:"ServerBuilder sb = Server.builder();\nsb.port(8888, HTTP, HTTPS);\n// Enable PROXY protocol, too.\nsb.port(9999, PROXY, HTTP, HTTPS);\n...\n"})}),"\n",(0,a.jsx)(r.h2,{id:"virtual-hosts",children:"Virtual hosts"}),"\n",(0,a.jsxs)(r.p,{children:["Use ",(0,a.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServerBuilder.html#virtualHost(java.lang.String)",children:"ServerBuilder#virtualHost(String)"})," to configure ",(0,a.jsx)(r.a,{href:"https://en.wikipedia.org/wiki/Virtual_hosting#Name-based",children:"a name-based virtual host"}),":"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-java",children:'ServerBuilder sb = Server.builder();\n// Configure foo.com.\nsb.virtualHost("foo.com")\n  .service(...)\n  .tls(...)\n  .and() // Configure *.bar.com.\n  .virtualHost("*.bar.com")\n  .service(...)\n  .tls(...)\n  .and() // Configure the default virtual host.\n  .service(...)\n  .tls(...);\n...\n'})}),"\n",(0,a.jsx)(r.h2,{id:"getting-an-ip-address-of-a-client-who-initiated-a-request",children:"Getting an IP address of a client who initiated a request"}),"\n",(0,a.jsxs)(r.p,{children:["You may want to get an IP address of a client who initiated a request in your service. In that case,\nyou can use ",(0,a.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html#clientAddress()",children:"ServiceRequestContext#clientAddress()"}),". But you need to configure\nyour ",(0,a.jsx)(r.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServerBuilder.html",children:"ServerBuilder"})," before doing that:"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-java",children:'import com.linecorp.armeria.common.util.InetAddressPredicates;\nimport com.linecorp.armeria.server.ClientAddressSource;\n\nServerBuilder sb = Server.builder();\n\n// Configure a filter which evaluates whether an address of a remote endpoint is\n// trusted. If unspecified, no remote endpoint is trusted.\n// e.g. servers who have an IP address in 10.0.0.0/8.\nsb.clientAddressTrustedProxyFilter(InetAddressPredicates.ofCidr("10.0.0.0/8"));\n\n// Configure a filter which evaluates whether an address can be used as\n// a client address. If unspecified, any address would be accepted.\n// e.g. public addresses\nsb.clientAddressFilter(address -> !address.isSiteLocalAddress());\n\n// Configure a list of sources which are used to determine where to look for\n// the client address, in the order of preference. If unspecified, \'Forwarded\',\n// \'X-Forwarded-For\' and the source address of a PROXY protocol header would be used.\nsb.clientAddressSources(ClientAddressSource.ofHeader(HttpHeaderNames.FORWARDED),\n                        ClientAddressSource.ofHeader(HttpHeaderNames.X_FORWARDED_FOR),\n                        ClientAddressSource.ofProxyProtocol());\n\n// Get an IP address of a client who initiated a request.\nsb.service("/", (ctx, res) ->\n        HttpResponse.of("A request was initiated by %s!",\n                        ctx.clientAddress().getHostAddress()));\n'})}),"\n",(0,a.jsx)(r.h2,{id:"see-also",children:"See also"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:(0,a.jsx)(r.a,{href:"/docs/server/decorator",children:"Decorating a service"})}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,a.jsx)(r,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}}}]);