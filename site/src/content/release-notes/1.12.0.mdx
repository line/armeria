---
date: 2021-10-07
---

# v1.12.0

## ðŸŒ¸ Highlights

- You can now enable [HTTP/JSON to GRPC transcoding](https://cloud.google.com/endpoints/docs/grpc/transcoding)
  in your [GrpcService](type). #3786

  ```java
  GrpcService.builder()
             .addService(helloService)
             .enableHttpJsonTranscoding(true) // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
             .build();
  ```

  :::tip

  HTTP/JSON transcoding is currently experimental. We're looking forward to your feedback.

  :::

{/* truncate */}

## ðŸŒŸ New features

- You can now bind a virtual host to a specific port. #3798 #3833
  ```java
  Server.builder()
        .http(8080)
        .http(18080)
        // Bind the virtual host to 18080 port.
        .virtualHost(18080).service("/health", healthCheckService) // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
                           .serviceUnder("/secret/", secretService)
        .and()
        ...
  ```
- You can now customize any HTTP error status responses including a decoder-level error and
  [HttpStatusException](type). #3822 #3853

  ```java
  ServerBuilder sb = ...
  sb.errorHandler(new ServerErrorHandler() {
      @Override
      public HttpResponse onServiceException(ServiceRequestContext ctx, Throwable cause) {
          // Convert an error that is raised in a service or a decorator.
          if (cause instanceof IllegalArgumentException) {
              return HttpResponse.of(HttpStatus.BAD_REQUEST);
          }
          ...
      }

      @Override
      public AggregatedHttpResponse onProtocolViolation(ServiceConfig config,
                                                        HttpStatus status,
                                                        @Nullable String description,
                                                        @Nullable Throwable cause) {
          // Convert the decoder-level error.
          if (status == HttpStatus.REQUEST_ENTITY_TOO_LARGE) {
              return AggregatedHttpResponse.of(HttpStatus.BAD_REQUEST);
          }
          ...
      }

      @Override
      public AggregatedHttpResponse renderStatus(ServiceConfig config,
                                                 HttpStatus status,
                                                 @Nullable String description,
                                                 @Nullable Throwable cause) {
          // Convert the given error status and cause.
          ...
      }
  })
  ```

- You can now share [ConcurrencyLimit](type) between [ConcurrencyLimitingClient](type). #3478 #3753 #3860

  ```java
  ConcurrencyLimit limit = ConcurrencyLimit.of(64); // Can send 64 requests concurrently.

  WebClient client1 = WebClient
    .builder(...)
    .decorator(ConcurrencyLimitingClient.newDecorator(limit))
    .build(...);

  WebClient client2 = WebClient
    .builder(...)
    .decorator(ConcurrencyLimitingClient.newDecorator(limit))
    // different options
    ...
    .build(...);
  ```

- You can now allow all headers in `Access-Control-Request-Headers` from a
  [preflight request](https://developer.mozilla.org/en-US/docs/Glossary/Preflight_request) using
  [CorsServiceBuilder#allowAllRequestHeaders(boolean)](type). #3839 #3843
  ```java
  ServerBuilder sb = ...
  sb.service("/cors", myService.decorate(CorsService.builder("http://example.com")
                                                    .allowRequestMethods(HttpMethod.GET)
                                                    .allowAllRequestHeaders(true) // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
                                                    .newDecorator()));
  ```

  - Specifying `*` in `Access-Control-Allow-Headers` does not work with
    [certain browsers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Headers#browser_compatibility)
    so you should use [CorsServiceBuilder#allowAllRequestHeaders(boolean)](type) to allow all headers.
- You can now sanitize the preview of a request or a response. #3791 #3795
  ```java
  ContentPreviewingService.builder(ContentPreviewerFactory.text(100))
                          .requestPreviewSanitizer(requestPreviewSanitizer) // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
                          .responsePreviewSanitizer(responsePreviewSanitizer) // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
                          .newDecorator();
  ```
- A compressed file is automatically decompressed if [FileServiceBuilder#autoDecompress(boolean)](type)
  is set to `true`. #3804 #3810
  ```java
  FileService.builder(FileServiceBuilderTest.class.getClassLoader(), "/")
             .serveCompressedFiles(true) // This should be set to true to serve compressed files.
             .autoDecompress(true) // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
             .build();
  ```
- You can now send a delayed [HttpResponse](type) using [HttpResponse#delayed(Supplier,Duration)](type).
  #3698 #3770
  ```java
  Supplier<HttpResponse> responseSupplier = ...
  HttpResponse.delayed(responseSupplier, Duration.ofSeconds(5)); // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
  ```
- You can now specify different blocking task executors for different [HttpService](type) using
  [ServiceBindingBuilder](type). #3740 #3754
  ```java
  Server.builder()
        .route()
        .get("/foo")
        .blockingTaskExecutor(fooExecutor) // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
        .build(fooService)
        .route()
        .get("/bar")
        .blockingTaskExecutor(barExecutor) // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
        .build(barService)
        .build()
  ```
- You can now specify an [AuthToken](type) when building a [HealthCheckedEndpointGroup](type). #3809
  ```java
  HealthCheckedEndpointGroup.builder(endpointGroup, "/health")
                            .auth(AuthToken.ofOAuth2("..."))
                            .build();
  ```
- You can now export different properties for different [RequestContextExportingAppender](typeplural) to log
  with [Logback](http://logback.qos.ch). #3775 #3769

  ```xml
  // logback.xml
  <appender name="RCEA1" class="com.linecorp.armeria.common.logback.RequestContextExportingAppender">
    ...
    <export>remote.ip</export>
  </appender>

  <appender name="RCEA2" class="com.linecorp.armeria.common.logback.RequestContextExportingAppender">
    ...
    <export>remote.port</export>
  </appender>
  ```

- You can now log HTTP/2 frames using the frame loggers. #3817
  ```xml
  <!-- logback.xml -->
  <logger name="com.linecorp.armeria.logging.traffic.server.http2" level="TRACE" />
  <logger name="com.linecorp.armeria.logging.traffic.client.http2" level="TRACE" />
  ```

### gRPC

- You can now use [UnframedGrpcErrorHandler](type) to map a non-OK gRPC status to an [HttpResponse](type)
  in an unframed gRPC service. #3777 #3782
  ```java
  GrpcService.builder()
             .addService(grpcService)
             .enableUnframedRequests(true) // This should be set to true to enable UnframedGrpcService.
             .unframedGrpcErrorHandler(UnframedGrpcErrorHandler.of()) // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
             .build();
  ```

### Kotlin

- You can now use Kotlin [Flow](https://kotlinlang.org/docs/flow.html) as a return type in an annotated service.
  #3756 #3768
  ```kotlin
  @Get("/members")
  @ProducesJson
  fun listMembers() = flow { // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
      emit(Member(name = "foo", age = 10))
      emit(Member(name = "bar", age = 20))
      emit(Member(name = "baz", age = 30))
  }
  ```

### Spring integration

- You can now configure an internal port with a Spring property file. #3798 #3833
  ```yaml
  armeria:
    ports:
      - port: 8080
    internal-services:
      # Prometheus exposition and health check service will be
      # exposed to 18080 port. The requests to 8080 port will return 404 Not Found.
      include: metrics, health
      port: 18080 # ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
      protocols: http
  ```
- You can now specify all parameters of [ServerBuilder](type) with a Spring property file. #3705 #3735
  ```yaml
  armeria:
    ports:
      - port: 0
    max-num-connections: 8
    idle-timeout: 2s
    ping-interval: 1s
    max-connection-age: 4s
    max-num-requests-per-connection: 4
    http2-initial-connection-window-size: 2mb
    http2-initial-stream-window-size: 4mb
    http2-max-streams-per-connection: 1
    ...
  ```

### GraphQL

- You can now specify a `GraphQLSchema` or `schemaUrls` when building a [GraphQlService](type). #3708 #3815
  ```java
  GraphQLSchema schema = ...
  sb.service("/graphql", GraphqlService.builder()
                                       .schema(schema) // ðŸ‘ˆðŸ‘ˆðŸ‘ˆ
                                       ...
                                       .build());
  ```

## ðŸ“ƒ Documentation

- You can now learn [how to write a streaming response](https://armeria.dev/docs/advanced-streaming-backpressure)
  using backpressure. #3397 #3847

## ðŸ“ˆ Improvements

- [ServiceRequestContext](type) is now automatically propagated to other dispatchers
  over [Kotlin Coroutines](https://kotlinlang.org/docs/coroutines-overview.html) when
  using annotated and gRPC services. #3745 #3849
- [JettyService](type) and [TomcatService](type) can now run the Servlets that
  depends on the TLS attributes. #3850

## ðŸ› ï¸ Bug fixes

- [ServerConfig#server()](type) doesn't raise an `IllegalStateException` anymore
  after [Server#reconfigure(ServerConfigurator)](type) is called. #3853
- The [RequestLog](type) is complete on the server-side even when an exception is raised and deferred values
  are not set. #3823
- [ResponseConverterFunctionProvider](type) now correctly works for suspending functions whose return type is
  [HttpResult](type) in Kotlin. #3844
- `%2F` and `%2f` are no longer converted to `/` when decoding a request path. #3855
- [ExceptionHandlerFunction](type) of an annotated service now correctly handles exceptions raised by
  service decorators. #3835
- You can now correctly send additional response headers even if the request has failed. #3836
- The [RequestLog](type) is complete on the server-side even when an exception is raised and deferred values
  are not set. #3823
- The failed request to a [TransientService](type) is now logged properly. #3818
- You no longer see a pseudo request header in a response headers. #3801
- You no longer see a [ClosedSessionException](type) when a server gracefully shut down an HTTP/2 connection.
  #3825
- A response headers of a [GrpcService](type) is now correctly sent when the first response frame
  is sent. #3856
- [GrpcService](type) now correctly invokes `Server.Listener` in order. #3805
- gRPC client calls are now closed exactly once. #3799 #3800
- Throwing an [ArmeriaStatusException](type) now overrides the gRPC status code and description as expected.
  #3838

## ðŸšï¸ Deprecations

- [SamlAssertionConsumerConfigBuilder#endpoint(SamlEndpoint)](type) is deprecated. #3813
  - Use [SamlServiceProviderBuilder#acs(SamlEndpoint)](type) instead.

## â˜¢ï¸ Breaking changes

- `ExceptionHandler` is now gone. #3853
  - Use [ServerErrorHandler](type) instead.

## â›“ Dependencies

- Bucket4j 6.2.0 â†’ 6.3.0
- Dropwizard 2.0.24 â†’ 2.0.25
- Dropwizard metrics 4.2.3 â†’ 4.2.4
- GraphQL-Java 17.1 â†’ 17.3
- gRPC-Java 1.40.1 â†’ 1.41.0
- Jackson 2.12.4 â†’ 2.13.0
- java-jwt 3.18.1 â†’ 3.18.2
- Kotlin 1.5.10 â†’ 1.5.21
- Kafka 2.8.0 -> 3.0.0
- Kotlin 1.5.21 â†’ 1.5.31
- Kotlin Coroutines 1.5.1 â†’ 1.5.2
- Logback 1.2.5 â†’ 1.2.6
- Micrometer 1.7.3 â†’ 1.7.4
- Netty 4.1.66 â†’ 4.1.68
- netty-tcnative-boringssl-static 2.0.40 â†’ 2.0.43
- Prometheus simpleclient 0.11.0 â†’ 0.12.0
- Reactor 3.4.9 â†’ 3.4.10
- RESTEasy 4.7.1 â†’ 4.7.2
- RxJava 3.1.0 â†’ 3.1.1
- scala-java8-compat 1.0.0 â†’ 1.0.1
- Spring 5.3.9 â†’ 5.3.10
- Spring Boot 2.5.4 â†’ 2.5.5
- Thrift 0.14.2 â†’ 0.15.0
- Tomcat 9.0.46 â†’ 9.0.53

## ðŸ™‡ Thank you

<ThankYou
  usernames={[
    'anuraaga',
    'berry120',
    'fantayeneh',
    'freevie',
    'ghkim3221',
    'heowc',
    'ikhoon',
    'jasper-vandemalle',
    'jrhee17',
    'kezhenxu94',
    'ks-yim',
    'minwoox',
    'TheWeaVer',
    'trustin',
    'vivekkothari',
  ]}
/>
