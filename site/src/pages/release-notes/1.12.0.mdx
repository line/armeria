---
date: 2021-10-05
---

## ğŸŒŸ New features

- You can now bind a virtual host to a specific port. #3798 #3833
  ```java
  Server.builder()
        .http(8080)
        .http(18080)
        // Bind the virtual host to 18080 port.
        .virtualHost(18080).service("/health", healthCheckService) // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ
                           .serviceUnder("/secret/", secretService)
        .and()
  ```
  - You can now configure an internal port with a Spring property file when using Spring integration module.
    ```yaml
    armeria:
      ports:
        - port: 8080
      internal-services:
        # Prometheus exposition and health check service will be
        # exposed to 18080 port. The requests to 8080 port will return 404 Not Found.
        include: metrics, health
        port: 18080 // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ
        protocols: http
    ```
- You can now use Kotlin [Flow](https://kotlinlang.org/docs/flow.html) as a return type in an annotated service.
  #3756 #3768
  ```kotlin
  @Get("/members")
  @ProducesJson
  fun listMembers() = flow { // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ
      emit(Member(name = "foo", age = 10))
      emit(Member(name = "bar", age = 20))
      emit(Member(name = "baz", age = 30))
  }
  ```
- You can now sanitize the preview of a request or a response. #3791 #3795
  ```java
  ContentPreviewingService.builder(ContentPreviewerFactory.text(100))
                          .requestContentSanitizer(requestContentSanitizer) // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ
                          .responseContentSanitizer(responseContentSanitizer) // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ
                          .newDecorator();
  ```
- You can now use <type://UnframedGrpcErrorHandler> to map a non-OK gRPC status to an <type://HttpResponse>
  in an unframed gRPC service. #3777 #3782
  ```java
  GrpcService.builder()
             .addService(grpcService)
             .enableUnframedRequests(true) // This should be set to true to enable UnframedGrpcService.
             .unframedGrpcErrorHandler(UnframedGrpcErrorHandler.of()) // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ
             .build();
  ```
- A compressed file is automatically decompressed if <type://FileServiceBuilder#autoDecompress(boolean)>
  is set to `true`. #3804 #3810
  ```java
  FileService.builder(FileServiceBuilderTest.class.getClassLoader(), "/")
             .serveCompressedFiles(true) // This should be set to true to serve compressed files.
             .autoDecompress(true) // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ
             .build();
  ```
- You can now specify all parameters of <type://ServerBuilder> with a Spring property file when using
  Spring integration module. #3705 #3735
  ```yaml
  armeria:
    ports:
      - port: 0
    max-num-connections: 8
    idle-timeout: 2s
    ping-interval: 1s
    max-connection-age: 4s
    max-num-requests-per-connection: 4
    http2-initial-connection-window-size: 2mb
    http2-initial-stream-window-size: 4mb
    http2-max-streams-per-connection: 1
    ...
  ```
- You can now send a delayed <type://HttpResponse> using <type://HttpResponse#delayed(Supplier,Duration)>.
  #3698 #3770
  ```java
  Supplier<HttpResponse> responseSupplier = ...
  HttpResponse.delayed(responseSupplier, Duration.ofSeconds(5)); // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ
  ```
- You can now specify different blocking task executors for different <type://HttpService> using
  <type://ServiceBindingBuilder>. #3740 #3754
  ```java
  Server.builder()
        .route()
        .get("/foo")
        .blockingTaskExecutor(fooExecutor) // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ
        .build(fooService)
        .route()
        .get("/bar")
        .blockingTaskExecutor(barExecutor) // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ
        .build(barService)
        .build()
  ```
- You can now specify an <type://AuthToken> when building a <type://HealthCheckedEndpointGroup>. #3809
  ```java
  HealthCheckedEndpointGroup.builder(endpointGroup, "/health")
                            .auth(AuthToken.ofOAuth2("..."))
                            .build();
  ```
- You can now export different properties for different <typeplural://RequestContextExportingAppender> to log
  with [Logback](http://logback.qos.ch). #3775 #3769
  ```xml
  // logback.xml
  <appender name="RCEA1" class="com.linecorp.armeria.common.logback.RequestContextExportingAppender">
    ...
    <export>remote.ip</export>
  </appender>

  <appender name="RCEA2" class="com.linecorp.armeria.common.logback.RequestContextExportingAppender">
    ...
    <export>remote.port</export>
  </appender>
  ```
- You can now specify a `GraphQLSchema` or `schemaUrls` when building a <type://GraphQlService>. #3708 #3815
  ```java
  GraphQLSchema schema = ...
  sb.service("/graphql", GraphqlService.builder()
                                       .schema(schema) // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ
                                       ...
                                       .build());
  ```
- You can now log HTTP/2 frames using the frame loggers. #3817
  ```xml
  <!-- logback.xml -->
  <logger name="com.linecorp.armeria.logging.traffic.server.http2" level="DEBUG" />
  <logger name="com.linecorp.armeria.logging.traffic.client.http2" level="DEBUG" />
  ```
  For example:
## ğŸ“ˆ Improvements

- You can now learn how to write a streaming response using backpressure. #3397

## ğŸ› ï¸ Bug fixes

- <type://ExceptionHandlerFunction> of an annotated service now correctly handles exceptions raised by
  service decorators. #3835
- You can now correctly send additional response headers even if the request has failed. #3836
- You no longer see a pseudo request header in a response headers. #3801
- You no longer see a <type://ClosedSessionException> when a server gracefully shut down an HTTP/2 connection.
  #3825
- <type://GrpcService> now correctly invokes `Server.Listener` in order. #3805
- gRPC client calls are now closed exactly once. #3799 #3800
- Throwing an <type://ArmeriaStatusException> now overrides the gRPC status code and description as expected.
  #3838
- The <type://RequestLog> is complete on the server-side even when an exception is raised and deferred values
  are not set. #3823
- The failed response to a <type://TransientService> is now logged properly. #3818

## ğŸšï¸ Deprecations

- <type://SamlAssertionConsumerConfigBuilder#acs()> is deprecated. #3813
  - Use <type://SamlAssertionConsumerConfigBuilder#acs(SamlEndpoint)> instead.

## â˜¢ï¸ Breaking changes

- N/A

## â›“ Dependencies

- Dropwizard 2.0.24 â†’ 2.0.25
- Fastutil 8.5.4 â†’ 8.5.6
- GraphQL-Java 17.1 â†’ 17.3
- gRPC-Java 1.40.1 â†’ 1.41.0
- Jackson 2.12.4 â†’ 2.12.5
- Kotlin 1.5.10 â†’ 1.5.21
- Java-jwt 3.18.1 â†’ 3.18.2
- Kafka 2.8.0 -> 3.0.0
- Kotlin 1.5.21 â†’ 1.5.31
- Kotlin Coroutines 1.5.1 â†’ 1.5.2
- Logback 1.2.5 â†’ 1.2.6
- Netty 4.1.66 â†’ 4.1.68
- netty-tcnative-boringssl-static 2.0.40 â†’ 2.0.43
- Prometheus simpleclient 0.11.0 â†’ 0.12.0
- Reactor 3.4.9 â†’ 3.4.10
- RESTEasy 4.7.1 â†’ 4.7.2
- RxJava 3.1.0 â†’ 3.1.1
- Scala-java8-compat 1.0.0 â†’ 1.0.1
- Spring 5.3.9 â†’ 5.3.10
- Spring Boot 2.5.4 â†’ 2.5.5
- Thrift 0.14.2 â†’ 0.15.0
- Tomcat 9.0.46 â†’ 9.0.53

## ğŸ™‡ Thank you

<ThankYou usernames={[
  'anuraaga',
  'freevie',
  'ghkim3221',
  'heowc',
  'jrhee17',
  'kezhenxu94',
  'ks-yim',
  'ikhoon',
  'minwoox',
  'TheWeaVer',
  'trustin',
  'Vivek Kothari'
]} />
