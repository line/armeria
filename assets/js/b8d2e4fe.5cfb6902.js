"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[663],{5866:e=>{e.exports=JSON.parse('{"permalink":"/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2016-08-04-applying-circuitbreaker-to-channel-gateway.mdx","source":"@site/src/content/blog/en/2016-08-04-applying-circuitbreaker-to-channel-gateway.mdx","title":"Applying CircuitBreaker to Channel Gateway","description":"Before reading","date":"2016-08-04T00:00:00.000Z","tags":[],"readingTime":7.23,"hasTruncateMarker":true,"authors":[{"name":"Shin Jong Hun","title":"I don\u2019t like being inconvenienced. One of the focal points of my work is to reduce these inconveniences so I have more time to focus on what matters. I think that\u2019s why I like programming. Although I can\u2019t really figure out why I seem to be getting busier with time\u2026","imageURL":"/img/author-shinjonghun.png","key":"shinjonghun","page":null}],"frontMatter":{"authors":["shinjonghun"],"other_languages":{"ja":"/blog/ja/2016/08/04/applying-circuitbreaker-to-channel-gateway","ko":"/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway"}},"unlisted":false,"prevItem":{"title":"Making a basic server with Java & Armeria","permalink":"/blog/2018/09/13/making-a-basic-server-with-java-armeria"},"nextItem":{"title":"Circuit breakers for distributed services","permalink":"/blog/2016/07/24/circuit-breakers-for-distributed-services"}}')},17282:(e,t,r)=>{r.d(t,{A:()=>i});const i=r.p+"assets/images/applying-circuitbreaker-to-channel-gateway-1-537a3aa178c1835906c7a42d541dac55.png"},28453:(e,t,r)=>{r.d(t,{R:()=>a,x:()=>o});var i=r(96540);const n={},s=i.createContext(n);function a(e){const t=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:a(e.components),i.createElement(s.Provider,{value:t},e.children)}},98908:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>l});var i=r(5866),n=r(74848),s=r(28453);const a={authors:["shinjonghun"],other_languages:{ja:"/blog/ja/2016/08/04/applying-circuitbreaker-to-channel-gateway",ko:"/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway"}},o="Applying CircuitBreaker to Channel Gateway",c={authorsImageUrls:[void 0]},l=[{value:"Before reading",id:"before-reading",level:2},{value:"Applying CircuitBreaker to Channel Gateway",id:"applying-circuitbreaker-to-channel-gateway",level:2},{value:"Annotation for CircuitBreaker",id:"annotation-for-circuitbreaker",level:2},{value:"Implementing proceed() for CircuitBreaker",id:"implementing-proceed-for-circuitbreaker",level:2},{value:"Methods used to change settings for CircuitBreaker",id:"methods-used-to-change-settings-for-circuitbreaker",level:2},{value:"Closing words",id:"closing-words",level:2},{value:"About the author",id:"about-the-author",level:2}];function d(e){const t={a:"a",code:"code",em:"em",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h2,{id:"before-reading",children:"Before reading"}),"\n",(0,n.jsxs)(t.p,{children:["If you have yet to read the introductory article to circuit breakers, I recommend you read the following article first: ",(0,n.jsx)(t.a,{href:"/blog/2016/07/24/circuit-breakers-for-distributed-services",children:"Circuit Breakers for distributed services"})]}),"\n",(0,n.jsx)(t.h2,{id:"applying-circuitbreaker-to-channel-gateway",children:"Applying CircuitBreaker to Channel Gateway"}),"\n",(0,n.jsx)(t.p,{children:"Channel Gateway servers provide various LINE server features to content providers.\nThis is why Channel Gateway servers are highly affected by the servers they are connected to, with the effects easily spreading across all Channel Gateway servers."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{src:r(17282).A+"",width:"870",height:"328"})}),"\n","\n",(0,n.jsx)(t.p,{children:"It was when I was struggling to think of a solution to this problem that I first heard about circuit breakers.\nCircuit breakers seem to be what I was looking for since they are able to detect a problem in certain servers, blocking all requests that the server would have otherwise received.\nWith that in mind, I decided to apply circuit breakers on Channel Gateway."}),"\n",(0,n.jsxs)(t.p,{children:["While I could have implemented my own circuit breakers on Channel Gateway, there were already excellent circuit breakers on ",(0,n.jsx)(t.a,{href:"http://line.github.io/armeria",children:"Armeria"}),".\nArmeria enables you to set various options on circuit breakers when you implement them using ",(0,n.jsx)(t.code,{children:"CircuitBreakerBuilder"}),", generating your own ",(0,n.jsx)(t.code,{children:"CircuitBreaker"})," object as a result.\nI was able to easily apply a customized circuit breaker on Channel Gateway thanks to this system."]}),"\n",(0,n.jsx)(t.h2,{id:"annotation-for-circuitbreaker",children:"Annotation for CircuitBreaker"}),"\n",(0,n.jsxs)(t.p,{children:["I was able to apply ",(0,n.jsx)(t.code,{children:"CircuitBreaker"})," to the talk-channel-gateway source code with a ",(0,n.jsx)(t.code,{children:"@CircuitBreakable"})," annotation."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"@CircuitBreakable(CircuitBreakerGroup.HBASE_CLIENT_USER_SETTINGS)\npublic ChannelSettings findBy(String mid) {\n    ...\n}\n"})}),"\n",(0,n.jsxs)(t.p,{children:["If applied like the example above, ",(0,n.jsx)(t.code,{children:"CircuitBreaker"})," opens and closes depending on the results gathered while monitoring the successful/failed call attempts on the findBy() method.\nHBASE_CLIENT_USER_SETTINGS is used to specify the groups grouped by ",(0,n.jsx)(t.code,{children:"CircuitBreaker"}),", calculating the group's percentage of failed calls out of the successful calls on methods, and opening and closing along with ",(0,n.jsx)(t.code,{children:"CircuitBreaker"}),".\nYou can change the options for ",(0,n.jsx)(t.code,{children:"CircuitBreaker"})," with the enum object called ",(0,n.jsx)(t.code,{children:"CircuitBreakerGroup"})," as shown below."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"public enum CircuitBreakerGroup implements ExceptionFilter {\n\n    SAMPLE_DEFAULT {\n    },\n    SAMPLE_API {\n        @Override\n        protected ExceptionFilter exceptionFilter() {\n            return cause -> !(cause instanceof AuthenticationException\n                              || cause instanceof ApiPermissionException\n                              || cause instanceof ImproperRequestException);\n        }\n    },\n    HBASE_CLIENT_CHANNEL_MATRIX {\n    },\n    HBASE_CLIENT_USER_SETTINGS {\n    };\n\n    protected ExceptionFilter exceptionFilter() {\n        return cause -> true;\n    }\n\n    public CircuitBreaker circuitBreaker(CircuitBreakerListener listener) {\n        return new `CircuitBreakerBuilder`(name()).exceptionFilter(exceptionFilter())\n                                                .listener(listener)\n                                                .build();\n    }\n\n    @Override\n    public boolean shouldDealWith(Throwable throwable) throws Exception {\n        return exceptionFilter().shouldDealWith(throwable);\n    }\n}\n"})}),"\n",(0,n.jsxs)(t.p,{children:["I used a customized ",(0,n.jsx)(t.code,{children:"ExceptionFilter"})," on Channel Gateway, while other options were kept at their default values from Armeria.\nYou can change options to your needs by modifying the ",(0,n.jsx)(t.code,{children:"circuitBreaker()"})," method."]}),"\n",(0,n.jsxs)(t.p,{children:["The default Armeria settings are set to identify any exception as a failure.\nHowever, Channel Gateway also treats any unauthorized accesses as exceptions, and there needed to be a distinction between these and the relevant exceptions.\nThat's why I had to customize ",(0,n.jsx)(t.code,{children:"ExceptionFilter"}),".\nI also added an event listener for Channel Gateway so that logs would be recorded each time a change is detected in ",(0,n.jsx)(t.code,{children:"CircuitBreaker"}),"."]}),"\n",(0,n.jsx)(t.p,{children:"The groups applied to annotations can be specified using the enum object, and you can set different settings for each group when implementing the enum object."}),"\n",(0,n.jsx)(t.h2,{id:"implementing-proceed-for-circuitbreaker",children:"Implementing proceed() for CircuitBreaker"}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"proceed()"})," code for the ",(0,n.jsx)(t.a,{href:"https://en.wikipedia.org/wiki/aspectj",children:"Aspect"})," object is as shown below."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"public class CircuitBreakerAspect implements Ordered {\n\n    private final Map&lt;CircuitBreakerGroup, CircuitBreaker>\n    circuitBreakers = new EnumMap&lt;>(CircuitBreakerGroup.class);\n\n    @PostConstruct\n    public void initialize() {\n\n        final CircuitBreakerListener listener = new\n        CircuitBreakerListenerImpl(circuitBreakerLogger);\n        for (CircuitBreakerGroup group : CircuitBreakerGroup.values()) {\n            circuitBreakers.put(group, group.circuitBreaker(listener));\n        }\n    }\n\n    public Object proceed(final ProceedingJoinPoint pjp, final CircuitBreakable\n    circuitBreakable) throws Throwable {\n\n        final CircuitBreakerGroup group = circuitBreakable.value();\n        final CircuitBreaker circuitBreaker = circuitBreakers.get(group);\n\n        if (circuitBreaker.canRequest()) {\n            final Object result;\n\n            try {\n                result = pjp.proceed();\n            } catch (Throwable e) {\n                if (group.shouldDealWith(e)) {\n                    circuitBreaker.onFailure(e);\n                } else {\n                    circuitBreaker.onSuccess();\n                }\n                throw e;\n            }\n\n            circuitBreaker.onSuccess();\n            return result;\n        } else {\n            throw CircuitBreakerException.circuitBroken();\n        }\n    }\n}\n"})}),"\n",(0,n.jsxs)(t.p,{children:["The code itself is quite simple.\nIf ",(0,n.jsx)(t.code,{children:"CircuitBreaker"})," is open through ",(0,n.jsx)(t.code,{children:"CircuitBreaker.canRequest()"}),", an exception occurs.\nIf not, the method is called normally.\nIf the result of the call caused an exception, and the exception is identified as a failure, ",(0,n.jsx)(t.code,{children:"CircuitBreaker"})," is notified that it's a failure.\nIf not, ",(0,n.jsx)(t.code,{children:"CircuitBreaker"})," is notified that it's a success."]}),"\n",(0,n.jsxs)(t.p,{children:["For you information, the actual code has code related to IMON Logger1 to check if ",(0,n.jsx)(t.code,{children:"CircuitBreaker"})," is working as intended.\nI omitted that feature from this article to focus more on ",(0,n.jsx)(t.code,{children:"CircuitBreaker"})," only."]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.em,{children:"1 IMON Logger: IMON is a system LINE engineers use to monitor various company services.\nIMON Logger collects the statistics and logs from these services and sends them to IMON."})}),"\n",(0,n.jsx)(t.h2,{id:"methods-used-to-change-settings-for-circuitbreaker",children:"Methods used to change settings for CircuitBreaker"}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"CircuitBreakerBuilder"})," provides many methods that you can use to build your own customized ",(0,n.jsx)(t.code,{children:"CircuitBreaker"}),".\nWhile I recommend using the default settings, here are some details for each setting to help you get a better idea about them."]}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"Method"}),(0,n.jsx)(t.th,{children:"Parameter"}),(0,n.jsx)(t.th,{children:"Default"}),(0,n.jsx)(t.th,{children:"Description"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"failureRateThreshold"}),(0,n.jsx)(t.td,{children:"double"}),(0,n.jsx)(t.td,{children:"0.8"}),(0,n.jsxs)(t.td,{children:["This is the failure rate used to determine whether CircuitBreaker should open or not. If the failure rate (during the duration of ",(0,n.jsx)(t.code,{children:"counterSlidingWindow"}),") is higher than this value, CircuitBreaker opens. The default value is set to open CircuitBreaker if the failure rate is above 80%. In other words, CircuitBreaker opens if the success rate is below 20%."]})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"minimumRequestThreshold"}),(0,n.jsx)(t.td,{children:"long"}),(0,n.jsx)(t.td,{children:"10"}),(0,n.jsxs)(t.td,{children:["The minimum amount of call requests required to determine whether CircuitBreaker should open or not. If the number of requests (during the duration of ",(0,n.jsx)(t.code,{children:"counterSlidingWindow"}),") is lower than this value, CircuitBreaker does not change its status."]})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"circuitOpenWindow"}),(0,n.jsx)(t.td,{children:"Duration"}),(0,n.jsx)(t.td,{children:"10 seconds"}),(0,n.jsxs)(t.td,{children:["The amount of time CircuitBreaker stays open before going into the half-open state. After CircuitBreaker has been open for the duration of ",(0,n.jsx)(t.code,{children:"circuitOpenWindow"}),", CircuitBreaker will change its state to half-open and test requests again."]})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"circuitOpenWindowMillis"}),(0,n.jsx)(t.td,{children:"long"}),(0,n.jsx)(t.td,{children:"10000"}),(0,n.jsx)(t.td,{})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"trialRequestInterval"}),(0,n.jsx)(t.td,{children:"Duration"}),(0,n.jsx)(t.td,{children:"3 seconds"}),(0,n.jsxs)(t.td,{children:["The amount of time before a request is reattempted in the half-open state when the request does not get a closed response. If there is a response during ",(0,n.jsx)(t.code,{children:"trialRequestInterval"}),", CircuitBreaker will change its state to open or closed depending on the result. If CircuitBreaker goes into the open state, the request will be reattempted after ",(0,n.jsx)(t.code,{children:"circuitOpenWindow"}),". If the request does not get a response during ",(0,n.jsx)(t.code,{children:"trialRequestInterval"}),", it will be reattempted."]})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"trialRequestIntervalMillis"}),(0,n.jsx)(t.td,{children:"long"}),(0,n.jsx)(t.td,{children:"3000"}),(0,n.jsx)(t.td,{})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"counterSlidingWindow"}),(0,n.jsx)(t.td,{children:"Duration"}),(0,n.jsx)(t.td,{children:"20 seconds"}),(0,n.jsxs)(t.td,{children:["Recent ",(0,n.jsx)(t.code,{children:"counterSlidngWindow"})," values are used to determine whether CircuitBreaker should open or not. The default value is set to only recognize the requests received in the last 20 seconds."]})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"counterSlidingWindowMillis"}),(0,n.jsx)(t.td,{children:"long"}),(0,n.jsx)(t.td,{children:"20000"}),(0,n.jsx)(t.td,{})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"counterUpdateInterval"}),(0,n.jsx)(t.td,{children:"Duration"}),(0,n.jsx)(t.td,{children:"1 second"}),(0,n.jsxs)(t.td,{children:["CircuitBreaker stores request results through ",(0,n.jsx)(t.code,{children:"SlidingWindowCounter"}),", and ",(0,n.jsx)(t.code,{children:"counterUpdateInterval"})," is the unit of time stored. The default value is set to keep records per each second. An example of this would look like this: 20 second(s) before = Success 20, Failure 0 / 19 second(s) before = Success 25, Failure 1 / ... / 1 second(s) before = Success 21, Failure 0. The failure rate is calculated using these records from the duration of counterSlidingWindow."]})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"counterUpdateIntervalMillis"}),(0,n.jsx)(t.td,{children:"long"}),(0,n.jsx)(t.td,{children:"1000"}),(0,n.jsx)(t.td,{})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"exceptionFilter"}),(0,n.jsx)(t.td,{children:"ExceptionFilter"}),(0,n.jsx)(t.td,{children:"cause -> true"}),(0,n.jsx)(t.td,{children:"An object that returns whether or not an exception is identified as a failure. The default value is set to identify all exceptions as failures."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:"listener"}),(0,n.jsx)(t.td,{children:"CircuitBreakerListener"}),(0,n.jsx)(t.td,{}),(0,n.jsxs)(t.td,{children:["A listener that receives events whenever the state of CircuitBreaker changes, when ",(0,n.jsx)(t.code,{children:"counterUpdateInterval"})," expires, or when an open CircuitBreaker rejects a request."]})]})]})]}),"\n",(0,n.jsx)(t.h2,{id:"closing-words",children:"Closing words"}),"\n",(0,n.jsxs)(t.p,{children:["Up until recently, whenever there was a problem somewhere in Channel Gateway the damage was already done by the time we could actually do something about it.\nA partial outage could cause the entire thread to be full, eventually affecting all services.\nNow that we have ",(0,n.jsx)(t.code,{children:"CircuitBreaker"})," blocking the problematic parts from the rest of the system, we have a wider time window to work with."]}),"\n",(0,n.jsxs)(t.p,{children:["To wrap up this article, I'd like to go through how ",(0,n.jsx)(t.code,{children:"CircuitBreaker"})," works step by step."]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["The initial state of ",(0,n.jsx)(t.code,{children:"CircuitBreaker"})," is ",(0,n.jsx)(t.em,{children:"Closed"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.em,{children:"Closed"}),": Depending on ",(0,n.jsx)(t.code,{children:"ExceptionFilter"})," settings, the following will happen after a request is processed.","\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["If the result is a success, it will be logged as a success and the state changes to ",(0,n.jsx)(t.em,{children:"Closed"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:["If the result is a failure, the requests during the duration of ",(0,n.jsx)(t.code,{children:"counterSlidingWindow"})," are checked and","\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["If requests are more than ",(0,n.jsx)(t.code,{children:"minimumRequestThreshold"}),", and the failure rate is above ",(0,n.jsx)(t.code,{children:"failureRateThreshold"}),", the state changes to ",(0,n.jsx)(t.em,{children:"Open"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:["If not, the state remains ",(0,n.jsx)(t.em,{children:"Closed"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.em,{children:"Open"}),": After the duration of ",(0,n.jsx)(t.code,{children:"circuitOpenWindow"})," passes, the state changes to ",(0,n.jsx)(t.em,{children:"Half-Open"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.em,{children:"Half-Open"}),": Depending on ",(0,n.jsx)(t.code,{children:"ExceptionFilter"})," settings, the following will happen after processing the first request received.","\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["If the result is a success, the state changes to ",(0,n.jsx)(t.em,{children:"Closed"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:["If the result is a failure, the state changes to ",(0,n.jsx)(t.em,{children:"Open"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:["If there is no response during the duration of ",(0,n.jsx)(t.code,{children:"trialRequestInterval"}),", a branch will occur depending on the result of the first request received during the ",(0,n.jsx)(t.em,{children:"Half-Open"})," state."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"about-the-author",children:"About the author"}),"\n",(0,n.jsx)(t.p,{children:"Shin, Jong Hun: I don't like being inconvenienced.\nOne of the focal points of my work is to reduce these inconveniences so I have more time to focus on what matters.\nI think that's why I like programming.\nAlthough I can't really figure out why I seem to be getting busier with time..."})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}}}]);