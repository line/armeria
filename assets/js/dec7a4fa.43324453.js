"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[5020],{13325:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"tutorials/grpc/implement-update","title":"Implementing UPDATE operation","description":"Previously, we created and read blog posts.","source":"@site/src/content/docs/tutorials/grpc/05-implement-update.mdx","sourceDirName":"tutorials/grpc","slug":"/tutorials/grpc/implement-update","permalink":"/docs/tutorials/grpc/implement-update","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site-new/src/content/docs/tutorials/grpc/05-implement-update.mdx","tags":[{"inline":true,"label":"server","permalink":"/docs/tags/server"}],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_label":"5. Implement UPDATE","category":"grpc","tags":["server"],"level":"basic","type":"step"},"sidebar":"docsSidebar","previous":{"title":"4. Implement READ","permalink":"/docs/tutorials/grpc/implement-read"},"next":{"title":"6. Implement DELETE","permalink":"/docs/tutorials/grpc/implement-delete"}}');var r=n(74848),i=n(28453);const o={sidebar_label:"5. Implement UPDATE",category:"grpc",tags:["server"],level:"basic",type:"step"},a="Implementing UPDATE operation",l={},c=[{value:"What you need",id:"what-you-need",level:2},{value:"1. Implement server-side",id:"1-implement-server-side",level:2},{value:"Add an exception handler",id:"add-an-exception-handler",level:3},{value:"Implement the service method",id:"implement-the-service-method",level:3},{value:"3. Test updating a blog post",id:"3-test-updating-a-blog-post",level:2},{value:"4. Test an error case",id:"4-test-an-error-case",level:2},{value:"What&#39;s next",id:"whats-next",level:2}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components},{TutorialSteps:n}=t;return n||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("TutorialSteps",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"implementing-update-operation",children:"Implementing UPDATE operation"})}),"\n",(0,r.jsx)(t.p,{children:"Previously, we created and read blog posts.\nNow, let's implement and make a call to update a blog post.\nWe'll also learn how to handle an exception with a custom exception handler."}),"\n",(0,r.jsx)(n,{current:5}),"\n",(0,r.jsx)(t.h2,{id:"what-you-need",children:"What you need"}),"\n",(0,r.jsxs)(t.p,{children:["You need to have the following files obtained from previous steps.\nYou can always ",(0,r.jsx)(t.a,{href:"https://github.com/line/armeria-examples/tree/main/tutorials/grpc",children:"download"})," the full version, instead of creating one yourself."]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"/docs/tutorials/grpc/define-service#6-compile-the-proto-file",children:"Generated Java code"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"BlogService.java"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"Main.java"})}),"\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.code,{children:"BlogServiceTest.java"})}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"1-implement-server-side",children:"1. Implement server-side"}),"\n",(0,r.jsx)(t.p,{children:"Let's implement the server-side for updating blog posts.\nThis time, we'll use a custom exception handler."}),"\n",(0,r.jsx)(t.h3,{id:"add-an-exception-handler",children:"Add an exception handler"}),"\n",(0,r.jsx)(t.p,{children:"First, add a custom exception handler for the blog service."}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"Create a class for the exception to be thrown when a specified blog post ID doesn't exist."}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-java",metastring:'title="BlogNotFoundException.java"',children:"package example.armeria.server.blog.grpc;\n\nfinal class BlogNotFoundException extends IllegalStateException {\n  BlogNotFoundException(String s) {\n      super(s);\n  }\n}\n"})}),"\n",(0,r.jsxs)(t.ol,{start:"2",children:["\n",(0,r.jsx)(t.li,{children:"Add an exception handler class for the blog service."}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-java",metastring:'title="GrpcExceptionHandler.java"',children:"package example.armeria.server.blog.grpc;\n\nimport com.linecorp.armeria.common.RequestContext;\nimport com.linecorp.armeria.common.annotation.Nullable;\nimport com.linecorp.armeria.common.grpc.GrpcExceptionHandlerFunction;\n\nimport io.grpc.Metadata;\nimport io.grpc.Status;\n\npublic class GrpcExceptionHandler implements GrpcExceptionHandlerFunction {\n\n  @Nullable\n  @Override\n  public Status apply(RequestContext ctx, Throwable cause, Metadata metadata) {\n    if (cause instanceof IllegalArgumentException) {\n        return Status.INVALID_ARGUMENT.withCause(cause);\n    }\n    if (cause instanceof BlogNotFoundException) {\n        return Status.NOT_FOUND.withCause(cause).withDescription(cause.getMessage());\n    }\n\n    // The default mapping function will be applied.\n    return null;\n  }\n}\n"})}),"\n",(0,r.jsxs)(t.ol,{start:"3",children:["\n",(0,r.jsxs)(t.li,{children:["In the ",(0,r.jsx)(t.code,{children:"Main"})," class, bind the ",(0,r.jsx)(t.code,{children:"GrpcExceptionHandler"})," to our service."]}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-java",metastring:'title="Main.java"',children:"private static Server newServer(int port) throws Exception {\n  final GrpcService grpcService =\n     GrpcService.builder()\n                .addService(new BlogService())\n                .exceptionMapping(new GrpcExceptionHandler()) // Add this\n                .build();\n  ...\n}\n"})}),"\n",(0,r.jsx)(t.h3,{id:"implement-the-service-method",children:"Implement the service method"}),"\n",(0,r.jsxs)(t.p,{children:["In the ",(0,r.jsx)(t.code,{children:"BlogServiceImpl"})," class, add a service method for updating a blog post."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-java",metastring:'title="BlogService.java"',children:'import example.armeria.blog.grpc.UpdateBlogPostRequest;\n\npublic class BlogService extends BlogServiceGrpc.BlogServiceImplBase {\n  @Override\n  public void updateBlogPost(UpdateBlogPostRequest request, StreamObserver<BlogPost> responseObserver) {\n    final BlogPost oldBlogPost = blogPosts.get(request.getId());\n    if (oldBlogPost == null) {\n      throw new BlogNotFoundException("The blog post does not exist. ID: " + request.getId());\n    } else {\n      final BlogPost newBlogPost = oldBlogPost.toBuilder()\n                .setTitle(request.getTitle())\n                .setContent(request.getContent())\n                .setModifiedAt(Instant.now().toEpochMilli())\n                .build();\n      blogPosts.put(request.getId(), newBlogPost);\n      responseObserver.onNext(newBlogPost);\n      responseObserver.onCompleted();\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(t.h2,{id:"3-test-updating-a-blog-post",children:"3. Test updating a blog post"}),"\n",(0,r.jsx)(t.p,{children:"Let's try updating the content of the first blog post.\nAdd a method like the following."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-java",metastring:'title="BlogServiceTest.java"',children:'@Test\n@Order(5)\nvoid updateBlogPosts() throws JsonProcessingException {\n  final UpdateBlogPostRequest request = UpdateBlogPostRequest.newBuilder()\n              .setId(0)\n              .setTitle("My first blog")\n              .setContent("Hello awesome Armeria!")\n              .build();\n  final BlogPost updated = client.updateBlogPost(request);\n  assertThat(updated.getId()).isZero();\n  assertThat(updated.getTitle()).isEqualTo("My first blog");\n  assertThat(updated.getContent()).isEqualTo("Hello awesome Armeria!");\n}\n'})}),"\n",(0,r.jsx)(t.p,{children:"Run all the test cases on your IDE or using Gradle.\nCheck that you see the test is passed."}),"\n",(0,r.jsx)(t.h2,{id:"4-test-an-error-case",children:"4. Test an error case"}),"\n",(0,r.jsx)(t.p,{children:"To check that our exception handler is working, let's try updating a post which does not exist."}),"\n",(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsx)(t.li,{children:"Bind the exception handler to the service for the test server."}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-java",metastring:'title="BlogServiceTest.java"',children:"@RegisterExtension\nstatic final ServerExtension server = new ServerExtension() {\n  @Override\n  protected void configure(ServerBuilder sb) throws Exception {\n    sb.service(GrpcService.builder()\n              .addService(new BlogService())\n              .exceptionHandler(new GrpcExceptionHandler()) // Add this\n              .build());\n  }\n};\n"})}),"\n",(0,r.jsxs)(t.ol,{start:"2",children:["\n",(0,r.jsx)(t.li,{children:"Add a test method to update a blog post with an invalid ID, asserting an exception is thrown as expected."}),"\n"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-java",metastring:'title="BlogServiceTest.java"',children:'@Test\n@Order(6)\nvoid updateInvalidBlogPost() {\n  final Throwable exception = catchThrowable(() -> {\n     client.updateBlogPost(UpdateBlogPostRequest.newBuilder()\n              .setId(Integer.MAX_VALUE)\n              .setTitle("My first blog")\n              .setContent("Hello awesome Armeria!")\n              .build());\n  });\n  final StatusRuntimeException statusException = (StatusRuntimeException) exception;\n  assertThat(statusException.getStatus().getCode()).isEqualTo(Code.NOT_FOUND);\n  assertThat(statusException)\n              .hasMessageContaining("The blog post does not exist. ID: " + Integer.MAX_VALUE);\n}\n'})}),"\n",(0,r.jsxs)(t.ol,{start:"3",children:["\n",(0,r.jsx)(t.li,{children:"Run all the test cases on your IDE or using Gradle.\nCheck that you see the test is passed."}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"whats-next",children:"What's next"}),"\n",(0,r.jsx)(t.p,{children:"In this step, we've implemented a service method for updating a blog post.\nWe've also added an exception handler."}),"\n",(0,r.jsxs)(t.p,{children:["Next, at ",(0,r.jsx)(t.a,{href:"/docs/tutorials/grpc/implement-delete",children:"Step 6. Implement DELETE"}),", we'll implement a method\nfor deleting a blog post and add a ",(0,r.jsx)(t.a,{href:"/docs/server/docservice",children:"Documentation Service"})," to our service."]}),"\n",(0,r.jsx)(n,{current:5})]})}function p(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var s=n(96540);const r={},i=s.createContext(r);function o(e){const t=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);