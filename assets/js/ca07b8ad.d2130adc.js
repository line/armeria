"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[3745],{28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>c});var r=n(96540);const a={},i=r.createContext(a);function o(e){const t=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),r.createElement(i.Provider,{value:t},e.children)}},78949:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>c,default:()=>d,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"advanced/request-context","title":"Request Context","description":"RequestContext is the central abstraction for accessing request-scoped information in Armeria.","source":"@site/src/content/docs/advanced/request-context.mdx","sourceDirName":"advanced","slug":"/advanced/request-context","permalink":"/docs/advanced/request-context","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site-new/src/content/docs/advanced/request-context.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"Structured logging","permalink":"/docs/advanced/structured-logging"},"next":{"title":"Understanding timeout and cancellation origins","permalink":"/docs/advanced/understanding-timeouts"}}');var a=n(74848),i=n(28453);const o={},c="Request Context",s={},l=[{value:"Accessing the current context",id:"accessing-the-current-context",level:2},{value:"Context propagation across threads",id:"context-propagation-across-threads",level:2},{value:"Using context-aware executors",id:"using-context-aware-executors",level:3},{value:"Making existing code context-aware",id:"making-existing-code-context-aware",level:3},{value:"Manual context pushing",id:"manual-context-pushing",level:3},{value:"Capturing client request context",id:"capturing-client-request-context",level:2},{value:"Custom attributes",id:"custom-attributes",level:2},{value:"Setting attributes for client requests",id:"setting-attributes-for-client-requests",level:3},{value:"Server vs Client attributes",id:"server-vs-client-attributes",level:3},{value:"Timeout control",id:"timeout-control",level:2},{value:"Server-side timeouts",id:"server-side-timeouts",level:3},{value:"Client-side timeouts",id:"client-side-timeouts",level:3},{value:"Request cancellation",id:"request-cancellation",level:2},{value:"Listening for cancellation",id:"listening-for-cancellation",level:3},{value:"Accessing request information",id:"accessing-request-information",level:2},{value:"See also",id:"see-also",level:2}];function u(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.header,{children:(0,a.jsx)(t.h1,{id:"request-context",children:"Request Context"})}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/RequestContext.html",children:"RequestContext"})," is the central abstraction for accessing request-scoped information in Armeria.\nEvery request being handled\u2014whether on the server or client side\u2014has an associated context that provides\ninformation about the request, utilities for thread-safe context propagation, and control over timeouts and cancellation."]}),"\n",(0,a.jsx)(t.p,{children:"Armeria provides two main implementations:"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"}),": Used on the server-side when handling a server request."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientRequestContext.html",children:"ClientRequestContext"}),": Used on the client-side when making a client request."]}),"\n"]}),"\n",(0,a.jsx)(t.h2,{id:"accessing-the-current-context",children:"Accessing the current context"}),"\n",(0,a.jsx)(t.p,{children:"Within a request's execution scope, you can access the current context using static methods:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"import com.linecorp.armeria.common.RequestContext;\nimport com.linecorp.armeria.server.ServiceRequestContext;\nimport com.linecorp.armeria.client.ClientRequestContext;\n\n// Get any context (throws IllegalStateException if unavailable)\nRequestContext ctx = RequestContext.current();\n\n// Get context or null if unavailable\nRequestContext ctxOrNull = RequestContext.currentOrNull();\n\n// Get specific context types\nServiceRequestContext serverCtx = ServiceRequestContext.current();\nClientRequestContext clientCtx = ClientRequestContext.current();\n"})}),"\n",(0,a.jsx)(t.admonition,{type:"note",children:(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.code,{children:"current()"})," throws an ",(0,a.jsx)(t.code,{children:"IllegalStateException"})," if the context is not available in the current thread.\nUse ",(0,a.jsx)(t.code,{children:"currentOrNull()"})," if you want to handle the absence of context gracefully."]})}),"\n",(0,a.jsxs)(t.p,{children:["When making a client request from within a server request handler, the ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientRequestContext.html",children:"ClientRequestContext"}),"\nhas a ",(0,a.jsx)(t.code,{children:"root()"})," that returns the originating ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"}),":"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"// Inside a client callback that was initiated from a server request\nServiceRequestContext serverCtx = ClientRequestContext.current().root();\n"})}),"\n",(0,a.jsx)(t.h2,{id:"context-propagation-across-threads",children:"Context propagation across threads"}),"\n",(0,a.jsxs)(t.p,{children:["Armeria's context is thread-local. If you switch threads (e.g., using ",(0,a.jsx)(t.code,{children:"CompletableFuture"}),", ",(0,a.jsx)(t.code,{children:"Executor"}),", or reactive streams),\nyou must propagate the context to the new thread. Failing to do so will result in lost context, breaking features like\ndistributed tracing and logging."]}),"\n",(0,a.jsx)(t.h3,{id:"using-context-aware-executors",children:"Using context-aware executors"}),"\n",(0,a.jsxs)(t.p,{children:["The preferred approach is to use the context's built-in executors.\n",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/RequestContext.html",children:"RequestContext"})," provides methods to obtain them."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"import java.util.concurrent.CompletableFuture;\n\nServiceRequestContext ctx = ServiceRequestContext.current();\n\n// For non-blocking async callbacks - uses the event loop\nctx.eventLoop().execute(() -> {\n    assert ServiceRequestContext.current() == ctx;\n    // Handle async logic...\n});\n\n// For blocking operations (DB calls, file I/O, etc.)\nctx.blockingTaskExecutor().execute(() -> {\n    assert ServiceRequestContext.current() == ctx;\n    // Blocking call that will be traced...\n    Thread.sleep(1000);\n});\n"})}),"\n",(0,a.jsx)(t.h3,{id:"making-existing-code-context-aware",children:"Making existing code context-aware"}),"\n",(0,a.jsxs)(t.p,{children:["You can wrap an existing ",(0,a.jsx)(t.code,{children:"Executor"})," or callbacks to make them context-aware using ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/RequestContext.html#makeContextAware(java.lang.Runnable)",children:"RequestContext#makeContextAware(Runnable)"}),":"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:'import java.util.concurrent.Executor;\nimport java.util.concurrent.Callable;\n\nServiceRequestContext ctx = ServiceRequestContext.current();\nExecutor myExecutor = ...;\n\n// Wrap an executor\nExecutor contextAwareExecutor = ctx.makeContextAware(myExecutor);\n\ncontextAwareExecutor.execute(() -> {\n    // Context is available here\n    assert RequestContext.current() == ctx;\n});\n\n// Wrap individual callbacks\nRunnable wrapped = ctx.makeContextAware(() -> { /* ... */ });\nCallable<String> wrappedCallable = ctx.makeContextAware(() -> "result");\n\n// Wrap CompletableFuture to propagate context in callbacks\nCompletableFuture<String> future = someFuture();\nCompletableFuture<String> contextAwareFuture = ctx.makeContextAware(future);\n'})}),"\n",(0,a.jsx)(t.h3,{id:"manual-context-pushing",children:"Manual context pushing"}),"\n",(0,a.jsxs)(t.p,{children:["For fine-grained control, you can manually push the context onto the thread-local stack using ",(0,a.jsx)(t.code,{children:"push()"}),".\nAlways use try-with-resources to ensure the context is popped:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"import com.linecorp.armeria.common.util.SafeCloseable;\n\ntry (SafeCloseable ignored = ctx.push()) {\n    // Context is available in this block\n    assert RequestContext.current() == ctx;\n}\n"})}),"\n",(0,a.jsx)(t.h2,{id:"capturing-client-request-context",children:"Capturing client request context"}),"\n",(0,a.jsxs)(t.p,{children:["When you need to access the ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientRequestContext.html",children:"ClientRequestContext"})," of a request you're about to send,\nuse ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/Clients.html#newContextCaptor()",children:"Clients#newContextCaptor()"})," to capture it. This is useful for inspecting\nrequest details, accessing the request log, or performing assertions in tests."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:'import com.linecorp.armeria.client.Clients;\nimport com.linecorp.armeria.client.ClientRequestContextCaptor;\nimport com.linecorp.armeria.client.WebClient;\n\ntry (ClientRequestContextCaptor captor = Clients.newContextCaptor()) {\n    WebClient.of().get("https://example.com/hello");\n    ClientRequestContext ctx = captor.get();\n    assert ctx.path().equals("/hello");\n}\n'})}),"\n",(0,a.jsxs)(t.p,{children:["You can also capture multiple ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientRequestContext.html",children:"ClientRequestContext"})," instances:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:'try (ClientRequestContextCaptor captor = Clients.newContextCaptor()) {\n    WebClient.of().get("https://example.com/foo");\n    WebClient.of().get("https://example.com/bar");\n    List<ClientRequestContext> contexts = captor.getAll();\n    assert contexts.get(0).path().equals("/foo");\n    assert contexts.get(1).path().equals("/bar");\n}\n'})}),"\n",(0,a.jsx)(t.admonition,{type:"note",children:(0,a.jsx)(t.p,{children:"The captor only captures contexts for requests made from the same thread that created the captor."})}),"\n",(0,a.jsx)(t.h2,{id:"custom-attributes",children:"Custom attributes"}),"\n",(0,a.jsxs)(t.p,{children:["You can attach custom attributes to a ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/RequestContext.html",children:"RequestContext"})," to share data between decorators\nor different parts of your application."]}),"\n",(0,a.jsxs)(t.p,{children:["First, define an ",(0,a.jsx)(t.code,{children:"AttributeKey"}),":"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:'import io.netty.util.AttributeKey;\n\n// Define keys (typically as static constants)\npublic final class MyAttributeKeys {\n    public static final AttributeKey<String> USER_ID =\n            AttributeKey.valueOf(MyAttributeKeys.class, "USER_ID");\n}\n'})}),"\n",(0,a.jsx)(t.p,{children:"Then, set and get attributes:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:'// Setting an attribute\nctx.setAttr(MyAttributeKeys.USER_ID, "user-123");\n\n// Getting an attribute\nString userId = ctx.attr(MyAttributeKeys.USER_ID);\n\n// Iterating over all attributes\nctx.attrs().forEachRemaining(entry -> {\n    System.out.println(entry.getKey() + ": " + entry.getValue());\n});\n'})}),"\n",(0,a.jsx)(t.h3,{id:"setting-attributes-for-client-requests",children:"Setting attributes for client requests"}),"\n",(0,a.jsxs)(t.p,{children:["You can set attributes when building a client request using ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/WebClient.html",children:"WebClient"})," or ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/RequestOptions.html",children:"RequestOptions"}),":"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:'import com.linecorp.armeria.client.WebClient;\n\nWebClient client = WebClient.of("http://example.com");\n\n// Using WebClientRequestPreparation\nclient.prepare()\n      .get("/my-service")\n      .attr(MyAttributeKeys.USER_ID, "user-123")\n      .execute();\n'})}),"\n",(0,a.jsx)(t.h3,{id:"server-vs-client-attributes",children:"Server vs Client attributes"}),"\n",(0,a.jsxs)(t.p,{children:["On the client side, ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientRequestContext.html",children:"ClientRequestContext"})," is often created within a\n",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"})," (e.g., a server making a downstream call).\nIn this case, the ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"})," is the ",(0,a.jsx)(t.em,{children:"root"})," of the\n",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientRequestContext.html",children:"ClientRequestContext"}),"."]}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/RequestContext.html#attr(io.netty.util.AttributeKey)",children:"RequestContext#attr(AttributeKey)"}),": Searches in the current context, and then in the root context."]}),"\n",(0,a.jsxs)(t.li,{children:[(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/RequestContext.html#ownAttr(io.netty.util.AttributeKey)",children:"RequestContext#ownAttr(AttributeKey)"}),": Searches only in the current context."]}),"\n"]}),"\n",(0,a.jsx)(t.p,{children:"This allows attributes to be inherited from the server context to the client context."}),"\n",(0,a.jsx)(t.h2,{id:"timeout-control",children:"Timeout control"}),"\n",(0,a.jsxs)(t.p,{children:["You can dynamically adjust the timeout of a request or response using ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/util/TimeoutMode.html",children:"TimeoutMode"}),"."]}),"\n",(0,a.jsx)(t.h3,{id:"server-side-timeouts",children:"Server-side timeouts"}),"\n",(0,a.jsxs)(t.p,{children:["Control request timeouts dynamically using ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/ServiceRequestContext.html",children:"ServiceRequestContext"}),":"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"import com.linecorp.armeria.common.util.TimeoutMode;\nimport java.time.Duration;\n\nServiceRequestContext ctx = ServiceRequestContext.current();\n\n// Set timeout from now\nctx.setRequestTimeout(Duration.ofSeconds(30));\n\n// Extend existing timeout\nctx.setRequestTimeoutMillis(TimeoutMode.EXTEND, 5000);\n\n// Set timeout from request start\nctx.setRequestTimeout(TimeoutMode.SET_FROM_START, Duration.ofSeconds(60));\n\n// Disable timeout entirely\nctx.clearRequestTimeout();\n\n// Trigger immediate timeout\nctx.timeoutNow();\n"})}),"\n",(0,a.jsx)(t.h3,{id:"client-side-timeouts",children:"Client-side timeouts"}),"\n",(0,a.jsxs)(t.p,{children:["Control response timeouts using ",(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/ClientRequestContext.html",children:"ClientRequestContext"}),":"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"ClientRequestContext ctx = ClientRequestContext.current();\n\n// Set response timeout from now\nctx.setResponseTimeout(Duration.ofSeconds(30));\n\n// Extend for long-running streaming responses\nctx.setResponseTimeout(TimeoutMode.EXTEND, Duration.ofSeconds(10));\n\n// Disable timeout\nctx.clearResponseTimeout();\n"})}),"\n",(0,a.jsx)(t.h2,{id:"request-cancellation",children:"Request cancellation"}),"\n",(0,a.jsx)(t.p,{children:"You can cancel a request or check its cancellation status:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:'ServiceRequestContext ctx = ServiceRequestContext.current();\n\n// Cancel with default exception\nctx.cancel();\n\n// Cancel with custom cause\nctx.cancel(new RuntimeException("Operation aborted"));\n\n// Cancel due to timeout\nctx.timeoutNow();\n\n// Check status\nboolean cancelled = ctx.isCancelled();\nboolean timedOut = ctx.isTimedOut();\nThrowable cause = ctx.cancellationCause();\n'})}),"\n",(0,a.jsx)(t.h3,{id:"listening-for-cancellation",children:"Listening for cancellation"}),"\n",(0,a.jsx)(t.p,{children:"React to cancellation events:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:"// Server-side\nServiceRequestContext sctx = ServiceRequestContext.current();\nsctx.whenRequestCancelling().thenAccept(cause -> {\n    // Cleanup before cancellation completes\n});\nsctx.whenRequestCancelled().thenAccept(cause -> {\n    // Cancellation is complete\n});\n\n// Client-side\nClientRequestContext cctx = ClientRequestContext.current();\ncctx.whenResponseCancelling().thenAccept(cause -> { /* ... */ });\ncctx.whenResponseCancelled().thenAccept(cause -> { /* ... */ });\n"})}),"\n",(0,a.jsx)(t.h2,{id:"accessing-request-information",children:"Accessing request information"}),"\n",(0,a.jsxs)(t.p,{children:[(0,a.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/RequestContext.html",children:"RequestContext"})," provides access to essential request details:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-java",children:'RequestContext ctx = RequestContext.current();\n\n// Request details\nHttpMethod method = ctx.method();\nString path = ctx.path();\nString decodedPath = ctx.decodedPath();\nString query = ctx.query();\nURI uri = ctx.uri();\nRequestId id = ctx.id();\n\n// Connection info\nSessionProtocol protocol = ctx.sessionProtocol();\nInetSocketAddress remoteAddr = ctx.remoteAddress();\nInetSocketAddress localAddr = ctx.localAddress();\nSSLSession sslSession = ctx.sslSession();\n\n// Server-specific (ServiceRequestContext)\nServiceRequestContext sctx = ServiceRequestContext.current();\nMap<String, String> pathParams = sctx.pathParams();\nQueryParams queryParams = sctx.queryParams();\nInetAddress clientAddress = sctx.clientAddress();\n\n// Request log (access after request is complete or for partial info)\nRequestLogAccess log = ctx.log();\nctx.log().whenComplete().thenAccept(requestLog -> {\n    System.out.println("Request finished in " + requestLog.totalDurationMillis() + "ms");\n});\n'})}),"\n",(0,a.jsx)(t.h2,{id:"see-also",children:"See also"}),"\n",(0,a.jsxs)(t.ul,{children:["\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"/docs/server/timeouts",children:"Configuring server timeouts"})}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"/docs/client/timeouts",children:"Overriding client timeouts"})}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"/docs/server/decorator",children:"Decorating a service"})}),"\n",(0,a.jsx)(t.li,{children:(0,a.jsx)(t.a,{href:"/docs/advanced/logging",children:"Logging contextual information"})}),"\n"]})]})}function d(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(u,{...e})}):u(e)}}}]);