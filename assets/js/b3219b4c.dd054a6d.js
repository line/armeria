"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[3099],{83890:e=>{e.exports=JSON.parse('{"archive":{"blogPosts":[{"id":"/2021/08/04/customizing-armeria-metrics","metadata":{"permalink":"/blog/2021/08/04/customizing-armeria-metrics","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2021-08-04-customizing-armeria-metrics.mdx","source":"@site/src/content/blog/en/2021-08-04-customizing-armeria-metrics.mdx","title":"Customizing Armeria metrics","description":"In my last post, Monitoring Prometheus metrics from Armeria, we took a look at how you can monitor Armeria metrics using Grafana.","date":"2021-08-04T00:00:00.000Z","tags":[],"readingTime":5.91,"hasTruncateMarker":true,"authors":[{"name":"Seunghwan Joo","title":"Seunghwan is in charge of LINE OpenChat back-end development","imageURL":"/img/author-seunghwanjoo.jpeg","key":"seunghwanjoo","page":null}],"frontMatter":{"authors":["seunghwanjoo"],"other_languages":{"ko":"/blog/ko/2021/07/15/customizing-armeria-metrics"}},"unlisted":false,"nextItem":{"title":"Monitoring Prometheus metrics from Armeria","permalink":"/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria"}},"content":"In my last post, [Monitoring Prometheus metrics from Armeria](/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria), we took a look at how you can monitor Armeria metrics using Grafana.\\nIn this post, I would like to show you how you can customize Armeria metrics to suit your needs.\\n\\n{/* truncate */}\\n\\n> The sample code in this post uses the same sample code from [Monitoring Prometheus metrics from Armeria](/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria).\\n\\n## Customizing metrics prefixes using MeterIdPrefixFunction\\n\\nIn the last post I mentioned that you can customize the default prefix appended to metrics by using the [`MeterIdPrefixFunction#ofDefault`](<https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html#ofDefault(java.lang.String)>) function.\\nYou can further customize these prefixes by using the [`MeterIdPrefixFunction#andThen`](<https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html#andThen(com.linecorp.armeria.common.metric.MeterIdPrefixFunctionCustomizer)>) function.\\n\\nLet\'s assume you want to add an HTTP method name as your prefix.\\n\\n- AS-IS: `my_http_service`\\n- TO-BE: `my_http_service_{HTTP method}`\\n\\nFirst you must generate a class that implements [`MeterIdPrefixFunctionCustomizer`](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/metric/MeterIdPrefixFunctionCustomizer.html).\\nYou can add your HTTP method name to your existing `MeterIdPrefix` in the `MeterIdPrefixFunctionCustomizer#apply` function.\\n\\nWhile doing so, you can use [`RequestLog#requestHeaders`](<https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/logging/RequestOnlyLog.html#requestHeaders()>) to get the request\'s HTTP method name.\\nVarious other information generated while processing a single request gets collected on [`RequestLog`](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/logging/RequestLog.html).\\nFor more information about this, please refer to the [Official Armeria documentation](https://armeria.dev/docs/advanced-structured-logging/).\\n\\n```java title=\\"MeterIdPrefixFunctionCustomizer.java\\"\\npublic class MyMeterIdPrefixFunction implements MeterIdPrefixFunctionCustomizer {\\n\\n    @Override\\n    public MeterIdPrefix apply(MeterRegistry registry, RequestOnlyLog log, MeterIdPrefix meterIdPrefix) {\\n        return meterIdPrefix.append(log.requestHeaders().method().name());\\n    }\\n}\\n```\\n\\nNext we insert the class\'s instance using the [`MeterIdPrefixFunction#andThen`](<https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html#andThen(com.linecorp.armeria.common.metric.MeterIdPrefixFunctionCustomizer)>) function.\\n\\n```java title=\\"ArmeriaPrometheusApplication.java\\"\\nServerBuilder sb = Server.builder();\\n                         .http(8083)\\n                         .meterRegistry(meterRegistry);\\nsb.annotatedService(...);\\nsb.service(\\"/metrics\\", ...);\\nsb.decorator(MetricCollectingService.builder(MeterIdPrefixFunction.ofDefault(\\"my.http.service\\")\\n                                                                  // add\\n                                                                  .andThen(new MyMeterIdPrefixFunction()))\\n                                                                  .newDecorator());\\nServer server = sb.build();\\n// ...\\n```\\n\\nAfter restarting the server, you can see that the HTTP method name has been appended to the front of your metrics.\\n\\n```\\n$ curl -s http://localhost:8083/metrics | grep \\"my_http_service_\\"\\n# HELP my_http_service_GET_timeouts_total\\n# TYPE my_http_service_GET_timeouts_total counter\\nmy_http_service_GET_timeouts_total{cause=\\"RequestTimeoutException\\",hostname_pattern=\\"*\\",http_status=\\"500\\",method=\\"hello\\",service=\\"com.example.armeria_prometheus.MyAnnotatedService\\",} 0.0\\nmy_http_service_GET_timeouts_total{cause=\\"RequestTimeoutException\\",hostname_pattern=\\"*\\",http_status=\\"200\\",method=\\"hello\\",service=\\"com.example.armeria_prometheus.MyAnnotatedService\\",} 0.0\\n# HELP my_http_service_GET_active_requests\\n# TYPE my_http_service_GET_active_requests gauge\\nmy_http_service_GET_active_requests{hostname_pattern=\\"*\\",method=\\"hello\\",service=\\"com.example.armeria_prometheus.MyAnnotatedService\\",} 0.0\\n...\\n```\\n\\nFor an alternative method of doing this, you can use lambda expressions that have been introduced in Java 8.\\n\\n```java title=\\"ArmeriaPrometheusApplication.java\\"\\nMeterIdPrefixFunction.ofDefault(\\"my.http.service\\")\\n                     .andThen((registry, log, prefix) -> prefix.append(log.requestHeaders().method().name())))\\n```\\n\\n## Customizing HTTP API response success predicate\\n\\nArmeria\'s default settings are set to recognize HTTP API response status codes smaller than 100 or larger than 400 as failures.\\nHowever, you can use `MetricCollectingServiceBuilder#successFunction` to customize this predicate.\\n\\nLet\'s assume the API has received a 404 status code response.\\n\\n```java title=\\"MyAnnotatedService.java\\"\\npublic class MyAnnotatedService {\\n\\n    @Get(\\"/hello/{seq}\\")\\n    public HttpResponse hello(@Param(\\"seq\\") int seq) {\\n        if (seq % 5 == 0) {\\n            return HttpResponse.of(HttpStatus.NOT_FOUND);\\n        }\\n        // ...\\n    }\\n}\\n```\\n\\n```\\n$ curl http://localhost:8083/hello/5\\n404 Not Found\\n\\n$ curl -s http://localhost:8083/metrics | grep \\"my_http_service_GET_requests_total\\" | grep \\"404\\"\\nmy_http_service_GET_requests_total{hostname_pattern=\\"*\\",http_status=\\"404\\",method=\\"hello\\",result=\\"success\\",service=\\"com.example.armeria_prometheus.MyAnnotatedService\\",} 0.0\\nmy_http_service_GET_requests_total{hostname_pattern=\\"*\\",http_status=\\"404\\",method=\\"hello\\",result=\\"failure\\",service=\\"com.example.armeria_prometheus.MyAnnotatedService\\",} 1.0\\n```\\n\\nIf you wish to change a 404 status code from a failure to a success, get the HTTP status from [`RequestLog#responseHeaders`](<https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/logging/RequestLog.html#responseHeaders()>) and implement [`MetricCollectingServiceBuilder#successFunction`](<https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/MetricCollectingServiceBuilder.html#successFunction(java.util.function.BiPredicate)>) as follows.\\n\\n```java title=\\"ArmeriaPrometheusApplication.java\\"\\n// ...\\nsb.decorator(MetricCollectingService.builder(MeterIdPrefixFunction.ofDefault(\\"my.http.service\\")\\n                                                                  .andThen(new MyMeterIdPrefixFunction()))\\n                                     // add\\n                                     .successFunction((context, log) -> {\\n                                        final int statusCode = log.responseHeaders().status().code();\\n                                        return (statusCode >= 200 && statusCode < 400) || statusCode == 404;\\n                                     })\\n                                     .newDecorator());\\n// ...\\n```\\n\\nYou can see that the test results below show the 404 status code response as a success.\\n\\n```\\n$ curl -s http://localhost:8083/metrics | grep \\"my_http_service_GET_requests_total\\" | grep \\"404\\"\\nmy_http_service_GET_requests_total{hostname_pattern=\\"*\\",http_status=\\"404\\",method=\\"hello\\",result=\\"success\\",service=\\"com.example.armeria_prometheus.MyAnnotatedService\\",} 1.0\\nmy_http_service_GET_requests_total{hostname_pattern=\\"*\\",http_status=\\"404\\",method=\\"hello\\",result=\\"failure\\",service=\\"com.example.armeria_prometheus.MyAnnotatedService\\",} 0.0\\n```\\n\\n## Filtering metrics\\n\\nYou can filter out unwanted metrics from your logs by using MeterFilter.\\nFor example, if you wish to remove JVM metrics from your logs, configure [`MeterFilter`](https://www.javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/config/MeterFilter.html) as follows.\\n\\n```java title=\\"ArmeriaPrometheusApplication.java\\"\\npublic static void main(String[] args) {\\n        PrometheusMeterRegistry meterRegistry = new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);\\n        meterRegistry.config()\\n                     .meterFilter(MeterFilter.denyNameStartsWith(\\"jvm\\"));\\n        ServerBuilder sb = Server.builder();\\n                                 .http(8083)\\n                                 .meterRegistry(meterRegistry);\\n        // ...\\n```\\n\\nYou can see that all `jvm_` metrics have been removed.\\n\\n```\\n$ curl -s http://localhost:8083/metrics | grep \\"^jvm\\"\\n```\\n\\n## Collecting gRPC metrics\\n\\nUsing Armeria\'s [`GrpcMeterIdPrefixFunction`](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/grpc/GrpcMeterIdPrefixFunction.html), you can collect metrics related to [gRPC status codes](https://grpc.github.io/grpc/core/md_doc_statuscodes.html).\\nTo do this, add armeria-grpc to your dependencies as follows.\\n\\n```groovy title=\\"build.gradle\\"\\ndependencies {\\n\\n    // Armeria\\n    implementation \\"com.linecorp.armeria:armeria:1.8.0\\"\\n    implementation \\"com.linecorp.armeria:armeria-logback:1.8.0\\"\\n    implementation \\"com.linecorp.armeria:armeria-grpc:1.8.0\\" // add\\n\\n    // ...\\n}\\n```\\n\\nFor testing purposes, I\'ve created a simple gRPC service as follows.\\n\\n```protobuf title=\\"hello.proto\\"\\nsyntax = \\"proto3\\";\\n\\npackage com.example.armeria_prometheus;\\n\\noption java_package = \\"com.example.armeria_prometheus.grpc\\";\\n\\nservice HelloService {\\n  rpc Hello (HelloRequest) returns (HelloReply) {}\\n}\\n\\nmessage HelloRequest {\\n  int32 seq = 1;\\n}\\n\\nmessage HelloReply {\\n  string message = 1;\\n}\\n```\\n\\n```java title=\\"MyGrpcService.java\\"\\npublic class MyGrpcService extends HelloServiceGrpc.HelloServiceImplBase {\\n\\n    @Override\\n    public void hello(HelloRequest request, StreamObserver<HelloReply> responseObserver) {\\n        if (request.getSeq() % 3 != 0) {\\n            HelloReply reply = HelloReply.newBuilder()\\n                                         .setMessage(\\"Success\\")\\n                                         .build();\\n            responseObserver.onNext(reply);\\n            responseObserver.onCompleted();\\n            return;\\n        }\\n        responseObserver.onError(Status.INTERNAL.asException());\\n    }\\n}\\n```\\n\\nI\'ve added the gRPC service created above as a new service.\\nIn order to prevent affecting existing HTTP metric collection, I\'ve applied a [`MetricCollectingService`](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/MetricCollectingService.html) decorator to each service.\\n\\n```java title=\\"ArmeriaPrometheusApplication.java\\"\\n// ...\\nsb.annotatedService(new MyAnnotatedService(),\\n                    MetricCollectingService.builder(MeterIdPrefixFunction.ofDefault(\\"my.http.service\\")\\n                                                                          // ... \xec\x83\x9d\xeb\x9e\xb5 ...\\nsb.service(GrpcService.builder()\\n                      .addService(new MyGrpcService())\\n                      .build(),\\n           MetricCollectingService.newDecorator(GrpcMeterIdPrefixFunction.of(\\"my.grpc.service\\")));\\nsb.service(\\"/metrics\\", PrometheusExpositionService.of(meterRegistry.getPrometheusRegistry()));\\n// ...\\n```\\n\\nFor easier testing, I\'ve added client code that triggers multiple gRPC requests.\\nWriting client code is also made easier when you\'re using Armeria.\\n\\n```java title=\\"RpcClientApplication.java\\"\\npublic class RpcClientApplication {\\n\\n    private static final Logger logger = LoggerFactory.getLogger(RpcClientApplication.class);\\n\\n    public static void main(String[] args) {\\n        HelloServiceBlockingStub helloService = Clients\\n                .newClient(\\"gproto+http://127.0.0.1:8083/\\", HelloServiceBlockingStub.class);\\n        for (int i = 0; i < 100; i++) {\\n            try {\\n                HelloRequest request = HelloRequest.newBuilder().setSeq(i).build();\\n                HelloReply reply = helloService.hello(request);\\n                logger.info(reply.getMessage());\\n            } catch (Exception e) {\\n                logger.error(\\"Error\\", e);\\n            }\\n        }\\n    }\\n}\\n```\\n\\nRestart your server and run the client code.\\n\\n```\\n$ curl -s http://localhost:8083/metrics | grep \\"my_grpc_service_requests_total\\"\\n# HELP my_grpc_service_requests_total\\n# TYPE my_grpc_service_requests_total counter\\nmy_grpc_service_requests_total{grpc_status=\\"13\\",hostname_pattern=\\"*\\",http_status=\\"200\\",method=\\"Hello\\",result=\\"success\\",service=\\"com.example.armeria_prometheus.HelloService\\",} 0.0\\nmy_grpc_service_requests_total{grpc_status=\\"13\\",hostname_pattern=\\"*\\",http_status=\\"200\\",method=\\"Hello\\",result=\\"failure\\",service=\\"com.example.armeria_prometheus.HelloService\\",} 34.0\\nmy_grpc_service_requests_total{grpc_status=\\"0\\",hostname_pattern=\\"*\\",http_status=\\"200\\",method=\\"Hello\\",result=\\"failure\\",service=\\"com.example.armeria_prometheus.HelloService\\",} 0.0\\nmy_grpc_service_requests_total{grpc_status=\\"0\\",hostname_pattern=\\"*\\",http_status=\\"200\\",method=\\"Hello\\",result=\\"success\\",service=\\"com.example.armeria_prometheus.HelloService\\",} 66.0\\n```\\n\\nYou can see that the [gRPC status code](https://grpc.github.io/grpc/core/md_doc_statuscodes.html) metrics are collected and displayed.\\n\\n## Conclusion\\n\\nArmeria also provides features that various users can use for collecting metrics.\\nI hope many server engineers find these features useful and make their monitoring efforts more productive."},{"id":"/2021/07/09/monitoring-prometheus-metrics-from-armeria","metadata":{"permalink":"/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2021-07-09-monitoring-prometheus-metrics-from-armeria.mdx","source":"@site/src/content/blog/en/2021-07-09-monitoring-prometheus-metrics-from-armeria.mdx","title":"Monitoring Prometheus metrics from Armeria","description":"In this post, we\'ll be taking a look at how you can monitor Prometheus metrics collected with Armeria.","date":"2021-07-09T00:00:00.000Z","tags":[],"readingTime":5.47,"hasTruncateMarker":true,"authors":[{"name":"Seunghwan Joo","title":"Seunghwan is in charge of LINE OpenChat back-end development","imageURL":"/img/author-seunghwanjoo.jpeg","key":"seunghwanjoo","page":null}],"frontMatter":{"authors":["seunghwanjoo"],"other_languages":{"ko":"/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria"}},"unlisted":false,"prevItem":{"title":"Customizing Armeria metrics","permalink":"/blog/2021/08/04/customizing-armeria-metrics"},"nextItem":{"title":"Using Circuit Breakers with Armeria","permalink":"/blog/2020/07/08/circuit-breakers-armeria"}},"content":"In this post, we\'ll be taking a look at how you can monitor [Prometheus](https://prometheus.io/) metrics collected with [Armeria](https://armeria.dev/).\\nFor those of you who are trying Armeria for the first time, I will be adding simple practice samples so that you can follow along.\\n\\n{/* truncate */}\\n\\n## Practice exercise\\n\\nThe practice session was designed on macOS Big Sur.\\nLet\'s now take a look at how you should install and configure Gradle, Prometheus, and [Grafana](https://grafana.com/) to run the samples, and see what the results are.\\n\\n### Configuring Gradle\\n\\nI\'ve defined the following dependencies on the \'build.gradle\' file to collect the Prometheus metrics from the Armeria server.\\n\\n```groovy title=\\"build.gradle\\"\\ndependencies {\\n\\n    // Armeria\\n    implementation \\"com.linecorp.armeria:armeria:1.8.0\\"\\n    implementation \\"com.linecorp.armeria:armeria-logback:1.8.0\\"\\n\\n    // Prometheus\\n    implementation \\"io.micrometer:micrometer-registry-prometheus:1.7.0\\"\\n\\n    // ...\\n}\\n```\\n\\nI\'ve also prepared a simple REST API that responds to a `/hello/{seq}`GET request with \\"Success\\" or \\"Failure\\" for the purpose of our exercise.\\n\\n```java title=\\"MyAnnotatedService.java\\"\\npublic class MyAnnotatedService {\\n\\n    @Get(\\"/hello/{seq}\\")\\n    public HttpResponse hello(@Param(\\"seq\\") int seq) {\\n        if (seq % 3 == 0) {\\n            return HttpResponse.of(HttpStatus.INTERNAL_SERVER_ERROR);\\n        }\\n        return HttpResponse.of(HttpStatus.OK, MediaType.PLAIN_TEXT_UTF_8, \\"Success\\");\\n    }\\n}\\n```\\n\\nBelow is the `main()` function code for running an Armeria server\\n\\n```java title=\\"ArmeriaPrometheusApplication.java\\"\\npublic class ArmeriaPrometheusApplication {\\n\\n    public static void main(String[] args) {\\n        PrometheusMeterRegistry meterRegistry = new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);\\n        Server server = Server\\n                .builder()\\n                .http(8083)\\n                .meterRegistry(meterRegistry)\\n                .annotatedService(new MyAnnotatedService())\\n                .service(\\"/metrics\\", PrometheusExpositionService.of(meterRegistry.getPrometheusRegistry()))\\n                .decorator(MetricCollectingService.builder(MeterIdPrefixFunction.ofDefault(\\"my.http.service\\"))\\n                                                  .newDecorator())\\n                .build();\\n\\n        CompletableFuture<Void> future = server.start();\\n        future.join();\\n    }\\n}\\n```\\n\\nYou must always add [MetricCollectingService](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/MetricCollectingService.html) as a `decorator` if you want to collect service metrics. (You can find more on how to do this in the [official Armeria documentation](https://armeria.dev/docs/advanced-metrics/).).\\nYou can customize the default prefix of the metrics by specifying the parameter of the `MeterIdPrefixFunction.ofDefault()` function.\\n\\n```java title=\\"ArmeriaPrometheusApplication.java\\"\\n.decorator(new MyAnnotatedService(),\\n           MetricCollectingService.builder(MeterIdPrefixFunction.ofDefault(\\"my.http.service\\"))\\n                                  .newDecorator())\\n```\\n\\nUse [PrometheusExpositionService](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/PrometheusExpositionService.html) to configure the path to output the Prometheus metrics.\\n\\n```java title=\\"ArmeriaPrometheusApplication.java\\"\\n.service(\\"/metrics\\", PrometheusExpositionService.of(meterRegistry.getPrometheusRegistry()))\\n```\\n\\nSend a request with the `/hello` API to check if there is a proper response.\\n\\n```\\n$ curl http://localhost:8083/hello/1\\nSuccess\\n\\n$ curl http://localhost:8083/hello/3\\n500 Internal Server Error\\n```\\n\\nAlso check if a request with the `/metrics`API properly returns the Prometheus metrics as a response.\\n\\n```\\n$ curl -s http://localhost:8083/metrics | grep \\"my_http_service_requests_total\\"\\n# HELP my_http_service_requests_total\\n# TYPE my_http_service_requests_total counter\\nmy_http_service_requests_total{hostname_pattern=\\"*\\",http_status=\\"500\\",method=\\"hello\\",result=\\"success\\",service=\\"com.example.armeria_prometheus.MyAnnotatedService\\",} 0.0\\nmy_http_service_requests_total{hostname_pattern=\\"*\\",http_status=\\"200\\",method=\\"hello\\",result=\\"failure\\",service=\\"com.example.armeria_prometheus.MyAnnotatedService\\",} 0.0\\nmy_http_service_requests_total{hostname_pattern=\\"*\\",http_status=\\"200\\",method=\\"hello\\",result=\\"success\\",service=\\"com.example.armeria_prometheus.MyAnnotatedService\\",} 1.0\\nmy_http_service_requests_total{hostname_pattern=\\"*\\",http_status=\\"500\\",method=\\"hello\\",result=\\"failure\\",service=\\"com.example.armeria_prometheus.MyAnnotatedService\\",} 1.0\\n```\\n\\n### Installing and configuring Prometheus\\n\\nFirst install Prometheus with the [Homebrew](https://brew.sh/index_ko) package manager.\\n\\n```\\n$ brew install prometheus\\n```\\n\\nWhen the installation process is finished, a file named \'prometheus.yml\' is created.\\nYou can use this YAML file to change Prometheus configurations.\\n\\n```\\n$ vi $(brew --prefix)/etc/prometheus.yml\\n```\\n\\nCarefully enter the paths and ports for collecting the Prometheus metrics in the configuration file.\\n\\n```yaml title=\\"prometheus.yml\\"\\nglobal:\\n  scrape_interval: 10s\\n\\nscrape_configs:\\n  - job_name: \'armeria-prometheus\'\\n    metrics_path: \'/metrics\'\\n    static_configs:\\n      - targets: [\'localhost:8083\']\\n```\\n\\nOnce you have made the changes, you must restart the Prometheus service to apply the changed settings.\\n\\n```\\n$ brew services start prometheus\\n```\\n\\nPrometheus uses the 9090 port by default.\\nNavigate to [http://localhost:9090](http://localhost:9090/) on your browser and you will see the screen shown below.\\n\\n![](/img/monitoring-prometheus-metrics-from-armeria-1.png)\\n\\nEnter \\"Armeria\\" into the search field to check if the related metrics have been properly collected from the Prometheus server.\\n\\n![](/img/monitoring-prometheus-metrics-from-armeria-2.png)\\n\\nTry sending multiple `/hello/{seq}` API requests and see if the `my_http_service_requests_total` metric properly increases.\\n\\n![](/img/monitoring-prometheus-metrics-from-armeria-3.png)\\n\\n### Installing and configuring Grafana\\n\\nInstall and run the Grafana service using Homebrew the same way you installed Prometheus.\\n\\n```\\n$ brew install grafana\\n$ brew services start grafana\\n```\\n\\nGrafana uses the 3000 port by default.\\nNavigate to [http://localhost:3000](http://localhost:3000/) on your browser and you will see the login screen shown below.\\n\\n![](/img/monitoring-prometheus-metrics-from-armeria-4.png)\\n\\nDon\'t worry if you have never created an account.\\nYou can enter \'admin\' on both the **Email or username** and **Password** field to log in.\\nAs you can probably tell from the name, \\"admin\\" is a very basic account, and you will need to create a proper new account when you actually run the service in a real environment.\\n\\nEnter the path to Prometheus in the **Data Source** field to display the Prometheus metrics as a graph on Grafana.\\n\\n![](/img/monitoring-prometheus-metrics-from-armeria-5.png)\\n\\nNext, create a dashboard and then add a panel where you can monitor the number of successful and unsuccessful attempts of the `/hello/{seq}` API.\\n\\n![](/img/monitoring-prometheus-metrics-from-armeria-6.png)\\n\\nThe queries are as follows.\\n\\n- 200: `increase(my_http_service_requests_total{hostname_pattern=\\"*\\", method=\\"hello\\", http_status=\\"200\\", result=\\"success\\", service=\\"com.example.armeria_prometheus.MyAnnotatedService\\"}[1m])`\\n- 500: `increase(my_http_service_requests_total{hostname_pattern=\\"*\\", method=\\"hello\\", http_status=\\"500\\", result=\\"failure\\", service=\\"com.example.armeria_prometheus.MyAnnotatedService\\"}[1m])`\\n\\nThe `armeria_server_requests_total` metric is a [Counter](https://prometheus.io/docs/concepts/metric_types/#counter)-type metric that only continues to increase until you reset it.\\nBecause of this, the cumulative amount of times the API call succeeded or failed doesn\'t provide much insight when monitoring in a real environment.\\nWhat you should instead focus on, is how many times it either succeeded or failed in a given time frame .\\nFor this purpose, you can use the [increase()](https://prometheus.io/docs/prometheus/latest/querying/functions/#increase) function to express the number of successful and unsuccessful attempts per minute as a graph.\\n\\n### Test results\\n\\nLet\'s now run the client code below to send 100 API requests. (We used Armeria\'s [WebClient](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/WebClient.html))\\n\\n```java title=\\"HttpClientApplication.java\\"\\npublic class HttpClientApplication {\\n\\n    private static final Logger logger = LoggerFactory.getLogger(HttpClientApplication.class);\\n\\n    public static void main(String[] args) {\\n        WebClient client = WebClient.of(\\"http://localhost:8083/\\");\\n        for (int i = 0; i < 100; i++) {\\n            AggregatedHttpResponse res = client.get(\\"/hello/\\" + i).aggregate().join();\\n            logger.info(res.content(StandardCharsets.UTF_8));\\n        }\\n    }\\n}\\n```\\n\\nYou can see the results of calling the `/hello/{seq}` API being expressed as a beautiful graph on Grafana.\\n\\n![](/img/monitoring-prometheus-metrics-from-armeria-7.png)\\n\\n## Closing words\\n\\nIn this post, we took a look at how you can monitor Prometheus metrics collected from running an Armeria server, using a Grafana dashboard.\\nArmeria provides various features for collecting metrics, and in our next post we will take a look at how you can customize the metrics you collect from Armeria to your needs."},{"id":"/2020/07/08/circuit-breakers-armeria","metadata":{"permalink":"/blog/2020/07/08/circuit-breakers-armeria","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2020-07-08-circuit-breakers-armeria.mdx","source":"@site/src/content/blog/en/2020-07-08-circuit-breakers-armeria.mdx","title":"Using Circuit Breakers with Armeria","description":"What is a circuit breaker?","date":"2020-07-08T00:00:00.000Z","tags":[],"readingTime":6.71,"hasTruncateMarker":true,"authors":[{"name":"Seunghwan Joo","title":"Seunghwan is in charge of LINE OpenChat back-end development","imageURL":"/img/author-seunghwanjoo.jpeg","key":"seunghwanjoo","page":null}],"frontMatter":{"authors":["seunghwanjoo"],"other_languages":{"ko":"/blog/ko/2020/04/27/circuit-breakers-armeria"}},"unlisted":false,"prevItem":{"title":"Monitoring Prometheus metrics from Armeria","permalink":"/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria"},"nextItem":{"title":"Let\'s Play with Reactive Streams on Armeria - Part 2","permalink":"/blog/2020/07/03/reactive-streams-armeria-2"}},"content":"## What is a circuit breaker?\\n\\nSuppose an unexpected failure occurs (For example, a network issue or a server crash) and a remote server is unable to respond to the request.\\nIf so, the client who made the request to the remote server will either wait for a response until a timeout occurs, consume resources, or eventually continue to send unnecessary requests.\\nAnd on a Microservice Architecture (MSA), this client can also be a server for other services.\\nIn the end, clients of this server will have the same problem.\\n\\n{/* truncate */}\\n\\nThis continuous propagation of failures results in the failure of one remote server having a significant impact on all systems.\\nThe concept that emerged to solve this problem is known as the circuit breaker.\\n\\nIn other words, circuit breakers are a fast method of failing a request from a client to a remote server when the failure rate exceeds a certain threshold, self-diagnosing that there is a problem with the server, and no longer sending unnecessary requests.\\nUsing circuit breakers allows us to avoid the aforementioned problems and minimize the size of failure.\\n\\nYou can read more about the concept of circuit breakers in this article previously posted on the blog: [Circuit breakers for distributed services](/blog/2016/07/24/circuit-breakers-for-distributed-services)\\n\\n## Status of a circuit breaker\\n\\nA circuit breaker can be in one of the following three states.\\n\\n![](/img/circuit-breakers-armeria-1.png)\\n\\n- `CLOSED`: The failure rate of the request is lower than the configured threshold. This is the initial and default state.\\n- `OPEN`: The failure rate of the request is beyond the configured threshold. Errors occur immediately without sending the actual request (Fails fast).\\n- `HALF_OPEN`: A status where the response is successful by sending a request once in the middle of the `OPEN` state. If successful, the state switches back to `CLOSED`. Upon failure, the state is left `OPEN`.\\n\\n## Armeria\'s circuit breaker\\n\\n[Armeria](https://github.com/line/armeria) is an open-source asynchronous microservice framework based on [Netty](https://netty.io/) that is maintained by LINE engineers, which can implement and provide circuit breakers directly.\\nLet me show you how circuit breakers work with Armeria.\\n\\n### Preparation\\n\\nFirst, let\'s launch two simple servers (Server1, Server2) to send and receive requests.\\nServer1 sends a `/world` request to Server2 when a `/hello` request is received from the Client.\\nWhen you receive a response from Server2, you return the response back to the client.\\nServer1 is a server, but it is also a client of Server2.\\n\\n![](/img/circuit-breakers-armeria-2.png)\\n\\n#### Server2 implementation code\\n\\nFirst, here is the implementation of Server2 which will receive the response of Server1.\\nIn response to requests coming into `/world`, success (200) and failure (500) are simply implemented to return.\\n\\n```java title=\\"Server2Application.java\\"\\n@SpringBootApplication\\npublic class Server2Application {\\n\\n    private static final AtomicInteger REQ_CNT = new AtomicInteger();\\n\\n    public static void main(String[] args) {\\n        ServerBuilder sb = Server.builder();\\n        sb.http(5008);\\n        sb.decorator(LoggingService.newDecorator());\\n\\n        sb.service(\\"/world\\", (ctx, res) -> {\\n            if (REQ_CNT.addAndGet(1) % 2 == 0) {\\n                return HttpResponse.of(HttpStatus.INTERNAL_SERVER_ERROR);\\n            }\\n            return HttpResponse.of(HttpStatus.OK);\\n        });\\n\\n        Server server = sb.build();\\n        CompletableFuture<Void> future = server.start();\\n        future.join();\\n    }\\n}\\n```\\n\\n#### Server1 implementation code\\n\\nHere is the implementation of Server1.\\nUnlike the simple one using `ServerBuilder` on Server2, you can find the Service bean that receives requests from the client and the Client bean that sends requests to Server2.\\n\\n```java title=\\"Server1Application.java\\"\\n@SpringBootApplication\\n@Import(Server1Context.class)\\npublic class Server1Application {\\n\\n    public static void main(String[] args) {\\n        SpringApplication.run(Server1Application.class, args);\\n    }\\n}\\n```\\n\\n```java title=\\"Server1Context.java\\"\\n@Configuration\\npublic class Server1Context {\\n\\n    @Bean\\n    public HttpServiceRegistrationBean httpService(WebClient webClient) {\\n        return new HttpServiceRegistrationBean()\\n                .setService((ctx, req) -> webClient.get(\\"/world\\"))\\n                .setServiceName(\\"httpService\\")\\n                .setRoute(Route.builder()\\n                               .path(\\"/hello\\")\\n                               .methods(HttpMethod.GET)\\n                               .build());\\n    }\\n\\n    @Bean\\n    public WebClient webClient() {\\n        CircuitBreakerStrategy strategy = CircuitBreakerStrategy.onServerErrorStatus();\\n\\n        // CircuitBreaker \xec\x84\xa4\xec \x95!!!\\n        CircuitBreaker circuitBreaker = CircuitBreaker\\n                .builder(\\"test-circuit-breaker\\")\\n                .counterSlidingWindow(Duration.ofSeconds(10))\\n                .circuitOpenWindow(Duration.ofSeconds(5))\\n                .failureRateThreshold(0.3)\\n                .minimumRequestThreshold(5)\\n                .trialRequestInterval(Duration.ofSeconds(3))\\n                .build();\\n\\n        return WebClient\\n                .builder(\\"http://localhost:5008\\")\\n                .decorator(LoggingClient.newDecorator())\\n                .decorator(CircuitBreakerHttpClient.newDecorator(circuitBreaker, strategy))\\n                .build();\\n    }\\n}\\n```\\n\\nPay attention to the fact that a Client object has its own `CircuitBreaker` when you use `CircuitBreaker` in Armeria.\\nIn other words, if a new Client object is created for each request to Server2 and is extinguished after the request is completed, the `CircuitBreaker` connected to the Client would eventually become useless.\\n\\nTherefore, we need a `WebClient` bean that sends requests to Server2 to reuse the same `WebClient` object for the requests to all Server2.\\nAnd we can apply `CircuitBreaker` to the `WebClient` object using the [Decorator](https://armeria.dev/docs/client-decorator) provided by Armeria.\\n\\nLet\'s take a look at each field of the `CircuitBreaker` settings above.\\n\\n- `counterSlidingWindow` (10s): The time interval between measuring the number of successful/failed requests in `CircuitBreaker`. It is used to determine what state to transition or maintain based on a 10-second aggregate.\\n- `circuitOpenWindow`(5s): The duration that `CircuitBreaker` is kept `OPEN`. Throws an error right away without asking the external server for 5 seconds once in an `OPEN` state (`FailFastException`).\\n- `failureRateThreshold`(0.3): The rate of failure of the request required to switch to an `OPEN` state. Requests greater than 0.3 (30%) must fail during the `circuitOpenWindow` time to enter the `OPEN` state.\\n- `minimumRequestThreshold`(5): Minimum number of requests required for measurement. Even if the failure rate is higher than `failureRateThreshold`, it must be the result of at least five requests before it becomes `OPEN`.\\n- `trialRequestInterval`(s): Time to remain in the `HALF_OPEN` state. For 3 seconds, it throws a `FailFastException` error as it did when it was `OPEN`, while sending requests to external servers to check if the server returned to normal. If the response to the request sent in these 3 seconds is successful, it immediately switches to the `CLOSED` state; if all fails, it goes back to the `OPEN` state.\\n\\n### Testing\\n\\nNow let\'s send requests from the terminal to Server1 using the [loadtest](https://www.npmjs.com/package/loadtest) library.\\n\\n```\\n$ loadtest http://127.0.0.1:5007/hello --rps 1\\n```\\n\\nThe log of Server1 provides information on the behavior of `CircuitBreaker`.\\n\\n![](/img/circuit-breakers-armeria-3.png)\\n\\nWhen the server first started, the initial state of `CircuitBreaker` was `CLOSED`.\\n\\nAt 03:03:41.830 - Of the total 5 requests measured, the number of failures was 2, so the failure rate was 2/5 = 0.4.\\nThus, the failure rate was greater than the previously set failure rate of 0.3 (`failureRateThreshold`) and the number of requests used in the measurement was greater than 5 (`minimumRequestThreshold`), so `CircuitBreaker` switched to the `OPEN` state.\\n\\n![](/img/circuit-breakers-armeria-4.png)\\n\\nFrom 03:03:41.830 to 03:03:47.824 - `FailFastException` errors continued to occur during subsequent periods, in approximately 5 seconds (`circuitOpenWindow`). (If you check the logs on Server2, you can see that the request was not received at that time.)\\n\\n![](/img/circuit-breakers-armeria-5.png)\\n\\nAt 03:03:47.824 - the transition is made to the `HALF_OPEN` state, where requests from clients were actually sent to Server2.\\nAt this point, the transmitted request luckily received a 200 response and then `CircuitBreaker` switched to the `CLOSED` state.\\n\\n![](/img/circuit-breakers-armeria-6.png)\\n\\nThis process is repeated again because it is `CLOSED` again.\\nFrom 03:03:47.827 to 03:03:56.824 - The failure rate was measured for approximately 10 seconds (`counterSlidingWindow`), and the failure rate measured this time was 4/8 = 0.5, so `CircuitBreaker` switched back to the `OPEN` state.\\n\\n![](/img/circuit-breakers-armeria-7.png)\\n\\nWe\'ve taken a look at Armeria\'s circuit breaker in action with the simple test above.\\nI hope you now have a better understanding of what the various configurations and operations are for, and how easy it is to implement a circuit breaker client for yourself.\\n\\n> For more information on Armeria\'s circuit breakers, please take a look at the [official Armeria documentation on circuit breakers](https://line.github.io/armeria/client-circuit-breaker.html).\\n\\n## Conclusion\\n\\nArmeria provides several features useful to running an MSA in addition to circuit breakers.\\nThese features include client-side load balancing and auto-retry.\\nWe use Armeria ourselves in our own OpenChat server development, and are enjoying the many benefits its features bring to our daily work.\\nI dedicate this post to the open-source Armeria development team who are working day and night to make requested features a reality."},{"id":"/2020/07/03/reactive-streams-armeria-2","metadata":{"permalink":"/blog/2020/07/03/reactive-streams-armeria-2","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2020-07-03-reactive-streams-armeria-2.mdx","source":"@site/src/content/blog/en/2020-07-03-reactive-streams-armeria-2.mdx","title":"Let\'s Play with Reactive Streams on Armeria - Part 2","description":"In the first part of this blog post, we took a look at the basic concepts of Reactive Streams.","date":"2020-05-06T11:00:00.000Z","tags":[],"readingTime":12.7,"hasTruncateMarker":true,"authors":[{"name":"Um Ikhun","title":"Ikhun is developing for open-source Armeria and Central Dogma at LINE Plus.","imageURL":"https://github.com/ikhoon.png","key":"ikhunum","page":null}],"frontMatter":{"date":"2020-05-06T11:00","authors":["ikhunum"],"other_languages":{"ko":"/blog/ko/2020/02/19/reactive-streams-armeria-2","ja":"/blog/ja/2020/03/26/reactive-streams-armeria-2"}},"unlisted":false,"prevItem":{"title":"Using Circuit Breakers with Armeria","permalink":"/blog/2020/07/08/circuit-breakers-armeria"},"nextItem":{"title":"Let\'s Play with Reactive Streams on Armeria - Part 1","permalink":"/blog/2020/05/06/reactive-streams-armeria-1"}},"content":"In the [first part of this blog post](/blog/2020/05/06/reactive-streams-armeria-1), we took a look at the basic concepts of Reactive Streams.\\nIn part 2 of this blog post, I\'d like to tell you about how we use Reactive Streams with Armeria.\\n\\n{/* truncate */}\\n\\n## What\u2019s Armeria?\\n\\nArmeria is an open-source asynchronous HTTP/2, RPC, REST client/server library based on Java 8, Netty, Thrift, and gRPC.\\nWhile Armeria is a lightweight microservices framework, its capabilities is comparable to existing full stack web frameworks.\\n\\nLet\'s first take a look at some prerequisite knowledge for setting up a Reactive Streams server on Armeria.\\n\\n### Supported protocols\\n\\n![](/img/reactive-streams-armeria-2-1.png)\\n\\nArmeria supports both HTTP/1 and HTTP/2, and these protocols both support [cleartext](https://simple.wikipedia.org/wiki/Cleartext) and TLS (Transport Layer Security) cryptographic protocols.\\nTo ensure compatibility between HTTP/1 and HTTP/2, Armeria supports both HTTP/2\'s connection preface and HTTP/1\'s upgrade request.\\n\\nFurthermore, gRPC and Thrift works with both HTTP/1 and HTTP/2 on Armeria.\\nThis is a unique feature of Armeria. gRPC normally doesn\'t support HTTP/1 and Thrift normally doesn\'t support HTTP/2.\\nHowever, Armeria\'s wide array of support allows it to be used in a variety of business environments.\\nIn Linux environments, Armeria supports JNI-based (Java Native Interface) socket IOs and BoringSSL-based TLS to allow better performance during production.\\n\\nLet\'s take a closer look at Armeria along with some sample code.\\n\\n### A closer look at Armeria\\n\\nArmeria is a user-friendly API with simple and easy-to-use code.\\nYou only need to write the following five lines if you want to run a \\"Hello world\\" server.\\n\\n```\\n// Build your own server under 5 lines.\\nvar server = Server.builder()\\n       .http(8080)\\n       .service(\u201c/\u201c, (ctx, req) -> HttpResponse.of(\u201cHello, World!\u201d))\\n       .build();\\n\\nserver.start();\\n```\\n\\nThe ability to easily run servers is a core feature for running separate business components on independent servers in a microservices environment.\\n\\nArmeria also allows you to simplify server architecture.\\nYou don\'t need to run [sidecar patterns](https://docs.microsoft.com/en-us/azure/architecture/patterns/sidecar) such as Nginx or static web servers such as Apache httpd to use HTTPS or HTTP/2.\\nAs mentioned, Armeria supports JNI-based socket IOs and BoringSSL in Linux environments, making it relatively less prone to performance impact.\\nYou can also [serve static files](https://line.github.io/armeria/docs/server-http-file) such as JS, CSS, or images.\\n\\n```\\nvar server = Server.builder()\\n       .http(8080)\\n       .https(8443) // HTTPS support\\n       .tlsSelfSigned()\\n       .service(\u201c/\u201c, (ctx, req) -> HttpResponse.of(\u201cHello, World!\u201d))\\n       .build();\\nserver.start();\\n```\\n\\nYou no longer need to add network hops with Armeria, allowing you to reduce points of failure, use resources more efficiently, simplify architecture, monitor activity, and dynamically expand your servers.\\n\\nThere\'s even more.\\nArmeria comes with built-in annotation that lets you use its features even more easily.\\nFor example, you can easily write routing code by setting `hello` as a prefix, and `name` as a path variable like the code below (For more information on using annotations, refer to [official Armeria documentation](https://armeria.dev/docs/server-annotated-service)).\\n\\n```\\nimport com.linecorp.armeria.server.annotation.Get;\\nimport com.linecorp.armeria.server.annotation.Param;\\nimport com.linecorp.armeria.server.annotation.PathPrefix;\\n\\n// Use built-in annotations for mapping path and parameter injection\\n@PathPrefix(\u201c/hello\u201d)\\nclass HelloService {\\n   @Get(\u201c/:name\u201d)\\n   public String hello(@Param String name) {\\n       return String.format(\u201cHello, %s!\u201d, name);\\n   }\\n}\\n```\\n\\nArmeria also comes with special features that allow you to serve multiple RPC protocols simultaneously.\\nYou can provide REST API, gRPC, and Thrift on a single server, allowing you to flexibly adapt to any business requirements or architecture changes.\\nThe single port design enables you to efficiently use resources, minimize unnecessary exposure, and reduce potential maintenance costs. [[1]](#footnotes)\\n\\n```\\nvar server = Server.builder()\\n   .http(8080)\\n   .service(\u201c/hello/rest\u201d, (ctx, req) -> HttpResponse.of(\u201cHello, world!\u201d))\\n   .service(\u201c/hello/thrift\u201d, THttpService.of(new ThriftHelloService()))\\n   .service(\u201c/hello/grpc\u201d, GrpcService.builder()\\n                                      .addService(new GrpcHelloService())\\n                                      .build())\\n   .build();\\n```\\n\\nEnterprise software developers would all agree that they\'ve spent countless hours coming up with ways to efficiently process authentication and logging.\\nWith Armeria, you can put those worries aside.\\nYou can use a separate [decorator](https://armeria.dev/docs/server-decorator) to manage this [separation of concerns](https://en.wikipedia.org/wiki/Separation_of_concerns).[[2]](#footnotes)\\n\\nIf you wish to add an additional decorator, you can always manually implement and bind one to a specific path or service.\\nFor example, `AuthService`in the figure below only calls the service when a `request` includes authentication info, and returns a \\"401 unauthorized\\" error if not.\\n\\n![](/img/reactive-streams-armeria-2-2.png)\\n\\nNext, let\'s take a look at how Armeria works with Reactive Streams.\\n\\n### HTTP/2 streams inside Armeria\\n\\nAs the name suggests, \\"streams\\" need to maintain a connection and let data constantly flow.\\nIf there is only one opening while everywhere else is closed, it will lead to an overload.\\nArmeria uses the back pressure feature of Reactive Streams to dynamically control data flow inside servers.\\nAlso, back pressure that utilizes [HTTP/2 stream flow control](https://tools.ietf.org/html/rfc7540#section-5.2) using [WINDOW_UPDATE](https://http2.github.io/http2-spec/#WINDOW_UPDATE) allows you to dynamically connect the Armeria server with your services and repositories from subnetwork layers.\\n\\n![](/img/reactive-streams-armeria-2-3.png)\\n\\nIf converting your service\'s server to an Armeria Reactive server is difficult at the moment, you could use an Armeria Reactive proxy server by following the sample code and [instructions available on the repository](https://github.com/line/armeria-examples/tree/master/proxy-server).\\n\\n```\\n// Use Armeria\u2019s async & reactive HTTP/2 client.\\nvar client = HttpClient.of(\u201ch2c://backend\u201d);\\nvar server = Server.builder()\\n    .http(8080)          // Forward all requests reactively\\n    .service(\u201cprefix:/\u201c, (ctx, req) -> client.execute(req))\\n    .build();\\n```\\n\\nWith an Armeria proxy server at the forefront, you can keep your server safe from any external threats on the internet.\\n\\n![](/img/reactive-streams-armeria-2-4.png)\\n\\n## Consolidating Reactive Streams and Armeria\\n\\nIf you create an Armeria server with direct support of Reactive Streams, even more features are available to you.\\nLet\'s take a closer look at how you can use Reactive Streams on Armeria, and some details about the built-in publisher.\\n\\n### Armeria HTTP response publisher\\n\\nResponses on Armeria are comprised of [HttpHeaders](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpHeaders.html) and [HttpData](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpData.html).\\nI will explain how you can convert an RxJava [Observable](http://reactivex.io/RxJava/javadoc/io/reactivex/Observable.html) to an Armeria [HttpResponse](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpResponse.html) step-by-step.\\n\\nOnce your data is ready, wrap `dataStream`with `HttpData` using the `Observable map` operator.\\n\\n```\\n// 1. Fetch data from Reactive Streams Publisher\\nObservable<String> dataStream = Observable.just(\u201ca\u201d, \u201cb\u201d, \u201cc\u201d, \u201cd\u201d, \u201ce\u201d);\\n\\n// 2. Convert string to Armeria HttpData\\nObservable<HttpData> httpDataStream = dataStream.map(HttpData::ofUtf8);\\n```\\n\\nOnce you have a confirmed response and a response header, combine it with the `httpDataStream` prepared above using the `concat` operator.\\nThis will complete a connected stream from `HttpHeaders`to `HttpData`.\\n\\n```\\n// 3. Prepare response headers\\nResponseHeaders httpHeaders = ResponseHeaders.of(HttpStatus.OK);\\n\\n// 4. Concat http header and body stream\\nObservable<HttpObject> responseStream = Observable.concat(Observable.just(httpHeaders), httpDataStream);\\n```\\n\\nConvert the completed stream to a Reactive Streams [Flowable](https://www.baeldung.com/rxjava-2-flowable) using the `Observable` `toFlowable` function, and wrap it with Armeria\'s `HttpResponse` to complete the conversion.\\n\\n```\\n// 5. Convert Observable to Armeria Response Stream\\nHttpResponse response = HttpResponse.of(responseStream.toFlowable(BackpressureStrategy.BUFFER));\\n```\\n\\n### Armeria\'s built-in publisher\\n\\nThe steps above may seem too complicated or boring.\\nThat\'s why Armeria provides a built-in publisher for [JSON Text Sequences(RFC 7464)](https://tools.ietf.org/html/rfc7464), the standard way of sending stream data on the web, and [Server-sent events](https://en.wikipedia.org/wiki/Server-sent_events), the HTML5 standard.\\nThis publisher will allow you to send Reactive Streams on the web more easily.\\n\\n```\\n// Fetch data from Reactive Streams Publisher\\nPublisher<String> dataStream = Flux.just(\u201ca\u201d, \u201cb\u201d, \u201cc\u201d, \u201cd\u201d, \u201ce\u201d);\\n\\n// Convert Publisher to JSON Text Sequences with Armeria HttpResponse\\n// with \u201capplication/json-seq\u201d MIME type\\nHttpResponse httpResponse = JsonTextSequences.fromPublisher(dataStream);\\n\\n// Convert Publisher to Server-sent Events with Armeria HttpResponse\\n// with \u201ctext/event-stream\u201d MIME type\\nHttpResponse httpResponse = ServerSentEvents\\n        .fromPublisher(dataStream, SeverSentEvent::ofData);\\n```\\n\\nRxJava consolidation support is available for those looking to use the built-in publisher even more easily.\\nAdd the `@ProduceJsonSequence` annotation to the annotated service and return `Observable` for automatic conversion on Armeria to the protocols mentioned above.\\n\\n```\\nimport io.reactivex.Observable;\\nimport com.linecorp.armeria.server.annotation.ProducesJsonSequences;\\n\\nclass RxJavaService {\\n    @Get(\u201c/json-streaming\u201d)\\n      // Generate JSON Text Sequences\\n    @ProducesJsonSequences\\n    public Observable<String> json() {\\n          // Just return RxJava Observable!\\n        return Observable.just(\u201ca\u201d, \u201cb\u201d, \u201cc\u201d);\\n    }\\n};\\n```\\n\\nEncoding a JSON text string with \'JsonTextSequences\' will add a separator and line feed to the beginning and end respectively.\\nDepending on the protocol, different operations are required when sending data through HTTP/1 or HTTP/2.\\nArmeria automatically finds the appropriate format according to the currently connected protocol.\\nJSON data is divided inside the [Data frame](https://http2.github.io/http2-spec/#DATA) for HTTP/2, and [chunked transfer encoding](https://en.wikipedia.org/wiki/Chunked_transfer_encoding) is used for HTTP/1.\\n\\n![](/img/reactive-streams-armeria-2-5.png)\\n\\n## Migrating Spring WebFlux\\n\\nArmeria supports various libraries and frameworks.\\nIf you are already using [Spring WebFlux](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html) to use Reactive Streams, you only need to [add](https://armeria.dev/docs/advanced-spring-webflux-integration)`armeria-spring-boot-webflux-starter`[to your dependencies](https://armeria.dev/docs/advanced-spring-webflux-integration) to complete migration to Armeria.\\nYou can replace [Reactor-Netty](https://github.com/reactor/reactor-netty), a WebFlux network layer, with Armeria\'s Reactive engine with this way.\\n\\n![](/img/reactive-streams-armeria-2-6.png)\\n\\nYou may be thinking to yourself \\"Shouldn\'t I just use WebFlux if I only want to replace the engine?\\" What advantages are there to going through the process above?\\n\\nYou can add Armeria features to Spring with [ArmeriaServerConfigurator](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/spring/ArmeriaServerConfigurator.html) if you replace your engine, allowing you to use unique Armeria features that aren\'t normally available on Spring.\\nFor example, you can add gRPC and Thrift features to a REST API Spring WebFlux server, and serve it through the same single port.\\n\\n```\\n@Configuration\\npublic class ArmeriaConfiguration {\\n   // Configure the server by providing an ArmeriaServerConfigurator bean.\\n   @Bean\\n   public ArmeriaServerConfigurator armeriaServerConfigurator() {\\n       // Customize the server using the given ServerBuilder. For example:\\n       return builder -> {\\n           // Add DocService that enables you to send gRPC and Thrift requests from web browser.\\n           builder.serviceUnder(\u201c/docs\u201d, new DocService());\\n           // Log every message which the server receives and responds.\\n           builder.decorator(LoggingService.newDecorator());\\n           // Write access log after completing a request.\\n           builder.accessLogWriter(AccessLogWriter.combined(), false);\\n           // You can also bind asynchronous RPC services such as Thrift and gRPC:\\n           builder.service(THttpService.of(\u2026));\\n           builder.service(GrpcService.builder()\u2026build());\\n       };\\n   }\\n}\\n```\\n\\nThe decorator features mentioned above are also available, to make your service more feature-rich.\\n\\n## Support for gRPC streams\\n\\n[gRPC supports streams](https://grpc.io/docs/tutorials/basic/java/#server-side-streaming-rpc) through [StreamObserver](https://grpc.github.io/grpc-java/javadoc/io/grpc/stub/StreamObserver.html), and you can easily convert to gRPC\'s StreamObserver with Reactive Streams.\\nLet\'s take a look at the example below.\\n\\nFirst, decide how to send and receive data using protobuf, and define your interface.\\n\\n```\\nsyntax = \u201cproto3\u201d;\\npackage users;\\noption java_package = \u201cusers\u201d;\\n\\nservice UserService {\\n  // Returns all user information\\n  rpc getAllUsers(UserRequest) returns (stream User) {}\\n\\n  // Push to stream of users\\n  rpc pushToUsers(stream User) returns (Result) {}\\n}\\n```\\n\\nIn order to send emails and push messages to all users, you must first look up the information of all users.\\nIf there are too many users, it may be difficult to send the data at once.\\nIn cases like this, you can build a stream server that returns large amounts of user information on gRPC by following the instructions below.\\n\\n1. Use ProjectReactor\'s `Flux`as a publisher to look up data on the repository in the format of a stream.\\n2. Convert to gRPC `StreamObservser` and send the data to an external location.\\n\\n```\\n// Implement interfaces generated by gRPC\\npublic final class UserServiceImpl extends UserServiceImplBase {\\n    @Override\\n    public void getAllUsers(UserRequest request, StreamObserver<User> responseObserver) {\\n        final Flux<User> userPublisher = userRepo.findAll();\\n        publisher.subscribe(responseObserver::onNext,\\n                            responseObserver::onError,\\n                            responseObserver::onCompleted);\\n    }\\n}\\n```\\n\\n`StreamObserver`, like Reactive Streams, has `onNext`, `onError`, `onCompleted` functions that can be matched and linked to APIs.\\n\\nThis time let\'s think how you would receive the data containing all user information.\\nFor this demonstration I will be using `Processor`. `Processor` doesn\'t have separate API, and simply inherits `Subscriber`and `Publisher`.\\nYou can use `Processor` to easily subscribe to data, and publish the subscribed data easily.\\nYou can send new user info that was received through `StreamObserver\'s` `onNext using Processor\'s onNext` function, and can further perform additional tasks by resubscribing.\\n\\n```\\n@Override\\npublic StreamObserver<User> pushToUsers(StreamObserver<Result> responseObserver) {\\n    Processor<User, User> processor = EmitterProcessor.create();\\n    Publisher<User> publisher = processor;\\n    Subscriber<User> subscriber = processor;\\n    // Push one-by-one by subscribing publisher\\n    ...\\n\\n      return new StreamObserver<User>() {\\n        // subscribe user data \xe2\x80\xa8\\n        @Override public void onNext(User user) { processor.onNext(user); }\\n        @Override public void onError(Throwable throwable) { processor.onError(throwable); }\\n        @Override public void onCompleted() {\\n            responseObserver.onNext(Result.newBuilder().setStatus(200).build());\\n            responseObserver.onCompleted();\\n        }\\n    };\\n}\\n```\\n\\nLet\'s run the gRPC code that we wrote on Armeria.\\n\\n```\\nimport com.linecorp.armeria.server.Server;\\nimport com.linecorp.armeria.server.grpc.GrpcService;\\n\\n// Add your grpc service to Armeria GrpcService\\nvar grpcService = GrpcService.builder()\\n                             .addService(new UserServiceImpl())\\n                             .build();\\n\\nvar server = Server.builder()\\n                   .http(8080)\\n                   .serviceUnder(\u201c/grpc\u201d, grpcService)\\n                   .serviceUnder(\u201c/docs\u201d, new DocService())\\n                   .build();\\n```\\n\\nWith a stream server like this, you can stream large amounts of data using only a small amount of memory.\\n\\n## Armeria features for microservices\\n\\nUsing Reactive Streams through Armeria allows you to easily handle large amounts of data and traffic.\\nRPC allows your microservices to communicate with each other more easily as well.\\n\\nIn addition, here are some more features catered towards microservices:\\n\\n- Kubernetes-type DNS (Domain Name System) and [service discovery with ZooKeeper](https://armeria.dev/docs/advanced-zookeeper) for easily locating servers in a cloud environment.\\n- Client-side load-distribution for searched services during communication with the server. Fewer points of failure.\\n- Direct server diagnosis with non-[L7](https://www.nginx.com/resources/glossary/layer-7-load-balancing/) clients.\\n- Automatic access logging to Kafka without the need to access distributed servers.\\n- Easy transfer of metrics to application monitoring tools such as Netflix\'s Atlas and Prometheus through Micrometer\'s filters.\\n\\n![](/img/reactive-streams-armeria-2-7.png)\\n\\n## Conclusion\\n\\nThrough parts 1 and 2 of this blog post, we took a look at Reactive Streams and Armeria.\\nArmeria allows you to build an asynchronous server that is safe, less prone to failure, and can harness the high performance of Reactive Streams, while also supporting RPC and HTTP/2.\\n\\nThe features mentioned in this blog post aren\'t everything there is to Armeria.\\nFor more information on what Armeria can do for you, refer to the [official website](https://armeria.dev/) and the following sources.\\n\\n- GitHub: [line/armeria](https://github.com/line/armeria)\\n- Twitter: [@armeria_project](https://twitter.com/armeria_project)\\n- Chat: [Discord](https://armeria.dev/s/discord)\\n- [API documentation](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/index.html), [release notes](https://armeria.dev/release-notes/)\\n- Armeria examples: [line/armeria-examples](https://github.com/line/armeria-examples)\\n\\n---\\n\\n#### Footnotes\\n\\n1. Refer to [Running a gRPC service](https://armeria.dev/docs/server-grpc) and [Running a Thrift service](https://armeria.dev/docs/server-thrift).\\n2. For more information on the various decorators provided with Armeria, refer to the Armeria and Javadoc official documentation.\\n   - [Decorating a service](https://armeria.dev/docs/server-decorator)\\n   - [Decorating a client](https://armeria.dev/docs/client-decorator)\\n   - Check Direct Known Subsclasses on [SimpleDecoratingHttpService](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/SimpleDecoratingHttpService.html) and [SimpleDecoratingClient](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/SimpleDecoratingClient.html)"},{"id":"/2020/05/06/reactive-streams-armeria-1","metadata":{"permalink":"/blog/2020/05/06/reactive-streams-armeria-1","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2020-05-06-reactive-streams-armeria-1.mdx","source":"@site/src/content/blog/en/2020-05-06-reactive-streams-armeria-1.mdx","title":"Let\'s Play with Reactive Streams on Armeria - Part 1","description":"What is Reactive Streams?","date":"2020-05-06T10:00:00.000Z","tags":[],"readingTime":11.56,"hasTruncateMarker":true,"authors":[{"name":"Um Ikhun","title":"Ikhun is developing for open-source Armeria and Central Dogma at LINE Plus.","imageURL":"https://github.com/ikhoon.png","key":"ikhunum","page":null}],"frontMatter":{"date":"2020-05-06T10:00","authors":["ikhunum"],"other_languages":{"ko":"/blog/ko/2020/02/18/reactive-streams-armeria-1","ja":"/blog/ja/2020/03/26/reactive-streams-armeria-1"}},"unlisted":false,"prevItem":{"title":"Let\'s Play with Reactive Streams on Armeria - Part 2","permalink":"/blog/2020/07/03/reactive-streams-armeria-2"},"nextItem":{"title":"Monitoring a Spring Boot app in Kubernetes - What I learned from Devoxx Belgium 2019","permalink":"/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019"}},"content":"## What is Reactive Streams?\\n\\nIn this post, I\'d like to introduce the basic concept of Reactive Streams, and how to use Reactive Streams with Armeria, the open-source asynchronous HTTP/2, RPC, REST client/server library.\\nLet\'s begin by examining what Reactive Streams is.\\n\\nThe [official homepage of Reactive Streams](http://reactive-streams.org/) defines it as follows.\\n\\n> Reactive Streams is a standard for asynchronous data processing in a streaming fashion with non-blocking back pressure.\\n\\nLet\'s take a closer look at what they mean by \\"processing in a streaming fashion,\\" \\"asynchronous,\\" \\"back pressure,\\" and \\"standard.\\"\\n\\n{/* truncate */}\\n\\n### Stream processing\\n\\nThe figure below compares traditional data processing against stream processing.\\n\\n![](/img/reactive-streams-armeria-1-1.png)\\n\\nThe traditional method of data processing depicted on the left requires the payload to be stored on an application\'s memory once there is a data processing request.\\nAny additional data that may be required must also be looked up and stored on memory.\\nThe problem with this method is that all data that is received or looked up must all be stored on the application\'s memory in order to generate a response message.\\nIf the size of the required data is larger than the available memory, an \\"out of memory\\" error will occur.\\nEven if a single request doesn\'t cause an \\"out of memory\\" error, there are many instances while operating a service where there will be many requests coming in at once.\\nWhen there are multiple requests occurring simultaneously, it will trigger a large amount of GC (garbage collection) in a short amount of time, leading to the server failing to respond normally.\\n\\nOn the other hand, you can use the stream processing method to process large amounts of data even with a small amount of system memory.\\nWith stream processing, you can create a pipeline that subscribes to any incoming data, processes the data, and then publishes it.\\nServer processing data with this method will be able to process large amounts of data elastically.\\n\\n### Asynchronous method\\n\\nLet\'s compare the asynchronous method with the synchronous method.\\nThe figure below depicts the processes of both methods.\\n\\n![](/img/reactive-streams-armeria-1-2.png)\\n\\nIn the synchronous method, a request sent by the client is blocked until the server sends a response.\\nBeing \\"blocked\\" means that the current thread cannot perform another task and must wait.\\nIf two requests are sent to servers A and B, the request must receive a response from server A before it can move on to server B.\\nHowever, with the asynchronous method, the current thread is not blocked and can perform other tasks while waiting for a response.\\nThe thread can be used for other tasks after sending a request to server A, or send a separate request to server B.\\nThe advantages of the asynchronous method compared to the synchronous method are as follows.\\n\\n- Fast speed - You can get quicker response speeds by sending two requests simultaneously.\\n- Less resources used - You can process more requests with less threads as threads can perform tasks in parallel without being blocked.\\n\\n### Back pressure\\n\\nBefore we go into more detail about \\"back pressure,\\" let\'s take a look into the [observer patten](http://reactivex.io/documentation/observable.html), push method, and pull method made famous by [RxJava](https://github.com/ReactiveX/RxJava).\\n\\n#### Push method\\n\\n![](/img/reactive-streams-armeria-1-3.png)\\n\\nIn an observer pattern, a publisher transfers data by pushing it to a subscriber.\\nA subscriber is not concerned with what state the subscriber is in, and is only concerned with transferring data.\\nIf the publisher sends 100 messages in the span of 1 second, and the subscriber can only process 10 messages in 1 second, what will happen?\\nThe subscriber will have to store the pending events in a queue.\\n\\n![](/img/reactive-streams-armeria-1-4.png)\\n\\nThe amount of memory allotted to the server is limited.\\nIf 100 messages per second is sent to the server, the buffer will fill up instantly.\\nWhat would happen if the buffer runs out and causes an overflow?\\nLet\'s see what would happen to a static buffer and a variable-length buffer.\\n\\n- Static buffer: Newly received messages are rejected. Rejected messages will send requests again, which will cause additional processing load on the network and CPU.\\n\\n![](/img/reactive-streams-armeria-1-5.png)\\n\\n- Variable-length buffer: The server will crash with an \\"out of memory\\" error while trying to store the events. While you might think \\"who would make it like this?\\", the data structure of Java `list`s are variable-length. For example, when querying for a large amount of data with SQL, DBMS is the publisher and your servers become subscribers. When your servers attempt to store all the data in a `list` data structure, it will trigger a large amount of GC, preventing your server from responding normally.\\n\\n![](/img/reactive-streams-armeria-1-6.png)\\n\\nHow can we solve this problem?\\nCould we solve it by having the publisher only send an amount of messages that the subscriber can handle?\\nThis is the fundamental workings behind back pressure.\\n\\n#### Pull method\\n\\nWith the pull method, a subscriber that can process 10 operations at a time will only request 10 operations to the publisher.\\nThe publisher can then send the requested amount, and the subscriber is safe from any \\"out of memory\\" errors.\\n\\n![](/img/reactive-streams-armeria-1-7.png)\\n\\nFurthermore, if the same subscriber is currently processing 8 operations, it can request 2 more operations so that the number of messages do not exceed the limits of what it can process.\\nWith the pull method, subscribers have the freedom to choose the size of the data they receive.\\nThe method that allows subscribers to dynamically pull data requests within their capacity is what back pressure is.\\n\\n### Standardization\\n\\nReactive Streams is a standardized API.\\nHere we\'ll talk about why standardization was necessary and how it became standardized.\\n\\nDevelopment for Reactive Streams first started in 2013 by engineers from Netflix, Pivotal, and Lightbend.\\nNetflix is responsible for the development of RxJava, Pivotal for WebFlux, and Lightbend for Akka, an implemntation of distributed processing actor models.\\nWhat these companies had in common was that they all required streaming APIs.\\nHowever streams are only meaningful if they combine and flow organically.\\nFor data to flow uninterrupted, these different companies needed to use shared specifications, or in other words, they needed standardization.\\n\\nDuring April, 2015, Reactive Streams has released its [1.0.0](https://www.reactive-streams.org/announce-1.0.0) specifications that can be used on JVM.\\nIn September, 2017, Java 9 added [Flow API](https://docs.oracle.com/javase/9/docs/api/java/util/concurrent/Flow.html), which includes the API, specs, and pull method of Reactive Streams and packaged it under `java.util.concurrent`.\\nReactive Streams, which was a shared effort between community members and a few companies, has been officially recognized and added as an official part of Java.\\nThree months later, Reactive Streams released an adapter that is compatible with Flow, allowing existing libraries to be used.\\n\\n![](/img/reactive-streams-armeria-1-8.png)\\n\\n## Reactive Streams API\\n\\nReactive Streams may look complex and daunting on the surface, but its internals are made up of a combination of simple APIs.\\n\\n```\\npublic interface Publisher<T> {\\n   public void subscribe(Subscriber<? super T> s);\\n}\\n\\npublic interface Subscriber<T> {\\n   public void onSubscribe(Subscription s);\\n   public void onNext(T t);\\n   public void onError(Throwable t);\\n   public void onComplete();\\n}\\n\\npublic interface Subscription {\\n   public void request(long n);\\n   public void cancel();\\n}\\n```\\n\\n- `Publishers` only have a `subscribe` API that allows `subscribers` to subscribe.\\n- `Subscribers` have `onNext` for processing received data, `onError` for processing errors, `onComplete` for completing tasks, and `onSubscribe` API for subscribing with parameters.\\n- For `subscription`, there is a `request` API for requesting data and a `cancel` API for cancelling subscriptions.\\n\\nNow let\'s take a look at how the API above is used in Reactive Streams.\\n\\n1. A `subscriber` uses the `subscribe` function to request a subscription to the `publisher`.\\n2. The `publisher` uses the `onSubscribe` function to send the `subscription` to the `subscriber`.\\n\\n![](/img/reactive-streams-armeria-1-9.png)\\n\\n3. The `subscription` now acts as a medium between a `subscriber` and `publisher`. `Subscribers` do not directly request data from `publishers`. Requests are sent to `publishers` using the `request` function of the `subscription`.\\n4. The `publisher`, using `subscription`, sends data with `onNext`, `onComplete` for completed tasks, and `onError` for errors.\\n5. The `subscriber`, `publisher`, and `subscription` all form an organic connection, communicating with each other; starting from `subscribe` all the way to `onComplete`. This completes the back pressure structure.\\n\\n![](/img/reactive-streams-armeria-1-10.png)\\n\\nSo back pressure seems useful, but how do you actually use it?\\nThe interface you see above is all of Reactive Streams API available on its official [GitHub repo](https://github.com/reactive-streams/reactive-streams-jvm/tree/master/api/src/main/java/org/reactivestreams).\\nThere isn\'t a separate implementation that you can use.\\n\\nThen can you implement it by yourself?\\nYou can in fact implement a `publisher` interface and generate a `subscription` using the rules above.\\nHowever, this is not all.\\nReactive Streams comes with its own [specifications](https://github.com/reactive-streams/reactive-streams-jvm#specification), and unlike a simple interface, these specifications present rules that must be followed during implementation.\\n\\n![](/img/reactive-streams-armeria-1-11.png)\\n\\nOnce you follow the specifications and have an implementation, you can validate it using a tool called [Reactive Streams TCK](https://github.com/reactive-streams/reactive-streams-jvm/tree/master/tck).\\nUnless you\'re a skilled expert in the field, it\'s difficult to have an implementation that satisfies all of the given rules.\\nThe `publisher` in particular is especially difficult to implement.\\nFor example, here\'s an [issue](https://github.com/reactor/reactor-core/issues/482) posted on the GitHub repo of [Project Reactor](https://projectreactor.io/), one of the more well known Reactive Streams implementations.\\nThe user in question is having difficulty in connecting their `publisher` to Flux.\\nThe reply from Project Reactor was basically \\"don\'t.\\" In my opinion, it\'s okay to do something like this in a pet project for study purposes.\\nYou should not, however, use unverified code in an actual service.\\nInstead, you should create a `publisher` using a constructor function such as `Flux.create()`.\\nIt\'s better off to use an existing, validated implementation when using Reactive Streams, rather than creating one yourself.\\nSo what are some implementations that you could use?\\n\\n## Reactive Streams implementations and interoperability\\n\\nThere are [various Reactive Streams implementations](https://en.wikipedia.org/wiki/Reactive_Streams#Adoption) that you can use.\\nEach implementation has its own quirks and characteristics, so you should find one that fits your needs.\\n\\n- If you only need stream computing processing you could use [RxJava](https://github.com/ReactiveX/RxJava), [Reactor Core](https://github.com/reactor/reactor-core), or [Akka Streams](https://doc.akka.io/docs/akka/current/stream/index.html).\\n- If you want to look up data in repositories using Reactive Streams, you could use [ReactiveMongo](http://reactivemongo.org/) or [Slick](http://scala-slick.org/).\\n- If you need something connected to web programming you could use [Armeria](https://line.github.io/armeria/), [Vert.x](https://vertx.io/), [Play Framework](https://www.playframework.com/), or [Spring WebFlux](https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux).\\n\\nAll these different implementations can communicate each other through Reactive Streams.\\n\\n### Interoperating Reactive Streams\\n\\n![](/img/reactive-streams-armeria-1-12.png)\\n\\n`Observable` in RxJava can be converted to Aremeria\'s `HttpResponse` or Project Reactor\'s `Flux` through Reactive Streams.\\nMongoDB\'s `DataPublisher` can stream compute through Akka Streams\' `Source`.\\n\\nFor example, let\'s say you\'re looking up data and computing on MongoDB and then sending it as an HTTP response.\\nUsing Reactive Streams to look up data on MongoDB will return publishers that can be subscribed to.\\nUnless a subscriber sends a request through a subscription, any actual data is not transferred.\\n\\n```\\n// Initiate MongoDB FindPublisher\\nFindPublisher<Document> mongoDBUsers = mongodbCollection.find();\\n```\\n\\nAs you can see in the code below, using `Observable\'s fromPublisher`, you can connect to `MongoDB\'s FindPublisher`.\\nUsing the `map` operator allows you to extract the `age` field from the results.\\n\\n```\\n// MongoDB FindPublisher -> RxJava Observable\\nObservable<Integer> rxJavaAllAges =\\n    Observable.fromPublisher(mongoDBUsers)\\n              .map(document -> document.getInteger(\u201cage\u201d));\\n```\\n\\nSince `RxJava\'s Observable` is implemented in an observer pattern, converting it for Reactive Streams requires the use of the `toFlowable` function as you can see in the code below.\\nAfter the conversion, you can connect `RxJava\'s Flowable` and `Flux` using the `from` function.\\n\\n```\\n// RxJava Observable -> Reactor Flux\\nFlux<HttpData> fluxHttpData =\\n    Flux.from(rxJavaAllAges.toFlowable(BackpressureStrategy.DROP))\\n        .map(age -> HttpData.ofAscii(age.toString()));\\n```\\n\\nTo use Flux data structure in HTTP responses, you must append an HTTP header to the front of the data.\\nYou can then call `HttpResponse.of` to connect it with Flux and then use it as an HTTP response for Armeria.\\n\\n```\\n// Reactor Flux -> Armeria HttpResponse\\nHttpResponse.of(Flux.concat(httpHeaders, fluxHttpData));\\n```\\n\\nAs previously mentioned, it\'s important to note that unlike typical `iterators`, any computing has not occurred yet in this process.\\nWe have only illustrated how the data will be sent to the `subscriber`.\\nWith Reactive Streams, data transfer must not begin until a `subscriber` specifically requests it.\\n\\n## Conclusion\\n\\nIn this post, we took a look at Reactive Streams and its implementations, and how they interoperate.\\nYou must use back pressure on HTTP requests on responses if you want to use Reactive Streams in web programming.\\nTo achieve this you must be able to appropriately adapt to the traffic that flows in.\\nIn the next post we will be looking at how we use Reactive Streams with Armeria to do this!\\n\\n[Let\u2019s Play with Reactive Streams on Armeria \u2013 Part 2](/blog/2020/07/03/reactive-streams-armeria-2)\\n\\nThe features mentioned in this blog post aren\'t everything there is to Armeria.\\nFor more information on what Armeria can do for you, refer to the [official website](https://armeria.dev/) and the following sources.\\n\\n- GitHub: [line/armeria](https://github.com/line/armeria)\\n- Twitter: [@armeria_project](https://twitter.com/armeria_project)\\n- Slack: [Armeria](https://armeria.dev/s/slack)\\n- [API documentation](https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/index.html)\\n- Armeria examples: [line/armeria-examples](https://github.com/line/armeria-examples)"},{"id":"/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019","metadata":{"permalink":"/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2019-12-23-monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019.mdx","source":"@site/src/content/blog/en/2019-12-23-monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019.mdx","title":"Monitoring a Spring Boot app in Kubernetes - What I learned from Devoxx Belgium 2019","description":"This November, accompanied by 3 other members of the Shop team, I attended Devoxx Belgium 2019, held in Antwerp, Belgium - the birthplace of Devoxx and most populous city of Belgium.","date":"2019-12-23T00:00:00.000Z","tags":[],"readingTime":13.04,"hasTruncateMarker":true,"authors":[{"name":"Teo","title":"Teodor is a server-side engineer at LINE.","imageURL":"/img/author-teo.png","key":"teo","page":null}],"frontMatter":{"authors":["teo"],"other_languages":{"ja":"/blog/ja/2020/01/14/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019"}},"unlisted":false,"prevItem":{"title":"Let\'s Play with Reactive Streams on Armeria - Part 1","permalink":"/blog/2020/05/06/reactive-streams-armeria-1"},"nextItem":{"title":"Make your GitHub contributions calendar greener (featuring Armeria Sprint)!","permalink":"/blog/2019/05/14/armeria-sprint-1"}},"content":"This November, accompanied by 3 other members of the Shop team, I attended Devoxx Belgium 2019, held in Antwerp, Belgium - the birthplace of Devoxx and most populous city of Belgium.\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-1.jpg)\\n\\n{/* truncate */}\\n\\n[Devoxx](https://en.wikipedia.org/wiki/Devoxx) is a developer community conference series started in 2001 which quickly grew to become one of the largest vendor-independent Java conferences in the world.\\nToday, Devoxx conferences are also held in France, Poland, Ukraine, Morocco, and the UK.\\n\\nDevoxx Belgium took place in \\"Kinepolis,\\" one of the largest cinemas in Europe.\\nThe speakers\' video and slides were projected on the huge cinema screens in 4K using the available THX audio setup.\\nThe view was great!\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-2.jpg) ![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-3.jpg) ![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-4.jpg)\\n\\nIn this blog post, I\'d like to present a small hands-on example on monitoring a Spring Boot application in Kubernetes using what I learned at Devoxx.\\nIn particular, I\'d like to talk about:\\n\\n- Preparing a Spring Boot application\\n- Installing Docker and Kubernetes\\n- Building a Docker image\\n- Deploying to Kubernetes\\n- Monitoring our application inside Kubernetes\\n\\n## Monitoring Example - Spring Boot application in Kubernetes\\n\\n### 1. Preparing a Spring Boot application\\n\\nFor this example, I\'m going to use a sample \\"Hello World\\" Spring Boot application that uses [Armeria](https://line.github.io/armeria/).\\nOn the Shop team we use Armeria to develop high-performance asynchronous microservices that use HTTP/2 as a session layer protocol.\\nI want to use Armeria in this example to show how you can expose a custom metrics endpoint and have Prometheus pull metrics from it.\\nExamples on how to get started with Armeria are available on [Armeria\'s GitHub repo](https://github.com/line/armeria-examples).\\nThe source code for this example is on [GitHub](https://github.com/nirvanarsc/k8s-monitoring-sample).\\nI\'ve only tested the code on macOS.\\n\\nI have set up a [gRPC Service](https://github.com/nirvanarsc/k8s-monitoring-sample/blob/master/src/main/java/com/github/nirvanarsc/k8s/monitoring/sample/service/GreetingService.java#L17) and an [HTTP Service](https://github.com/nirvanarsc/k8s-monitoring-sample/blob/master/src/main/java/com/github/nirvanarsc/k8s/monitoring/sample/service/SampleService.java#L11) which we can call by navigating to `/internal/docs`.\\nDocService is a single-page web application that comes out of the box with Armeria listing all of our services and allowing us to call test them.\\nMore about it can be found on [Armeria\'s official documentation](https://line.github.io/armeria/server-docservice.html).\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-5.png)\\n\\n### 2. Installing Docker & Kubernetes\\n\\n#### Docker\\n\\nBefore we get started with Kubernetes, we need to install [Docker](https://docs.docker.com/install/).\\nIf you are just getting started with Docker, I found the official [quickstart guide](https://docs.docker.com/get-started/) useful.\\nWe\'re going to use a public registry to push our application image to, so please [register](https://hub.docker.com/signup) and login to Docker through the GUI or by running:\\n\\n```\\n$ docker login\\n```\\n\\nThere seems to be some confusion online regarding the user name you should use when prompted to login.\\nDo not use your email!\\nUse the Docker ID you chose when signing up.\\nYou can find your Docker ID in the upper right corner after logging in to [Docker Hub](https://hub.docker.com/).\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-6.png)\\n\\n#### Kubernetes\\n\\nOkay now let\'s install Kubernetes.\\nFor this example, we\'re just going to enable Kubernetes inside Docker.\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-7.png)\\n\\nAlternatives to docker-desktop for running a local Kubernetes cluster include:\\n\\n- [minikube](https://github.com/kubernetes/minikube)\\n- [kind](https://github.com/kubernetes-sigs/kind)\\n\\n### 3. Building an Image\\n\\nIf you\'ve got this far you should be able to run:\\n\\n```\\n$ kubectl cluster-info\\n```\\n\\nand see something similar to the following:\\n\\n```\\nKubernetes master is running at https://kubernetes.docker.internal:6443\\nKubeDNS is running at https://kubernetes.docker.internal:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\\n\\nTo further debug and diagnose cluster problems, use \'kubectl cluster-info dump\'.\\n```\\n\\nSo far so good.\\nNow let\'s build a docker image for our Spring Boot app.\\nAll we need to do is write a Docker file and run a Docker daemon, while watching out for the best-practices for Docker.\\nPerhaps following the first part of this [guide](https://spring.io/guides/topicals/spring-boot-docker/).\\n\\n#### Jib\\n\\nOr we can just jib it. [Jib](https://github.com/GoogleContainerTools/jib) is a tool developed by Google that helps you build Docker images for your Java applications without a Docker daemon - and without deep mastery of Docker best-practices.\\nAll we need to do is to add the following to our build.gradle file.\\n\\n```\\nplugins {\\n    ..\\n    id \'com.google.cloud.tools.jib\' version \'1.8.0\'\\n}\\n\\njib.to.image = \'docker_id/image_name\'\\n```\\n\\nIn this example we\'re using a public docker registry but jib can be configured to upload images to a private registry.\\nMore on that in [Jib\'s official documentation](https://github.com/GoogleContainerTools/jib/tree/master/jib-gradle-plugin#authentication-methods).\\n\\nAfter we have configured the jib plugin, building our Docker image is as simple as running:\\n\\n```\\n$ ./gradlew jib\\n```\\n\\nIf all is well after logging in to [Docker Hub](https://hub.docker.com/) you should see your image on top.\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-8.png)\\n\\nThe url for your image should be of the form `docker.io/docker_id/image_name`\\n\\n### 4. Deploying to Kubernetes\\n\\nNext, let\'s deploy our image to Kubernetes.\\nTo do this, we need to write YAML configuration files, and as you can see in these tutorials from [IBM](https://developer.ibm.com/tutorials/yaml-basics-and-usage-in-kubernetes/) and [Mirantis](https://www.mirantis.com/blog/introduction-to-yaml-creating-a-kubernetes-deployment/), writing even a basic .yaml file correctly can be a daunting task.\\nHowever, there is a very easy way to get started, which I found out at Ray Tsang\'s session [\\"Best Practices to Spring to Kubernetes Easier and Faster\\"](https://www.youtube.com/watch?v=c16oOeTfFXM) at Devoxx.\\nInstead of doing something like this:\\n\\n```\\n$ kubectl create deployment my-app --image docker.io/nirvanarsc/my-app\\n```\\n\\nWe should add the `--dry-run` option like this:\\n\\n```\\n$ kubectl create deployment my-app --image docker.io/nirvanarsc/my-app --dry-run -oyaml\\n```\\n\\nWhich will print the YAML configuration necessary for a Deployment with the specified image as follows.\\n\\n```\\napiVersion: apps/v1\\nkind: Deployment\\nmetadata:\\n  creationTimestamp: null\\n  labels:\\n    app: my-app\\n  name: my-app\\nspec:\\n  replicas: 1\\n  selector:\\n    matchLabels:\\n      app: my-app\\n  strategy: {}\\n  template:\\n    metadata:\\n      creationTimestamp: null\\n      labels:\\n        app: my-app\\n    spec:\\n      containers:\\n      - image: docker.io/nirvanarsc/my-app\\n        name: my-app\\n        resources: {}\\nstatus: {}\\n```\\n\\nThe only thing I will modify here is to increase the replicas from 1 to 3. (Set the number of instances of our app to 3)  \\nIn the exact same way, we can get an initial configuration for our service.\\nRunning the following for example,\\n\\n```\\n$ kubectl create service clusterip my-app --tcp=8080:8080 --dry-run -oyaml\\n```\\n\\nprints this:\\n\\n```\\napiVersion: v1\\nkind: Service\\nmetadata:\\n  creationTimestamp: null\\n  labels:\\n    app: my-app\\n  name: my-app\\nspec:\\n  ports:\\n  - name: 8080-8080\\n    port: 8080\\n    protocol: TCP\\n    targetPort: 8080\\n  selector:\\n    app: my-app\\n  type: ClusterIP\\nstatus:\\n  loadBalancer: {}\\n```\\n\\nLet\'s save both of these configuration to their own files.\\nCreate a folder named \\"k8s\\" and execute:\\n\\n```\\n$ kubectl create deployment my-app --image docker.io/nirvanarsc/my-app --dry-run -oyaml > k8s/deployment.yaml\\n$ kubectl create service clusterip my-app --tcp=8080:8080 --dry-run -oyaml > k8s/service.yaml\\n```\\n\\nNow deploying our app is as simple as running:\\n\\n```\\n$ kubectl apply -f k8s\\n```\\n\\nTo access our application we will need to allow external traffic into our Kubernetes cluster.\\n\\nThis article will not be addressing Ingress/LoadBalancer/NodePort.\\nPerhaps [this article on Medium](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0) is a good overview on that subject.\\n\\nInstead, we will just forward a local port to a port on the cluster like this:\\n\\n```\\n$ kubectl port-forward svc/my-app 8080:8080\\n```\\n\\nNow we can access our `internal/docs` endpoint and our `internal/metrics` endpoint at `http://localhost:8080`.\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-9.png)\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-10.png)\\n\\n### 5. Monitoring our application inside Kubernetes\\n\\nFinally, we can talk about monitoring.\\nFirst a few words about Prometheus and Grafana.\\n\\nPrometheus is a monitoring and alerting system.\\nIt was originally built by SoundCloud in 2012, but has since been open sourced and now is part of the CNCF.\\nIt is inspired by Google\'s BorgMon - one of Google\'s internal monitoring technologies used to monitor services running on Borg.\\nBorg is Google\'s internal cluster scheduler, which in turn inspired Kubernetes.\\nSo Prometheus and Kubernetes have both been inspired by complementary technologies inside Google.\\n\\nGrafana is an open source analytics and monitoring system.\\nPrometheus and Grafana have become basically the de facto monitoring solution.\\nGrafana should not be confused with Kibana, which runs on top of Elasticsearch and is used to analyze log messages.\\nOn the Shop team we also use Prometheus with Grafana as our monitoring solution.\\n\\nIt is possible to have an external instance of Prometheus discover and pull metrics from our Application inside Kubernetes, but for this example I\'m going to install an instance of Prometheus and Grafana inside the cluster and have Prometheus discover our Application and scrape metrics from it.\\n\\nTo install Prometheus and Grafana in our cluster we\'re going to use [Helm](https://helm.sh/).\\nHelm is a package manager for Kubernetes.\\nThink of it like npm/apt for Kubernetes.\\nCheck out the [official documentation on getting started](https://helm.sh/docs/intro/quickstart/) if you have the time, but for this example, all the configuration we\'re going to need is:\\n\\n```\\n$ brew install helm\\n```\\n\\n```\\n$ helm repo add stable https://kubernetes-charts.storage.googleapis.com/\\n```\\n\\n#### Installing Prometheus\\n\\nWe can install Prometheus in our cluster by running:\\n\\n```\\n$ helm install my-prometheus stable/prometheus\\n```\\n\\nWhich should output something like:\\n\\n```\\nNAME: my-prometheus\\nLAST DEPLOYED: Thu Dec  5 15:29:58 2019\\nNAMESPACE: default\\nSTATUS: deployed\\nREVISION: 1\\nTEST SUITE: None\\nNOTES:\\nThe Prometheus server can be accessed via port 80 on the following DNS name from within your cluster:\\nmy-prometheus-server.default.svc.cluster.local\\n\\nGet the Prometheus server URL by running these commands in the same shell:\\n  export POD_NAME=$(kubectl get pods --namespace default -l \\"app=prometheus,component=server\\" -o jsonpath=\\"{.items[0].metadata.name}\\")\\n  kubectl --namespace default port-forward $POD_NAME 9090\\n\\nThe Prometheus alertmanager can be accessed via port 80 on the following DNS name from within your cluster:\\nmy-prometheus-alertmanager.default.svc.cluster.local\\n\\nGet the Alertmanager URL by running these commands in the same shell:\\n  export POD_NAME=$(kubectl get pods --namespace default -l \\"app=prometheus,component=alertmanager\\" -o jsonpath=\\"{.items[0].metadata.name}\\")\\n  kubectl --namespace default port-forward $POD_NAME 9093\\n\\nThe Prometheus PushGateway can be accessed via port 9091 on the following DNS name from within your cluster:\\nmy-prometheus-pushgateway.default.svc.cluster.local\\n\\nGet the PushGateway URL by running these commands in the same shell:\\n  export POD_NAME=$(kubectl get pods --namespace default -l \\"app=prometheus,component=pushgateway\\" -o jsonpath=\\"{.items[0].metadata.name}\\")\\n  kubectl --namespace default port-forward $POD_NAME 9091\\n\\nFor more information on running Prometheus, visit:\\nhttps://prometheus.io/\\n```\\n\\nNow if we also run:\\n\\n```\\n$ export POD_NAME=$(kubectl get pods --namespace default -l \\"app=prometheus,component=server\\" -o jsonpath=\\"{.items[0].metadata.name}\\")\\n  kubectl --namespace default port-forward $POD_NAME 9090\\n```\\n\\nWe should be able to access the Prometheus server at `localhost:9090`\\n\\nBut if we navigate to status/targets, we will see that Prometheus fails to discover our application.\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-11.png)\\n\\nThere\'s two ways to fix this.\\nFirst we can use an [additional argument](https://github.com/helm/charts/blob/master/stable/prometheus/values.yaml#L1316) when installing the Prometheus chart through Helm -  \\nWe can create a file `extraScrapeConfigs.yaml` with the following settings\\n\\n```\\nextraScrapeConfigs: |\\n  - job_name: \'armeria-metrics\'\\n    scrape_interval: 1s\\n    metrics_path: /internal/metrics\\n    kubernetes_sd_configs:\\n      - role: endpoints\\n```\\n\\nAnd then we need to update our Prometheus chart config by running:\\n\\n```\\n$ helm upgrade --install my-prometheus --set-file extraScrapeConfigs=prometheus/extraScrapeConfigs.yaml stable/prometheus\\n```\\n\\nHowever I suggest we modify our `deployment.yaml` file by adding the following config allowing Prometheus to pull metrics from our app:\\n\\n```\\nspec.template.metadata.annotations:\\n  prometheus.io/scrape: \\"true\\"\\n  prometheus.io/port: \\"8080\\"\\n  prometheus.io/path: /internal/metrics\\n```\\n\\nSo our `deployment.yaml` file should look like this:\\n\\n```\\napiVersion: apps/v1\\nkind: Deployment\\nmetadata:\\n  creationTimestamp: null\\n  labels:\\n    app: my-app\\n  name: my-app\\nspec:\\n  replicas: 3\\n  selector:\\n    matchLabels:\\n      app: my-app\\n  strategy: {}\\n  template:\\n    metadata:\\n      creationTimestamp: null\\n      labels:\\n        app: my-app\\n      annotations:                               ### here\\n        prometheus.io/scrape: \\"true\\"\\n        prometheus.io/port: \\"8080\\"\\n        prometheus.io/path: /internal/metrics\\n    spec:\\n      containers:\\n      - image: docker.io/nirvanarsc/my-app\\n        name: my-app\\n        resources: {}\\nstatus: {}\\n```\\n\\nAnd we need to re-deploy our app with the updated configuration:\\n\\n```\\n$ kubectl delete deploy/my-app svc/my-app\\n$ kubectl apply -f k8s\\n$ kubectl port-forward svc/my-app 8080:8080\\n```\\n\\nIf we navigate to status/targets now, we should see the 3 pods of our application.\\nWe should also be able to query our metrics.\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-12.png)\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-13.png)\\n\\n#### Installing Grafana\\n\\nLastly, we can install Grafana and visualize our metrics.\\n\\n```\\n$ helm install my-grafana stable/grafana\\n```\\n\\n```\\nNAME: my-grafana\\nLAST DEPLOYED: Thu Dec  5 16:03:33 2019\\nNAMESPACE: default\\nSTATUS: deployed\\nREVISION: 1\\nNOTES:\\n1. Get your \'admin\' user password by running:\\n\\n   kubectl get secret --namespace default my-grafana -o jsonpath=\\"{.data.admin-password}\\" | base64 --decode ; echo\\n\\n2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster:\\n\\n   my-grafana.default.svc.cluster.local\\n\\n   Get the Grafana URL to visit by running these commands in the same shell:\\n\\n     export POD_NAME=$(kubectl get pods --namespace default -l \\"app=grafana,release=my-grafana\\" -o jsonpath=\\"{.items[0].metadata.name}\\")\\n     kubectl --namespace default port-forward $POD_NAME 3000\\n\\n3. Login with the password from step 1 and the username: admin\\n```\\n\\nFollowing the instructions above we should be able to log in to Grafana at `localhost:3000`.\\nThen we can add Prometheus as a data source and create a dashboard with our applications metrics.\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-14.png)\\n\\n![](/img/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-15.png)\\n\\nAnd that\'s it!\\nWe have successfully used Prometheus and Grafana to build a dashboard visualizing our app\'s metrics.\\n\\n## Conclusion\\n\\nGetting started with Kubernetes can be quite challenging.\\nI think there are 3 main reasons for that:\\n\\n- Writing a good YAML file is difficult\\n- Knowledge of networking is required\\n- There are a lot of small interconnected components such as Docker, Pods, Services, and ReplicaSets\\n\\nI hope this blog post will make it a little easier for you to begin development on Kubernetes.\\n\\nHappy coding!\\n\\n---\\n\\nA list of the Devoxx sessions about Kubernetes I found most useful:\\n\\n- [Best Practices to Spring to Kubernetes Easier and Faster by Ray Tsang - YouTube](https://www.youtube.com/watch?v=c16oOeTfFXM)\\n- [Develop and Deploy to Kubernetes like a Googler by David Gageot - YouTube](https://www.youtube.com/watch?v=YYJ4RZFw4j8)\\n- [Helm your way with Kubernetes by Ana Maria Mihalceanu - YouTube](https://www.youtube.com/watch?v=YiXf4Pqyl0A)\\n- [Crash course in Kubernetes monitoring by Robert Munteanu - YouTube](https://www.youtube.com/watch?v=dId543PzSsU)"},{"id":"/2019/05/14/armeria-sprint-1","metadata":{"permalink":"/blog/2019/05/14/armeria-sprint-1","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2019-05-14-armeria-sprint-1.mdx","source":"@site/src/content/blog/en/2019-05-14-armeria-sprint-1.mdx","title":"Make your GitHub contributions calendar greener (featuring Armeria Sprint)!","description":"Hi, there!","date":"2019-05-14T00:00:00.000Z","tags":[],"readingTime":8.24,"hasTruncateMarker":true,"authors":[{"name":"SeoYeon Lee","title":"I\'m responsible for open source projects at LINE","imageURL":"https://github.com/syleeeee.png","key":"seoyeonlee","page":null}],"frontMatter":{"authors":["seoyeonlee"],"other_languages":{"ja":"/blog/ja/2019/06/21/armeria-sprint-1","ko":"/blog/ko/2019/05/09/armeria-sprint-1"}},"unlisted":false,"prevItem":{"title":"Monitoring a Spring Boot app in Kubernetes - What I learned from Devoxx Belgium 2019","permalink":"/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019"},"nextItem":{"title":"Thank you for contributing to Armeria!","permalink":"/blog/2019/04/16/thank-you-for-contributing-to-armeria"}},"content":"Hi, there!\\nDo any of you need to make lots and lots of commits to turn your [GitHub contribution calendar](https://help.github.com/en/articles/viewing-contributions-on-your-profile#contributions-calendar) into a pastureland?\\nIf that\'s the case, I proudly present Armeria Sprint!\\nLet me give you some ideas on what Armeria Sprint is and share reviews from our enthusiastic participants.\\n\\nYou\'ve probably come across a sprint at technical conferences such as [PyCON Development Sprints](https://us.pycon.org/2019/community/sprints/) before.\\nOr, you might just find the term, sprint, familiar because it appears in Agile software development.\\nYou might still wonder, \\"What is an open source sprint anyway?\\nWhat\'s up with Armeria Sprint?\\"\\n\\n![](/img/armeria-sprint-1-1.png)\\n\\n{/* truncate */}\\n\\n## What is an open source sprint?\\n\\nAn open source sprint is a time dedicated for those who want to contribute to open source projects to come together and concentrate on coding. (Please refer to the [previous posting](/blog/2019/04/16/thank-you-for-contributing-to-armeria) to find more about open source contributions.) It could vary but sprints are usually scheduled as a one-day event where all participants meet up in the morning to decide who is doing what (among open issues) and spend the rest of the day \\"coding away\\".\\n\\nThere are usually two types of participants, mentors and mentees.\\nThose who have contributed to the selected open source project before take up a mentor role while new comers with a lot of passion for the project are mentees.\\nFor the Armeria Sprint, we were honored to have our three Armeria maintainers as mentors.\\n\\n### What is a sprint for?\\n\\nEven if you have passion for open source projects, the reality is that it is not always easy to find time for it.\\nOr, sometimes you have so many questions about an open source project but you simply don\'t know where to find answers.\\nMoreover, it is conventional wisdom that two are better than one.\\nOpen source sprints are an opportunity for those of you who have a heart for open source projects but could not find time in the past or for those of you who just want to give it a try for the first time.\\n\\nNew contributors and their contributions fuel the growth of the open source community, making it more vibrant.\\nEven for mentors, when they interact and communicate with different participants, they will be able to understand what has been an entry barrier for new contributors.\\n\\n## Overview of Armeria Sprint\\n\\nThis year\'s Armeria Sprint was open to LINE developers only.\\nWe opened up only a few seats to achieve the optimum ratio of mentors to mentees.\\nQuite surprisingly, these seats were filled up in a flash with more applicants on the waiting list!\\nThis alone testified to fully charged passion of all applicants.\\nWhat an enthusiasm!\\nThe Armeria Sprint was scheduled for two days: two hours of welcome session on the first day and four hours of development sprint on the second day.\\n\\n### Welcome session\\n\\nThe welcome session was kicked off with a brief introduction of all participants.\\nAfter breaking the ice, the participants touched upon the following topics.\\n\\n#### Must-reads before open source contribution\\n\\n#### Contributing\\n\\n[This document](https://github.com/line/armeria/blob/master/CONTRIBUTING.md) explains how you can contribute to the Armeria project together with a set of rules to comply with when doing so.\\nThe summary of key points is provided under [Checklist for your pull request](https://github.com/line/armeria/blob/master/CONTRIBUTING.md#checklist-for-your-pull-request).\\nIt can help you save time for code review.\\n\\n#### Contributor License Agreement (CLA)\\n\\nYou might have seen this type of [agreement](https://cla-assistant.io/line/armeria) before but considered it did not concern you.\\nOpen source projects usually ask you to sign the CLA before you start your contribution.\\nThe following bullet points summarize the content of the CLA (Note that it can vary by project.):\\n\\n- The purpose of the CLA is to protect the project and its contributors and users.\\n\\n- Signing the CLA will constitute an agreement to go open source on your contributions in the same terms as the Armeria project.\\n- Your contributions will be accepted as they are, and you will not be held accountable for any bug or flaw in your contributions.\\n\\n#### Code of Conduct\\n\\nContributors are expected to follow the [Code of Conduct](https://github.com/line/armeria/blob/master/CODE_OF_CONDUCT.md), which provides a guideline to foster an open and welcoming environment.\\n\\n#### Task allocation\\n\\nThe main purpose of the welcome session was to decide on who is going to do what.\\nFirst, the participants went through the [good-first-issues](https://github.com/line/armeria/issues?q=is%3Aopen+is%3Aissue+label%3Agood-first-issue) with more detailed elaboration on each issue by the mentors.\\nThey explained about the background and history of each issue and relevant technical requirements and background knowledge to resolve the issue.\\n\\nWhen you find an issue you want to work on, don\'t hesitate to leave a comment such as \\"I am working on this\\" or \\"I\'ll handle this issue\\" so that you don\'t redundantly work on the same issue with others.\\n\\n#### Configuring development environment\\n\\nAfter everyone picked an issue, they went step by step to set up the development environment (Check out [Setting up your IDE](https://github.com/line/armeria/blob/master/CONTRIBUTING.md#setting-up-your-ide)).\\n\\n![](/img/armeria-sprint-1-2.jpg)\\n\\nThe participants did a little activity while configuring development environment like \\"lay down your water bottle when you\'re done with fork & clone\\".\\n\\n### Sprint results\\n\\nHere are the pull requests opened during the Armeria Sprint:\\n\\n- [#1742](https://github.com/line/armeria/pull/1742) Allow using wildcards with RequestContextExportingAppender\\n- [#1743](https://github.com/line/armeria/pull/1743) Provide a way to create a client with an Endpoint rather than with a URI\\n- [#1744](https://github.com/line/armeria/pull/1744) Show armeria version in doc service\\n- [#1745](https://github.com/line/armeria/pull/1745) Enable to convert JSON format request to String\\n- [#1747](https://github.com/line/armeria/pull/1747) Introduce \'export-as-curl\' button to a debug request window\\n\\n![](/img/armeria-sprint-1-3.jpeg)\\n\\nDon\'t worry!\\nYour \\"secret identity\\" is protected, Armeria Sprinters!\\n\\n![](/img/armeria-sprint-1-4.jpeg)\\n\\nKeep those sticky fingers away from the precious laptops!\\n\\n### Reviews\\n\\n#### Feedback from Armeria Sprint participants\\n\\n- I especially liked that there was someone I could easily reach out for questions. Moreover, everyone respected each other. I hope there will more opportunities like this so that I can overcome my hesitation toward open source projects.\\n- Well, I think I was kind of \\"tricked by my mentor\\" because the issue I picked sounded much easier when he explained it. (LOL) Still, it was quite a positive experience for me to make contributions to an open source project.\\n- If you are developer, you would have dreamt of open source contributions, at least once. It was a good start for me.\\n- When I actually got to it, it was only a few lines of code. But, I had a lot to think about before making it happen.\\n- Mentors made open issues quite easy to understand, but it took some time for me to understand the existing code. If we were given an overall view on the code or structure of Armeria in advance, it could have been easier to approach the issue.\\n- I\'ve given it a few tries to contribute to open source projects in the past, but to no avail. This time, I could make it happen because there were mentors around for guidance.\\n- My team is using Armeria. Even if I sometimes felt a need for new things, I was reluctant to make changes on my own. After this Sprint, I think I\'ll be able to take the initiative in making contributions. I\'ll study the code more to prepare myself.\\n- I found it a little bit difficult to handle the issue. But, it was a good opportunity for me to learn the basics.\\n- I was almost done, but we ran out of time before I could open a pull request. I\'ll finish it up and open a pull request soon.\\n\\n#### Feedback from Armeria Sprint mentors\\n\\n- To those who find it difficult to approach open source development, it all begins with leaving your problem solving ideas as a comment on the issue. Don\'t sweat it and ask questions! Your questions are a big help for us, too.\\n- It was a great opportunity for me to realize that there were so many developers out there who were interested in open source development. I was very proud to serve as a mentor for this event. (Don\'t forget to star the repository!)\\n- I was a little nervous because this was the first Sprint ever. But, all my worries were groundless. I\'d like to thank all the participants for taking it so seriously. Even though the first Armeria Sprint is over for now, you can always leave a comment or a question on the GitHub and Slack.\\n- We made a big progress by opening pull requests today. But, I dare say it\'s only a start. Your coding skills will evolve further through code reviews. Don\'t give up until your code is merged.\\n- It was a very meaningful experience to meet up with contributors face to face. I wish there will be more events like this one.\\n\\n## Wrapping up\\n\\nThank you all for your hard work during the Armeria Sprint!\\nWe hope this was a time of mutual growth and everyone enjoyed the Sprint.\\nWe\'ll come back with a more rewarding event next time.\\n\\nBefore I go away, this was the first Sprint I\'ve organized, and I\'d like to express my gratitude to the authors of the following guides as they helped me to make my first-time Sprint a success:\\n\\n- [Open Source Contribution Sprint Guide by DRUD](https://github.com/drud/sprint_guide)\\n- [Th](https://opensourceevents.github.io/)[e In-Person Event Handbook by opensource-events](https://opensourceevents.github.io/)"},{"id":"/2019/04/16/thank-you-for-contributing-to-armeria","metadata":{"permalink":"/blog/2019/04/16/thank-you-for-contributing-to-armeria","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2019-04-16-thank-you-for-contributing-to-armeria.mdx","source":"@site/src/content/blog/en/2019-04-16-thank-you-for-contributing-to-armeria.mdx","title":"Thank you for contributing to Armeria!","description":"Hello to the readers!","date":"2019-04-16T00:00:00.000Z","tags":[],"readingTime":11.29,"hasTruncateMarker":true,"authors":[{"name":"SeoYeon Lee","title":"I\'m responsible for open source projects at LINE","imageURL":"https://github.com/syleeeee.png","key":"seoyeonlee","page":null}],"frontMatter":{"authors":["seoyeonlee"],"other_languages":{"ja":"/blog/ja/2019/05/23/thank-you-for-contributing-to-armeria","ko":"/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria"}},"unlisted":false,"prevItem":{"title":"Make your GitHub contributions calendar greener (featuring Armeria Sprint)!","permalink":"/blog/2019/05/14/armeria-sprint-1"},"nextItem":{"title":"Making a basic server with Java & Armeria","permalink":"/blog/2018/09/13/making-a-basic-server-with-java-armeria"}},"content":"Hello to the readers!\\nI\'d like to share with you the first ever Armeria Contributor Reward Event and how it went.\\nFor this posting, I\'m not going to elaborate on the technical aspects of Armeria.\\nTo learn more about its technology and features, please visit the [official website for Armeria](https://line.github.io/armeria).\\n\\nThe [Armeria](https://github.com/line/armeria) project was initially developed by LINE but went to open source later.\\nEven though the project was initiated by LINE, Armeria is where it is now thanks to participation from many passionate contributors.\\nThat is why we organized this Armeria Contributor Reward Event, to express our gratitude to all of the contributors.\\n\\nLet me first give a quick summary of what open source contribution is.\\n\\n{/* truncate */}\\n\\n## What is open source contribution?\\n\\nWhen a new project is launched at a company, the project team is formed with participants from different areas such as development, planning, business and design.\\nThe same applies to open source projects as open source projects can deliver good results when people with different backgrounds, not only programmers but also testers, marketers, designers and technical writers, work together.\\nSome think, in the narrow sense, you contribute to open source only when your code is merged.\\nHowever, as open source projects are not all about programming, as I mentioned earlier, all kinds of contributions matter for the growth and sustainability of open source projects.\\nFor example, you are an open source contributor if you bring in more contributors by giving presentations on an open source project, if you donate your talent of writing for documentation, if you offer new ideas to resolve an issue, if you report a bug or if you help out with a logo or UI design.\\n\\nSo, why does each and every contributor count in the world of open source?\\nWhy can\'t it be controlled solely by a project owner?\\n\\n### Why contribute to open source? - from project owner\'s perspective\\n\\nWhen I talk to people who create open source projects, they tend to have a belief that projects are yet to be perfected and they can make them better with user feedback. [Eric S.\\nRaymond](https://en.wikipedia.org/wiki/Eric_S._Raymond), a well-known open source software advocate, wrote about open source software development models in his essay, [The Cathedral and the Bazaar](https://en.wikipedia.org/wiki/The_Cathedral_and_the_Bazaar).\\nThe point he wants to make is: the more contributors including users are, the better software becomes.\\n\\nLet\'s say you own a restaurant and sell your signature menu.\\nEveryone almost always has a different voice about the same menu.\\nSome might say it tastes just right for them while others could find it too sweet, too spicy or too salty.\\nOr, some might have an idea of perfect plating for your signature menu.\\nThere could also be someone who knows how to better design a menu to highlight your signature dish.\\nWhat if they have a channel to give their feedback right away or even make changes themselves?\\nSuch collaborated efforts and ideas could make your restaurant a more attractive place.\\nPeople might line up outside your beautiful restaurant to enjoy the upgraded signature menu.\\n\\nOpen source software development is fueled by user feedback.\\nIf you choose to go open source but ignore user feedback, users will gradually stop using the software.\\nThen, the software will eventually lose its purpose as a product.\\nOn the other hand, trying to handle every single feedback on your own is problematic too.\\nEspecially if there is too much feedback.\\nYou will naturally get more feedback when more contributors participate.\\nIt will become more difficult for you to respond to increasing feedback all by yourself, and when you fail to do so, it will result in deteriorating quality and loss of users.\\nIn the end, the open source software will become obsolete.\\n\\nSmooth communications between the project owner and users are essential to open source development based on user feedback.\\nQuick reflection of feedback will lead to more participation, creating a virtuous cycle of users actively participating as developers.\\nSuch a virtuous cycle will sustain the open source community for the project.\\n\\nAll this is from the perspective of project owners.\\nNow, let\'s look at it from a contributor\'s perspective.\\n\\n### Why contribute to open source? - from contributor\'s perspective\\n\\nFirst of all, you as a contributor can make requests to an open source project directly and immediately.\\nWhen there is an active community for the open source project, you will get replies in no time from other users or the maintainer.\\nWouldn\'t it make your open source life easier if you can get an answer to your questions quickly?\\nIf there is something you want to change, you can do it yourself, instead of waiting for someone to do it for you.\\nYou can also receive feedback on the changes you made.\\nRecords of everyone\'s participation is shared publicly at the open source community.\\nThis record can act as a portfolio and serve as a strong and effective self promotion, even more so than the coding tests you have to take in applying for jobs.\\n\\nDid any of you out there stand on the sidelines because you thought that open source projects were only for highly skilled programmers?\\nWhy don\'t you revisit those open source projects you have been following and contribute?\\nI\'d suggest to start with the issue list of a project, especially with the issues tagged with \'good-first-issue\', \'first-timers-only\' or \'help-wanted\'?\\n\\n## Armeria Contributor Reward\\n\\nThe purpose of the Armeria Contributor Reward Event was to express our gratitude to the contributors and interact with them.\\nSince the Armeria project was open to people around the globe, main communications channel was via texts or replies.\\nWe\'ve always felt that \\"LGTM (Looks Good To Me)\\" or \\":thumbsup:?\\" weren\'t enough to express our gratitude.\\nThis time, we have reached out to individual contributors by email and sent a small gift.\\n\\nWe also created an event banner, using the [GitHub profile pictures](https://help.github.com/articles/personalizing-your-profile/#changing-your-profile-picture) of all contributors.\\nIsn\'t it an adorable pink banner just like the logo of Armeria?\\n\\n![](/img/thank-you-for-contributing-to-armeria-1.png)\\n\\n### Participation by contributors\\n\\nGitHub provides a [graph](https://github.com/line/armeria/graphs/contributors) on contributions.\\nThe following is a summary of what the graph tells you.\\nUp until now, more than 60 contributors made more than 1,350 commits, adding about 457,000 lines and deleting 257,500 lines.\\nThe numbers tell how active our contributors have been.\\n\\n![](/img/thank-you-for-contributing-to-armeria-2.png)\\n\\nLet\'s take a closer look on more specific contributions from the contributors.\\n\\n- Your contribution led Armeria\'s annotated service to a whole new level.\\n- Your Retrofit integration module was one of the greatest additions in Armeria\'s history.\\n- HTTP redirection is now easier than ever with Armeria thanks to your contribution.\\n- Your work on implementing the high quality circuit breaker in Armeria is considered as an all-time legend.\\n- Your optimization of weighted round-robin load balancing algorithm was very clever idea that it was worth of a prize.\\n- We appreciate your initial groundwork, especially on the client-side, which made today\'s Armeria.\\n- Thank you for promoting Armeria to the developer communities and we appreciate your contribution to the project!\\n- Your documentation clean-up made us look way better than ever.\\n- Your help with fixing the bug made Armeria more stable than ever.\\n- Although your part was small, your dedication saved many of our days.\\n\\nOn top of this, many contributors made contributions in various ways.\\nWe sent a thank-you note to each and every one of them.\\n\\n### Interview with @anuraaga\\n\\nAs the [Insights tab](https://github.com/line/armeria/graphs/contributors) on GitHub shows, it was [@anuraaga](https://github.com/line/armeria/commits?author=anuraaga) who made the most contributions except for the project owners.\\nWe took this opportunity to interview @anuraaga to share his thoughts.\\n\\n**Q.\\nCould you please introduce yourself briefly?**\\n\\nA.\\nI\'m Anuraag, many call me Rag.\\nI am a software engineer, and I have worked on many large-scale server-side projects.\\nI got to know Armeria when I was working at LINE in the LINE Shop team \xe2\x80\x94 it was a really great coincidence that when I joined the team and wanted a full-featured RPC framework to replace legacy [Thrift](https://thrift.apache.org/) libraries, [@trustin](https://github.com/trustin)(Trustin, the project owner) had just started working on the Armeria project to provide that.\\nSince then, even after leaving LINE, I have been using Armeria in all my projects and continue to contribute what I can to the project.\\n\\n**Q.\\nHow do you use Armeria?\\nDo you use it at work?**\\n\\nA.\\nI use Armeria for all my server-side needs, for work and personal needs.\\nMy company, [Infostellar](https://www.infostellar.net/), is building out global network infrastructure for satellite communications, and this means transferring lots of data, in addition to usual needs of an API.\\nOur architecture follows a standard service-based one, with many servers running on [Kubernetes](https://kubernetes.io/), each exposing a [gRPC](https://grpc.io/) API using Armeria.\\nWe also have a web frontend, which is also powered by Armeria\'s static file serving functionality and support for gRPC-Web.\\n\\nAside from work, Armeria is also my go-to for personal projects on the weekends.\\nI\'m glad I can use Armeria effectively in all sizes of projects as it just satisfies the use cases I need :)\\n\\n**Q.\\nWhat do you think is the best part of Armeria?**\\n\\nA.\\nI think Armeria\'s strongest point is the focus on developer productivity.\\nTrustin has really created the project to satisfy the needs of all developers, and it means lots of flexibility, while also showcasing best practices and ensuring developers don\'t miss out on modern trends such as asynchronous programming.\\nI have seen other frameworks or libraries where the maintainers take a very theoretical approach, which often results in the library being harder to use for developers because it focuses on what the maintainers want to see in a library, not what the developers need in a library.\\nI think Armeria\'s focus on developer needs, including providing full support in a Slack channel, allows it to be useful to a large spectrum of developers, not just a small segment.\\n\\nI also want to say that I really appreciate that Armeria is the most flexible server framework I\'ve seen \xe2\x80\x94 being able to serve gRPC, static files, metrics, DocService, and any other content all on the same TCP port is a big achievement!\\n\\n**Q.\\nHave you experienced any difficulties in participating in Armeria development?**\\n\\nA.\\nArmeria development has been very smooth for me.\\nThe documentation and IDE(Integrated Development Environment) settings setup is easy to follow and PRs (Pull Requests) go smoothly thanks to the pleasant reviewers.\\nFor a little while, I did feel that releases were happening slowly, and I\'ve even had to once deploy a snapshot with a bugfix that was merged but not released for some time.\\nLately, though, it seems releases are happening much more frequently and I haven\'t felt this at all. :)\\n\\nOne small point, which I guess is hard to change, is I do find myself having trouble getting whitespace formatting right even with the imported code settings \xe2\x80\x94 it\'s especially embarrassing seeing Trustin fix some whitespace issues in future PRs when he notices the ones I missed. ;) Using an automatic formatter would remove one thing to worry about during development.\\n\\n**Q.\\nDo you have any plans for or expectations from the project?**\\n\\nA.\\nI personally plan to continue to use Armeria, contributing code when I find a new feature that may be useful, etc.\\nActually this is a good point; I\'m not clear on what are the project\'s expectations for itself.\\nThere are many feature requests, often using a limited scope of technology \xe2\x80\x94 [adding support](https://github.com/line/armeria/issues/194) for more service discovery mechanisms is a recent one that reminded me of this, another being whether to natively support spring security or not.\\nI imagine it\'s not in Armeria\'s scope to support every single technology in the world, and wonder how to draw the line.\\n\\n**Q.\\nWhat do you think about open source or open source contribution?**\\n\\nA.\\nI love open source!\\nI think it creates useful technology for all the developers out there, but also creates strong communities and I am really surprised but happy to have made many friends through open source.\\nI hope to get to meet many more people through continued open source activities and encourage anyone that has some free time to just send a PR to their favorite repository.\\n\\n**Q.\\nAny other comments?**\\n\\nA.\\nI am excited that this event happened \xe2\x80\x94 it\'s great to see a focus on expanding open source from a leading company like LINE.\\nIt\'s easy for companies to just put out some source code, but not easy to actually support the ecosystem itself.\\nThanks a lot for helping to build the open source community!\\n\\n## Closing\\n\\nArmeria is planning a range of programs to reach out to more users and contributors.\\nWe will share the news on upcoming events via [LINE Engineering blog](https://engineering.linecorp.com/ko/blog/) and [official Slack](https://line-armeria.slack.com/join/shared_invite/enQtNjIxNDU1ODU1MTI2LTgwMzk0MzVhOGRhZjJiY2ExODc0MzNhYzIxZDFlYjM5OGRjNTE1MzYzYzQ4MzNhNGY2ZDM0NThhMTRmZmQ3ZjQ) like we always do.\\n\\nMoreover, LINE is looking for programmers for [Armeria](https://github.com/line/armeria) and [Central Dogma](https://github.com/line/centraldogma).\\nPlease check out the following job posting for more information.\\n\\n- [Open position: common framework and platform software development](https://recruit.linepluscorp.com/lineplus/career/detail/20002599) - Korea"},{"id":"/2018/09/13/making-a-basic-server-with-java-armeria","metadata":{"permalink":"/blog/2018/09/13/making-a-basic-server-with-java-armeria","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2018-09-13-making-a-basic-server-with-java-armeria.mdx","source":"@site/src/content/blog/en/2018-09-13-making-a-basic-server-with-java-armeria.mdx","title":"Making a basic server with Java & Armeria","description":"As some of you know already, LINE has been actively open-sourcing projects including Armeria and Central Dogma.","date":"2018-09-13T00:00:00.000Z","tags":[],"readingTime":5.36,"hasTruncateMarker":true,"authors":[{"name":"Inseong","title":"LINE Engineer","imageURL":"/img/author-inseong.png","key":"inseong","page":null}],"frontMatter":{"authors":["inseong"]},"unlisted":false,"prevItem":{"title":"Thank you for contributing to Armeria!","permalink":"/blog/2019/04/16/thank-you-for-contributing-to-armeria"},"nextItem":{"title":"Applying CircuitBreaker to Channel Gateway","permalink":"/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway"}},"content":"As some of you know already, LINE has been actively open-sourcing projects including [Armeria](https://line.github.io/armeria/) and [Central Dogma](https://line.github.io/centraldogma/).\\nToday, I\'d like to share a bit about Armeria and setting up a simple web server using Armeria.\\nTo follow the instructions, you need to have Java and IntelliJ IDEA installed, which can be downloaded from the following links:\\n\\n- [Java Development Kit](https://www.oracle.com/technetwork/java/javase/downloads/index.html)\\n- [IntelliJ IDEA](https://www.jetbrains.com/idea/)\\n\\n{/* truncate */}\\n\\n## Create a project\\n\\nLet us begin by creating a project.\\nFirst, run IntelliJ IDEA and click the **Create New Project** button.\\nThe New Project dialog pops up.\\n\\n![](/img/making-a-basic-server-with-java-armeria-1.png)\\n\\nOn the New Project dialog, click the **Gradle** menu from the left panel, and then check the box for **Java**, and click the Next button.\\nThe dialog displays the fields required for project configuration.\\n\\n![](/img/making-a-basic-server-with-java-armeria-2.png)\\n\\nConfigure the fields as instructed below.\\n\\n- **GroupId**: We will skip this field. This field is optional anyway.\\n- **ArtifactId**: Enter a name to represent your project. For this post, I named it \'hello-armeria\'.\\n- **Version**: Use the default value already in the input field.\\n\\n![](/img/making-a-basic-server-with-java-armeria-3.png)\\n\\nOnce you are done with filling in, click the **Next** button.\\nContinue with the rest of the step until you see the **Finish** button.\\n\\n## Configure Gradle\\n\\nOnce a project is created, open the `build.gradle` file, which you can find from the **Project** panel on the left-hand side.\\nYou will see a few lines of code like below.\\nAdd the line marked with comments I\'ve left, and save the file.\\nThis makes Gradle automatically configure \u2014 download and build \u2014 the Armeria library for you.\\nIt may take sometime for the process to be completed.\\n\\n```\\nplugins {\\n    id \'java\'\\n}\\n\\nversion \'1.0-SNAPSHOT\'\\n\\nsourceCompatibility = 1.8\\n\\nrepositories {\\n    mavenCentral()\\n}\\n\\ndependencies {\\n    // Add the following line of code\\n    // <Group Name>:<Artifact Id>:<Version>\\n    compile \\"com.linecorp.armeria:armeria:0.71.1\\"\\n}\\n```\\n\\n## Hello Armeria!\\n\\nNow, let\'s make a class.\\nGo to **src > main**, right-click on **java**, and click **New > Java Class**.\\nWe\'ll name the class `ServerMain.java` and make it print, `\\"Hello, Armeria!\\"`.\\n\\n![](/img/making-a-basic-server-with-java-armeria-4.png)\\n\\nFirst, we will create an instance of the `ServerBuilder` class and run the server, in the following steps:\\n\\n1. Set the port using the `http()` method.\\n2. Configure the server with the `service()` method.\\n3. Create an instance of `Server`.\\n4. Call the `start()` method.\\n\\nHere is the actual code:\\n\\n```\\nimport com.linecorp.armeria.common.HttpResponse;\\nimport com.linecorp.armeria.common.HttpStatus;\\nimport com.linecorp.armeria.common.MediaType;\\nimport com.linecorp.armeria.server.Server;\\nimport com.linecorp.armeria.server.ServerBuilder;\\nimport java.util.concurrent.CompletableFuture;\\n\\npublic class ServerMain {\\n    public static void main(String[] args) {\\n        ServerBuilder sb = new ServerBuilder();\\n        sb.http(8080);\\n        sb.service(\\"/hello\\", (ctx, res) ->\\n            HttpResponse.of(\\n                HttpStatus.OK,\\n                MediaType.HTML_UTF_8,\\n                \\"<h1>Hello Armeria...!</h1>\\"));\\n        Server server = sb.build();\\n        CompletableFuture<Void> future = server.start();\\n        future.join();\\n    }\\n}\\n```\\n\\nTo those who are unfamiliar with IntelliJ IDEA, here is a little tip on importing classes.\\nWhen you enter the name of a class in your code and the class needs to be imported \u2014 in our case, `ServerBuilder` and `HttpResponse` \u2014 press **ALT + Enter**.\\nYou will see the context menu with options available for the given class.\\nSelect **Import class** from the menu which will automatically add an import statement for the specified class on the file.\\n\\n![](/img/making-a-basic-server-with-java-armeria-5.png)\\n\\nNote that if you select the **Import class** option on `MediaType`, available options are as follows:\\n\\n- `MediaType (com.google.common.net)`\\n- `MediaType (com.linecorp.armeria.common)`\\n\\nSince we are using Armeria, select `com.linecorp.armeria.common`.\\n\\n![](/img/making-a-basic-server-with-java-armeria-6.png)\\n\\n## Run a web server for starters\\n\\nTo run a web server from IntelliJ IDEA, go to **Run > Run \\\\<file_name\\\\>**.\\nYou may see warnings on SLF4J (a library for printing out logs) that it cannot find a suitable logger implementation, but that\'s not important at the moment.\\nLet\'s focus on getting our Armeria server up and running.Open a web browser, enter the URL, http://127.0.0.1:8080/hello, and you will be greeted with `\\"Hello, Armeria...!\\"`.\\n\\n![](/img/making-a-basic-server-with-java-armeria-7.png)\\n\\nSo, that was it!\\nMaking a web server with Java couldn\'t be simpler than this, right?\\nYou\'ve only seen the tip of the iceberg; there is much more to Armeria than this.\\nJust to show you a little bit more, let\'s move onto routing, the most basic and the core feature of web servers.\\n\\n## Routing\\n\\nCreate a Java class and name it `CustomService` or any other name you like.\\nCopy and paste the following code in the class.\\nIn addition to `HttpResponse.of()`, I\'ve added annotations for routing.\\nTo keep things simple, I did not add this configuration in the `build.gradle` file, but instead, passed a parameter, `@Param(\\"number\\") int number`.\\nYou can enter parameters like `@Param int number`, if you add `-parameters` in the compile option for `build.gradle`.\\n\\nUsing annotations, we set up routing; set `methodA()` to be called via `GET \\"/\\"`.\\nLikewise, `methodB()` is to be called via `GET \\"/page/<number>\\"`.\\n\\n```\\nimport com.linecorp.armeria.common.HttpResponse;\\nimport com.linecorp.armeria.common.HttpStatus;\\nimport com.linecorp.armeria.common.MediaType;\\nimport com.linecorp.armeria.server.annotation.Get;\\nimport com.linecorp.armeria.server.annotation.Param;\\n\\npublic class CustomService {\\n    @Get(\\"/\\")\\n    public HttpResponse methodA() {\\n        return HttpResponse.of(\\n            HttpStatus.OK,\\n            MediaType.HTML_UTF_8,\\n            \\"<h1>Hello Custom Service...!</h1>\\");\\n    }\\n\\n    @Get(\\"/page/:number\\")\\n    public HttpResponse methodB(@Param(\\"number\\") int number) {\\n        return HttpResponse.of(\\n            HttpStatus.OK,\\n            MediaType.HTML_UTF_8,\\n            \\"<h1>Hello %d...!</h1>\\", number);\\n    }\\n}\\n```\\n\\nThe next step is to modify our class, `ServerMain`.\\nWe need to pass the instance of the `CustomService` class.\\nTo do so, call the `annotatedService()` method and pass the instance as the parameter.\\n\\n```\\nimport com.linecorp.armeria.server.Server;\\nimport com.linecorp.armeria.server.ServerBuilder;\\nimport java.util.concurrent.CompletableFuture;\\n\\npublic class ServerMain {\\n    public static void main(String[] args) {\\n        ServerBuilder sb = new ServerBuilder();\\n        sb.http(8080);\\n\\n        sb.annotatedService(new CustomService());\\n\\n        Server server = sb.build();\\n        CompletableFuture<Void> future = server.start();\\n        future.join();\\n    }\\n}\\n```\\n\\n## Run again!\\n\\nNow run the code and open http://127.0.0.1:8080/.\\nYou will see `\\"Hello Custom Service...!\\"` printed on the page.\\n\\n![](/img/making-a-basic-server-with-java-armeria-8.png)\\n\\nThis time, add `/page/10` to the URL to make it http://127.0.0.1:8080/page/10, and open the page.\\nYou will see `\\"Hello 10...!\\"` instead.\\n\\n![](/img/making-a-basic-server-with-java-armeria-9.png)\\n\\nUsing Armeria, implementing routing is a piece of cake!\\nToday, we\'ve looked through the most basic way of using Armeria.\\nArmeria supports serving static files, running and calling Thrift services, structured logging with Kafka and many others.\\nVisit the [official Armeria site](https://line.github.io/armeria/) and the [GitHub repository](https://github.com/line/armeria) to learn more about Armeria.\\n\\n![](/img/making-a-basic-server-with-java-armeria-10.png)"},{"id":"/2016/08/04/applying-circuitbreaker-to-channel-gateway","metadata":{"permalink":"/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2016-08-04-applying-circuitbreaker-to-channel-gateway.mdx","source":"@site/src/content/blog/en/2016-08-04-applying-circuitbreaker-to-channel-gateway.mdx","title":"Applying CircuitBreaker to Channel Gateway","description":"Before reading","date":"2016-08-04T00:00:00.000Z","tags":[],"readingTime":7.23,"hasTruncateMarker":true,"authors":[{"name":"Shin Jong Hun","title":"I don\u2019t like being inconvenienced. One of the focal points of my work is to reduce these inconveniences so I have more time to focus on what matters. I think that\u2019s why I like programming. Although I can\u2019t really figure out why I seem to be getting busier with time\u2026","imageURL":"/img/author-shinjonghun.png","key":"shinjonghun","page":null}],"frontMatter":{"authors":["shinjonghun"],"other_languages":{"ja":"/blog/ja/2016/08/04/applying-circuitbreaker-to-channel-gateway","ko":"/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway"}},"unlisted":false,"prevItem":{"title":"Making a basic server with Java & Armeria","permalink":"/blog/2018/09/13/making-a-basic-server-with-java-armeria"},"nextItem":{"title":"Circuit breakers for distributed services","permalink":"/blog/2016/07/24/circuit-breakers-for-distributed-services"}},"content":"## Before reading\\n\\nIf you have yet to read the introductory article to circuit breakers, I recommend you read the following article first: [Circuit Breakers for distributed services](/blog/2016/07/24/circuit-breakers-for-distributed-services)\\n\\n## Applying CircuitBreaker to Channel Gateway\\n\\nChannel Gateway servers provide various LINE server features to content providers.\\nThis is why Channel Gateway servers are highly affected by the servers they are connected to, with the effects easily spreading across all Channel Gateway servers.\\n\\n![](/img/applying-circuitbreaker-to-channel-gateway-1.png)\\n\\n{/* truncate */}\\n\\nIt was when I was struggling to think of a solution to this problem that I first heard about circuit breakers.\\nCircuit breakers seem to be what I was looking for since they are able to detect a problem in certain servers, blocking all requests that the server would have otherwise received.\\nWith that in mind, I decided to apply circuit breakers on Channel Gateway.\\n\\nWhile I could have implemented my own circuit breakers on Channel Gateway, there were already excellent circuit breakers on [Armeria](http://line.github.io/armeria).\\nArmeria enables you to set various options on circuit breakers when you implement them using `CircuitBreakerBuilder`, generating your own `CircuitBreaker` object as a result.\\nI was able to easily apply a customized circuit breaker on Channel Gateway thanks to this system.\\n\\n## Annotation for CircuitBreaker\\n\\nI was able to apply `CircuitBreaker` to the talk-channel-gateway source code with a `@CircuitBreakable` annotation.\\n\\n```\\n@CircuitBreakable(CircuitBreakerGroup.HBASE_CLIENT_USER_SETTINGS)\\npublic ChannelSettings findBy(String mid) {\\n    ...\\n}\\n```\\n\\nIf applied like the example above, `CircuitBreaker` opens and closes depending on the results gathered while monitoring the successful/failed call attempts on the findBy() method.\\nHBASE_CLIENT_USER_SETTINGS is used to specify the groups grouped by `CircuitBreaker`, calculating the group\'s percentage of failed calls out of the successful calls on methods, and opening and closing along with `CircuitBreaker`.\\nYou can change the options for `CircuitBreaker` with the enum object called `CircuitBreakerGroup` as shown below.\\n\\n```\\npublic enum CircuitBreakerGroup implements ExceptionFilter {\\n\\n    SAMPLE_DEFAULT {\\n    },\\n    SAMPLE_API {\\n        @Override\\n        protected ExceptionFilter exceptionFilter() {\\n            return cause -> !(cause instanceof AuthenticationException\\n                              || cause instanceof ApiPermissionException\\n                              || cause instanceof ImproperRequestException);\\n        }\\n    },\\n    HBASE_CLIENT_CHANNEL_MATRIX {\\n    },\\n    HBASE_CLIENT_USER_SETTINGS {\\n    };\\n\\n    protected ExceptionFilter exceptionFilter() {\\n        return cause -> true;\\n    }\\n\\n    public CircuitBreaker circuitBreaker(CircuitBreakerListener listener) {\\n        return new `CircuitBreakerBuilder`(name()).exceptionFilter(exceptionFilter())\\n                                                .listener(listener)\\n                                                .build();\\n    }\\n\\n    @Override\\n    public boolean shouldDealWith(Throwable throwable) throws Exception {\\n        return exceptionFilter().shouldDealWith(throwable);\\n    }\\n}\\n```\\n\\nI used a customized `ExceptionFilter` on Channel Gateway, while other options were kept at their default values from Armeria.\\nYou can change options to your needs by modifying the `circuitBreaker()` method.\\n\\nThe default Armeria settings are set to identify any exception as a failure.\\nHowever, Channel Gateway also treats any unauthorized accesses as exceptions, and there needed to be a distinction between these and the relevant exceptions.\\nThat\'s why I had to customize `ExceptionFilter`.\\nI also added an event listener for Channel Gateway so that logs would be recorded each time a change is detected in `CircuitBreaker`.\\n\\nThe groups applied to annotations can be specified using the enum object, and you can set different settings for each group when implementing the enum object.\\n\\n## Implementing proceed() for CircuitBreaker\\n\\nThe `proceed()` code for the [Aspect](https://en.wikipedia.org/wiki/aspectj) object is as shown below.\\n\\n```\\npublic class CircuitBreakerAspect implements Ordered {\\n\\n    private final Map&lt;CircuitBreakerGroup, CircuitBreaker>\\n    circuitBreakers = new EnumMap&lt;>(CircuitBreakerGroup.class);\\n\\n    @PostConstruct\\n    public void initialize() {\\n\\n        final CircuitBreakerListener listener = new\\n        CircuitBreakerListenerImpl(circuitBreakerLogger);\\n        for (CircuitBreakerGroup group : CircuitBreakerGroup.values()) {\\n            circuitBreakers.put(group, group.circuitBreaker(listener));\\n        }\\n    }\\n\\n    public Object proceed(final ProceedingJoinPoint pjp, final CircuitBreakable\\n    circuitBreakable) throws Throwable {\\n\\n        final CircuitBreakerGroup group = circuitBreakable.value();\\n        final CircuitBreaker circuitBreaker = circuitBreakers.get(group);\\n\\n        if (circuitBreaker.canRequest()) {\\n            final Object result;\\n\\n            try {\\n                result = pjp.proceed();\\n            } catch (Throwable e) {\\n                if (group.shouldDealWith(e)) {\\n                    circuitBreaker.onFailure(e);\\n                } else {\\n                    circuitBreaker.onSuccess();\\n                }\\n                throw e;\\n            }\\n\\n            circuitBreaker.onSuccess();\\n            return result;\\n        } else {\\n            throw CircuitBreakerException.circuitBroken();\\n        }\\n    }\\n}\\n```\\n\\nThe code itself is quite simple.\\nIf `CircuitBreaker` is open through `CircuitBreaker.canRequest()`, an exception occurs.\\nIf not, the method is called normally.\\nIf the result of the call caused an exception, and the exception is identified as a failure, `CircuitBreaker` is notified that it\'s a failure.\\nIf not, `CircuitBreaker` is notified that it\'s a success.\\n\\nFor you information, the actual code has code related to IMON Logger1 to check if `CircuitBreaker` is working as intended.\\nI omitted that feature from this article to focus more on `CircuitBreaker` only.\\n\\n_1 IMON Logger: IMON is a system LINE engineers use to monitor various company services.\\nIMON Logger collects the statistics and logs from these services and sends them to IMON._\\n\\n## Methods used to change settings for CircuitBreaker\\n\\n`CircuitBreakerBuilder` provides many methods that you can use to build your own customized `CircuitBreaker`.\\nWhile I recommend using the default settings, here are some details for each setting to help you get a better idea about them.\\n\\n| Method                      | Parameter              | Default       | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |\\n| --------------------------- | ---------------------- | ------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\\n| failureRateThreshold        | double                 | 0.8           | This is the failure rate used to determine whether CircuitBreaker should open or not. If the failure rate (during the duration of `counterSlidingWindow`) is higher than this value, CircuitBreaker opens. The default value is set to open CircuitBreaker if the failure rate is above 80%. In other words, CircuitBreaker opens if the success rate is below 20%.                                                                                                          |\\n| minimumRequestThreshold     | long                   | 10            | The minimum amount of call requests required to determine whether CircuitBreaker should open or not. If the number of requests (during the duration of `counterSlidingWindow`) is lower than this value, CircuitBreaker does not change its status.                                                                                                                                                                                                                          |\\n| circuitOpenWindow           | Duration               | 10 seconds    | The amount of time CircuitBreaker stays open before going into the half-open state. After CircuitBreaker has been open for the duration of `circuitOpenWindow`, CircuitBreaker will change its state to half-open and test requests again.                                                                                                                                                                                                                                   |\\n| circuitOpenWindowMillis     | long                   | 10000         |\\n| trialRequestInterval        | Duration               | 3 seconds     | The amount of time before a request is reattempted in the half-open state when the request does not get a closed response. If there is a response during `trialRequestInterval`, CircuitBreaker will change its state to open or closed depending on the result. If CircuitBreaker goes into the open state, the request will be reattempted after `circuitOpenWindow`. If the request does not get a response during `trialRequestInterval`, it will be reattempted.        |\\n| trialRequestIntervalMillis  | long                   | 3000          |\\n| counterSlidingWindow        | Duration               | 20 seconds    | Recent `counterSlidngWindow` values are used to determine whether CircuitBreaker should open or not. The default value is set to only recognize the requests received in the last 20 seconds.                                                                                                                                                                                                                                                                                |\\n| counterSlidingWindowMillis  | long                   | 20000         |\\n| counterUpdateInterval       | Duration               | 1 second      | CircuitBreaker stores request results through `SlidingWindowCounter`, and `counterUpdateInterval` is the unit of time stored. The default value is set to keep records per each second. An example of this would look like this: 20 second(s) before = Success 20, Failure 0 / 19 second(s) before = Success 25, Failure 1 / ... / 1 second(s) before = Success 21, Failure 0. The failure rate is calculated using these records from the duration of counterSlidingWindow. |\\n| counterUpdateIntervalMillis | long                   | 1000          |\\n| exceptionFilter             | ExceptionFilter        | cause -> true | An object that returns whether or not an exception is identified as a failure. The default value is set to identify all exceptions as failures.                                                                                                                                                                                                                                                                                                                              |\\n| listener                    | CircuitBreakerListener |               | A listener that receives events whenever the state of CircuitBreaker changes, when `counterUpdateInterval` expires, or when an open CircuitBreaker rejects a request.                                                                                                                                                                                                                                                                                                        |\\n\\n## Closing words\\n\\nUp until recently, whenever there was a problem somewhere in Channel Gateway the damage was already done by the time we could actually do something about it.\\nA partial outage could cause the entire thread to be full, eventually affecting all services.\\nNow that we have `CircuitBreaker` blocking the problematic parts from the rest of the system, we have a wider time window to work with.\\n\\nTo wrap up this article, I\'d like to go through how `CircuitBreaker` works step by step.\\n\\n- The initial state of `CircuitBreaker` is _Closed_.\\n- _Closed_: Depending on `ExceptionFilter` settings, the following will happen after a request is processed.\\n  - If the result is a success, it will be logged as a success and the state changes to _Closed_.\\n  - If the result is a failure, the requests during the duration of `counterSlidingWindow` are checked and\\n    - If requests are more than `minimumRequestThreshold`, and the failure rate is above `failureRateThreshold`, the state changes to _Open_.\\n    - If not, the state remains _Closed_.\\n- _Open_: After the duration of `circuitOpenWindow` passes, the state changes to _Half-Open_.\\n- _Half-Open_: Depending on `ExceptionFilter` settings, the following will happen after processing the first request received.\\n  - If the result is a success, the state changes to _Closed_.\\n  - If the result is a failure, the state changes to _Open_.\\n  - If there is no response during the duration of `trialRequestInterval`, a branch will occur depending on the result of the first request received during the _Half-Open_ state.\\n\\n## About the author\\n\\nShin, Jong Hun: I don\'t like being inconvenienced.\\nOne of the focal points of my work is to reduce these inconveniences so I have more time to focus on what matters.\\nI think that\'s why I like programming.\\nAlthough I can\'t really figure out why I seem to be getting busier with time..."},{"id":"/2016/07/24/circuit-breakers-for-distributed-services","metadata":{"permalink":"/blog/2016/07/24/circuit-breakers-for-distributed-services","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2016-07-24-circuit-breakers-for-distributed-services.mdx","source":"@site/src/content/blog/en/2016-07-24-circuit-breakers-for-distributed-services.mdx","title":"Circuit breakers for distributed services","description":"Hello, my name is Ono and I\'m a LINE engineer.","date":"2016-07-24T00:00:00.000Z","tags":[],"readingTime":5.39,"hasTruncateMarker":true,"authors":[{"name":"Ono Yuichi","title":"He is a LINE engineer.","imageURL":"/img/author-onoyuichi.png","key":"onoyuichi","page":null}],"frontMatter":{"authors":["onoyuichi"],"other_languages":{"ja":"/blog/ja/2016/07/14/circuit-breakers-for-distributed-services","ko":"/blog/ko/2016/07/24/circuit-breakers-for-distributed-services"}},"unlisted":false,"prevItem":{"title":"Applying CircuitBreaker to Channel Gateway","permalink":"/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway"},"nextItem":{"title":"Open-sourcing Armeria","permalink":"/blog/2016/04/13/open-sourcing-armeria"}},"content":"Hello, my name is Ono and I\'m a LINE engineer.\\nIn this blog post, I\'d like to talk about \\"circuit breakers\\" which we use with our LINE servers.\\n\\n## What is a Circuit Breaker?\\n\\nThe backend server systems for various web services and apps including LINE consist of networks that have several services connected with each other through APIs and RPCs.\\n\\nWhat would happen if one of these networks suddenly failed to respond?\\nThe downed services would be blocked until they time-out, and all other services that rely on the blocked service would start a chain reaction of failures.\\nIf no one has been keeping an eye on the entire network, it will take a long time to figure out which service is the root cause.\\n\\n![-BG-](/img/circuit-breakers-for-distributed-services-1.png)\\n\\n{/* truncate */}\\n\\nThese chain reaction failures should be prevented at all costs.\\nAt the least, the core features must be protected from these failures.\\nTo achieve that, we must block off access to the downed service before it affects another.\\n\\n![-BG-](/img/circuit-breakers-for-distributed-services-2.png)\\n\\nCircuit breakers are used to automate this whole process.\\n\\n[http://martinfowler.com/bliki/CircuitBreaker.html]\\n\\nThe in-depth details behind the system can be found in the post above by Martin Fowler, but I\'ll keep it brief here.\\n\\nA circuit breaker is a system that automatically blocks off access when the number of failed remote access attempts exceeds the failure rate.\\n\\nCircuit breakers can be seen as state machines.\\nThey can automatically detect failures and determine when they\'re restored by continuously updating access success and failure events.\\n\\n![](/img/circuit-breakers-for-distributed-services-3.png)\\n\\nBelow are details for each state and their conditions.\\n\\n**CLOSED**  \\nInitial state.\\nAll accesses are treated normally.\\n\\n**OPEN**  \\nThe state changes to OPEN once the number of failures exceeds the failure rate.\\nAll accesses are blocked off (fail fast).\\n\\n**HALF_OPEN**  \\nAfter a certain amount of time in the OPEN state, it changes into the HALF_OPEN state.\\nIf an attempted access succeeds, the state changes to CLOSED.\\nIf access fails, the state changes to OPEN.\\n\\n## Circuit breakers for Armeria\\n\\n[Armeria](http://line.github.io/armeria/) is an asynchronous Thrift client/server library based on Netty, released as a LINE open source project.\\nOne of Armeria\'s many key features is its ability to expand features using decorators.\\n\\nStarting with version 0.13.0 of Armeria, it is possible to add circuit breakers using decorators.\\n\\nBelow is an example of initializing a Thrift client using a circuit breaker.\\n\\n```\\nIface helloClient = new ClientBuilder(\\"tbinary+http://127.0.0.1:8080/hello\\")\\n                     .decorator(\\n                      CircuitBreakerClient.newDecorator(\\n                          new CircuitBreakerBuilder(\\"hello\\").build()\\n                      )\\n                     )\\n                     .build(Iface.class);\\n```\\n\\nEasy, right?\\n\\nBelow is the code for calling this Thrift client.\\n\\n```\\ntry {\\n    helloClient.hello(\\"line\\");\\n} catch (TException e) {\\n    // error handling\\n} catch (FailFastException e) {\\n   // fallback code\\n}\\n```\\n\\nAs you can see in the example above, when the circuit breaker detects a failure, the Thrift client will send a FailFastException, running the appropriate fallback code.\\nIt can be used in the same way for an asynchronous client.\\n\\n```\\nhelloClient.hello(\\"line\\", new AsyncMethodCallback() {\\n  public void onComplete(Object response) {\\n     // response handling\\n  }\\n  public void onError(Exception e) {\\n     if (e instanceof TException) {\\n         // error handling\\n     } else if (e instanceof FailFastException) {\\n         // fallback code\\n     }\\n }\\n});\\n```\\n\\n## Grouping\\n\\nIn the example above, a single circuit breaker was allocated for each Thrift service.\\nIn this case, if a single method causes a problem in a service, all other methods will be blocked when the circuit breaker becomes active.\\nThis would only spread the failure to more parts, and isn\'t something that is recommended.\\n\\nThat\'s why Armeria lets its users group the range of circuit breaker instances in a variety of ways.\\n\\nBelow are the grouping conditions.\\n\\n**Per Host**  \\nA single circuit breaker is allocated for each remote host.\\n\\n**Per Method**  \\nA single circuit breaker is allocated for each method.\\n\\n**Per Host and Method**  \\nA single circuit breaker is allocated each method in each host.\\n\\n![-BG-](/img/circuit-breakers-for-distributed-services-4.png)\\n\\n## Failure Rate\\n\\nWhen using circuit breakers, it\'s important to clearly define the conditions for a failure.\\n\\nFailures in Armeria are when the number of failed requests (failure rate) exceeds the _Failure Rate Threshold_.\\n\\nHowever, in cases where there are too few requests, (such as right after launching) the failure rate will be too irregular and the system may incorrectly assess the situation as a failure.\\nTo resolve this, you can set a _Minimum Request Threshold_ so that the system only begins to detect failures when the number of requests is at least at a certain amount.\\n\\nThe duration of the time where detection begins can also be adjusted with the _Sliding Window_.\\n\\nThe correlation between the failure rate and the sliding window can be seen in the figure below.\\n\\n![-BG-](/img/circuit-breakers-for-distributed-services-5.png)\\n\\n## Monitoring\\n\\nYou can monitor the status of circuit breakers by adding a listener.\\n\\nBelow is sample code using a listener based on Dropwizard Metrics provided by Armeria.\\nYou can implement listeners that match your customized monitoring system.\\n\\n```\\nMetricRegistry registry = new MetricRegistry();\\n\\nIface helloClient = new ClientBuilder(\\"tbinary+http://127.0.0.1:8080/hello\\")\\n       .decorator(\\n        CircuitBreakerClient.newDecorator(\\n          new CircuitBreakerBuilder(\\"hello\\")\\n            .listener(new DropwizardMetricsCircuitBreakerListener(registry, \\"hello\\"))\\n            .build()\\n        )\\n       )\\n       .build(Iface.class);\\n```\\n\\n## Using Armeria\'s circuit breaker independently\\n\\nUp to this point, I\'ve talked about how you can combine the Armeria thrift client and circuit breaker package, but it\'s also possible to use the circuit breaker package independently.\\n\\nWhen using the circuit breaker package independently, keep the following 3 APIs in mind.\\n\\n**CircuitBreaker#canRequest()**  \\nChecks the status of the circuit breaker.\\nIf the circuit is blocked off, the returned value will be \\"false.\\"\\n\\n**CircuitBreaker#onSuccess()**  \\nRecords successful access attempts to a service.\\n\\n**CircuitBreaker#onFailure() or CircuitBreaker#onFailure(Throwable t)**  \\nRecords failed access attempts to a service.\\n\\nIn the sample code below, canRequest() checks the status of the circuit and runs remote service access if there are no problems detected.\\nDepending on the result, the API will call onSuccess or onFailure.\\n\\nThe trigger condition for this sample was set to \\"whether or not exceptions were detected,\\" but you can change the condition to whatever fits your needs.\\nFor example, you can make it so that it counts as an error if remote service access took a certain amount of time even if there were no exceptions detected.\\n\\n```\\nif (circuitBreaker.canRequest()) {\\n   try {\\n       // remote service access\\n\\n       circuitBreaker.onSuccess();\\n   } catch (Exception e) {\\n       circuitBreaker.onFailure(e);\\n   }\\n} else {\\n   // fail fast\\n}\\n```\\n\\nThis concludes my introduction to the circuit breaker feature in Armeria.\\n\\nIn a future post, I plan to give you some real-life use cases from inside LINE."},{"id":"/2016/04/13/open-sourcing-armeria","metadata":{"permalink":"/blog/2016/04/13/open-sourcing-armeria","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2016-04-13-open-sourcing-armeria.mdx","source":"@site/src/content/blog/en/2016-04-13-open-sourcing-armeria.mdx","title":"Open-sourcing Armeria","description":"Armeria is an asynchronous RPC/API client-server implementation built on top of Java 8 and Netty that went open-source last November under Apache License 2.0 by LINE Corporation.","date":"2016-04-13T00:00:00.000Z","tags":[],"readingTime":10,"hasTruncateMarker":true,"authors":[{"name":"Trustin Lee","title":"He is the founder of Netty and a co-founder of Apache MINA.","imageURL":"https://github.com/trustin.png","key":"trustin","page":null}],"frontMatter":{"authors":["trustin"],"other_languages":{"ja":"/blog/ja/2016/04/13/open-sourcing-armeria","ko":"/blog/ko/2016/04/13/open-sourcing-armeria"}},"unlisted":false,"prevItem":{"title":"Circuit breakers for distributed services","permalink":"/blog/2016/07/24/circuit-breakers-for-distributed-services"}},"content":"import Head from \'@docusaurus/Head\';\\n\\n\\n[Armeria](http://line.github.io/armeria/) is an asynchronous RPC/API client-server implementation built on top of Java 8 and [Netty](http://netty.io/) that went open-source last November under Apache License 2.0 by LINE Corporation.\\nIts primary goal is to help engineers build high-performance asynchronous Thrift clients and servers that use HTTP/2 as a session layer protocol, although it is designed to be protocol-agnostic and highly extensible (for example, you can serve a directory of static files via HTTP/2 and run Java EE web applications).\\n\\n{/* truncate */}\\n\\nIn this post, I\'d like to focus on the steps that were taken to open-source an internal project rather than the technical aspect.\\nIf you are interested in the technical details of Armeria, you might want to check out the following slides presented last February during the 14th LINE Developer Meetup:\\n\\n<Head>\\n  <script\\n    async\\n    className=\\"speakerdeck-embed-script\\"\\n    src=\\"https://speakerdeck.com/assets/embed.js\\"\\n  ><\/script>\\n</Head>\\n<div\\n  className=\\"deck-embed js-deck-embed\\"\\n  style={{ aspectRatio: \'1024/640\' }}\\n  data-ratio=\\"1.6\\"\\n  data-state=\\"processed\\"\\n>\\n  <div\\n    className=\\"speakerdeck-embed\\"\\n    data-title=\\"false\\"\\n    data-skip-resize=\\"true\\"\\n    data-id=\\"8d645c29ce33400e8360e61fd0250f91\\"\\n    data-name=\\"Armeria: LINE\'s next generation RPC layer\\"\\n    data-ratio=\\"1.6\\"\\n    data-host=\\"speakerdeck.com\\"\\n  />\\n</div>\\n\\n## Cleaning up the project history\\n\\nWhen you work on an internal project, it is very likely that the project contains changesets you wouldn\'t have published if they were public from day 1, such as:\\n\\n- Confidential information (Such as issue numbers, host names, internal URLs)\\n- Commit messages that are meaningless or written in poor taste (\\"Blah\\", \\"WIP\\", \\"WTF\\")\\n- Copyright headers\\n\\nIt is obviously not an option to append an amending commit to the repository, because the history of the project would still be preserved.\\nWe need to clean up the history so that it does not leak anything unexpected.\\nThere are basically two options for this.\\n\\nOne option is to review each changeset and amend it individually.\\nAlthough you can reduce the amount of effort by using automation such as the [`git filter-branch`](https://git-scm.com/docs/git-filter-branch) command, you\'ll basically have to review every changeset carefully.\\nThe other option is to hide any unwanted information and collapse all changesets into a single commit.\\nThis is much simpler than the first option, but you will lose the history.\\nSomeday, you may wonder why you wrote a piece of code in a certain way, but you\'ll have no clue because the history has been squashed away.\\n\\nIf the project history is relatively short and you are sure your coding standards are pretty high, you might want to choose the first option.\\nOtherwise, if your time is limited and there\'s too much stuff to review, you would want to push the big red button like we did - squashing the history into a single commit.\\n\\nHowever, code is not written by a single person nowadays.\\nIf we just make a single commit, how would we credit the people who participated in this collaborative effort of fine workmanship?\\nWe ended up crediting them in our commit message.\\n\\n```\\nSubject: Initial import\\nThis commit contains the collective work of the following enthusiastic\\ncontributors at LINE Corporation:\\n- Anuraag Agrawal  @anuraaga\\n- Heon Jeong       @blmarket\\n- Young-tae Seok   @delegacy\\n- Su-ahn Lee       @inch772\\n- Woo-jung Choi    @sophiechoi\\n- Trustin Lee      @trustin\\n- Yuichi Ono\\n```\\n\\nLooking back, I should have expressed more appreciation into the commit message.\\nI can\'t thank you enough, folks!\\n\\n## Writing API documentation\\n\\nWhen starting a project from scratch, especially one with no real template to follow, it is important to write code fast and get it out fast to find design issues and bugs.\\nAPIs change fast in the early stages and it can be convenient to leave out API documentation to focus on implementation, leaving some holes that need to be filled later (of course, we also find it much more fun to write code than documentation).\\n\\nHowever, good documentation is one of the critical factors of adoption in the open-source scene.\\nIt\'s only when we are very desperate when we consider to use undocumented open-source software.\\nWhy would people use our open-source project if it is not documented well?\\nThere are already so many similar projects in the wild!\\n\\nSo, we had to fill all the holes we left open.\\nWe could call it \\"documentation debt\\" and we must admit that paying it back was not the most pleasing experience.\\nNow that we have documented everything properly, it is very easy to keep the documentation debt low by making sure any new public methods and classes are documented properly during the review process.\\nIt\'s like keeping your body fit; it\'s easier once you\'re fit.\\n\\n## Building a website\\n\\nAlthough Github is a good starting point for hosting a project, it is almost always better to provide a dedicated website.\\nIn a dedicated project website, we can organize the information we want to provide in the way we want and express the identity of the project in a more visually appealing way.\\n\\nHowever, building a website is not a simple job and we did not want to spend more time than writing a few lines of code to maintain it; we needed a scalable way to write and maintain it.\\n\\nFortunately, some engineers have open-sourced great website generation tools that help us deal with HTML and CSS, so we can bug our designers less often.\\nWe chose [Sphinx](http://www.sphinx-doc.org/en/stable/) in conjunction with [sphinx-maven-plugin](http://trustin.github.io/sphinx-maven-plugin/) and [Read the Docs theme](http://read-the-docs.readthedocs.org/en/latest/) so that we can generate our website as a part of the build process.\\nThere are also many other tools that serve similar purposes, such as [Awestruct](http://awestruct.org/) and [Jekyll](https://jekyllrb.com/), so you might want to play with them and choose what fits you if you are interested in building a website.\\n\\n## Designing a logo\\n\\n![](/img/open-sourcing-armeria-1.png)\\n\\nThe Armeria logo\\n\\nA logo is like the essence of a project.\\nIt visualizes and symbolizes what the project is and where it is going.\\nIt also helps people remember the project via association.\\n\\nBecause of its impact on a project, it requires a designer to contemplate and iterate over many prototypes.\\nWe fortunately had a new member with an industrial design degree who joined us at just the right time.\\nWe really appreciate her for helping us in her spare time, and we believe her next logo will be fascinating as well!\\n\\n## I\'m not a lawyer but legal stuff matters\\n\\nThe notion of open-source software has been around since the beginning of computing, but it hasn\'t been very long since open-source licensing caught our attention.\\nSome people overlook the fact that an open source project is still owned by someone even if it is free to use.\\nTo avoid any potential legal issues, what we did first was to make sure that we do not violate the license terms of the open-source software projects Armeria depends on.\\n\\nFor instance, we included all the license agreement files and their summaries into our repository so that our users are informed about what software Armeria depends on.\\nWe also explicitly mentioned what portions of other open-source software have been modified and redistributed in Armeria.\\n\\nOn the other hand, Armeria is also an open source project with an owner, so we licensed it to its users under fair and clear terms as well.\\nWe chose [Apache License 2.0](<https://tldrlegal.com/license/apache-license-2.0-(apache-2.0)>) over other open source licenses because of the following notable features:\\n\\n- Software licensed under Apache License 2.0 may be freely used, reproduced, modified, distributed or sold without accompanying the corresponding source code.\\n- It contains a provision that states the conditions of the granting and infringement of patent licenses.\\n\\nAnother important thing people often miss out is the contributor license agreement (CLA) which is required when accepting an external contribution.\\nWhen someone outside your company sends a pull request for a very cool feature you feel like merging immediately, you\'d better make sure the submitter of the pull request has signed the contributor license agreement.\\nIt\'s outside the scope of this post to explain what exactly CLA is, but you can find detailed explanations on [OSS Watch](http://oss-watch.ac.uk/resources/cla) and [CLAHub](https://www.clahub.com/pages/why_cla).\\n\\nAll these steps are seemingly time-consuming and painful, but it wasn\'t anything like that in reality.\\nThey are mostly one-time things, and our friendly folks at the legal department freed us from the hassles of dealing with legal issues we would have had to deal with by ourselves otherwise.\\nWhen you are in doubt, just find your legal department; we are not lawyers!\\n\\n## Working with other open-source projects\\n\\nYou may sometimes find bugs in an open-source project you depend on.\\nSometimes it can be worked around, but sometimes it can\'t.\\nYou could keep the fix in your own fork of the project, but it\'s almost always better to propose a change upstream so that you do not need to maintain it by yourself indefinitely.\\nContributing upstream also increases your visibility to the open-source scene and you will find yourself having fun collaborating with others, both of which are very positive to your career.\\n\\nWhile developing Armeria, we reported various issues and contributed some of their fixes to the [Netty](http://netty.io/) project:\\n\\n- HTTP/1 and 2\\n  - [#4785](https://github.com/netty/netty/pull/4785) - Fix missing trailing data on HTTP client upgrade\\n  - [#4582](https://github.com/netty/netty/pull/4582) - Revamp InboundHttp2ToHttpAdapter builder API\\n  - [#4574](https://github.com/netty/netty/pull/4574) - Revamp the Http2ConnectionHandler builder API\\n  - [#4525](https://github.com/netty/netty/pull/4525) - Fix the incorrect usage/value of \\"Connection: upgrade\\"\\n  - [#4524](https://github.com/netty/netty/pull/4524) - Fix IllegalReferenceCountException caused by HttpClientCodec.upgradeFrom()\\n  - [#4523](https://github.com/netty/netty/pull/4523) - Relax the sanity check in HttpClientUpgradeHandler\\n  - [#4428](https://github.com/netty/netty/pull/4428) - Reject the first SETTINGS ack on HTTP/2 Preface\\n  - [#4210](https://github.com/netty/netty/pull/4210) - Http2ConnectionHandler does not close the stream 1 (HTTP_UPGRADE_STREAM_ID)\\n  - [#3876](https://github.com/netty/netty/pull/3876) - Lazily instantiate HttpServerUpgradeHandler.UpgradeCodec\\n- DNS\\n  - [#4946](https://github.com/netty/netty/pull/4946) - Fix potential infinite loop when resolving CNAME records\\n  - [#4837](https://github.com/netty/netty/pull/4837) - Preserve the host name of address when parsing /etc/hosts file\\n  - [#4665](https://github.com/netty/netty/pull/4665) - Netty\'s DNS resolution should take into account system domain name\\n  - [#4541](https://github.com/netty/netty/pull/4541) - Don\'t cycle dns servers while cycling dns record types.\\n- Miscellaneous\\n  - [#4547](https://github.com/netty/netty/pull/4547) - NPE in PooledByteBufAllocator.newDirectBuffer()\\n  - [#4419](https://github.com/netty/netty/pull/4419) - Fix a bug where DefaultPromise.toString() says \\"incomplete\\" when it\'s done\\n\\nBy working closely with the projects Armeria depends on, we were able to reduce the burden of maintaining a fork and increase the visibility of Armeria itself and its project members in the open-source community.\\n\\n## Please join us!\\n\\nDid you find our story about contributing our work to the community and working with other projects interesting?\\nArmeria is still in its early stages, and we have various new features in our roadmap, such as:\\n\\n- Client-side load balancing\\n- Large content streaming via reactive streams\\n- Support for more protocols such as Redis and MySQL\\n- Integrated web-based administrative and monitoring console\\n- New Thrift compiler for better documentation and code generation\\n\\nWe also have a few more projects in our open-sourcing pipeline and we encourage our engineers to build something that could be useful to more people in the longer term rather than just serving our own immediate purpose.\\nPlease apply to join us in building something fascinating that could impress the world!\\n\\n[Job opening](http://recruit.linepluscorp.com/lineplus/career/detail/20000312) (Scroll down for English)\\n\\n## About the author\\n\\n[Trustin Lee](https://github.com/trustin) is a platform software engineer at LINE.\\nHe is also the founder of [Netty](http://netty.io/) and a co-founder of [Apache MINA](http://mina.apache.org/)."}]}}')}}]);