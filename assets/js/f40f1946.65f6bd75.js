"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[4075],{6354:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/monitoring-prometheus-metrics-from-armeria-7-14b9783a6a86ef8e9f99c0251d8c241e.png"},20571:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/monitoring-prometheus-metrics-from-armeria-6-4c5290f42ab658d351a7c297a4e7fdcb.png"},28453:(e,t,r)=>{r.d(t,{R:()=>o,x:()=>a});var n=r(96540);const s={},i=n.createContext(s);function o(e){const t=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),n.createElement(i.Provider,{value:t},e.children)}},38916:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/monitoring-prometheus-metrics-from-armeria-1-d761e7cf42bde79256e6b3acd7f73941.png"},42240:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/monitoring-prometheus-metrics-from-armeria-5-7ea539d66490a74cd206f210a73f0f84.png"},53159:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>m,frontMatter:()=>o,metadata:()=>n,toc:()=>l});var n=r(67099),s=r(74848),i=r(28453);const o={authors:["seunghwanjoo"],other_languages:{ko:"/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria"}},a="Monitoring Prometheus metrics from Armeria",c={authorsImageUrls:[void 0]},l=[{value:"Practice exercise",id:"practice-exercise",level:2},{value:"Configuring Gradle",id:"configuring-gradle",level:3},{value:"Installing and configuring Prometheus",id:"installing-and-configuring-prometheus",level:3},{value:"Installing and configuring Grafana",id:"installing-and-configuring-grafana",level:3},{value:"Test results",id:"test-results",level:3},{value:"Closing words",id:"closing-words",level:2}];function h(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(t.p,{children:["In this post, we'll be taking a look at how you can monitor ",(0,s.jsx)(t.a,{href:"https://prometheus.io/",children:"Prometheus"})," metrics collected with ",(0,s.jsx)(t.a,{href:"https://armeria.dev/",children:"Armeria"}),".\nFor those of you who are trying Armeria for the first time, I will be adding simple practice samples so that you can follow along."]}),"\n","\n",(0,s.jsx)(t.h2,{id:"practice-exercise",children:"Practice exercise"}),"\n",(0,s.jsxs)(t.p,{children:["The practice session was designed on macOS Big Sur.\nLet's now take a look at how you should install and configure Gradle, Prometheus, and ",(0,s.jsx)(t.a,{href:"https://grafana.com/",children:"Grafana"})," to run the samples, and see what the results are."]}),"\n",(0,s.jsx)(t.h3,{id:"configuring-gradle",children:"Configuring Gradle"}),"\n",(0,s.jsx)(t.p,{children:"I've defined the following dependencies on the 'build.gradle' file to collect the Prometheus metrics from the Armeria server."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-groovy",metastring:'title="build.gradle"',children:'dependencies {\n\n    // Armeria\n    implementation "com.linecorp.armeria:armeria:1.8.0"\n    implementation "com.linecorp.armeria:armeria-logback:1.8.0"\n\n    // Prometheus\n    implementation "io.micrometer:micrometer-registry-prometheus:1.7.0"\n\n    // ...\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["I've also prepared a simple REST API that responds to a ",(0,s.jsx)(t.code,{children:"/hello/{seq}"}),'GET request with "Success" or "Failure" for the purpose of our exercise.']}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",metastring:'title="MyAnnotatedService.java"',children:'public class MyAnnotatedService {\n\n    @Get("/hello/{seq}")\n    public HttpResponse hello(@Param("seq") int seq) {\n        if (seq % 3 == 0) {\n            return HttpResponse.of(HttpStatus.INTERNAL_SERVER_ERROR);\n        }\n        return HttpResponse.of(HttpStatus.OK, MediaType.PLAIN_TEXT_UTF_8, "Success");\n    }\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Below is the ",(0,s.jsx)(t.code,{children:"main()"})," function code for running an Armeria server"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",metastring:'title="ArmeriaPrometheusApplication.java"',children:'public class ArmeriaPrometheusApplication {\n\n    public static void main(String[] args) {\n        PrometheusMeterRegistry meterRegistry = new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);\n        Server server = Server\n                .builder()\n                .http(8083)\n                .meterRegistry(meterRegistry)\n                .annotatedService(new MyAnnotatedService())\n                .service("/metrics", PrometheusExpositionService.of(meterRegistry.getPrometheusRegistry()))\n                .decorator(MetricCollectingService.builder(MeterIdPrefixFunction.ofDefault("my.http.service"))\n                                                  .newDecorator())\n                .build();\n\n        CompletableFuture<Void> future = server.start();\n        future.join();\n    }\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["You must always add ",(0,s.jsx)(t.a,{href:"https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/MetricCollectingService.html",children:"MetricCollectingService"})," as a ",(0,s.jsx)(t.code,{children:"decorator"})," if you want to collect service metrics. (You can find more on how to do this in the ",(0,s.jsx)(t.a,{href:"https://armeria.dev/docs/advanced-metrics/",children:"official Armeria documentation"}),".).\nYou can customize the default prefix of the metrics by specifying the parameter of the ",(0,s.jsx)(t.code,{children:"MeterIdPrefixFunction.ofDefault()"})," function."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",metastring:'title="ArmeriaPrometheusApplication.java"',children:'.decorator(new MyAnnotatedService(),\n           MetricCollectingService.builder(MeterIdPrefixFunction.ofDefault("my.http.service"))\n                                  .newDecorator())\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Use ",(0,s.jsx)(t.a,{href:"https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/PrometheusExpositionService.html",children:"PrometheusExpositionService"})," to configure the path to output the Prometheus metrics."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",metastring:'title="ArmeriaPrometheusApplication.java"',children:'.service("/metrics", PrometheusExpositionService.of(meterRegistry.getPrometheusRegistry()))\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Send a request with the ",(0,s.jsx)(t.code,{children:"/hello"})," API to check if there is a proper response."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"$ curl http://localhost:8083/hello/1\nSuccess\n\n$ curl http://localhost:8083/hello/3\n500 Internal Server Error\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Also check if a request with the ",(0,s.jsx)(t.code,{children:"/metrics"}),"API properly returns the Prometheus metrics as a response."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:'$ curl -s http://localhost:8083/metrics | grep "my_http_service_requests_total"\n# HELP my_http_service_requests_total\n# TYPE my_http_service_requests_total counter\nmy_http_service_requests_total{hostname_pattern="*",http_status="500",method="hello",result="success",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0\nmy_http_service_requests_total{hostname_pattern="*",http_status="200",method="hello",result="failure",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0\nmy_http_service_requests_total{hostname_pattern="*",http_status="200",method="hello",result="success",service="com.example.armeria_prometheus.MyAnnotatedService",} 1.0\nmy_http_service_requests_total{hostname_pattern="*",http_status="500",method="hello",result="failure",service="com.example.armeria_prometheus.MyAnnotatedService",} 1.0\n'})}),"\n",(0,s.jsx)(t.h3,{id:"installing-and-configuring-prometheus",children:"Installing and configuring Prometheus"}),"\n",(0,s.jsxs)(t.p,{children:["First install Prometheus with the ",(0,s.jsx)(t.a,{href:"https://brew.sh/index_ko",children:"Homebrew"})," package manager."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"$ brew install prometheus\n"})}),"\n",(0,s.jsx)(t.p,{children:"When the installation process is finished, a file named 'prometheus.yml' is created.\nYou can use this YAML file to change Prometheus configurations."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"$ vi $(brew --prefix)/etc/prometheus.yml\n"})}),"\n",(0,s.jsx)(t.p,{children:"Carefully enter the paths and ports for collecting the Prometheus metrics in the configuration file."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-yaml",metastring:'title="prometheus.yml"',children:"global:\n  scrape_interval: 10s\n\nscrape_configs:\n  - job_name: 'armeria-prometheus'\n    metrics_path: '/metrics'\n    static_configs:\n      - targets: ['localhost:8083']\n"})}),"\n",(0,s.jsx)(t.p,{children:"Once you have made the changes, you must restart the Prometheus service to apply the changed settings."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"$ brew services start prometheus\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Prometheus uses the 9090 port by default.\nNavigate to ",(0,s.jsx)(t.a,{href:"http://localhost:9090/",children:"http://localhost:9090"})," on your browser and you will see the screen shown below."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:r(38916).A+"",width:"1024",height:"317"})}),"\n",(0,s.jsx)(t.p,{children:'Enter "Armeria" into the search field to check if the related metrics have been properly collected from the Prometheus server.'}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:r(93567).A+"",width:"1024",height:"388"})}),"\n",(0,s.jsxs)(t.p,{children:["Try sending multiple ",(0,s.jsx)(t.code,{children:"/hello/{seq}"})," API requests and see if the ",(0,s.jsx)(t.code,{children:"my_http_service_requests_total"})," metric properly increases."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:r(97238).A+"",width:"1024",height:"475"})}),"\n",(0,s.jsx)(t.h3,{id:"installing-and-configuring-grafana",children:"Installing and configuring Grafana"}),"\n",(0,s.jsx)(t.p,{children:"Install and run the Grafana service using Homebrew the same way you installed Prometheus."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"$ brew install grafana\n$ brew services start grafana\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Grafana uses the 3000 port by default.\nNavigate to ",(0,s.jsx)(t.a,{href:"http://localhost:3000/",children:"http://localhost:3000"})," on your browser and you will see the login screen shown below."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:r(97065).A+"",width:"1024",height:"528"})}),"\n",(0,s.jsxs)(t.p,{children:["Don't worry if you have never created an account.\nYou can enter 'admin' on both the ",(0,s.jsx)(t.strong,{children:"Email or username"})," and ",(0,s.jsx)(t.strong,{children:"Password"}),' field to log in.\nAs you can probably tell from the name, "admin" is a very basic account, and you will need to create a proper new account when you actually run the service in a real environment.']}),"\n",(0,s.jsxs)(t.p,{children:["Enter the path to Prometheus in the ",(0,s.jsx)(t.strong,{children:"Data Source"})," field to display the Prometheus metrics as a graph on Grafana."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:r(42240).A+"",width:"840",height:"411"})}),"\n",(0,s.jsxs)(t.p,{children:["Next, create a dashboard and then add a panel where you can monitor the number of successful and unsuccessful attempts of the ",(0,s.jsx)(t.code,{children:"/hello/{seq}"})," API."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:r(20571).A+"",width:"1024",height:"581"})}),"\n",(0,s.jsx)(t.p,{children:"The queries are as follows."}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["200: ",(0,s.jsx)(t.code,{children:'increase(my_http_service_requests_total{hostname_pattern="*", method="hello", http_status="200", result="success", service="com.example.armeria_prometheus.MyAnnotatedService"}[1m])'})]}),"\n",(0,s.jsxs)(t.li,{children:["500: ",(0,s.jsx)(t.code,{children:'increase(my_http_service_requests_total{hostname_pattern="*", method="hello", http_status="500", result="failure", service="com.example.armeria_prometheus.MyAnnotatedService"}[1m])'})]}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.code,{children:"armeria_server_requests_total"})," metric is a ",(0,s.jsx)(t.a,{href:"https://prometheus.io/docs/concepts/metric_types/#counter",children:"Counter"}),"-type metric that only continues to increase until you reset it.\nBecause of this, the cumulative amount of times the API call succeeded or failed doesn't provide much insight when monitoring in a real environment.\nWhat you should instead focus on, is how many times it either succeeded or failed in a given time frame .\nFor this purpose, you can use the ",(0,s.jsx)(t.a,{href:"https://prometheus.io/docs/prometheus/latest/querying/functions/#increase",children:"increase()"})," function to express the number of successful and unsuccessful attempts per minute as a graph."]}),"\n",(0,s.jsx)(t.h3,{id:"test-results",children:"Test results"}),"\n",(0,s.jsxs)(t.p,{children:["Let's now run the client code below to send 100 API requests. (We used Armeria's ",(0,s.jsx)(t.a,{href:"https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/WebClient.html",children:"WebClient"}),")"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-java",metastring:'title="HttpClientApplication.java"',children:'public class HttpClientApplication {\n\n    private static final Logger logger = LoggerFactory.getLogger(HttpClientApplication.class);\n\n    public static void main(String[] args) {\n        WebClient client = WebClient.of("http://localhost:8083/");\n        for (int i = 0; i < 100; i++) {\n            AggregatedHttpResponse res = client.get("/hello/" + i).aggregate().join();\n            logger.info(res.content(StandardCharsets.UTF_8));\n        }\n    }\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["You can see the results of calling the ",(0,s.jsx)(t.code,{children:"/hello/{seq}"})," API being expressed as a beautiful graph on Grafana."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{src:r(6354).A+"",width:"1024",height:"377"})}),"\n",(0,s.jsx)(t.h2,{id:"closing-words",children:"Closing words"}),"\n",(0,s.jsx)(t.p,{children:"In this post, we took a look at how you can monitor Prometheus metrics collected from running an Armeria server, using a Grafana dashboard.\nArmeria provides various features for collecting metrics, and in our next post we will take a look at how you can customize the metrics you collect from Armeria to your needs."})]})}function m(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},67099:e=>{e.exports=JSON.parse('{"permalink":"/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2021-07-09-monitoring-prometheus-metrics-from-armeria.mdx","source":"@site/src/content/blog/en/2021-07-09-monitoring-prometheus-metrics-from-armeria.mdx","title":"Monitoring Prometheus metrics from Armeria","description":"In this post, we\'ll be taking a look at how you can monitor Prometheus metrics collected with Armeria.","date":"2021-07-09T00:00:00.000Z","tags":[],"readingTime":5.47,"hasTruncateMarker":true,"authors":[{"name":"Seunghwan Joo","title":"Seunghwan is in charge of LINE OpenChat back-end development","imageURL":"/img/author-seunghwanjoo.jpeg","key":"seunghwanjoo","page":null}],"frontMatter":{"authors":["seunghwanjoo"],"other_languages":{"ko":"/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria"}},"unlisted":false,"prevItem":{"title":"Customizing Armeria metrics","permalink":"/blog/2021/08/04/customizing-armeria-metrics"},"nextItem":{"title":"Using Circuit Breakers with Armeria","permalink":"/blog/2020/07/08/circuit-breakers-armeria"}}')},93567:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/monitoring-prometheus-metrics-from-armeria-2-57ec3c55f86df941b1757ef46c971024.png"},97065:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/monitoring-prometheus-metrics-from-armeria-4-59a3e9308b0cfcf44a86c758be874099.png"},97238:(e,t,r)=>{r.d(t,{A:()=>n});const n=r.p+"assets/images/monitoring-prometheus-metrics-from-armeria-3-42f66c9e85883a24608a69d73ecc4c0b.png"}}]);