# Running a GraphQL service

<Tip>

Visit [armeria-examples](https://github.com/line/armeria-examples) to find a fully working example.

</Tip>

First, You need the `armeria-graphql` dependency:

<RequiredDependencies
  boms={[{ groupId: 'com.linecorp.armeria', artifactId: 'armeria-bom' }]}
  dependencies={[
    { groupId: 'com.linecorp.armeria', artifactId: 'armeria-graphql' },
  ]}
/>

<Tip>

Please note that this is entirely based on [graphql-java](https://www.graphql-java.com/).

</Tip>

- [GraphQL Java](https://www.graphql-java.com/) is the Java (server) implementation for GraphQL.
- This documentation shows how to serve a service made from GraphQL Java over HTTP.
- The main steps for creating a GraphQL service are:

## Defining schema

A schema which defines each field that can be queried or mutated and what types those fields are.
This schema defines one top level field (in the type Query): which returns the details of a User.

```graphql
type Query {
  user(id: ID): User
}

type User {
  id: ID
  name: String
}
```

Armeria provides a way to write an HTTP service using the GraphQL like this.

## Loading data

A [DataFetcher](https://javadoc.io/doc/com.graphql-java/graphql-java/latest/graphql/schema/DataFetcher.html) fetches data for one field while the query is executed.
The `UserDataFetcher` retrieves a user with a specific ID from a static map. This is made just for testing.

```java
import graphql.schema.DataFetcher;
import graphql.schema.DataFetchingEnvironment;

class UserDataFetcher implements DataFetcher<User> {

    private final Map<String, User> data = Map.of("1", new User("1", "hero"),
                                                  "2", new User("2", "human"),
                                                  "3", new User("3", "droid"));

    @Override
    public User get(DataFetchingEnvironment environment) throws Exception {
        final String id = environment.getArgument("id");
        return data.get(id);
    }
}
```

## Building `GraphqlService`
Once you've finished the implementation of the service, you need to build a <type://GraphqlService> using
a <type://GraphqlServiceBuilder> and add it to the <type://ServerBuilder>:

```java
import com.linecorp.armeria.server.Server;
import com.linecorp.armeria.server.ServerBuilder;

ServerBuilder sb = Server.builder();
...
sb.service("/graphql",
           GraphqlService.builder()
                         .runtimeWiring(c -> {
                            c.type("Query",
                                   typeWiring -> typeWiring.dataFetcher("user", new UserDataFetcher()));
                         })
                         .build());
...
Server server = sb.build();
server.start();
```

<Tip>

When writing <type://GraphqlService>, register the [DataFetcher](https://javadoc.io/doc/com.graphql-java/graphql-java/latest/graphql/schema/DataFetcher.html) that was written just before.

</Tip>

## Blocking service implementation

Armeria does not run service logic in a separate thread pool by default. If your service implementation
requires blocking, either run the individual blocking logic in a thread pool, set
<type://GraphqlServiceBuilder#useBlockingTaskExecutor(boolean)> so the above happens automatically for
all service methods and lifecycle callbacks.

```java
ServerBuilder sb = Server.builder();
sb.service("/graphql",
           GraphqlService.builder()
                         .runtimeWiring(c -> {
                            c.type("Query",
                                   typeWiring -> typeWiring.dataFetcher("user", new UserDataFetcher()));
                         })
                         // All service methods will be run within
                         // the blocking executor.
                         .useBlockingTaskExecutor(true)
                         .build());
```

<Tip>

Another way is to wrap the [DataFetcher](https://javadoc.io/doc/com.graphql-java/graphql-java/latest/graphql/schema/DataFetcher.html) in an [AsyncDataFetcher](https://javadoc.io/doc/com.graphql-java/graphql-java/latest/graphql/schema/AsyncDataFetcher.html).

</Tip>
