"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[5940],{28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var r=t(96540);const a={},i=r.createContext(a);function o(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),r.createElement(i.Provider,{value:n},e.children)}},43860:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>c,default:()=>d,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"advanced/athenz","title":"Athenz integration","description":"This document explains how to integrate Armeria with Athenz, a platform for service","source":"@site/src/content/docs/advanced/athenz.mdx","sourceDirName":"advanced","slug":"/advanced/athenz","permalink":"/docs/advanced/athenz","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site-new/src/content/docs/advanced/athenz.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"docsSidebar","previous":{"title":"SAML Single Sign-On","permalink":"/docs/advanced/saml"},"next":{"title":"Spring Boot integration","permalink":"/docs/advanced/spring-boot-integration"}}');var a=t(74848),i=t(28453);const o={},c="Athenz integration",s={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Creating a ZTS client",id:"creating-a-zts-client",level:2},{value:"Checking permissions with the AthenzService decorator",id:"checking-permissions-with-the-athenzservice-decorator",level:2},{value:"Checking permissions with the @RequiresAthenzRole annotation",id:"checking-permissions-with-the-requiresathenzrole-annotation",level:2},{value:"Obtaining athenz tokens with AthenzClient",id:"obtaining-athenz-tokens-with-athenzclient",level:2},{value:"Integrating with Spring Boot",id:"integrating-with-spring-boot",level:2}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components},{RequiredDependencies:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("RequiredDependencies",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"athenz-integration",children:"Athenz integration"})}),"\n",(0,a.jsxs)(n.p,{children:["This document explains how to integrate Armeria with ",(0,a.jsx)(n.a,{href:"https://www.athenz.io/",children:"Athenz"}),", a platform for service\nauthentication and authorization. It assumes that you have already configured an Athenz domain and installed\nthe necessary service identity certificates locally."]}),"\n",(0,a.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsx)(n.p,{children:"Add the following dependencies to your build.gradle file:"}),"\n",(0,a.jsx)(t,{boms:[{groupId:"com.linecorp.armeria",artifactId:"armeria-bom"}],dependencies:[{groupId:"com.linecorp.armeria",artifactId:"armeria-athenz"}]}),"\n",(0,a.jsx)(n.h2,{id:"creating-a-zts-client",children:"Creating a ZTS client"}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/athenz/ZtsBaseClient.html",children:"ZtsBaseClient"})," is a client used to interact with the ",(0,a.jsx)(n.a,{href:"https://athenz.github.io/athenz/system_view/#zts-authz-token-system",children:"Athenz ZTS (authZ Token System)"}),".\nIt is required to create ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/athenz/AthenzClient.html",children:"AthenzClient"})," and ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/AthenzService.html",children:"AthenzService"})," decorators.\nYou can create an instance of ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/athenz/ZtsBaseClient.html",children:"ZtsBaseClient"})," as follows:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'import com.linecorp.armeria.client.athenz.ZtsBaseClient;\nimport com.linecorp.armeria.client.athenz.ZtsBaseClientBuilder;\n\nZtsBaseClient ztsBaseClient =\n    ZtsBaseClient\n        .builder("https://athenz.example.com:8443/zts/v1")\n        // You need to specify your Athenz service key and certificate files.\n        .keyPair("/var/lib/athenz/service.key.pem",\n                 "/var/lib/athenz/service.cert.pem")\n        // Uncomment the following line to use a proxy.\n        // .proxyUri("http://my-proxy.example.com:8080")\n        .build();\n\n// ...\n\n// Close the client when it is no longer needed.\nztsBaseClient.close();\n'})}),"\n",(0,a.jsxs)(n.h2,{id:"checking-permissions-with-the-athenzservice-decorator",children:["Checking permissions with the ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/AthenzService.html",children:"AthenzService"})," decorator"]}),"\n",(0,a.jsxs)(n.p,{children:["You can enforce Athenz authorization on your services by applying the ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/AthenzService.html",children:"AthenzService"})," decorator.\nThis decorator intercepts incoming requests and validates the client's token against the configured Athenz policies."]}),"\n",(0,a.jsxs)(n.p,{children:["The code below configures a decorator for paths under ",(0,a.jsx)(n.code,{children:"/files"}),". It will only grant access to requests that\npresent a token with the specified ",(0,a.jsx)(n.code,{children:"action"}),' ("get") and ',(0,a.jsx)(n.code,{children:"resource"}),' ("files") for your Athenz domain.\nThe ',(0,a.jsx)(n.code,{children:"action"})," and ",(0,a.jsx)(n.code,{children:"resource"})," must correspond to an assertion you have configured in Athenz."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'import com.linecorp.armeria.server.Server;\nimport com.linecorp.armeria.server.ServerBuilder;\nimport com.linecorp.armeria.server.athenz.AthenzService;\nimport com.linecorp.armeria.server.athenz.AthenzPolicyConfig;\n\nServerBuilder serverBuilder = Server.builder();\nserverBuilder.decoratorUnder(\n    "/files",\n    AthenzService.builder(ztsBaseClient)\n                 .action("get")\n                 .resource("files")\n                 .policyConfig(new AthenzPolicyConfig("your-domain"))\n                 .newDecorator());\nserverBuilder.serviceUnder("/files", FileService.of(...));\n...\n'})}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/AthenzPolicyConfig.html",children:"AthenzPolicyConfig"})," object replaces the need for a ",(0,a.jsx)(n.code,{children:"zpu.conf"})," file. It allows the server to download\npolicy files directly at startup and perform authorization checks without relying on the ",(0,a.jsx)(n.a,{href:"https://athenz.github.io/athenz/setup_zpu/",children:(0,a.jsx)(n.code,{children:"zpu"})}),"\ncommand-line utility."]}),"\n",(0,a.jsx)(n.p,{children:"If you are only using the decorator for permission checks, this is all the configuration required to integrate Athenz with Armeria."}),"\n",(0,a.jsxs)(n.h2,{id:"checking-permissions-with-the-requiresathenzrole-annotation",children:["Checking permissions with the ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/RequiresAthenzRole.html",children:"@RequiresAthenzRole"})," annotation"]}),"\n",(0,a.jsxs)(n.p,{children:["As an alternative to programmatically applying decorators, you can use the ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/RequiresAthenzRole.html",children:"@RequiresAthenzRole"})," annotation\non service methods or classes for a more declarative approach."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'import com.linecorp.armeria.server.athenz.RequiresAthenzRole;\n\nclass MyService {\n    // Decorate the method with `@RequiresAthenzRole` to check the Athenz role.\n    @RequiresAthenzRole(resource = "user", action = "get")\n    @ProducesJson\n    @Get("/user")\n    public CompletableFuture<User> getUser() {\n        // ...\n    }\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["To enable this annotation, you must register an ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/AthenzServiceDecoratorFactory.html",children:"AthenzServiceDecoratorFactory"})," with the server.\nThis factory uses the ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/athenz/ZtsBaseClient.html",children:"ZtsBaseClient"})," to create the necessary decorators that enforce the roles specified\nin the annotations."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'import com.linecorp.armeria.common.DependencyInjector;\nimport com.linecorp.armeria.server.athenz.AthenzPolicyConfig;\nimport com.linecorp.armeria.server.athenz.AthenzServiceDecoratorFactory;\nimport com.linecorp.armeria.server.athenz.AthenzServiceDecoratorFactoryBuilder;\n\n// Create and register `AthenzServiceDecoratorFactory`.\nAthenzServiceDecoratorFactory athenzDecoratorFactory =\n  AthenzServiceDecoratorFactory\n    .builder(ztsBaseClient)\n    .policyConfig(new AthenzPolicyConfig("my-domain"))\n    .build();\n\nDependencyInjector di =\n  DependencyInjector.ofSingletons(athenzDecoratorFactory)\n                    .orElse(DependencyInjector.ofReflective());\nserverBuilder.dependencyInjector(di, true);\n'})}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/RequiresAthenzRole.html",children:"@RequiresAthenzRole"})," annotation can be applied not only to annotated services but also to methods in\nThrift and gRPC services."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'class UserGrpcServiceImpl extends UserGrpcServiceImplBase {\n  @RequiresAthenzRole(resource = "user", action = "get")\n  public void getUser(UserRequest request,\n                      StreamObserver<UserResponse> responseObserver) {\n    // ...\n  }\n}\n'})}),"\n",(0,a.jsxs)(n.h2,{id:"obtaining-athenz-tokens-with-athenzclient",children:["Obtaining athenz tokens with ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/athenz/AthenzClient.html",children:"AthenzClient"})]}),"\n",(0,a.jsxs)(n.p,{children:["To communicate with other Athenz-protected services, you can use the ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/athenz/AthenzClient.html",children:"AthenzClient"})," decorator.\nThis client automatically acquires an Athenz token from the ZTS, caches it, and attaches it to outgoing requests.\nIt also handles token refreshes before expiration, so you do not need to manage the token lifecycle yourself."]}),"\n",(0,a.jsxs)(n.p,{children:["To obtain an access token and send it in the ",(0,a.jsx)(n.code,{children:"Authorization"})," header, configure the decorator with ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/athenz/TokenType.html#ACCESS_TOKEN",children:"TokenType#ACCESS_TOKEN"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'import com.linecorp.armeria.client.athenz.AthenzClient;\nimport com.linecorp.armeria.common.athenz.TokenType;\n\nWebClient client =\n  WebClient\n    .builder("https://api.example.com/")\n    .decorator(AthenzClient.newDecorator(ztsBaseClient, "my-domain",\n                                         TokenType.ACCESS_TOKEN))\n    .build();\n\n// An Athenz access token is automatically acquired and set in the `Authorization` header.\nclient.get("/files");\n'})}),"\n",(0,a.jsxs)(n.p,{children:["To obtain a role token and send it in a role token header (e.g., Athenz-Role-Auth or Yahoo-Role-Auth), specify\n",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/athenz/TokenType.html#ATHENZ_ROLE_TOKEN",children:"TokenType#ATHENZ_ROLE_TOKEN"})," or ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/athenz/TokenType.html#YAHOO_ROLE_TOKEN",children:"TokenType#YAHOO_ROLE_TOKEN"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-java",children:'WebClient client =\nWebClient\n  .builder("https://api.example.com/")\n  .decorator(AthenzClient.newDecorator(ztsBaseClient, "my-domain",\n                                       TokenType.ATHENZ_ROLE_TOKEN))\n  .build();\n'})}),"\n",(0,a.jsx)(n.h2,{id:"integrating-with-spring-boot",children:"Integrating with Spring Boot"}),"\n",(0,a.jsxs)(n.p,{children:["If you are using Spring Boot, you can enable the ",(0,a.jsx)(n.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/athenz/RequiresAthenzRole.html",children:"@RequiresAthenzRole"})," annotation\nby configuring Athenz properties in ",(0,a.jsx)(n.code,{children:"application.yml"}),"."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"// in application.yml\narmeria:\n  athenz:\n    zts-uri: https://athenz.example.com:8443/zts/v1\n    domains: my-athenz-provider-domain\n    athenz-private-key: /path/to/athenz_private.pem\n    athenz-public-key: /path/to/athenz_public.pem\n"})}),"\n",(0,a.jsx)(n.admonition,{type:"tip",children:(0,a.jsxs)(n.p,{children:["Visit ",(0,a.jsx)(n.a,{href:"https://github.com/line/armeria/tree/main/examples/athenz",children:"athenz-example"})," to check out a fully working example."]})})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}}}]);