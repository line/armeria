"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[4126],{28453:(e,r,t)=>{t.d(r,{R:()=>o,x:()=>c});var i=t(96540);const n={},s=i.createContext(n);function o(e){const r=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:o(e.components),i.createElement(s.Provider,{value:r},e.children)}},33503:e=>{e.exports=JSON.parse('{"permalink":"/blog/2021/08/04/customizing-armeria-metrics","editUrl":"https://github.com/line/armeria/edit/main/site/src/content/blog/en/2021-08-04-customizing-armeria-metrics.mdx","source":"@site/src/content/blog/en/2021-08-04-customizing-armeria-metrics.mdx","title":"Customizing Armeria metrics","description":"In my last post, Monitoring Prometheus metrics from Armeria, we took a look at how you can monitor Armeria metrics using Grafana.","date":"2021-08-04T00:00:00.000Z","tags":[],"readingTime":5.91,"hasTruncateMarker":true,"authors":[{"name":"Seunghwan Joo","title":"Seunghwan is in charge of LINE OpenChat back-end development","imageURL":"/img/author-seunghwanjoo.jpeg","key":"seunghwanjoo","page":null}],"frontMatter":{"authors":["seunghwanjoo"],"other_languages":{"ko":"/blog/ko/2021/07/15/customizing-armeria-metrics"}},"unlisted":false,"nextItem":{"title":"Monitoring Prometheus metrics from Armeria","permalink":"/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria"}}')},61423:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>a,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var i=t(33503),n=t(74848),s=t(28453);const o={authors:["seunghwanjoo"],other_languages:{ko:"/blog/ko/2021/07/15/customizing-armeria-metrics"}},c="Customizing Armeria metrics",a={authorsImageUrls:[void 0]},l=[{value:"Customizing metrics prefixes using MeterIdPrefixFunction",id:"customizing-metrics-prefixes-using-meteridprefixfunction",level:2},{value:"Customizing HTTP API response success predicate",id:"customizing-http-api-response-success-predicate",level:2},{value:"Filtering metrics",id:"filtering-metrics",level:2},{value:"Collecting gRPC metrics",id:"collecting-grpc-metrics",level:2},{value:"Conclusion",id:"conclusion",level:2}];function m(e){const r={a:"a",blockquote:"blockquote",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(r.p,{children:["In my last post, ",(0,n.jsx)(r.a,{href:"/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria",children:"Monitoring Prometheus metrics from Armeria"}),", we took a look at how you can monitor Armeria metrics using Grafana.\nIn this post, I would like to show you how you can customize Armeria metrics to suit your needs."]}),"\n","\n",(0,n.jsxs)(r.blockquote,{children:["\n",(0,n.jsxs)(r.p,{children:["The sample code in this post uses the same sample code from ",(0,n.jsx)(r.a,{href:"/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria",children:"Monitoring Prometheus metrics from Armeria"}),"."]}),"\n"]}),"\n",(0,n.jsx)(r.h2,{id:"customizing-metrics-prefixes-using-meteridprefixfunction",children:"Customizing metrics prefixes using MeterIdPrefixFunction"}),"\n",(0,n.jsxs)(r.p,{children:["In the last post I mentioned that you can customize the default prefix appended to metrics by using the ",(0,n.jsx)(r.a,{href:"https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html#ofDefault(java.lang.String)",children:(0,n.jsx)(r.code,{children:"MeterIdPrefixFunction#ofDefault"})})," function.\nYou can further customize these prefixes by using the ",(0,n.jsx)(r.a,{href:"https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html#andThen(com.linecorp.armeria.common.metric.MeterIdPrefixFunctionCustomizer)",children:(0,n.jsx)(r.code,{children:"MeterIdPrefixFunction#andThen"})})," function."]}),"\n",(0,n.jsx)(r.p,{children:"Let's assume you want to add an HTTP method name as your prefix."}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:["AS-IS: ",(0,n.jsx)(r.code,{children:"my_http_service"})]}),"\n",(0,n.jsxs)(r.li,{children:["TO-BE: ",(0,n.jsx)(r.code,{children:"my_http_service_{HTTP method}"})]}),"\n"]}),"\n",(0,n.jsxs)(r.p,{children:["First you must generate a class that implements ",(0,n.jsx)(r.a,{href:"https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/metric/MeterIdPrefixFunctionCustomizer.html",children:(0,n.jsx)(r.code,{children:"MeterIdPrefixFunctionCustomizer"})}),".\nYou can add your HTTP method name to your existing ",(0,n.jsx)(r.code,{children:"MeterIdPrefix"})," in the ",(0,n.jsx)(r.code,{children:"MeterIdPrefixFunctionCustomizer#apply"})," function."]}),"\n",(0,n.jsxs)(r.p,{children:["While doing so, you can use ",(0,n.jsx)(r.a,{href:"https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/logging/RequestOnlyLog.html#requestHeaders()",children:(0,n.jsx)(r.code,{children:"RequestLog#requestHeaders"})})," to get the request's HTTP method name.\nVarious other information generated while processing a single request gets collected on ",(0,n.jsx)(r.a,{href:"https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/logging/RequestLog.html",children:(0,n.jsx)(r.code,{children:"RequestLog"})}),".\nFor more information about this, please refer to the ",(0,n.jsx)(r.a,{href:"https://armeria.dev/docs/advanced-structured-logging/",children:"Official Armeria documentation"}),"."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="MeterIdPrefixFunctionCustomizer.java"',children:"public class MyMeterIdPrefixFunction implements MeterIdPrefixFunctionCustomizer {\n\n    @Override\n    public MeterIdPrefix apply(MeterRegistry registry, RequestOnlyLog log, MeterIdPrefix meterIdPrefix) {\n        return meterIdPrefix.append(log.requestHeaders().method().name());\n    }\n}\n"})}),"\n",(0,n.jsxs)(r.p,{children:["Next we insert the class's instance using the ",(0,n.jsx)(r.a,{href:"https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html#andThen(com.linecorp.armeria.common.metric.MeterIdPrefixFunctionCustomizer)",children:(0,n.jsx)(r.code,{children:"MeterIdPrefixFunction#andThen"})})," function."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="ArmeriaPrometheusApplication.java"',children:'ServerBuilder sb = Server.builder();\n                         .http(8083)\n                         .meterRegistry(meterRegistry);\nsb.annotatedService(...);\nsb.service("/metrics", ...);\nsb.decorator(MetricCollectingService.builder(MeterIdPrefixFunction.ofDefault("my.http.service")\n                                                                  // add\n                                                                  .andThen(new MyMeterIdPrefixFunction()))\n                                                                  .newDecorator());\nServer server = sb.build();\n// ...\n'})}),"\n",(0,n.jsx)(r.p,{children:"After restarting the server, you can see that the HTTP method name has been appended to the front of your metrics."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'$ curl -s http://localhost:8083/metrics | grep "my_http_service_"\n# HELP my_http_service_GET_timeouts_total\n# TYPE my_http_service_GET_timeouts_total counter\nmy_http_service_GET_timeouts_total{cause="RequestTimeoutException",hostname_pattern="*",http_status="500",method="hello",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0\nmy_http_service_GET_timeouts_total{cause="RequestTimeoutException",hostname_pattern="*",http_status="200",method="hello",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0\n# HELP my_http_service_GET_active_requests\n# TYPE my_http_service_GET_active_requests gauge\nmy_http_service_GET_active_requests{hostname_pattern="*",method="hello",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0\n...\n'})}),"\n",(0,n.jsx)(r.p,{children:"For an alternative method of doing this, you can use lambda expressions that have been introduced in Java 8."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="ArmeriaPrometheusApplication.java"',children:'MeterIdPrefixFunction.ofDefault("my.http.service")\n                     .andThen((registry, log, prefix) -> prefix.append(log.requestHeaders().method().name())))\n'})}),"\n",(0,n.jsx)(r.h2,{id:"customizing-http-api-response-success-predicate",children:"Customizing HTTP API response success predicate"}),"\n",(0,n.jsxs)(r.p,{children:["Armeria's default settings are set to recognize HTTP API response status codes smaller than 100 or larger than 400 as failures.\nHowever, you can use ",(0,n.jsx)(r.code,{children:"MetricCollectingServiceBuilder#successFunction"})," to customize this predicate."]}),"\n",(0,n.jsx)(r.p,{children:"Let's assume the API has received a 404 status code response."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="MyAnnotatedService.java"',children:'public class MyAnnotatedService {\n\n    @Get("/hello/{seq}")\n    public HttpResponse hello(@Param("seq") int seq) {\n        if (seq % 5 == 0) {\n            return HttpResponse.of(HttpStatus.NOT_FOUND);\n        }\n        // ...\n    }\n}\n'})}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'$ curl http://localhost:8083/hello/5\n404 Not Found\n\n$ curl -s http://localhost:8083/metrics | grep "my_http_service_GET_requests_total" | grep "404"\nmy_http_service_GET_requests_total{hostname_pattern="*",http_status="404",method="hello",result="success",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0\nmy_http_service_GET_requests_total{hostname_pattern="*",http_status="404",method="hello",result="failure",service="com.example.armeria_prometheus.MyAnnotatedService",} 1.0\n'})}),"\n",(0,n.jsxs)(r.p,{children:["If you wish to change a 404 status code from a failure to a success, get the HTTP status from ",(0,n.jsx)(r.a,{href:"https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/logging/RequestLog.html#responseHeaders()",children:(0,n.jsx)(r.code,{children:"RequestLog#responseHeaders"})})," and implement ",(0,n.jsx)(r.a,{href:"https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/MetricCollectingServiceBuilder.html#successFunction(java.util.function.BiPredicate)",children:(0,n.jsx)(r.code,{children:"MetricCollectingServiceBuilder#successFunction"})})," as follows."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="ArmeriaPrometheusApplication.java"',children:'// ...\nsb.decorator(MetricCollectingService.builder(MeterIdPrefixFunction.ofDefault("my.http.service")\n                                                                  .andThen(new MyMeterIdPrefixFunction()))\n                                     // add\n                                     .successFunction((context, log) -> {\n                                        final int statusCode = log.responseHeaders().status().code();\n                                        return (statusCode >= 200 && statusCode < 400) || statusCode == 404;\n                                     })\n                                     .newDecorator());\n// ...\n'})}),"\n",(0,n.jsx)(r.p,{children:"You can see that the test results below show the 404 status code response as a success."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'$ curl -s http://localhost:8083/metrics | grep "my_http_service_GET_requests_total" | grep "404"\nmy_http_service_GET_requests_total{hostname_pattern="*",http_status="404",method="hello",result="success",service="com.example.armeria_prometheus.MyAnnotatedService",} 1.0\nmy_http_service_GET_requests_total{hostname_pattern="*",http_status="404",method="hello",result="failure",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0\n'})}),"\n",(0,n.jsx)(r.h2,{id:"filtering-metrics",children:"Filtering metrics"}),"\n",(0,n.jsxs)(r.p,{children:["You can filter out unwanted metrics from your logs by using MeterFilter.\nFor example, if you wish to remove JVM metrics from your logs, configure ",(0,n.jsx)(r.a,{href:"https://www.javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/config/MeterFilter.html",children:(0,n.jsx)(r.code,{children:"MeterFilter"})})," as follows."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="ArmeriaPrometheusApplication.java"',children:'public static void main(String[] args) {\n        PrometheusMeterRegistry meterRegistry = new PrometheusMeterRegistry(PrometheusConfig.DEFAULT);\n        meterRegistry.config()\n                     .meterFilter(MeterFilter.denyNameStartsWith("jvm"));\n        ServerBuilder sb = Server.builder();\n                                 .http(8083)\n                                 .meterRegistry(meterRegistry);\n        // ...\n'})}),"\n",(0,n.jsxs)(r.p,{children:["You can see that all ",(0,n.jsx)(r.code,{children:"jvm_"})," metrics have been removed."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'$ curl -s http://localhost:8083/metrics | grep "^jvm"\n'})}),"\n",(0,n.jsx)(r.h2,{id:"collecting-grpc-metrics",children:"Collecting gRPC metrics"}),"\n",(0,n.jsxs)(r.p,{children:["Using Armeria's ",(0,n.jsx)(r.a,{href:"https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/grpc/GrpcMeterIdPrefixFunction.html",children:(0,n.jsx)(r.code,{children:"GrpcMeterIdPrefixFunction"})}),", you can collect metrics related to ",(0,n.jsx)(r.a,{href:"https://grpc.github.io/grpc/core/md_doc_statuscodes.html",children:"gRPC status codes"}),".\nTo do this, add armeria-grpc to your dependencies as follows."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-groovy",metastring:'title="build.gradle"',children:'dependencies {\n\n    // Armeria\n    implementation "com.linecorp.armeria:armeria:1.8.0"\n    implementation "com.linecorp.armeria:armeria-logback:1.8.0"\n    implementation "com.linecorp.armeria:armeria-grpc:1.8.0" // add\n\n    // ...\n}\n'})}),"\n",(0,n.jsx)(r.p,{children:"For testing purposes, I've created a simple gRPC service as follows."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-protobuf",metastring:'title="hello.proto"',children:'syntax = "proto3";\n\npackage com.example.armeria_prometheus;\n\noption java_package = "com.example.armeria_prometheus.grpc";\n\nservice HelloService {\n  rpc Hello (HelloRequest) returns (HelloReply) {}\n}\n\nmessage HelloRequest {\n  int32 seq = 1;\n}\n\nmessage HelloReply {\n  string message = 1;\n}\n'})}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="MyGrpcService.java"',children:'public class MyGrpcService extends HelloServiceGrpc.HelloServiceImplBase {\n\n    @Override\n    public void hello(HelloRequest request, StreamObserver<HelloReply> responseObserver) {\n        if (request.getSeq() % 3 != 0) {\n            HelloReply reply = HelloReply.newBuilder()\n                                         .setMessage("Success")\n                                         .build();\n            responseObserver.onNext(reply);\n            responseObserver.onCompleted();\n            return;\n        }\n        responseObserver.onError(Status.INTERNAL.asException());\n    }\n}\n'})}),"\n",(0,n.jsxs)(r.p,{children:["I've added the gRPC service created above as a new service.\nIn order to prevent affecting existing HTTP metric collection, I've applied a ",(0,n.jsx)(r.a,{href:"https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/MetricCollectingService.html",children:(0,n.jsx)(r.code,{children:"MetricCollectingService"})})," decorator to each service."]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="ArmeriaPrometheusApplication.java"',children:'// ...\nsb.annotatedService(new MyAnnotatedService(),\n                    MetricCollectingService.builder(MeterIdPrefixFunction.ofDefault("my.http.service")\n                                                                          // ... \xec\x83\x9d\xeb\x9e\xb5 ...\nsb.service(GrpcService.builder()\n                      .addService(new MyGrpcService())\n                      .build(),\n           MetricCollectingService.newDecorator(GrpcMeterIdPrefixFunction.of("my.grpc.service")));\nsb.service("/metrics", PrometheusExpositionService.of(meterRegistry.getPrometheusRegistry()));\n// ...\n'})}),"\n",(0,n.jsx)(r.p,{children:"For easier testing, I've added client code that triggers multiple gRPC requests.\nWriting client code is also made easier when you're using Armeria."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-java",metastring:'title="RpcClientApplication.java"',children:'public class RpcClientApplication {\n\n    private static final Logger logger = LoggerFactory.getLogger(RpcClientApplication.class);\n\n    public static void main(String[] args) {\n        HelloServiceBlockingStub helloService = Clients\n                .newClient("gproto+http://127.0.0.1:8083/", HelloServiceBlockingStub.class);\n        for (int i = 0; i < 100; i++) {\n            try {\n                HelloRequest request = HelloRequest.newBuilder().setSeq(i).build();\n                HelloReply reply = helloService.hello(request);\n                logger.info(reply.getMessage());\n            } catch (Exception e) {\n                logger.error("Error", e);\n            }\n        }\n    }\n}\n'})}),"\n",(0,n.jsx)(r.p,{children:"Restart your server and run the client code."}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{children:'$ curl -s http://localhost:8083/metrics | grep "my_grpc_service_requests_total"\n# HELP my_grpc_service_requests_total\n# TYPE my_grpc_service_requests_total counter\nmy_grpc_service_requests_total{grpc_status="13",hostname_pattern="*",http_status="200",method="Hello",result="success",service="com.example.armeria_prometheus.HelloService",} 0.0\nmy_grpc_service_requests_total{grpc_status="13",hostname_pattern="*",http_status="200",method="Hello",result="failure",service="com.example.armeria_prometheus.HelloService",} 34.0\nmy_grpc_service_requests_total{grpc_status="0",hostname_pattern="*",http_status="200",method="Hello",result="failure",service="com.example.armeria_prometheus.HelloService",} 0.0\nmy_grpc_service_requests_total{grpc_status="0",hostname_pattern="*",http_status="200",method="Hello",result="success",service="com.example.armeria_prometheus.HelloService",} 66.0\n'})}),"\n",(0,n.jsxs)(r.p,{children:["You can see that the ",(0,n.jsx)(r.a,{href:"https://grpc.github.io/grpc/core/md_doc_statuscodes.html",children:"gRPC status code"})," metrics are collected and displayed."]}),"\n",(0,n.jsx)(r.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,n.jsx)(r.p,{children:"Armeria also provides features that various users can use for collecting metrics.\nI hope many server engineers find these features useful and make their monitoring efforts more productive."})]})}function u(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(m,{...e})}):m(e)}}}]);