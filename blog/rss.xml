<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Armeria Blog</title>
        <link>https://armeria.dev/blog</link>
        <description></description>
        <lastBuildDate>Wed, 04 Aug 2021 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <copyright>© 2015-2025, LY Corporation</copyright>
        <item>
            <title><![CDATA[Customizing Armeria metrics]]></title>
            <link>https://armeria.dev/blog/2021/08/04/customizing-armeria-metrics</link>
            <guid>https://armeria.dev/blog/2021/08/04/customizing-armeria-metrics</guid>
            <pubDate>Wed, 04 Aug 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[In my last post, Monitoring Prometheus metrics from Armeria, we took a look at how you can monitor Armeria metrics using Grafana.]]></description>
            <content:encoded><![CDATA[<p>In my last post, <a class="" href="https://armeria.dev/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria">Monitoring Prometheus metrics from Armeria</a>, we took a look at how you can monitor Armeria metrics using Grafana.
In this post, I would like to show you how you can customize Armeria metrics to suit your needs.</p>
<!-- -->
<blockquote>
<p>The sample code in this post uses the same sample code from <a class="" href="https://armeria.dev/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria">Monitoring Prometheus metrics from Armeria</a>.</p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="customizing-metrics-prefixes-using-meteridprefixfunction">Customizing metrics prefixes using MeterIdPrefixFunction<a href="https://armeria.dev/blog/2021/08/04/customizing-armeria-metrics#customizing-metrics-prefixes-using-meteridprefixfunction" class="hash-link" aria-label="Direct link to Customizing metrics prefixes using MeterIdPrefixFunction" title="Direct link to Customizing metrics prefixes using MeterIdPrefixFunction" translate="no">​</a></h2>
<p>In the last post I mentioned that you can customize the default prefix appended to metrics by using the <a href="https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html#ofDefault(java.lang.String)" target="_blank" rel="noopener noreferrer" class=""><code>MeterIdPrefixFunction#ofDefault</code></a> function.
You can further customize these prefixes by using the <a href="https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html#andThen(com.linecorp.armeria.common.metric.MeterIdPrefixFunctionCustomizer)" target="_blank" rel="noopener noreferrer" class=""><code>MeterIdPrefixFunction#andThen</code></a> function.</p>
<p>Let's assume you want to add an HTTP method name as your prefix.</p>
<ul>
<li class="">AS-IS: <code>my_http_service</code></li>
<li class="">TO-BE: <code>my_http_service_{HTTP method}</code></li>
</ul>
<p>First you must generate a class that implements <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/metric/MeterIdPrefixFunctionCustomizer.html" target="_blank" rel="noopener noreferrer" class=""><code>MeterIdPrefixFunctionCustomizer</code></a>.
You can add your HTTP method name to your existing <code>MeterIdPrefix</code> in the <code>MeterIdPrefixFunctionCustomizer#apply</code> function.</p>
<p>While doing so, you can use <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/logging/RequestOnlyLog.html#requestHeaders()" target="_blank" rel="noopener noreferrer" class=""><code>RequestLog#requestHeaders</code></a> to get the request's HTTP method name.
Various other information generated while processing a single request gets collected on <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/logging/RequestLog.html" target="_blank" rel="noopener noreferrer" class=""><code>RequestLog</code></a>.
For more information about this, please refer to the <a href="https://armeria.dev/docs/advanced-structured-logging/" target="_blank" rel="noopener noreferrer" class="">Official Armeria documentation</a>.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">MeterIdPrefixFunctionCustomizer.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MyMeterIdPrefixFunction</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">MeterIdPrefixFunctionCustomizer</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">MeterIdPrefix</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterRegistry</span><span class="token plain"> registry</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">RequestOnlyLog</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">MeterIdPrefix</span><span class="token plain"> meterIdPrefix</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> meterIdPrefix</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">requestHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">method</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Next we insert the class's instance using the <a href="https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.html#andThen(com.linecorp.armeria.common.metric.MeterIdPrefixFunctionCustomizer)" target="_blank" rel="noopener noreferrer" class=""><code>MeterIdPrefixFunction#andThen</code></a> function.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">ServerBuilder</span><span class="token plain"> sb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">http</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8083</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">meterRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meterRegistry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">annotatedService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/metrics"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MetricCollectingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.http.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                  </span><span class="token comment" style="color:#999988;font-style:italic">// add</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">andThen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyMeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Server</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><br></span></code></pre></div></div>
<p>After restarting the server, you can see that the HTTP method name has been appended to the front of your metrics.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -s http://localhost:8083/metrics | grep "my_http_service_"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP my_http_service_GET_timeouts_total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE my_http_service_GET_timeouts_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_timeouts_total{cause="RequestTimeoutException",hostname_pattern="*",http_status="500",method="hello",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_timeouts_total{cause="RequestTimeoutException",hostname_pattern="*",http_status="200",method="hello",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP my_http_service_GET_active_requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE my_http_service_GET_active_requests gauge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_active_requests{hostname_pattern="*",method="hello",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre></div></div>
<p>For an alternative method of doing this, you can use lambda expressions that have been introduced in Java 8.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">MeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.http.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">andThen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">registry</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prefix</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> prefix</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">requestHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">method</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="customizing-http-api-response-success-predicate">Customizing HTTP API response success predicate<a href="https://armeria.dev/blog/2021/08/04/customizing-armeria-metrics#customizing-http-api-response-success-predicate" class="hash-link" aria-label="Direct link to Customizing HTTP API response success predicate" title="Direct link to Customizing HTTP API response success predicate" translate="no">​</a></h2>
<p>Armeria's default settings are set to recognize HTTP API response status codes smaller than 100 or larger than 400 as failures.
However, you can use <code>MetricCollectingServiceBuilder#successFunction</code> to customize this predicate.</p>
<p>Let's assume the API has received a 404 status code response.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">MyAnnotatedService.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MyAnnotatedService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/hello/{seq}"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"seq"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> seq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NOT_FOUND</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl http://localhost:8083/hello/5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">404 Not Found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -s http://localhost:8083/metrics | grep "my_http_service_GET_requests_total" | grep "404"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_requests_total{hostname_pattern="*",http_status="404",method="hello",result="success",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_requests_total{hostname_pattern="*",http_status="404",method="hello",result="failure",service="com.example.armeria_prometheus.MyAnnotatedService",} 1.0</span><br></span></code></pre></div></div>
<p>If you wish to change a 404 status code from a failure to a success, get the HTTP status from <a href="https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/logging/RequestLog.html#responseHeaders()" target="_blank" rel="noopener noreferrer" class=""><code>RequestLog#responseHeaders</code></a> and implement <a href="https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/MetricCollectingServiceBuilder.html#successFunction(java.util.function.BiPredicate)" target="_blank" rel="noopener noreferrer" class=""><code>MetricCollectingServiceBuilder#successFunction</code></a> as follows.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MetricCollectingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.http.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">andThen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyMeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token comment" style="color:#999988;font-style:italic">// add</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">successFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> statusCode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">responseHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">code</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">statusCode </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> statusCode </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">400</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> statusCode </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">404</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><br></span></code></pre></div></div>
<p>You can see that the test results below show the 404 status code response as a success.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -s http://localhost:8083/metrics | grep "my_http_service_GET_requests_total" | grep "404"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_requests_total{hostname_pattern="*",http_status="404",method="hello",result="success",service="com.example.armeria_prometheus.MyAnnotatedService",} 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_requests_total{hostname_pattern="*",http_status="404",method="hello",result="failure",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="filtering-metrics">Filtering metrics<a href="https://armeria.dev/blog/2021/08/04/customizing-armeria-metrics#filtering-metrics" class="hash-link" aria-label="Direct link to Filtering metrics" title="Direct link to Filtering metrics" translate="no">​</a></h2>
<p>You can filter out unwanted metrics from your logs by using MeterFilter.
For example, if you wish to remove JVM metrics from your logs, configure <a href="https://www.javadoc.io/doc/io.micrometer/micrometer-core/latest/io/micrometer/core/instrument/config/MeterFilter.html" target="_blank" rel="noopener noreferrer" class=""><code>MeterFilter</code></a> as follows.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">PrometheusMeterRegistry</span><span class="token plain"> meterRegistry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PrometheusMeterRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">PrometheusConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">DEFAULT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        meterRegistry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">meterFilter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterFilter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">denyNameStartsWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"jvm"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ServerBuilder</span><span class="token plain"> sb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">http</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8083</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">meterRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meterRegistry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><br></span></code></pre></div></div>
<p>You can see that all <code>jvm_</code> metrics have been removed.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -s http://localhost:8083/metrics | grep "^jvm"</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="collecting-grpc-metrics">Collecting gRPC metrics<a href="https://armeria.dev/blog/2021/08/04/customizing-armeria-metrics#collecting-grpc-metrics" class="hash-link" aria-label="Direct link to Collecting gRPC metrics" title="Direct link to Collecting gRPC metrics" translate="no">​</a></h2>
<p>Using Armeria's <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/grpc/GrpcMeterIdPrefixFunction.html" target="_blank" rel="noopener noreferrer" class=""><code>GrpcMeterIdPrefixFunction</code></a>, you can collect metrics related to <a href="https://grpc.github.io/grpc/core/md_doc_statuscodes.html" target="_blank" rel="noopener noreferrer" class="">gRPC status codes</a>.
To do this, add armeria-grpc to your dependencies as follows.</p>
<div class="language-groovy codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">build.gradle</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-groovy codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dependencies </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Armeria</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation </span><span class="token interpolation-string string" style="color:#e3116c">"com.linecorp.armeria:armeria:1.8.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation </span><span class="token interpolation-string string" style="color:#e3116c">"com.linecorp.armeria:armeria-logback:1.8.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation </span><span class="token interpolation-string string" style="color:#e3116c">"com.linecorp.armeria:armeria-grpc:1.8.0"</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// add</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>For testing purposes, I've created a simple gRPC service as follows.</p>
<div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">hello.proto</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">syntax</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"proto3"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> com</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">armeria_prometheus</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">option</span><span class="token plain"> java_package </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"com.example.armeria_prometheus.grpc"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">service</span><span class="token plain"> </span><span class="token class-name">HelloService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">rpc</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Hello</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HelloRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HelloReply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">message</span><span class="token plain"> </span><span class="token class-name">HelloRequest</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin">int32</span><span class="token plain"> seq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">message</span><span class="token plain"> </span><span class="token class-name">HelloReply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin">string</span><span class="token plain"> message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">MyGrpcService.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MyGrpcService</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">HelloServiceGrpc</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">HelloServiceImplBase</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HelloRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">StreamObserver</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">HelloReply</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> responseObserver</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSeq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">HelloReply</span><span class="token plain"> reply </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HelloReply</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Success"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            responseObserver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onNext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            responseObserver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onCompleted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        responseObserver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">INTERNAL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">asException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>I've added the gRPC service created above as a new service.
In order to prevent affecting existing HTTP metric collection, I've applied a <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/MetricCollectingService.html" target="_blank" rel="noopener noreferrer" class=""><code>MetricCollectingService</code></a> decorator to each service.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">annotatedService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyAnnotatedService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">MetricCollectingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.http.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                          </span><span class="token comment" style="color:#999988;font-style:italic">// ... ìëµ ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">GrpcService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyGrpcService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token class-name">MetricCollectingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">GrpcMeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.grpc.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/metrics"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">PrometheusExpositionService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meterRegistry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getPrometheusRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><br></span></code></pre></div></div>
<p>For easier testing, I've added client code that triggers multiple gRPC requests.
Writing client code is also made easier when you're using Armeria.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">RpcClientApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RpcClientApplication</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">Logger</span><span class="token plain"> logger </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">LoggerFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RpcClientApplication</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">HelloServiceBlockingStub</span><span class="token plain"> helloService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Clients</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gproto+http://127.0.0.1:8083/"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">HelloServiceBlockingStub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">HelloRequest</span><span class="token plain"> request </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HelloRequest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setSeq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">HelloReply</span><span class="token plain"> reply </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> helloService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hello</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reply</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Error"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Restart your server and run the client code.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -s http://localhost:8083/metrics | grep "my_grpc_service_requests_total"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP my_grpc_service_requests_total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE my_grpc_service_requests_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_grpc_service_requests_total{grpc_status="13",hostname_pattern="*",http_status="200",method="Hello",result="success",service="com.example.armeria_prometheus.HelloService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_grpc_service_requests_total{grpc_status="13",hostname_pattern="*",http_status="200",method="Hello",result="failure",service="com.example.armeria_prometheus.HelloService",} 34.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_grpc_service_requests_total{grpc_status="0",hostname_pattern="*",http_status="200",method="Hello",result="failure",service="com.example.armeria_prometheus.HelloService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_grpc_service_requests_total{grpc_status="0",hostname_pattern="*",http_status="200",method="Hello",result="success",service="com.example.armeria_prometheus.HelloService",} 66.0</span><br></span></code></pre></div></div>
<p>You can see that the <a href="https://grpc.github.io/grpc/core/md_doc_statuscodes.html" target="_blank" rel="noopener noreferrer" class="">gRPC status code</a> metrics are collected and displayed.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="https://armeria.dev/blog/2021/08/04/customizing-armeria-metrics#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h2>
<p>Armeria also provides features that various users can use for collecting metrics.
I hope many server engineers find these features useful and make their monitoring efforts more productive.</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Monitoring Prometheus metrics from Armeria]]></title>
            <link>https://armeria.dev/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria</link>
            <guid>https://armeria.dev/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria</guid>
            <pubDate>Fri, 09 Jul 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[In this post, we'll be taking a look at how you can monitor Prometheus metrics collected with Armeria.]]></description>
            <content:encoded><![CDATA[<p>In this post, we'll be taking a look at how you can monitor <a href="https://prometheus.io/" target="_blank" rel="noopener noreferrer" class="">Prometheus</a> metrics collected with <a href="https://armeria.dev/" target="_blank" rel="noopener noreferrer" class="">Armeria</a>.
For those of you who are trying Armeria for the first time, I will be adding simple practice samples so that you can follow along.</p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="practice-exercise">Practice exercise<a href="https://armeria.dev/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria#practice-exercise" class="hash-link" aria-label="Direct link to Practice exercise" title="Direct link to Practice exercise" translate="no">​</a></h2>
<p>The practice session was designed on macOS Big Sur.
Let's now take a look at how you should install and configure Gradle, Prometheus, and <a href="https://grafana.com/" target="_blank" rel="noopener noreferrer" class="">Grafana</a> to run the samples, and see what the results are.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuring-gradle">Configuring Gradle<a href="https://armeria.dev/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria#configuring-gradle" class="hash-link" aria-label="Direct link to Configuring Gradle" title="Direct link to Configuring Gradle" translate="no">​</a></h3>
<p>I've defined the following dependencies on the 'build.gradle' file to collect the Prometheus metrics from the Armeria server.</p>
<div class="language-groovy codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">build.gradle</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-groovy codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dependencies </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Armeria</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation </span><span class="token interpolation-string string" style="color:#e3116c">"com.linecorp.armeria:armeria:1.8.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation </span><span class="token interpolation-string string" style="color:#e3116c">"com.linecorp.armeria:armeria-logback:1.8.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Prometheus</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation </span><span class="token interpolation-string string" style="color:#e3116c">"io.micrometer:micrometer-registry-prometheus:1.7.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>I've also prepared a simple REST API that responds to a <code>/hello/{seq}</code>GET request with "Success" or "Failure" for the purpose of our exercise.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">MyAnnotatedService.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MyAnnotatedService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/hello/{seq}"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"seq"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> seq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">INTERNAL_SERVER_ERROR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">OK</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">MediaType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PLAIN_TEXT_UTF_8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Success"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Below is the <code>main()</code> function code for running an Armeria server</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ArmeriaPrometheusApplication</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">PrometheusMeterRegistry</span><span class="token plain"> meterRegistry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PrometheusMeterRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">PrometheusConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">DEFAULT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Server</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">http</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8083</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">meterRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meterRegistry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">annotatedService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyAnnotatedService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/metrics"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">PrometheusExpositionService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meterRegistry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getPrometheusRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MetricCollectingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.http.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CompletableFuture</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Void</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> future </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>You must always add <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/MetricCollectingService.html" target="_blank" rel="noopener noreferrer" class="">MetricCollectingService</a> as a <code>decorator</code> if you want to collect service metrics. (You can find more on how to do this in the <a href="https://armeria.dev/docs/advanced-metrics/" target="_blank" rel="noopener noreferrer" class="">official Armeria documentation</a>.).
You can customize the default prefix of the metrics by specifying the parameter of the <code>MeterIdPrefixFunction.ofDefault()</code> function.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyAnnotatedService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token class-name">MetricCollectingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.http.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Use <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/PrometheusExpositionService.html" target="_blank" rel="noopener noreferrer" class="">PrometheusExpositionService</a> to configure the path to output the Prometheus metrics.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/metrics"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">PrometheusExpositionService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meterRegistry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getPrometheusRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>Send a request with the <code>/hello</code> API to check if there is a proper response.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl http://localhost:8083/hello/1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ curl http://localhost:8083/hello/3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">500 Internal Server Error</span><br></span></code></pre></div></div>
<p>Also check if a request with the <code>/metrics</code>API properly returns the Prometheus metrics as a response.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -s http://localhost:8083/metrics | grep "my_http_service_requests_total"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP my_http_service_requests_total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE my_http_service_requests_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_requests_total{hostname_pattern="*",http_status="500",method="hello",result="success",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_requests_total{hostname_pattern="*",http_status="200",method="hello",result="failure",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_requests_total{hostname_pattern="*",http_status="200",method="hello",result="success",service="com.example.armeria_prometheus.MyAnnotatedService",} 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_requests_total{hostname_pattern="*",http_status="500",method="hello",result="failure",service="com.example.armeria_prometheus.MyAnnotatedService",} 1.0</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="installing-and-configuring-prometheus">Installing and configuring Prometheus<a href="https://armeria.dev/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria#installing-and-configuring-prometheus" class="hash-link" aria-label="Direct link to Installing and configuring Prometheus" title="Direct link to Installing and configuring Prometheus" translate="no">​</a></h3>
<p>First install Prometheus with the <a href="https://brew.sh/index_ko" target="_blank" rel="noopener noreferrer" class="">Homebrew</a> package manager.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew install prometheus</span><br></span></code></pre></div></div>
<p>When the installation process is finished, a file named 'prometheus.yml' is created.
You can use this YAML file to change Prometheus configurations.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vi $(brew --prefix)/etc/prometheus.yml</span><br></span></code></pre></div></div>
<p>Carefully enter the paths and ports for collecting the Prometheus metrics in the configuration file.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">prometheus.yml</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scrape_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">scrape_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'armeria-prometheus'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metrics_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/metrics'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'localhost:8083'</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>Once you have made the changes, you must restart the Prometheus service to apply the changed settings.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew services start prometheus</span><br></span></code></pre></div></div>
<p>Prometheus uses the 9090 port by default.
Navigate to <a href="http://localhost:9090/" target="_blank" rel="noopener noreferrer" class="">http://localhost:9090</a> on your browser and you will see the screen shown below.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-1-d761e7cf42bde79256e6b3acd7f73941.png" width="1024" height="317" class="img_ev3q"></p>
<p>Enter "Armeria" into the search field to check if the related metrics have been properly collected from the Prometheus server.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-2-57ec3c55f86df941b1757ef46c971024.png" width="1024" height="388" class="img_ev3q"></p>
<p>Try sending multiple <code>/hello/{seq}</code> API requests and see if the <code>my_http_service_requests_total</code> metric properly increases.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-3-42f66c9e85883a24608a69d73ecc4c0b.png" width="1024" height="475" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="installing-and-configuring-grafana">Installing and configuring Grafana<a href="https://armeria.dev/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria#installing-and-configuring-grafana" class="hash-link" aria-label="Direct link to Installing and configuring Grafana" title="Direct link to Installing and configuring Grafana" translate="no">​</a></h3>
<p>Install and run the Grafana service using Homebrew the same way you installed Prometheus.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew install grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ brew services start grafana</span><br></span></code></pre></div></div>
<p>Grafana uses the 3000 port by default.
Navigate to <a href="http://localhost:3000/" target="_blank" rel="noopener noreferrer" class="">http://localhost:3000</a> on your browser and you will see the login screen shown below.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-4-59a3e9308b0cfcf44a86c758be874099.png" width="1024" height="528" class="img_ev3q"></p>
<p>Don't worry if you have never created an account.
You can enter 'admin' on both the <strong>Email or username</strong> and <strong>Password</strong> field to log in.
As you can probably tell from the name, "admin" is a very basic account, and you will need to create a proper new account when you actually run the service in a real environment.</p>
<p>Enter the path to Prometheus in the <strong>Data Source</strong> field to display the Prometheus metrics as a graph on Grafana.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-5-7ea539d66490a74cd206f210a73f0f84.png" width="840" height="411" class="img_ev3q"></p>
<p>Next, create a dashboard and then add a panel where you can monitor the number of successful and unsuccessful attempts of the <code>/hello/{seq}</code> API.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-6-4c5290f42ab658d351a7c297a4e7fdcb.png" width="1024" height="581" class="img_ev3q"></p>
<p>The queries are as follows.</p>
<ul>
<li class="">200: <code>increase(my_http_service_requests_total{hostname_pattern="*", method="hello", http_status="200", result="success", service="com.example.armeria_prometheus.MyAnnotatedService"}[1m])</code></li>
<li class="">500: <code>increase(my_http_service_requests_total{hostname_pattern="*", method="hello", http_status="500", result="failure", service="com.example.armeria_prometheus.MyAnnotatedService"}[1m])</code></li>
</ul>
<p>The <code>armeria_server_requests_total</code> metric is a <a href="https://prometheus.io/docs/concepts/metric_types/#counter" target="_blank" rel="noopener noreferrer" class="">Counter</a>-type metric that only continues to increase until you reset it.
Because of this, the cumulative amount of times the API call succeeded or failed doesn't provide much insight when monitoring in a real environment.
What you should instead focus on, is how many times it either succeeded or failed in a given time frame .
For this purpose, you can use the <a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#increase" target="_blank" rel="noopener noreferrer" class="">increase()</a> function to express the number of successful and unsuccessful attempts per minute as a graph.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="test-results">Test results<a href="https://armeria.dev/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria#test-results" class="hash-link" aria-label="Direct link to Test results" title="Direct link to Test results" translate="no">​</a></h3>
<p>Let's now run the client code below to send 100 API requests. (We used Armeria's <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/WebClient.html" target="_blank" rel="noopener noreferrer" class="">WebClient</a>)</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">HttpClientApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">HttpClientApplication</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">Logger</span><span class="token plain"> logger </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">LoggerFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpClientApplication</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">WebClient</span><span class="token plain"> client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">WebClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"http://localhost:8083/"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">AggregatedHttpResponse</span><span class="token plain"> res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/hello/"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">aggregate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">content</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">UTF_8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>You can see the results of calling the <code>/hello/{seq}</code> API being expressed as a beautiful graph on Grafana.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-7-14b9783a6a86ef8e9f99c0251d8c241e.png" width="1024" height="377" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="closing-words">Closing words<a href="https://armeria.dev/blog/2021/07/09/monitoring-prometheus-metrics-from-armeria#closing-words" class="hash-link" aria-label="Direct link to Closing words" title="Direct link to Closing words" translate="no">​</a></h2>
<p>In this post, we took a look at how you can monitor Prometheus metrics collected from running an Armeria server, using a Grafana dashboard.
Armeria provides various features for collecting metrics, and in our next post we will take a look at how you can customize the metrics you collect from Armeria to your needs.</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Using Circuit Breakers with Armeria]]></title>
            <link>https://armeria.dev/blog/2020/07/08/circuit-breakers-armeria</link>
            <guid>https://armeria.dev/blog/2020/07/08/circuit-breakers-armeria</guid>
            <pubDate>Wed, 08 Jul 2020 00:00:00 GMT</pubDate>
            <description><![CDATA[What is a circuit breaker?]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-a-circuit-breaker">What is a circuit breaker?<a href="https://armeria.dev/blog/2020/07/08/circuit-breakers-armeria#what-is-a-circuit-breaker" class="hash-link" aria-label="Direct link to What is a circuit breaker?" title="Direct link to What is a circuit breaker?" translate="no">​</a></h2>
<p>Suppose an unexpected failure occurs (For example, a network issue or a server crash) and a remote server is unable to respond to the request.
If so, the client who made the request to the remote server will either wait for a response until a timeout occurs, consume resources, or eventually continue to send unnecessary requests.
And on a Microservice Architecture (MSA), this client can also be a server for other services.
In the end, clients of this server will have the same problem.</p>
<!-- -->
<p>This continuous propagation of failures results in the failure of one remote server having a significant impact on all systems.
The concept that emerged to solve this problem is known as the circuit breaker.</p>
<p>In other words, circuit breakers are a fast method of failing a request from a client to a remote server when the failure rate exceeds a certain threshold, self-diagnosing that there is a problem with the server, and no longer sending unnecessary requests.
Using circuit breakers allows us to avoid the aforementioned problems and minimize the size of failure.</p>
<p>You can read more about the concept of circuit breakers in this article previously posted on the blog: <a class="" href="https://armeria.dev/blog/2016/07/24/circuit-breakers-for-distributed-services">Circuit breakers for distributed services</a></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="status-of-a-circuit-breaker">Status of a circuit breaker<a href="https://armeria.dev/blog/2020/07/08/circuit-breakers-armeria#status-of-a-circuit-breaker" class="hash-link" aria-label="Direct link to Status of a circuit breaker" title="Direct link to Status of a circuit breaker" translate="no">​</a></h2>
<p>A circuit breaker can be in one of the following three states.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-1-f70bdace5b6c392763a6f834aac57203.png" width="1806" height="598" class="img_ev3q"></p>
<ul>
<li class=""><code>CLOSED</code>: The failure rate of the request is lower than the configured threshold. This is the initial and default state.</li>
<li class=""><code>OPEN</code>: The failure rate of the request is beyond the configured threshold. Errors occur immediately without sending the actual request (Fails fast).</li>
<li class=""><code>HALF_OPEN</code>: A status where the response is successful by sending a request once in the middle of the <code>OPEN</code> state. If successful, the state switches back to <code>CLOSED</code>. Upon failure, the state is left <code>OPEN</code>.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="armerias-circuit-breaker">Armeria's circuit breaker<a href="https://armeria.dev/blog/2020/07/08/circuit-breakers-armeria#armerias-circuit-breaker" class="hash-link" aria-label="Direct link to Armeria's circuit breaker" title="Direct link to Armeria's circuit breaker" translate="no">​</a></h2>
<p><a href="https://github.com/line/armeria" target="_blank" rel="noopener noreferrer" class="">Armeria</a> is an open-source asynchronous microservice framework based on <a href="https://netty.io/" target="_blank" rel="noopener noreferrer" class="">Netty</a> that is maintained by LINE engineers, which can implement and provide circuit breakers directly.
Let me show you how circuit breakers work with Armeria.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="preparation">Preparation<a href="https://armeria.dev/blog/2020/07/08/circuit-breakers-armeria#preparation" class="hash-link" aria-label="Direct link to Preparation" title="Direct link to Preparation" translate="no">​</a></h3>
<p>First, let's launch two simple servers (Server1, Server2) to send and receive requests.
Server1 sends a <code>/world</code> request to Server2 when a <code>/hello</code> request is received from the Client.
When you receive a response from Server2, you return the response back to the client.
Server1 is a server, but it is also a client of Server2.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-2-b3c58daca726cc29671eb155593a051c.png" width="840" height="234" class="img_ev3q"></p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="server2-implementation-code">Server2 implementation code<a href="https://armeria.dev/blog/2020/07/08/circuit-breakers-armeria#server2-implementation-code" class="hash-link" aria-label="Direct link to Server2 implementation code" title="Direct link to Server2 implementation code" translate="no">​</a></h4>
<p>First, here is the implementation of Server2 which will receive the response of Server1.
In response to requests coming into <code>/world</code>, success (200) and failure (500) are simply implemented to return.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Server2Application.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@SpringBootApplication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Server2Application</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">AtomicInteger</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">REQ_CNT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AtomicInteger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ServerBuilder</span><span class="token plain"> sb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">http</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5008</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">LoggingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/world"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">REQ_CNT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addAndGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">INTERNAL_SERVER_ERROR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Server</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CompletableFuture</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Void</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> future </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="server1-implementation-code">Server1 implementation code<a href="https://armeria.dev/blog/2020/07/08/circuit-breakers-armeria#server1-implementation-code" class="hash-link" aria-label="Direct link to Server1 implementation code" title="Direct link to Server1 implementation code" translate="no">​</a></h4>
<p>Here is the implementation of Server1.
Unlike the simple one using <code>ServerBuilder</code> on Server2, you can find the Service bean that receives requests from the client and the Client bean that sends requests to Server2.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Server1Application.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@SpringBootApplication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Import</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Server1Context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Server1Application</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">SpringApplication</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Server1Application</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Server1Context.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Server1Context</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">HttpServiceRegistrationBean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">httpService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">WebClient</span><span class="token plain"> webClient</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">HttpServiceRegistrationBean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> webClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/world"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setServiceName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"httpService"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Route</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/hello"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">methods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">GET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">WebClient</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">webClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CircuitBreakerStrategy</span><span class="token plain"> strategy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CircuitBreakerStrategy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onServerErrorStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// CircuitBreaker ì¤ì !!!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CircuitBreaker</span><span class="token plain"> circuitBreaker </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CircuitBreaker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"test-circuit-breaker"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">counterSlidingWindow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">circuitOpenWindow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">failureRateThreshold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">minimumRequestThreshold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">trialRequestInterval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">WebClient</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"http://localhost:5008"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">LoggingClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">CircuitBreakerHttpClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">circuitBreaker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strategy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Pay attention to the fact that a Client object has its own <code>CircuitBreaker</code> when you use <code>CircuitBreaker</code> in Armeria.
In other words, if a new Client object is created for each request to Server2 and is extinguished after the request is completed, the <code>CircuitBreaker</code> connected to the Client would eventually become useless.</p>
<p>Therefore, we need a <code>WebClient</code> bean that sends requests to Server2 to reuse the same <code>WebClient</code> object for the requests to all Server2.
And we can apply <code>CircuitBreaker</code> to the <code>WebClient</code> object using the <a href="https://armeria.dev/docs/client-decorator" target="_blank" rel="noopener noreferrer" class="">Decorator</a> provided by Armeria.</p>
<p>Let's take a look at each field of the <code>CircuitBreaker</code> settings above.</p>
<ul>
<li class=""><code>counterSlidingWindow</code> (10s): The time interval between measuring the number of successful/failed requests in <code>CircuitBreaker</code>. It is used to determine what state to transition or maintain based on a 10-second aggregate.</li>
<li class=""><code>circuitOpenWindow</code>(5s): The duration that <code>CircuitBreaker</code> is kept <code>OPEN</code>. Throws an error right away without asking the external server for 5 seconds once in an <code>OPEN</code> state (<code>FailFastException</code>).</li>
<li class=""><code>failureRateThreshold</code>(0.3): The rate of failure of the request required to switch to an <code>OPEN</code> state. Requests greater than 0.3 (30%) must fail during the <code>circuitOpenWindow</code> time to enter the <code>OPEN</code> state.</li>
<li class=""><code>minimumRequestThreshold</code>(5): Minimum number of requests required for measurement. Even if the failure rate is higher than <code>failureRateThreshold</code>, it must be the result of at least five requests before it becomes <code>OPEN</code>.</li>
<li class=""><code>trialRequestInterval</code>(s): Time to remain in the <code>HALF_OPEN</code> state. For 3 seconds, it throws a <code>FailFastException</code> error as it did when it was <code>OPEN</code>, while sending requests to external servers to check if the server returned to normal. If the response to the request sent in these 3 seconds is successful, it immediately switches to the <code>CLOSED</code> state; if all fails, it goes back to the <code>OPEN</code> state.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="testing">Testing<a href="https://armeria.dev/blog/2020/07/08/circuit-breakers-armeria#testing" class="hash-link" aria-label="Direct link to Testing" title="Direct link to Testing" translate="no">​</a></h3>
<p>Now let's send requests from the terminal to Server1 using the <a href="https://www.npmjs.com/package/loadtest" target="_blank" rel="noopener noreferrer" class="">loadtest</a> library.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ loadtest http://127.0.0.1:5007/hello --rps 1</span><br></span></code></pre></div></div>
<p>The log of Server1 provides information on the behavior of <code>CircuitBreaker</code>.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-3-07759276f457694ff964d39a17233647.png" width="2780" height="440" class="img_ev3q"></p>
<p>When the server first started, the initial state of <code>CircuitBreaker</code> was <code>CLOSED</code>.</p>
<p>At 03:03:41.830 - Of the total 5 requests measured, the number of failures was 2, so the failure rate was 2/5 = 0.4.
Thus, the failure rate was greater than the previously set failure rate of 0.3 (<code>failureRateThreshold</code>) and the number of requests used in the measurement was greater than 5 (<code>minimumRequestThreshold</code>), so <code>CircuitBreaker</code> switched to the <code>OPEN</code> state.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-4-a2545fecd5a4cb40a6c7f1e9bc606001.png" width="3160" height="378" class="img_ev3q"></p>
<p>From 03:03:41.830 to 03:03:47.824 - <code>FailFastException</code> errors continued to occur during subsequent periods, in approximately 5 seconds (<code>circuitOpenWindow</code>). (If you check the logs on Server2, you can see that the request was not received at that time.)</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-5-fb48c4e7a8981c1da7c2dc9413a94d2f.png" width="2562" height="448" class="img_ev3q"></p>
<p>At 03:03:47.824 - the transition is made to the <code>HALF_OPEN</code> state, where requests from clients were actually sent to Server2.
At this point, the transmitted request luckily received a 200 response and then <code>CircuitBreaker</code> switched to the <code>CLOSED</code> state.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-6-26bbfb46bbe9fbc038bbac6a0eb170c2.png" width="3164" height="146" class="img_ev3q"></p>
<p>This process is repeated again because it is <code>CLOSED</code> again.
From 03:03:47.827 to 03:03:56.824 - The failure rate was measured for approximately 10 seconds (<code>counterSlidingWindow</code>), and the failure rate measured this time was 4/8 = 0.5, so <code>CircuitBreaker</code> switched back to the <code>OPEN</code> state.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-7-d5c6d32d0e6c79a216971115d5a25552.png" width="3156" height="626" class="img_ev3q"></p>
<p>We've taken a look at Armeria's circuit breaker in action with the simple test above.
I hope you now have a better understanding of what the various configurations and operations are for, and how easy it is to implement a circuit breaker client for yourself.</p>
<blockquote>
<p>For more information on Armeria's circuit breakers, please take a look at the <a href="https://line.github.io/armeria/client-circuit-breaker.html" target="_blank" rel="noopener noreferrer" class="">official Armeria documentation on circuit breakers</a>.</p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="https://armeria.dev/blog/2020/07/08/circuit-breakers-armeria#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h2>
<p>Armeria provides several features useful to running an MSA in addition to circuit breakers.
These features include client-side load balancing and auto-retry.
We use Armeria ourselves in our own OpenChat server development, and are enjoying the many benefits its features bring to our daily work.
I dedicate this post to the open-source Armeria development team who are working day and night to make requested features a reality.</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Let's Play with Reactive Streams on Armeria - Part 2]]></title>
            <link>https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2</link>
            <guid>https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2</guid>
            <pubDate>Wed, 06 May 2020 11:00:00 GMT</pubDate>
            <description><![CDATA[In the first part of this blog post, we took a look at the basic concepts of Reactive Streams.]]></description>
            <content:encoded><![CDATA[<p>In the <a class="" href="https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1">first part of this blog post</a>, we took a look at the basic concepts of Reactive Streams.
In part 2 of this blog post, I'd like to tell you about how we use Reactive Streams with Armeria.</p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="whats-armeria">What’s Armeria?<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#whats-armeria" class="hash-link" aria-label="Direct link to What’s Armeria?" title="Direct link to What’s Armeria?" translate="no">​</a></h2>
<p>Armeria is an open-source asynchronous HTTP/2, RPC, REST client/server library based on Java 8, Netty, Thrift, and gRPC.
While Armeria is a lightweight microservices framework, its capabilities is comparable to existing full stack web frameworks.</p>
<p>Let's first take a look at some prerequisite knowledge for setting up a Reactive Streams server on Armeria.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="supported-protocols">Supported protocols<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#supported-protocols" class="hash-link" aria-label="Direct link to Supported protocols" title="Direct link to Supported protocols" translate="no">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-1-b8df78267813bd6db4a7146dc18e2f91.png" width="3030" height="1468" class="img_ev3q"></p>
<p>Armeria supports both HTTP/1 and HTTP/2, and these protocols both support <a href="https://simple.wikipedia.org/wiki/Cleartext" target="_blank" rel="noopener noreferrer" class="">cleartext</a> and TLS (Transport Layer Security) cryptographic protocols.
To ensure compatibility between HTTP/1 and HTTP/2, Armeria supports both HTTP/2's connection preface and HTTP/1's upgrade request.</p>
<p>Furthermore, gRPC and Thrift works with both HTTP/1 and HTTP/2 on Armeria.
This is a unique feature of Armeria. gRPC normally doesn't support HTTP/1 and Thrift normally doesn't support HTTP/2.
However, Armeria's wide array of support allows it to be used in a variety of business environments.
In Linux environments, Armeria supports JNI-based (Java Native Interface) socket IOs and BoringSSL-based TLS to allow better performance during production.</p>
<p>Let's take a closer look at Armeria along with some sample code.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="a-closer-look-at-armeria">A closer look at Armeria<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#a-closer-look-at-armeria" class="hash-link" aria-label="Direct link to A closer look at Armeria" title="Direct link to A closer look at Armeria" translate="no">​</a></h3>
<p>Armeria is a user-friendly API with simple and easy-to-use code.
You only need to write the following five lines if you want to run a "Hello world" server.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Build your own server under 5 lines.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var server = Server.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .http(8080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .service(“/“, (ctx, req) -&gt; HttpResponse.of(“Hello, World!”))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.start();</span><br></span></code></pre></div></div>
<p>The ability to easily run servers is a core feature for running separate business components on independent servers in a microservices environment.</p>
<p>Armeria also allows you to simplify server architecture.
You don't need to run <a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/sidecar" target="_blank" rel="noopener noreferrer" class="">sidecar patterns</a> such as Nginx or static web servers such as Apache httpd to use HTTPS or HTTP/2.
As mentioned, Armeria supports JNI-based socket IOs and BoringSSL in Linux environments, making it relatively less prone to performance impact.
You can also <a href="https://line.github.io/armeria/docs/server-http-file" target="_blank" rel="noopener noreferrer" class="">serve static files</a> such as JS, CSS, or images.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var server = Server.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .http(8080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .https(8443) // HTTPS support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .tlsSelfSigned()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .service(“/“, (ctx, req) -&gt; HttpResponse.of(“Hello, World!”))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.start();</span><br></span></code></pre></div></div>
<p>You no longer need to add network hops with Armeria, allowing you to reduce points of failure, use resources more efficiently, simplify architecture, monitor activity, and dynamically expand your servers.</p>
<p>There's even more.
Armeria comes with built-in annotation that lets you use its features even more easily.
For example, you can easily write routing code by setting <code>hello</code> as a prefix, and <code>name</code> as a path variable like the code below (For more information on using annotations, refer to <a href="https://armeria.dev/docs/server-annotated-service" target="_blank" rel="noopener noreferrer" class="">official Armeria documentation</a>).</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.annotation.Get;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.annotation.Param;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.annotation.PathPrefix;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Use built-in annotations for mapping path and parameter injection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@PathPrefix(“/hello”)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HelloService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   @Get(“/:name”)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public String hello(@Param String name) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       return String.format(“Hello, %s!”, name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Armeria also comes with special features that allow you to serve multiple RPC protocols simultaneously.
You can provide REST API, gRPC, and Thrift on a single server, allowing you to flexibly adapt to any business requirements or architecture changes.
The single port design enables you to efficiently use resources, minimize unnecessary exposure, and reduce potential maintenance costs. <a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#footnotes" class="">[1]</a></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var server = Server.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   .http(8080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   .service(“/hello/rest”, (ctx, req) -&gt; HttpResponse.of(“Hello, world!”))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   .service(“/hello/thrift”, THttpService.of(new ThriftHelloService()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   .service(“/hello/grpc”, GrpcService.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      .addService(new GrpcHelloService())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      .build())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   .build();</span><br></span></code></pre></div></div>
<p>Enterprise software developers would all agree that they've spent countless hours coming up with ways to efficiently process authentication and logging.
With Armeria, you can put those worries aside.
You can use a separate <a href="https://armeria.dev/docs/server-decorator" target="_blank" rel="noopener noreferrer" class="">decorator</a> to manage this <a href="https://en.wikipedia.org/wiki/Separation_of_concerns" target="_blank" rel="noopener noreferrer" class="">separation of concerns</a>.<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#footnotes" class="">[2]</a></p>
<p>If you wish to add an additional decorator, you can always manually implement and bind one to a specific path or service.
For example, <code>AuthService</code>in the figure below only calls the service when a <code>request</code> includes authentication info, and returns a "401 unauthorized" error if not.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-2-651dfe37d84cf70fa56b6314072fc869.png" width="3316" height="1652" class="img_ev3q"></p>
<p>Next, let's take a look at how Armeria works with Reactive Streams.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="http2-streams-inside-armeria">HTTP/2 streams inside Armeria<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#http2-streams-inside-armeria" class="hash-link" aria-label="Direct link to HTTP/2 streams inside Armeria" title="Direct link to HTTP/2 streams inside Armeria" translate="no">​</a></h3>
<p>As the name suggests, "streams" need to maintain a connection and let data constantly flow.
If there is only one opening while everywhere else is closed, it will lead to an overload.
Armeria uses the back pressure feature of Reactive Streams to dynamically control data flow inside servers.
Also, back pressure that utilizes <a href="https://tools.ietf.org/html/rfc7540#section-5.2" target="_blank" rel="noopener noreferrer" class="">HTTP/2 stream flow control</a> using <a href="https://http2.github.io/http2-spec/#WINDOW_UPDATE" target="_blank" rel="noopener noreferrer" class="">WINDOW_UPDATE</a> allows you to dynamically connect the Armeria server with your services and repositories from subnetwork layers.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-3-19c9d7f507f0cc7efb072673431792ff.png" width="3336" height="1792" class="img_ev3q"></p>
<p>If converting your service's server to an Armeria Reactive server is difficult at the moment, you could use an Armeria Reactive proxy server by following the sample code and <a href="https://github.com/line/armeria-examples/tree/master/proxy-server" target="_blank" rel="noopener noreferrer" class="">instructions available on the repository</a>.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Use Armeria’s async &amp; reactive HTTP/2 client.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var client = HttpClient.of(“h2c://backend”);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var server = Server.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .http(8080)          // Forward all requests reactively</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .service(“prefix:/“, (ctx, req) -&gt; client.execute(req))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .build();</span><br></span></code></pre></div></div>
<p>With an Armeria proxy server at the forefront, you can keep your server safe from any external threats on the internet.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-4-d1176606f39d7cc2951b0a21a74b80c6.png" width="2310" height="716" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="consolidating-reactive-streams-and-armeria">Consolidating Reactive Streams and Armeria<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#consolidating-reactive-streams-and-armeria" class="hash-link" aria-label="Direct link to Consolidating Reactive Streams and Armeria" title="Direct link to Consolidating Reactive Streams and Armeria" translate="no">​</a></h2>
<p>If you create an Armeria server with direct support of Reactive Streams, even more features are available to you.
Let's take a closer look at how you can use Reactive Streams on Armeria, and some details about the built-in publisher.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="armeria-http-response-publisher">Armeria HTTP response publisher<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#armeria-http-response-publisher" class="hash-link" aria-label="Direct link to Armeria HTTP response publisher" title="Direct link to Armeria HTTP response publisher" translate="no">​</a></h3>
<p>Responses on Armeria are comprised of <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpHeaders.html" target="_blank" rel="noopener noreferrer" class="">HttpHeaders</a> and <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpData.html" target="_blank" rel="noopener noreferrer" class="">HttpData</a>.
I will explain how you can convert an RxJava <a href="http://reactivex.io/RxJava/javadoc/io/reactivex/Observable.html" target="_blank" rel="noopener noreferrer" class="">Observable</a> to an Armeria <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/common/HttpResponse.html" target="_blank" rel="noopener noreferrer" class="">HttpResponse</a> step-by-step.</p>
<p>Once your data is ready, wrap <code>dataStream</code>with <code>HttpData</code> using the <code>Observable map</code> operator.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 1. Fetch data from Reactive Streams Publisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Observable&lt;String&gt; dataStream = Observable.just(“a”, “b”, “c”, “d”, “e”);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2. Convert string to Armeria HttpData</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Observable&lt;HttpData&gt; httpDataStream = dataStream.map(HttpData::ofUtf8);</span><br></span></code></pre></div></div>
<p>Once you have a confirmed response and a response header, combine it with the <code>httpDataStream</code> prepared above using the <code>concat</code> operator.
This will complete a connected stream from <code>HttpHeaders</code>to <code>HttpData</code>.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 3. Prepare response headers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ResponseHeaders httpHeaders = ResponseHeaders.of(HttpStatus.OK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 4. Concat http header and body stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Observable&lt;HttpObject&gt; responseStream = Observable.concat(Observable.just(httpHeaders), httpDataStream);</span><br></span></code></pre></div></div>
<p>Convert the completed stream to a Reactive Streams <a href="https://www.baeldung.com/rxjava-2-flowable" target="_blank" rel="noopener noreferrer" class="">Flowable</a> using the <code>Observable</code> <code>toFlowable</code> function, and wrap it with Armeria's <code>HttpResponse</code> to complete the conversion.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 5. Convert Observable to Armeria Response Stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HttpResponse response = HttpResponse.of(responseStream.toFlowable(BackpressureStrategy.BUFFER));</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="armerias-built-in-publisher">Armeria's built-in publisher<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#armerias-built-in-publisher" class="hash-link" aria-label="Direct link to Armeria's built-in publisher" title="Direct link to Armeria's built-in publisher" translate="no">​</a></h3>
<p>The steps above may seem too complicated or boring.
That's why Armeria provides a built-in publisher for <a href="https://tools.ietf.org/html/rfc7464" target="_blank" rel="noopener noreferrer" class="">JSON Text Sequences(RFC 7464)</a>, the standard way of sending stream data on the web, and <a href="https://en.wikipedia.org/wiki/Server-sent_events" target="_blank" rel="noopener noreferrer" class="">Server-sent events</a>, the HTML5 standard.
This publisher will allow you to send Reactive Streams on the web more easily.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Fetch data from Reactive Streams Publisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Publisher&lt;String&gt; dataStream = Flux.just(“a”, “b”, “c”, “d”, “e”);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Convert Publisher to JSON Text Sequences with Armeria HttpResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// with “application/json-seq” MIME type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HttpResponse httpResponse = JsonTextSequences.fromPublisher(dataStream);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Convert Publisher to Server-sent Events with Armeria HttpResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// with “text/event-stream” MIME type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HttpResponse httpResponse = ServerSentEvents</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .fromPublisher(dataStream, SeverSentEvent::ofData);</span><br></span></code></pre></div></div>
<p>RxJava consolidation support is available for those looking to use the built-in publisher even more easily.
Add the <code>@ProduceJsonSequence</code> annotation to the annotated service and return <code>Observable</code> for automatic conversion on Armeria to the protocols mentioned above.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import io.reactivex.Observable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.annotation.ProducesJsonSequences;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class RxJavaService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Get(“/json-streaming”)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Generate JSON Text Sequences</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ProducesJsonSequences</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Observable&lt;String&gt; json() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // Just return RxJava Observable!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Observable.just(“a”, “b”, “c”);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre></div></div>
<p>Encoding a JSON text string with 'JsonTextSequences' will add a separator and line feed to the beginning and end respectively.
Depending on the protocol, different operations are required when sending data through HTTP/1 or HTTP/2.
Armeria automatically finds the appropriate format according to the currently connected protocol.
JSON data is divided inside the <a href="https://http2.github.io/http2-spec/#DATA" target="_blank" rel="noopener noreferrer" class="">Data frame</a> for HTTP/2, and <a href="https://en.wikipedia.org/wiki/Chunked_transfer_encoding" target="_blank" rel="noopener noreferrer" class="">chunked transfer encoding</a> is used for HTTP/1.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-5-b047c88a956d6aea2e8163ea08fd3590.png" width="3278" height="1818" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="migrating-spring-webflux">Migrating Spring WebFlux<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#migrating-spring-webflux" class="hash-link" aria-label="Direct link to Migrating Spring WebFlux" title="Direct link to Migrating Spring WebFlux" translate="no">​</a></h2>
<p>Armeria supports various libraries and frameworks.
If you are already using <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" target="_blank" rel="noopener noreferrer" class="">Spring WebFlux</a> to use Reactive Streams, you only need to <a href="https://armeria.dev/docs/advanced-spring-webflux-integration" target="_blank" rel="noopener noreferrer" class="">add</a><code>armeria-spring-boot-webflux-starter</code><a href="https://armeria.dev/docs/advanced-spring-webflux-integration" target="_blank" rel="noopener noreferrer" class="">to your dependencies</a> to complete migration to Armeria.
You can replace <a href="https://github.com/reactor/reactor-netty" target="_blank" rel="noopener noreferrer" class="">Reactor-Netty</a>, a WebFlux network layer, with Armeria's Reactive engine with this way.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-6-0408b3405e56818eebd1d7b8471bbc75.png" width="3120" height="1346" class="img_ev3q"></p>
<p>You may be thinking to yourself "Shouldn't I just use WebFlux if I only want to replace the engine?" What advantages are there to going through the process above?</p>
<p>You can add Armeria features to Spring with <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/spring/ArmeriaServerConfigurator.html" target="_blank" rel="noopener noreferrer" class="">ArmeriaServerConfigurator</a> if you replace your engine, allowing you to use unique Armeria features that aren't normally available on Spring.
For example, you can add gRPC and Thrift features to a REST API Spring WebFlux server, and serve it through the same single port.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ArmeriaConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Configure the server by providing an ArmeriaServerConfigurator bean.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public ArmeriaServerConfigurator armeriaServerConfigurator() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // Customize the server using the given ServerBuilder. For example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       return builder -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // Add DocService that enables you to send gRPC and Thrift requests from web browser.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           builder.serviceUnder(“/docs”, new DocService());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // Log every message which the server receives and responds.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           builder.decorator(LoggingService.newDecorator());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // Write access log after completing a request.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           builder.accessLogWriter(AccessLogWriter.combined(), false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // You can also bind asynchronous RPC services such as Thrift and gRPC:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           builder.service(THttpService.of(…));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           builder.service(GrpcService.builder()…build());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The decorator features mentioned above are also available, to make your service more feature-rich.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="support-for-grpc-streams">Support for gRPC streams<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#support-for-grpc-streams" class="hash-link" aria-label="Direct link to Support for gRPC streams" title="Direct link to Support for gRPC streams" translate="no">​</a></h2>
<p><a href="https://grpc.io/docs/tutorials/basic/java/#server-side-streaming-rpc" target="_blank" rel="noopener noreferrer" class="">gRPC supports streams</a> through <a href="https://grpc.github.io/grpc-java/javadoc/io/grpc/stub/StreamObserver.html" target="_blank" rel="noopener noreferrer" class="">StreamObserver</a>, and you can easily convert to gRPC's StreamObserver with Reactive Streams.
Let's take a look at the example below.</p>
<p>First, decide how to send and receive data using protobuf, and define your interface.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">syntax = “proto3”;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package users;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">option java_package = “users”;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service UserService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Returns all user information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rpc getAllUsers(UserRequest) returns (stream User) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Push to stream of users</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rpc pushToUsers(stream User) returns (Result) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>In order to send emails and push messages to all users, you must first look up the information of all users.
If there are too many users, it may be difficult to send the data at once.
In cases like this, you can build a stream server that returns large amounts of user information on gRPC by following the instructions below.</p>
<ol>
<li class="">Use ProjectReactor's <code>Flux</code>as a publisher to look up data on the repository in the format of a stream.</li>
<li class="">Convert to gRPC <code>StreamObservser</code> and send the data to an external location.</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Implement interfaces generated by gRPC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class UserServiceImpl extends UserServiceImplBase {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void getAllUsers(UserRequest request, StreamObserver&lt;User&gt; responseObserver) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Flux&lt;User&gt; userPublisher = userRepo.findAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.subscribe(responseObserver::onNext,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            responseObserver::onError,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            responseObserver::onCompleted);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><code>StreamObserver</code>, like Reactive Streams, has <code>onNext</code>, <code>onError</code>, <code>onCompleted</code> functions that can be matched and linked to APIs.</p>
<p>This time let's think how you would receive the data containing all user information.
For this demonstration I will be using <code>Processor</code>. <code>Processor</code> doesn't have separate API, and simply inherits <code>Subscriber</code>and <code>Publisher</code>.
You can use <code>Processor</code> to easily subscribe to data, and publish the subscribed data easily.
You can send new user info that was received through <code>StreamObserver's</code> <code>onNext using Processor's onNext</code> function, and can further perform additional tasks by resubscribing.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public StreamObserver&lt;User&gt; pushToUsers(StreamObserver&lt;Result&gt; responseObserver) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Processor&lt;User, User&gt; processor = EmitterProcessor.create();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Publisher&lt;User&gt; publisher = processor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Subscriber&lt;User&gt; subscriber = processor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Push one-by-one by subscribing publisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new StreamObserver&lt;User&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // subscribe user data â¨</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override public void onNext(User user) { processor.onNext(user); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override public void onError(Throwable throwable) { processor.onError(throwable); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override public void onCompleted() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            responseObserver.onNext(Result.newBuilder().setStatus(200).build());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            responseObserver.onCompleted();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Let's run the gRPC code that we wrote on Armeria.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.Server;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.grpc.GrpcService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Add your grpc service to Armeria GrpcService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var grpcService = GrpcService.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             .addService(new UserServiceImpl())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var server = Server.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   .http(8080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   .serviceUnder(“/grpc”, grpcService)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   .serviceUnder(“/docs”, new DocService())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   .build();</span><br></span></code></pre></div></div>
<p>With a stream server like this, you can stream large amounts of data using only a small amount of memory.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="armeria-features-for-microservices">Armeria features for microservices<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#armeria-features-for-microservices" class="hash-link" aria-label="Direct link to Armeria features for microservices" title="Direct link to Armeria features for microservices" translate="no">​</a></h2>
<p>Using Reactive Streams through Armeria allows you to easily handle large amounts of data and traffic.
RPC allows your microservices to communicate with each other more easily as well.</p>
<p>In addition, here are some more features catered towards microservices:</p>
<ul>
<li class="">Kubernetes-type DNS (Domain Name System) and <a href="https://armeria.dev/docs/advanced-zookeeper" target="_blank" rel="noopener noreferrer" class="">service discovery with ZooKeeper</a> for easily locating servers in a cloud environment.</li>
<li class="">Client-side load-distribution for searched services during communication with the server. Fewer points of failure.</li>
<li class="">Direct server diagnosis with non-<a href="https://www.nginx.com/resources/glossary/layer-7-load-balancing/" target="_blank" rel="noopener noreferrer" class="">L7</a> clients.</li>
<li class="">Automatic access logging to Kafka without the need to access distributed servers.</li>
<li class="">Easy transfer of metrics to application monitoring tools such as Netflix's Atlas and Prometheus through Micrometer's filters.</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-7-da8c2428f8f86f6212efef177ca57d88.png" width="3076" height="1428" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h2>
<p>Through parts 1 and 2 of this blog post, we took a look at Reactive Streams and Armeria.
Armeria allows you to build an asynchronous server that is safe, less prone to failure, and can harness the high performance of Reactive Streams, while also supporting RPC and HTTP/2.</p>
<p>The features mentioned in this blog post aren't everything there is to Armeria.
For more information on what Armeria can do for you, refer to the <a href="https://armeria.dev/" target="_blank" rel="noopener noreferrer" class="">official website</a> and the following sources.</p>
<ul>
<li class="">GitHub: <a href="https://github.com/line/armeria" target="_blank" rel="noopener noreferrer" class="">line/armeria</a></li>
<li class="">Twitter: <a href="https://twitter.com/armeria_project" target="_blank" rel="noopener noreferrer" class="">@armeria_project</a></li>
<li class="">Chat: <a href="https://armeria.dev/s/discord" target="_blank" rel="noopener noreferrer" class="">Discord</a></li>
<li class=""><a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/index.html" target="_blank" rel="noopener noreferrer" class="">API documentation</a>, <a href="https://armeria.dev/release-notes/" target="_blank" rel="noopener noreferrer" class="">release notes</a></li>
<li class="">Armeria examples: <a href="https://github.com/line/armeria-examples" target="_blank" rel="noopener noreferrer" class="">line/armeria-examples</a></li>
</ul>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="footnotes">Footnotes<a href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2#footnotes" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes" translate="no">​</a></h4>
<ol>
<li class="">Refer to <a href="https://armeria.dev/docs/server-grpc" target="_blank" rel="noopener noreferrer" class="">Running a gRPC service</a> and <a href="https://armeria.dev/docs/server-thrift" target="_blank" rel="noopener noreferrer" class="">Running a Thrift service</a>.</li>
<li class="">For more information on the various decorators provided with Armeria, refer to the Armeria and Javadoc official documentation.<!-- -->
<ul>
<li class=""><a href="https://armeria.dev/docs/server-decorator" target="_blank" rel="noopener noreferrer" class="">Decorating a service</a></li>
<li class=""><a href="https://armeria.dev/docs/client-decorator" target="_blank" rel="noopener noreferrer" class="">Decorating a client</a></li>
<li class="">Check Direct Known Subsclasses on <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/SimpleDecoratingHttpService.html" target="_blank" rel="noopener noreferrer" class="">SimpleDecoratingHttpService</a> and <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/SimpleDecoratingClient.html" target="_blank" rel="noopener noreferrer" class="">SimpleDecoratingClient</a></li>
</ul>
</li>
</ol>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Let's Play with Reactive Streams on Armeria - Part 1]]></title>
            <link>https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1</link>
            <guid>https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1</guid>
            <pubDate>Wed, 06 May 2020 10:00:00 GMT</pubDate>
            <description><![CDATA[What is Reactive Streams?]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-reactive-streams">What is Reactive Streams?<a href="https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1#what-is-reactive-streams" class="hash-link" aria-label="Direct link to What is Reactive Streams?" title="Direct link to What is Reactive Streams?" translate="no">​</a></h2>
<p>In this post, I'd like to introduce the basic concept of Reactive Streams, and how to use Reactive Streams with Armeria, the open-source asynchronous HTTP/2, RPC, REST client/server library.
Let's begin by examining what Reactive Streams is.</p>
<p>The <a href="http://reactive-streams.org/" target="_blank" rel="noopener noreferrer" class="">official homepage of Reactive Streams</a> defines it as follows.</p>
<blockquote>
<p>Reactive Streams is a standard for asynchronous data processing in a streaming fashion with non-blocking back pressure.</p>
</blockquote>
<p>Let's take a closer look at what they mean by "processing in a streaming fashion," "asynchronous," "back pressure," and "standard."</p>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="stream-processing">Stream processing<a href="https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1#stream-processing" class="hash-link" aria-label="Direct link to Stream processing" title="Direct link to Stream processing" translate="no">​</a></h3>
<p>The figure below compares traditional data processing against stream processing.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-1-2f25791f2d6557baebc7d095eda17c7d.png" width="3342" height="1882" class="img_ev3q"></p>
<p>The traditional method of data processing depicted on the left requires the payload to be stored on an application's memory once there is a data processing request.
Any additional data that may be required must also be looked up and stored on memory.
The problem with this method is that all data that is received or looked up must all be stored on the application's memory in order to generate a response message.
If the size of the required data is larger than the available memory, an "out of memory" error will occur.
Even if a single request doesn't cause an "out of memory" error, there are many instances while operating a service where there will be many requests coming in at once.
When there are multiple requests occurring simultaneously, it will trigger a large amount of GC (garbage collection) in a short amount of time, leading to the server failing to respond normally.</p>
<p>On the other hand, you can use the stream processing method to process large amounts of data even with a small amount of system memory.
With stream processing, you can create a pipeline that subscribes to any incoming data, processes the data, and then publishes it.
Server processing data with this method will be able to process large amounts of data elastically.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="asynchronous-method">Asynchronous method<a href="https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1#asynchronous-method" class="hash-link" aria-label="Direct link to Asynchronous method" title="Direct link to Asynchronous method" translate="no">​</a></h3>
<p>Let's compare the asynchronous method with the synchronous method.
The figure below depicts the processes of both methods.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-2-f4e515c6966123761077255924895887.png" width="3344" height="1876" class="img_ev3q"></p>
<p>In the synchronous method, a request sent by the client is blocked until the server sends a response.
Being "blocked" means that the current thread cannot perform another task and must wait.
If two requests are sent to servers A and B, the request must receive a response from server A before it can move on to server B.
However, with the asynchronous method, the current thread is not blocked and can perform other tasks while waiting for a response.
The thread can be used for other tasks after sending a request to server A, or send a separate request to server B.
The advantages of the asynchronous method compared to the synchronous method are as follows.</p>
<ul>
<li class="">Fast speed - You can get quicker response speeds by sending two requests simultaneously.</li>
<li class="">Less resources used - You can process more requests with less threads as threads can perform tasks in parallel without being blocked.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="back-pressure">Back pressure<a href="https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1#back-pressure" class="hash-link" aria-label="Direct link to Back pressure" title="Direct link to Back pressure" translate="no">​</a></h3>
<p>Before we go into more detail about "back pressure," let's take a look into the <a href="http://reactivex.io/documentation/observable.html" target="_blank" rel="noopener noreferrer" class="">observer patten</a>, push method, and pull method made famous by <a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener noreferrer" class="">RxJava</a>.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="push-method">Push method<a href="https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1#push-method" class="hash-link" aria-label="Direct link to Push method" title="Direct link to Push method" translate="no">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-3-f90a82d7c69e036ae62f224a2fff1c57.png" width="2040" height="1002" class="img_ev3q"></p>
<p>In an observer pattern, a publisher transfers data by pushing it to a subscriber.
A subscriber is not concerned with what state the subscriber is in, and is only concerned with transferring data.
If the publisher sends 100 messages in the span of 1 second, and the subscriber can only process 10 messages in 1 second, what will happen?
The subscriber will have to store the pending events in a queue.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-4-e144d9d9e9c035b0f776f6d81465a871.png" width="2656" height="1158" class="img_ev3q"></p>
<p>The amount of memory allotted to the server is limited.
If 100 messages per second is sent to the server, the buffer will fill up instantly.
What would happen if the buffer runs out and causes an overflow?
Let's see what would happen to a static buffer and a variable-length buffer.</p>
<ul>
<li class="">Static buffer: Newly received messages are rejected. Rejected messages will send requests again, which will cause additional processing load on the network and CPU.</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-5-5271512498a52243394d8a9ba2e15c3a.png" width="2684" height="1358" class="img_ev3q"></p>
<ul>
<li class="">Variable-length buffer: The server will crash with an "out of memory" error while trying to store the events. While you might think "who would make it like this?", the data structure of Java <code>list</code>s are variable-length. For example, when querying for a large amount of data with SQL, DBMS is the publisher and your servers become subscribers. When your servers attempt to store all the data in a <code>list</code> data structure, it will trigger a large amount of GC, preventing your server from responding normally.</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-6-93355b83286fefdd6b5dac13f0e5957a.png" width="2694" height="1328" class="img_ev3q"></p>
<p>How can we solve this problem?
Could we solve it by having the publisher only send an amount of messages that the subscriber can handle?
This is the fundamental workings behind back pressure.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="pull-method">Pull method<a href="https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1#pull-method" class="hash-link" aria-label="Direct link to Pull method" title="Direct link to Pull method" translate="no">​</a></h4>
<p>With the pull method, a subscriber that can process 10 operations at a time will only request 10 operations to the publisher.
The publisher can then send the requested amount, and the subscriber is safe from any "out of memory" errors.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-7-23bbdc8de88d80bfb99c448b495dcbcd.png" width="2558" height="1082" class="img_ev3q"></p>
<p>Furthermore, if the same subscriber is currently processing 8 operations, it can request 2 more operations so that the number of messages do not exceed the limits of what it can process.
With the pull method, subscribers have the freedom to choose the size of the data they receive.
The method that allows subscribers to dynamically pull data requests within their capacity is what back pressure is.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="standardization">Standardization<a href="https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1#standardization" class="hash-link" aria-label="Direct link to Standardization" title="Direct link to Standardization" translate="no">​</a></h3>
<p>Reactive Streams is a standardized API.
Here we'll talk about why standardization was necessary and how it became standardized.</p>
<p>Development for Reactive Streams first started in 2013 by engineers from Netflix, Pivotal, and Lightbend.
Netflix is responsible for the development of RxJava, Pivotal for WebFlux, and Lightbend for Akka, an implemntation of distributed processing actor models.
What these companies had in common was that they all required streaming APIs.
However streams are only meaningful if they combine and flow organically.
For data to flow uninterrupted, these different companies needed to use shared specifications, or in other words, they needed standardization.</p>
<p>During April, 2015, Reactive Streams has released its <a href="https://www.reactive-streams.org/announce-1.0.0" target="_blank" rel="noopener noreferrer" class="">1.0.0</a> specifications that can be used on JVM.
In September, 2017, Java 9 added <a href="https://docs.oracle.com/javase/9/docs/api/java/util/concurrent/Flow.html" target="_blank" rel="noopener noreferrer" class="">Flow API</a>, which includes the API, specs, and pull method of Reactive Streams and packaged it under <code>java.util.concurrent</code>.
Reactive Streams, which was a shared effort between community members and a few companies, has been officially recognized and added as an official part of Java.
Three months later, Reactive Streams released an adapter that is compatible with Flow, allowing existing libraries to be used.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-8-d9ff99c821b42b8a7ed40882fcd3f69e.png" width="3318" height="1846" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="reactive-streams-api">Reactive Streams API<a href="https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1#reactive-streams-api" class="hash-link" aria-label="Direct link to Reactive Streams API" title="Direct link to Reactive Streams API" translate="no">​</a></h2>
<p>Reactive Streams may look complex and daunting on the surface, but its internals are made up of a combination of simple APIs.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Publisher&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void subscribe(Subscriber&lt;? super T&gt; s);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface Subscriber&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void onSubscribe(Subscription s);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void onNext(T t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void onError(Throwable t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void onComplete();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface Subscription {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void request(long n);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void cancel();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>Publishers</code> only have a <code>subscribe</code> API that allows <code>subscribers</code> to subscribe.</li>
<li class=""><code>Subscribers</code> have <code>onNext</code> for processing received data, <code>onError</code> for processing errors, <code>onComplete</code> for completing tasks, and <code>onSubscribe</code> API for subscribing with parameters.</li>
<li class="">For <code>subscription</code>, there is a <code>request</code> API for requesting data and a <code>cancel</code> API for cancelling subscriptions.</li>
</ul>
<p>Now let's take a look at how the API above is used in Reactive Streams.</p>
<ol>
<li class="">A <code>subscriber</code> uses the <code>subscribe</code> function to request a subscription to the <code>publisher</code>.</li>
<li class="">The <code>publisher</code> uses the <code>onSubscribe</code> function to send the <code>subscription</code> to the <code>subscriber</code>.</li>
</ol>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-9-17e45a561c31ba0d7cc7c5e6846d91fa.png" width="3332" height="1860" class="img_ev3q"></p>
<ol start="3">
<li class="">The <code>subscription</code> now acts as a medium between a <code>subscriber</code> and <code>publisher</code>. <code>Subscribers</code> do not directly request data from <code>publishers</code>. Requests are sent to <code>publishers</code> using the <code>request</code> function of the <code>subscription</code>.</li>
<li class="">The <code>publisher</code>, using <code>subscription</code>, sends data with <code>onNext</code>, <code>onComplete</code> for completed tasks, and <code>onError</code> for errors.</li>
<li class="">The <code>subscriber</code>, <code>publisher</code>, and <code>subscription</code> all form an organic connection, communicating with each other; starting from <code>subscribe</code> all the way to <code>onComplete</code>. This completes the back pressure structure.</li>
</ol>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-10-ed725f58b4ed0796a63fd72e5956a7b2.png" width="3328" height="1866" class="img_ev3q"></p>
<p>So back pressure seems useful, but how do you actually use it?
The interface you see above is all of Reactive Streams API available on its official <a href="https://github.com/reactive-streams/reactive-streams-jvm/tree/master/api/src/main/java/org/reactivestreams" target="_blank" rel="noopener noreferrer" class="">GitHub repo</a>.
There isn't a separate implementation that you can use.</p>
<p>Then can you implement it by yourself?
You can in fact implement a <code>publisher</code> interface and generate a <code>subscription</code> using the rules above.
However, this is not all.
Reactive Streams comes with its own <a href="https://github.com/reactive-streams/reactive-streams-jvm#specification" target="_blank" rel="noopener noreferrer" class="">specifications</a>, and unlike a simple interface, these specifications present rules that must be followed during implementation.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-11-297565955f64bff427a1d12928ce5fc3.png" width="2866" height="1582" class="img_ev3q"></p>
<p>Once you follow the specifications and have an implementation, you can validate it using a tool called <a href="https://github.com/reactive-streams/reactive-streams-jvm/tree/master/tck" target="_blank" rel="noopener noreferrer" class="">Reactive Streams TCK</a>.
Unless you're a skilled expert in the field, it's difficult to have an implementation that satisfies all of the given rules.
The <code>publisher</code> in particular is especially difficult to implement.
For example, here's an <a href="https://github.com/reactor/reactor-core/issues/482" target="_blank" rel="noopener noreferrer" class="">issue</a> posted on the GitHub repo of <a href="https://projectreactor.io/" target="_blank" rel="noopener noreferrer" class="">Project Reactor</a>, one of the more well known Reactive Streams implementations.
The user in question is having difficulty in connecting their <code>publisher</code> to Flux.
The reply from Project Reactor was basically "don't." In my opinion, it's okay to do something like this in a pet project for study purposes.
You should not, however, use unverified code in an actual service.
Instead, you should create a <code>publisher</code> using a constructor function such as <code>Flux.create()</code>.
It's better off to use an existing, validated implementation when using Reactive Streams, rather than creating one yourself.
So what are some implementations that you could use?</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="reactive-streams-implementations-and-interoperability">Reactive Streams implementations and interoperability<a href="https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1#reactive-streams-implementations-and-interoperability" class="hash-link" aria-label="Direct link to Reactive Streams implementations and interoperability" title="Direct link to Reactive Streams implementations and interoperability" translate="no">​</a></h2>
<p>There are <a href="https://en.wikipedia.org/wiki/Reactive_Streams#Adoption" target="_blank" rel="noopener noreferrer" class="">various Reactive Streams implementations</a> that you can use.
Each implementation has its own quirks and characteristics, so you should find one that fits your needs.</p>
<ul>
<li class="">If you only need stream computing processing you could use <a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener noreferrer" class="">RxJava</a>, <a href="https://github.com/reactor/reactor-core" target="_blank" rel="noopener noreferrer" class="">Reactor Core</a>, or <a href="https://doc.akka.io/docs/akka/current/stream/index.html" target="_blank" rel="noopener noreferrer" class="">Akka Streams</a>.</li>
<li class="">If you want to look up data in repositories using Reactive Streams, you could use <a href="http://reactivemongo.org/" target="_blank" rel="noopener noreferrer" class="">ReactiveMongo</a> or <a href="http://scala-slick.org/" target="_blank" rel="noopener noreferrer" class="">Slick</a>.</li>
<li class="">If you need something connected to web programming you could use <a href="https://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a>, <a href="https://vertx.io/" target="_blank" rel="noopener noreferrer" class="">Vert.x</a>, <a href="https://www.playframework.com/" target="_blank" rel="noopener noreferrer" class="">Play Framework</a>, or <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux" target="_blank" rel="noopener noreferrer" class="">Spring WebFlux</a>.</li>
</ul>
<p>All these different implementations can communicate each other through Reactive Streams.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="interoperating-reactive-streams">Interoperating Reactive Streams<a href="https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1#interoperating-reactive-streams" class="hash-link" aria-label="Direct link to Interoperating Reactive Streams" title="Direct link to Interoperating Reactive Streams" translate="no">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-12-d033d15e15c32b4597b72cf8fc3bc910.png" width="3204" height="1398" class="img_ev3q"></p>
<p><code>Observable</code> in RxJava can be converted to Aremeria's <code>HttpResponse</code> or Project Reactor's <code>Flux</code> through Reactive Streams.
MongoDB's <code>DataPublisher</code> can stream compute through Akka Streams' <code>Source</code>.</p>
<p>For example, let's say you're looking up data and computing on MongoDB and then sending it as an HTTP response.
Using Reactive Streams to look up data on MongoDB will return publishers that can be subscribed to.
Unless a subscriber sends a request through a subscription, any actual data is not transferred.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Initiate MongoDB FindPublisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FindPublisher&lt;Document&gt; mongoDBUsers = mongodbCollection.find();</span><br></span></code></pre></div></div>
<p>As you can see in the code below, using <code>Observable's fromPublisher</code>, you can connect to <code>MongoDB's FindPublisher</code>.
Using the <code>map</code> operator allows you to extract the <code>age</code> field from the results.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// MongoDB FindPublisher -&gt; RxJava Observable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Observable&lt;Integer&gt; rxJavaAllAges =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Observable.fromPublisher(mongoDBUsers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .map(document -&gt; document.getInteger(“age”));</span><br></span></code></pre></div></div>
<p>Since <code>RxJava's Observable</code> is implemented in an observer pattern, converting it for Reactive Streams requires the use of the <code>toFlowable</code> function as you can see in the code below.
After the conversion, you can connect <code>RxJava's Flowable</code> and <code>Flux</code> using the <code>from</code> function.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// RxJava Observable -&gt; Reactor Flux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flux&lt;HttpData&gt; fluxHttpData =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Flux.from(rxJavaAllAges.toFlowable(BackpressureStrategy.DROP))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .map(age -&gt; HttpData.ofAscii(age.toString()));</span><br></span></code></pre></div></div>
<p>To use Flux data structure in HTTP responses, you must append an HTTP header to the front of the data.
You can then call <code>HttpResponse.of</code> to connect it with Flux and then use it as an HTTP response for Armeria.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Reactor Flux -&gt; Armeria HttpResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HttpResponse.of(Flux.concat(httpHeaders, fluxHttpData));</span><br></span></code></pre></div></div>
<p>As previously mentioned, it's important to note that unlike typical <code>iterators</code>, any computing has not occurred yet in this process.
We have only illustrated how the data will be sent to the <code>subscriber</code>.
With Reactive Streams, data transfer must not begin until a <code>subscriber</code> specifically requests it.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="https://armeria.dev/blog/2020/05/06/reactive-streams-armeria-1#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h2>
<p>In this post, we took a look at Reactive Streams and its implementations, and how they interoperate.
You must use back pressure on HTTP requests on responses if you want to use Reactive Streams in web programming.
To achieve this you must be able to appropriately adapt to the traffic that flows in.
In the next post we will be looking at how we use Reactive Streams with Armeria to do this!</p>
<p><a class="" href="https://armeria.dev/blog/2020/07/03/reactive-streams-armeria-2">Let’s Play with Reactive Streams on Armeria – Part 2</a></p>
<p>The features mentioned in this blog post aren't everything there is to Armeria.
For more information on what Armeria can do for you, refer to the <a href="https://armeria.dev/" target="_blank" rel="noopener noreferrer" class="">official website</a> and the following sources.</p>
<ul>
<li class="">GitHub: <a href="https://github.com/line/armeria" target="_blank" rel="noopener noreferrer" class="">line/armeria</a></li>
<li class="">Twitter: <a href="https://twitter.com/armeria_project" target="_blank" rel="noopener noreferrer" class="">@armeria_project</a></li>
<li class="">Slack: <a href="https://armeria.dev/s/slack" target="_blank" rel="noopener noreferrer" class="">Armeria</a></li>
<li class=""><a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/index.html" target="_blank" rel="noopener noreferrer" class="">API documentation</a></li>
<li class="">Armeria examples: <a href="https://github.com/line/armeria-examples" target="_blank" rel="noopener noreferrer" class="">line/armeria-examples</a></li>
</ul>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Monitoring a Spring Boot app in Kubernetes - What I learned from Devoxx Belgium 2019]]></title>
            <link>https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019</link>
            <guid>https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019</guid>
            <pubDate>Mon, 23 Dec 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[This November, accompanied by 3 other members of the Shop team, I attended Devoxx Belgium 2019, held in Antwerp, Belgium - the birthplace of Devoxx and most populous city of Belgium.]]></description>
            <content:encoded><![CDATA[<p>This November, accompanied by 3 other members of the Shop team, I attended Devoxx Belgium 2019, held in Antwerp, Belgium - the birthplace of Devoxx and most populous city of Belgium.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-1-8e22983a2492a8731c34a80e445decc8.jpg" width="1024" height="682" class="img_ev3q"></p>
<!-- -->
<p><a href="https://en.wikipedia.org/wiki/Devoxx" target="_blank" rel="noopener noreferrer" class="">Devoxx</a> is a developer community conference series started in 2001 which quickly grew to become one of the largest vendor-independent Java conferences in the world.
Today, Devoxx conferences are also held in France, Poland, Ukraine, Morocco, and the UK.</p>
<p>Devoxx Belgium took place in "Kinepolis," one of the largest cinemas in Europe.
The speakers' video and slides were projected on the huge cinema screens in 4K using the available THX audio setup.
The view was great!</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-2-4530f6955b4607b56de009631379926e.jpg" width="1024" height="768" class="img_ev3q"> <img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-3-cebba6c5f750b3fb1e59c6d953ef9de0.jpg" width="1024" height="768" class="img_ev3q"> <img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-4-a9a269fb31331861032e096fc80bd0b2.jpg" width="768" height="1024" class="img_ev3q"></p>
<p>In this blog post, I'd like to present a small hands-on example on monitoring a Spring Boot application in Kubernetes using what I learned at Devoxx.
In particular, I'd like to talk about:</p>
<ul>
<li class="">Preparing a Spring Boot application</li>
<li class="">Installing Docker and Kubernetes</li>
<li class="">Building a Docker image</li>
<li class="">Deploying to Kubernetes</li>
<li class="">Monitoring our application inside Kubernetes</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="monitoring-example---spring-boot-application-in-kubernetes">Monitoring Example - Spring Boot application in Kubernetes<a href="https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019#monitoring-example---spring-boot-application-in-kubernetes" class="hash-link" aria-label="Direct link to Monitoring Example - Spring Boot application in Kubernetes" title="Direct link to Monitoring Example - Spring Boot application in Kubernetes" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-preparing-a-spring-boot-application">1. Preparing a Spring Boot application<a href="https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019#1-preparing-a-spring-boot-application" class="hash-link" aria-label="Direct link to 1. Preparing a Spring Boot application" title="Direct link to 1. Preparing a Spring Boot application" translate="no">​</a></h3>
<p>For this example, I'm going to use a sample "Hello World" Spring Boot application that uses <a href="https://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a>.
On the Shop team we use Armeria to develop high-performance asynchronous microservices that use HTTP/2 as a session layer protocol.
I want to use Armeria in this example to show how you can expose a custom metrics endpoint and have Prometheus pull metrics from it.
Examples on how to get started with Armeria are available on <a href="https://github.com/line/armeria-examples" target="_blank" rel="noopener noreferrer" class="">Armeria's GitHub repo</a>.
The source code for this example is on <a href="https://github.com/nirvanarsc/k8s-monitoring-sample" target="_blank" rel="noopener noreferrer" class="">GitHub</a>.
I've only tested the code on macOS.</p>
<p>I have set up a <a href="https://github.com/nirvanarsc/k8s-monitoring-sample/blob/master/src/main/java/com/github/nirvanarsc/k8s/monitoring/sample/service/GreetingService.java#L17" target="_blank" rel="noopener noreferrer" class="">gRPC Service</a> and an <a href="https://github.com/nirvanarsc/k8s-monitoring-sample/blob/master/src/main/java/com/github/nirvanarsc/k8s/monitoring/sample/service/SampleService.java#L11" target="_blank" rel="noopener noreferrer" class="">HTTP Service</a> which we can call by navigating to <code>/internal/docs</code>.
DocService is a single-page web application that comes out of the box with Armeria listing all of our services and allowing us to call test them.
More about it can be found on <a href="https://line.github.io/armeria/server-docservice.html" target="_blank" rel="noopener noreferrer" class="">Armeria's official documentation</a>.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-5-72863d1657c6923548295bdf10de5dba.png" width="1024" height="753" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-installing-docker--kubernetes">2. Installing Docker &amp; Kubernetes<a href="https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019#2-installing-docker--kubernetes" class="hash-link" aria-label="Direct link to 2. Installing Docker &amp; Kubernetes" title="Direct link to 2. Installing Docker &amp; Kubernetes" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="docker">Docker<a href="https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019#docker" class="hash-link" aria-label="Direct link to Docker" title="Direct link to Docker" translate="no">​</a></h4>
<p>Before we get started with Kubernetes, we need to install <a href="https://docs.docker.com/install/" target="_blank" rel="noopener noreferrer" class="">Docker</a>.
If you are just getting started with Docker, I found the official <a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener noreferrer" class="">quickstart guide</a> useful.
We're going to use a public registry to push our application image to, so please <a href="https://hub.docker.com/signup" target="_blank" rel="noopener noreferrer" class="">register</a> and login to Docker through the GUI or by running:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker login</span><br></span></code></pre></div></div>
<p>There seems to be some confusion online regarding the user name you should use when prompted to login.
Do not use your email!
Use the Docker ID you chose when signing up.
You can find your Docker ID in the upper right corner after logging in to <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer" class="">Docker Hub</a>.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-6-0e05f0c7e2d267e4fa64b2789b2d3ca9.png" width="1024" height="458" class="img_ev3q"></p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="kubernetes">Kubernetes<a href="https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019#kubernetes" class="hash-link" aria-label="Direct link to Kubernetes" title="Direct link to Kubernetes" translate="no">​</a></h4>
<p>Okay now let's install Kubernetes.
For this example, we're just going to enable Kubernetes inside Docker.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-7-1a01abcfce3208d0c00906f8e1305be5.png" width="1024" height="845" class="img_ev3q"></p>
<p>Alternatives to docker-desktop for running a local Kubernetes cluster include:</p>
<ul>
<li class=""><a href="https://github.com/kubernetes/minikube" target="_blank" rel="noopener noreferrer" class="">minikube</a></li>
<li class=""><a href="https://github.com/kubernetes-sigs/kind" target="_blank" rel="noopener noreferrer" class="">kind</a></li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-building-an-image">3. Building an Image<a href="https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019#3-building-an-image" class="hash-link" aria-label="Direct link to 3. Building an Image" title="Direct link to 3. Building an Image" translate="no">​</a></h3>
<p>If you've got this far you should be able to run:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl cluster-info</span><br></span></code></pre></div></div>
<p>and see something similar to the following:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Kubernetes master is running at https://kubernetes.docker.internal:6443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KubeDNS is running at https://kubernetes.docker.internal:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.</span><br></span></code></pre></div></div>
<p>So far so good.
Now let's build a docker image for our Spring Boot app.
All we need to do is write a Docker file and run a Docker daemon, while watching out for the best-practices for Docker.
Perhaps following the first part of this <a href="https://spring.io/guides/topicals/spring-boot-docker/" target="_blank" rel="noopener noreferrer" class="">guide</a>.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="jib">Jib<a href="https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019#jib" class="hash-link" aria-label="Direct link to Jib" title="Direct link to Jib" translate="no">​</a></h4>
<p>Or we can just jib it. <a href="https://github.com/GoogleContainerTools/jib" target="_blank" rel="noopener noreferrer" class="">Jib</a> is a tool developed by Google that helps you build Docker images for your Java applications without a Docker daemon - and without deep mastery of Docker best-practices.
All we need to do is to add the following to our build.gradle file.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">plugins {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id 'com.google.cloud.tools.jib' version '1.8.0'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jib.to.image = 'docker_id/image_name'</span><br></span></code></pre></div></div>
<p>In this example we're using a public docker registry but jib can be configured to upload images to a private registry.
More on that in <a href="https://github.com/GoogleContainerTools/jib/tree/master/jib-gradle-plugin#authentication-methods" target="_blank" rel="noopener noreferrer" class="">Jib's official documentation</a>.</p>
<p>After we have configured the jib plugin, building our Docker image is as simple as running:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./gradlew jib</span><br></span></code></pre></div></div>
<p>If all is well after logging in to <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer" class="">Docker Hub</a> you should see your image on top.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-8-df9a37f4de7dd4d36a83f18a48efe014.png" width="1024" height="522" class="img_ev3q"></p>
<p>The url for your image should be of the form <code>docker.io/docker_id/image_name</code></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-deploying-to-kubernetes">4. Deploying to Kubernetes<a href="https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019#4-deploying-to-kubernetes" class="hash-link" aria-label="Direct link to 4. Deploying to Kubernetes" title="Direct link to 4. Deploying to Kubernetes" translate="no">​</a></h3>
<p>Next, let's deploy our image to Kubernetes.
To do this, we need to write YAML configuration files, and as you can see in these tutorials from <a href="https://developer.ibm.com/tutorials/yaml-basics-and-usage-in-kubernetes/" target="_blank" rel="noopener noreferrer" class="">IBM</a> and <a href="https://www.mirantis.com/blog/introduction-to-yaml-creating-a-kubernetes-deployment/" target="_blank" rel="noopener noreferrer" class="">Mirantis</a>, writing even a basic .yaml file correctly can be a daunting task.
However, there is a very easy way to get started, which I found out at Ray Tsang's session <a href="https://www.youtube.com/watch?v=c16oOeTfFXM" target="_blank" rel="noopener noreferrer" class="">"Best Practices to Spring to Kubernetes Easier and Faster"</a> at Devoxx.
Instead of doing something like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create deployment my-app --image docker.io/nirvanarsc/my-app</span><br></span></code></pre></div></div>
<p>We should add the <code>--dry-run</code> option like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create deployment my-app --image docker.io/nirvanarsc/my-app --dry-run -oyaml</span><br></span></code></pre></div></div>
<p>Which will print the YAML configuration necessary for a Deployment with the specified image as follows.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creationTimestamp: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  strategy: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      creationTimestamp: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - image: docker.io/nirvanarsc/my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resources: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">status: {}</span><br></span></code></pre></div></div>
<p>The only thing I will modify here is to increase the replicas from 1 to 3. (Set the number of instances of our app to 3)<br>
<!-- -->In the exact same way, we can get an initial configuration for our service.
Running the following for example,</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create service clusterip my-app --tcp=8080:8080 --dry-run -oyaml</span><br></span></code></pre></div></div>
<p>prints this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creationTimestamp: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - name: 8080-8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    port: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    targetPort: 8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: ClusterIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">status:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  loadBalancer: {}</span><br></span></code></pre></div></div>
<p>Let's save both of these configuration to their own files.
Create a folder named "k8s" and execute:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create deployment my-app --image docker.io/nirvanarsc/my-app --dry-run -oyaml &gt; k8s/deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl create service clusterip my-app --tcp=8080:8080 --dry-run -oyaml &gt; k8s/service.yaml</span><br></span></code></pre></div></div>
<p>Now deploying our app is as simple as running:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f k8s</span><br></span></code></pre></div></div>
<p>To access our application we will need to allow external traffic into our Kubernetes cluster.</p>
<p>This article will not be addressing Ingress/LoadBalancer/NodePort.
Perhaps <a href="https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0" target="_blank" rel="noopener noreferrer" class="">this article on Medium</a> is a good overview on that subject.</p>
<p>Instead, we will just forward a local port to a port on the cluster like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl port-forward svc/my-app 8080:8080</span><br></span></code></pre></div></div>
<p>Now we can access our <code>internal/docs</code> endpoint and our <code>internal/metrics</code> endpoint at <code>http://localhost:8080</code>.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-9-72863d1657c6923548295bdf10de5dba.png" width="1024" height="753" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-10-8c715e5f0e93caec07cf919acc75c4a1.png" width="1024" height="522" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-monitoring-our-application-inside-kubernetes">5. Monitoring our application inside Kubernetes<a href="https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019#5-monitoring-our-application-inside-kubernetes" class="hash-link" aria-label="Direct link to 5. Monitoring our application inside Kubernetes" title="Direct link to 5. Monitoring our application inside Kubernetes" translate="no">​</a></h3>
<p>Finally, we can talk about monitoring.
First a few words about Prometheus and Grafana.</p>
<p>Prometheus is a monitoring and alerting system.
It was originally built by SoundCloud in 2012, but has since been open sourced and now is part of the CNCF.
It is inspired by Google's BorgMon - one of Google's internal monitoring technologies used to monitor services running on Borg.
Borg is Google's internal cluster scheduler, which in turn inspired Kubernetes.
So Prometheus and Kubernetes have both been inspired by complementary technologies inside Google.</p>
<p>Grafana is an open source analytics and monitoring system.
Prometheus and Grafana have become basically the de facto monitoring solution.
Grafana should not be confused with Kibana, which runs on top of Elasticsearch and is used to analyze log messages.
On the Shop team we also use Prometheus with Grafana as our monitoring solution.</p>
<p>It is possible to have an external instance of Prometheus discover and pull metrics from our Application inside Kubernetes, but for this example I'm going to install an instance of Prometheus and Grafana inside the cluster and have Prometheus discover our Application and scrape metrics from it.</p>
<p>To install Prometheus and Grafana in our cluster we're going to use <a href="https://helm.sh/" target="_blank" rel="noopener noreferrer" class="">Helm</a>.
Helm is a package manager for Kubernetes.
Think of it like npm/apt for Kubernetes.
Check out the <a href="https://helm.sh/docs/intro/quickstart/" target="_blank" rel="noopener noreferrer" class="">official documentation on getting started</a> if you have the time, but for this example, all the configuration we're going to need is:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew install helm</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm repo add stable https://kubernetes-charts.storage.googleapis.com/</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="installing-prometheus">Installing Prometheus<a href="https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019#installing-prometheus" class="hash-link" aria-label="Direct link to Installing Prometheus" title="Direct link to Installing Prometheus" translate="no">​</a></h4>
<p>We can install Prometheus in our cluster by running:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm install my-prometheus stable/prometheus</span><br></span></code></pre></div></div>
<p>Which should output something like:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME: my-prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LAST DEPLOYED: Thu Dec  5 15:29:58 2019</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STATUS: deployed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REVISION: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TEST SUITE: None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOTES:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The Prometheus server can be accessed via port 80 on the following DNS name from within your cluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my-prometheus-server.default.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Get the Prometheus server URL by running these commands in the same shell:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  export POD_NAME=$(kubectl get pods --namespace default -l "app=prometheus,component=server" -o jsonpath="{.items[0].metadata.name}")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl --namespace default port-forward $POD_NAME 9090</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The Prometheus alertmanager can be accessed via port 80 on the following DNS name from within your cluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my-prometheus-alertmanager.default.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Get the Alertmanager URL by running these commands in the same shell:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  export POD_NAME=$(kubectl get pods --namespace default -l "app=prometheus,component=alertmanager" -o jsonpath="{.items[0].metadata.name}")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl --namespace default port-forward $POD_NAME 9093</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">The Prometheus PushGateway can be accessed via port 9091 on the following DNS name from within your cluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my-prometheus-pushgateway.default.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Get the PushGateway URL by running these commands in the same shell:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  export POD_NAME=$(kubectl get pods --namespace default -l "app=prometheus,component=pushgateway" -o jsonpath="{.items[0].metadata.name}")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl --namespace default port-forward $POD_NAME 9091</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">For more information on running Prometheus, visit:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">https://prometheus.io/</span><br></span></code></pre></div></div>
<p>Now if we also run:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export POD_NAME=$(kubectl get pods --namespace default -l "app=prometheus,component=server" -o jsonpath="{.items[0].metadata.name}")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl --namespace default port-forward $POD_NAME 9090</span><br></span></code></pre></div></div>
<p>We should be able to access the Prometheus server at <code>localhost:9090</code></p>
<p>But if we navigate to status/targets, we will see that Prometheus fails to discover our application.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-11-3177aada7f7d631978ce2302a70b6277.png" width="1024" height="646" class="img_ev3q"></p>
<p>There's two ways to fix this.
First we can use an <a href="https://github.com/helm/charts/blob/master/stable/prometheus/values.yaml#L1316" target="_blank" rel="noopener noreferrer" class="">additional argument</a> when installing the Prometheus chart through Helm -<br>
<!-- -->We can create a file <code>extraScrapeConfigs.yaml</code> with the following settings</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">extraScrapeConfigs: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - job_name: 'armeria-metrics'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scrape_interval: 1s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metrics_path: /internal/metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kubernetes_sd_configs:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - role: endpoints</span><br></span></code></pre></div></div>
<p>And then we need to update our Prometheus chart config by running:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm upgrade --install my-prometheus --set-file extraScrapeConfigs=prometheus/extraScrapeConfigs.yaml stable/prometheus</span><br></span></code></pre></div></div>
<p>However I suggest we modify our <code>deployment.yaml</code> file by adding the following config allowing Prometheus to pull metrics from our app:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spec.template.metadata.annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prometheus.io/scrape: "true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prometheus.io/port: "8080"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  prometheus.io/path: /internal/metrics</span><br></span></code></pre></div></div>
<p>So our <code>deployment.yaml</code> file should look like this:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  creationTimestamp: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  strategy: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      creationTimestamp: null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      annotations:                               ### here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prometheus.io/scrape: "true"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prometheus.io/port: "8080"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prometheus.io/path: /internal/metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      - image: docker.io/nirvanarsc/my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        name: my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resources: {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">status: {}</span><br></span></code></pre></div></div>
<p>And we need to re-deploy our app with the updated configuration:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl delete deploy/my-app svc/my-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl apply -f k8s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl port-forward svc/my-app 8080:8080</span><br></span></code></pre></div></div>
<p>If we navigate to status/targets now, we should see the 3 pods of our application.
We should also be able to query our metrics.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-12-a952350f9bf8708b17939060074def86.png" width="1024" height="665" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-13-382dd088b3f97b0c8f38724aa7d7c150.png" width="1024" height="396" class="img_ev3q"></p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="installing-grafana">Installing Grafana<a href="https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019#installing-grafana" class="hash-link" aria-label="Direct link to Installing Grafana" title="Direct link to Installing Grafana" translate="no">​</a></h4>
<p>Lastly, we can install Grafana and visualize our metrics.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm install my-grafana stable/grafana</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">NAME: my-grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LAST DEPLOYED: Thu Dec  5 16:03:33 2019</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STATUS: deployed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REVISION: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOTES:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. Get your 'admin' user password by running:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   kubectl get secret --namespace default my-grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   my-grafana.default.svc.cluster.local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Get the Grafana URL to visit by running these commands in the same shell:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     export POD_NAME=$(kubectl get pods --namespace default -l "app=grafana,release=my-grafana" -o jsonpath="{.items[0].metadata.name}")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     kubectl --namespace default port-forward $POD_NAME 3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. Login with the password from step 1 and the username: admin</span><br></span></code></pre></div></div>
<p>Following the instructions above we should be able to log in to Grafana at <code>localhost:3000</code>.
Then we can add Prometheus as a data source and create a dashboard with our applications metrics.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-14-20c6d4e2bf109eed0aeac970ff02e6f7.png" width="1024" height="723" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019-15-aeb013ee4a1911f79afdcc680a01e887.png" width="1024" height="317" class="img_ev3q"></p>
<p>And that's it!
We have successfully used Prometheus and Grafana to build a dashboard visualizing our app's metrics.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="conclusion">Conclusion<a href="https://armeria.dev/blog/2019/12/23/monitoring-a-spring-boot-app-in-kubernetes-what-i-learned-from-devoxx-belgium-2019#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate="no">​</a></h2>
<p>Getting started with Kubernetes can be quite challenging.
I think there are 3 main reasons for that:</p>
<ul>
<li class="">Writing a good YAML file is difficult</li>
<li class="">Knowledge of networking is required</li>
<li class="">There are a lot of small interconnected components such as Docker, Pods, Services, and ReplicaSets</li>
</ul>
<p>I hope this blog post will make it a little easier for you to begin development on Kubernetes.</p>
<p>Happy coding!</p>
<hr>
<p>A list of the Devoxx sessions about Kubernetes I found most useful:</p>
<ul>
<li class=""><a href="https://www.youtube.com/watch?v=c16oOeTfFXM" target="_blank" rel="noopener noreferrer" class="">Best Practices to Spring to Kubernetes Easier and Faster by Ray Tsang - YouTube</a></li>
<li class=""><a href="https://www.youtube.com/watch?v=YYJ4RZFw4j8" target="_blank" rel="noopener noreferrer" class="">Develop and Deploy to Kubernetes like a Googler by David Gageot - YouTube</a></li>
<li class=""><a href="https://www.youtube.com/watch?v=YiXf4Pqyl0A" target="_blank" rel="noopener noreferrer" class="">Helm your way with Kubernetes by Ana Maria Mihalceanu - YouTube</a></li>
<li class=""><a href="https://www.youtube.com/watch?v=dId543PzSsU" target="_blank" rel="noopener noreferrer" class="">Crash course in Kubernetes monitoring by Robert Munteanu - YouTube</a></li>
</ul>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Make your GitHub contributions calendar greener (featuring Armeria Sprint)!]]></title>
            <link>https://armeria.dev/blog/2019/05/14/armeria-sprint-1</link>
            <guid>https://armeria.dev/blog/2019/05/14/armeria-sprint-1</guid>
            <pubDate>Tue, 14 May 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[Hi, there!]]></description>
            <content:encoded><![CDATA[<p>Hi, there!
Do any of you need to make lots and lots of commits to turn your <a href="https://help.github.com/en/articles/viewing-contributions-on-your-profile#contributions-calendar" target="_blank" rel="noopener noreferrer" class="">GitHub contribution calendar</a> into a pastureland?
If that's the case, I proudly present Armeria Sprint!
Let me give you some ideas on what Armeria Sprint is and share reviews from our enthusiastic participants.</p>
<p>You've probably come across a sprint at technical conferences such as <a href="https://us.pycon.org/2019/community/sprints/" target="_blank" rel="noopener noreferrer" class="">PyCON Development Sprints</a> before.
Or, you might just find the term, sprint, familiar because it appears in Agile software development.
You might still wonder, "What is an open source sprint anyway?
What's up with Armeria Sprint?"</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/armeria-sprint-1-1-86145b7d89389da073b2ac3d87ee8787.png" width="1276" height="172" class="img_ev3q"></p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-an-open-source-sprint">What is an open source sprint?<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#what-is-an-open-source-sprint" class="hash-link" aria-label="Direct link to What is an open source sprint?" title="Direct link to What is an open source sprint?" translate="no">​</a></h2>
<p>An open source sprint is a time dedicated for those who want to contribute to open source projects to come together and concentrate on coding. (Please refer to the <a class="" href="https://armeria.dev/blog/2019/04/16/thank-you-for-contributing-to-armeria">previous posting</a> to find more about open source contributions.) It could vary but sprints are usually scheduled as a one-day event where all participants meet up in the morning to decide who is doing what (among open issues) and spend the rest of the day "coding away".</p>
<p>There are usually two types of participants, mentors and mentees.
Those who have contributed to the selected open source project before take up a mentor role while new comers with a lot of passion for the project are mentees.
For the Armeria Sprint, we were honored to have our three Armeria maintainers as mentors.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-a-sprint-for">What is a sprint for?<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#what-is-a-sprint-for" class="hash-link" aria-label="Direct link to What is a sprint for?" title="Direct link to What is a sprint for?" translate="no">​</a></h3>
<p>Even if you have passion for open source projects, the reality is that it is not always easy to find time for it.
Or, sometimes you have so many questions about an open source project but you simply don't know where to find answers.
Moreover, it is conventional wisdom that two are better than one.
Open source sprints are an opportunity for those of you who have a heart for open source projects but could not find time in the past or for those of you who just want to give it a try for the first time.</p>
<p>New contributors and their contributions fuel the growth of the open source community, making it more vibrant.
Even for mentors, when they interact and communicate with different participants, they will be able to understand what has been an entry barrier for new contributors.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview-of-armeria-sprint">Overview of Armeria Sprint<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#overview-of-armeria-sprint" class="hash-link" aria-label="Direct link to Overview of Armeria Sprint" title="Direct link to Overview of Armeria Sprint" translate="no">​</a></h2>
<p>This year's Armeria Sprint was open to LINE developers only.
We opened up only a few seats to achieve the optimum ratio of mentors to mentees.
Quite surprisingly, these seats were filled up in a flash with more applicants on the waiting list!
This alone testified to fully charged passion of all applicants.
What an enthusiasm!
The Armeria Sprint was scheduled for two days: two hours of welcome session on the first day and four hours of development sprint on the second day.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="welcome-session">Welcome session<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#welcome-session" class="hash-link" aria-label="Direct link to Welcome session" title="Direct link to Welcome session" translate="no">​</a></h3>
<p>The welcome session was kicked off with a brief introduction of all participants.
After breaking the ice, the participants touched upon the following topics.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="must-reads-before-open-source-contribution">Must-reads before open source contribution<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#must-reads-before-open-source-contribution" class="hash-link" aria-label="Direct link to Must-reads before open source contribution" title="Direct link to Must-reads before open source contribution" translate="no">​</a></h4>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="contributing">Contributing<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#contributing" class="hash-link" aria-label="Direct link to Contributing" title="Direct link to Contributing" translate="no">​</a></h4>
<p><a href="https://github.com/line/armeria/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer" class="">This document</a> explains how you can contribute to the Armeria project together with a set of rules to comply with when doing so.
The summary of key points is provided under <a href="https://github.com/line/armeria/blob/master/CONTRIBUTING.md#checklist-for-your-pull-request" target="_blank" rel="noopener noreferrer" class="">Checklist for your pull request</a>.
It can help you save time for code review.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="contributor-license-agreement-cla">Contributor License Agreement (CLA)<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#contributor-license-agreement-cla" class="hash-link" aria-label="Direct link to Contributor License Agreement (CLA)" title="Direct link to Contributor License Agreement (CLA)" translate="no">​</a></h4>
<p>You might have seen this type of <a href="https://cla-assistant.io/line/armeria" target="_blank" rel="noopener noreferrer" class="">agreement</a> before but considered it did not concern you.
Open source projects usually ask you to sign the CLA before you start your contribution.
The following bullet points summarize the content of the CLA (Note that it can vary by project.):</p>
<ul>
<li class="">
<p>The purpose of the CLA is to protect the project and its contributors and users.</p>
</li>
<li class="">
<p>Signing the CLA will constitute an agreement to go open source on your contributions in the same terms as the Armeria project.</p>
</li>
<li class="">
<p>Your contributions will be accepted as they are, and you will not be held accountable for any bug or flaw in your contributions.</p>
</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="code-of-conduct">Code of Conduct<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#code-of-conduct" class="hash-link" aria-label="Direct link to Code of Conduct" title="Direct link to Code of Conduct" translate="no">​</a></h4>
<p>Contributors are expected to follow the <a href="https://github.com/line/armeria/blob/master/CODE_OF_CONDUCT.md" target="_blank" rel="noopener noreferrer" class="">Code of Conduct</a>, which provides a guideline to foster an open and welcoming environment.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="task-allocation">Task allocation<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#task-allocation" class="hash-link" aria-label="Direct link to Task allocation" title="Direct link to Task allocation" translate="no">​</a></h4>
<p>The main purpose of the welcome session was to decide on who is going to do what.
First, the participants went through the <a href="https://github.com/line/armeria/issues?q=is%3Aopen+is%3Aissue+label%3Agood-first-issue" target="_blank" rel="noopener noreferrer" class="">good-first-issues</a> with more detailed elaboration on each issue by the mentors.
They explained about the background and history of each issue and relevant technical requirements and background knowledge to resolve the issue.</p>
<p>When you find an issue you want to work on, don't hesitate to leave a comment such as "I am working on this" or "I'll handle this issue" so that you don't redundantly work on the same issue with others.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="configuring-development-environment">Configuring development environment<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#configuring-development-environment" class="hash-link" aria-label="Direct link to Configuring development environment" title="Direct link to Configuring development environment" translate="no">​</a></h4>
<p>After everyone picked an issue, they went step by step to set up the development environment (Check out <a href="https://github.com/line/armeria/blob/master/CONTRIBUTING.md#setting-up-your-ide" target="_blank" rel="noopener noreferrer" class="">Setting up your IDE</a>).</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/armeria-sprint-1-2-083b5bebb1c751fbb46e8b72bc4a7c2d.jpg" width="2002" height="1280" class="img_ev3q"></p>
<p>The participants did a little activity while configuring development environment like "lay down your water bottle when you're done with fork &amp; clone".</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="sprint-results">Sprint results<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#sprint-results" class="hash-link" aria-label="Direct link to Sprint results" title="Direct link to Sprint results" translate="no">​</a></h3>
<p>Here are the pull requests opened during the Armeria Sprint:</p>
<ul>
<li class=""><a href="https://github.com/line/armeria/pull/1742" target="_blank" rel="noopener noreferrer" class="">#1742</a> Allow using wildcards with RequestContextExportingAppender</li>
<li class=""><a href="https://github.com/line/armeria/pull/1743" target="_blank" rel="noopener noreferrer" class="">#1743</a> Provide a way to create a client with an Endpoint rather than with a URI</li>
<li class=""><a href="https://github.com/line/armeria/pull/1744" target="_blank" rel="noopener noreferrer" class="">#1744</a> Show armeria version in doc service</li>
<li class=""><a href="https://github.com/line/armeria/pull/1745" target="_blank" rel="noopener noreferrer" class="">#1745</a> Enable to convert JSON format request to String</li>
<li class=""><a href="https://github.com/line/armeria/pull/1747" target="_blank" rel="noopener noreferrer" class="">#1747</a> Introduce 'export-as-curl' button to a debug request window</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/armeria-sprint-1-3-e6687888fa70e93961043304b6092178.jpeg" width="4032" height="3024" class="img_ev3q"></p>
<p>Don't worry!
Your "secret identity" is protected, Armeria Sprinters!</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/armeria-sprint-1-4-cc4f6442e399cee4c1ac98a48b7e8a1f.jpeg" width="3452" height="2233" class="img_ev3q"></p>
<p>Keep those sticky fingers away from the precious laptops!</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="reviews">Reviews<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#reviews" class="hash-link" aria-label="Direct link to Reviews" title="Direct link to Reviews" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="feedback-from-armeria-sprint-participants">Feedback from Armeria Sprint participants<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#feedback-from-armeria-sprint-participants" class="hash-link" aria-label="Direct link to Feedback from Armeria Sprint participants" title="Direct link to Feedback from Armeria Sprint participants" translate="no">​</a></h4>
<ul>
<li class="">I especially liked that there was someone I could easily reach out for questions. Moreover, everyone respected each other. I hope there will more opportunities like this so that I can overcome my hesitation toward open source projects.</li>
<li class="">Well, I think I was kind of "tricked by my mentor" because the issue I picked sounded much easier when he explained it. (LOL) Still, it was quite a positive experience for me to make contributions to an open source project.</li>
<li class="">If you are developer, you would have dreamt of open source contributions, at least once. It was a good start for me.</li>
<li class="">When I actually got to it, it was only a few lines of code. But, I had a lot to think about before making it happen.</li>
<li class="">Mentors made open issues quite easy to understand, but it took some time for me to understand the existing code. If we were given an overall view on the code or structure of Armeria in advance, it could have been easier to approach the issue.</li>
<li class="">I've given it a few tries to contribute to open source projects in the past, but to no avail. This time, I could make it happen because there were mentors around for guidance.</li>
<li class="">My team is using Armeria. Even if I sometimes felt a need for new things, I was reluctant to make changes on my own. After this Sprint, I think I'll be able to take the initiative in making contributions. I'll study the code more to prepare myself.</li>
<li class="">I found it a little bit difficult to handle the issue. But, it was a good opportunity for me to learn the basics.</li>
<li class="">I was almost done, but we ran out of time before I could open a pull request. I'll finish it up and open a pull request soon.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="feedback-from-armeria-sprint-mentors">Feedback from Armeria Sprint mentors<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#feedback-from-armeria-sprint-mentors" class="hash-link" aria-label="Direct link to Feedback from Armeria Sprint mentors" title="Direct link to Feedback from Armeria Sprint mentors" translate="no">​</a></h4>
<ul>
<li class="">To those who find it difficult to approach open source development, it all begins with leaving your problem solving ideas as a comment on the issue. Don't sweat it and ask questions! Your questions are a big help for us, too.</li>
<li class="">It was a great opportunity for me to realize that there were so many developers out there who were interested in open source development. I was very proud to serve as a mentor for this event. (Don't forget to star the repository!)</li>
<li class="">I was a little nervous because this was the first Sprint ever. But, all my worries were groundless. I'd like to thank all the participants for taking it so seriously. Even though the first Armeria Sprint is over for now, you can always leave a comment or a question on the GitHub and Slack.</li>
<li class="">We made a big progress by opening pull requests today. But, I dare say it's only a start. Your coding skills will evolve further through code reviews. Don't give up until your code is merged.</li>
<li class="">It was a very meaningful experience to meet up with contributors face to face. I wish there will be more events like this one.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="wrapping-up">Wrapping up<a href="https://armeria.dev/blog/2019/05/14/armeria-sprint-1#wrapping-up" class="hash-link" aria-label="Direct link to Wrapping up" title="Direct link to Wrapping up" translate="no">​</a></h2>
<p>Thank you all for your hard work during the Armeria Sprint!
We hope this was a time of mutual growth and everyone enjoyed the Sprint.
We'll come back with a more rewarding event next time.</p>
<p>Before I go away, this was the first Sprint I've organized, and I'd like to express my gratitude to the authors of the following guides as they helped me to make my first-time Sprint a success:</p>
<ul>
<li class=""><a href="https://github.com/drud/sprint_guide" target="_blank" rel="noopener noreferrer" class="">Open Source Contribution Sprint Guide by DRUD</a></li>
<li class=""><a href="https://opensourceevents.github.io/" target="_blank" rel="noopener noreferrer" class="">Th</a><a href="https://opensourceevents.github.io/" target="_blank" rel="noopener noreferrer" class="">e In-Person Event Handbook by opensource-events</a></li>
</ul>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Thank you for contributing to Armeria!]]></title>
            <link>https://armeria.dev/blog/2019/04/16/thank-you-for-contributing-to-armeria</link>
            <guid>https://armeria.dev/blog/2019/04/16/thank-you-for-contributing-to-armeria</guid>
            <pubDate>Tue, 16 Apr 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[Hello to the readers!]]></description>
            <content:encoded><![CDATA[<p>Hello to the readers!
I'd like to share with you the first ever Armeria Contributor Reward Event and how it went.
For this posting, I'm not going to elaborate on the technical aspects of Armeria.
To learn more about its technology and features, please visit the <a href="https://line.github.io/armeria" target="_blank" rel="noopener noreferrer" class="">official website for Armeria</a>.</p>
<p>The <a href="https://github.com/line/armeria" target="_blank" rel="noopener noreferrer" class="">Armeria</a> project was initially developed by LINE but went to open source later.
Even though the project was initiated by LINE, Armeria is where it is now thanks to participation from many passionate contributors.
That is why we organized this Armeria Contributor Reward Event, to express our gratitude to all of the contributors.</p>
<p>Let me first give a quick summary of what open source contribution is.</p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-open-source-contribution">What is open source contribution?<a href="https://armeria.dev/blog/2019/04/16/thank-you-for-contributing-to-armeria#what-is-open-source-contribution" class="hash-link" aria-label="Direct link to What is open source contribution?" title="Direct link to What is open source contribution?" translate="no">​</a></h2>
<p>When a new project is launched at a company, the project team is formed with participants from different areas such as development, planning, business and design.
The same applies to open source projects as open source projects can deliver good results when people with different backgrounds, not only programmers but also testers, marketers, designers and technical writers, work together.
Some think, in the narrow sense, you contribute to open source only when your code is merged.
However, as open source projects are not all about programming, as I mentioned earlier, all kinds of contributions matter for the growth and sustainability of open source projects.
For example, you are an open source contributor if you bring in more contributors by giving presentations on an open source project, if you donate your talent of writing for documentation, if you offer new ideas to resolve an issue, if you report a bug or if you help out with a logo or UI design.</p>
<p>So, why does each and every contributor count in the world of open source?
Why can't it be controlled solely by a project owner?</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-contribute-to-open-source---from-project-owners-perspective">Why contribute to open source? - from project owner's perspective<a href="https://armeria.dev/blog/2019/04/16/thank-you-for-contributing-to-armeria#why-contribute-to-open-source---from-project-owners-perspective" class="hash-link" aria-label="Direct link to Why contribute to open source? - from project owner's perspective" title="Direct link to Why contribute to open source? - from project owner's perspective" translate="no">​</a></h3>
<p>When I talk to people who create open source projects, they tend to have a belief that projects are yet to be perfected and they can make them better with user feedback. <a href="https://en.wikipedia.org/wiki/Eric_S._Raymond" target="_blank" rel="noopener noreferrer" class="">Eric S.
Raymond</a>, a well-known open source software advocate, wrote about open source software development models in his essay, <a href="https://en.wikipedia.org/wiki/The_Cathedral_and_the_Bazaar" target="_blank" rel="noopener noreferrer" class="">The Cathedral and the Bazaar</a>.
The point he wants to make is: the more contributors including users are, the better software becomes.</p>
<p>Let's say you own a restaurant and sell your signature menu.
Everyone almost always has a different voice about the same menu.
Some might say it tastes just right for them while others could find it too sweet, too spicy or too salty.
Or, some might have an idea of perfect plating for your signature menu.
There could also be someone who knows how to better design a menu to highlight your signature dish.
What if they have a channel to give their feedback right away or even make changes themselves?
Such collaborated efforts and ideas could make your restaurant a more attractive place.
People might line up outside your beautiful restaurant to enjoy the upgraded signature menu.</p>
<p>Open source software development is fueled by user feedback.
If you choose to go open source but ignore user feedback, users will gradually stop using the software.
Then, the software will eventually lose its purpose as a product.
On the other hand, trying to handle every single feedback on your own is problematic too.
Especially if there is too much feedback.
You will naturally get more feedback when more contributors participate.
It will become more difficult for you to respond to increasing feedback all by yourself, and when you fail to do so, it will result in deteriorating quality and loss of users.
In the end, the open source software will become obsolete.</p>
<p>Smooth communications between the project owner and users are essential to open source development based on user feedback.
Quick reflection of feedback will lead to more participation, creating a virtuous cycle of users actively participating as developers.
Such a virtuous cycle will sustain the open source community for the project.</p>
<p>All this is from the perspective of project owners.
Now, let's look at it from a contributor's perspective.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-contribute-to-open-source---from-contributors-perspective">Why contribute to open source? - from contributor's perspective<a href="https://armeria.dev/blog/2019/04/16/thank-you-for-contributing-to-armeria#why-contribute-to-open-source---from-contributors-perspective" class="hash-link" aria-label="Direct link to Why contribute to open source? - from contributor's perspective" title="Direct link to Why contribute to open source? - from contributor's perspective" translate="no">​</a></h3>
<p>First of all, you as a contributor can make requests to an open source project directly and immediately.
When there is an active community for the open source project, you will get replies in no time from other users or the maintainer.
Wouldn't it make your open source life easier if you can get an answer to your questions quickly?
If there is something you want to change, you can do it yourself, instead of waiting for someone to do it for you.
You can also receive feedback on the changes you made.
Records of everyone's participation is shared publicly at the open source community.
This record can act as a portfolio and serve as a strong and effective self promotion, even more so than the coding tests you have to take in applying for jobs.</p>
<p>Did any of you out there stand on the sidelines because you thought that open source projects were only for highly skilled programmers?
Why don't you revisit those open source projects you have been following and contribute?
I'd suggest to start with the issue list of a project, especially with the issues tagged with 'good-first-issue', 'first-timers-only' or 'help-wanted'?</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="armeria-contributor-reward">Armeria Contributor Reward<a href="https://armeria.dev/blog/2019/04/16/thank-you-for-contributing-to-armeria#armeria-contributor-reward" class="hash-link" aria-label="Direct link to Armeria Contributor Reward" title="Direct link to Armeria Contributor Reward" translate="no">​</a></h2>
<p>The purpose of the Armeria Contributor Reward Event was to express our gratitude to the contributors and interact with them.
Since the Armeria project was open to people around the globe, main communications channel was via texts or replies.
We've always felt that "LGTM (Looks Good To Me)" or ":thumbsup:?" weren't enough to express our gratitude.
This time, we have reached out to individual contributors by email and sent a small gift.</p>
<p>We also created an event banner, using the <a href="https://help.github.com/articles/personalizing-your-profile/#changing-your-profile-picture" target="_blank" rel="noopener noreferrer" class="">GitHub profile pictures</a> of all contributors.
Isn't it an adorable pink banner just like the logo of Armeria?</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/thank-you-for-contributing-to-armeria-1-3f3df0d2b8c505b2e22a7d0c13a5bd23.png" width="1000" height="333" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="participation-by-contributors">Participation by contributors<a href="https://armeria.dev/blog/2019/04/16/thank-you-for-contributing-to-armeria#participation-by-contributors" class="hash-link" aria-label="Direct link to Participation by contributors" title="Direct link to Participation by contributors" translate="no">​</a></h3>
<p>GitHub provides a <a href="https://github.com/line/armeria/graphs/contributors" target="_blank" rel="noopener noreferrer" class="">graph</a> on contributions.
The following is a summary of what the graph tells you.
Up until now, more than 60 contributors made more than 1,350 commits, adding about 457,000 lines and deleting 257,500 lines.
The numbers tell how active our contributors have been.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/thank-you-for-contributing-to-armeria-2-fcb1737125e1ea66099c22a8139ee5f9.png" width="1093" height="309" class="img_ev3q"></p>
<p>Let's take a closer look on more specific contributions from the contributors.</p>
<ul>
<li class="">Your contribution led Armeria's annotated service to a whole new level.</li>
<li class="">Your Retrofit integration module was one of the greatest additions in Armeria's history.</li>
<li class="">HTTP redirection is now easier than ever with Armeria thanks to your contribution.</li>
<li class="">Your work on implementing the high quality circuit breaker in Armeria is considered as an all-time legend.</li>
<li class="">Your optimization of weighted round-robin load balancing algorithm was very clever idea that it was worth of a prize.</li>
<li class="">We appreciate your initial groundwork, especially on the client-side, which made today's Armeria.</li>
<li class="">Thank you for promoting Armeria to the developer communities and we appreciate your contribution to the project!</li>
<li class="">Your documentation clean-up made us look way better than ever.</li>
<li class="">Your help with fixing the bug made Armeria more stable than ever.</li>
<li class="">Although your part was small, your dedication saved many of our days.</li>
</ul>
<p>On top of this, many contributors made contributions in various ways.
We sent a thank-you note to each and every one of them.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="interview-with-anuraaga">Interview with @anuraaga<a href="https://armeria.dev/blog/2019/04/16/thank-you-for-contributing-to-armeria#interview-with-anuraaga" class="hash-link" aria-label="Direct link to Interview with @anuraaga" title="Direct link to Interview with @anuraaga" translate="no">​</a></h3>
<p>As the <a href="https://github.com/line/armeria/graphs/contributors" target="_blank" rel="noopener noreferrer" class="">Insights tab</a> on GitHub shows, it was <a href="https://github.com/line/armeria/commits?author=anuraaga" target="_blank" rel="noopener noreferrer" class="">@anuraaga</a> who made the most contributions except for the project owners.
We took this opportunity to interview @anuraaga to share his thoughts.</p>
<p><strong>Q.
Could you please introduce yourself briefly?</strong></p>
<p>A.
I'm Anuraag, many call me Rag.
I am a software engineer, and I have worked on many large-scale server-side projects.
I got to know Armeria when I was working at LINE in the LINE Shop team â it was a really great coincidence that when I joined the team and wanted a full-featured RPC framework to replace legacy <a href="https://thrift.apache.org/" target="_blank" rel="noopener noreferrer" class="">Thrift</a> libraries, <a href="https://github.com/trustin" target="_blank" rel="noopener noreferrer" class="">@trustin</a>(Trustin, the project owner) had just started working on the Armeria project to provide that.
Since then, even after leaving LINE, I have been using Armeria in all my projects and continue to contribute what I can to the project.</p>
<p><strong>Q.
How do you use Armeria?
Do you use it at work?</strong></p>
<p>A.
I use Armeria for all my server-side needs, for work and personal needs.
My company, <a href="https://www.infostellar.net/" target="_blank" rel="noopener noreferrer" class="">Infostellar</a>, is building out global network infrastructure for satellite communications, and this means transferring lots of data, in addition to usual needs of an API.
Our architecture follows a standard service-based one, with many servers running on <a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer" class="">Kubernetes</a>, each exposing a <a href="https://grpc.io/" target="_blank" rel="noopener noreferrer" class="">gRPC</a> API using Armeria.
We also have a web frontend, which is also powered by Armeria's static file serving functionality and support for gRPC-Web.</p>
<p>Aside from work, Armeria is also my go-to for personal projects on the weekends.
I'm glad I can use Armeria effectively in all sizes of projects as it just satisfies the use cases I need :)</p>
<p><strong>Q.
What do you think is the best part of Armeria?</strong></p>
<p>A.
I think Armeria's strongest point is the focus on developer productivity.
Trustin has really created the project to satisfy the needs of all developers, and it means lots of flexibility, while also showcasing best practices and ensuring developers don't miss out on modern trends such as asynchronous programming.
I have seen other frameworks or libraries where the maintainers take a very theoretical approach, which often results in the library being harder to use for developers because it focuses on what the maintainers want to see in a library, not what the developers need in a library.
I think Armeria's focus on developer needs, including providing full support in a Slack channel, allows it to be useful to a large spectrum of developers, not just a small segment.</p>
<p>I also want to say that I really appreciate that Armeria is the most flexible server framework I've seen â being able to serve gRPC, static files, metrics, DocService, and any other content all on the same TCP port is a big achievement!</p>
<p><strong>Q.
Have you experienced any difficulties in participating in Armeria development?</strong></p>
<p>A.
Armeria development has been very smooth for me.
The documentation and IDE(Integrated Development Environment) settings setup is easy to follow and PRs (Pull Requests) go smoothly thanks to the pleasant reviewers.
For a little while, I did feel that releases were happening slowly, and I've even had to once deploy a snapshot with a bugfix that was merged but not released for some time.
Lately, though, it seems releases are happening much more frequently and I haven't felt this at all. :)</p>
<p>One small point, which I guess is hard to change, is I do find myself having trouble getting whitespace formatting right even with the imported code settings â it's especially embarrassing seeing Trustin fix some whitespace issues in future PRs when he notices the ones I missed. ;) Using an automatic formatter would remove one thing to worry about during development.</p>
<p><strong>Q.
Do you have any plans for or expectations from the project?</strong></p>
<p>A.
I personally plan to continue to use Armeria, contributing code when I find a new feature that may be useful, etc.
Actually this is a good point; I'm not clear on what are the project's expectations for itself.
There are many feature requests, often using a limited scope of technology â <a href="https://github.com/line/armeria/issues/194" target="_blank" rel="noopener noreferrer" class="">adding support</a> for more service discovery mechanisms is a recent one that reminded me of this, another being whether to natively support spring security or not.
I imagine it's not in Armeria's scope to support every single technology in the world, and wonder how to draw the line.</p>
<p><strong>Q.
What do you think about open source or open source contribution?</strong></p>
<p>A.
I love open source!
I think it creates useful technology for all the developers out there, but also creates strong communities and I am really surprised but happy to have made many friends through open source.
I hope to get to meet many more people through continued open source activities and encourage anyone that has some free time to just send a PR to their favorite repository.</p>
<p><strong>Q.
Any other comments?</strong></p>
<p>A.
I am excited that this event happened â it's great to see a focus on expanding open source from a leading company like LINE.
It's easy for companies to just put out some source code, but not easy to actually support the ecosystem itself.
Thanks a lot for helping to build the open source community!</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="closing">Closing<a href="https://armeria.dev/blog/2019/04/16/thank-you-for-contributing-to-armeria#closing" class="hash-link" aria-label="Direct link to Closing" title="Direct link to Closing" translate="no">​</a></h2>
<p>Armeria is planning a range of programs to reach out to more users and contributors.
We will share the news on upcoming events via <a href="https://engineering.linecorp.com/ko/blog/" target="_blank" rel="noopener noreferrer" class="">LINE Engineering blog</a> and <a href="https://line-armeria.slack.com/join/shared_invite/enQtNjIxNDU1ODU1MTI2LTgwMzk0MzVhOGRhZjJiY2ExODc0MzNhYzIxZDFlYjM5OGRjNTE1MzYzYzQ4MzNhNGY2ZDM0NThhMTRmZmQ3ZjQ" target="_blank" rel="noopener noreferrer" class="">official Slack</a> like we always do.</p>
<p>Moreover, LINE is looking for programmers for <a href="https://github.com/line/armeria" target="_blank" rel="noopener noreferrer" class="">Armeria</a> and <a href="https://github.com/line/centraldogma" target="_blank" rel="noopener noreferrer" class="">Central Dogma</a>.
Please check out the following job posting for more information.</p>
<ul>
<li class=""><a href="https://recruit.linepluscorp.com/lineplus/career/detail/20002599" target="_blank" rel="noopener noreferrer" class="">Open position: common framework and platform software development</a> - Korea</li>
</ul>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Making a basic server with Java & Armeria]]></title>
            <link>https://armeria.dev/blog/2018/09/13/making-a-basic-server-with-java-armeria</link>
            <guid>https://armeria.dev/blog/2018/09/13/making-a-basic-server-with-java-armeria</guid>
            <pubDate>Thu, 13 Sep 2018 00:00:00 GMT</pubDate>
            <description><![CDATA[As some of you know already, LINE has been actively open-sourcing projects including Armeria and Central Dogma.]]></description>
            <content:encoded><![CDATA[<p>As some of you know already, LINE has been actively open-sourcing projects including <a href="https://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a> and <a href="https://line.github.io/centraldogma/" target="_blank" rel="noopener noreferrer" class="">Central Dogma</a>.
Today, I'd like to share a bit about Armeria and setting up a simple web server using Armeria.
To follow the instructions, you need to have Java and IntelliJ IDEA installed, which can be downloaded from the following links:</p>
<ul>
<li class=""><a href="https://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="noopener noreferrer" class="">Java Development Kit</a></li>
<li class=""><a href="https://www.jetbrains.com/idea/" target="_blank" rel="noopener noreferrer" class="">IntelliJ IDEA</a></li>
</ul>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-a-project">Create a project<a href="https://armeria.dev/blog/2018/09/13/making-a-basic-server-with-java-armeria#create-a-project" class="hash-link" aria-label="Direct link to Create a project" title="Direct link to Create a project" translate="no">​</a></h2>
<p>Let us begin by creating a project.
First, run IntelliJ IDEA and click the <strong>Create New Project</strong> button.
The New Project dialog pops up.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/making-a-basic-server-with-java-armeria-1-f9cd4bd82d79b146a04372e6c3cf26af.png" width="1332" height="964" class="img_ev3q"></p>
<p>On the New Project dialog, click the <strong>Gradle</strong> menu from the left panel, and then check the box for <strong>Java</strong>, and click the Next button.
The dialog displays the fields required for project configuration.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/making-a-basic-server-with-java-armeria-2-80eb84c42349487c987a7dbb286e610e.png" width="806" height="487" class="img_ev3q"></p>
<p>Configure the fields as instructed below.</p>
<ul>
<li class=""><strong>GroupId</strong>: We will skip this field. This field is optional anyway.</li>
<li class=""><strong>ArtifactId</strong>: Enter a name to represent your project. For this post, I named it 'hello-armeria'.</li>
<li class=""><strong>Version</strong>: Use the default value already in the input field.</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/making-a-basic-server-with-java-armeria-3-133fca86fc557e3340b69025921d2f63.png" width="806" height="487" class="img_ev3q"></p>
<p>Once you are done with filling in, click the <strong>Next</strong> button.
Continue with the rest of the step until you see the <strong>Finish</strong> button.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="configure-gradle">Configure Gradle<a href="https://armeria.dev/blog/2018/09/13/making-a-basic-server-with-java-armeria#configure-gradle" class="hash-link" aria-label="Direct link to Configure Gradle" title="Direct link to Configure Gradle" translate="no">​</a></h2>
<p>Once a project is created, open the <code>build.gradle</code> file, which you can find from the <strong>Project</strong> panel on the left-hand side.
You will see a few lines of code like below.
Add the line marked with comments I've left, and save the file.
This makes Gradle automatically configure — download and build — the Armeria library for you.
It may take sometime for the process to be completed.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">plugins {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id 'java'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version '1.0-SNAPSHOT'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sourceCompatibility = 1.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">repositories {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mavenCentral()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dependencies {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Add the following line of code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // &lt;Group Name&gt;:&lt;Artifact Id&gt;:&lt;Version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    compile "com.linecorp.armeria:armeria:0.71.1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="hello-armeria">Hello Armeria!<a href="https://armeria.dev/blog/2018/09/13/making-a-basic-server-with-java-armeria#hello-armeria" class="hash-link" aria-label="Direct link to Hello Armeria!" title="Direct link to Hello Armeria!" translate="no">​</a></h2>
<p>Now, let's make a class.
Go to <strong>src &gt; main</strong>, right-click on <strong>java</strong>, and click <strong>New &gt; Java Class</strong>.
We'll name the class <code>ServerMain.java</code> and make it print, <code>"Hello, Armeria!"</code>.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/making-a-basic-server-with-java-armeria-4-0abee9bb88f848a5ee8ee433185ae2c7.png" width="678" height="509" class="img_ev3q"></p>
<p>First, we will create an instance of the <code>ServerBuilder</code> class and run the server, in the following steps:</p>
<ol>
<li class="">Set the port using the <code>http()</code> method.</li>
<li class="">Configure the server with the <code>service()</code> method.</li>
<li class="">Create an instance of <code>Server</code>.</li>
<li class="">Call the <code>start()</code> method.</li>
</ol>
<p>Here is the actual code:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.common.HttpResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.common.HttpStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.common.MediaType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.Server;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.ServerBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.CompletableFuture;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ServerMain {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerBuilder sb = new ServerBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb.http(8080);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb.service("/hello", (ctx, res) -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HttpResponse.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                HttpStatus.OK,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                MediaType.HTML_UTF_8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "&lt;h1&gt;Hello Armeria...!&lt;/h1&gt;"));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Server server = sb.build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CompletableFuture&lt;Void&gt; future = server.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future.join();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>To those who are unfamiliar with IntelliJ IDEA, here is a little tip on importing classes.
When you enter the name of a class in your code and the class needs to be imported — in our case, <code>ServerBuilder</code> and <code>HttpResponse</code> — press <strong>ALT + Enter</strong>.
You will see the context menu with options available for the given class.
Select <strong>Import class</strong> from the menu which will automatically add an import statement for the specified class on the file.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/making-a-basic-server-with-java-armeria-5-57f6c382db621a5320ffec9a350c821d.png" width="522" height="223" class="img_ev3q"></p>
<p>Note that if you select the <strong>Import class</strong> option on <code>MediaType</code>, available options are as follows:</p>
<ul>
<li class=""><code>MediaType (com.google.common.net)</code></li>
<li class=""><code>MediaType (com.linecorp.armeria.common)</code></li>
</ul>
<p>Since we are using Armeria, select <code>com.linecorp.armeria.common</code>.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/making-a-basic-server-with-java-armeria-6-f0515b31fdeb8dae7c16535963042dd1.png" width="1030" height="203" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="run-a-web-server-for-starters">Run a web server for starters<a href="https://armeria.dev/blog/2018/09/13/making-a-basic-server-with-java-armeria#run-a-web-server-for-starters" class="hash-link" aria-label="Direct link to Run a web server for starters" title="Direct link to Run a web server for starters" translate="no">​</a></h2>
<p>To run a web server from IntelliJ IDEA, go to <strong>Run &gt; Run &lt;file_name&gt;</strong>.
You may see warnings on SLF4J (a library for printing out logs) that it cannot find a suitable logger implementation, but that's not important at the moment.
Let's focus on getting our Armeria server up and running.Open a web browser, enter the URL, <a href="http://127.0.0.1:8080/hello" target="_blank" rel="noopener noreferrer" class="">http://127.0.0.1:8080/hello</a>, and you will be greeted with <code>"Hello, Armeria...!"</code>.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/making-a-basic-server-with-java-armeria-7-a72df7033eb694ec9d3aa68da72e7ac9.png" width="576" height="246" class="img_ev3q"></p>
<p>So, that was it!
Making a web server with Java couldn't be simpler than this, right?
You've only seen the tip of the iceberg; there is much more to Armeria than this.
Just to show you a little bit more, let's move onto routing, the most basic and the core feature of web servers.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="routing">Routing<a href="https://armeria.dev/blog/2018/09/13/making-a-basic-server-with-java-armeria#routing" class="hash-link" aria-label="Direct link to Routing" title="Direct link to Routing" translate="no">​</a></h2>
<p>Create a Java class and name it <code>CustomService</code> or any other name you like.
Copy and paste the following code in the class.
In addition to <code>HttpResponse.of()</code>, I've added annotations for routing.
To keep things simple, I did not add this configuration in the <code>build.gradle</code> file, but instead, passed a parameter, <code>@Param("number") int number</code>.
You can enter parameters like <code>@Param int number</code>, if you add <code>-parameters</code> in the compile option for <code>build.gradle</code>.</p>
<p>Using annotations, we set up routing; set <code>methodA()</code> to be called via <code>GET "/"</code>.
Likewise, <code>methodB()</code> is to be called via <code>GET "/page/&lt;number&gt;"</code>.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.common.HttpResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.common.HttpStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.common.MediaType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.annotation.Get;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.annotation.Param;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CustomService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Get("/")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpResponse methodA() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return HttpResponse.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HttpStatus.OK,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MediaType.HTML_UTF_8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "&lt;h1&gt;Hello Custom Service...!&lt;/h1&gt;");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Get("/page/:number")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpResponse methodB(@Param("number") int number) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return HttpResponse.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            HttpStatus.OK,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MediaType.HTML_UTF_8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "&lt;h1&gt;Hello %d...!&lt;/h1&gt;", number);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The next step is to modify our class, <code>ServerMain</code>.
We need to pass the instance of the <code>CustomService</code> class.
To do so, call the <code>annotatedService()</code> method and pass the instance as the parameter.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.Server;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.ServerBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.CompletableFuture;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ServerMain {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerBuilder sb = new ServerBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb.http(8080);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb.annotatedService(new CustomService());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Server server = sb.build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CompletableFuture&lt;Void&gt; future = server.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future.join();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="run-again">Run again!<a href="https://armeria.dev/blog/2018/09/13/making-a-basic-server-with-java-armeria#run-again" class="hash-link" aria-label="Direct link to Run again!" title="Direct link to Run again!" translate="no">​</a></h2>
<p>Now run the code and open <a href="http://127.0.0.1:8080/" target="_blank" rel="noopener noreferrer" class="">http://127.0.0.1:8080/</a>.
You will see <code>"Hello Custom Service...!"</code> printed on the page.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/making-a-basic-server-with-java-armeria-8-0e388a130c6e1da91fa599abe2292ab3.png" width="576" height="246" class="img_ev3q"></p>
<p>This time, add <code>/page/10</code> to the URL to make it <a href="http://127.0.0.1:8080/page/10" target="_blank" rel="noopener noreferrer" class="">http://127.0.0.1:8080/page/10</a>, and open the page.
You will see <code>"Hello 10...!"</code> instead.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/making-a-basic-server-with-java-armeria-9-14d6092166514d80e35de57af09e460d.png" width="603" height="246" class="img_ev3q"></p>
<p>Using Armeria, implementing routing is a piece of cake!
Today, we've looked through the most basic way of using Armeria.
Armeria supports serving static files, running and calling Thrift services, structured logging with Kafka and many others.
Visit the <a href="https://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">official Armeria site</a> and the <a href="https://github.com/line/armeria" target="_blank" rel="noopener noreferrer" class="">GitHub repository</a> to learn more about Armeria.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/making-a-basic-server-with-java-armeria-10-719b12466c159ea32a06306171e69614.png" width="1552" height="1012" class="img_ev3q"></p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Applying CircuitBreaker to Channel Gateway]]></title>
            <link>https://armeria.dev/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway</link>
            <guid>https://armeria.dev/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway</guid>
            <pubDate>Thu, 04 Aug 2016 00:00:00 GMT</pubDate>
            <description><![CDATA[Before reading]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="before-reading">Before reading<a href="https://armeria.dev/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway#before-reading" class="hash-link" aria-label="Direct link to Before reading" title="Direct link to Before reading" translate="no">​</a></h2>
<p>If you have yet to read the introductory article to circuit breakers, I recommend you read the following article first: <a class="" href="https://armeria.dev/blog/2016/07/24/circuit-breakers-for-distributed-services">Circuit Breakers for distributed services</a></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="applying-circuitbreaker-to-channel-gateway">Applying CircuitBreaker to Channel Gateway<a href="https://armeria.dev/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway#applying-circuitbreaker-to-channel-gateway" class="hash-link" aria-label="Direct link to Applying CircuitBreaker to Channel Gateway" title="Direct link to Applying CircuitBreaker to Channel Gateway" translate="no">​</a></h2>
<p>Channel Gateway servers provide various LINE server features to content providers.
This is why Channel Gateway servers are highly affected by the servers they are connected to, with the effects easily spreading across all Channel Gateway servers.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/applying-circuitbreaker-to-channel-gateway-1-537a3aa178c1835906c7a42d541dac55.png" width="870" height="328" class="img_ev3q"></p>
<!-- -->
<p>It was when I was struggling to think of a solution to this problem that I first heard about circuit breakers.
Circuit breakers seem to be what I was looking for since they are able to detect a problem in certain servers, blocking all requests that the server would have otherwise received.
With that in mind, I decided to apply circuit breakers on Channel Gateway.</p>
<p>While I could have implemented my own circuit breakers on Channel Gateway, there were already excellent circuit breakers on <a href="http://line.github.io/armeria" target="_blank" rel="noopener noreferrer" class="">Armeria</a>.
Armeria enables you to set various options on circuit breakers when you implement them using <code>CircuitBreakerBuilder</code>, generating your own <code>CircuitBreaker</code> object as a result.
I was able to easily apply a customized circuit breaker on Channel Gateway thanks to this system.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="annotation-for-circuitbreaker">Annotation for CircuitBreaker<a href="https://armeria.dev/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway#annotation-for-circuitbreaker" class="hash-link" aria-label="Direct link to Annotation for CircuitBreaker" title="Direct link to Annotation for CircuitBreaker" translate="no">​</a></h2>
<p>I was able to apply <code>CircuitBreaker</code> to the talk-channel-gateway source code with a <code>@CircuitBreakable</code> annotation.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@CircuitBreakable(CircuitBreakerGroup.HBASE_CLIENT_USER_SETTINGS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public ChannelSettings findBy(String mid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>If applied like the example above, <code>CircuitBreaker</code> opens and closes depending on the results gathered while monitoring the successful/failed call attempts on the findBy() method.
HBASE_CLIENT_USER_SETTINGS is used to specify the groups grouped by <code>CircuitBreaker</code>, calculating the group's percentage of failed calls out of the successful calls on methods, and opening and closing along with <code>CircuitBreaker</code>.
You can change the options for <code>CircuitBreaker</code> with the enum object called <code>CircuitBreakerGroup</code> as shown below.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public enum CircuitBreakerGroup implements ExceptionFilter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SAMPLE_DEFAULT {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SAMPLE_API {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected ExceptionFilter exceptionFilter() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return cause -&gt; !(cause instanceof AuthenticationException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              || cause instanceof ApiPermissionException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              || cause instanceof ImproperRequestException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HBASE_CLIENT_CHANNEL_MATRIX {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HBASE_CLIENT_USER_SETTINGS {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected ExceptionFilter exceptionFilter() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return cause -&gt; true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CircuitBreaker circuitBreaker(CircuitBreakerListener listener) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new `CircuitBreakerBuilder`(name()).exceptionFilter(exceptionFilter())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .listener(listener)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean shouldDealWith(Throwable throwable) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return exceptionFilter().shouldDealWith(throwable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>I used a customized <code>ExceptionFilter</code> on Channel Gateway, while other options were kept at their default values from Armeria.
You can change options to your needs by modifying the <code>circuitBreaker()</code> method.</p>
<p>The default Armeria settings are set to identify any exception as a failure.
However, Channel Gateway also treats any unauthorized accesses as exceptions, and there needed to be a distinction between these and the relevant exceptions.
That's why I had to customize <code>ExceptionFilter</code>.
I also added an event listener for Channel Gateway so that logs would be recorded each time a change is detected in <code>CircuitBreaker</code>.</p>
<p>The groups applied to annotations can be specified using the enum object, and you can set different settings for each group when implementing the enum object.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="implementing-proceed-for-circuitbreaker">Implementing proceed() for CircuitBreaker<a href="https://armeria.dev/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway#implementing-proceed-for-circuitbreaker" class="hash-link" aria-label="Direct link to Implementing proceed() for CircuitBreaker" title="Direct link to Implementing proceed() for CircuitBreaker" translate="no">​</a></h2>
<p>The <code>proceed()</code> code for the <a href="https://en.wikipedia.org/wiki/aspectj" target="_blank" rel="noopener noreferrer" class="">Aspect</a> object is as shown below.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CircuitBreakerAspect implements Ordered {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Map&amp;lt;CircuitBreakerGroup, CircuitBreaker&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    circuitBreakers = new EnumMap&amp;lt;&gt;(CircuitBreakerGroup.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostConstruct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void initialize() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final CircuitBreakerListener listener = new</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CircuitBreakerListenerImpl(circuitBreakerLogger);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (CircuitBreakerGroup group : CircuitBreakerGroup.values()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            circuitBreakers.put(group, group.circuitBreaker(listener));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object proceed(final ProceedingJoinPoint pjp, final CircuitBreakable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    circuitBreakable) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final CircuitBreakerGroup group = circuitBreakable.value();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final CircuitBreaker circuitBreaker = circuitBreakers.get(group);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (circuitBreaker.canRequest()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Object result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = pjp.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (group.shouldDealWith(e)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    circuitBreaker.onFailure(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    circuitBreaker.onSuccess();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            circuitBreaker.onSuccess();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw CircuitBreakerException.circuitBroken();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The code itself is quite simple.
If <code>CircuitBreaker</code> is open through <code>CircuitBreaker.canRequest()</code>, an exception occurs.
If not, the method is called normally.
If the result of the call caused an exception, and the exception is identified as a failure, <code>CircuitBreaker</code> is notified that it's a failure.
If not, <code>CircuitBreaker</code> is notified that it's a success.</p>
<p>For you information, the actual code has code related to IMON Logger1 to check if <code>CircuitBreaker</code> is working as intended.
I omitted that feature from this article to focus more on <code>CircuitBreaker</code> only.</p>
<p><em>1 IMON Logger: IMON is a system LINE engineers use to monitor various company services.
IMON Logger collects the statistics and logs from these services and sends them to IMON.</em></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="methods-used-to-change-settings-for-circuitbreaker">Methods used to change settings for CircuitBreaker<a href="https://armeria.dev/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway#methods-used-to-change-settings-for-circuitbreaker" class="hash-link" aria-label="Direct link to Methods used to change settings for CircuitBreaker" title="Direct link to Methods used to change settings for CircuitBreaker" translate="no">​</a></h2>
<p><code>CircuitBreakerBuilder</code> provides many methods that you can use to build your own customized <code>CircuitBreaker</code>.
While I recommend using the default settings, here are some details for each setting to help you get a better idea about them.</p>
<table><thead><tr><th>Method</th><th>Parameter</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>failureRateThreshold</td><td>double</td><td>0.8</td><td>This is the failure rate used to determine whether CircuitBreaker should open or not. If the failure rate (during the duration of <code>counterSlidingWindow</code>) is higher than this value, CircuitBreaker opens. The default value is set to open CircuitBreaker if the failure rate is above 80%. In other words, CircuitBreaker opens if the success rate is below 20%.</td></tr><tr><td>minimumRequestThreshold</td><td>long</td><td>10</td><td>The minimum amount of call requests required to determine whether CircuitBreaker should open or not. If the number of requests (during the duration of <code>counterSlidingWindow</code>) is lower than this value, CircuitBreaker does not change its status.</td></tr><tr><td>circuitOpenWindow</td><td>Duration</td><td>10 seconds</td><td>The amount of time CircuitBreaker stays open before going into the half-open state. After CircuitBreaker has been open for the duration of <code>circuitOpenWindow</code>, CircuitBreaker will change its state to half-open and test requests again.</td></tr><tr><td>circuitOpenWindowMillis</td><td>long</td><td>10000</td><td></td></tr><tr><td>trialRequestInterval</td><td>Duration</td><td>3 seconds</td><td>The amount of time before a request is reattempted in the half-open state when the request does not get a closed response. If there is a response during <code>trialRequestInterval</code>, CircuitBreaker will change its state to open or closed depending on the result. If CircuitBreaker goes into the open state, the request will be reattempted after <code>circuitOpenWindow</code>. If the request does not get a response during <code>trialRequestInterval</code>, it will be reattempted.</td></tr><tr><td>trialRequestIntervalMillis</td><td>long</td><td>3000</td><td></td></tr><tr><td>counterSlidingWindow</td><td>Duration</td><td>20 seconds</td><td>Recent <code>counterSlidngWindow</code> values are used to determine whether CircuitBreaker should open or not. The default value is set to only recognize the requests received in the last 20 seconds.</td></tr><tr><td>counterSlidingWindowMillis</td><td>long</td><td>20000</td><td></td></tr><tr><td>counterUpdateInterval</td><td>Duration</td><td>1 second</td><td>CircuitBreaker stores request results through <code>SlidingWindowCounter</code>, and <code>counterUpdateInterval</code> is the unit of time stored. The default value is set to keep records per each second. An example of this would look like this: 20 second(s) before = Success 20, Failure 0 / 19 second(s) before = Success 25, Failure 1 / ... / 1 second(s) before = Success 21, Failure 0. The failure rate is calculated using these records from the duration of counterSlidingWindow.</td></tr><tr><td>counterUpdateIntervalMillis</td><td>long</td><td>1000</td><td></td></tr><tr><td>exceptionFilter</td><td>ExceptionFilter</td><td>cause -&gt; true</td><td>An object that returns whether or not an exception is identified as a failure. The default value is set to identify all exceptions as failures.</td></tr><tr><td>listener</td><td>CircuitBreakerListener</td><td></td><td>A listener that receives events whenever the state of CircuitBreaker changes, when <code>counterUpdateInterval</code> expires, or when an open CircuitBreaker rejects a request.</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="closing-words">Closing words<a href="https://armeria.dev/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway#closing-words" class="hash-link" aria-label="Direct link to Closing words" title="Direct link to Closing words" translate="no">​</a></h2>
<p>Up until recently, whenever there was a problem somewhere in Channel Gateway the damage was already done by the time we could actually do something about it.
A partial outage could cause the entire thread to be full, eventually affecting all services.
Now that we have <code>CircuitBreaker</code> blocking the problematic parts from the rest of the system, we have a wider time window to work with.</p>
<p>To wrap up this article, I'd like to go through how <code>CircuitBreaker</code> works step by step.</p>
<ul>
<li class="">The initial state of <code>CircuitBreaker</code> is <em>Closed</em>.</li>
<li class=""><em>Closed</em>: Depending on <code>ExceptionFilter</code> settings, the following will happen after a request is processed.<!-- -->
<ul>
<li class="">If the result is a success, it will be logged as a success and the state changes to <em>Closed</em>.</li>
<li class="">If the result is a failure, the requests during the duration of <code>counterSlidingWindow</code> are checked and<!-- -->
<ul>
<li class="">If requests are more than <code>minimumRequestThreshold</code>, and the failure rate is above <code>failureRateThreshold</code>, the state changes to <em>Open</em>.</li>
<li class="">If not, the state remains <em>Closed</em>.</li>
</ul>
</li>
</ul>
</li>
<li class=""><em>Open</em>: After the duration of <code>circuitOpenWindow</code> passes, the state changes to <em>Half-Open</em>.</li>
<li class=""><em>Half-Open</em>: Depending on <code>ExceptionFilter</code> settings, the following will happen after processing the first request received.<!-- -->
<ul>
<li class="">If the result is a success, the state changes to <em>Closed</em>.</li>
<li class="">If the result is a failure, the state changes to <em>Open</em>.</li>
<li class="">If there is no response during the duration of <code>trialRequestInterval</code>, a branch will occur depending on the result of the first request received during the <em>Half-Open</em> state.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="about-the-author">About the author<a href="https://armeria.dev/blog/2016/08/04/applying-circuitbreaker-to-channel-gateway#about-the-author" class="hash-link" aria-label="Direct link to About the author" title="Direct link to About the author" translate="no">​</a></h2>
<p>Shin, Jong Hun: I don't like being inconvenienced.
One of the focal points of my work is to reduce these inconveniences so I have more time to focus on what matters.
I think that's why I like programming.
Although I can't really figure out why I seem to be getting busier with time...</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Circuit breakers for distributed services]]></title>
            <link>https://armeria.dev/blog/2016/07/24/circuit-breakers-for-distributed-services</link>
            <guid>https://armeria.dev/blog/2016/07/24/circuit-breakers-for-distributed-services</guid>
            <pubDate>Sun, 24 Jul 2016 00:00:00 GMT</pubDate>
            <description><![CDATA[Hello, my name is Ono and I'm a LINE engineer.]]></description>
            <content:encoded><![CDATA[<p>Hello, my name is Ono and I'm a LINE engineer.
In this blog post, I'd like to talk about "circuit breakers" which we use with our LINE servers.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="what-is-a-circuit-breaker">What is a Circuit Breaker?<a href="https://armeria.dev/blog/2016/07/24/circuit-breakers-for-distributed-services#what-is-a-circuit-breaker" class="hash-link" aria-label="Direct link to What is a Circuit Breaker?" title="Direct link to What is a Circuit Breaker?" translate="no">​</a></h2>
<p>The backend server systems for various web services and apps including LINE consist of networks that have several services connected with each other through APIs and RPCs.</p>
<p>What would happen if one of these networks suddenly failed to respond?
The downed services would be blocked until they time-out, and all other services that rely on the blocked service would start a chain reaction of failures.
If no one has been keeping an eye on the entire network, it will take a long time to figure out which service is the root cause.</p>
<p><img decoding="async" loading="lazy" alt="-BG-" src="https://armeria.dev/assets/images/circuit-breakers-for-distributed-services-1-5bb7df69bbea59e475a05522088cd493.png" width="537" height="141" class="img_ev3q"></p>
<!-- -->
<p>These chain reaction failures should be prevented at all costs.
At the least, the core features must be protected from these failures.
To achieve that, we must block off access to the downed service before it affects another.</p>
<p><img decoding="async" loading="lazy" alt="-BG-" src="https://armeria.dev/assets/images/circuit-breakers-for-distributed-services-2-94100185efcea1b197617840a9c6a288.png" width="537" height="140" class="img_ev3q"></p>
<p>Circuit breakers are used to automate this whole process.</p>
<p>[<a href="http://martinfowler.com/bliki/CircuitBreaker.html" target="_blank" rel="noopener noreferrer" class="">http://martinfowler.com/bliki/CircuitBreaker.html</a>]</p>
<p>The in-depth details behind the system can be found in the post above by Martin Fowler, but I'll keep it brief here.</p>
<p>A circuit breaker is a system that automatically blocks off access when the number of failed remote access attempts exceeds the failure rate.</p>
<p>Circuit breakers can be seen as state machines.
They can automatically detect failures and determine when they're restored by continuously updating access success and failure events.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-for-distributed-services-3-706b943b1852878bf1209d68ac7ca623.png" width="749" height="182" class="img_ev3q"></p>
<p>Below are details for each state and their conditions.</p>
<p><strong>CLOSED</strong><br>
<!-- -->Initial state.
All accesses are treated normally.</p>
<p><strong>OPEN</strong><br>
<!-- -->The state changes to OPEN once the number of failures exceeds the failure rate.
All accesses are blocked off (fail fast).</p>
<p><strong>HALF_OPEN</strong><br>
<!-- -->After a certain amount of time in the OPEN state, it changes into the HALF_OPEN state.
If an attempted access succeeds, the state changes to CLOSED.
If access fails, the state changes to OPEN.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="circuit-breakers-for-armeria">Circuit breakers for Armeria<a href="https://armeria.dev/blog/2016/07/24/circuit-breakers-for-distributed-services#circuit-breakers-for-armeria" class="hash-link" aria-label="Direct link to Circuit breakers for Armeria" title="Direct link to Circuit breakers for Armeria" translate="no">​</a></h2>
<p><a href="http://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a> is an asynchronous Thrift client/server library based on Netty, released as a LINE open source project.
One of Armeria's many key features is its ability to expand features using decorators.</p>
<p>Starting with version 0.13.0 of Armeria, it is possible to add circuit breakers using decorators.</p>
<p>Below is an example of initializing a Thrift client using a circuit breaker.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Iface helloClient = new ClientBuilder("tbinary+http://127.0.0.1:8080/hello")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     .decorator(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      CircuitBreakerClient.newDecorator(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          new CircuitBreakerBuilder("hello").build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     .build(Iface.class);</span><br></span></code></pre></div></div>
<p>Easy, right?</p>
<p>Below is the code for calling this Thrift client.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    helloClient.hello("line");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} catch (TException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // error handling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} catch (FailFastException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // fallback code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>As you can see in the example above, when the circuit breaker detects a failure, the Thrift client will send a FailFastException, running the appropriate fallback code.
It can be used in the same way for an asynchronous client.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helloClient.hello("line", new AsyncMethodCallback() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void onComplete(Object response) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     // response handling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void onError(Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     if (e instanceof TException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         // error handling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     } else if (e instanceof FailFastException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         // fallback code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="grouping">Grouping<a href="https://armeria.dev/blog/2016/07/24/circuit-breakers-for-distributed-services#grouping" class="hash-link" aria-label="Direct link to Grouping" title="Direct link to Grouping" translate="no">​</a></h2>
<p>In the example above, a single circuit breaker was allocated for each Thrift service.
In this case, if a single method causes a problem in a service, all other methods will be blocked when the circuit breaker becomes active.
This would only spread the failure to more parts, and isn't something that is recommended.</p>
<p>That's why Armeria lets its users group the range of circuit breaker instances in a variety of ways.</p>
<p>Below are the grouping conditions.</p>
<p><strong>Per Host</strong><br>
<!-- -->A single circuit breaker is allocated for each remote host.</p>
<p><strong>Per Method</strong><br>
<!-- -->A single circuit breaker is allocated for each method.</p>
<p><strong>Per Host and Method</strong><br>
<!-- -->A single circuit breaker is allocated each method in each host.</p>
<p><img decoding="async" loading="lazy" alt="-BG-" src="https://armeria.dev/assets/images/circuit-breakers-for-distributed-services-4-4ae96ba1d797e52c0fc3b3f1f3909775.png" width="684" height="279" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="failure-rate">Failure Rate<a href="https://armeria.dev/blog/2016/07/24/circuit-breakers-for-distributed-services#failure-rate" class="hash-link" aria-label="Direct link to Failure Rate" title="Direct link to Failure Rate" translate="no">​</a></h2>
<p>When using circuit breakers, it's important to clearly define the conditions for a failure.</p>
<p>Failures in Armeria are when the number of failed requests (failure rate) exceeds the <em>Failure Rate Threshold</em>.</p>
<p>However, in cases where there are too few requests, (such as right after launching) the failure rate will be too irregular and the system may incorrectly assess the situation as a failure.
To resolve this, you can set a <em>Minimum Request Threshold</em> so that the system only begins to detect failures when the number of requests is at least at a certain amount.</p>
<p>The duration of the time where detection begins can also be adjusted with the <em>Sliding Window</em>.</p>
<p>The correlation between the failure rate and the sliding window can be seen in the figure below.</p>
<p><img decoding="async" loading="lazy" alt="-BG-" src="https://armeria.dev/assets/images/circuit-breakers-for-distributed-services-5-2ff3131f0701105e189fa5953d2d9c1e.png" width="585" height="277" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="monitoring">Monitoring<a href="https://armeria.dev/blog/2016/07/24/circuit-breakers-for-distributed-services#monitoring" class="hash-link" aria-label="Direct link to Monitoring" title="Direct link to Monitoring" translate="no">​</a></h2>
<p>You can monitor the status of circuit breakers by adding a listener.</p>
<p>Below is sample code using a listener based on Dropwizard Metrics provided by Armeria.
You can implement listeners that match your customized monitoring system.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MetricRegistry registry = new MetricRegistry();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Iface helloClient = new ClientBuilder("tbinary+http://127.0.0.1:8080/hello")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .decorator(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CircuitBreakerClient.newDecorator(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          new CircuitBreakerBuilder("hello")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .listener(new DropwizardMetricsCircuitBreakerListener(registry, "hello"))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .build(Iface.class);</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="using-armerias-circuit-breaker-independently">Using Armeria's circuit breaker independently<a href="https://armeria.dev/blog/2016/07/24/circuit-breakers-for-distributed-services#using-armerias-circuit-breaker-independently" class="hash-link" aria-label="Direct link to Using Armeria's circuit breaker independently" title="Direct link to Using Armeria's circuit breaker independently" translate="no">​</a></h2>
<p>Up to this point, I've talked about how you can combine the Armeria thrift client and circuit breaker package, but it's also possible to use the circuit breaker package independently.</p>
<p>When using the circuit breaker package independently, keep the following 3 APIs in mind.</p>
<p><strong>CircuitBreaker#canRequest()</strong><br>
<!-- -->Checks the status of the circuit breaker.
If the circuit is blocked off, the returned value will be "false."</p>
<p><strong>CircuitBreaker#onSuccess()</strong><br>
<!-- -->Records successful access attempts to a service.</p>
<p><strong>CircuitBreaker#onFailure() or CircuitBreaker#onFailure(Throwable t)</strong><br>
<!-- -->Records failed access attempts to a service.</p>
<p>In the sample code below, canRequest() checks the status of the circuit and runs remote service access if there are no problems detected.
Depending on the result, the API will call onSuccess or onFailure.</p>
<p>The trigger condition for this sample was set to "whether or not exceptions were detected," but you can change the condition to whatever fits your needs.
For example, you can make it so that it counts as an error if remote service access took a certain amount of time even if there were no exceptions detected.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if (circuitBreaker.canRequest()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // remote service access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       circuitBreaker.onSuccess();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       circuitBreaker.onFailure(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // fail fast</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>This concludes my introduction to the circuit breaker feature in Armeria.</p>
<p>In a future post, I plan to give you some real-life use cases from inside LINE.</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Open-sourcing Armeria]]></title>
            <link>https://armeria.dev/blog/2016/04/13/open-sourcing-armeria</link>
            <guid>https://armeria.dev/blog/2016/04/13/open-sourcing-armeria</guid>
            <pubDate>Wed, 13 Apr 2016 00:00:00 GMT</pubDate>
            <description><![CDATA[Armeria is an asynchronous RPC/API client-server implementation built on top of Java 8 and Netty that went open-source last November under Apache License 2.0 by LINE Corporation.]]></description>
            <content:encoded><![CDATA[<p><a href="http://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a> is an asynchronous RPC/API client-server implementation built on top of Java 8 and <a href="http://netty.io/" target="_blank" rel="noopener noreferrer" class="">Netty</a> that went open-source last November under Apache License 2.0 by LINE Corporation.
Its primary goal is to help engineers build high-performance asynchronous Thrift clients and servers that use HTTP/2 as a session layer protocol, although it is designed to be protocol-agnostic and highly extensible (for example, you can serve a directory of static files via HTTP/2 and run Java EE web applications).</p>
<!-- -->
<p>In this post, I'd like to focus on the steps that were taken to open-source an internal project rather than the technical aspect.
If you are interested in the technical details of Armeria, you might want to check out the following slides presented last February during the 14th LINE Developer Meetup:</p>
<!-- -->
<div class="deck-embed js-deck-embed" style="aspect-ratio:1024/640" data-ratio="1.6" data-state="processed"><div class="speakerdeck-embed" data-title="false" data-skip-resize="true" data-id="8d645c29ce33400e8360e61fd0250f91" data-name="Armeria: LINE's next generation RPC layer" data-ratio="1.6" data-host="speakerdeck.com"></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="cleaning-up-the-project-history">Cleaning up the project history<a href="https://armeria.dev/blog/2016/04/13/open-sourcing-armeria#cleaning-up-the-project-history" class="hash-link" aria-label="Direct link to Cleaning up the project history" title="Direct link to Cleaning up the project history" translate="no">​</a></h2>
<p>When you work on an internal project, it is very likely that the project contains changesets you wouldn't have published if they were public from day 1, such as:</p>
<ul>
<li class="">Confidential information (Such as issue numbers, host names, internal URLs)</li>
<li class="">Commit messages that are meaningless or written in poor taste ("Blah", "WIP", "WTF")</li>
<li class="">Copyright headers</li>
</ul>
<p>It is obviously not an option to append an amending commit to the repository, because the history of the project would still be preserved.
We need to clean up the history so that it does not leak anything unexpected.
There are basically two options for this.</p>
<p>One option is to review each changeset and amend it individually.
Although you can reduce the amount of effort by using automation such as the <a href="https://git-scm.com/docs/git-filter-branch" target="_blank" rel="noopener noreferrer" class=""><code>git filter-branch</code></a> command, you'll basically have to review every changeset carefully.
The other option is to hide any unwanted information and collapse all changesets into a single commit.
This is much simpler than the first option, but you will lose the history.
Someday, you may wonder why you wrote a piece of code in a certain way, but you'll have no clue because the history has been squashed away.</p>
<p>If the project history is relatively short and you are sure your coding standards are pretty high, you might want to choose the first option.
Otherwise, if your time is limited and there's too much stuff to review, you would want to push the big red button like we did - squashing the history into a single commit.</p>
<p>However, code is not written by a single person nowadays.
If we just make a single commit, how would we credit the people who participated in this collaborative effort of fine workmanship?
We ended up crediting them in our commit message.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Subject: Initial import</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This commit contains the collective work of the following enthusiastic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contributors at LINE Corporation:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Anuraag Agrawal  @anuraaga</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Heon Jeong       @blmarket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Young-tae Seok   @delegacy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Su-ahn Lee       @inch772</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Woo-jung Choi    @sophiechoi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Trustin Lee      @trustin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Yuichi Ono</span><br></span></code></pre></div></div>
<p>Looking back, I should have expressed more appreciation into the commit message.
I can't thank you enough, folks!</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="writing-api-documentation">Writing API documentation<a href="https://armeria.dev/blog/2016/04/13/open-sourcing-armeria#writing-api-documentation" class="hash-link" aria-label="Direct link to Writing API documentation" title="Direct link to Writing API documentation" translate="no">​</a></h2>
<p>When starting a project from scratch, especially one with no real template to follow, it is important to write code fast and get it out fast to find design issues and bugs.
APIs change fast in the early stages and it can be convenient to leave out API documentation to focus on implementation, leaving some holes that need to be filled later (of course, we also find it much more fun to write code than documentation).</p>
<p>However, good documentation is one of the critical factors of adoption in the open-source scene.
It's only when we are very desperate when we consider to use undocumented open-source software.
Why would people use our open-source project if it is not documented well?
There are already so many similar projects in the wild!</p>
<p>So, we had to fill all the holes we left open.
We could call it "documentation debt" and we must admit that paying it back was not the most pleasing experience.
Now that we have documented everything properly, it is very easy to keep the documentation debt low by making sure any new public methods and classes are documented properly during the review process.
It's like keeping your body fit; it's easier once you're fit.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="building-a-website">Building a website<a href="https://armeria.dev/blog/2016/04/13/open-sourcing-armeria#building-a-website" class="hash-link" aria-label="Direct link to Building a website" title="Direct link to Building a website" translate="no">​</a></h2>
<p>Although Github is a good starting point for hosting a project, it is almost always better to provide a dedicated website.
In a dedicated project website, we can organize the information we want to provide in the way we want and express the identity of the project in a more visually appealing way.</p>
<p>However, building a website is not a simple job and we did not want to spend more time than writing a few lines of code to maintain it; we needed a scalable way to write and maintain it.</p>
<p>Fortunately, some engineers have open-sourced great website generation tools that help us deal with HTML and CSS, so we can bug our designers less often.
We chose <a href="http://www.sphinx-doc.org/en/stable/" target="_blank" rel="noopener noreferrer" class="">Sphinx</a> in conjunction with <a href="http://trustin.github.io/sphinx-maven-plugin/" target="_blank" rel="noopener noreferrer" class="">sphinx-maven-plugin</a> and <a href="http://read-the-docs.readthedocs.org/en/latest/" target="_blank" rel="noopener noreferrer" class="">Read the Docs theme</a> so that we can generate our website as a part of the build process.
There are also many other tools that serve similar purposes, such as <a href="http://awestruct.org/" target="_blank" rel="noopener noreferrer" class="">Awestruct</a> and <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer" class="">Jekyll</a>, so you might want to play with them and choose what fits you if you are interested in building a website.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="designing-a-logo">Designing a logo<a href="https://armeria.dev/blog/2016/04/13/open-sourcing-armeria#designing-a-logo" class="hash-link" aria-label="Direct link to Designing a logo" title="Direct link to Designing a logo" translate="no">​</a></h2>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/open-sourcing-armeria-1-89b68e7649f79147f589aed590d59639.png" width="938" height="811" class="img_ev3q"></p>
<p>The Armeria logo</p>
<p>A logo is like the essence of a project.
It visualizes and symbolizes what the project is and where it is going.
It also helps people remember the project via association.</p>
<p>Because of its impact on a project, it requires a designer to contemplate and iterate over many prototypes.
We fortunately had a new member with an industrial design degree who joined us at just the right time.
We really appreciate her for helping us in her spare time, and we believe her next logo will be fascinating as well!</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="im-not-a-lawyer-but-legal-stuff-matters">I'm not a lawyer but legal stuff matters<a href="https://armeria.dev/blog/2016/04/13/open-sourcing-armeria#im-not-a-lawyer-but-legal-stuff-matters" class="hash-link" aria-label="Direct link to I'm not a lawyer but legal stuff matters" title="Direct link to I'm not a lawyer but legal stuff matters" translate="no">​</a></h2>
<p>The notion of open-source software has been around since the beginning of computing, but it hasn't been very long since open-source licensing caught our attention.
Some people overlook the fact that an open source project is still owned by someone even if it is free to use.
To avoid any potential legal issues, what we did first was to make sure that we do not violate the license terms of the open-source software projects Armeria depends on.</p>
<p>For instance, we included all the license agreement files and their summaries into our repository so that our users are informed about what software Armeria depends on.
We also explicitly mentioned what portions of other open-source software have been modified and redistributed in Armeria.</p>
<p>On the other hand, Armeria is also an open source project with an owner, so we licensed it to its users under fair and clear terms as well.
We chose <a href="https://tldrlegal.com/license/apache-license-2.0-(apache-2.0)" target="_blank" rel="noopener noreferrer" class="">Apache License 2.0</a> over other open source licenses because of the following notable features:</p>
<ul>
<li class="">Software licensed under Apache License 2.0 may be freely used, reproduced, modified, distributed or sold without accompanying the corresponding source code.</li>
<li class="">It contains a provision that states the conditions of the granting and infringement of patent licenses.</li>
</ul>
<p>Another important thing people often miss out is the contributor license agreement (CLA) which is required when accepting an external contribution.
When someone outside your company sends a pull request for a very cool feature you feel like merging immediately, you'd better make sure the submitter of the pull request has signed the contributor license agreement.
It's outside the scope of this post to explain what exactly CLA is, but you can find detailed explanations on <a href="http://oss-watch.ac.uk/resources/cla" target="_blank" rel="noopener noreferrer" class="">OSS Watch</a> and <a href="https://www.clahub.com/pages/why_cla" target="_blank" rel="noopener noreferrer" class="">CLAHub</a>.</p>
<p>All these steps are seemingly time-consuming and painful, but it wasn't anything like that in reality.
They are mostly one-time things, and our friendly folks at the legal department freed us from the hassles of dealing with legal issues we would have had to deal with by ourselves otherwise.
When you are in doubt, just find your legal department; we are not lawyers!</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="working-with-other-open-source-projects">Working with other open-source projects<a href="https://armeria.dev/blog/2016/04/13/open-sourcing-armeria#working-with-other-open-source-projects" class="hash-link" aria-label="Direct link to Working with other open-source projects" title="Direct link to Working with other open-source projects" translate="no">​</a></h2>
<p>You may sometimes find bugs in an open-source project you depend on.
Sometimes it can be worked around, but sometimes it can't.
You could keep the fix in your own fork of the project, but it's almost always better to propose a change upstream so that you do not need to maintain it by yourself indefinitely.
Contributing upstream also increases your visibility to the open-source scene and you will find yourself having fun collaborating with others, both of which are very positive to your career.</p>
<p>While developing Armeria, we reported various issues and contributed some of their fixes to the <a href="http://netty.io/" target="_blank" rel="noopener noreferrer" class="">Netty</a> project:</p>
<ul>
<li class="">HTTP/1 and 2<!-- -->
<ul>
<li class=""><a href="https://github.com/netty/netty/pull/4785" target="_blank" rel="noopener noreferrer" class="">#4785</a> - Fix missing trailing data on HTTP client upgrade</li>
<li class=""><a href="https://github.com/netty/netty/pull/4582" target="_blank" rel="noopener noreferrer" class="">#4582</a> - Revamp InboundHttp2ToHttpAdapter builder API</li>
<li class=""><a href="https://github.com/netty/netty/pull/4574" target="_blank" rel="noopener noreferrer" class="">#4574</a> - Revamp the Http2ConnectionHandler builder API</li>
<li class=""><a href="https://github.com/netty/netty/pull/4525" target="_blank" rel="noopener noreferrer" class="">#4525</a> - Fix the incorrect usage/value of "Connection: upgrade"</li>
<li class=""><a href="https://github.com/netty/netty/pull/4524" target="_blank" rel="noopener noreferrer" class="">#4524</a> - Fix IllegalReferenceCountException caused by HttpClientCodec.upgradeFrom()</li>
<li class=""><a href="https://github.com/netty/netty/pull/4523" target="_blank" rel="noopener noreferrer" class="">#4523</a> - Relax the sanity check in HttpClientUpgradeHandler</li>
<li class=""><a href="https://github.com/netty/netty/pull/4428" target="_blank" rel="noopener noreferrer" class="">#4428</a> - Reject the first SETTINGS ack on HTTP/2 Preface</li>
<li class=""><a href="https://github.com/netty/netty/pull/4210" target="_blank" rel="noopener noreferrer" class="">#4210</a> - Http2ConnectionHandler does not close the stream 1 (HTTP_UPGRADE_STREAM_ID)</li>
<li class=""><a href="https://github.com/netty/netty/pull/3876" target="_blank" rel="noopener noreferrer" class="">#3876</a> - Lazily instantiate HttpServerUpgradeHandler.UpgradeCodec</li>
</ul>
</li>
<li class="">DNS<!-- -->
<ul>
<li class=""><a href="https://github.com/netty/netty/pull/4946" target="_blank" rel="noopener noreferrer" class="">#4946</a> - Fix potential infinite loop when resolving CNAME records</li>
<li class=""><a href="https://github.com/netty/netty/pull/4837" target="_blank" rel="noopener noreferrer" class="">#4837</a> - Preserve the host name of address when parsing /etc/hosts file</li>
<li class=""><a href="https://github.com/netty/netty/pull/4665" target="_blank" rel="noopener noreferrer" class="">#4665</a> - Netty's DNS resolution should take into account system domain name</li>
<li class=""><a href="https://github.com/netty/netty/pull/4541" target="_blank" rel="noopener noreferrer" class="">#4541</a> - Don't cycle dns servers while cycling dns record types.</li>
</ul>
</li>
<li class="">Miscellaneous<!-- -->
<ul>
<li class=""><a href="https://github.com/netty/netty/pull/4547" target="_blank" rel="noopener noreferrer" class="">#4547</a> - NPE in PooledByteBufAllocator.newDirectBuffer()</li>
<li class=""><a href="https://github.com/netty/netty/pull/4419" target="_blank" rel="noopener noreferrer" class="">#4419</a> - Fix a bug where DefaultPromise.toString() says "incomplete" when it's done</li>
</ul>
</li>
</ul>
<p>By working closely with the projects Armeria depends on, we were able to reduce the burden of maintaining a fork and increase the visibility of Armeria itself and its project members in the open-source community.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="please-join-us">Please join us!<a href="https://armeria.dev/blog/2016/04/13/open-sourcing-armeria#please-join-us" class="hash-link" aria-label="Direct link to Please join us!" title="Direct link to Please join us!" translate="no">​</a></h2>
<p>Did you find our story about contributing our work to the community and working with other projects interesting?
Armeria is still in its early stages, and we have various new features in our roadmap, such as:</p>
<ul>
<li class="">Client-side load balancing</li>
<li class="">Large content streaming via reactive streams</li>
<li class="">Support for more protocols such as Redis and MySQL</li>
<li class="">Integrated web-based administrative and monitoring console</li>
<li class="">New Thrift compiler for better documentation and code generation</li>
</ul>
<p>We also have a few more projects in our open-sourcing pipeline and we encourage our engineers to build something that could be useful to more people in the longer term rather than just serving our own immediate purpose.
Please apply to join us in building something fascinating that could impress the world!</p>
<p><a href="http://recruit.linepluscorp.com/lineplus/career/detail/20000312" target="_blank" rel="noopener noreferrer" class="">Job opening</a> (Scroll down for English)</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="about-the-author">About the author<a href="https://armeria.dev/blog/2016/04/13/open-sourcing-armeria#about-the-author" class="hash-link" aria-label="Direct link to About the author" title="Direct link to About the author" translate="no">​</a></h2>
<p><a href="https://github.com/trustin" target="_blank" rel="noopener noreferrer" class="">Trustin Lee</a> is a platform software engineer at LINE.
He is also the founder of <a href="http://netty.io/" target="_blank" rel="noopener noreferrer" class="">Netty</a> and a co-founder of <a href="http://mina.apache.org/" target="_blank" rel="noopener noreferrer" class="">Apache MINA</a>.</p>]]></content:encoded>
        </item>
    </channel>
</rss>