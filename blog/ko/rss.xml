<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Armeria Blog - Korean</title>
        <link>https://armeria.dev/blog/ko</link>
        <description></description>
        <lastBuildDate>Thu, 15 Jul 2021 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <copyright>© 2015-2026, LY Corporation</copyright>
        <item>
            <title><![CDATA[Armeria 지표 커스터마이징하기]]></title>
            <link>https://armeria.dev/blog/ko/2021/07/15/customizing-armeria-metrics</link>
            <guid>https://armeria.dev/blog/ko/2021/07/15/customizing-armeria-metrics</guid>
            <pubDate>Thu, 15 Jul 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[시작하며]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="시작하며">시작하며<a href="https://armeria.dev/blog/ko/2021/07/15/customizing-armeria-metrics#%EC%8B%9C%EC%9E%91%ED%95%98%EB%A9%B0" class="hash-link" aria-label="Direct link to 시작하며" title="Direct link to 시작하며" translate="no">​</a></h2>
<p>이전 글 <a class="" href="https://armeria.dev/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria">Armeria에서 Prometheus 지표 모니터링하기</a>에서 Armeria 지표를 Grafana로 모니터링하는 방법을 살펴봤습니다.
이번 글에는 Armeria에서 필요에 따라 지표를 커스터마이징하는 방법을 알아보겠습니다.</p>
<!-- -->
<blockquote>
<p>이번 글에서 사용한 코드는 <a class="" href="https://armeria.dev/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria">Armeria에서 Prometheus 지표 모니터링하기</a> 글의 예제 코드를 재사용했습니다.</p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="meteridprefixfunction-이용해-지표-프리픽스-이름-커스터마이징하기">MeterIdPrefixFunction 이용해 지표 프리픽스 이름 커스터마이징하기<a href="https://armeria.dev/blog/ko/2021/07/15/customizing-armeria-metrics#meteridprefixfunction-%EC%9D%B4%EC%9A%A9%ED%95%B4-%EC%A7%80%ED%91%9C-%ED%94%84%EB%A6%AC%ED%94%BD%EC%8A%A4-%EC%9D%B4%EB%A6%84-%EC%BB%A4%EC%8A%A4%ED%84%B0%EB%A7%88%EC%9D%B4%EC%A7%95%ED%95%98%EA%B8%B0" class="hash-link" aria-label="Direct link to MeterIdPrefixFunction 이용해 지표 프리픽스 이름 커스터마이징하기" title="Direct link to MeterIdPrefixFunction 이용해 지표 프리픽스 이름 커스터마이징하기" translate="no">​</a></h2>
<p>이전 글에서 <code>MeterIdPrefixFunction#ofDefault</code> 함수를 이용해 지표의 기본 프리픽스 이름을 설정할 수 있다는 것을 말씀드렸는데요. 이때 <code>MeterIdPrefixFunction#andThen</code> 함수를 이용하면 이 프리픽스 이름을 더욱 다양하게 커스터마이징할 수 있습니다.</p>
<p>HTTP 메서드 이름을 메트릭의 프리픽스 이름으로 추가하고 싶다고 가정해보겠습니다.</p>
<ul>
<li class="">AS-IS: <code>my_http_service</code></li>
<li class="">TO-BE: <code>my_http_service_{HTTP method}</code></li>
</ul>
<p>먼저 <code>MeterIdPrefixFunctionCustomizer</code>를 구현한 클래스를 생성해야 합니다. <code>MeterIdPrefixFunctionCustomizer#apply</code> 함수 안에서 기존 <code>MeterIdPrefix</code>에 HTTP 메서드 이름을 추가하도록 구현했습니다.</p>
<p>이때 <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/logging/RequestOnlyLog.html#requestHeaders()" target="_blank" rel="noopener noreferrer" class="">RequestLog#requestHeaders</a>를 통해 요청 HTTP 메서드 이름을 가져올 수 있습니다. <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/logging/RequestLog.html" target="_blank" rel="noopener noreferrer" class="">RequestLog</a>에는 이외에도 하나의 요청을 처리하면서 발생하는 다양한 정보들이 수집되는데요. 자세한 내용은 <a href="https://armeria.dev/docs/advanced-structured-logging/" target="_blank" rel="noopener noreferrer" class="">Armeria 공식 블로그</a>에서 확인하실 수 있습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">MeterIdPrefixFunctionCustomizer.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MyMeterIdPrefixFunction</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">implements</span><span class="token plain"> </span><span class="token class-name">MeterIdPrefixFunctionCustomizer</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">MeterIdPrefix</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterRegistry</span><span class="token plain"> registry</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">RequestOnlyLog</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">MeterIdPrefix</span><span class="token plain"> meterIdPrefix</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> meterIdPrefix</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">requestHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">method</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>다음으로 <code>MeterIdPrefixFunction#andThen</code> 함수로 이 클래스의 인스턴스를 넣습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">ServerBuilder</span><span class="token plain"> sb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">http</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8083</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">meterRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meterRegistry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">annotatedService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/metrics"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MetricCollectingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.http.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                  </span><span class="token comment" style="color:#999988;font-style:italic">// 추가</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">andThen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyMeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Server</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ... 생략 ...</span><br></span></code></pre></div></div>
<p>서버를 재기동한 뒤 살펴보면 지표 이름에 HTTP 메서드 이름이 잘 추가된 것을 확인할 수 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -s http://localhost:8083/metrics | grep "my_http_service_"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP my_http_service_GET_timeouts_total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE my_http_service_GET_timeouts_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_timeouts_total{cause="RequestTimeoutException",hostname_pattern="*",http_status="500",method="hello",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_timeouts_total{cause="RequestTimeoutException",hostname_pattern="*",http_status="200",method="hello",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP my_http_service_GET_active_requests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE my_http_service_GET_active_requests gauge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_active_requests{hostname_pattern="*",method="hello",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre></div></div>
<p>다른 방법으로, 아래와 같이 Java 8부터 지원되는 람다(lambda) 표현식을 이용해 바로 추가할 수도 있습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">MeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.http.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">andThen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">registry</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> prefix</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> prefix</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">requestHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">method</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="http-api-응답-성공-기준-커스터마이징하기">HTTP API 응답 성공 기준 커스터마이징하기<a href="https://armeria.dev/blog/ko/2021/07/15/customizing-armeria-metrics#http-api-%EC%9D%91%EB%8B%B5-%EC%84%B1%EA%B3%B5-%EA%B8%B0%EC%A4%80-%EC%BB%A4%EC%8A%A4%ED%84%B0%EB%A7%88%EC%9D%B4%EC%A7%95%ED%95%98%EA%B8%B0" class="hash-link" aria-label="Direct link to HTTP API 응답 성공 기준 커스터마이징하기" title="Direct link to HTTP API 응답 성공 기준 커스터마이징하기" translate="no">​</a></h2>
<p>Armeria에서는 기본적으로 HTTP API의 응답 상태 코드가 100보다 작거나, 400보다 크거나 같은 경우에 실패로 간주하고 있습니다. 이때 <code>MetricCollectingServiceBuilder#successFunction</code>를 이용하면, 응답 성공과 실패의 기준을 내가 원하는 대로 재정의할 수 있습니다.</p>
<p>먼저 API에서 404 상태 코드로 응답한 상황을 가정해 보겠습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">MyAnnotatedService.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MyAnnotatedService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/hello/{seq}"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"seq"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> seq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">NOT_FOUND</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ... 생략 ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl http://localhost:8083/hello/5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">404 Not Found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -s http://localhost:8083/metrics | grep "my_http_service_GET_requests_total" | grep "404"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_requests_total{hostname_pattern="*",http_status="404",method="hello",result="success",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_requests_total{hostname_pattern="*",http_status="404",method="hello",result="failure",service="com.example.armeria_prometheus.MyAnnotatedService",} 1.0</span><br></span></code></pre></div></div>
<p>만약 404 상태 코드를 실패가 아닌 성공으로 처리하고 싶다면, <a href="https://javadoc.io/static/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/logging/RequestLog.html#responseHeaders()" target="_blank" rel="noopener noreferrer" class="">RequestLog#responseHeaders</a>에서 HTTP 상태를 가져와서 아래와 같이 <code>MetricCollectingServiceBuilder#successFunction</code>을 구현하면 됩니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ... 생략 ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MetricCollectingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.http.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">andThen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyMeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token comment" style="color:#999988;font-style:italic">// 추가</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">successFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> statusCode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">responseHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">code</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">statusCode </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> statusCode </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">400</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> statusCode </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">404</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ... 생략 ...</span><br></span></code></pre></div></div>
<p>구현 후 테스트한 결과 404 상태 코드도 성공(success)으로 집계된 것을 확인할 수 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -s http://localhost:8083/metrics | grep "my_http_service_GET_requests_total" | grep "404"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_requests_total{hostname_pattern="*",http_status="404",method="hello",result="success",service="com.example.armeria_prometheus.MyAnnotatedService",} 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_GET_requests_total{hostname_pattern="*",http_status="404",method="hello",result="failure",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="지표-필터링하기">지표 필터링하기<a href="https://armeria.dev/blog/ko/2021/07/15/customizing-armeria-metrics#%EC%A7%80%ED%91%9C-%ED%95%84%ED%84%B0%EB%A7%81%ED%95%98%EA%B8%B0" class="hash-link" aria-label="Direct link to 지표 필터링하기" title="Direct link to 지표 필터링하기" translate="no">​</a></h2>
<p><code>MeterFilter</code>를 이용하면 내가 원하지 않는 지표를 집계에서 제외할 수 있습니다. 예를 들어, JVM 지표들을 집계에서 제외하고 싶다면, 아래와 같이 <code>MeterFilter</code>를 설정하면 됩니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">PrometheusMeterRegistry</span><span class="token plain"> meterRegistry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PrometheusMeterRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">PrometheusConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">DEFAULT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        meterRegistry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">meterFilter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterFilter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">denyNameStartsWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"jvm"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ServerBuilder</span><span class="token plain"> sb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">http</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8083</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">meterRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meterRegistry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// ... 생략 ...</span><br></span></code></pre></div></div>
<p><code>jvm_</code> 지표들이 모두 제외된 것을 확인할 수 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -s http://localhost:8083/metrics | grep "^jvm"</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="grpc-지표-수집하기">gRPC 지표 수집하기<a href="https://armeria.dev/blog/ko/2021/07/15/customizing-armeria-metrics#grpc-%EC%A7%80%ED%91%9C-%EC%88%98%EC%A7%91%ED%95%98%EA%B8%B0" class="hash-link" aria-label="Direct link to gRPC 지표 수집하기" title="Direct link to gRPC 지표 수집하기" translate="no">​</a></h2>
<p>Armeria의 <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/common/grpc/GrpcMeterIdPrefixFunction.html" target="_blank" rel="noopener noreferrer" class="">GrpcMeterIdPrefixFunction</a>를 이용해 <a href="https://grpc.github.io/grpc/core/md_doc_statuscodes.html" target="_blank" rel="noopener noreferrer" class="">gRPC 상태 코드</a>에 대한 지표도 수집할 수 있습니다. 지표를 수집하기 위해서는 먼저 아래와 같이 <code>armeria-grpc</code>를 디펜던시에 추가해야 합니다.</p>
<div class="language-groovy codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">build.gradle</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-groovy codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dependencies </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Armeria</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation </span><span class="token interpolation-string string" style="color:#e3116c">"com.linecorp.armeria:armeria:1.8.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation </span><span class="token interpolation-string string" style="color:#e3116c">"com.linecorp.armeria:armeria-logback:1.8.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation </span><span class="token interpolation-string string" style="color:#e3116c">"com.linecorp.armeria:armeria-grpc:1.8.0"</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 추가</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>테스트하기 위해 아래와 같이 간단한 gRPC 서비스를 하나 생성했습니다.</p>
<div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">hello.proto</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">syntax</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"proto3"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> com</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">example</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">armeria_prometheus</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">option</span><span class="token plain"> java_package </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"com.example.armeria_prometheus.grpc"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">service</span><span class="token plain"> </span><span class="token class-name">HelloService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">rpc</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Hello</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HelloRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HelloReply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">message</span><span class="token plain"> </span><span class="token class-name">HelloRequest</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin">int32</span><span class="token plain"> seq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">message</span><span class="token plain"> </span><span class="token class-name">HelloReply</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin">string</span><span class="token plain"> message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">MyGrpcService.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MyGrpcService</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">HelloServiceGrpc</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">HelloServiceImplBase</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HelloRequest</span><span class="token plain"> request</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">StreamObserver</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">HelloReply</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> responseObserver</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getSeq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">HelloReply</span><span class="token plain"> reply </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HelloReply</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Success"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            responseObserver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onNext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reply</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            responseObserver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onCompleted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        responseObserver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">INTERNAL</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">asException</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>위에서 만든 gRPC 서비스를 새로운 서비스로 추가합니다. 기존의 HTTP 지표 수집에 영향을 주지 않도록 각 서비스에 <code>MetricCollectingService</code> <code>decorator</code>를 적용하는 형태로 변경했습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ... 생략 ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">annotatedService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyAnnotatedService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token class-name">MetricCollectingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.http.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                                          </span><span class="token comment" style="color:#999988;font-style:italic">// ... 생략 ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">GrpcService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyGrpcService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token class-name">MetricCollectingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">GrpcMeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.grpc.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/metrics"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">PrometheusExpositionService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meterRegistry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getPrometheusRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// ... 생략 ...</span><br></span></code></pre></div></div>
<p>간편하게 테스트를 진행하기 위해 복수 개의 gRPC 요청을 발생시키는 클라이언트 코드도 작성했습니다(클라이언트 역시 Armeria를 이용하면 쉽게 작성할 수 있습니다).</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">RpcClientApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RpcClientApplication</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">Logger</span><span class="token plain"> logger </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">LoggerFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RpcClientApplication</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">HelloServiceBlockingStub</span><span class="token plain"> helloService </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Clients</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"gproto+http://127.0.0.1:8083/"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">HelloServiceBlockingStub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">HelloRequest</span><span class="token plain"> request </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HelloRequest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newBuilder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setSeq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token class-name">HelloReply</span><span class="token plain"> reply </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> helloService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">hello</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reply</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Exception</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Error"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>서버를 재기동하고 클라이언트 코드를 실행해 봅니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -s http://localhost:8083/metrics | grep "my_grpc_service_requests_total"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP my_grpc_service_requests_total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE my_grpc_service_requests_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_grpc_service_requests_total{grpc_status="13",hostname_pattern="*",http_status="200",method="Hello",result="success",service="com.example.armeria_prometheus.HelloService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_grpc_service_requests_total{grpc_status="13",hostname_pattern="*",http_status="200",method="Hello",result="failure",service="com.example.armeria_prometheus.HelloService",} 34.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_grpc_service_requests_total{grpc_status="0",hostname_pattern="*",http_status="200",method="Hello",result="failure",service="com.example.armeria_prometheus.HelloService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_grpc_service_requests_total{grpc_status="0",hostname_pattern="*",http_status="200",method="Hello",result="success",service="com.example.armeria_prometheus.HelloService",} 66.0</span><br></span></code></pre></div></div>
<p>실질적인 gRPC 응답에 해당하는 <a href="https://grpc.github.io/grpc/core/md_doc_statuscodes.html" target="_blank" rel="noopener noreferrer" class="">gRPC 상태 코드</a> 지표도 함께 수집돼 출력된 것을 확인할 수 있습니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="마치며">마치며<a href="https://armeria.dev/blog/ko/2021/07/15/customizing-armeria-metrics#%EB%A7%88%EC%B9%98%EB%A9%B0" class="hash-link" aria-label="Direct link to 마치며" title="Direct link to 마치며" translate="no">​</a></h2>
<p>Armeria에서는 이 밖에도 사용자들이 각자의 요구 사항에 맞게 지표를 수집할 수 있도록 다양한 기능을 제공하고 있습니다. 이런 기능들을 활용해 서버 개발자들이 보다 생산적으로 모니터링할 수 있기를 소망하며 글을 마치겠습니다.</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Armeria에서 Prometheus 지표 모니터링하기]]></title>
            <link>https://armeria.dev/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria</link>
            <guid>https://armeria.dev/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria</guid>
            <pubDate>Mon, 28 Jun 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[시작하며]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="시작하며">시작하며<a href="https://armeria.dev/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria#%EC%8B%9C%EC%9E%91%ED%95%98%EB%A9%B0" class="hash-link" aria-label="Direct link to 시작하며" title="Direct link to 시작하며" translate="no">​</a></h2>
<p>이번 글에서는 <a href="https://armeria.dev/" target="_blank" rel="noopener noreferrer" class="">Armeria</a>에서 수집한 <a href="https://prometheus.io/" target="_blank" rel="noopener noreferrer" class="">Prometheus</a> 지표를 모니터링하는 방법을 살펴보겠습니다.
Armeria를 처음 사용해 보시는 분들도 쉽게 따라 할 수 있도록 간단한 실습 예제와 함께 작성했습니다.</p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="실습">실습<a href="https://armeria.dev/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria#%EC%8B%A4%EC%8A%B5" class="hash-link" aria-label="Direct link to 실습" title="Direct link to 실습" translate="no">​</a></h2>
<p>실습은 macOS Big Sur 환경에서 진행했습니다. 실습을 진행하기 위해 Gradle과 Prometheus, <a href="https://grafana.com/" target="_blank" rel="noopener noreferrer" class="">Grafana</a>를 어떻게 설치하고 설정했는지 함께 알아보고, 테스트 결과를 확인해보겠습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="gradle-설정">Gradle 설정<a href="https://armeria.dev/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria#gradle-%EC%84%A4%EC%A0%95" class="hash-link" aria-label="Direct link to Gradle 설정" title="Direct link to Gradle 설정" translate="no">​</a></h3>
<p>Armeria 서버의 Prometheus 지표를 수집하기 위해 'build.gradle' 파일에 아래와 같은 디펜던시를 정의했습니다.</p>
<div class="language-groovy codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">build.gradle</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-groovy codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dependencies </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Armeria</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation </span><span class="token interpolation-string string" style="color:#e3116c">"com.linecorp.armeria:armeria:1.8.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation </span><span class="token interpolation-string string" style="color:#e3116c">"com.linecorp.armeria:armeria-logback:1.8.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Prometheus</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation </span><span class="token interpolation-string string" style="color:#e3116c">"io.micrometer:micrometer-registry-prometheus:1.7.0"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>또한 실습을 위해 아래와 같이 <code>/hello/{seq}</code>로 GET 요청을 전송하면 성공 혹은 실패로 응답하는 간단한 REST API를 하나 준비했습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">MyAnnotatedService.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MyAnnotatedService</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/hello/{seq}"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hello</span><span class="token punctuation" style="color:#393A34">(</span><span class="token annotation punctuation" style="color:#393A34">@Param</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"seq"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> seq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seq </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">INTERNAL_SERVER_ERROR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">OK</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">MediaType</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">PLAIN_TEXT_UTF_8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Success"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>아래는 Armeria 서버를 실행하기 위한 <code>main()</code> 함수 코드입니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ArmeriaPrometheusApplication</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">PrometheusMeterRegistry</span><span class="token plain"> meterRegistry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">PrometheusMeterRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">PrometheusConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">DEFAULT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Server</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">http</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">8083</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">meterRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meterRegistry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">annotatedService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyAnnotatedService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/metrics"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">PrometheusExpositionService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meterRegistry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getPrometheusRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MetricCollectingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.http.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CompletableFuture</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Void</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> future </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>서비스 지표를 수집하기 위해서는 반드시 아래와 같이 <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/MetricCollectingService.html" target="_blank" rel="noopener noreferrer" class="">MetricCollectingService</a>를 <code>decorator</code>로 추가해야 합니다(자세한 방법은 <a href="https://armeria.dev/docs/advanced-metrics/" target="_blank" rel="noopener noreferrer" class="">공식 문서</a>를 참고하시기 바랍니다). <code>MeterIdPrefixFunction.ofDefault()</code> 함수의 인자 값을 이용하면 지표의 기본 프리픽스 이름을 원하는 대로 설정할 수 있습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">MyAnnotatedService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token class-name">MetricCollectingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">MeterIdPrefixFunction</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofDefault</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"my.http.service"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/1.8.0/com/linecorp/armeria/server/metric/PrometheusExpositionService.html" target="_blank" rel="noopener noreferrer" class="">PrometheusExpositionService</a>를 이용해 Prometheus 지표를 노출할 경로를 설정합니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">ArmeriaPrometheusApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/metrics"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">PrometheusExpositionService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">meterRegistry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getPrometheusRegistry</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><code>/hello</code> API를 요청해 응답이 잘 오는지 확인합니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl http://localhost:8083/hello/1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ curl http://localhost:8083/hello/3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">500 Internal Server Error</span><br></span></code></pre></div></div>
<p><code>/metrics</code>로 요청했을 때 Prometheus 지표가 응답으로 잘 전달되는지도 확인합니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -s http://localhost:8083/metrics | grep "my_http_service_requests_total"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HELP my_http_service_requests_total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># TYPE my_http_service_requests_total counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_requests_total{hostname_pattern="*",http_status="500",method="hello",result="success",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_requests_total{hostname_pattern="*",http_status="200",method="hello",result="failure",service="com.example.armeria_prometheus.MyAnnotatedService",} 0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_requests_total{hostname_pattern="*",http_status="200",method="hello",result="success",service="com.example.armeria_prometheus.MyAnnotatedService",} 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">my_http_service_requests_total{hostname_pattern="*",http_status="500",method="hello",result="failure",service="com.example.armeria_prometheus.MyAnnotatedService",} 1.0</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="prometheus-설치-및-설정">Prometheus 설치 및 설정<a href="https://armeria.dev/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria#prometheus-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EC%84%A4%EC%A0%95" class="hash-link" aria-label="Direct link to Prometheus 설치 및 설정" title="Direct link to Prometheus 설치 및 설정" translate="no">​</a></h3>
<p>먼저 <a href="https://brew.sh/index_ko" target="_blank" rel="noopener noreferrer" class="">Homebrew</a> 패키지 매니저로 Prometheus를 설치합니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew install prometheus</span><br></span></code></pre></div></div>
<p>설치가 완료되면 기본적으로 'prometheus.yml'이라는 파일이 하나 생성됩니다. 이 YAML 파일을 이용해 Prometheus 설정을 변경할 수 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vi $(brew --prefix)/etc/prometheus.yml</span><br></span></code></pre></div></div>
<p>설정 파일에 Prometheus 지표를 수집할 수 있는 경로와 포트를 정확하게 기입합니다.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">prometheus.yml</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">global</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">scrape_interval</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">scrape_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">job_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'armeria-prometheus'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metrics_path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">'/metrics'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">static_configs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">'localhost:8083'</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p>변경한 후에 Prometheus 서비스를 재시작해야 변경된 설정이 적용됩니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew services start prometheus</span><br></span></code></pre></div></div>
<p>Prometheus가 사용하는 기본 포트는 <code>9090</code>입니다. 웹 브라우저에서 <code>http://localhost:9090</code> 주소로 접속하면 아래 화면을 볼 수 있습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-1-d761e7cf42bde79256e6b3acd7f73941.png" width="1024" height="317" class="img_ev3q"></p>
<p>셀렉트 박스를 클릭해 Armeria 관련 지표가 Prometheus 서버에서 잘 수집됐는지 확인합니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-2-57ec3c55f86df941b1757ef46c971024.png" width="1024" height="388" class="img_ev3q"></p>
<p><code>/hello/{seq}</code> API를 몇 번 요청한 뒤 <code>my_http_service_requests_total</code> 지표가 잘 증가하는지 그래프에서 확인합니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-3-42f66c9e85883a24608a69d73ecc4c0b.png" width="1024" height="475" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="grafana-설치-및-설정">Grafana 설치 및 설정<a href="https://armeria.dev/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria#grafana-%EC%84%A4%EC%B9%98-%EB%B0%8F-%EC%84%A4%EC%A0%95" class="hash-link" aria-label="Direct link to Grafana 설치 및 설정" title="Direct link to Grafana 설치 및 설정" translate="no">​</a></h3>
<p>Prometheus와 마찬가지로 Grafana도 Homebrew로 설치한 후 서비스를 시작합니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ brew install grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ brew services start grafana</span><br></span></code></pre></div></div>
<p>Grafana의 기본 포트는 <code>3000</code>입니다. 브라우저에서 <code>http://localhost:3000</code> 주소로 접속하면 아래 로그인 페이지를 만나게 됩니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-4-59a3e9308b0cfcf44a86c758be874099.png" width="1024" height="528" class="img_ev3q"></p>
<p>'계정을 만든 적이 없는데...?'라고 당황하지 마시고 침착하게 <strong>Email or username</strong>과 <strong>Password</strong>에 'admin'을 입력하면 로그인할 수 있습니다. 이름에서 알 수 있듯이 admin은 기본 계정이므로 실제 서비스에서 사용할 때는 보안을 위해 반드시 계정을 새로 만들어야 합니다.</p>
<p>Grafana에서 Prometheus 메트릭을 그래프로 표시할 수 있도록, 앞에서 설정한 Prometheus 경로를 <strong>Data Source</strong>로 추가해야 합니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-5-7ea539d66490a74cd206f210a73f0f84.png" width="840" height="411" class="img_ev3q"></p>
<p>다음으로 대시보드를 하나 생성한 후, <code>/hello/{seq}</code> API의 성공과 실패 횟수를 모니터링할 수 있는 패널을 하나 생성하겠습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-6-4c5290f42ab658d351a7c297a4e7fdcb.png" width="1024" height="581" class="img_ev3q"></p>
<p>쿼리는 아래와 같이 작성했습니다.</p>
<ul>
<li class="">200: <code>increase(my_http_service_requests_total{hostname_pattern="*", method="hello", http_status="200", result="success", service="com.example.armeria_prometheus.MyAnnotatedService"}[1m])</code></li>
<li class="">500: <code>increase(my_http_service_requests_total{hostname_pattern="*", method="hello", http_status="500", result="failure", service="com.example.armeria_prometheus.MyAnnotatedService"}[1m])</code></li>
</ul>
<p>여기서 <code>armeria_server_requests_total</code> 지표는 <a href="https://prometheus.io/docs/concepts/metric_types/#counter" target="_blank" rel="noopener noreferrer" class="">Counter</a>라는 지표 유형으로 단순히 누적되며 계속 증가하는 값입니다. 실제 API 모니터링에서는 이 API가 현재까지 얼마나 많이 성공 혹은 실패했느냐는 누적값보다는, 시간별 성공과 실패 횟수가 더 의미 있을 것입니다. 이에 <a href="https://prometheus.io/docs/prometheus/latest/querying/functions/#increase" target="_blank" rel="noopener noreferrer" class="">increase()</a> 함수를 사용해서 매 1분 동안의 성공과 실패 횟수를 그래프로 나타냈습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="테스트-결과">테스트 결과<a href="https://armeria.dev/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria#%ED%85%8C%EC%8A%A4%ED%8A%B8-%EA%B2%B0%EA%B3%BC" class="hash-link" aria-label="Direct link to 테스트 결과" title="Direct link to 테스트 결과" translate="no">​</a></h3>
<p>이제 아래 클라이언트 코드를 실행해 API 요청을 100번 보내겠습니다(Armeria의 <a href="https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/WebClient.html" target="_blank" rel="noopener noreferrer" class="">WebClient</a>를 사용했습니다).</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">HttpClientApplication.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">HttpClientApplication</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">Logger</span><span class="token plain"> logger </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">LoggerFactory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpClientApplication</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">WebClient</span><span class="token plain"> client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">WebClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"http://localhost:8083/"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">AggregatedHttpResponse</span><span class="token plain"> res </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/hello/"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">aggregate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">content</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">UTF_8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Grafana에서 <code>/hello/{seq}</code> API의 성공과 실패 횟수가 아름답게 그래프로 표시되는 것을 확인할 수 있습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/monitoring-prometheus-metrics-from-armeria-7-14b9783a6a86ef8e9f99c0251d8c241e.png" width="1024" height="377" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="마치며">마치며<a href="https://armeria.dev/blog/ko/2021/06/28/monitoring-prometheus-metrics-from-armeria#%EB%A7%88%EC%B9%98%EB%A9%B0" class="hash-link" aria-label="Direct link to 마치며" title="Direct link to 마치며" translate="no">​</a></h2>
<p>이번 글에서는 Armeria 서버를 실행해서 수집한 Prometheus 지표와 Grafana 대시보드를 이용해 모니터링하는 방법을 살펴보았습니다.
Armeria에서는 현재 지표 수집과 관련한 다양한 기능을 제공하고 있습니다. 다음 글에서는 이 기능을 이용해 Armeria에서 수집된 지표를 내 입맛에 맞게 커스터마이징해 보겠습니다.</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Armeria로 Reactive Streams와 놀자! - 2]]></title>
            <link>https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2</link>
            <guid>https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2</guid>
            <pubDate>Wed, 06 May 2020 11:00:00 GMT</pubDate>
            <description><![CDATA[안녕하세요.]]></description>
            <content:encoded><![CDATA[<p>안녕하세요.
LINE+에서 오픈소스 Armeria와 Central Dogma를 개발하고 있는 엄익훈입니다. <a class="" href="https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1">지난 포스팅</a>에선 Reactive Streams의 개념을 살펴보았는데요. 이번 포스팅에선 Reactive Streams를 오픈 소스 비동기 HTTP/2, RPC, REST 클라이언트/서버 라이브러리인 Armeria에서 사용하는 방법에 대해 공유하려고 합니다.</p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="whats-armeria">What’s Armeria?<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#whats-armeria" class="hash-link" aria-label="Direct link to What’s Armeria?" title="Direct link to What’s Armeria?" translate="no">​</a></h2>
<p>Armeria는 Java 8 및 Netty, Thrift, gRPC에 기반한 오픈 소스 비동기 HTTP/2, RPC, REST 클라이언트/서버 라이브러리입니다.
Armeria는 경량(Lightweight) 마이크로 서비스 프레임워크지만 지원하는 기능은 다른 풀 스택(full stack) 웹 프레임워크와 비교해도 손색이 없습니다.</p>
<p>먼저 Armeria에서 Reactive Streams를 활용한 서버를 구현하기 위해선 기본적으로 알아야 할 것들을 알려드리겠습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="지원하는-프로토콜">지원하는 프로토콜<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#%EC%A7%80%EC%9B%90%ED%95%98%EB%8A%94-%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C" class="hash-link" aria-label="Direct link to 지원하는 프로토콜" title="Direct link to 지원하는 프로토콜" translate="no">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-1-b8df78267813bd6db4a7146dc18e2f91.png" width="3030" height="1468" class="img_ev3q"></p>
<p>Armeria에서는 HTTP/1과 HTTP/2를 모두 지원하고, 이 두 개의 프로토콜은 <a href="https://simple.wikipedia.org/wiki/Cleartext" target="_blank" rel="noopener noreferrer" class="">cleartext</a>와 TLS(Transport Layer Security) 암호화 통신을 모두 지원합니다.
HTTP/1에서 HTTP/2로의 호환성을 지원하기 위한 프로토콜 업그레이드 면에선, HTTP/2의 'connection preface'와 HTTP/1의 'upgrade request'를 모두 지원하고 있습니다.</p>
<p>또한 Armeria에선 gRPC와 Thrift가 HTTP/1과 HTTP/2, 양쪽에서 모두 동작합니다. 이는 Armeria만의 특별한 기능인데요. gRPC는 HTTP/1을 지원하지 않고, 기존의 Thrift에선 HTTP/2를 지원하지 않습니다. 하지만 Armeria에서는 모두 지원하고 있어서 다양한 비즈니스 환경에서 유연하게 사용할 수 있습니다. 또한 리눅스 환경에선 JNI(Java Native Interface) 기반의 소켓 IO와 BoringSSL 기반의 TLS를 통해서 더욱더 빠른 성능으로 프로덕션에 사용할 수 있습니다.</p>
<p>그럼 예제 코드와 함께 Armeria에 대해서 하나씩 알아보겠습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="예제-코드로-알아보는-armeria">예제 코드로 알아보는 Armeria<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#%EC%98%88%EC%A0%9C-%EC%BD%94%EB%93%9C%EB%A1%9C-%EC%95%8C%EC%95%84%EB%B3%B4%EB%8A%94-armeria" class="hash-link" aria-label="Direct link to 예제 코드로 알아보는 Armeria" title="Direct link to 예제 코드로 알아보는 Armeria" translate="no">​</a></h3>
<p>Armeria는 사용자 친화적인 API입니다. 코드가 간결하고 사용하기 쉽습니다. 'Hello world' 서버를 실행하고 싶다면 아래와 같이 5줄만 작성하면 됩니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Build your own server under 5 lines.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var server = Server.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .http(8080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .service(“/“, (ctx, req) -&gt; HttpResponse.of(“Hello, World!”))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.start();</span><br></span></code></pre></div></div>
<p>서버를 쉽게 실행할 수 있다는 점은 마이크로 서비스 환경에서 각각의 비즈니스 컴포넌트를 분리하여 독립된 서버로 관리하려고 할 때 핵심이 되는 사항입니다.</p>
<p>또한 서버 아키텍처를 단순하게 만들 수 있습니다.
HTTPS나 HTTP/2를 사용하기 위해 별도로 <a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/sidecar" target="_blank" rel="noopener noreferrer" class="">사이드카</a>(sidecar)인 Nginx나 Apache Httpd와 같은 정적 웹 서버를 실행할 필요가 없습니다. 앞서 언급했듯, 리눅스 환경에서는 JNI 기반의 소켓 IO와 BoringSSL을 지원하기 때문에 별도로 성능 저하를 고려하지 않아도 됩니다. 또한 JS나 CSS, 이미지와 같은 정적 파일을 서빙하는 기능도 제공하고 있습니다(<a href="https://line.github.io/armeria/server-http-file.html" target="_blank" rel="noopener noreferrer" class="">참고</a>).</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var server = Server.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .http(8080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .https(8443) // HTTPS support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .tlsSelfSigned()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .service(“/“, (ctx, req) -&gt; HttpResponse.of(“Hello, World!”))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">server.start();</span><br></span></code></pre></div></div>
<p>네트워크 홉(hop)을 추가하지 않아도 되기 때문에 장애점을 줄일 수 있고, 리소스를 절약할 수 있어 효율적으로 통신할 수 있으며, 아키텍처가 단순해지고, 모니터링이 쉬워지며, 서버를 유연하게 확장할 수 있습니다.</p>
<p>그 외에도 유용한 기능이 많습니다. 그중 하나가 Armeria에서 빌트인으로 제공하는 어노테이션(annotation)입니다. 어노테이션을 이용하면 Armeria의 기능을 더욱 쉽게 사용할 수 있습니다. 예를 들어 아래와 같이 <code>hello</code>를 프리픽스(prefix)로, <code>name</code>을 경로 변수로 설정하여 라우팅하는 코드를 손쉽게 작성할 수 있습니다(<a href="https://line.github.io/armeria/server-annotated-service.html" target="_blank" rel="noopener noreferrer" class="">Armeria 공식 문서</a>를 참고하면 그 외 다양한 어노테이션을 더욱 자세하게 살펴볼 수 있습니다).</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.annotation.Get;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.annotation.Param;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.annotation.PathPrefix;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Use built-in annotations for mapping path and parameter injection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@PathPrefix(“/hello”)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class HelloService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   @Get(“/:name”)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public String hello(@Param String name) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       return String.format(“Hello, %s!”, name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Armeria에는 다른 종류의 RPC 프로토콜을 동시에 서빙할 수 있는 특별한 기능도 있습니다. 하나의 서버에서 REST API와 gRPC, Thrift를 모두 제공할 수 있어서 비즈니스 요구 사항이나 아키텍처의 변화에 유연하게 대응할 수 있습니다. 또한 단일 포트로 제공하기 때문에 리소스를 효율적으로 사용하면서 보안 측면에서 불필요한 노출을 최소화하고, 관리 포인트를 줄일 수 있는 장점이 있습니다.<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#footnotes" class="">[1]</a></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var server = Server.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   .http(8080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   .service(“/hello/rest”, (ctx, req) -&gt; HttpResponse.of(“Hello, world!”))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   .service(“/hello/thrift”, THttpService.of(new ThriftHelloService()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   .service(“/hello/grpc”, GrpcService.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      .addService(new GrpcHelloService())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      .build())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   .build();</span><br></span></code></pre></div></div>
<p>엔터프라이즈 소프트웨어 개발자들은 공통적으로 인증, 로깅과 같은 부분을 어떻게 하면 효율적으로 처리할 수 있을지에 관심을 갖고 고민하게 됩니다.
Armeria에서는 <a href="https://en.wikipedia.org/wiki/Separation_of_concerns" target="_blank" rel="noopener noreferrer" class="">separation of concerns</a>라고 부르는 이런 부분을 별도의 <a href="https://line.github.io/armeria/server-decorator.html" target="_blank" rel="noopener noreferrer" class="">decorator</a>로 관리할 수 있는 기능을 제공합니다.<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#footnotes" class="">[2]</a></p>
<p>또한 기본 제공 외에 다른 decorator가 필요하다면, 직접 손쉽게 구현해서 특정 경로나 서비스에 바인딩해서 사용할 수도 있습니다. 예를 들어 아래 그림에서 구현한 <code>AuthService</code>같은 경우에는 <code>request</code>에 인증 정보가 포함되어 있을 때만 서비스를 호출하고, 그렇지 않으면 '401 unauthorized' 에러를 발생시키도록 했습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-2-651dfe37d84cf70fa56b6314072fc869.png" width="3316" height="1652" class="img_ev3q"></p>
<p>다음으로 Armeria에서 Reactive Streams를 어떻게 지원하고 있는지 알아보겠습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="armeria-내-http2-스트림">Armeria 내 HTTP/2 스트림<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#armeria-%EB%82%B4-http2-%EC%8A%A4%ED%8A%B8%EB%A6%BC" class="hash-link" aria-label="Direct link to Armeria 내 HTTP/2 스트림" title="Direct link to Armeria 내 HTTP/2 스트림" translate="no">​</a></h3>
<p>스트림(stream)은 흐르는 물과 같이 유기적으로 계속 연결되어 있어야 합니다. 어느 한곳만 뚫려있고 나머지가 막혀 있다면 곧 넘쳐 버립니다.
Armeria에서는 데이터의 흐름을 유기적으로 제어하기 위해서 서버 내에선 Reactive Streams의 백 프레셔를 이용해 트래픽을 제어합니다. 또한 <a href="https://http2.github.io/http2-spec/#WINDOW_UPDATE" target="_blank" rel="noopener noreferrer" class="">WINDOW_UPDATE</a>를 이용한 <a href="https://tools.ietf.org/html/rfc7540#section-5.2" target="_blank" rel="noopener noreferrer" class="">HTTP/2 stream flow control</a>로, 백 프레셔가 하위 네트워크 레이어에서 Armeria 서버와 여러분이 구현한 서비스, 그리고 데이터 저장소까지 유기적으로 연결할 수 있도록 만들었습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-3-19c9d7f507f0cc7efb072673431792ff.png" width="3336" height="1792" class="img_ev3q"></p>
<p>만약 서비스에서 사용하는 서버를 Armeria의 Reactive 서버로 당장 바꾸기 어렵다면, 아래와 같이 Armeria를 Reactive 프락시 서버로 활용할 수도 있습니다(<a href="https://github.com/line/armeria-examples/tree/master/proxy-server" target="_blank" rel="noopener noreferrer" class="">참고</a>).</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Use Armeria’s async &amp; reactive HTTP/2 client.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var client = HttpClient.of(“h2c://backend”);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var server = Server.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .http(8080)          // Forward all requests reactively</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .service(“prefix:/“, (ctx, req) -&gt; client.execute(req))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .build();</span><br></span></code></pre></div></div>
<p>Armeria 프락시 서버를 앞에 두면 여러분의 서버를 험난한 외부 인터넷으로부터 안전하게 보호할 수 있습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-4-d1176606f39d7cc2951b0a21a74b80c6.png" width="2310" height="716" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="reactive-streams와-armeria의-통합">Reactive Streams와 Armeria의 통합<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#reactive-streams%EC%99%80-armeria%EC%9D%98-%ED%86%B5%ED%95%A9" class="hash-link" aria-label="Direct link to Reactive Streams와 Armeria의 통합" title="Direct link to Reactive Streams와 Armeria의 통합" translate="no">​</a></h2>
<p>Armeria로 직접 Reactive Streams를 지원하는 서버를 만든다면 더욱더 다양한 기능을 쓸 수 있는데요.
Armeria에서 Reactive Streams를 활용하는 방법과 빌트인 publisher에 대해서 좀 더 자세히 알아보겠습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="armeria-http-응답-publisher">Armeria HTTP 응답 Publisher<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#armeria-http-%EC%9D%91%EB%8B%B5-publisher" class="hash-link" aria-label="Direct link to Armeria HTTP 응답 Publisher" title="Direct link to Armeria HTTP 응답 Publisher" translate="no">​</a></h3>
<p>Armeria의 응답은 헤더를 표현하는 <a href="https://line.github.io/armeria/apidocs/com/linecorp/armeria/common/HttpHeaders.html" target="_blank" rel="noopener noreferrer" class="">HttpHeaders</a>와 데이터를 표현하는 <a href="https://line.github.io/armeria/apidocs/com/linecorp/armeria/common/HttpData.html" target="_blank" rel="noopener noreferrer" class="">HttpData</a>로 구성되어 있습니다.
RxJava의 <a href="http://reactivex.io/RxJava/javadoc/io/reactivex/Observable.html" target="_blank" rel="noopener noreferrer" class="">Observable</a>을 Armeria의 <a href="https://line.github.io/armeria/apidocs/com/linecorp/armeria/common/HttpResponse.html" target="_blank" rel="noopener noreferrer" class="">HttpResponse</a>로 바꾸는 과정을 단계별로 살펴보겠습니다.</p>
<p>데이터가 준비되면 먼저 <code>Observable</code>의 <code>map</code> 연산자를 이용해서 <code>dataStream</code>을 <code>HttpData</code>로 감싸줍니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 1. Fetch data from Reactive Streams Publisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Observable&lt;String&gt; dataStream = Observable.just(“a”, “b”, “c”, “d”, “e”);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2. Convert string to Armeria HttpData</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Observable&lt;HttpData&gt; httpDataStream = dataStream.map(HttpData::ofUtf8);</span><br></span></code></pre></div></div>
<p>어떤 식으로 응답할지 결정하여 응답 헤더를 준비한 후, <code>concat</code> 연산자로 위에서 준비한 <code>httpDataStream</code>과 합치면, <code>HttpHeaders</code>에서 <code>HttpData</code>로 연결되는 하나의 스트림이 완성됩니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 3. Prepare response headers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ResponseHeaders httpHeaders = ResponseHeaders.of(HttpStatus.OK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 4. Concat http header and body stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Observable&lt;HttpObject&gt; responseStream = Observable.concat(Observable.just(httpHeaders), httpDataStream);</span><br></span></code></pre></div></div>
<p><code>완성된 스트림을 Observable</code>의 <code>toFlowable</code> 함수를 이용하여 Reactive Streams의 <a href="https://www.baeldung.com/rxjava-2-flowable" target="_blank" rel="noopener noreferrer" class="">Flowable</a>로 변환한 뒤, 최종적으로 Armeria의 <code>HttpResponse로</code> 감싸면 과정이 끝납니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 5. Convert Observable to Armeria Response Stream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HttpResponse response = HttpResponse.of(responseStream.toFlowable(BackpressureStrategy.BUFFER));</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="armeria-빌트인-publisher">Armeria 빌트인 Publisher<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#armeria-%EB%B9%8C%ED%8A%B8%EC%9D%B8-publisher" class="hash-link" aria-label="Direct link to Armeria 빌트인 Publisher" title="Direct link to Armeria 빌트인 Publisher" translate="no">​</a></h3>
<p>위 과정이 조금 복잡하거나, 혹은 지루하게 느껴졌을 수도 있습니다. 그래서 Armeria에서는 웹에서 스트림 데이터를 전달하는 방법의 표준인 <a href="https://tools.ietf.org/html/rfc7464" target="_blank" rel="noopener noreferrer" class="">JSON Text Sequences(RFC 7464)</a>와 HTML5 규격인 <a href="https://en.wikipedia.org/wiki/Server-sent_events" target="_blank" rel="noopener noreferrer" class="">Server-sent events</a>에 대한 빌트인 Publisher를 제공합니다. 이 publisher를 이용하면 Reactive Streams를 좀 더 편리하게 웹으로 전달할 수 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Fetch data from Reactive Streams Publisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Publisher&lt;String&gt; dataStream = Flux.just(“a”, “b”, “c”, “d”, “e”);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Convert Publisher to JSON Text Sequences with Armeria HttpResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// with “application/json-seq” MIME type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HttpResponse httpResponse = JsonTextSequences.fromPublisher(dataStream);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Convert Publisher to Server-sent Events with Armeria HttpResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// with “text/event-stream” MIME type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HttpResponse httpResponse = ServerSentEvents</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .fromPublisher(dataStream, SeverSentEvent::ofData);</span><br></span></code></pre></div></div>
<p>또한 빌트인 publisher를 더욱 쉽게 사용할 수 있도록 RxJava 통합을 지원하고 있습니다. 어노테이션한 서비스에 <code>@ProduceJsonSequence</code> 어노테이션을 추가하고, <code>Observable</code>을 그대로 반환하면 Armeria에서 해당 프로토콜로 자동으로 변환합니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import io.reactivex.Observable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.annotation.ProducesJsonSequences;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class RxJavaService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Get(“/json-streaming”)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Generate JSON Text Sequences</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ProducesJsonSequences</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Observable&lt;String&gt; json() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          // Just return RxJava Observable!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Observable.just(“a”, “b”, “c”);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre></div></div>
<p>아래와 같이'JsonTextSequences'로 인코딩하면 JSON 문자열의 시작과 끝에 레코드 구분자(separator)와 라인 피드(line feed)가 추가됩니다. 또한 현재 프로토콜에 따라 HTTP/1과 HTTP/2로 전송될 때 다르게 동작해야 하는데요.
Armeria에선 현재 연결된 프로토콜에 따라 알아서 적합한 형태의 데이터로 전송합니다.
HTTP/2의 경우에는 <a href="https://http2.github.io/http2-spec/#DATA" target="_blank" rel="noopener noreferrer" class="">Data frame</a>안에 JSON 데이터를 나누어서 보내고, HTTP/1의 경우에는 <a href="https://en.wikipedia.org/wiki/Chunked_transfer_encoding" target="_blank" rel="noopener noreferrer" class="">chunked transfer encoding</a>을 이용하여 나누어서 보냅니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-5-b047c88a956d6aea2e8163ea08fd3590.png" width="3278" height="1818" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="spring-webflux-통합">Spring WebFlux 통합<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#spring-webflux-%ED%86%B5%ED%95%A9" class="hash-link" aria-label="Direct link to Spring WebFlux 통합" title="Direct link to Spring WebFlux 통합" translate="no">​</a></h2>
<p>Armeria는 다양한 라이브러리 및 프레임워크와의 연동을 지원합니다.
Reactive Streams를 사용하기 위해서 이미 <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" target="_blank" rel="noopener noreferrer" class="">Spring WebFlux</a>를 사용하고 있다면, 별도의 코드 수정 없이 'armeria-spring-boot-webflux-starter'를 의존성에 추가(<a href="https://line.github.io/armeria/advanced-spring-webflux-integration.html" target="_blank" rel="noopener noreferrer" class="">참고</a>)하는 것만으로 Armeria로의 마이그레이션을 끝낼 수 있습니다. 이런 방식으로 WebFlux의 네트워크 레이어인 <a href="https://github.com/reactor/reactor-netty" target="_blank" rel="noopener noreferrer" class="">Reactor-Netty</a>를 Armeria의 Reactive 엔진으로 교체할 수 있습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-6-0408b3405e56818eebd1d7b8471bbc75.png" width="3120" height="1346" class="img_ev3q"></p>
<p>단순히 엔진만 교체하는 거라면 '그냥 WebFlux만 사용하면 되지 않을까?'라는 의문이 생길 수도 있는데요. 과연 어떤 이점이 있는 걸까요?</p>
<p>엔진을 교체하면 <a href="https://line.github.io/armeria/apidocs/com/linecorp/armeria/spring/ArmeriaServerConfigurator.html" target="_blank" rel="noopener noreferrer" class="">ArmeriaServerConfigurator</a>를 통해서 Spring에 Armeria의 기능을 추가할 수 있어서, 기존 Spring에서는 지원하지 않는 Armeria만의 기능을 활용할 수 있습니다. 예를 들어 아래와 같이 REST API로 구성된 기존 Spring Webflux 서버에 gRPC나 Thrift 기능을 추가하여 기존과 동일한, 단일 포트에서 서비스할 수 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ArmeriaConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // Configure the server by providing an ArmeriaServerConfigurator bean.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public ArmeriaServerConfigurator armeriaServerConfigurator() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // Customize the server using the given ServerBuilder. For example:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       return builder -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // Add DocService that enables you to send gRPC and Thrift requests from web browser.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           builder.serviceUnder(“/docs”, new DocService());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // Log every message which the server receives and responds.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           builder.decorator(LoggingService.newDecorator());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // Write access log after completing a request.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           builder.accessLogWriter(AccessLogWriter.combined(), false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           // You can also bind asynchronous RPC services such as Thrift and gRPC:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           builder.service(THttpService.of(…));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           builder.service(GrpcService.builder()…build());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>또한 이외에도 앞서 설명드린 decorator 기능을 활용해서 더욱더 풍성한 서비스로 만들 수 있습니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="grpc-스트림-지원">gRPC 스트림 지원<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#grpc-%EC%8A%A4%ED%8A%B8%EB%A6%BC-%EC%A7%80%EC%9B%90" class="hash-link" aria-label="Direct link to gRPC 스트림 지원" title="Direct link to gRPC 스트림 지원" translate="no">​</a></h2>
<p>gRPC는 <a href="https://grpc.github.io/grpc-java/javadoc/io/grpc/stub/StreamObserver.html" target="_blank" rel="noopener noreferrer" class="">StreamObserver</a>를 이용하여 스트림을 지원합니다(<a href="https://grpc.io/docs/tutorials/basic/java/#server-side-streaming-rpc" target="_blank" rel="noopener noreferrer" class="">참고</a>). 그리고 Reactive Streams에선 gRPC의 <a href="https://grpc.github.io/grpc-java/javadoc/io/grpc/stub/StreamObserver.html" target="_blank" rel="noopener noreferrer" class="">StreamObserver</a>로 손쉽게 변환할 수 있습니다. 예제를 통해서 알아보겠습니다.</p>
<p>우선 아래와 같이 protobuf를 이용해 데이터를 어떤 식으로 주고받을지, 인터페이스를 정의합니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">syntax = “proto3”;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package users;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">option java_package = “users”;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service UserService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Returns all user information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rpc getAllUsers(UserRequest) returns (stream User) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Push to stream of users</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rpc pushToUsers(stream User) returns (Result) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>전체 회원에게 메일 혹은 푸시 메시지를 보내고 싶다면 먼저 모든 사용자 정보를 조회해야 하는데요. 만약 회원 수가 너무 많다면 데이터를 한 번에 전송하는 게 어려울 수 있습니다. 그럴 때 아래와 같은 방법으로 대량의 사용자 정보를 반환하는 스트림 서버를 gRPC로 구축할 수 있습니다.</p>
<ol>
<li class="">ProjectReactor의 <code>Flux</code>를 Publisher로 사용하여 저장소에서 스트림 형태로 데이터를 조회합니다.</li>
<li class="">gRPC의 <code>StreamObservser</code>로 변환하여 외부로 전송합니다.</li>
</ol>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Implement interfaces generated by gRPC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class UserServiceImpl extends UserServiceImplBase {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void getAllUsers(UserRequest request, StreamObserver&lt;User&gt; responseObserver) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Flux&lt;User&gt; userPublisher = userRepo.findAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        publisher.subscribe(responseObserver::onNext,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            responseObserver::onError,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            responseObserver::onCompleted);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p><code>StreamObserver</code>에도 Reactive Streams와 유사하게 <code>onNext</code>, <code>onError</code>, <code>onCompleted</code> 함수가 존재하기 때문에 각각의 API를 매칭해서 연결하기만 하면 됩니다.</p>
<p>이번에는 수신 측에서 전체 사용자의 정보를 스트림으로 받는 것을 생각해 볼 건데요. <a href="https://www.reactive-streams.org/reactive-streams-1.0.0-javadoc/org/reactivestreams/Processor.html" target="_blank" rel="noopener noreferrer" class="">Processor</a>를 활용하겠습니다. <code>Processor</code>는 별도의 API를 가지고 있지 않고, <code>Subscriber</code>와 <code>Publisher,</code> 이 두 개의 인터페이스를 상속받고 있는 게 전부인데요. 데이터를 구독 받고, 구독한 데이터를 다시 발행할 때 유용하게 사용할 수 있습니다. <code>StreamObserver</code>의 <code>onNext</code>로 들어온 새로운 사용자 정보를 <code>Processor</code>의 <code>onNext</code> 함수로 전달할 수 있고, 이를 다시 구독해서 원하는 작업을 추가로 수행할 수 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public StreamObserver&lt;User&gt; pushToUsers(StreamObserver&lt;Result&gt; responseObserver) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Processor&lt;User, User&gt; processor = EmitterProcessor.create();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Publisher&lt;User&gt; publisher = processor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Subscriber&lt;User&gt; subscriber = processor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Push one-by-one by subscribing publisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new StreamObserver&lt;User&gt;() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // subscribe user data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override public void onNext(User user) { processor.onNext(user); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override public void onError(Throwable throwable) { processor.onError(throwable); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override public void onCompleted() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            responseObserver.onNext(Result.newBuilder().setStatus(200).build());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            responseObserver.onCompleted();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>작성한 gRPC 코드를 Armeria에서 실행해보겠습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.Server;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.linecorp.armeria.server.grpc.GrpcService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Add your grpc service to Armeria GrpcService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var grpcService = GrpcService.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             .addService(new UserServiceImpl())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                             .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var server = Server.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   .http(8080)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   .serviceUnder(“/grpc”, grpcService)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   .serviceUnder(“/docs”, new DocService())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   .build();</span><br></span></code></pre></div></div>
<p>이렇게 만든 스트림 서버를 이용해 작은 메모리로도 많은 양의 데이터를 스트림 형태로 처리할 수 있습니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="마이크로-서비스를-위한-armeria의-기능">마이크로 서비스를 위한 Armeria의 기능<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#%EB%A7%88%EC%9D%B4%ED%81%AC%EB%A1%9C-%EC%84%9C%EB%B9%84%EC%8A%A4%EB%A5%BC-%EC%9C%84%ED%95%9C-armeria%EC%9D%98-%EA%B8%B0%EB%8A%A5" class="hash-link" aria-label="Direct link to 마이크로 서비스를 위한 Armeria의 기능" title="Direct link to 마이크로 서비스를 위한 Armeria의 기능" translate="no">​</a></h2>
<p>Armeria를 통해 Reactive Streams를 활용하면 많은 양의 데이터와 트랙픽을 유연하게 처리할 수 있습니다. 또한 RPC를 통해서 마이크로 서비스간 통신도 쉽게 처리할 수 있습니다.</p>
<p>이외에도 아래와 같이 마이크로 서비스에 필요한 다양한 기능을 제공하고 있습니다.</p>
<ul>
<li class="">클라우드 환경에서 서버의 위치를 파악하기 위해 Kubernetes 유형의 DNS(Domain Name System)와 ZooKeeper를 활용한 서비스 검색(discovery)을 제공(<a href="https://line.github.io/armeria/advanced-zookeeper.html" target="_blank" rel="noopener noreferrer" class="">참고</a>)하고 있습니다.</li>
<li class="">검색된 서비스는 클라이언트 측 로드 밸런싱으로 직접 부하를 분산하며 서버와 통신합니다. 이를 통해 장애점을 줄일 수 있습니다.</li>
<li class=""><a href="https://www.nginx.com/resources/glossary/layer-7-load-balancing/" target="_blank" rel="noopener noreferrer" class="">L7</a>이 아닌 클라이언트가 직접 서버 상태를 체크할 수 있습니다.</li>
<li class="">로그를 확인할 때 분산된 서버에 접근하지 않고도 확인할 수 있도록 Kafka로 접속 로그를 전송합니다.</li>
<li class="">Micrometer를 활용해서 필요한 수치를 설정, 수집하여 Prometheus나 Netflix의 Atlas와 같은 애플리케이션 모니터링 툴로 전송할 수 있습니다.</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-2-7-da8c2428f8f86f6212efef177ca57d88.png" width="3076" height="1428" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="마치며">마치며<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#%EB%A7%88%EC%B9%98%EB%A9%B0" class="hash-link" aria-label="Direct link to 마치며" title="Direct link to 마치며" translate="no">​</a></h2>
<p>두 번에 걸쳐 Reactive Streams와 Armeria에 대한 내용을 공유드렸습니다. 함께 살펴보았듯 Armeria를 이용하면, Reactive Streams와 고성능, 비동기, RPC, HTTP/2를 지원하면서 장애에 탄력적인, 보다 안전한 서버를 구축할 수 있습니다.</p>
<p>Armeria에선 포스팅에서 언급한 기능 외에 더 많은 기능을 제공하고 있습니다. 이와 관련하여 Armeria의 <a href="https://line.github.io/armeria/index.html" target="_blank" rel="noopener noreferrer" class="">공식 홈페이지</a>와 아래 링크를 참고하시기 바랍니다.</p>
<ul>
<li class="">GitHub: <a href="https://github.com/line/armeria" target="_blank" rel="noopener noreferrer" class="">line/armeria</a></li>
<li class="">Twitter: <a href="https://twitter.com/armeria_project" target="_blank" rel="noopener noreferrer" class="">@armeria_project</a></li>
<li class="">Chat: <a href="https://armeria.dev/s/discord" target="_blank" rel="noopener noreferrer" class="">Discord</a></li>
<li class=""><a href="https://line.github.io/armeria/apidocs/index.html" target="_blank" rel="noopener noreferrer" class="">API documentation</a></li>
<li class="">Armeria examples: <a href="https://github.com/line/armeria-examples" target="_blank" rel="noopener noreferrer" class="">line/armeria-examples</a></li>
</ul>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="footnotes">Footnotes<a href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2#footnotes" class="hash-link" aria-label="Direct link to Footnotes" title="Direct link to Footnotes" translate="no">​</a></h4>
<ol>
<li class=""><a href="https://line.github.io/armeria/server-grpc.html" target="_blank" rel="noopener noreferrer" class="">gRPC 서버를 Armeria에서 구동하는 법</a>과 <a href="https://line.github.io/armeria/server-thrift.html" target="_blank" rel="noopener noreferrer" class="">Thrift 서버를 Armeria에서 구동하는 법</a>을 참고하시기 바랍니다.</li>
<li class="">Armeria에서 기본적으로 제공하는 다양한 decorator는 공식 문서와 아래 Javadoc에서 확인해 볼 수 있습니다.<!-- -->
<ul>
<li class=""><a href="https://line.github.io/armeria/apidocs/com/linecorp/armeria/server/SimpleDecoratingHttpService.html" target="_blank" rel="noopener noreferrer" class="">SimpleDecoratingHttpService</a>와 <a href="https://line.github.io/armeria/apidocs/com/linecorp/armeria/client/SimpleDecoratingClient.html" target="_blank" rel="noopener noreferrer" class="">SimpleDecoratingClient</a>의 Direct Known Subsclasses 항목</li>
</ul>
</li>
</ol>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Armeria로 Reactive Streams와 놀자! - 1]]></title>
            <link>https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1</link>
            <guid>https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1</guid>
            <pubDate>Wed, 06 May 2020 10:00:00 GMT</pubDate>
            <description><![CDATA[Reactive Streams란?]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="reactive-streams란">Reactive Streams란?<a href="https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1#reactive-streams%EB%9E%80" class="hash-link" aria-label="Direct link to Reactive Streams란?" title="Direct link to Reactive Streams란?" translate="no">​</a></h2>
<p>LINE+에서 오픈소스 Armeria와 Central Dogma를 개발하고 있는 엄익훈입니다. 저는 Reactive Streams의 개념과, Reactive Streams를 오픈 소스 비동기 HTTP/2, RPC, REST 클라이언트/서버 라이브러리인 Armeria에서 사용하는 방법에 대해 공유하려고 하는데요. 이번 포스팅에선 먼저 Reactive Streams의 개념을 알아보겠습니다.</p>
<p>Reactive Streams는 공식 홈페이지인 <a href="http://reactive-streams.org/" target="_blank" rel="noopener noreferrer" class="">reactive-streams.org</a>에서 아래와 같이 정의하고 있습니다.</p>
<blockquote>
<p>Reactive Streams is a standard for asynchronous data processing in a streaming fashion with non-blocking back pressure.</p>
</blockquote>
<p>홈페이지에선 논블로킹(Non-blocking) 백 프레셔(back pressure)를 이용한 비동기 데이터 처리의 표준이라고 말하고 있는데요. '스트리밍 처리', '비동기(asynchronous) 방식', '백 프레셔', 그리고 '표준'이라는 각각의 단어가 의미하는 바를 조금 더 자세히 알아보겠습니다.</p>
<!-- -->
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="스트리밍-처리">스트리밍 처리<a href="https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1#%EC%8A%A4%ED%8A%B8%EB%A6%AC%EB%B0%8D-%EC%B2%98%EB%A6%AC" class="hash-link" aria-label="Direct link to 스트리밍 처리" title="Direct link to 스트리밍 처리" translate="no">​</a></h3>
<p>아래 그림은 전통적인 데이터 처리 방식과 스트리밍 처리 방식을 비교한 그림입니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-1-2f25791f2d6557baebc7d095eda17c7d.png" width="3342" height="1882" class="img_ev3q"></p>
<p>왼쪽의 전통적인 데이터 처리 방식에서는, 데이터 처리 요청이 오면 페이로드(payload)를 모두 애플리케이션의 메모리에 저장한 후에 다음 처리를 해야 합니다. 추가로 필요한 데이터도 저장소에서 조회하여 메모리에 적재해야 합니다. 이 방식의 문제점은 전달된 데이터는 물론 저장소에서 조회한 데이터까지 모든 데이터가 애플리케이션의 메모리에 적재되어야만 응답 메시지를 만들 수 있다는 것입니다. 만약 필요한 데이터의 크기가 메모리 용량보다 크다면 'out of memory' 에러가 발생하게 됩니다. 그리고 서비스를 운영하다 보면 꼭 하나의 요청이 'out of memory'를 발생시키지 않더라도, 순간적으로 많은 요청이 몰리면서 다량의 GC(Garbage Collection)가 발생, 서버가 정상적으로 응답하지 못하는 경우가 종종 나타납니다.</p>
<p>그런데 많은 양의 데이터를 처리하는 애플리케이션에 스트림 처리 방식을 적용하면, 크기가 작은 시스템 메모리로도 많은 양의 데이터를 처리할 수 있습니다. 입력 데이터에 대한 파이프 라인을 만들어 데이터가 들어오는 대로 물 흐르듯이 구독(subscribe)하고, 처리한 뒤, 발행(publish)까지 한 번에 연결하여 처리할 수 있습니다. 이렇게 하면 서버는 많은 양의 데이터도 탄력적으로 처리할 수 있습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="비동기-방식">비동기 방식<a href="https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1#%EB%B9%84%EB%8F%99%EA%B8%B0-%EB%B0%A9%EC%8B%9D" class="hash-link" aria-label="Direct link to 비동기 방식" title="Direct link to 비동기 방식" translate="no">​</a></h3>
<p>비동기 방식은 동기(synchronous) 방식과 비교하며 살펴보겠습니다. 아래 그림은 동기 방식과 비동기 방식의 처리 과정을 나타낸 그림입니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-2-f4e515c6966123761077255924895887.png" width="3344" height="1876" class="img_ev3q"></p>
<p>동기 방식에선 클라이언트가 서버에 요청을 보내면 응답을 받기 전까지 블로킹(blocking)됩니다. 블로킹된다는 것은 현재 스레드(thread)가 다른 일을 하지 못하고 기다린다는 것을 의미합니다. 따라서 두 개의 요청을 A와 B 서버로 보내면, A의 응답이 끝나고 나서야 B로 요청을 보낼 수 있습니다. 하지만 비동기 방식에서는 현재 스레드가 블로킹되지 않기 때문에 다른 일을 계속할 수 있습니다.
A에게 요청을 보낸 뒤 다른 일을 처리할 수도 있고, 혹은 B에게 또 다른 요청을 보낼 수도 있습니다. 동기 방식과 비교하여 비동기 방식의 장점을 정리하면 아래와 같습니다.</p>
<ul>
<li class="">빠른 속도 - 두 개의 요청을 동시에 보내기 때문에 더 빠른 응답 속도를 보여줄 것입니다.</li>
<li class="">적은 리소스 사용 - 현재 스레드가 블로킹되지 않고 다른 업무를 처리할 수 있어서 더 적은 수의 스레드로 더 많은 양의 요청을 처리할 수 있습니다.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="백-프레셔">백 프레셔<a href="https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1#%EB%B0%B1-%ED%94%84%EB%A0%88%EC%85%94" class="hash-link" aria-label="Direct link to 백 프레셔" title="Direct link to 백 프레셔" translate="no">​</a></h3>
<p>백 프레셔에 대해 알아보기 전에 <a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener noreferrer" class="">RxJava</a>로 유명해진 옵저버 패턴(<a href="http://reactivex.io/documentation/observable.html" target="_blank" rel="noopener noreferrer" class="">observer patten</a>)과 푸시(push) 방식, 그리고 풀(pull) 방식에 대해서 알아보겠습니다.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="푸시-방식">푸시 방식<a href="https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1#%ED%91%B8%EC%8B%9C-%EB%B0%A9%EC%8B%9D" class="hash-link" aria-label="Direct link to 푸시 방식" title="Direct link to 푸시 방식" translate="no">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-3-f90a82d7c69e036ae62f224a2fff1c57.png" width="2040" height="1002" class="img_ev3q"></p>
<p>옵저버 패턴에서는 발행자(publisher)가 구독자(subscriber)에게 밀어 넣는 방식으로 데이터가 전달됩니다. 발행자는 구독자의 상태를 고려하지 않고 데이터를 전달하는 데에만 충실합니다. 만약 발행자가 1초 동안 100개의 메시지를 보내는데 구독자는 1초에 10개밖에 처리하지 못한다면 어떻게 해야 할까요? 큐(queue)를 이용해서 대기 중인 이벤트를 저장해야 합니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-4-e144d9d9e9c035b0f776f6d81465a871.png" width="2656" height="1158" class="img_ev3q"></p>
<p>서버가 가용할 수 있는 메모리는 한정되어 있습니다. 만약 초당 100개의 메모리를 계속 푸시한다면 버퍼는 순식간에 소모되고 말 텐데요. 버퍼를 다 사용해버려서 오버플로(overflow)가 발생하면 어떻게 될까요? 고정 길이 버퍼와 가변 길이 버퍼로 나누어 살펴보겠습니다.</p>
<ul>
<li class="">고정 길이 버퍼: 신규로 수신된 메시지를 거절합니다. 거절된 메시지는 재요청하게 되는데요. 재요청 과정에서 네트워크와 CPU 연산 비용이 추가로 발생합니다.</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-5-5271512498a52243394d8a9ba2e15c3a.png" width="2684" height="1358" class="img_ev3q"></p>
<ul>
<li class="">가변 길이 버퍼: 이벤트를 저장할 때 'out of memory' 에러가 발생하면서 서버 크래시(crash)가 발생합니다. '누가 그렇게 구현하겠어?'라고 생각할 수 있지만, Java에서 많이 사용되는 <code>List</code>가 가변 길이 자료 구조형입니다. 예를 들어 SQL로 많은 양의 데이터를 질의하면 DBMS는 발행자가 되고 여러분의 서버가 구독자가 되어 <code>List</code> 자료 구조형에 데이터를 전부 담으려고 하다가 다량의 GC가 발생하면서 서버가 정상적으로 응답할 수 없는 상태에 이를 수 있습니다.</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-6-93355b83286fefdd6b5dac13f0e5957a.png" width="2694" height="1328" class="img_ev3q"></p>
<p>이 문제를 어떻게 해결할 수 있을까요? 발행자가 데이터를 전달할 때 구독자가 필요한 만큼만 전달하면 해결할 수 있지 않을까요? 이게 바로 백 프레셔의 기본 원리입니다.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="풀-방식">풀 방식<a href="https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1#%ED%92%80-%EB%B0%A9%EC%8B%9D" class="hash-link" aria-label="Direct link to 풀 방식" title="Direct link to 풀 방식" translate="no">​</a></h4>
<p>풀 방식에선 구독자가 10개를 처리할 수 있다면 발행자에게 10개만 요청합니다. 발행자는 요청받은 만큼만 전달하면 되고, 구독자는 더 이상 'out of memory' 에러를 걱정하지 않아도 됩니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-7-23bbdc8de88d80bfb99c448b495dcbcd.png" width="2558" height="1082" class="img_ev3q"></p>
<p>여기서 좀 더 탄력적으로 적용하여, 구독자가 이미 8개의 일을 처리하고 있다면 추가로 2개만 더 요청하여 자신이 현재 처리 가능한 범위 내에서만 메시지를 받게 할 수 있습니다. 풀 방식에선 이렇게 전달되는 모든 데이터의 크기를 구독자가 결정합니다. 이런 다이나믹 풀 방식의 데이터 요청을 통해서 구독자가 수용할 수 있는 만큼만 데이터를 요청하는 방식이 백 프레셔입니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="표준">표준<a href="https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1#%ED%91%9C%EC%A4%80" class="hash-link" aria-label="Direct link to 표준" title="Direct link to 표준" translate="no">​</a></h3>
<p>Reactive Streams는 표준화된 API입니다. 왜 표준화가 필요했고 어떤 과정을 통해 표준화가 되었는지 알아보겠습니다.</p>
<p>Reactive Streams는 2013년에 Netflix와 Pivotal, Lightbend의 엔지니어들이 처음 개발하기 시작했습니다.
Netflix는 RxJava, Pivotal은 WebFlux, 그리고 Lightbend는 분산 처리 액터(actor) 모델을 구현한 Akka를 만든 회사인데요. 모두 스트림 API가 꼭 필요한 회사였습니다. 그런데 스트림은 서로 유기적으로 엮여서 흘러야 의미가 있습니다. 데이터가 지속적으로 흐르기 위해서는 서로 다른 회사가 공통의 스펙을 설정하고 구현해야 합니다. 그래서 표준화가 필요했습니다.</p>
<p>Reactive Streams에선 2015년 4월에 JVM에서 사용하기 위한 <a href="https://www.reactive-streams.org/announce-1.0.0" target="_blank" rel="noopener noreferrer" class="">1.0.0</a> 스펙을 릴리스했습니다. 그리고 2017년 9월에, Reactive Streams의 API와 스펙, 풀(pull) 방식 사용 원칙을 그대로 포팅해서 <a href="https://docs.oracle.com/javase/9/docs/api/java/util/concurrent/Flow.html" target="_blank" rel="noopener noreferrer" class="">Flow API</a>라는 이름으로 <code>java.util.concurrent</code> 패키지 아래 포함시킨 Java 9이 릴리스되었습니다. 이는 커뮤니티와 일부 기업에서 주도해 개발했던 Reactive Streams가 Java의 공식 기능이 되었다는 것을 의미합니다. 이어서 3달 뒤, Reactive Streams에서 Flow와 상호 변환이 가능한 어댑터를 릴리스하면서, 기존에 만들어진 라이브러리를 사용할 수 있게 되었습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-8-d9ff99c821b42b8a7ed40882fcd3f69e.png" width="3318" height="1846" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="reactive-streams-api">Reactive Streams API<a href="https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1#reactive-streams-api" class="hash-link" aria-label="Direct link to Reactive Streams API" title="Direct link to Reactive Streams API" translate="no">​</a></h2>
<p>Reactive Streams는 그럴듯한 단어로 설명되어 뭔가 복잡할 것 같지만, 실제 내부는 아주 간단한 API들의 조합으로 구성되어 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Publisher&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void subscribe(Subscriber&lt;? super T&gt; s);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface Subscriber&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void onSubscribe(Subscription s);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void onNext(T t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void onError(Throwable t);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void onComplete();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface Subscription {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void request(long n);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void cancel();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<ul>
<li class=""><code>Publisher</code>에는 <code>Subscriber</code>의 구독을 받기 위한 <code>subscribe</code> API 하나만 있습니다.</li>
<li class=""><code>Subscriber</code>에는 받은 데이터를 처리하기 위한 <code>onNext</code>, 에러를 처리하는 <code>onError</code>, 작업 완료 시 사용하는 <code>onComplete</code>, 그리고 매개 변수로 <code>Subscription</code>을 받는 <code>onSubscribe</code> API가 있습니다.</li>
<li class=""><code>Subscription</code>은 n개의 데이터를 요청하기 위한 <code>request</code>와 구독을 취소하기 위한 <code>cancel</code> API가 있습니다.</li>
</ul>
<p>이제 Reactive Streams에서 위 API를 사용하는 흐름을 살펴보겠습니다.</p>
<ol>
<li class="">
<p><code>Subscriber</code>가 <code>subscribe</code> 함수를 사용해 <code>Publisher</code>에게 구독을 요청합니다.</p>
</li>
<li class="">
<p><code>Publisher</code>는 <code>onSubscribe</code> 함수를 사용해 <code>Subscriber</code>에게 <code>Subscription</code>을 전달합니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-9-17e45a561c31ba0d7cc7c5e6846d91fa.png" width="3332" height="1860" class="img_ev3q"></p>
</li>
<li class="">
<p>이제 <code>Subscription</code>은 <code>Subscriber</code>와 <code>Publisher</code> 간 통신의 매개체가 됩니다. <code>Subscriber</code>는 <code>Publisher</code>에게 직접 데이터 요청을 하지 않습니다. <code>Subscription</code>의 <code>request</code> 함수를 통해 <code>Publisher</code>에게 전달합니다.</p>
</li>
<li class="">
<p><code>Publisher</code>는 <code>Subscription</code>을 통해 <code>Subscriber</code>의 <code>onNext</code>에 데이터를 전달하고, 작업이 완료되면 <code>onComplete</code>, 에러가 발생하면 <code>onError</code> 시그널을 전달합니다.</p>
</li>
<li class="">
<p><code>Subscriber</code>와 <code>Publisher</code>, <code>Subscription</code>이 서로 유기적으로 연결되어 통신을 주고받으면서 <code>subscribe</code>부터 <code>onComplete</code>까지 연결되고, 이를 통해 백 프레셔가 완성됩니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-10-ed725f58b4ed0796a63fd72e5956a7b2.png" width="3328" height="1866" class="img_ev3q"></p>
</li>
</ol>
<p>백 프레셔가 좋은 건 알겠는데, 과연 어떻게 사용하는 걸까요?
Reactive Streams API는 <a href="https://github.com/reactive-streams/reactive-streams-jvm/tree/master/api/src/main/java/org/reactivestreams" target="_blank" rel="noopener noreferrer" class="">GitHub</a>에 들어가서 살펴봐도 위에서 살펴본 인터페이스가 전부입니다. 따로 구현체가 없습니다.</p>
<p>그렇다면 직접 구현해서 사용하면 될까요? 앞서 나온 규칙대로 <code>Publisher</code> 인터페이스를 구현하고 이를 구독할 때 <code>Subscription</code>을 생성해서 넘겨주도록 구현할 수는 있습니다. 하지만 이게 전부가 아닙니다.
Reactive Streams에는 API 외에도 <a href="https://github.com/reactive-streams/reactive-streams-jvm#specification" target="_blank" rel="noopener noreferrer" class="">명세서</a>가 있는데요. 이 명세서에는 단순한 인터페이스와는 달리 구현 시 따라야 하는 규칙이 복잡하게 명세되어 있습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-11-297565955f64bff427a1d12928ce5fc3.png" width="2866" height="1582" class="img_ev3q"></p>
<p>이 명세에 맞춰 직접 구현한 기능은 <a href="https://github.com/reactive-streams/reactive-streams-jvm/tree/master/tck" target="_blank" rel="noopener noreferrer" class="">Reative Streams TCK</a>라는 툴로 검증할 수 있는데요. 해당 분야의 전문가가 아니라면 모든 규칙을 만족하도록 구현하는 게 꽤나 까다로운 일입니다. 특히 <code>Publisher</code>를 구현하는 게 어렵습니다.
Java의 유명한 Reactive Streams 구현체 중 하나인 <a href="https://projectreactor.io/" target="_blank" rel="noopener noreferrer" class="">Project Reactor</a>의 GitHub에 올라온 이슈를 살펴보면, 어떤 사용자가 자신이 만든 커스텀 <code>Publisher</code>가 Flux와 잘 연결되지 않는다는 내용으로 이슈를 올려놓은 게 있습니다(<a href="https://github.com/reactor/reactor-core/issues/482" target="_blank" rel="noopener noreferrer" class="">참고</a>). 이에 대한 Project Reactor의 답변은 단호합니다. '만들지 마세요!'라고 답변했습니다. 학습 차원에서 토이 프로젝트로 만드는 것은 저도 추천합니다. 공부도 되고, 좋습니다. 하지만 실제 운영에서 사용할 코드라면 검증되지 않은 코드보다는, <code>Flux.create()</code>와 같은 생성자 함수를 활용해서 <code>Publisher</code>를 만드는 게 좋다고 생각합니다.
Reactive Streams를 사용하려면 직접 구현하는 것보다는 이미 잘 만들어져서 검증까지 받은 구현체를 사용하는 게 좋습니다. 그렇다면 이런 구현체에는 어떤 게 있을까요?</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="reactive-stream-구현체와-상호운영성interoperability">Reactive Stream 구현체와 상호운영성(interoperability)<a href="https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1#reactive-stream-%EA%B5%AC%ED%98%84%EC%B2%B4%EC%99%80-%EC%83%81%ED%98%B8%EC%9A%B4%EC%98%81%EC%84%B1interoperability" class="hash-link" aria-label="Direct link to Reactive Stream 구현체와 상호운영성(interoperability)" title="Direct link to Reactive Stream 구현체와 상호운영성(interoperability)" translate="no">​</a></h2>
<p>Reactive Streams에는 <a href="https://en.wikipedia.org/wiki/Reactive_Streams#Adoption" target="_blank" rel="noopener noreferrer" class="">다양한 구현체</a>가 존재합니다. 각각의 구현체는 서로 특성이 조금씩 다르기 때문에 상황에 따라, 필요에 맞게 골라서 사용할 수 있습니다.</p>
<ul>
<li class="">순수하게 스트림 연산 처리만 필요하다면 <a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener noreferrer" class="">RxJava</a>나 <a href="https://github.com/reactor/reactor-core" target="_blank" rel="noopener noreferrer" class="">Reactor Core</a>, <a href="https://doc.akka.io/docs/akka/current/stream/index.html" target="_blank" rel="noopener noreferrer" class="">Akka Streams</a> 등을 사용하면 됩니다.</li>
<li class="">저장소의 데이터를 Reactive Streams로 조회하고 싶다면 <a href="http://reactivemongo.org/" target="_blank" rel="noopener noreferrer" class="">ReactiveMongo</a>나 <a href="http://scala-slick.org/" target="_blank" rel="noopener noreferrer" class="">Slick</a> 등을 사용하면 됩니다.</li>
<li class="">웹 프로그래밍과 연결된 Reactive Streams가 필요하다면 <a href="https://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a>와 <a href="https://vertx.io/" target="_blank" rel="noopener noreferrer" class="">Vert.x</a>, <a href="https://www.playframework.com/" target="_blank" rel="noopener noreferrer" class="">Play Framework</a>, <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux" target="_blank" rel="noopener noreferrer" class="">Spring WebFlux</a>를 활용할 수 있습니다.</li>
</ul>
<p>이렇게 각각 특성이 다른 구현체들은 모두 Reactive Streams를 통해서 서로 통신할 수 있습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="reactive-stream-상호-운영">Reactive Stream 상호 운영<a href="https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1#reactive-stream-%EC%83%81%ED%98%B8-%EC%9A%B4%EC%98%81" class="hash-link" aria-label="Direct link to Reactive Stream 상호 운영" title="Direct link to Reactive Stream 상호 운영" translate="no">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/reactive-streams-armeria-1-12-d033d15e15c32b4597b72cf8fc3bc910.png" width="3204" height="1398" class="img_ev3q"></p>
<p>RxJava의 <code>Observable</code>는 Reactive Streams를 통해서 Armeria의 <code>HttpResponse</code>나 Project Reactor의 <code>Flux</code>로 변환될 수 있고, MongoDB의 <code>DataPublisher</code>는 Akka Streams의 <code>Source</code>를 통해 스트림 연산을 할 수 있습니다.</p>
<p>예를 들어 MongoDB에서 조회한 데이터를 연산 처리한 후 HTTP 응답으로 보낸다고 가정해 보겠습니다.
Reactive Streams를 이용해서 MongoDB에서 데이터를 조회하면 우선 데이터를 구독 받을 수 있는 <code>Pulisher</code>만 반환됩니다.
Subscriber가 Subscription을 통해 request를 호출하기 전까진, 실제 데이터는 전달되지 않습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Initiate MongoDB FindPublisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FindPublisher&lt;Document&gt; mongoDBUsers = mongodbCollection.find();</span><br></span></code></pre></div></div>
<p>아래 코드와 같이<code>Obsevable</code>의 <code>fromPublisher</code>를 통해서 MongoDB의 <code>FindPublisher</code>와 연결할 수 있습니다. 그리고 <code>map</code> 연산자를 이용해 조회 결과에서 <code>age</code> 필드를 추출할 수 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// MongoDB FindPublisher -&gt; RxJava Observable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Observable&lt;Integer&gt; rxJavaAllAges =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Observable.fromPublisher(mongoDBUsers)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              .map(document -&gt; document.getInteger(“age”));</span><br></span></code></pre></div></div>
<p>RxJava의 <code>Observable</code>은 옵저버 패턴으로 구현되어 있기 때문에, 이를 Reactive Streams로 변환하기 위해서는 아래 코드와 같이 <code>toFlowable</code> 함수를 이용해야 합니다. 변환 후 <code>Flux</code>의 <code>from</code> 함수를 이용해 RxJava의 <code>Flowable</code>과 <code>Flux</code>를 연결할 수 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// RxJava Observable -&gt; Reactor Flux</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flux&lt;HttpData&gt; fluxHttpData =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Flux.from(rxJavaAllAges.toFlowable(BackpressureStrategy.DROP))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .map(age -&gt; HttpData.ofAscii(age.toString()));</span><br></span></code></pre></div></div>
<p>Flux 자료 구조를 HTTP 응답으로 사용하려면 아래와 같이 데이터 앞에 HTTP 헤더를 붙여야 합니다. 그 후 Armeria의 HTTP 응답으로 사용하기 위해 <code>HttpResponse.of</code>를 호출해 Flux와 연결합니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Reactor Flux -&gt; Armeria HttpResponse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HttpResponse.of(Flux.concat(httpHeaders, fluxHttpData));</span><br></span></code></pre></div></div>
<p>앞서도 언급했지만 명심할 것은, 일반적인 <code>Iterator</code>와는 달리 아직 실제 연산(변환, 조작, 계산 등)은 전혀 일어나지 않았다는 점입니다. 단지 데이터가 어떻게 <code>Subscriber</code>에게 흘러갈지 그 행위를 기술한 것뿐입니다.
Reactive Streams에서는 <code>Subscriber</code>가 데이터를 요청하기 전까지는 아무런 데이터도 전송하지 않아야 합니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="마치며">마치며<a href="https://armeria.dev/blog/ko/2020/02/18/reactive-streams-armeria-1#%EB%A7%88%EC%B9%98%EB%A9%B0" class="hash-link" aria-label="Direct link to 마치며" title="Direct link to 마치며" translate="no">​</a></h2>
<p>이번 포스팅에서는 Reactive Streams와 그 구현체, 그리고 상호운영성에 대해 알아보았습니다.
Reactive Streams를 웹 프로그래밍에서 활용하기 위해서는 HTTP 요청과 응답에 백 프레셔를 이용해야 합니다. 이를 통해 유입되는 트래픽의 양에 탄력적으로 반응해야 하는데요. <a class="" href="https://armeria.dev/blog/ko/2020/02/19/reactive-streams-armeria-2">다음 포스팅</a>에선 이와 관련해 Armeria에서 Reactive Streams를 어떻게 사용하고 있는지 자세히 알아보겠습니다. 많이 기대해주세요!</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Armeria의 서킷 브레이커 사용해 보기]]></title>
            <link>https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria</link>
            <guid>https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria</guid>
            <pubDate>Mon, 27 Apr 2020 00:00:00 GMT</pubDate>
            <description><![CDATA[안녕하세요.]]></description>
            <content:encoded><![CDATA[<p>안녕하세요.
LINE에서 OpenChat 서비스의 백엔드를 개발하고 있는 주승환입니다. 이번 글에서는 간단한 코드 예제와 함께 Armeria의 서킷 브레이커 기능을 사용해 본 내용을 공유하고자 합니다.</p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="서킷-브레이커란">서킷 브레이커란?<a href="https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria#%EC%84%9C%ED%82%B7-%EB%B8%8C%EB%A0%88%EC%9D%B4%EC%BB%A4%EB%9E%80" class="hash-link" aria-label="Direct link to 서킷 브레이커란?" title="Direct link to 서킷 브레이커란?" translate="no">​</a></h2>
<p>만약 예상치 못한 장애(네크워크 이슈 혹은 서버 다운 등)가 발생하여 어떤 원격 서버 하나가 요청에 응답하지 못하는 상태라고 가정해 보겠습니다. 이때 해당 서버로 요청을 보낸 클라이언트는 타임아웃이 발생할 때까지 응답을 기다리거나 계속 무의미한 요청을 보내며 자원을 낭비하게 될 것입니다.
MSA(Microservice Architecture)에서는 이 클라이언트가 또 다른 누군가의 서버가 될 수도 있는데요. 그렇다면 이 서버의 클라이언트 역시 똑같은 문제를 겪게 될 것입니다. 이렇게 장애가 계속 전파되며 한 원격 서버에서 발생한 장애가 모든 시스템에 큰 영향을 줄 수 있습니다. 이런 문제를 해결하기 위해 등장한 개념이 바로 '서킷 브레이커(circuit breaker)'입니다.</p>
<p>서킷 브레이커란, 클라이언트에서 어떤 원격 서버로 전송한 요청의 실패율이 특정 임계치(threshold)를 넘어서면, 이 서버에 문제가 있다고 판단하여 더 이상 무의미한 요청을 전송하지 않고 빠르게 에러를 발생시키는 방법(fail fast)입니다. 이 방법으로 앞서 언급한 문제를 방지하여 장애 규모를 최소화할 수 있습니다(서킷 브레이커의 개념은 '<a class="" href="https://armeria.dev/blog/ko/2016/07/24/circuit-breakers-for-distributed-services">분산 서비스 환경에 대한 Circuit Breaker 적용</a>' 블로그에 잘 설명되어 있으니 참고하시기 바랍니다).</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="서킷-브레이커의-상태">서킷 브레이커의 상태<a href="https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria#%EC%84%9C%ED%82%B7-%EB%B8%8C%EB%A0%88%EC%9D%B4%EC%BB%A4%EC%9D%98-%EC%83%81%ED%83%9C" class="hash-link" aria-label="Direct link to 서킷 브레이커의 상태" title="Direct link to 서킷 브레이커의 상태" translate="no">​</a></h2>
<p>서킷 브레이커에는 총 3가지 상태가 있습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-1-f70bdace5b6c392763a6f834aac57203.png" width="1806" height="598" class="img_ev3q"></p>
<ul>
<li class=""><code>CLOSED</code>: 요청의 실패율이 정해 놓은 임계치보다 낮은 정상적인 상태.</li>
<li class=""><code>OPEN</code>: 요청의 실패율이 정해 놓은 임계치를 넘어선 상태. 요청을 전송하지 않고 바로 에러를 발생시킴(fail fast).</li>
<li class=""><code>HALF_OPEN</code>: <code>OPEN</code> 상태에서 주기적으로 요청을 전송하여 응답을 확인하는 상태. 성공하면 <code>CLOSED</code> 상태로 전환하고 실패하면 <code>OPEN</code> 상태를 유지.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="armeria의-서킷-브레이커">Armeria의 서킷 브레이커<a href="https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria#armeria%EC%9D%98-%EC%84%9C%ED%82%B7-%EB%B8%8C%EB%A0%88%EC%9D%B4%EC%BB%A4" class="hash-link" aria-label="Direct link to Armeria의 서킷 브레이커" title="Direct link to Armeria의 서킷 브레이커" translate="no">​</a></h2>
<p>LINE에서 운영하는 <a href="https://netty.io/" target="_blank" rel="noopener noreferrer" class="">Netty</a> 기반의 비동기 마이크로 서비스 프레임워크 오픈소스, <a href="https://github.com/line/armeria" target="_blank" rel="noopener noreferrer" class="">Armeria</a>에서는 서킷 브레이커 기능을 직접 구현하여 제공하고 있습니다. 이를 이용해 직접 로그를 살펴보며 서킷 브레이커의 동작을 확인해 보겠습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="준비하기">준비하기<a href="https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria#%EC%A4%80%EB%B9%84%ED%95%98%EA%B8%B0" class="hash-link" aria-label="Direct link to 준비하기" title="Direct link to 준비하기" translate="no">​</a></h3>
<p>먼저, 테스트를 위해 간단하게 요청과 응답을 주고받을 서버 2대, Server1과 Server2를 준비합니다.</p>
<p>클라이언트가 Server1으로 <code>/hello</code> 요청을 보내면, Server1은 Server2로 <code>/world</code> 요청을 보냅니다.
Server2가 Server1으로 응답을 보내면 Server1은 그 응답을 다시 클라이언트에게 반환합니다.
Server1은 클라이언트의 서버이면서 Server2의 클라이언트이기도 합니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-2-b3c58daca726cc29671eb155593a051c.png" width="840" height="234" class="img_ev3q"></p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="server2-구현-코드">Server2 구현 코드<a href="https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria#server2-%EA%B5%AC%ED%98%84-%EC%BD%94%EB%93%9C" class="hash-link" aria-label="Direct link to Server2 구현 코드" title="Direct link to Server2 구현 코드" translate="no">​</a></h4>
<p>상대적으로 구현이 간단한, Server1의 응답을 받을 Server2의 구현 코드부터 보겠습니다. <code>/world</code>로 전송된 요청에 대한 응답으로 성공(200)과 실패(500)를 번갈아 반환하도록 간단하게 구현했습니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Server2Application.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@SpringBootApplication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Server2Application</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">private</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">final</span><span class="token plain"> </span><span class="token class-name">AtomicInteger</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">REQ_CNT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">AtomicInteger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">ServerBuilder</span><span class="token plain"> sb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">http</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5008</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">LoggingService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">service</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/world"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">REQ_CNT</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addAndGet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">INTERNAL_SERVER_ERROR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">HttpResponse</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">of</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Server</span><span class="token plain"> server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CompletableFuture</span><span class="token generics punctuation" style="color:#393A34">&lt;</span><span class="token generics class-name">Void</span><span class="token generics punctuation" style="color:#393A34">&gt;</span><span class="token plain"> future </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="server1-구현-코드">Server1 구현 코드<a href="https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria#server1-%EA%B5%AC%ED%98%84-%EC%BD%94%EB%93%9C" class="hash-link" aria-label="Direct link to Server1 구현 코드" title="Direct link to Server1 구현 코드" translate="no">​</a></h4>
<p>Server1의 구현 코드입니다.
Server2는 <code>ServerBuilder</code>를 이용하여 간단하게 구현한 후, Server1은 클라이언트의 요청을 받을 서비스와 Server2로 요청을 보낼 클라이언트를 모두 빈(bean)으로 만들어 사용합니다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Server1Application.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@SpringBootApplication</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token annotation punctuation" style="color:#393A34">@Import</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Server1Context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Server1Application</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">SpringApplication</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Server1Application</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">class</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_OeMC">Server1Context.java</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token annotation punctuation" style="color:#393A34">@Configuration</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Server1Context</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">HttpServiceRegistrationBean</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">httpService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">WebClient</span><span class="token plain"> webClient</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">HttpServiceRegistrationBean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> webClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/world"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setServiceName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"httpService"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Route</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/hello"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">methods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token constant" style="color:#36acaa">GET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token annotation punctuation" style="color:#393A34">@Bean</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token class-name">WebClient</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">webClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CircuitBreakerStrategy</span><span class="token plain"> strategy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CircuitBreakerStrategy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onServerErrorStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// CircuitBreaker 설정!!!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">CircuitBreaker</span><span class="token plain"> circuitBreaker </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">CircuitBreaker</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"test-circuit-breaker"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">counterSlidingWindow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">circuitOpenWindow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">failureRateThreshold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">minimumRequestThreshold</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">trialRequestInterval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ofSeconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token class-name">WebClient</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">builder</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"http://localhost:5008"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">LoggingClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">decorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">CircuitBreakerHttpClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newDecorator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">circuitBreaker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strategy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>Armeria에서 <code>CircuitBreaker</code>를 구현할 때 주의해야 할 점은, 클라이언트 객체는 각자 자신만의 <code>CircuitBreaker</code>를 가진다는 점입니다. 만약 Server2로 전송되는 매 요청마다 클라이언트 객체를 새로 생성하고 요청이 끝난 후에 소멸되는 방식으로 구현했다면, 각 객체에 연결된 <code>CircuitBreaker</code>는 사실상 무의미해집니다. 따라서 Server2로 요청을 보낼 <code>WebClient</code>를 빈(bean)으로 만들어서 Server2로 전송되는 모든 요청에 대해 동일한 <code>WebClient</code> 객체를 재사용하도록 구현한 후, Armeria에서 제공하는 <a href="https://line.github.io/armeria/client-decorator.html" target="_blank" rel="noopener noreferrer" class="">Decorator</a>를 이용해 이 <code>WebClient</code> 객체에 서킷 브레이커를 적용했습니다.</p>
<p>위 코드에서 <code>CircuitBreaker</code>에 설정한 각 필드를 하나씩 살펴보겠습니다.</p>
<ul>
<li class=""><code>counterSlidingWindow</code>(10s): 서킷 브레이커에서 요청의 성공/실패의 수를 측정하는 시간 간격입니다. 즉, 위 코드에선 10초 동안의 집계를 바탕으로 어떤 상태로 전환 또는 유지할지 판단합니다.</li>
<li class=""><code>circuitOpenWindow</code>(5s): 서킷 브레이커가 <code>OPEN</code> 상태로 유지되는 시간입니다. 위 코드에선 <code>OPEN</code> 상태가 되면 5초 동안 외부 서버로 요청을 보내지 않고 바로 에러(FailFastException)를 발생시킵니다.</li>
<li class=""><code>failureRateThreshold</code>(0.3): <code>OPEN</code> 상태로 전환되기 위한 요청 실패율입니다. <code>circuitOpenWindow</code>에서 설정한 시간 동안 0.3(30%) 비율 이상으로 요청이 실패해야 <code>OPEN</code> 상태로 전환됩니다.</li>
<li class=""><code>minimumRequestThreshold</code>(5): 측정에 필요한 요청의 최소 개수입니다. 실패율이 <code>failureRateThreshold</code>보다 높다고 해도, 그 값이 최소 5개 이상의 요청에 대한 결과값일 때만 <code>OPEN</code> 상태로 전환됩니다.</li>
<li class=""><code>trialRequestInterval</code>(3s): <code>HALF_OPEN</code> 상태로 유지되는 시간입니다. 3초 동안은 <code>OPEN</code> 상태일 때와 마찬가지로 <code>FailFastException</code> 에러를 발생시키는 한편, 외부 서버로도 요청을 전송하며 서버가 정상으로 돌아왔는지 확인합니다. 3초 동안 요청을 전송하면서 성공 응답을 받으면 즉시 <code>CLOSED</code> 상태로 전환되고, 모두 실패하면 다시 <code>OPEN</code> 상태로 전환됩니다.</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="테스트">테스트<a href="https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria#%ED%85%8C%EC%8A%A4%ED%8A%B8" class="hash-link" aria-label="Direct link to 테스트" title="Direct link to 테스트" translate="no">​</a></h3>
<p>아래와 같이 터미널에서 <a href="https://www.npmjs.com/package/loadtest" target="_blank" rel="noopener noreferrer" class="">loadtest</a> 라이브러리를 이용하여 지속적으로 Server1에 요청을 보내겠습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ loadtest http://127.0.0.1:5007/hello --rps 1</span><br></span></code></pre></div></div>
<p>Server1의 로그를 살펴보면 서킷 브레이커의 동작을 눈으로 확인할 수 있습니다. 서버가 처음 실행될 때는 서킷 브레이커의 초기 상태가 <code>CLOSED</code>입니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-3-07759276f457694ff964d39a17233647.png" width="2780" height="440" class="img_ev3q"></p>
<p><em>03:03:41.830</em> 초에 측정된 전체 5개의 요청 중 실패한 요청 수는 두 개이고, 실패율은 2/5 = 0.4입니다. 실패율이 앞서 설정한 0.3(<code>failureRateThreshold</code>)보다 크고, 측정에 사용한 요청 수도 5(<code>minimumRequestThreshold</code>) 이상이므로 서킷 브레이커는 <code>OPEN</code> 상태로 전환됩니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-4-a2545fecd5a4cb40a6c7f1e9bc606001.png" width="3160" height="378" class="img_ev3q"></p>
<p>이후 <em>03:03:41.830</em> ~ <em>03:03:47.824</em>, 약 5초(<code>circuitOpenWindow</code>) 간 Server2로 요청이 전송되지 않고 <code>FailFastException</code> 에러가 계속 발생합니다(Server2의 로그를 보면 해당 시간에 요청이 들어오지 않은 것을 확인할 수 있습니다).</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-5-fb48c4e7a8981c1da7c2dc9413a94d2f.png" width="2562" height="448" class="img_ev3q"></p>
<p><em>03:03:47.824</em> 초에 <code>HALF_OPEN</code> 상태로 전환되고, 클라이언트가 보낸 요청이 Server2로 전송됩니다. 이때 전송된 요청이 운 좋게 200 응답을 받으면서 <code>CLOSED</code> 상태로 전환됩니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-6-26bbfb46bbe9fbc038bbac6a0eb170c2.png" width="3164" height="146" class="img_ev3q"></p>
<p>다시 <code>CLOSED</code>가 되어서 이 과정을 또 반복합니다. <em>03:03:47.827</em> ~ <em>03:03:56.824</em>, 약 10초(<code>counterSlidingWindow</code>) 동안 실패율을 측정합니다. 이번에 측정한 실패율은 4/8 = 0.5이므로, 서킷 브레이커는 다시 <code>OPEN</code> 상태로 전환됩니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-armeria-7-d5c6d32d0e6c79a216971115d5a25552.png" width="3156" height="626" class="img_ev3q"></p>
<p>위와 같이 간단한 테스트를 통해 Armeria 서킷 브레이커의 동작을 직접 확인해 보면서, 여러 설정 옵션의 의미와 그에 따른 동작을 보다 쉽게 이해할 수 있었습니다. 또한 간단한 설정으로도 완벽히 동작하는 서킷 브레이커 클라이언트를 구현할 수 있다는 점도 알게 되었습니다.</p>
<blockquote>
<p>Armeria 서킷 브레이커에 관한 보다 자세한 내용은 <a href="https://armeria.dev/docs/client-circuit-breaker/" target="_blank" rel="noopener noreferrer" class="">https://armeria.dev/docs/client-circuit-breaker/</a> 를 참고하시기 바랍니다.</p>
</blockquote>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="마치며">마치며<a href="https://armeria.dev/blog/ko/2020/04/27/circuit-breakers-armeria#%EB%A7%88%EC%B9%98%EB%A9%B0" class="hash-link" aria-label="Direct link to 마치며" title="Direct link to 마치며" translate="no">​</a></h2>
<p>Armeria에서는 서킷 브레이커 외에도 MSA에 필요한 클라이언트 측 로드 밸런싱이나 auto-retry와 같은 여러 유용한 기능을 제공하고 있습니다. 실제 저희 OpenChat 서버 개발에도 Armeria를 사용하고 있는데요. 덕분에 많은 기능을 편하게 사용하고 있습니다. 지금 이 순간에도 개발자의 목소리에 귀를 기울이며 새로운 기능을 추가하고 개선하고 있는 Armeria 오픈소스 개발 팀에게 감사의 말을 전하며 이 글을 마칩니다.</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[생애 첫 오픈 소스 기여 경험(feat. Armeria)]]></title>
            <link>https://armeria.dev/blog/ko/2019/12/24/my-first-opensource-contribution-to-armeria</link>
            <guid>https://armeria.dev/blog/ko/2019/12/24/my-first-opensource-contribution-to-armeria</guid>
            <pubDate>Tue, 24 Dec 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[들어가며]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="들어가며">들어가며<a href="https://armeria.dev/blog/ko/2019/12/24/my-first-opensource-contribution-to-armeria#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0" class="hash-link" aria-label="Direct link to 들어가며" title="Direct link to 들어가며" translate="no">​</a></h2>
<p>이번 글은 LINE에서 진행됐던 <a class="" href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1">Armeria Sprint</a> 참가 후기입니다. '짧은' 스프린트를 거친 뒤 '긴' 리뷰 과정을 거치며 하나의 기능을 완성하고 결국 릴리스까지 이뤄낸, 길고 험난(?)했던 오픈 소스 기여 경험을 공유하려고 합니다.</p>
<p>어느 날, LINE에서 개발하고 있는 오픈 소스인 Armeria에서 스프린트 참여자를 모집한다는 메일을 받았습니다. 호기심 반, 선착순이라고 하니 일단 지원하자는 마음 반으로 내용도 자세히 확인하지 않고 신청해 버렸습니다. 신청하고 난 후 내용을 확인해 보니 짧은 기간 동안 멘토와 멘티로 활동하면서 Armeria에 코드 기여를 할 수 있는 기회를 제공해 주는 좋은 활동이었습니다. 다만 제가 Armeria에 대한 지식이 전혀 없어서 고민했는데요. 다행히 사내에서 진행되는 OJT(On the Job Training)를 통해서 Armeria 소개를 직접 들을 수 있는 기회가 찾아왔습니다.
OJT에 참석하여 Armeria에 대한 설명을 듣고 나니 걱정 반, 설렘 반이 되었습니다. 이렇게 큰 오픈 소스에 기여해 볼 기회가 생겨 좋긴 했지만, 정말 내가 마무리까지 잘 할 수 있을까 하는 걱정이 앞섰습니다.</p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="이슈-선정에서-pr-등록까지">이슈 선정에서 PR 등록까지<a href="https://armeria.dev/blog/ko/2019/12/24/my-first-opensource-contribution-to-armeria#%EC%9D%B4%EC%8A%88-%EC%84%A0%EC%A0%95%EC%97%90%EC%84%9C-pr-%EB%93%B1%EB%A1%9D%EA%B9%8C%EC%A7%80" class="hash-link" aria-label="Direct link to 이슈 선정에서 PR 등록까지" title="Direct link to 이슈 선정에서 PR 등록까지" translate="no">​</a></h2>
<p>모임에 참석하기 전에, 스프린트를 통해서 스스로 달성하고 싶은 목표에 대해서 생각해 보았습니다. 첫 번째 목표는 '도전을 통해 성장하기'였고, 두 번째는 '목표를 쉽게 설정하는 한이 있더라도 끝까지 포기하지 않기'였습니다. 목표를 설정한 후에 메일로 안내된 간단한 사전 준비를 확인한 뒤, 설레는 마음으로 모임에 참석했습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="간단하게-시작한-첫-번째-모임">간단하게 시작한 첫 번째 모임<a href="https://armeria.dev/blog/ko/2019/12/24/my-first-opensource-contribution-to-armeria#%EA%B0%84%EB%8B%A8%ED%95%98%EA%B2%8C-%EC%8B%9C%EC%9E%91%ED%95%9C-%EC%B2%AB-%EB%B2%88%EC%A7%B8-%EB%AA%A8%EC%9E%84" class="hash-link" aria-label="Direct link to 간단하게 시작한 첫 번째 모임" title="Direct link to 간단하게 시작한 첫 번째 모임" translate="no">​</a></h3>
<p>첫 번째 모임에선 앞으로 개발해야 할 이슈 중에서 'good-first-issue'로 설정된 상대적으로 쉬운(?) 이슈들에 대해서 설명을 듣고, 스프린트에 참여한 사람들이 자신이 개발해 보고 싶은 것을 고르는 자리가 마련되었습니다. 저는 스스로 설정한 두 번째 목표를 떠올리며 'good-first-issue' 중에서도 가장 간단해 보였던 <a href="https://github.com/line/armeria/issues/685" target="_blank" rel="noopener noreferrer" class="">‘Show Armeria version in DocService</a>’를 골라서 진행했습니다. 이슈에 대해서 간단하게 설명하자면, 제목 그대로 'Document Service'에 현재 Armeria의 버전을 표시하는 작업이었습니다(당시 설명만 듣고는 정말 쉽게 끝날 줄 알았습니다 :) ). 개발은 다음 모임 때 진행하기로 하고 첫 번째 모임이 마무리되었습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="개발을-시작해-pr-등록까지-마친-두-번째-모임">개발을 시작해 PR 등록까지 마친 두 번째 모임<a href="https://armeria.dev/blog/ko/2019/12/24/my-first-opensource-contribution-to-armeria#%EA%B0%9C%EB%B0%9C%EC%9D%84-%EC%8B%9C%EC%9E%91%ED%95%B4-pr-%EB%93%B1%EB%A1%9D%EA%B9%8C%EC%A7%80-%EB%A7%88%EC%B9%9C-%EB%91%90-%EB%B2%88%EC%A7%B8-%EB%AA%A8%EC%9E%84" class="hash-link" aria-label="Direct link to 개발을 시작해 PR 등록까지 마친 두 번째 모임" title="Direct link to 개발을 시작해 PR 등록까지 마친 두 번째 모임" translate="no">​</a></h3>
<p>두 번째 모인 자리에서는 바로 개발이 진행되었습니다. 궁금한 점이 있으면 근처 멘토에게 찾아가 물어보거나 도움을 요청하면 된다는 설명과 함께 고독한 개발 시간이 시작되었습니다. 저는 가장 간단해 보이는 이슈를 선택했지만, 그럼에도 거대한 양의 코드 앞에서 무엇부터 시작해야 할지 감이 잘 오지 않았습니다. 게다가 제 이슈는 너무나 간단한 이슈였기 때문에 별다른 설명이 없어서 혼자서 끙끙대고 있었는데요. 그렇게 시간이 흘러가 버리는 게 아까워서 근처에 계신 멘토 님께 도움을 요청했습니다. 멘토 님은 해당 이슈에 대해 자세하게 설명해 주며 가장 처음에 해야 할, 프로젝트 세팅과 제가 개발해야 하는 부분을 파악하는 작업까지 도와주셨습니다.</p>
<p>어느 정도 가이드를 받고 나니 혼자서도 충분히 개발을 진행할 수 있게 되었습니다. 버전과 관련된 소스 코드를 살펴보면서 화면의 어느 곳에 버전을 표시하면 가장 좋을지 고민했습니다. 제일 잘 보이면서 어색하지 않은 곳에 위치시키면 좋을 것 같아서 최상단 타이틀 옆에 버전 표시를 추가해도 되는지 멘토와 상의한 뒤 빠르게 추가해 보았습니다. 정말 간단하게 추가할 수 있었는데요. 추가하고 나니 한 가지 거슬리는 부분이 있었습니다. 버전은 '0.84.0-SNAPSHOT'와 같은 형식으로 표시되었는데요. 뒤에 불필요하게 붙어 있는 'SNAPSHOT' 텍스트를 제거하면 더 깔끔해질 것 같았습니다. 그래서 'SNAPSHOT' 텍스트를 지우고 버전과 관련된 숫자만 표시되도록 다시 수정한 뒤, 드디어 첫 오픈 소스 PR(pull request)인 <a href="https://github.com/line/armeria/pull/1744" target="_blank" rel="noopener noreferrer" class="">Show armeria version in doc service #685</a>를 등록했습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/my-first-opensource-contribution-to-armeria-1-b8b4e9c95de92654ec324075276ccda9.png" width="1024" height="282" class="img_ev3q"></p>
<p>직접 진행하면서 오픈 소스에도 이렇게 간단하게 끝나는 이슈가 있다는 점에 놀랐고, 한편으론 오픈 소스에 기여하는 건 아무나 할 수 없는 어려운 거라고 생각했던 제 짧은 생각이 부끄럽게 느껴졌습니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="오픈-소스-기여의-진정한-시작-리뷰">오픈 소스 기여의 진정한 시작, 리뷰<a href="https://armeria.dev/blog/ko/2019/12/24/my-first-opensource-contribution-to-armeria#%EC%98%A4%ED%94%88-%EC%86%8C%EC%8A%A4-%EA%B8%B0%EC%97%AC%EC%9D%98-%EC%A7%84%EC%A0%95%ED%95%9C-%EC%8B%9C%EC%9E%91-%EB%A6%AC%EB%B7%B0" class="hash-link" aria-label="Direct link to 오픈 소스 기여의 진정한 시작, 리뷰" title="Direct link to 오픈 소스 기여의 진정한 시작, 리뷰" translate="no">​</a></h2>
<p>'오픈 소스 기여는 리뷰를 받으면서 시작된다'라는 말과 함께, 앞으로는 리뷰를 통해서 온라인에서 만나자고 전달받고 스프린트가 종료되었습니다. 사실 그 말을 들으면서도 속으로는 '이렇게 간단한 이슈니 쉽게 끝날 수 있겠지'라고 생각했습니다.</p>
<p>하나의 PR이 머지(merge)되기 위해서는 CI(Continuous Integration)를 통과한 후 메인테이너의 승인(approve)을 받아야 합니다.
PR을 등록하자마자 처음 달렸던 코멘트는 개발용 코드를 제외해 달라는 내용이었습니다. 개발하기 위해 설정을 변경해 두었던 것을 깜빡 잊고 개발용 코드가 포함된 상태로 PR을 올리는 바람에 CI 과정에서 기본적으로 진행되는 검사에서 에러를 의미하는 빨간불이 표시되었고, 관련 내용을 확인한 리뷰어가 남겨준 코멘트였습니다. 다행히 문제가 되었던 부분을 금방 발견해 빠르게 수정할 수 있었습니다. 그 코멘트를 시작으로 간단하게 끝날 거라고 생각했던 제 작업에 여러 코멘트가 달리기 시작했습니다. 리뷰어들이 여러 가지 개선 사항을 제시해 주었고, 그걸 보며 드디어 오픈 소스 기여가 시작되었다는 것을 느낄 수 있었습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="자유로운-의견-제시를-통한-개선">자유로운 의견 제시를 통한 개선<a href="https://armeria.dev/blog/ko/2019/12/24/my-first-opensource-contribution-to-armeria#%EC%9E%90%EC%9C%A0%EB%A1%9C%EC%9A%B4-%EC%9D%98%EA%B2%AC-%EC%A0%9C%EC%8B%9C%EB%A5%BC-%ED%86%B5%ED%95%9C-%EA%B0%9C%EC%84%A0" class="hash-link" aria-label="Direct link to 자유로운 의견 제시를 통한 개선" title="Direct link to 자유로운 의견 제시를 통한 개선" translate="no">​</a></h3>
<p>오픈 소스 기여를 경험하면서 느끼게 된 점 중 하나는, 수평적인 관계를 통해 자유롭게 의견을 제시하는 LINE의 문화가 오픈 소스에서도 그대로 나타나고 있었다는 점입니다. 좋은 아이디어가 떠오르면 누구나 코멘트를 통해서 자유롭게 의견을 제시하고, 이를 통해 오픈 소스가 더 좋은 방향으로 나아갈 수 있다는 점이 흥미로웠습니다.</p>
<p>제가 맡은 작업은 간단하게 버전만 표시하는 것이었는데요. 메인테이너 분이 추가로 모듈별 커밋 날짜, 커밋 해시(hash), 해당 모듈의 상태 등 다른 유용한 정보를 함께 보여주면 어떻겠냐고 의견을 제시해 주었습니다. 저는 코멘트를 확인하고 어디에 보여 주면 좋을지 고민했습니다. 처음 DocService에 접근하면 아래와 같은 메인 페이지가 나타나는데요. 간단한 환영 메시지와 짧은 설명이 표시된 상단 외의 나머지 공간이 비어 있어서 허전해 보였습니다. 저는 메인 페이지의 빈 공간에 코멘트에서 언급된 정보들을 표시하면 어떻겠냐고 의견을 제시했고, 'Sounds like a good idea!'라는 긍정적인 피드백을 받았습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/my-first-opensource-contribution-to-armeria-2-f6e833d0f7f64840c005286b3b611d61.png" width="1024" height="521" class="img_ev3q"></p>
<p>아래와 같이 허전해 보였던 메인 페이지에 <strong>Version information</strong>이라는 타이틀과 함께 표 형식의 버전 정보를 추가하니 화면이 유용한 정보로 가득 찬 느낌입니다. 추가 작업을 진행하면서 가장 기억에 남았던 건 마지막 커밋 시각을 보여주는 <strong>Commit Time</strong> 컬럼 값 표시 형식의 변화 과정입니다. 처음에 해당 컬럼은 쉽게 시간을 알아보기 힘든 숫자로 표시되었는데요. 이를 사용자가 쉽게 인지할 수 있는 UTC String 형식으로 변경했습니다. 그 후 메인테이너 분이 현재 커밋 시점에서 얼마나 시간이 흘렀는지 사용자들이 더 쉽게 알아볼 수 있는 방법을 제안해 주어서 이를 적용했는데요. 적용하면서 추가로 기존 UTC String 형식으로 보여줬던 값을 말풍선(tooltip)으로 옮겨 사용자가 컬럼 값에 마우스를 올리면 정확한 시간을 함께 확인할 수 있도록 변경했습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/my-first-opensource-contribution-to-armeria-3-31690b686e3385df87c6d453a4781097.png" width="1024" height="363" class="img_ev3q"></p>
<p>이렇게 추가 개발을 진행하면서 Armeria에서 사용자 편의성을 많이 고려하며 개발하고 있다는 것을 느낄 수 있었습니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="찬란한-결과">찬란한 결과<a href="https://armeria.dev/blog/ko/2019/12/24/my-first-opensource-contribution-to-armeria#%EC%B0%AC%EB%9E%80%ED%95%9C-%EA%B2%B0%EA%B3%BC" class="hash-link" aria-label="Direct link to 찬란한 결과" title="Direct link to 찬란한 결과" translate="no">​</a></h2>
<p>처음 시작은 현재 버전을 표시하는 것뿐이었지만, 자유롭게 의견을 주고받으며 개발하는 과정을 거쳐서 최종적으로는 각 모듈별 버전 관련 정보 표시까지 추가하게 되었습니다. 제가 추가한 기능은 CI를 통과한 뒤 모든 메인테이너의 승인을 받아 머지되었고, 0.91.0 버전으로 마침내 릴리스되었습니다. 기여자(contributor) 명단에서 제 ID를 확인했을 때는 정말 말로 표현할 수 없을 만큼 기뻤습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/my-first-opensource-contribution-to-armeria-4-2cadac531c2515a7128b18317039c654.png" width="1024" height="471" class="img_ev3q"></p>
<p>해당 이슈를 처리하는 동안 리뷰어와 총 66개의 코멘트를 주고받았습니다. 중간에 잠시 잊고 있다가 리마인더를 받고 다시 시작하기도 했는데요. 그러다 보니 약 5개월이라는 긴 시간이 소요되었습니다. 오랜 시간이 걸렸지만, 꾸준히 저를 찾아주신 메인테이너 분들의 도움을 받아 포기하지 않고 지속적으로 개발한 덕분에 결국 오픈 소스에 기여할 수 있었습니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="마치며">마치며<a href="https://armeria.dev/blog/ko/2019/12/24/my-first-opensource-contribution-to-armeria#%EB%A7%88%EC%B9%98%EB%A9%B0" class="hash-link" aria-label="Direct link to 마치며" title="Direct link to 마치며" translate="no">​</a></h2>
<p>호기심으로 시작했지만, 개발을 진행하며 오픈 소스 생태계에 대해 좀 더 깊이 알게 된 좋은 경험이었습니다. 꼼꼼하게 코드를 리뷰하며 개선해야 할 부분을 짚어주고 더 좋은 방법과 더 좋은 코드를 조언해 준 많은 분들 덕분에 성장할 수 있는 기회를 잘 잡을 수 있었고, 스스로 설정한 목표를 달성하게 되어 아주 만족스러웠습니다.</p>
<p>Armeria 스프린트를 통해 오픈 소스에 기여해 보면서 오픈 소스에 대한 두려움을 이겨낼 수 있었습니다. 앞으로 주기적으로, 더 많이 오픈 소스에 기여하려고 합니다. 빠른 피드백과 함께 마지막까지 포기하지 않고 도와주신 모든 분들께 이 자리를 빌려 감사의 인사를 드립니다.</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[GitHub Contributions 그래프를 푸릇푸릇하게 만들어보아요(feat. Armeria Sprint)]]></title>
            <link>https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1</link>
            <guid>https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1</guid>
            <pubDate>Thu, 09 May 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[들어가며]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="들어가며">들어가며<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0" class="hash-link" aria-label="Direct link to 들어가며" title="Direct link to 들어가며" translate="no">​</a></h2>
<p>안녕하세요. 혹시 독자분들 중에서 <a href="https://help.github.com/en/articles/viewing-contributions-on-your-profile#contributions-calendar" target="_blank" rel="noopener noreferrer" class="">GitHub contribution graph</a>에 가뭄이 온 분들이 계신가요? 이번 글에서는 가뭄을 물러가게 할 Armeria Sprint 행사를 소개하고 그 후기를 공유하겠습니다.</p>
<p>종종 기술 컨퍼런스의 스케줄에서 '스프린트(sprint)'라는 일정을 보신 적이 있을 겁니다(예를 들면, <a href="https://us.pycon.org/2019/community/sprints/" target="_blank" rel="noopener noreferrer" class="">PYCON Development Sprint</a>). 혹은 애자일(agile) 개발 방법론에 등장하는 단어라서 스프린트라는 단어를 친숙하게 느끼는 분들도 많을 거라고 생각하는데요. 그럼 오픈소스 스프린트란 무엇인지, 그리고 오픈소스 스프린트인 'Armeria Sprint'에서는 어떤 활동이 진행되었는지 소개해보겠습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/armeria-sprint-1-1-86145b7d89389da073b2ac3d87ee8787.png" width="1276" height="172" class="img_ev3q"></p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="오픈소스-스프린트가-뭐죠">오픈소스 스프린트가 뭐죠?<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4-%EC%8A%A4%ED%94%84%EB%A6%B0%ED%8A%B8%EA%B0%80-%EB%AD%90%EC%A3%A0" class="hash-link" aria-label="Direct link to 오픈소스 스프린트가 뭐죠?" title="Direct link to 오픈소스 스프린트가 뭐죠?" translate="no">​</a></h2>
<p>오픈소스 스프린트란 오픈소스에 관심있는 사람들이 모여서 오픈소스에 기여해 보는 것이라고 정의할 수 있습니다(오픈소스 기여에 대해서는 <a class="" href="https://armeria.dev/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria">지난 포스팅</a>에서 더욱 자세히 다루고 있으니 참고해주세요). 행사마다 편차가 있겠지만 보통 진행 기간을 하루 정도로 잡고 오전에는 다같이 모여서 각자 할 일(어떤 이슈를 맡아서 할지)을 정하고 오후에는 집중해서 코딩을 합니다.</p>
<p>참여하는 사람은 크게 멘토와 멘티로 나눌 수 있는데요. 멘토는 주로 스프린트에서 다루기로 한 오픈소스에 직접 기여해본 경험이 있는 사람이 맡고, 아직 경험은 없지만 이번 기회에 기여해 보기로 마음먹고 참가 신청한 사람이 멘티가 됩니다. 이번 오픈소스 스프린트에서는 메인테이너 세 분께서 직접 멘토로 나섰습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="왜-하는-거예요">왜 하는 거예요?<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#%EC%99%9C-%ED%95%98%EB%8A%94-%EA%B1%B0%EC%98%88%EC%9A%94" class="hash-link" aria-label="Direct link to 왜 하는 거예요?" title="Direct link to 왜 하는 거예요?" translate="no">​</a></h3>
<p>오픈소스에 기여해 보고 싶어도 개인 시간을 따로 내어 작업하는 게 사실 쉬운 일은 아닙니다. 또한 질문거리들이 많은데 오픈소스는 질문을 어디에 해야 할지 몰라 망설이는 경우도 있고, 혼자서 하는 것보다는 여럿이 모였을 때 조금 더 열심히 해볼 수 있는 힘이 생기는 경우도 많습니다. 오픈소스 스프린트는 이렇게 평소에 마음은 있었지만 혼자서는 오픈소스에 기여할 시간을 내지 못했거나, 오픈소스 기여를 처음 시도해보는 사람들을 돕기 위해 열리는 행사입니다.</p>
<p>새로운 기여자들의 참여는 오픈소스 커뮤니티를 더욱 풍성하게 만듭니다. 멘토들의 입장에서도 여러 사람들을 직접 만나 그들의 질문에 답하면서 그동안 새로운 기여자들이 참여하기 어려웠던 장벽이 무엇이었는지 확인해 볼 수 있는 소중한 기회가 됩니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="armeria-sprint-정리">Armeria Sprint 정리<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#armeria-sprint-%EC%A0%95%EB%A6%AC" class="hash-link" aria-label="Direct link to Armeria Sprint 정리" title="Direct link to Armeria Sprint 정리" translate="no">​</a></h2>
<p>이번 행사는 LINE 개발자를 대상으로 참가자를 모집했습니다. 멘토와 멘티의 비율을 고려해 소수의 인원만 참가신청을 받았는데요. 금방 마감되고 추가로 대기 줄을 서는 모습에 깜짝 놀랐습니다. 참가 신청을 하는 것부터 알 수 있듯이 모두들 열정이 가득하셨습니다. 행사는 이틀에 나누어서 첫째 날에는 환영 세션이 2시간 동안 진행되었고, 둘째 날에는 스프린트가 4시간 동안 진행되었습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="welcome-session">Welcome Session<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#welcome-session" class="hash-link" aria-label="Direct link to Welcome Session" title="Direct link to Welcome Session" translate="no">​</a></h3>
<p>환영 세션에선 참가자들이 각자 자기 소개를 한 뒤, 아래의 내용을 가볍게 다루었습니다.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="오픈소스에-기여하기-전에-읽어보아야-할-것">오픈소스에 기여하기 전에 읽어보아야 할 것<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4%EC%97%90-%EA%B8%B0%EC%97%AC%ED%95%98%EA%B8%B0-%EC%A0%84%EC%97%90-%EC%9D%BD%EC%96%B4%EB%B3%B4%EC%95%84%EC%95%BC-%ED%95%A0-%EA%B2%83" class="hash-link" aria-label="Direct link to 오픈소스에 기여하기 전에 읽어보아야 할 것" title="Direct link to 오픈소스에 기여하기 전에 읽어보아야 할 것" translate="no">​</a></h4>
<ul>
<li class=""><a href="https://github.com/line/armeria/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer" class="">Contributing</a>
<ul>
<li class="">프로젝트에 기여하는 방법이나 기여할 때 지켜야 할 규칙이 설명되어 있는 문서입니다.</li>
<li class="">Armeria에서는 이런 사항들을 <a href="https://github.com/line/armeria/blob/master/CONTRIBUTING.md#checklist-for-your-pull-request" target="_blank" rel="noopener noreferrer" class="">Checklist for your pull request</a>로 정리해 놓았습니다. 잘 확인해두면 코드 리뷰에 걸리는 시간을 단축할 수 있습니다.</li>
</ul>
</li>
<li class=""><a href="https://cla-assistant.io/line/armeria" target="_blank" rel="noopener noreferrer" class="">Contributor License Agreement</a>
<ul>
<li class="">평소에는 그냥 지나쳤을 법한 문서입니다. 오픈소스에서는 보통 기여를 받기 전에 서명을 요구합니다.</li>
<li class="">서명 내용을 짧게 세 줄로 요약해보았습니다(프로젝트마다 내용은 다를 수 있습니다).<!-- -->
<ul>
<li class="">서명의 목적은 기여자와 프로젝트, 유저를 보호하기 위함입니다.</li>
<li class="">서명을 완료하면 여러분은 각자가 기여한 부분을 Armeria 프로젝트와 동일한 조건으로 공개하는 것에 동의하게 됩니다.</li>
<li class="">여러분의 기여는 현재 상태 그대로 Armeria 프로젝트에 반영될 것이며 어떤 버그나 결함이 있어도 그에 대한 책임은 지지 않아도 됩니다.</li>
</ul>
</li>
</ul>
</li>
<li class=""><a href="https://github.com/line/armeria/blob/master/CODE_OF_CONDUCT.md" target="_blank" rel="noopener noreferrer" class="">Code of Conduct</a>
<ul>
<li class="">커뮤니티에서 준수해야 할 행동 규범입니다. 오픈소스의 기본 정신인 '자유'를 추구하기 위해서 꼭 지켜야 하는 행동 규범을 설명하는 문서입니다.</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="할-일-정하기">할 일 정하기<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#%ED%95%A0-%EC%9D%BC-%EC%A0%95%ED%95%98%EA%B8%B0" class="hash-link" aria-label="Direct link to 할 일 정하기" title="Direct link to 할 일 정하기" translate="no">​</a></h4>
<p>첫날 모이는 가장 큰 이유가 바로 각자 할 일을 정하기 위해서였는데요. 다같이 모여 초심자를 기다리는 이슈들(<a href="https://github.com/line/armeria/issues?q=is%3Aopen+is%3Aissue+label%3Agood-first-issue" target="_blank" rel="noopener noreferrer" class="">good-first-issues</a>)을 함께 확인해 보았습니다. 이슈마다 각각 설명이 쓰여있긴 하지만, 어떤 배경이나 흐름에서 이런 이슈가 발견되었는지 또는 해당 이슈를 해결하기 위해 어떤 기술 배경지식이 필요하고 어떤 부분을 봐야하는지 등 조금 더 자세한 설명을 들을 수 있었습니다.</p>
<p>어떤 이슈를 맡을지 마음을 정했다면, 재빨리 해당 이슈에 'I am working on this.' 또는 'I'll handle this issue.' 등의 댓글을 남겨 다른 사람과 이슈가 겹치지 않도록 표시합니다.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="개발-환경-설정하기">개발 환경 설정하기<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#%EA%B0%9C%EB%B0%9C-%ED%99%98%EA%B2%BD-%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0" class="hash-link" aria-label="Direct link to 개발 환경 설정하기" title="Direct link to 개발 환경 설정하기" translate="no">​</a></h4>
<p>모두가 이슈를 고른 뒤, 다 함께 차근차근 개발 환경을 설정했습니다(<a href="https://github.com/line/armeria/blob/master/CONTRIBUTING.md#setting-up-your-ide" target="_blank" rel="noopener noreferrer" class="">개발 환경 설정 방법</a>).</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/armeria-sprint-1-2-083b5bebb1c751fbb46e8b72bc4a7c2d.jpg" width="2002" height="1280" class="img_ev3q"></p>
<p>개발 환경을 설정할 때 'fork&amp;clone이 다 된 사람은 물병을 눕혀서 표시해주세요.'라는 소소한 활동까지 더해졌습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="스프린트-결과">스프린트 결과<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#%EC%8A%A4%ED%94%84%EB%A6%B0%ED%8A%B8-%EA%B2%B0%EA%B3%BC" class="hash-link" aria-label="Direct link to 스프린트 결과" title="Direct link to 스프린트 결과" translate="no">​</a></h3>
<p>이번 스프린트를 통해 새로 open한 pull request들입니다.</p>
<ul>
<li class=""><a href="https://github.com/line/armeria/pull/1742" target="_blank" rel="noopener noreferrer" class="">#1742</a> Allow using wildcards with RequestContextExportingAppender</li>
<li class=""><a href="https://github.com/line/armeria/pull/1743" target="_blank" rel="noopener noreferrer" class="">#1743</a> Provide a way to create a client with an Endpoint rather than with a URI</li>
<li class=""><a href="https://github.com/line/armeria/pull/1744" target="_blank" rel="noopener noreferrer" class="">#1744</a> Show armeria version in doc service</li>
<li class=""><a href="https://github.com/line/armeria/pull/1745" target="_blank" rel="noopener noreferrer" class="">#1745</a> Enable to convert JSON format request to String</li>
<li class=""><a href="https://github.com/line/armeria/pull/1747" target="_blank" rel="noopener noreferrer" class="">#1747</a> Introduce 'export-as-curl' button to a debug request window</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/armeria-sprint-1-3-e6687888fa70e93961043304b6092178.jpeg" width="4032" height="3024" class="img_ev3q"></p>
<p>부끄럼 많은 참가자들의 초상권은 저희가 지켜 드리겠습니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/armeria-sprint-1-4-cc4f6442e399cee4c1ac98a48b7e8a1f.jpeg" width="3452" height="2233" class="img_ev3q"></p>
<p>내 랩탑은 내가 지킨다! 서있는 한이 있더라도 피자는 랩탑과 멀리멀리~</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="후기">후기<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#%ED%9B%84%EA%B8%B0" class="hash-link" aria-label="Direct link to 후기" title="Direct link to 후기" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="참가자들의-후기">참가자들의 후기<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#%EC%B0%B8%EA%B0%80%EC%9E%90%EB%93%A4%EC%9D%98-%ED%9B%84%EA%B8%B0" class="hash-link" aria-label="Direct link to 참가자들의 후기" title="Direct link to 참가자들의 후기" translate="no">​</a></h4>
<ul>
<li class="">편하게 물어볼 수 있는 멘토가 함께 있다는 점, 그리고 서로 배려해주는 모습이 좋았습니다. 오픈소스에 대한 막연한 두려움을 줄일 수 있는 이런 기회가 앞으로는 더 많았으면 좋겠습니다.</li>
<li class="">설명으로는 분명 쉬워 보여서 이슈를 골랐는데 아무래도 멘토의 꾀임에 넘어간 것 같습니다(ㅋㅋ). 그렇지만 오픈소스에 기여해보는 시간을 가질 수 있다는 점이 굉장히 좋았습니다.</li>
<li class="">개발자라면 누구나 한 번쯤은 '오픈소스에 기여해봐야지'하고 생각해 봤을텐데요. 이렇게 시작해볼 수 있는 기회가 있어서 좋았습니다.</li>
<li class="">막상 해결하고 보니 실제 코딩한 건 몇 줄 안된 것 같아요. 그렇지만 생각해 볼 거리가 많은 이슈였습니다.</li>
<li class="">이슈에 대한 설명은 쉬웠는데요. 기존 코드를 이해하는데 시간이 오래 걸린 것 같습니다. Armeria의 코드나 구조를 전반적으로 훑어보는 시간이 먼저 있으면 조금 더 쉽게 접근할 수 있을 것 같습니다.</li>
<li class="">그동안 다른 오픈소스에 기여해보려고 몇 번 시도를 한 적이 있는데 매번 실패했습니다. 이번에는 멘토가 옆에 있으니 쉽게 기여할 수 있었습니다.</li>
<li class="">팀에서 Armeria를 사용 중입니다. 개발하다가 뭔가 필요한 것이 있을 때가 있는데요. 그럴 때 앞으로는 직접 기여해서 고쳐보면 좋겠다고 생각해서 참여하게 되었습니다. 코드를 읽으면서 공부를 조금 더 해보겠습니다.</li>
<li class="">저에게는 이슈에 접근하는 것이 조금 어렵게 느껴졌습니다. 그렇지만 이번 기회에 기본기를 다지게 된 것 같아 좋았습니다.</li>
<li class="">어느 정도 기능 구현은 다 된 것 같은데 pull request를 열기 전에 시간이 끝나서 아쉽습니다. 정리해서 조만간 pull request 열겠습니다.</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="멘토들의-후기">멘토들의 후기<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#%EB%A9%98%ED%86%A0%EB%93%A4%EC%9D%98-%ED%9B%84%EA%B8%B0" class="hash-link" aria-label="Direct link to 멘토들의 후기" title="Direct link to 멘토들의 후기" translate="no">​</a></h4>
<ul>
<li class="">오픈소스 개발을 어려워하시는 분들에게 - 어떤 이슈를 보고 어떻게 해결할 수 있을지 잘 모르겠다면, 어떻게 해결하면 좋을지 그 이슈에 댓글을 남기는 것부터가 오픈소스 기여의 시작입니다. 너무 걱정하지 말고 마구 물어보세요. 그런 질문들이 저희에게는 많은 도움이 됩니다.</li>
<li class="">이번 기회로 오픈소스에 관심이 있는 개발자 동료들이 이렇게나 많았다는 것을 알 수 있었습니다. 함께 같은 공간에서 서로 도울 수 있어서 뿌듯했습니다(Star는 모두 잊지 않으셨죠?).</li>
<li class="">처음 해보는 행사라서 조금 걱정을 했는데 참가자 모두 굉장히 진지하게 임해주셔서 감사하다는 말씀을 드리고 싶습니다. 행사 시간은 끝났지만 질문이 있을 때는 언제든지 GitHub이나 Slack에 남겨주세요.</li>
<li class="">물론 오늘 pull request를 여는 것만으로도 큰 진전이었지만, 시작은 지금부터라고 말씀드리고 싶습니다. 특히 코드 리뷰를 통해서 개발 실력이 많이 성장하기 때문에 포기하지 말고 머지(merge)되기까지 열심히 따라와 주시면 좋겠습니다.</li>
<li class="">기여자를 직접 만나 함께 문제를 해결하는 시간이 굉장히 뜻깊었습니다. 앞으로도 이런 행사를 자주하면 좋겠습니다.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="정리하며">정리하며<a href="https://armeria.dev/blog/ko/2019/05/09/armeria-sprint-1#%EC%A0%95%EB%A6%AC%ED%95%98%EB%A9%B0" class="hash-link" aria-label="Direct link to 정리하며" title="Direct link to 정리하며" translate="no">​</a></h2>
<p>참가자 여러분들 모두 고생 많으셨습니다. 이번 행사가 함께 성장하는 시간이 되었길 바랍니다. 모두들 즐겁게 참여해주셔서 감사드리며, 다음에 더욱 알찬 행사로 돌아오겠습니다.</p>
<p>저는 이런 종류의 행사를 처음 진행해보았는데요. 아래 두 문서에서 큰 도움을 받았습니다. 이 글을 통해서 아래 두 문서를 작성하신 분들께도 감사의 인사를 드립니다.</p>
<ul>
<li class=""><a href="https://github.com/drud/sprint_guide" target="_blank" rel="noopener noreferrer" class="">Open Source Contribution Sprint Guide by DRUD</a></li>
<li class=""><a href="https://opensourceevents.github.io/" target="_blank" rel="noopener noreferrer" class="">The In-Person Event Handbook by opensource-events</a> (<a href="https://muchtrans.com/translations/in-person-event-handbook.ko.html" target="_blank" rel="noopener noreferrer" class="">한국어 번역본</a>)</li>
</ul>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[오픈소스 Armeria의 기여자를 위한 이벤트를 진행하였습니다]]></title>
            <link>https://armeria.dev/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria</link>
            <guid>https://armeria.dev/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria</guid>
            <pubDate>Tue, 16 Apr 2019 00:00:00 GMT</pubDate>
            <description><![CDATA[들어가며]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="들어가며">들어가며<a href="https://armeria.dev/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0" class="hash-link" aria-label="Direct link to 들어가며" title="Direct link to 들어가며" translate="no">​</a></h2>
<p>안녕하세요.
LINE에서 오픈소스를 담당하고 있는 이서연입니다. 이번 글에서는 LINE에서 이번에 처음 시행한 이벤트인 'Armeria contributor reward'를 소개하고 그 후기를 공유드리려고 합니다. 참고로 이번 글에서는 Armeria에 대한 기술적인 설명은 하지 않습니다. 기술에 대한 자세한 설명은 <a href="https://line.github.io/armeria" target="_blank" rel="noopener noreferrer" class="">공식 홈페이지</a>에서 확인하실 수 있습니다.</p>
<p><a href="https://github.com/line/armeria" target="_blank" rel="noopener noreferrer" class="">Armeria</a> 프로젝트는 LINE에서 개발하여 오픈소스로 공개한 프로젝트입니다. 비록 시작은 LINE에서 했지만, Armeria가 지금의 모습을 갖추기까지는 LINE 밖 여러 기여자(contributor)분들의 열정적인 참여가 큰 역할을 담당했습니다. 이에 저희는 기여자들에게 감사의 뜻을 전하고자 이번 이벤트를 기획하게 되었습니다.</p>
<p>본 내용으로 들어가기 전에 '오픈소스 기여'가 무엇인지 먼저 정리해보았습니다.</p>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="오픈소스-기여란">오픈소스 기여란?<a href="https://armeria.dev/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria#%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4-%EA%B8%B0%EC%97%AC%EB%9E%80" class="hash-link" aria-label="Direct link to 오픈소스 기여란?" title="Direct link to 오픈소스 기여란?" translate="no">​</a></h2>
<p>회사에서 프로젝트를 진행하면 개발팀, 기획팀, 사업팀, 디자인팀 등 여러 분야의 사람들이 함께 모여 일을 합니다. 오픈소스 프로젝트도 이와 마찬가지입니다. 개발 이외에도 테스트, 홍보, 디자인, 그리고 문서화 등의 작업이 모두 모여 하나의 훌륭한 오픈소스를 만들어 냅니다. 간혹 오픈소스 기여를 좁은 의미로만 해석하여 직접 작성한 코드가 프로젝트 코드에 머지(merge)되는 것만으로 한정할 때가 있는데요. 앞서 이야기한 것처럼 오픈소스가 만들어지는 과정에는 단지 '코딩'만 포함되는 것은 아닙니다. <strong>오픈소스의 성장과 유지에 도움되는 모든 활동</strong>이 오픈소스 기여에 포함된다고 볼 수 있습니다. 오픈소스 프로젝트를 주제로 발표해서 더 많은 사용자를 확보하는 활동, 문서화에 참여해 정교하고 정확한 문서 작성에 도움을 주는 활동, 새로운 아이디어를 제안해 문제 해결에 도움을 주는 활동, 버그 리포팅, 로고나 UI 디자인에 도움을 주는 활동 모두가 오픈소스 기여에 포함됩니다.</p>
<p>그렇다면 왜 오픈소스 세계에서는 기여자를 소중하게 생각할까요? 그냥 제작자가 마음대로 하면 안 되는 걸까요?</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="오픈소스-기여가-중요한-이유---제작자의-관점">오픈소스 기여가 중요한 이유 - 제작자의 관점<a href="https://armeria.dev/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria#%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4-%EA%B8%B0%EC%97%AC%EA%B0%80-%EC%A4%91%EC%9A%94%ED%95%9C-%EC%9D%B4%EC%9C%A0---%EC%A0%9C%EC%9E%91%EC%9E%90%EC%9D%98-%EA%B4%80%EC%A0%90" class="hash-link" aria-label="Direct link to 오픈소스 기여가 중요한 이유 - 제작자의 관점" title="Direct link to 오픈소스 기여가 중요한 이유 - 제작자의 관점" translate="no">​</a></h3>
<p>오픈소스 만드는 사람들과 직접 이야기를 나누어보면, 그들은 항상 프로젝트가 아직 완벽하지 않으며 사용자 피드백을 중심으로 더욱 발전해야 한다고 생각하고 있습니다. 오픈소스 운동의 대표적 인물인 <a href="https://ko.wikipedia.org/wiki/%EC%97%90%EB%A6%AD_%EB%A0%88%EC%9D%B4%EB%A8%BC%EB%93%9C" target="_blank" rel="noopener noreferrer" class="">에릭 레이먼드</a>가 쓴 글, '<a href="https://en.wikipedia.org/wiki/The_Cathedral_and_the_Bazaar" target="_blank" rel="noopener noreferrer" class="">성당과 시장</a>'을 읽어보면 오픈소스 개발 방법에 대해 자세히 나오는데요. 핵심은 사용자를 포함한 많은 사람들의 참여가 소프트웨어를 더욱 발전시킨다는 것입니다.</p>
<p>음식점을 예로 들어볼까요? 내가 식당 주인이고 음식을 만들어 판다고 생각해봅시다. 내가 만든 음식이 어떤 사람에게는 적당하고 또 어떤 사람에게는 달거나 맵거나 싱거울 수 있습니다. 또한 내가 만든 음식과 좀 더 잘 어울리는 식기나 식탁 혹은 플레이팅 방법을 알고 있는 사람이 있을 수도 있습니다. 음식이 좀 더 돋보이는 메뉴판 레이아웃을 알고 있는 사람도 있겠죠. 이런 유용한 피드백들을 바로 전달받을 수 있다면 어떨까요? 또한 그런 유용한 피드백을 전달한 사람이 직접 적용할 수 있게 만든다면 어떨까요? 좀 더 멋진 식당이 될 가능성이 크겠죠? 아마 맛집으로 소문나지 않을까요?</p>
<p>오픈소스는 사용자 피드백을 바탕으로 개발해 나간다고 말할 수 있습니다. 오픈소스로 공개해 놓고 사용자 피드백을 무시한다면 그 오픈소스는 사용자를 점점 잃게 될 것입니다. 사용하는 사람이 줄어들면 제품의 가치는 같이 줄어들 수밖에 없습니다. 또한 사용자 피드백을 무시하지 않고 받아들인다고 해도 만약 혼자서 모든 것을 감당하려고 한다면 역시 문제가 발생할 수 있습니다. 사용자가 늘어나면 피드백도 함께 늘어나게 될 텐데요. 늘어난 피드백을 참여자들의 도움없이 혼자서 모두 응답하는 건 점점 어려워질 테고, 그렇게 품질이 저하되며 결국 사용자는 감소하게 될 것입니다. 결국 그 오픈소스는 죽은 오픈소스라고 불리겠죠.</p>
<p>사용자 피드백을 중심으로 개발할 땐 사용자와 제작자 간의 원활한 커뮤니케이션이 기본 바탕이 됩니다. 피드백이 신속하게 반영되면 그에 맞춰 사용자가 점점 늘어나고, 그 사용자가 다시 개발자가 되는 선순환의 구조가 탄탄한 커뮤니티를 형성하며 오픈소스를 지탱하게 됩니다.</p>
<p>여기까지 오픈소스 제작자의 관점에서 설명을 적어보았는데요. 오픈소스 개발에 참여하는 참여자의 입장에서도 한번 생각해 보겠습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="오픈소스-기여가-중요한-이유---참여자의-관점">오픈소스 기여가 중요한 이유 - 참여자의 관점<a href="https://armeria.dev/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria#%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4-%EA%B8%B0%EC%97%AC%EA%B0%80-%EC%A4%91%EC%9A%94%ED%95%9C-%EC%9D%B4%EC%9C%A0---%EC%B0%B8%EC%97%AC%EC%9E%90%EC%9D%98-%EA%B4%80%EC%A0%90" class="hash-link" aria-label="Direct link to 오픈소스 기여가 중요한 이유 - 참여자의 관점" title="Direct link to 오픈소스 기여가 중요한 이유 - 참여자의 관점" translate="no">​</a></h3>
<p>우선 요구 사항을 빨리 전달할 수 있습니다. 참여자들이 활발하게 활동하는 오픈소스는 질문을 남기면 다른 사용자나 메인테이너(maintainer)가 빠르게 응답해줍니다. 질문한 뒤 답을 빨리 받아볼 수 있다면 오픈소스를 더욱 쉽게 사용할 수 있겠죠? 또 고치고 싶은 부분이 있다면 다른 사람이 해줄 때까지 기다리지 않고 직접 고쳐볼 수 있습니다. 혼자 수정한 부분은 리뷰를 통해 의견을 받아볼 수 있고요. 이렇게 오픈소스에 참여한 이력은 고스란히 남아서 누구나 볼 수 있게 공개됩니다. 이런 이력들은 개발자 채용 과정에서 코딩 테스트보다 더욱 효과적으로 자신을 보여줄 수 있다는 장점이 있습니다.</p>
<p>혹시 그동안 오픈소스 프로젝트는 초고수 개발자들만 참여하는 거라고 생각해서 소극적인 태도로 그저 바라만 보고 있지는 않으셨나요? 이번 기회에 관심 있게 지켜보던 프로젝트의 issue 목록에서 'good-first-issue', 'first-timers-only' 혹은 'help-wanted' 같은 label이 붙은 것들을 찾아 한번 시작해보면 어떨까요?</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="armeria-contributor-reward-소개">Armeria contributor reward 소개<a href="https://armeria.dev/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria#armeria-contributor-reward-%EC%86%8C%EA%B0%9C" class="hash-link" aria-label="Direct link to Armeria contributor reward 소개" title="Direct link to Armeria contributor reward 소개" translate="no">​</a></h2>
<p>이번 행사의 목표는 감사 인사를 드리며 기여자들과 교류하는 것이었습니다. 오픈소스 프로젝트다 보니 개발에 참여하고 계신 분들이 전 세계 각지에 흩어져 있어서 소통이 주로 텍스트로만 이뤄졌는데요. 늘 코멘트로 짧게 LGTM(Looks Good To Me) 혹은 :thumbsup:으로만 마음을 전하는 것이 부족하다고 생각하고 있었습니다. 그래서 이번에는 기여자분들에게 개별적으로 이메일을 보내 인사를 드리고 소정의 선물을 전달하였습니다.</p>
<p>아래는 기여자들의 <a href="https://help.github.com/articles/personalizing-your-profile/#changing-your-profile-picture" target="_blank" rel="noopener noreferrer" class="">GitHub profile picture</a>를 활용한 이벤트 이미지입니다.
Armeria의 로고처럼 '핑크 핑크'한 색감이 참 예쁘죠?</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/thank-you-for-contributing-to-armeria-1-3f3df0d2b8c505b2e22a7d0c13a5bd23.png" width="1000" height="333" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="기여자들의-참여">기여자들의 참여<a href="https://armeria.dev/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria#%EA%B8%B0%EC%97%AC%EC%9E%90%EB%93%A4%EC%9D%98-%EC%B0%B8%EC%97%AC" class="hash-link" aria-label="Direct link to 기여자들의 참여" title="Direct link to 기여자들의 참여" translate="no">​</a></h3>
<p>GitHub에서는 기여자들의 활동 현황을 <a href="https://github.com/line/armeria/graphs/contributors" target="_blank" rel="noopener noreferrer" class="">그래프</a>로 볼 수 있는데요. 그래프 내용을 아래와 같이 정리해봤습니다. 현재까지 60명이 넘는 기여자들이 약 1,350번의 커밋을 통해 약 457,000줄을 추가하고 약 257,500줄을 삭제해주셨습니다. 숫자로 보니 다양한 사람들의 활발한 참여가 더욱 실감나네요.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/thank-you-for-contributing-to-armeria-2-fcb1737125e1ea66099c22a8139ee5f9.png" width="1093" height="309" class="img_ev3q"></p>
<p>기여자들이 어떤 부분에 기여해주셨는지 조금 더 자세하게 살펴볼까요?</p>
<ul>
<li class="">Your contribution led Armeria's annotated service to a whole new level.</li>
<li class="">Your Retrofit integration module was one of the greatest additions in Armeria's history.</li>
<li class="">HTTP redirection is now easier than ever with Armeria thanks to your contribution.</li>
<li class="">Your work on implementing the high quality circuit breaker in Armeria is considered as an all-time legend.</li>
<li class="">Your optimization of weighted round-robin load balancing algorithm was very clever idea that it was worth of a prize.</li>
<li class="">We appreciate your initial groundwork, especially on the client-side, which made today's Armeria.</li>
<li class="">Thank you for promoting Armeria to the developer communities and we appreciate your contribution to the project!</li>
<li class="">Your documentation clean-up made us look way better than ever.</li>
<li class="">Your help with fixing the bug made Armeria more stable than ever.</li>
<li class="">Although your part was small, your dedication saved many of our days.</li>
</ul>
<p>이 외에도 많은 기여자들이 다양하게 참여해 주셨는데요. 기여자 각각에게 개별적으로 감사 메시지를 전달하였습니다.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="수상-소감">수상 소감<a href="https://armeria.dev/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria#%EC%88%98%EC%83%81-%EC%86%8C%EA%B0%90" class="hash-link" aria-label="Direct link to 수상 소감" title="Direct link to 수상 소감" translate="no">​</a></h3>
<p>프로젝트 기여도를 보여주는 <a href="https://github.com/line/armeria/graphs/contributors" target="_blank" rel="noopener noreferrer" class="">그래프</a>에 나타나듯 프로젝트 오너(owner)를 제외하고 가장 많이 기여해준 기여자는 <a href="https://github.com/line/armeria/commits?author=anuraaga" target="_blank" rel="noopener noreferrer" class="">@anuraaga</a> 님입니다. 이번 행사를 진행하면서 <a href="https://github.com/line/armeria/commits?author=anuraaga" target="_blank" rel="noopener noreferrer" class="">@anuraaga</a> 님에게 짧게나마 소감을 여쭤볼 수 있었습니다.</p>
<p>Q. 짧게 자기 소개 부탁드릴께요.</p>
<p>A. 안녕하세요. 다들 'Rag'라고 불러주시는 Anuraag입니다. 저는 여러 대규모 서버 사이드 프로젝트를 수행해 온 소프트웨어 엔지니어입니다. 처음 Armeria를 알게 된 건 LINE Shop 팀에서 근무할 때인데요. 정말 엄청난 우연이었습니다. 제가 팀에 합류한 뒤 기존 <a href="https://thrift.apache.org/" target="_blank" rel="noopener noreferrer" class="">Thrift</a> 라이브러리를 대체할 완전한 기능이 갖춰진(full-featured) <a href="https://en.wikipedia.org/wiki/Remote_procedure_call" target="_blank" rel="noopener noreferrer" class="">RPC</a> 프레임워크가 필요했거든요. 그런데 그때 마침 <a href="https://github.com/trustin" target="_blank" rel="noopener noreferrer" class="">@trustin</a>(Trustin, 프로젝트 오너)이 바로 그걸 목적으로 Armeria 프로젝트를 시작했더라고요. 그래서 그 이후로, 심지어 LINE을 떠난 후에도 저는 모든 프로젝트에서 Armeria를 사용하고 있으며 제가 기여할 수 있는 부분이 있다면 꾸준히 기여도 하고 있습니다.</p>
<p>Q.
Armeria를 어떻게 사용하고 계신가요?</p>
<p>A. 저는 업무에서나 개인적으로나 모든 서버 사이드 니즈(needs)에 Armeria를 사용합니다. 저희 회사 <a href="https://www.infostellar.net/" target="_blank" rel="noopener noreferrer" class="">Infostellar</a>는 위성 통신을 위한 글로벌 네트워크 인프라스트럭처를 구축하고 있는데요. 일반적인 API 요구사항을 만족해야 하는 것은 물론 아주 많은 양의 데이터도 전송해야 합니다. 저희 아키텍처는 표준 서비스 기반 아키텍처를 따르는데요. 많은 서버가 <a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer" class="">Kubernetes</a>에서 실행되면서 Armeria를 사용해서 <a href="https://grpc.io/" target="_blank" rel="noopener noreferrer" class="">gRPC</a> API를 열어 놓고 있습니다. 또한 Armeria의 정적 파일 서비스 기능과 gRPC-Web 지원을 통해 제공되는 웹 프론트엔드도 있습니다.</p>
<p>업무에서 뿐만 아니라 주말에 개인적으로 진행하는 프로젝트에서도 Armeria를 사용합니다. 제게 필요한 유스케이스에 따라 다양한 크기의 프로젝트에서 Armeria를 효과적으로 사용할 수 있어 기쁘네요. :)</p>
<p>Q.
Armeria에서 가장 좋은 점을 꼽아본다면?</p>
<p>A. 제 생각에 Armeria의 가장 큰 장점은 개발자의 생산성에 초점을 맞췄다는 점입니다.
Trustin은 모든 개발자의 요구 사항을 만족시킬 만한 프로젝트를 만들어냈습니다.
Armeria는 굉장히 유연하고, 모범 사례를 보여주며, 개발자들이 '비동기(asynchronous) 프로그래밍'과 같은 최신 트렌드를 접하게 해줍니다. 저는 메인테이너가 굉장히 이론적인 접근을 취하는 프레임워크나 라이브러리를 봤는데요. 그런 식으로 운영하면 종종 개발자가 아니라 메인테이너가 원하는 방향으로 초점이 맞춰지면서 정작 개발자들은 사용하기 어려운 라이브러리가 되더군요.
Armeria는 Slack 채널에서 완전한 지원을 제공하는 등 개발자의 요구에 초점을 잘 맞추고 있어서 다양한 스펙트럼의 개발자들에게 유용할 거라고 생각합니다.</p>
<p>또한 Armeria는 제가 본 프레임워크 중 가장 유연한 서버 프레임워크입니다. 동일한 TCP 포트로 gRPC, 정적 파일(static files), <a href="https://dzone.com/articles/metrics-for-microservices" target="_blank" rel="noopener noreferrer" class="">metrics</a>, <a href="https://line.github.io/armeria/server-docservice.html#server-docservice" target="_blank" rel="noopener noreferrer" class="">DocService</a>와 기타 컨텐츠를 모두 제공할 수 있다는 점은 정말 큰 성과라고 할 수 있습니다.</p>
<p>Q.
Armeria 개발에 참여하면서 힘들었던 적이 있으신가요?</p>
<p>A.
Armeria 개발하면서 특별히 힘들었던 적은 없습니다.
Armeria는 문서화가 잘 되어 있고, IDE(통합 개발 환경, Integrated Development Environment) 설정도 따라하기 쉽게 되어 있으며, 상냥한 리뷰어들 덕분에 PR(Pull Request)도 원활히 진행됩니다. 아주 잠시지만 릴리스가 좀 느리게 진행되는 것 같다고 느낀 적은 있습니다. 버그수정(bugfix)이 머지(merge)는 되었는데 릴리스는 되지 않아서 버그수정이 포함된 스냅샷(snapshot)을 배포한 적이 있거든요. 하지만 최근에는 자주 릴리스되고 있어서 그런 기분을 느끼지 않고 있습니다. :)</p>
<p>사소한 것 하나 언급하자면, 제 생각엔 바꾸기 어려울 것 같은데요. 저는 import한 코드 설정을 사용하는데도 공백 포맷을 제대로 적용하는 데 어려움을 겪습니다.
Trustin이 제가 놓친 몇몇 공백 이슈를 발견하고 나중에 다른 PR을 통해 수정하는 것을 지켜볼 때 특히 당혹스럽네요. ;) 자동 포맷터(formatter)를 사용하면 개발 중 걱정거리를 하나 줄일 수 있을 것 같습니다.</p>
<p>Q. 프로젝트와 관련해 앞으로 계획하고 있거나 기대하는 것이 있나요?</p>
<p>A. 저는 개인적으로 유용할 것 같은 기능을 발견하면 코드에 기여하는 등 계속 Armeria를 사용할 계획입니다. 사실 이건 좋은 질문이에요. 비록 저는 프로젝트에 대한 기대가 무엇인지 명확하게 알진 못하지만요.
Armeria엔 기능 요청이 많이 들어옵니다. 그 중엔 종종 제한된 범위의 기술을 사용하는 요청도 있습니다. 지금 머리에 떠오르는 <a href="https://github.com/line/armeria/issues/194" target="_blank" rel="noopener noreferrer" class="">사례</a>는 더 많은 <a href="https://microservices.io/patterns/client-side-discovery.html" target="_blank" rel="noopener noreferrer" class="">service discovery</a> 메커니즘을 위한 지원을 추가하는 건이네요. 또한 <a href="https://spring.io/projects/spring-security" target="_blank" rel="noopener noreferrer" class="">Spring Security</a>를 기본적으로 지원할 지 여부도 있습니다. 저는 전 세계의 모든 기술을 지원하는 것이 Armeria의 범위는 아니라고 생각하는데요. 선을 어떻게 그어야 할지 모르겠습니다.</p>
<p>Q. 오픈소스(또는 오픈소스 기여에 대해) 하실 말씀이 있다면?</p>
<p>A. 저는 오픈소스가 너무 좋습니다! 제 생각에 오픈소스는 개발자들에게 유용한 기술을 만들어내기도 하면서, 또한 강력한 커뮤니티를 만들어주는 일도 하고 있습니다. 오픈소스를 통해 많은 친구들을 만나게 되어 정말 놀랍고 행복합니다. 저는 앞으로도 꾸준히 오픈소스 활동을 하며 더 많은 사람들을 만나게 되길 바라고 있고요. 주위에 시간 여유가 되시는 분들에겐 본인이 좋아하는 저장소에 PR 한번 보내보라고 독려할 거에요.</p>
<p>Q. 마지막으로 더 하고 싶은 이야기가 있으실까요?</p>
<p>A. 이런 이벤트가 열려서 정말 즐겁네요.
LINE과 같은 선도 기업에서 오픈소스 확장에 중점을 두는 건 굉장한 일입니다. 기업들이 소스코드 몇 개 내놓는 것은 쉬울 수 있는데요. 이렇게 실제로 생태계 자체를 지원하는 건 절대 쉽지 않거든요. 오픈소스 커뮤니티를 구축하는데 도움을 주셔서 정말 고맙습니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="마치며">마치며<a href="https://armeria.dev/blog/ko/2019/04/16/thank-you-for-contributing-to-armeria#%EB%A7%88%EC%B9%98%EB%A9%B0" class="hash-link" aria-label="Direct link to 마치며" title="Direct link to 마치며" translate="no">​</a></h2>
<p>저는 이번에 'Armeria contributor reward'를 진행하면서 이벤트를 처음 진행해 봤는데요. 여러가지 새로운 경험이 즐거운 기억으로 남았습니다. 이런 즐거운 경험이 오픈소스의 매력이 아닐까 싶습니다.</p>
<p>Armeria에서 새로운 경험을 쌓아보고 싶으신가요? '<a href="https://github.com/line/armeria/issues?q=is%3Aopen+is%3Aissue+label%3Agood-first-issue" target="_blank" rel="noopener noreferrer" class="">good-first-issue</a>'를 한번 둘러보세요. 이미 Armeria에 익숙하신가요? 현재 1.0.0 버전 릴리스를 위해 필요한 것들을 정리하고 있는데요. 관련하여 <a href="https://github.com/line/armeria/issues/1704" target="_blank" rel="noopener noreferrer" class="">이곳</a>에서 아이디어를 공유해보세요.</p>
<p>Armeria에서는 더욱 많은 사용자와 기여자를 확보하기 위해 다양한 프로그램을 기획하고 있습니다. 앞으로 진행할 이벤트도 이번과 마찬가지로 이곳, <a href="https://engineering.linecorp.com/ko/blog/" target="_blank" rel="noopener noreferrer" class="">LINE Engineering blog</a>와 <a href="https://line-armeria.slack.com/join/shared_invite/enQtNjIxNDU1ODU1MTI2LTgwMzk0MzVhOGRhZjJiY2ExODc0MzNhYzIxZDFlYjM5OGRjNTE1MzYzYzQ4MzNhNGY2ZDM0NThhMTRmZmQ3ZjQ" target="_blank" rel="noopener noreferrer" class="">공식 Slack</a>에서 소식을 전해드리겠습니다.</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Channel Gateway에 CircuitBreaker 적용]]></title>
            <link>https://armeria.dev/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway</link>
            <guid>https://armeria.dev/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway</guid>
            <pubDate>Thu, 04 Aug 2016 00:00:00 GMT</pubDate>
            <description><![CDATA[들어가기에 앞서]]></description>
            <content:encoded><![CDATA[<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="들어가기에-앞서">들어가기에 앞서<a href="https://armeria.dev/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway#%EB%93%A4%EC%96%B4%EA%B0%80%EA%B8%B0%EC%97%90-%EC%95%9E%EC%84%9C" class="hash-link" aria-label="Direct link to 들어가기에 앞서" title="Direct link to 들어가기에 앞서" translate="no">​</a></h2>
<p><a class="" href="https://armeria.dev/blog/ko/2016/07/24/circuit-breakers-for-distributed-services">Circuit Breaker에 대한 소개 블로그</a>를 읽지 않았다면 먼저 읽어보시길 권장합니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="channel-gateway에-circuitbreaker-적용하기">Channel Gateway에 CircuitBreaker 적용하기<a href="https://armeria.dev/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway#channel-gateway%EC%97%90-circuitbreaker-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0" class="hash-link" aria-label="Direct link to Channel Gateway에 CircuitBreaker 적용하기" title="Direct link to Channel Gateway에 CircuitBreaker 적용하기" translate="no">​</a></h2>
<p>Channel Gateway 서버에서는 LINE의 다양한 서버들의 기능을 CP(Contents Provider)들에게 제공하는 역할을 맡고 있습니다. 그러다보니 Channel Gateway 서버들은 연결된 서버들에 영향을 많이 받게 됩니다. 그리고, 그러한 영향들은 쉽게 전체 Channel Gateway 서버들에게 전파됩니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/applying-circuitbreaker-to-channel-gateway-1-537a3aa178c1835906c7a42d541dac55.png" width="870" height="328" class="img_ev3q"></p>
<!-- -->
<p>이 문제를 해결하기 위하여 고민하던 중에 CircuitBreaker에 관한 내용을 들었습니다. 특정 서버에서 장애가 발생할 경우 CircuitBreaker가 이를 감지하고 그 서버로 요청하는 호출을 차단하면 문제를 충분히 해결할 수 있다고 생각했습니다. 그래서 Channel Gateway에 CircuitBreaker를 적용하기로 했습니다.</p>
<p>Channel Gateway를 위한 CircuitBreaker를 직접 구현할 수도 있었지만, <a href="http://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a>에는 CircuitBreaker가 훌륭하게 만들어져 있었습니다.
Armeria의 CircuitBreaker는 여러 가지 옵션들을 원하는 대로 설정하여 <code>CircuitBreakerBuilder</code>를 통해 구현된 <code>CircuitBreaker</code> 객체를 얻을 수 있습니다. 이 객체를 통하여 Channel Gateway에 맞게 커스터마이즈할 수 있게 구현되어 있어서 어렵지 않게 적용할 수 있었습니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="circuitbreaker의-애너테이션-사용">CircuitBreaker의 애너테이션 사용<a href="https://armeria.dev/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway#circuitbreaker%EC%9D%98-%EC%95%A0%EB%84%88%ED%85%8C%EC%9D%B4%EC%85%98-%EC%82%AC%EC%9A%A9" class="hash-link" aria-label="Direct link to CircuitBreaker의 애너테이션 사용" title="Direct link to CircuitBreaker의 애너테이션 사용" translate="no">​</a></h2>
<p>talk-channel-gateway 소스코드에서 CircuitBreaker는 <code>@CircuitBreakable</code> 애너테이션을 사용하여 적용할 수 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@CircuitBreakable(CircuitBreakerGroup.HBASE_CLIENT_USER_SETTINGS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public ChannelSettings findBy(String mid) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>위와 같이 적용한 경우, <code>findBy()</code> 메서드가 호출될 때마다 성공/실패를 감시하고, 그 결과에 따라 CircuitBreaker가 열리거나 닫히게 됩니다.
HBASE_CLIENT_USER_SETTINGS는 CircuitBreaker로 묶일 그룹을 지정하는 것으로서, 메서드들의 실패율을 계산할 때도 그룹 전체의 호출 회수 대비 실패 회수로 계산하고, CircuitBreaker가 열리거나 닫힐 때도 함께 열리거나 닫히게 됩니다.
CircuitBreaker의 설정은 <code>CircuitBreakerGroup</code>이라는 enum 객체에서 다음과 같이 설정할 수 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public enum CircuitBreakerGroup implements ExceptionFilter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SAMPLE_DEFAULT {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SAMPLE_API {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        protected ExceptionFilter exceptionFilter() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return cause -&gt; !(cause instanceof AuthenticationException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              || cause instanceof ApiPermissionException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              || cause instanceof ImproperRequestException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HBASE_CLIENT_CHANNEL_MATRIX {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HBASE_CLIENT_USER_SETTINGS {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected ExceptionFilter exceptionFilter() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return cause -&gt; true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public CircuitBreaker circuitBreaker(CircuitBreakerListener listener) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new CircuitBreakerBuilder(name()).exceptionFilter(exceptionFilter())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .listener(listener)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean shouldDealWith(Throwable throwable) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return exceptionFilter().shouldDealWith(throwable);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Channel Gateway에서는 <code>ExceptionFilter</code>를 커스터마이즈하여 사용하였습니다. 그 외의 옵션들은 Armeria의 기본 옵션을 그대로 사용하였습니다. 만약, 다른 옵션들을 변경하여 사용하고 싶다면 <code>circuitBreaker()</code> 메서드를 수정하여 사용할 수 있을 것입니다.</p>
<p>Armeria에서는 기본적으로 어떠한 예외라도 발생할 경우 실패로 간주하도록 되어 있습니다. 하지만, Channel Gateway에서는 권한이 없는 경우 등을 예외로 처리하여 반환해주기 때문에 이를 구분할 필요가 있었습니다. 그래서, <code>ExceptionFilter</code>를 커스터마이즈하여 사용하였습니다. 그리고, CircuitBreaker의 상태가 변할 때마다 로그를 쌓을 수 있도록 Channel Gateway를 위한 이벤트 리스너도 추가하였습니다.</p>
<p>애너테이션에 적용하는 그룹은 enum 객체로 지정할 수 있으며, enum 객체 구현 부분에서 그룹별로 다른 설정을 할 수 있도록 하였습니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="circuitbreaker에서-proceed-구현">CircuitBreaker에서 proceed() 구현<a href="https://armeria.dev/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway#circuitbreaker%EC%97%90%EC%84%9C-proceed-%EA%B5%AC%ED%98%84" class="hash-link" aria-label="Direct link to CircuitBreaker에서 proceed() 구현" title="Direct link to CircuitBreaker에서 proceed() 구현" translate="no">​</a></h2>
<p><a href="https://en.wikipedia.org/wiki/AspectJ" target="_blank" rel="noopener noreferrer" class="">Aspect</a> 객체의 <code>proceed()</code> 코드는 다음과 같습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CircuitBreakerAspect implements Ordered {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final Map&amp;lt;CircuitBreakerGroup, CircuitBreaker&gt; circuitBreakers =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new EnumMap&amp;lt;&gt;(CircuitBreakerGroup.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @PostConstruct</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void initialize() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final CircuitBreakerListener listener =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new CircuitBreakerListenerImpl(circuitBreakerLogger);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (CircuitBreakerGroup group : CircuitBreakerGroup.values()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                circuitBreakers.put(group, group.circuitBreaker(listener));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Object proceed(final ProceedingJoinPoint pjp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               final CircuitBreakable circuitBreakable) throws Throwable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final CircuitBreakerGroup group = circuitBreakable.value();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            final CircuitBreaker circuitBreaker = circuitBreakers.get(group);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (circuitBreaker.canRequest()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                final Object result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = pjp.proceed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (Throwable e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (group.shouldDealWith(e)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        circuitBreaker.onFailure(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        circuitBreaker.onSuccess();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                circuitBreaker.onSuccess();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw CircuitBreakerException.circuitBroken();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre></div></div>
<p>코드는 비교적 간단합니다. <code>CircuitBreaker.canRequest()</code>를 통해 CircuitBreaker가 열려 있다면 예외를 발생시킵니다. 그렇지 않다면 메서드를 정상적으로 호출합니다. 호출한 결과 예외가 발생했고, 그 예외가 실패로 처리해야 하는 경우라면 CircuitBreaker에게 실패했다고 알려줍니다. 그렇지 않다면 CircuitBreaker에게 성공했다고 알려주기만 하면 됩니다. 참고로 실제 적용된 코드에는 CircuitBreaker가 잘 적용되었는지 확인하기 위한 IMON Logger1와 관련된 코드가 들어있습니다. 하지만, 여기에서는 CircuitBreaker 부분에 집중할 수 있도록 생략하였습니다.</p>
<p><em>1: IMON Logger: IMON은 LINE 사내의 다양한 서비스들을 모니터링하기 위한 시스템으로, IMON Logger는 IMON으로 대상 서비스의 통계지표 및 로그들을 취합하여 전송하는 기능을 하고 있다.</em></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="circuitbreaker의-설정-변경-메서드">CircuitBreaker의 설정 변경 메서드<a href="https://armeria.dev/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway#circuitbreaker%EC%9D%98-%EC%84%A4%EC%A0%95-%EB%B3%80%EA%B2%BD-%EB%A9%94%EC%84%9C%EB%93%9C" class="hash-link" aria-label="Direct link to CircuitBreaker의 설정 변경 메서드" title="Direct link to CircuitBreaker의 설정 변경 메서드" translate="no">​</a></h2>
<p>CircuitBreaker 객체를 만들어주는 <code>CircuitBreakerBuilder</code>에는 CircuitBreaker의 설정을 변경할 수 있는 여러 가지 메서드를 제공합니다. 가능하면 기본 설정 그대로 사용하는 것을 추천하지만 CircuitBreaker에 대해서 좀 더 이해하기 쉽도록 설정들에 대해서 설명드릴까 합니다.</p>
<table><thead><tr><th>메서드</th><th>파라미터</th><th>기본값</th><th>설명</th></tr></thead><tbody><tr><td>failureRateThreshold</td><td>double</td><td>0.8</td><td>CircuitBreaker를 열지 말지 판단할 때 사용하기 위한 실패율입니다. <code>counterSlidingWindow</code> 시간 동안의 실패율이 이 값보다 높을 경우 CircuitBreaker가 열리게 됩니다. 기본값 그대로 사용할 경우 80% 이상 실패하게 되면 CircuitBreaker가 열리게 됩니다. 다시 말해 성공하는 비율이 20% 미만이면 CircuitBreaker가 열리게 됩니다.</td></tr><tr><td>minimumRequestThreshold</td><td>long</td><td>10</td><td>CircuitBreaker를 열지 말지 판단할 최소의 호출 회수입니다. <code>counterSlidingWindow</code> 시간 동안의 호출 회수가 이 값 미만일 때는 CircuitBreaker를 열지 말지 판단하지 않습니다.</td></tr><tr><td>circuitOpenWindow</td><td>Duration</td><td>10초</td><td>CircuitBreaker가 Open 상태로 바뀐 후 Half-Open 상태로 바뀌기까지의 시간입니다. CircuitBreaker가 열린 후에는 <code>circuitOpenWindow</code> 시간만큼 흐른 후에 Half-Open 상태로 바뀌어서 호출을 테스트하게 됩니다.</td></tr><tr><td>circuitOpenWindowMillis</td><td>long</td><td>10000</td><td></td></tr><tr><td>trialRequestInterval</td><td>Duration</td><td>3초</td><td>Half-Open 상태에서 요청한 호출에 Closed응답이 없을 경우, 호출을 재시도하기 위해 기다리는 시간입니다. <code>trialRequestInterval</code> 시간 안에 응답이 올 경우에는 그 결과에 따라서 Closed나 Open 상태로 바뀌게 됩니다. 만약, Open 상태로 바뀌었다면 다시 <code>circuitOpenWindow</code> 시간만큼 기다렸다가 호출을 테스트하게 됩니다. 하지만, 요청한 호출이 <code>trialRequestInterval</code> 시간 동안 어느 응답도 오지 않는다면 다시 호출을 시도하게 됩니다.</td></tr><tr><td>trialRequestIntervalMillis</td><td>long</td><td>3000</td><td></td></tr><tr><td>counterSlidingWindow</td><td>Duration</td><td>20초</td><td>CircuitBreaker를 열지 말지 판단할 때 최근 <code>counterSlidngWindow</code> 시간만큼의 기록을 가지고 판단합니다. 기본값 그대로 사용하게 되면 최근 20초 동안의 호출 결과들만으로 판단하게 됩니다.</td></tr><tr><td>counterSlidingWindowMillis</td><td>long</td><td>20000</td><td></td></tr><tr><td>counterUpdateInterval</td><td>Duration</td><td>1초</td><td>CircuitBreaker에서는 호출의 결과를 <code>SlidingWindowCounter</code>를 통해서 보관하고 있는데 이때, 보관하는 단위의 시간을 의미합니다. 기본값 그대로 사용하게 되면 1초 단위로 기록을 가지고 있습니다. 예를 들면, 최근 20초 전 = 성공 20회, 실패 0회 / 최근 19초 전 = 성공 25회, 실패 1회 / ... / 최근 1초 전 = 성공 21회, 실패 0회 등의 기록을 가지고 있습니다. 이 1초 단위의 기록을 가지고 <code>counterSlidingWindow</code> 시간만큼을 계산하여 실패율을 계산하게 됩니다.</td></tr><tr><td>counterUpdateIntervalMillis</td><td>long</td><td>1000</td><td></td></tr><tr><td>exceptionFilter</td><td>ExceptionFilter</td><td>모든 예외를 실패로 간주</td><td>예외가 발생했을 때, 그 예외를 실패로 간주할지 여부를 반환하는 객체입니다. 기본값을 그대로 사용하게 되면 모든 예외를 실패로 간주합니다.</td></tr><tr><td>listener</td><td>CircuitBreakerListener</td><td></td><td>CircuitBreaker의 상태가 바뀌거나, <code>counterUpdateInterval</code> 시간이 지나거나, CircuitBreaker가 열려서 호출이 거부될 때에 대한 이벤트를 수신할 수 있는 리스너입니다.</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="마무리하며">마무리하며<a href="https://armeria.dev/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway#%EB%A7%88%EB%AC%B4%EB%A6%AC%ED%95%98%EB%A9%B0" class="hash-link" aria-label="Direct link to 마무리하며" title="Direct link to 마무리하며" translate="no">​</a></h2>
<p>예전에는 Channel Gateway의 어떤 부분에 장애가 발생한다면 손쓰기 전에 너무 큰 피해가 발생하였습니다. 일부에서 시작된 장애가 Thread Full 현상을 발생시키고, 결국 전체 서비스에 영향을 미쳤기 때문입니다. 하지만, 이제는 CircuitBreaker가 그 부분을 차단함으로서 좀 더 여유롭게 대처할 수 있을 것입니다.</p>
<p>마지막으로 위 설정들을 이용하여 CircuitBreaker의 동작 방식을 설명하는 것으로 마무리 지을까 합니다.</p>
<ul>
<li class="">처음 CircuitBreaker의 상태는 <em>Closed</em>입니다.</li>
<li class=""><em>Closed</em> : 호출을 수행한 후 <code>exceptionFilter</code>에 따라 다음과 같이 동작합니다.<!-- -->
<ul>
<li class="">결과가 성공했다면 성공했다는 기록을 남기고 <em>Closed</em> 상태로 갑니다.</li>
<li class="">결과가 실패했다면 <code>counterSlidingWindow</code> 시간 동안의 호출 결과를 확인해서<!-- -->
<ul>
<li class=""><code>minimumRequestThreshold</code> 개수보다 많고, 실패율이 <code>failureRateThreshold</code> 이상이라면 <em>Open</em> 상태로 갑니다.</li>
<li class="">그렇지 않다면 <em>Closed</em> 상태로 유지됩니다.</li>
</ul>
</li>
</ul>
</li>
<li class=""><em>Open</em> : <code>circuitOpenWindow</code> 시간이 지나면 <em>Half-Open</em> 상태로 바뀌게 됩니다.</li>
<li class=""><em>Half-Open</em> : 처음 들어오는 호출을 수행한 후 <code>exceptionFilter</code>에 따라 다음과 같이 동작합니다.<!-- -->
<ul>
<li class="">결과가 성공했다면 <em>Closed</em> 상태로 바뀝니다.</li>
<li class="">결과가 실패했다면 <em>Open</em> 상태로 바뀝니다.</li>
<li class=""><code>trialRequestInterval</code> 시간 안에 응답이 없다면 <em>Half-Open</em> 상태에서 그 다음 처음으로 들어오는 호출 결과에 따른 분기 처리를 합니다.</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="저자-소개">저자 소개<a href="https://armeria.dev/blog/ko/2016/08/04/applying-circuitbreaker-to-channel-gateway#%EC%A0%80%EC%9E%90-%EC%86%8C%EA%B0%9C" class="hash-link" aria-label="Direct link to 저자 소개" title="Direct link to 저자 소개" translate="no">​</a></h2>
<p>신종훈: 저는 귀찮은 일을 싫어합니다. 귀찮은 일을 줄이기 위해서 계속 고민하지요. 그래서, 프로그래밍을 좋아하는데 왠지 일이 더 늘어난 것 같은 느낌은 저만의 느낌이겠지요?</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[분산 서비스 환경에 대한 Circuit Breaker 적용]]></title>
            <link>https://armeria.dev/blog/ko/2016/07/24/circuit-breakers-for-distributed-services</link>
            <guid>https://armeria.dev/blog/ko/2016/07/24/circuit-breakers-for-distributed-services</guid>
            <pubDate>Sun, 24 Jul 2016 00:00:00 GMT</pubDate>
            <description><![CDATA[LINE의 엔지니어 Ono입니다.]]></description>
            <content:encoded><![CDATA[<p>LINE의 엔지니어 Ono입니다.
이번 블로그에서는 LINE의 서버에서 실제로 도입을 시작한 'Circuit Breaker'라는 시스템에 대해 소개하겠습니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="circuit-breaker란">Circuit Breaker란?<a href="https://armeria.dev/blog/ko/2016/07/24/circuit-breakers-for-distributed-services#circuit-breaker%EB%9E%80" class="hash-link" aria-label="Direct link to Circuit Breaker란?" title="Direct link to Circuit Breaker란?" translate="no">​</a></h2>
<p>LINE을 비롯한 최근의 Web 및 App의 백엔드 서버 시스템은 여러 개의 서비스가 API나 RPC로 연결된 네트워크로 구성되어 있습니다.
만약 이 네트워크 중 하나가 갑자기 전혀 응답하지 않게 되는 상황이 발생하면 어떻게 될까요?
동작하지 않는 서비스 접속 시 타임아웃될 때까지 차단되어, 의존성이 있는 서비스까지 연쇄적으로 멈출 가능성이 있습니다.
만약 네트워크 전체를 파악하고 있는 사람이 아무도 없다면, 근본적인 원인이 어느 서비스에 있는지를 알아내기까지 시간이 걸리게 됩니다.</p>
<p><img decoding="async" loading="lazy" alt="-BG-" src="https://armeria.dev/assets/images/circuit-breakers-for-distributed-services-1-5bb7df69bbea59e475a05522088cd493.png" width="537" height="141" class="img_ev3q"></p>
<!-- -->
<p>우리는 이러한 연쇄적인 장애 발생을 막아야 합니다.
적어도 가장 중요한 기능에 영향이 가지 않도록 해야 하는데, 그러기 위해서는 장애가 발생한 서비스에 대한 접속 차단이 필요합니다.</p>
<p><img decoding="async" loading="lazy" alt="-BG-" src="https://armeria.dev/assets/images/circuit-breakers-for-distributed-services-2-94100185efcea1b197617840a9c6a288.png" width="537" height="140" class="img_ev3q"></p>
<p>이 시스템을 자동화한 것이 바로 Circuit Breaker입니다.
<a href="http://martinfowler.com/bliki/CircuitBreaker.html" target="_blank" rel="noopener noreferrer" class="">http://martinfowler.com/bliki/CircuitBreaker.html</a></p>
<p>위 링크에 있는 마틴 파울러의 글에 자세한 설명이 있으니 여기서는 간단하게만 소개하겠습니다.</p>
<p>Circuit Breaker란, 원격 접속의 성공/실패를 카운트하여 에러율(failure rate)이 임계치를 넘어섰을 때 자동적으로 접속을 차단하는 시스템입니다.
Circuit Breaker는 상태 머신(State Machine)으로 나타낼 수 있습니다. 접속 성공과 실패 이벤트가 발생할 때마다 내부 상태를 업데이트하여 자동적으로 장애를 검출하고 복구 여부를 판단합니다.</p>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/circuit-breakers-for-distributed-services-3-706b943b1852878bf1209d68ac7ca623.png" width="749" height="182" class="img_ev3q"></p>
<p>각각의 상태와 이동 조건은 아래와 같습니다.</p>
<p><strong>CLOSED</strong></p>
<p>초기 상태입니다. 모든 접속은 평소와 같이 실행됩니다.</p>
<p><strong>OPEN</strong></p>
<p>에러율이 임계치를 넘어서면 OPEN 상태가 됩니다. 모든 접속은 차단(fail fast)됩니다.</p>
<p><strong>HALF_OPEN</strong></p>
<p>OPEN 후 일정 시간이 지나면 HALF_OPEN 상태가 됩니다. 접속을 시도하여 성공하면 CLOSED, 실패하면 OPEN으로 되돌아갑니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="circuit-breaker-for-armeria">Circuit Breaker for Armeria<a href="https://armeria.dev/blog/ko/2016/07/24/circuit-breakers-for-distributed-services#circuit-breaker-for-armeria" class="hash-link" aria-label="Direct link to Circuit Breaker for Armeria" title="Direct link to Circuit Breaker for Armeria" translate="no">​</a></h2>
<p><a href="http://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a>는 LINE이 오픈소스로 공개한 Netty 기반의 비동기 Thrift 클라이언트/서버 라이브러리입니다.
Armeria의 장점은 decorator를 통해 기능을 간편하게 확장할 수 있다는 점입니다. 그리고 Armeria 0.13.0부터 Circuit Breaker를 decorator로 추가할 수 있게 되었습니다.</p>
<p>Circuit Breaker를 사용한 Thrift Client 초기화는 아래와 같이 진행합니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Iface helloClient = new ClientBuilder("tbinary+http://127.0.0.1:8080/hello")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     .decorator(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      CircuitBreakerClient.newDecorator(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          new CircuitBreakerBuilder("hello").build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     .build(Iface.class);</span><br></span></code></pre></div></div>
<p>쉽게 초기화를 할 수 있습니다. 그리고 이 Thrift Client를 호출하는 코드는 아래와 같습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    helloClient.hello("line");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} catch (TException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // error handling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} catch (FailFastException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // fallback code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Circuit Breaker가 장애를 감지하면 Thrift Client가 FailFastException을 전송하므로, 적절한 대체(fallback) 코드를 실행합니다. 비동기 Client의 경우도 동일합니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helloClient.hello("line", new AsyncMethodCallback() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void onComplete(Object response) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     // response handling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void onError(Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     if (e instanceof TException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         // error handling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     } else if (e instanceof FailFastException) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         // fallback code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="grouping">Grouping<a href="https://armeria.dev/blog/ko/2016/07/24/circuit-breakers-for-distributed-services#grouping" class="hash-link" aria-label="Direct link to Grouping" title="Direct link to Grouping" translate="no">​</a></h2>
<p>위 예시에서는 하나의 Thrift 서비스에 하나의 Circuit Breaker를 할당했습니다. 이 경우, 동일한 서비스 중 하나의 메서드가 원인이 되어 Circuit이 차단되었을 때 다른 모든 메서드도 차단되게 됩니다. 이는 오히려 장애 범위를 확대시키게 되므로 바람직한 동작이 아닙니다. 따라서 Armeria에서는 Circuit Breaker의 인스턴스를 할당할 범위를 선택할 수 있는 그룹핑 기능을 제공하고 있습니다.</p>
<p>그룹핑에는 다음의 3종류가 있습니다.</p>
<p><strong>Per Method</strong></p>
<p>메서드별로 하나의 Circuit Breaker를 할당합니다.</p>
<p><strong>Per Host</strong></p>
<p>원격 호스트별로 하나의 Circuit Breaker를 할당합니다.</p>
<p><strong>Per Host and Method</strong></p>
<p>원격 호스트와 메서드별로 하나의 Circuit Breaker를 할당합니다.</p>
<p><img decoding="async" loading="lazy" alt="-BG-" src="https://armeria.dev/assets/images/circuit-breakers-for-distributed-services-4-4ae96ba1d797e52c0fc3b3f1f3909775.png" width="684" height="279" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="failure-rate">Failure Rate<a href="https://armeria.dev/blog/ko/2016/07/24/circuit-breakers-for-distributed-services#failure-rate" class="hash-link" aria-label="Direct link to Failure Rate" title="Direct link to Failure Rate" translate="no">​</a></h2>
<p>Circuit Breaker를 운용할 때는 어떤 상태를 장애로 간주할 것인지 조건을 명확하게 정의해야 합니다.
Armeria에서는 일정 시간 내에 처리한 리퀘스트 중 에러율(Failure Rate)이 &lt; Failure Rate Threshold &gt; 이상인 경우를 장애 상태로 취급합니다. 단, 리퀘스트 수가 너무 적을 경우(실행 직후의 과도 상태 등)에는 에러율이 안정적이지 않아서 장애를 오감지하게 될 가능성이 있습니다. 따라서 리퀘스트 수가 &lt; Minimum Request Threshold &gt; 이하인 경우에는 장애 판정을 하지 않도록 설정할 수 있습니다. 그리고 에러 비율을 카운트하는 시간의 길이는 &lt; Sliding Window &gt;로 설정합니다.
Failure Rate와 Sliding Window의 관계는 아래 그림으로 나타낼 수 있습니다.</p>
<p><img decoding="async" loading="lazy" alt="-BG-" src="https://armeria.dev/assets/images/circuit-breakers-for-distributed-services-5-2ff3131f0701105e189fa5953d2d9c1e.png" width="585" height="277" class="img_ev3q"></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="monitoring">Monitoring<a href="https://armeria.dev/blog/ko/2016/07/24/circuit-breakers-for-distributed-services#monitoring" class="hash-link" aria-label="Direct link to Monitoring" title="Direct link to Monitoring" translate="no">​</a></h2>
<p>Circuit Breaker Listener를 통해 Circuit Breaker의 상태 변화를 모니터링할 수 있습니다. 아래의 코드는 Armeria가 제공하는 Dropwizard Metrics 기반의 Listener를 사용한 예입니다. 물론 커스터마이즈된 모니터링 시스템에 맞춘 Listener를 구현하는 것도 가능합니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MetricRegistry registry = new MetricRegistry();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Iface helloClient = new ClientBuilder("tbinary+http://127.0.0.1:8080/hello")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .decorator(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CircuitBreakerClient.newDecorator(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          new CircuitBreakerBuilder("hello")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .listener(new DropwizardMetricsCircuitBreakerListener(registry, "hello"))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .build(Iface.class);</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="armeria의-circuit-breaker를-단독으로-사용하기">Armeria의 Circuit Breaker를 단독으로 사용하기<a href="https://armeria.dev/blog/ko/2016/07/24/circuit-breakers-for-distributed-services#armeria%EC%9D%98-circuit-breaker%EB%A5%BC-%EB%8B%A8%EB%8F%85%EC%9C%BC%EB%A1%9C-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0" class="hash-link" aria-label="Direct link to Armeria의 Circuit Breaker를 단독으로 사용하기" title="Direct link to Armeria의 Circuit Breaker를 단독으로 사용하기" translate="no">​</a></h2>
<p>지금까지는 Armeria의 Thrift Client와 Circuit Breaker 패키지를 조합해서 사용하는 방법을 소개했는데, Circuit Breaker 패키지를 단독으로 사용하는 것도 가능합니다.</p>
<p>Circuit Breaker 패키지를 단독으로 사용할 경우, 중요한 API는 아래의 3가지입니다.</p>
<p><strong>CircuitBreaker#canRequest()</strong></p>
<p>Circuit Breaker의 상태를 확인합니다.
Circuit이 차단되어 있는 경우에는 false를 반환합니다.</p>
<p><strong>CircuitBreaker#onSuccess()</strong></p>
<p>서비스 접속이 정상적으로 이루어졌음을 기록합니다.</p>
<p><strong>CircuitBreaker#onFailure() 또는 CircuitBreaker#onFailure(Throwable t)</strong></p>
<p>서비스 접속이 실패했음을 기록합니다.</p>
<p>아래의 샘플 코드에서는 먼저 canRequest()로 Circuit의 상황을 확인하고, 문제가 없으면 remote service access를 실행합니다. 그리고 그 결과에 따라 onSuccess 또는 onFailure를 호출합니다. 여기에서는 예외 발생 여부를 결과의 조건으로 설정했는데, 이 조건은 상황에 맞춰 자유롭게 정의할 수 있습니다. 예를 들어, remote service access가 일정 시간 이상 걸린 경우에는 예외가 발생하지 않았더라도 에러로 카운트하도록 할 수도 있습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if (circuitBreaker.canRequest()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       // remote service access</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       circuitBreaker.onSuccess();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       circuitBreaker.onFailure(e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // fail fast</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>이상으로 Armeria의 Circuit Breaker 기능에 대한 소개를 마치겠습니다.
LINE 내에서의 실제 사례도 조만간 소개하도록 하겠습니다.</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Armeria 오픈소스화 이야기]]></title>
            <link>https://armeria.dev/blog/ko/2016/04/13/open-sourcing-armeria</link>
            <guid>https://armeria.dev/blog/ko/2016/04/13/open-sourcing-armeria</guid>
            <pubDate>Wed, 13 Apr 2016 00:00:00 GMT</pubDate>
            <description><![CDATA[Armeria는 Java 8 및 Netty 상에 비동기 RPC/API 클라이언트-서버를 구현한 것입니다.]]></description>
            <content:encoded><![CDATA[<p><a href="http://line.github.io/armeria/" target="_blank" rel="noopener noreferrer" class="">Armeria</a>는 Java 8 및 <a href="http://netty.io/" target="_blank" rel="noopener noreferrer" class="">Netty</a> 상에 비동기 RPC/API 클라이언트-서버를 구현한 것입니다.
LINE은 작년 11월 Armeria를 Apache License 2.0이 적용되는 오픈소스 프로젝트로 배포했습니다.
Armeria는 HTTP/2를 세션 레이어 프로토콜로 사용하는 고성능의 비동기 Thrift 클라이언트/서버를 구축하기 위해 만든 프로젝트이지만, 기본적으로 프로토콜의 제약을 받지 않으며 확장성이 뛰어납니다. (예를 들어, HTTP/2를 통해 정적 파일 디렉토리를 처리하는 동시에 Java EE 웹 애플리케이션을 실행할 수 있습니다.)</p>
<!-- -->
<p>이 블로그에서는 기술적 측면에 초점을 맞추기 보다는 내부 프로젝트를 오픈소스로 만들어가면서 겪었던 과정을 소개하고자 합니다.
Armeria의 기술적 내용을 알고 싶으시다면 지난 2월 개발자들을 대상으로 개최한 제14회 LINE Developer Meetup에서 발표한 슬라이드 자료를 참고 바랍니다.</p>
<!-- -->
<div class="deck-embed js-deck-embed" style="aspect-ratio:1024/640" data-ratio="1.6" data-state="processed"><div class="speakerdeck-embed" data-title="false" data-skip-resize="true" data-id="8d645c29ce33400e8360e61fd0250f91" data-name="Armeria: LINE's next generation RPC layer" data-ratio="1.6" data-host="speakerdeck.com"></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="프로젝트-이력-정리">프로젝트 이력 정리<a href="https://armeria.dev/blog/ko/2016/04/13/open-sourcing-armeria#%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EC%9D%B4%EB%A0%A5-%EC%A0%95%EB%A6%AC" class="hash-link" aria-label="Direct link to 프로젝트 이력 정리" title="Direct link to 프로젝트 이력 정리" translate="no">​</a></h2>
<p>내부 프로젝트를 작업하다 보면 공개 프로젝트라면 결코 노출하지 않을 아래와 같은 변경 이력이 다수 포함되기 마련입니다.</p>
<ul>
<li class="">기밀 정보(이슈 번호, 호스트명, 내부 URL 등)</li>
<li class="">무의미하거나 불확실하게 작성된 커밋 메시지(“blah blah”, “WIP”, “WTF” 등)</li>
<li class="">저작권 고지 헤더</li>
</ul>
<p>리포지토리에 이런 문구를 수정하는 커밋을 추가한다 하더라도 프로젝트의 이력이 온전히 남기 때문에 그러한 작업은 아무 소용이 없습니다. 따라서 이력 내용을 '청소'해야 정보가 예기치 않게 유출되는 상황을 피할 수 있습니다. 이를 위해 선택 가능한 방법은 두 가지입니다.</p>
<p>한 가지 방법은 변경 이력을 일일이 검토하면서 수정하는 것입니다. 이 경우 <a href="https://git-scm.com/docs/git-filter-branch" target="_blank" rel="noopener noreferrer" class=""><code>git filter-branch</code></a> 같은 명령어를 사용해서 자동화하면 일을 어느 정도 줄일 수 있지만 변경 이력을 하나씩 꼼꼼하게 살펴봐야만 합니다.</p>
<p>또 다른 방법은 외부에 공개하면 안되는 정보를 모두 숨기고 여러 변경 이력을 하나의 커밋으로 압축하는 것입니다. 이 방법은 첫 번째 방법보다 간단하긴 하지만 모든 이력을 잃게 됩니다. 기존 이력이 모두 없어지기 때문에 나중에 코드를 왜 이렇게 썼는지 기억나지 않아도 알아낼 방도가 없습니다.</p>
<p>프로젝트 이력이 비교적 짧고 잘 정의된 코딩 스타일 가이드에 맞춰 코드를 작성했다면 첫 번째 방법을 선택할 수 있습니다. 하지만 시간은 부족하고 검토할 분량이 너무 많다면 저희가 그랬던 것처럼 모든 이력을 단 하나의 커밋으로 줄이는 최후의 방법을 선택할 것입니다.</p>
<p>하지만 요즘은 코드를 한 사람이 작성하지 않기 때문에 이 방법도 문제가 있습니다. 커밋을 하나만 남겨두면 훌륭한 기량을 발휘하여 협업에 기여한 여러 사람들의 노력과 공로를 어떻게 인정할 수 있겠습니까? 저희는 결국 아래처럼 커밋 메시지를 남기는 방식으로 감사를 표시할 수 밖에 없었습니다.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Subject: Initial import</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This commit contains the collective work of the following enthusiastic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">contributors at LINE Corporation:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Anuraag Agrawal  @anuraaga</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Heon Jeong       @blmarket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Young-tae Seok   @delegacy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Su-ahn Lee       @inch772</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Woo-jung Choi    @sophiechoi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Trustin Lee      @trustin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Yuichi Ono</span><br></span></code></pre></div></div>
<p>지금 돌이켜보면 커밋 메시지에 제 감사의 마음을 좀더 적극적으로 표현했어야 했다는 생각이 듭니다. 이 글을 통해 모든 분들의 도움에 다시 한번 진심으로 감사드립니다!</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="api-문서-작성">API 문서 작성<a href="https://armeria.dev/blog/ko/2016/04/13/open-sourcing-armeria#api-%EB%AC%B8%EC%84%9C-%EC%9E%91%EC%84%B1" class="hash-link" aria-label="Direct link to API 문서 작성" title="Direct link to API 문서 작성" translate="no">​</a></h2>
<p>프로젝트를 백지 상태에서 처음 시작할 때에는, 특히 선례로 삼을 만한 템플릿이 없는 경우에는, 코드를 신속하게 작성해서 빠른 시일 내에 공개할 필요가 있습니다. 그래야만 설계 이슈나 버그를 초반에 발견할 수 있습니다. 그런데 이 단계를 반복하는 과정에서 API 변경이 끊임없이 발생하게 되는데, 이를 구현하는 데 집중하다 보면 API 문서화 작업은 뒤로 미루게 되고 언젠가는 메워야 하는 구멍으로 남게 됩니다. (사실 문서를 작성하는 일보다 코드를 쓰는 게 훨씬 더 재미있기도 하고요.)</p>
<p>하지만 적절한 문서화는 오픈소스 프로젝트에서 아주 중요합니다. 사람들은 아주 절박하지 않은 한 문서가 제공되지 않는 오픈소스 소프트웨어를 사용하려 하지 않습니다. 문서화가 제대로 되어 있지 않다면 누가 그런 오픈소스를 선택하겠습니까? 이 세상에는 유사한 프로젝트가 이미 많이 있으니까요!</p>
<p>결국은 나중에 우리 스스로가 남겨두었던 구멍을 모두 메워야 했습니다. 저희는 그걸 '기술 부채(technical debt)'라는 용어를 본따 '문서화 부채(documentation debt)'라 불렀습니다. 솔직하게 고백하자면 그 빚을 갚는 일은 결코 유쾌한 경험이 아니었습니다. 하지만 일단 제대로 문서화 작업을 해놓고 나니 빚을 최소한으로 유지하는 일이 수월해졌습니다. 이제는 퍼블릭 메서드나 클래스를 새로 쓰고 나면 리뷰를 진행하면서 문서화 작업을 함께 하면 됩니다. 이건 균형잡힌 몸매를 유지하는 것과 비슷합니다. 일단 좋은 몸매가 다듬어지면 그 다음부터는 쉬워지는 원리입니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="웹사이트-구축">웹사이트 구축<a href="https://armeria.dev/blog/ko/2016/04/13/open-sourcing-armeria#%EC%9B%B9%EC%82%AC%EC%9D%B4%ED%8A%B8-%EA%B5%AC%EC%B6%95" class="hash-link" aria-label="Direct link to 웹사이트 구축" title="Direct link to 웹사이트 구축" translate="no">​</a></h2>
<p>Github는 프로젝트를 제공하기에 적합한 공간이지만 가능하면 전용 웹사이트를 활용하는 것이 더 낫습니다. 프로젝트 웹사이트가 있으면 원하는 정보를 원하는 방식으로 구성하고 제공할 수 있으며 프로젝트의 성격을 한층 더 시각적이고 효과적으로 알릴 수 있습니다.</p>
<p>하지만 웹사이트 구축은 간단한 작업이 아닙니다. 그래서 코드 몇 줄 적어넣는 것 이상의 시간을 투자하지 않으면서도 확장 가능한 방식으로 웹사이트를 개발, 유지 관리할 수 있는 수단을 찾아 보았습니다.</p>
<p>다행히 몇몇 엔지니어가 제공한 훌륭한 오픈소스 웹사이트 생성 툴이 있었습니다. 이 툴 덕분에 디자이너를 덜 괴롭히면서 HTML, CSS를 직접 다룰 수 있었습니다.
Armeria의 경우는 <a href="http://www.sphinx-doc.org/en/stable/" target="_blank" rel="noopener noreferrer" class="">Sphinx</a>를 선택했고 이와 더불어 <a href="http://trustin.github.io/sphinx-maven-plugin/" target="_blank" rel="noopener noreferrer" class="">sphinx-maven-plugin</a>과 <a href="http://read-the-docs.readthedocs.org/en/latest/" target="_blank" rel="noopener noreferrer" class="">Read the Docs theme</a>을 사용함으로써 빌드 프로세스에 웹사이트 생성까지 포함했습니다. 이밖에도 <a href="http://awestruct.org/" target="_blank" rel="noopener noreferrer" class="">Awestruct</a>, <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer" class="">Jekyll</a> 같은 유사한 용도의 툴이 다양하게 있습니다. 웹사이트 구축에 관심있는 분들은 이런 툴을 사용해 본다면 본인에게 적합한 것을 선택하는 데 많은 도움이 될 것입니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="로고-제작">로고 제작<a href="https://armeria.dev/blog/ko/2016/04/13/open-sourcing-armeria#%EB%A1%9C%EA%B3%A0-%EC%A0%9C%EC%9E%91" class="hash-link" aria-label="Direct link to 로고 제작" title="Direct link to 로고 제작" translate="no">​</a></h2>
<p><img decoding="async" loading="lazy" src="https://armeria.dev/assets/images/open-sourcing-armeria-1-89b68e7649f79147f589aed590d59639.png" width="938" height="811" class="img_ev3q"></p>
<p>Armeria의 로고</p>
<p>로고는 프로젝트의 정수입니다. 로고는 그 프로젝트가 무엇을 위한 것인지, 어떤 방향으로 나아갈 것인지 시각적으로 그리고 상징적으로 알려주는 수단입니다. 또한 사람들이 프로젝트를 더 잘 기억하게 만드는 연상 효과도 있습니다.</p>
<p>이처럼 프로젝트에 중대한 영향을 미치기 때문에 디자이너는 여러 측면을 신중하게 검토하고 프로토타입을 많이 만들어 봐야 합니다. 운좋게도 산업 디자인까지 전공한 동료가 때맞춰 입사한 덕분에 도움을 받을 수 있었습니다. 본인의 업무로 바쁘신 와중에도 시간을 내어 도와주셔서 너무 고마웠습니다. 다음에도 이번 못지 않게 뛰어난 로고를 만들어 주실거라 믿습니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="라이선스의-법적-효력과-책임에-대한-검토">라이선스의 법적 효력과 책임에 대한 검토<a href="https://armeria.dev/blog/ko/2016/04/13/open-sourcing-armeria#%EB%9D%BC%EC%9D%B4%EC%84%A0%EC%8A%A4%EC%9D%98-%EB%B2%95%EC%A0%81-%ED%9A%A8%EB%A0%A5%EA%B3%BC-%EC%B1%85%EC%9E%84%EC%97%90-%EB%8C%80%ED%95%9C-%EA%B2%80%ED%86%A0" class="hash-link" aria-label="Direct link to 라이선스의 법적 효력과 책임에 대한 검토" title="Direct link to 라이선스의 법적 효력과 책임에 대한 검토" translate="no">​</a></h2>
<p>오픈소스 소프트웨어에 대한 개념은 컴퓨팅 기술의 시초부터 존재해 왔습니다. 하지만 사람들이 오픈소스 라이선스에 관심을 가지게 된 건 최근입니다. 어떤 사람들은 무료로 사용 가능한 프로젝트라 하더라도 누군가에게 소유권이 있다는 사실을 간과하는 것 같습니다.
Armeria 프로젝트에서는 법적 문제가 발생할 소지를 방지하기 위해 Armeria에 사용된 오픈소스 소프트웨어의 라이선스 규정을 위반하지 않도록 각별히 주의를 기울였습니다.</p>
<p>그 일환으로 프로젝트 리포지토리에 모든 라이선스 규정 파일과 요약문을 포함해서 Armeria가 어떤 소프트웨어로부터 도움을 받았는지 이용자에게 확실히 밝히고 있습니다. 또한 Armeria 내에서 이러한 오픈소스 소프트웨어의 어떤 부분을 수정했고 재배포했는지 구체적으로 명시하고 있습니다.</p>
<p>Armeria는 소유 주체가 있는 오픈소스 프로젝트이기 때문에 공정하고 명확한 규정에 의거하여 라이선스를 부여하고 있습니다. 다음과 같은 특징을 감안하여 여러 라이선스 중에서 <a href="https://tldrlegal.com/license/apache-license-2.0-(apache-2.0)" target="_blank" rel="noopener noreferrer" class="">Apache License 2.0</a>을 선택했습니다.</p>
<ul>
<li class="">Apache License 2.0 라이선스를 사용하는 소프트웨어는 무료로 사용, 재생산, 수정, 배포, 판매할 수 있으며 원본 소스 코드를 포함할 필요가 없습니다.</li>
<li class="">오픈소스의 특허 라이선스 부여 및 특허 침해에 관한 조항(Grant of Patent License)이 명시되어 있습니다.</li>
</ul>
<p>사람들이 종종 간과하는 또 다른 중요한 부분은 CLA(Contributor License Agreement)입니다.
CLA는 외부인으로부터 도움을 받을 때 필요합니다. 예를 들어, 외부인이 어떤 기능을 제안하는 pull request를 보냈는데 여러분의 프로젝트에 병합하고 싶다면 해당 제출자로부터 이 서약에 동의하는 서명을 받아야 합니다.
CLA는 이 블로그의 주제에서 벗어나는 내용이므로 여기에서 자세히 설명하지는 않겠습니다. 대신 관련 정보를 제공하는 사이트를 소개합니다. <a href="http://oss-watch.ac.uk/resources/cla" target="_blank" rel="noopener noreferrer" class="">OSS Watch</a> 및 <a href="https://www.clahub.com/pages/why_cla" target="_blank" rel="noopener noreferrer" class="">CLAHub</a> 링크를 참고해 주세요.</p>
<p>법적 검토를 거치는 과정은 어려워 보이기도 하고 시간이 많이 걸릴 것 같지만 실상은 그렇지 않습니다. 대부분 한 번만 완수하면 되는 작업이고 법무 부서의 동료 직원이 우리를 대신해서 성심성의껏 골치 아픈 법적 문제를 처리해 줍니다. 조금이라도 석연치 않은 점이 있다면 바로 법무 부서를 방문하여 전문가에게 도움을 구하세요.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="다양한-오픈소스-프로젝트-간의-협업">다양한 오픈소스 프로젝트 간의 협업<a href="https://armeria.dev/blog/ko/2016/04/13/open-sourcing-armeria#%EB%8B%A4%EC%96%91%ED%95%9C-%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4-%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-%EA%B0%84%EC%9D%98-%ED%98%91%EC%97%85" class="hash-link" aria-label="Direct link to 다양한 오픈소스 프로젝트 간의 협업" title="Direct link to 다양한 오픈소스 프로젝트 간의 협업" translate="no">​</a></h2>
<p>오픈소스 프로젝트를 이용하다 보면 버그를 발견할 수 있습니다. 버그를 발견한 당사자가 스스로 해결책을 강구할 수도 있지만 그렇지 못한 경우도 있습니다. 원래 프로젝트에서 여러분만의 프로젝트 포크(fork)를 만들어 직접 수정하고 관리할 수도 있습니다. 하지만 그것보다 업스트림(upstream)에 변경을 제안하는 것이 언제나 더 나은 접근법입니다. 그렇지 않으면 여러분이 지속적으로 프로젝트를 관리해야 합니다. 또한 업스트림에 기여하면 오픈소스 업계에서 본인의 활동을 알릴 수 있고 다른 사람들과 협업하면서 더욱 재미를 찾을 수도 있습니다. 둘 다 여러분의 경력에 매우 긍정적인 효과를 줄 것입니다.</p>
<p>이번에 Armeria를 개발하는 동안 Netty 프로젝트에서 발견한 여러 이슈를 보고하고 일부 이슈의 경우 수정 작업을 돕기도 했습니다.</p>
<ul>
<li class="">HTTP/1과 2<!-- -->
<ul>
<li class=""><a href="https://github.com/netty/netty/pull/4785" target="_blank" rel="noopener noreferrer" class="">#4785</a> - Fix missing trailing data on HTTP client upgrade</li>
<li class=""><a href="https://github.com/netty/netty/pull/4582" target="_blank" rel="noopener noreferrer" class="">#4582</a> - Revamp InboundHttp2ToHttpAdapter builder API</li>
<li class=""><a href="https://github.com/netty/netty/pull/4574" target="_blank" rel="noopener noreferrer" class="">#4574</a> - Revamp the Http2ConnectionHandler builder API</li>
<li class=""><a href="https://github.com/netty/netty/pull/4525" target="_blank" rel="noopener noreferrer" class="">#4525</a> - Fix the incorrect usage/value of "Connection: upgrade"</li>
<li class=""><a href="https://github.com/netty/netty/pull/4524" target="_blank" rel="noopener noreferrer" class="">#4524</a> - Fix IllegalReferenceCountException caused by HttpClientCodec.upgradeFrom()</li>
<li class=""><a href="https://github.com/netty/netty/pull/4523" target="_blank" rel="noopener noreferrer" class="">#4523</a> - Relax the sanity check in HttpClientUpgradeHandler</li>
<li class=""><a href="https://github.com/netty/netty/pull/4428" target="_blank" rel="noopener noreferrer" class="">#4428</a> - Reject the first SETTINGS ack on HTTP/2 Preface</li>
<li class=""><a href="https://github.com/netty/netty/pull/4210" target="_blank" rel="noopener noreferrer" class="">#4210</a> - Http2ConnectionHandler does not close the stream 1 (HTTP_UPGRADE_STREAM_ID)</li>
<li class=""><a href="https://github.com/netty/netty/pull/3876" target="_blank" rel="noopener noreferrer" class="">#3876</a> - Lazily instantiate HttpServerUpgradeHandler.UpgradeCodec</li>
</ul>
</li>
<li class="">DNS<!-- -->
<ul>
<li class=""><a href="https://github.com/netty/netty/pull/4946" target="_blank" rel="noopener noreferrer" class="">#4946</a> - Fix potential infinite loop when resolving CNAME records</li>
<li class=""><a href="https://github.com/netty/netty/pull/4837" target="_blank" rel="noopener noreferrer" class="">#4837</a> - Preserve the host name of address when parsing /etc/hosts file</li>
<li class=""><a href="https://github.com/netty/netty/pull/4665" target="_blank" rel="noopener noreferrer" class="">#4665</a> - Netty's DNS resolution should take into account system domain name</li>
<li class=""><a href="https://github.com/netty/netty/pull/4541" target="_blank" rel="noopener noreferrer" class="">#4541</a> - Don't cycle dns servers while cycling dns record types.</li>
</ul>
</li>
<li class="">기타<!-- -->
<ul>
<li class=""><a href="https://github.com/netty/netty/pull/4547" target="_blank" rel="noopener noreferrer" class="">#4547</a> - NPE in PooledByteBufAllocator.newDirectBuffer()</li>
<li class=""><a href="https://github.com/netty/netty/pull/4419" target="_blank" rel="noopener noreferrer" class="">#4419</a> - Fix a bug where DefaultPromise.toString() says "incomplete" when it's done</li>
</ul>
</li>
</ul>
<p>여러 프로젝트의 개발자들과 함께 작업한 덕분에 Armeria에서 사용한 오픈소스의 프로젝트 포크를 별도로 유지 관리하는 부담을 줄일 수 있었고, 오픈소스 커뮤니티에서 Armeria 프로젝트뿐 아니라 프로젝트에 참여한 구성원의 활동을 널리 알리는 기회를 누릴 수 있었습니다.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="도전자를-찾습니다">도전자를 찾습니다!<a href="https://armeria.dev/blog/ko/2016/04/13/open-sourcing-armeria#%EB%8F%84%EC%A0%84%EC%9E%90%EB%A5%BC-%EC%B0%BE%EC%8A%B5%EB%8B%88%EB%8B%A4" class="hash-link" aria-label="Direct link to 도전자를 찾습니다!" title="Direct link to 도전자를 찾습니다!" translate="no">​</a></h2>
<p>개발 성과물을 공유하며 커뮤니티에 기여하고 다양한 프로젝트 개발자들과 협업하는 과정이 즐거워 보이지 않으십니까?
Armeria는 아직 프로젝트 초기 단계이기 때문에 로드맵에 따라 향후 새로운 기능을 추가할 예정입니다. 현재 구상 중인 기능은 다음과 같습니다.</p>
<ul>
<li class="">클라이언트 기반의 로드 밸런싱</li>
<li class="">Reactive Streams을 통한 대용량 컨텐트 스트리밍</li>
<li class="">Redis, MySQL 등 더욱 다양한 프로토콜 지원</li>
<li class="">관리와 모니터링을 통합적으로 수행하는 웹 콘솔</li>
<li class="">문서화와 코드 생성을 더욱 효율적으로 할 수 있는 새로운 Thrift 컴파일러</li>
</ul>
<p>LINE은 다른 프로젝트들도 오픈소스로 배포하기 위해 준비하고 있습니다. 또한 LINE 엔지니어는 회사의 이익을 추구하는 데 그치지 않고 장기적으로 많은 이들에게 도움을 되는 일을 목표로 삼고 있습니다.
LINE에 지원하여 함께 프로젝트를 만들고 세상이 놀랄 만한 일에 도전해 보세요!</p>
<p><a href="http://recruit.linepluscorp.com/lineplus/career/detail/20000312" target="_blank" rel="noopener noreferrer" class="">채용 정보</a></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="저자-소개">저자 소개<a href="https://armeria.dev/blog/ko/2016/04/13/open-sourcing-armeria#%EC%A0%80%EC%9E%90-%EC%86%8C%EA%B0%9C" class="hash-link" aria-label="Direct link to 저자 소개" title="Direct link to 저자 소개" translate="no">​</a></h2>
<p><a href="https://github.com/trustin" target="_blank" rel="noopener noreferrer" class="">이희승(Trustin)님</a>은 <a href="http://netty.io/" target="_blank" rel="noopener noreferrer" class="">Netty 프로젝트</a> 창시자이자 <a href="http://mina.apache.org/" target="_blank" rel="noopener noreferrer" class="">Apache MINA 프로젝트</a> 공동 창시자로서, 현재 LINE에서 플랫폼 소프트웨어 엔지니어로 재직 중입니다.</p>]]></content:encoded>
        </item>
    </channel>
</rss>