"use strict";(globalThis.webpackChunkarmeria_site=globalThis.webpackChunkarmeria_site||[]).push([[6127],{28453:(e,t,r)=>{r.d(t,{R:()=>a,x:()=>o});var n=r(96540);const i={},s=n.createContext(i);function a(e){const t=n.useContext(s);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),n.createElement(s.Provider,{value:t},e.children)}},73246:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"tutorials/thrift/implement-create","title":"Implementing CREATE operation","description":"In the previous step, we defined empty service methods.","source":"@site/src/content/docs/tutorials/thrift/03-implement-create.mdx","sourceDirName":"tutorials/thrift","slug":"/tutorials/thrift/implement-create","permalink":"/docs/tutorials/thrift/implement-create","draft":false,"unlisted":false,"editUrl":"https://github.com/line/armeria/edit/main/site-new/src/content/docs/tutorials/thrift/03-implement-create.mdx","tags":[{"inline":true,"label":"server","permalink":"/docs/tags/server"}],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_label":"3. Implement CREATE","category":"thrift","tags":["server"],"level":"basic","type":"step"},"sidebar":"docsSidebar","previous":{"title":"2. Run a service","permalink":"/docs/tutorials/thrift/run-service"},"next":{"title":"4. Implement READ","permalink":"/docs/tutorials/thrift/implement-read"}}');var i=r(74848),s=r(28453);const a={sidebar_label:"3. Implement CREATE",category:"thrift",tags:["server"],level:"basic",type:"step"},o="Implementing CREATE operation",l={},c=[{value:"What you need",id:"what-you-need",level:2},{value:"1. Implement server-side",id:"1-implement-server-side",level:2},{value:"2. Create a client",id:"2-create-a-client",level:2},{value:"3. Implement client-side",id:"3-implement-client-side",level:2},{value:"4. Create a test file",id:"4-create-a-test-file",level:2},{value:"5. Register a ServerExtension",id:"5-register-a-serverextension",level:2},{value:"6. Test creating a blog post",id:"6-test-creating-a-blog-post",level:2},{value:"What&#39;s next",id:"whats-next",level:2}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components},{TutorialSteps:r}=t;return r||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("TutorialSteps",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"implementing-create-operation",children:"Implementing CREATE operation"})}),"\n",(0,i.jsxs)(t.p,{children:["In the previous step, we defined empty service methods.\nIn this step, we'll fill in one of the service methods to create a blog post and implement a corresponding client method.\nAlso, we'll try making a call to the service method with test code using Armeria's ",(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/testing/junit5/server/ServerExtension.html",children:"ServerExtension"}),"."]}),"\n",(0,i.jsx)(r,{current:3}),"\n",(0,i.jsx)(t.h2,{id:"what-you-need",children:"What you need"}),"\n",(0,i.jsxs)(t.p,{children:["You need to have the following files obtained from previous steps.\nYou can always ",(0,i.jsx)(t.a,{href:"https://github.com/line/armeria-examples/tree/main/tutorials/thrift",children:"download"})," the full version, instead of creating one yourself."]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"/docs/tutorials/thrift/define-service#3-compile-the-thrift-file",children:"Generated Java code"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"Main.java"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.code,{children:"BlogServiceImpl.java"})}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"1-implement-server-side",children:"1. Implement server-side"}),"\n",(0,i.jsx)(t.p,{children:"Let's implement a service method to create a blog post."}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["In the ",(0,i.jsx)(t.code,{children:"BlogServiceImpl"})," class, create an ID generator to issue temporary blog post IDs and a map to contain blog posts."]}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-java",metastring:'title="BlogServiceImpl.java"',children:"import java.util.Map;\nimport java.util.concurrent.ConcurrentHashMap;\nimport java.util.concurrent.atomic.AtomicInteger;\n\npublic class BlogServiceImpl implements BlogService.AsyncIface {\n  private final AtomicInteger idGenerator = new AtomicInteger();\n  private final Map<Integer, BlogPost> blogPosts = new ConcurrentHashMap<>();\n  ...\n}\n"})}),"\n",(0,i.jsxs)(t.ol,{start:"2",children:["\n",(0,i.jsxs)(t.li,{children:["In the ",(0,i.jsx)(t.code,{children:"createBlogPost()"})," method, create a ",(0,i.jsx)(t.code,{children:"BlogPost"})," object with a generated ID and request parameters."]}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-java",metastring:'title="BlogServiceImpl.java"',children:"import java.time.Instant;\n...\n@Override\npublic void createBlogPost(CreateBlogPostRequest request, AsyncMethodCallback<BlogPost> resultHandler)\n        throws TException {\n  final int id = idGenerator.getAndIncrement();\n  final Instant now = Instant.now();\n  final BlogPost blogPost = new BlogPost()\n          .setId(id)\n          .setTitle(request.getTitle())\n          .setContent(request.getContent())\n          .setModifiedAt(now.toEpochMilli())\n          .setCreatedAt(now.toEpochMilli());\n}\n"})}),"\n",(0,i.jsxs)(t.ol,{start:"2",children:["\n",(0,i.jsxs)(t.li,{children:["In the ",(0,i.jsx)(t.code,{children:"createBlogPost()"})," method, save the post information in the ",(0,i.jsx)(t.code,{children:"blogPosts"})," map and return the information of the created blog post to the ",(0,i.jsx)(t.code,{children:"resultHandler"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-java",metastring:'title="BlogServiceImpl.java"',children:"@Override\npublic void createBlogPost(CreateBlogPostRequest request, AsyncMethodCallback<BlogPost> resultHandler)\n        throws TException {\n  ...\n  blogPosts.put(id, blogPost);\n  final BlogPost stored = blogPost;\n  resultHandler.onComplete(stored);\n}\n"})}),"\n",(0,i.jsx)(t.h2,{id:"2-create-a-client",children:"2. Create a client"}),"\n",(0,i.jsxs)(t.p,{children:["Let's create a client to send a request to the service.\nYou can refer to the full version of the file ",(0,i.jsx)(t.a,{href:"https://github.com/line/armeria-examples/blob/main/tutorials/thrift/src/main/java/example/armeria/server/blog/thrift/BlogClient.java",children:"here"})," of the file."]}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Create a class for our client. We'll name the class ",(0,i.jsx)(t.code,{children:"BlogClient"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-java",metastring:'title="BlogClient.java"',children:"package example.armeria.server.blog.thrift;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\npublic class BlogClient {\n  private static final Logger logger = LoggerFactory.getLogger(BlogClient.class);\n}\n"})}),"\n",(0,i.jsxs)(t.ol,{start:"2",children:["\n",(0,i.jsxs)(t.li,{children:["In the ",(0,i.jsx)(t.code,{children:"BlogClient"})," class, add a constructor and create a Thrift client instance using Armeria's ",(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/client/thrift/ThriftClients.html",children:"ThriftClients"}),"."]}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-java",metastring:'title="BlogClient.java"',children:"import java.net.URI;\nimport com.linecorp.armeria.client.thrift.ThriftClients;\nimport example.armeria.blog.thrift.BlogService;\n\npublic class BlogClient {\n  ...\n  private final BlogService.Iface blogService;\n\n  BlogClient(URI uri, String path) {\n    blogService =\n      ThriftClients.builder(uri)\n        .path(path)\n        .build(BlogService.Iface.class);\n  }\n}\n"})}),"\n",(0,i.jsx)(t.h2,{id:"3-implement-client-side",children:"3. Implement client-side"}),"\n",(0,i.jsxs)(t.p,{children:["In the ",(0,i.jsx)(t.code,{children:"BlogClient"})," class, add a method to send a request to create a blog post."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-java",metastring:'title="BlogClient.java"',children:"import org.apache.thrift.TException;\nimport example.armeria.blog.thrift.BlogPost;\nimport example.armeria.blog.thrift.CreateBlogPostRequest;\n...\nBlogPost createBlogPost(String title, String content) throws TException {\n  final CreateBlogPostRequest request =\n          new CreateBlogPostRequest().setTitle(title)\n                                     .setContent(content);\n  return blogService.createBlogPost(request);\n}\n"})}),"\n",(0,i.jsx)(t.h2,{id:"4-create-a-test-file",children:"4. Create a test file"}),"\n",(0,i.jsx)(t.p,{children:"Let's start writing test code.\nWe'll use test code to verify what we implement along the way."}),"\n",(0,i.jsxs)(t.p,{children:["Create a file, ",(0,i.jsx)(t.code,{children:"BlogServiceTest.java"}),", under ",(0,i.jsx)(t.code,{children:"{project_root}/src/test/java/example/armeria/server/blog/thrift"})," as follows.\nYou can see the full version of the file ",(0,i.jsx)(t.a,{href:"https://github.com/line/armeria-examples/blob/main/tutorials/thrift/src/test/java/example/armeria/server/blog/thrift/BlogServiceTest.java",children:"here"}),"."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-java",metastring:'title="BlogServiceTest.java"',children:"package example.armeria.server.blog.thrift;\n\nclass BlogServiceTest {}\n"})}),"\n",(0,i.jsx)(t.h2,{id:"5-register-a-serverextension",children:"5. Register a ServerExtension"}),"\n",(0,i.jsxs)(t.p,{children:["Armeria's ",(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/testing/junit5/server/ServerExtension.html",children:"ServerExtension"})," automatically handles set-up and tear-down of a server for testing.\nThis is convenient as it eliminates the need to execute the main method to set up a server before running our tests."]}),"\n",(0,i.jsxs)(t.p,{children:["In the ",(0,i.jsx)(t.code,{children:"BlogServiceTest"})," class, register a ",(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/testing/junit5/server/ServerExtension.html",children:"ServerExtension"})," as follows.\nNote that the service instance is added to the configuration."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-java",metastring:'title="BlogServiceTest.java"',children:'import org.junit.jupiter.api.extension.RegisterExtension;\nimport com.linecorp.armeria.server.ServerBuilder;\nimport com.linecorp.armeria.server.thrift.THttpService;\nimport com.linecorp.armeria.testing.junit5.server.ServerExtension;\n...\n@RegisterExtension\nstatic final ServerExtension server = new ServerExtension() {\n  @Override\n  protected void configure(ServerBuilder sb) throws Exception {\n    sb.service("/thrift",\n               THttpService.builder()\n                           // Add the service to the configuration\n                           .addService(new BlogServiceImpl())\n                           .build());\n  }\n};\n'})}),"\n",(0,i.jsx)(t.h2,{id:"6-test-creating-a-blog-post",children:"6. Test creating a blog post"}),"\n",(0,i.jsx)(t.p,{children:"Let's test if we can create a blog post."}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["In the ",(0,i.jsx)(t.code,{children:"BlogServiceTest"})," class, add a test method as follows."]}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-java",metastring:'title="BlogServiceTest.java"',children:'import static org.assertj.core.api.Assertions.assertThat;\nimport org.apache.thrift.TException;\nimport org.junit.jupiter.api.Test;\nimport example.armeria.blog.thrift.BlogPost;\n...\n@Test\nvoid createBlogPost() throws TException {\n  final BlogClient client = new BlogClient(server.httpUri(), "/thrift");\n  final BlogPost response = client.createBlogPost("My first blog", "Hello Armeria!");\n  assertThat(response.getId()).isGreaterThanOrEqualTo(0);\n  assertThat(response.getTitle()).isEqualTo("My first blog");\n  assertThat(response.getContent()).isEqualTo("Hello Armeria!");\n}\n'})}),"\n",(0,i.jsxs)(t.ol,{start:"2",children:["\n",(0,i.jsx)(t.li,{children:"Run the test case on your IDE or using Gradle."}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"./gradlew test\n"})}),"\n",(0,i.jsx)(t.p,{children:"The service worked as expected if you see the test case passed."}),"\n",(0,i.jsx)(t.h2,{id:"whats-next",children:"What's next"}),"\n",(0,i.jsxs)(t.p,{children:["In this step, we've implemented a method for creating a blog post.\nWe've also written test code and registered ",(0,i.jsx)(t.a,{href:"type://https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/testing/junit5/server/ServerExtension.html",children:"ServerExtension"})," to our test."]}),"\n",(0,i.jsxs)(t.p,{children:["Next, at ",(0,i.jsx)(t.a,{href:"/docs/tutorials/thrift/implement-read",children:"Step 4. Implement READ"}),", we'll implement a READ operation to read a single post and also multiple posts."]}),"\n",(0,i.jsx)(r,{current:3})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);